"use strict";var HP=Object.create;var _u=Object.defineProperty;var ZP=Object.getOwnPropertyDescriptor;var GP=Object.getOwnPropertyNames;var VP=Object.getPrototypeOf,QP=Object.prototype.hasOwnProperty;var ke=(n,e)=>()=>(n&&(e=n(n=0)),e);var U=(n,e)=>()=>(e||n((e={exports:{}}).exports,e),e.exports),io=(n,e)=>{for(var t in e)_u(n,t,{get:e[t],enumerable:!0})},ix=(n,e,t,o)=>{if(e&&typeof e=="object"||typeof e=="function")for(let r of GP(e))!QP.call(n,r)&&r!==t&&_u(n,r,{get:()=>e[r],enumerable:!(o=ZP(e,r))||o.enumerable});return n};var D=(n,e,t)=>(t=n!=null?HP(VP(n)):{},ix(e||!n||!n.__esModule?_u(t,"default",{value:n,enumerable:!0}):t,n)),WP=n=>ix(_u({},"__esModule",{value:!0}),n);var xn,sr=ke(()=>{"use strict";xn=(y=>(y.Antigravity="antigravity",y.Chutes="chutes",y.DeepInfra="deepinfra",y.DeepSeek="deepseek",y.GeminiCli="geminicli",y.Huggingface="huggingface",y.LightningAI="lightningai",y.Kimi="kimi",y.Mistral="mistral",y.MiniMax="minimax",y.MiniMaxCoding="minimax-coding",y.Moonshot="moonshot",y.Ollama="ollama",y.OpenCode="opencode",y.OpenAI="openai",y.QwenCli="qwencli",y.Zenmux="zenmux",y.Zhipu="zhipu",y.Compatible="compatible",y))(xn||{})});var an,u,ce=ke(()=>{"use strict";an=D(require("vscode")),u=class n{static outputChannel;static initialize(e="Copilot ++"){n.outputChannel=an.window.createOutputChannel(e,{log:!0})}static checkAndPromptLogLevel(){if(!n.outputChannel)return;let e=n.outputChannel.logLevel,t=an.env.logLevel;n.info("VS Code log level status:"),n.info(`  - Output channel level: ${an.LogLevel[e]} (${e})`),n.info(`  - Editor environment level: ${an.LogLevel[t]} (${t})`),e>an.LogLevel.Debug?(n.warn(`Current VS Code log level is ${an.LogLevel[e]}, detailed debug information may not be displayed`),n.info('To view detailed debug logs, please execute command: "Developer: Set Log Level" \u2192 select "Debug"'),an.window.showInformationMessage(`Copilot ++: Current VS Code log level is ${an.LogLevel[e]}`,"Set Log Level","Ignore").then(o=>{o==="Set Log Level"&&an.commands.executeCommand("workbench.action.setLogLevel")})):n.info(`VS Code log level is set to ${an.LogLevel[e]}, detailed debug information can be viewed`)}static trace(e,...t){n.outputChannel&&n.outputChannel.trace(e,...t)}static debug(e,...t){n.outputChannel&&n.outputChannel.debug(e,...t)}static info(e,...t){n.outputChannel&&n.outputChannel.info(e,...t)}static warn(e,...t){n.outputChannel&&n.outputChannel.warn(e,...t)}static error(e,...t){n.outputChannel&&n.outputChannel.error(e,...t)}static dispose(){n.outputChannel&&n.outputChannel.dispose()}}});var cx,ax,sx,it,cr=ke(()=>{"use strict";cx=D(require("vscode"));ce();ax="chp.accountQuotaCache",sx=1,it=class n{static instance;context;cache=new Map;_onQuotaStateChange=new cx.EventEmitter;onQuotaStateChange=this._onQuotaStateChange.event;constructor(){}static initialize(e){return n.instance||(n.instance=new n),n.instance.context=e,n.instance.loadFromStorage(),u.info("AccountQuotaCache initialized"),n.instance}static getInstance(){return n.instance||(n.instance=new n),n.instance}loadFromStorage(){if(this.context)try{let e=this.context.globalState.get(ax);if(e&&e.version===sx){this.cache.clear();for(let t of e.accounts)t.quotaExceeded&&t.quotaResetAt&&Date.now()>=t.quotaResetAt&&(t.quotaExceeded=!1,t.quotaResetAt=void 0,t.backoffLevel=0,t.lastError=void 0),this.cache.set(t.accountId,t);u.debug(`Loaded ${this.cache.size} account quota states from storage`)}}catch(e){u.error("Failed to load quota cache from storage:",e)}}async saveToStorage(){if(this.context)try{let e={version:sx,accounts:Array.from(this.cache.values()),updatedAt:Date.now()};await this.context.globalState.update(ax,e),u.debug("Quota cache saved to storage")}catch(e){u.error("Failed to save quota cache to storage:",e)}}getOrCreateState(e,t,o){e||(u.warn(`[AccountQuotaCache] getOrCreateState called with empty accountId! provider: ${t}, accountName: ${o}`),u.warn("[AccountQuotaCache] Stack trace:",new Error().stack));let r=this.cache.get(e);return r?o&&r.accountName!==o&&(r.accountName=o):(u.debug(`[AccountQuotaCache] Creating new state for accountId: ${e}, provider: ${t}`),r={accountId:e,accountName:o,provider:t,quotaExceeded:!1,backoffLevel:0,updatedAt:Date.now(),successCount:0,failureCount:0},this.cache.set(e,r)),r}async markQuotaExceeded(e,t,o){if(!e||e==="undefined"){u.error(`[AccountQuotaCache] markQuotaExceeded called with invalid accountId: "${e}", provider: ${t}, accountName: ${o?.accountName}`),u.error("[AccountQuotaCache] Stack trace:",new Error().stack);return}u.debug(`[AccountQuotaCache] markQuotaExceeded - accountId: ${e}, provider: ${t}, accountName: ${o?.accountName}`);let r=this.getOrCreateState(e,t,o?.accountName),{cooldown:i,newLevel:a}=this.calculateCooldown(r.backoffLevel,o?.resetDelayMs);r.quotaExceeded=!0,r.quotaResetAt=Date.now()+i,r.backoffLevel=a,r.affectedModel=o?.affectedModel,r.lastError=o?.error||`Quota exceeded, retry after ${Math.round(i/1e3)}s`,r.updatedAt=Date.now(),r.failureCount++,r.lastFailureAt=Date.now(),u.debug(`[AccountQuotaCache] Updated state for ${e}: failureCount=${r.failureCount}, quotaResetAt=${r.quotaResetAt}`),await this.saveToStorage(),this._onQuotaStateChange.fire({accountId:e,provider:t,state:r}),u.debug(`[AccountQuotaCache] Account ${e} quota exceeded, cooldown ${Math.round(i/1e3)}s (level ${a})`)}async clearQuotaExceeded(e){let t=this.cache.get(e);t&&(t.quotaExceeded=!1,t.quotaResetAt=void 0,t.backoffLevel=0,t.lastError=void 0,t.updatedAt=Date.now(),await this.saveToStorage(),this._onQuotaStateChange.fire({accountId:e,provider:t.provider,state:t}))}async recordSuccess(e,t,o){if(!e||e==="undefined"){u.error(`[AccountQuotaCache] recordSuccess called with invalid accountId: "${e}", provider: ${t}, accountName: ${o}`),u.error("[AccountQuotaCache] Stack trace:",new Error().stack);return}u.debug(`[AccountQuotaCache] recordSuccess - accountId: ${e}, provider: ${t}, accountName: ${o}`);let r=this.getOrCreateState(e,t,o);u.debug(`[AccountQuotaCache] Current state for ${e}: successCount=${r.successCount}, failureCount=${r.failureCount}`),r.quotaExceeded&&(r.quotaExceeded=!1,r.quotaResetAt=void 0,r.backoffLevel=0,r.lastError=void 0),r.successCount++,r.lastSuccessAt=Date.now(),r.updatedAt=Date.now(),u.debug(`[AccountQuotaCache] Updated state for ${e}: successCount=${r.successCount}`),await this.saveToStorage(),this._onQuotaStateChange.fire({accountId:e,provider:t,state:r})}async recordFailure(e,t,o,r){let i=this.getOrCreateState(e,t,r);i.failureCount++,i.lastFailureAt=Date.now(),i.lastError=o,i.updatedAt=Date.now(),await this.saveToStorage(),this._onQuotaStateChange.fire({accountId:e,provider:t,state:i})}isInCooldown(e){let t=this.cache.get(e);return!t||!t.quotaExceeded?!1:t.quotaResetAt&&Date.now()>=t.quotaResetAt?(this.clearQuotaExceeded(e),!1):!0}getRemainingCooldown(e){let t=this.cache.get(e);if(!t||!t.quotaExceeded||!t.quotaResetAt)return 0;let o=t.quotaResetAt-Date.now();return o>0?o:0}getState(e){return this.cache.get(e)}getAllStates(){let e=Array.from(this.cache.values());return u.debug(`[AccountQuotaCache] getAllStates returning ${e.length} states:`,e.map(t=>({accountId:t.accountId,provider:t.provider,successCount:t.successCount,failureCount:t.failureCount}))),e}getStatesByProvider(e){return Array.from(this.cache.values()).filter(t=>t.provider===e)}getAvailableAccounts(e){return Array.from(this.cache.values()).filter(t=>t.provider===e&&!this.isInCooldown(t.accountId)).map(t=>t.accountId)}getAccountWithShortestCooldown(e){return this.getStatesByProvider(e).filter(o=>o.quotaExceeded&&o.quotaResetAt).sort((o,r)=>(o.quotaResetAt||0)-(r.quotaResetAt||0))[0]?.accountId}calculateCooldown(e,t){e<0&&(e=0);let i=1e3*2**e;return i<1e3&&(i=1e3),t&&t>i&&(i=t),i>=18e5?{cooldown:18e5,newLevel:e}:{cooldown:i,newLevel:e+1}}async removeAccount(e){this.cache.has(e)&&(this.cache.delete(e),await this.saveToStorage())}async clearAll(){this.cache.clear(),await this.saveToStorage()}dispose(){this._onQuotaStateChange.dispose()}}});var px={};io(px,{AccountManager:()=>Ne});var dx,lx,ux,Ne,Vr=ke(()=>{"use strict";dx=D(require("vscode"));sr();ce();cr();lx="chp.accounts",ux=1,Ne=class n{static instance;context;accounts=new Map;activeAccounts={};routingConfig={};_onAccountChange=new dx.EventEmitter;onAccountChange=this._onAccountChange.event;static providerConfigs=new Map([["antigravity",{supportsMultiAccount:!0,supportsOAuth:!0,supportsApiKey:!1}],["zhipu",{supportsMultiAccount:!0,supportsOAuth:!1,supportsApiKey:!0}],["moonshot",{supportsMultiAccount:!0,supportsOAuth:!1,supportsApiKey:!0}],["minimax",{supportsMultiAccount:!0,supportsOAuth:!1,supportsApiKey:!0}],["compatible",{supportsMultiAccount:!0,supportsOAuth:!1,supportsApiKey:!0}],["deepseek",{supportsMultiAccount:!0,supportsOAuth:!1,supportsApiKey:!0}],["deepinfra",{supportsMultiAccount:!0,supportsOAuth:!1,supportsApiKey:!0}],["chutes",{supportsMultiAccount:!0,supportsOAuth:!1,supportsApiKey:!0}],["opencode",{supportsMultiAccount:!0,supportsOAuth:!1,supportsApiKey:!0}],["huggingface",{supportsMultiAccount:!0,supportsOAuth:!1,supportsApiKey:!0}],["mistral",{supportsMultiAccount:!0,supportsOAuth:!1,supportsApiKey:!0}],["openai",{supportsMultiAccount:!0,supportsOAuth:!1,supportsApiKey:!0}],["kimi",{supportsMultiAccount:!0,supportsOAuth:!1,supportsApiKey:!0}],["minimax-coding",{supportsMultiAccount:!0,supportsOAuth:!1,supportsApiKey:!0}],["qwencli",{supportsMultiAccount:!0,supportsOAuth:!0,supportsApiKey:!1}],["geminicli",{supportsMultiAccount:!0,supportsOAuth:!0,supportsApiKey:!1}]]);constructor(e){this.context=e}static initialize(e){return n.instance||(n.instance=new n(e),n.instance.loadFromStorage(),u.info("AccountManager initialized")),n.instance}static getInstance(){if(!n.instance)throw new Error("AccountManager not initialized. Call initialize() first.");return n.instance}generateAccountId(){let e=Date.now().toString(36),t=Math.random().toString(36).substring(2,8);return`acc_${e}_${t}`}async loadFromStorage(){try{let e=this.context.globalState.get(lx);if(e&&e.version===ux){this.accounts.clear();for(let t of e.accounts)this.accounts.set(t.id,t);this.activeAccounts=e.activeAccounts||{},this.routingConfig=e.routingConfig||{},this.syncIsDefaultWithActiveAccounts(),u.debug(`Loaded ${this.accounts.size} accounts from storage`)}}catch(e){u.error("Failed to load accounts from storage:",e)}}syncIsDefaultWithActiveAccounts(){for(let e of this.accounts.values())e.isDefault=!1;for(let[e,t]of Object.entries(this.activeAccounts)){let o=this.accounts.get(t);o&&o.provider===e&&(o.isDefault=!0)}}async saveToStorage(){try{let e={version:ux,accounts:Array.from(this.accounts.values()),activeAccounts:this.activeAccounts,routingConfig:this.routingConfig};await this.context.globalState.update(lx,e),u.debug("Accounts saved to storage")}catch(e){u.error("Failed to save accounts to storage:",e)}}async saveCredentials(e,t){let o=`chp.account.${e}.credentials`;await this.context.secrets.store(o,JSON.stringify(t))}async getCredentials(e){let t=`chp.account.${e}.credentials`,o=await this.context.secrets.get(t);if(o)try{return JSON.parse(o)}catch{return}}async deleteCredentials(e){let t=`chp.account.${e}.credentials`;await this.context.secrets.delete(t)}async addApiKeyAccount(e,t,o,r){try{let i=this.generateAccountId(),a=new Date().toISOString(),s={id:i,displayName:t,provider:e,authType:"apiKey",status:"active",createdAt:a,updatedAt:a,metadata:r?.metadata,isDefault:this.getAccountsByProvider(e).length===0},c={apiKey:o,endpoint:r?.endpoint,customHeaders:r?.customHeaders};return this.accounts.set(i,s),await this.saveCredentials(i,c),await this.saveToStorage(),s.isDefault&&(this.activeAccounts[e]=i),this._onAccountChange.fire({type:"added",account:s,provider:e}),u.info(`Added API Key account: ${t} for ${e}`),{success:!0,account:s}}catch(i){let a=i instanceof Error?i.message:"Unknown error";return u.error("Failed to add API Key account:",i),{success:!1,error:a}}}async addOAuthAccount(e,t,o,r,i){try{let a=this.generateAccountId(),s=new Date().toISOString(),c={id:a,displayName:t,provider:e,authType:"oauth",email:o,status:"active",createdAt:s,updatedAt:s,expiresAt:r.expiresAt,metadata:i,isDefault:this.getAccountsByProvider(e).length===0};return this.accounts.set(a,c),await this.saveCredentials(a,r),await this.saveToStorage(),c.isDefault&&(this.activeAccounts[e]=a),this._onAccountChange.fire({type:"added",account:c,provider:e}),u.info(`Added OAuth account: ${t} (${o}) for ${e}`),{success:!0,account:c}}catch(a){let s=a instanceof Error?a.message:"Unknown error";return u.error("Failed to add OAuth account:",a),{success:!1,error:s}}}async removeAccount(e){let t=this.accounts.get(e);if(!t)return u.warn(`Account not found: ${e}`),!1;try{if(await this.deleteCredentials(e),this.accounts.delete(e),this.activeAccounts[t.provider]===e){let r=this.getAccountsByProvider(t.provider);r.length>0?this.activeAccounts[t.provider]=r[0].id:delete this.activeAccounts[t.provider]}let o=this.routingConfig[t.provider];if(o?.modelAssignments)for(let[r,i]of Object.entries(o.modelAssignments))i===e&&delete o.modelAssignments[r];try{await it.getInstance().removeAccount(e)}catch{}return await this.saveToStorage(),this._onAccountChange.fire({type:"removed",account:t,provider:t.provider}),u.info(`Removed account: ${t.displayName}`),!0}catch(o){return u.error("Failed to remove account:",o),!1}}async switchAccount(e,t){let o=this.accounts.get(t);if(!o||o.provider!==e)return u.warn(`Account not found or provider mismatch: ${t}`),!1;try{let r=this.activeAccounts[e];if(r){let i=this.accounts.get(r);i&&(i.isDefault=!1)}return this.activeAccounts[e]=t,o.isDefault=!0,o.updatedAt=new Date().toISOString(),await this.saveToStorage(),this._onAccountChange.fire({type:"switched",account:o,provider:e}),u.info(`Switched to account: ${o.displayName} for ${e}`),!0}catch(r){return u.error("Failed to switch account:",r),!1}}getActiveAccount(e){let t=this.activeAccounts[e];if(t)return this.accounts.get(t)}async getActiveCredentials(e){let t=this.getActiveAccount(e);if(t)return this.getCredentials(t.id)}async getActiveApiKey(e){let t=await this.getActiveCredentials(e);if(t&&"apiKey"in t)return t.apiKey}async getActiveOAuthToken(e){let t=await this.getActiveCredentials(e);if(t&&"accessToken"in t)return t.accessToken}getAccountsByProvider(e){return Array.from(this.accounts.values()).filter(t=>t.provider===e)}getAllAccounts(){return Array.from(this.accounts.values())}getAccount(e){return this.accounts.get(e)}async updateAccount(e,t){let o=this.accounts.get(e);if(!o)return!1;try{return Object.assign(o,t,{updatedAt:new Date().toISOString()}),await this.saveToStorage(),this._onAccountChange.fire({type:"updated",account:o,provider:o.provider}),!0}catch(r){return u.error("Failed to update account:",r),!1}}async updateCredentials(e,t){let o=this.accounts.get(e);if(!o)return!1;try{return await this.saveCredentials(e,t),o.updatedAt=new Date().toISOString(),"expiresAt"in t&&(o.expiresAt=t.expiresAt),await this.saveToStorage(),!0}catch(r){return u.error("Failed to update credentials:",r),!1}}getModelAccountAssignments(e){return{...this.routingConfig[e]?.modelAssignments||{}}}getAccountIdForModel(e,t){return this.routingConfig[e]?.modelAssignments?.[t]}async setAccountForModel(e,t,o){let r=this.ensureProviderRoutingConfig(e);o?r.modelAssignments[t]=o:delete r.modelAssignments[t],await this.saveToStorage()}getLoadBalanceEnabled(e){let t=e==="antigravity";return this.routingConfig[e]?.loadBalanceEnabled??t}async setLoadBalanceEnabled(e,t){let o=this.ensureProviderRoutingConfig(e);o.loadBalanceEnabled=t,await this.saveToStorage()}ensureProviderRoutingConfig(e){return this.routingConfig[e]?this.routingConfig[e].modelAssignments||(this.routingConfig[e].modelAssignments={}):this.routingConfig[e]={modelAssignments:{},loadBalanceEnabled:!1},this.routingConfig[e]}static supportsMultiAccount(e){return n.providerConfigs.get(e)?.supportsMultiAccount??!0}static getProviderConfig(e){return n.providerConfigs.get(e)??{supportsMultiAccount:!0,supportsOAuth:!1,supportsApiKey:!0}}static registerProviderConfig(e,t){n.providerConfigs.set(e,t)}isAccountExpired(e){let t=this.accounts.get(e);return!t||!t.expiresAt?!1:new Date(t.expiresAt)<new Date}async markAccountExpired(e){await this.updateAccount(e,{status:"expired"})}async markAccountError(e,t){await this.updateAccount(e,{status:"error",metadata:{...this.accounts.get(e)?.metadata,lastError:t}})}isAccountQuotaLimited(e){try{return it.getInstance().isInCooldown(e)}catch{return!1}}getAccountQuotaCooldown(e){try{return it.getInstance().getRemainingCooldown(e)}catch{return 0}}getAvailableAccountsForProvider(e){return this.getAccountsByProvider(e).filter(o=>o.status==="active"&&!this.isAccountExpired(o.id)&&!this.isAccountQuotaLimited(o.id))}getNextAvailableAccount(e,t){let o=this.getAvailableAccountsForProvider(e);if(o.length===0){try{let i=it.getInstance().getAccountWithShortestCooldown(e);if(i)return this.accounts.get(i)}catch{}return}if(o.length===0){try{let i=it.getInstance().getAccountWithShortestCooldown(e);if(i)return this.accounts.get(i)}catch{}return}if(t){let r=o.findIndex(i=>i.id===t);if(r>=0&&r<o.length-1)return o[r+1]}return o[0]}dispose(){this._onAccountChange.dispose()}}});var mx,fx=ke(()=>{mx=`/* Account Manager Page Styles */
:root {
	--vscode-font-family: var(
		--vscode-editor-font-family,
		-apple-system,
		BlinkMacSystemFont,
		"Segoe UI",
		Roboto,
		Oxygen,
		Ubuntu,
		Cantarell,
		"Open Sans",
		"Helvetica Neue",
		sans-serif
	);
	--vscode-font-size: var(--vscode-editor-font-size, 13px);

	--radius-lg: 16px;
	--radius-md: 12px;
	--radius-sm: 10px;
	--shadow-soft: 0 10px 28px rgba(0, 0, 0, 0.12);
}

* {
	box-sizing: border-box;
	margin: 0;
	padding: 0;
}

body {
	font-family: var(--vscode-font-family);
	font-size: var(--vscode-font-size);
	color: var(--vscode-foreground);
	background-color: var(--vscode-editor-background);
	padding: 16px 16px 24px;
	line-height: 1.4;
}

.container {
	max-width: 1100px;
	margin: 0 auto;
}

.shell {
	display: flex;
	flex-direction: column;
	gap: 14px;
}

.surface {
	background: var(
		--vscode-editorWidget-background,
		var(--vscode-editor-background)
	);
	border: 1px solid var(--vscode-panel-border);
	border-radius: var(--radius-lg);
	box-shadow: 0 1px 0 rgba(0, 0, 0, 0.06);
}

/* Top bar */
.topbar {
	display: flex;
	align-items: center;
	justify-content: space-between;
	gap: 12px;
	padding: 14px 16px;
}

.topbar-title {
	min-width: 0;
}

.topbar-title-text {
	font-size: 18px;
	font-weight: 700;
	color: var(--vscode-foreground);
}

.topbar-subtitle {
	margin-top: 2px;
	font-size: 12px;
	color: var(--vscode-descriptionForeground);
}

.topbar-actions {
	display: flex;
	gap: 10px;
	align-items: center;
	flex-shrink: 0;
}

/* Settings link */
.settings-link {
	display: flex;
	align-items: center;
	gap: 6px;
	padding: 6px 12px;
	border-radius: var(--radius-sm);
	color: var(--vscode-textLink-foreground);
	text-decoration: none;
	font-size: 13px;
	font-weight: 500;
	transition:
		background-color 0.15s ease,
		color 0.15s ease;
	cursor: pointer;
}

.settings-link:hover {
	background-color: var(--vscode-toolbar-hoverBackground);
	color: var(
		--vscode-textLink-activeForeground,
		var(--vscode-textLink-foreground)
	);
}

.settings-icon {
	font-size: 14px;
}

.settings-text {
	white-space: nowrap;
}

/* Main layout */
.layout {
	display: grid;
	grid-template-columns: 260px 1fr;
	gap: 14px;
	align-items: start;
}

.sidebar {
	padding: 14px;
	display: flex;
	flex-direction: column;
	gap: 12px;
	position: sticky;
	top: 16px;
}

.sidebar-header {
	display: flex;
	align-items: center;
	justify-content: space-between;
}

.sidebar-title {
	font-size: 12px;
	font-weight: 700;
	color: var(--vscode-descriptionForeground);
	letter-spacing: 0.8px;
	text-transform: uppercase;
}

.provider-list {
	display: flex;
	flex-direction: column;
	gap: 6px;
}

.provider-item {
	width: 100%;
	display: grid;
	grid-template-columns: 28px 1fr auto;
	align-items: center;
	gap: 10px;
	padding: 10px 10px;
	border-radius: var(--radius-md);
	border: 1px solid transparent;
	background: transparent;
	color: var(--vscode-foreground);
	cursor: pointer;
	text-align: left;
}

.provider-item:hover {
	background: var(--vscode-list-hoverBackground);
}

.provider-item.active {
	background: var(--vscode-list-inactiveSelectionBackground);
	border-color: var(--vscode-focusBorder);
}

.provider-item-icon {
	display: inline-flex;
	width: 28px;
	height: 28px;
	border-radius: var(--radius-sm);
	align-items: center;
	justify-content: center;
	background: var(--vscode-badge-background);
	color: var(--vscode-badge-foreground);
	font-size: 14px;
}

.provider-icon-img {
	width: 100%;
	height: 100%;
	object-fit: contain;
	border-radius: var(--radius-sm);
}

.provider-item-name {
	min-width: 0;
	overflow: hidden;
	text-overflow: ellipsis;
	white-space: nowrap;
	font-weight: 600;
	font-size: 13px;
}

.provider-item-count {
	font-variant-numeric: tabular-nums;
	font-size: 12px;
	color: var(--vscode-descriptionForeground);
	padding: 2px 8px;
	border-radius: 999px;
	border: 1px solid var(--vscode-panel-border);
}

.sidebar-footer {
	margin-top: 6px;
}

.btn-block {
	width: 100%;
	justify-content: center;
}

.content {
	padding: 14px;
}

.content-header {
	display: flex;
	align-items: flex-start;
	justify-content: space-between;
	gap: 12px;
	margin-bottom: 12px;
}

.content-title {
	font-size: 16px;
	font-weight: 700;
}

.content-subtitle {
	margin-top: 2px;
	font-size: 12px;
	color: var(--vscode-descriptionForeground);
}

.content-actions {
	flex-shrink: 0;
}

.account-cards {
	display: flex;
	flex-direction: column;
	gap: 10px;
}

/* Notice */
.notice {
	padding: 12px 14px;
	border-radius: var(--radius-lg);
	border: 1px solid var(--vscode-panel-border);
	background: var(
		--vscode-editorWidget-background,
		var(--vscode-editor-background)
	);
}

.notice-warning {
	border-color: var(--vscode-notificationsWarningBorder, #ffa500);
	background: var(
		--vscode-inputValidation-warningBackground,
		rgba(255, 165, 0, 0.08)
	);
}

.notice-title {
	font-weight: 700;
	font-size: 13px;
	color: var(--vscode-notificationsWarningForeground, #ffa500);
	margin-bottom: 4px;
}

.notice-body {
	color: var(--vscode-foreground);
	font-size: 12px;
}

.notice-meta {
	margin-top: 4px;
	color: var(--vscode-descriptionForeground);
}

.quota-countdown {
	font-variant-numeric: tabular-nums;
	font-weight: 700;
	color: var(--vscode-foreground);
}

/* Codex Rate Limit Banner */
.codex-rate-limit-banner {
	display: flex;
	flex-direction: column;
	gap: 8px;
	margin: 0 0 16px;
	padding: 12px 16px;
	border-radius: 4px;
	border-left: 3px solid var(--vscode-charts-green, #4caf50);
	background: var(--vscode-editor-background);
	border: 1px solid var(--vscode-panel-border);
}

.codex-rate-limit-banner.warning {
	border-left-color: var(--vscode-notificationsWarningBorder, #ffa500);
	background: var(
		--vscode-inputValidation-warningBackground,
		rgba(255, 165, 0, 0.08)
	);
}

.rate-limit-header {
	display: flex;
	align-items: center;
	gap: 8px;
}

.rate-limit-icon {
	font-size: 14px;
}

.rate-limit-title {
	font-weight: 600;
	font-size: 13px;
	color: var(--vscode-foreground);
}

.rate-limit-updated {
	margin-left: auto;
	font-size: 11px;
	color: var(--vscode-descriptionForeground);
}

.rate-limit-content {
	display: flex;
	flex-direction: column;
	gap: 4px;
}

.rate-limit-row {
	display: flex;
	align-items: center;
	gap: 8px;
	font-size: 12px;
}

.rate-limit-label {
	min-width: 60px;
	color: var(--vscode-descriptionForeground);
}

.rate-limit-bar {
	font-family: monospace;
	font-size: 11px;
	color: var(--vscode-foreground);
	opacity: 0.8;
}

.rate-limit-value {
	min-width: 35px;
	text-align: right;
	font-weight: 600;
	color: var(--vscode-foreground);
}

.codex-rate-limit-banner.warning .rate-limit-value {
	color: var(--vscode-notificationsWarningForeground, #ffa500);
}

/* Account-level Rate Limit (inline in account card) */
.account-rate-limit {
	margin-top: 8px;
	padding: 8px 10px;
	border-radius: 4px;
	background: var(--vscode-editor-background);
	border: 1px solid var(--vscode-panel-border);
	font-size: 11px;
}

.account-rate-limit.warning {
	border-color: var(--vscode-notificationsWarningBorder, #ffa500);
	background: var(
		--vscode-inputValidation-warningBackground,
		rgba(255, 165, 0, 0.08)
	);
}

.rate-limit-header-inline {
	display: flex;
	align-items: center;
	gap: 6px;
	margin-bottom: 4px;
}

.rate-limit-title-small {
	font-weight: 600;
	font-size: 11px;
	color: var(--vscode-foreground);
}

.rate-limit-value.warning {
	color: var(--vscode-notificationsWarningForeground, #ffa500);
}

/* Account Quota State (cached quota info) */
.account-quota-state {
	margin-top: 8px;
	padding: 8px 10px;
	border-radius: 4px;
	background: var(--vscode-editor-background);
	border: 1px solid var(--vscode-panel-border);
	font-size: 11px;
}

.account-quota-state.success {
	border-color: var(--vscode-notificationsInfoBorder, #3794ff);
}

.account-quota-state.warning {
	border-color: var(--vscode-notificationsWarningBorder, #ffa500);
	background: var(
		--vscode-inputValidation-warningBackground,
		rgba(255, 165, 0, 0.08)
	);
}

.account-quota-state.error {
	border-color: var(--vscode-notificationsErrorBorder, #f14c4c);
	background: var(
		--vscode-inputValidation-errorBackground,
		rgba(241, 76, 76, 0.08)
	);
}

.quota-state-header {
	display: flex;
	align-items: center;
	gap: 6px;
	margin-bottom: 6px;
}

.quota-state-icon {
	font-size: 12px;
}

.quota-state-title {
	font-weight: 600;
	font-size: 11px;
	color: var(--vscode-foreground);
}

.quota-state-content {
	display: flex;
	flex-direction: column;
	gap: 2px;
}

.quota-state-row {
	display: flex;
	justify-content: space-between;
	align-items: center;
	gap: 8px;
}

.quota-state-row.warning {
	color: var(--vscode-notificationsWarningForeground, #ffa500);
}

.quota-state-label {
	color: var(--vscode-descriptionForeground);
	font-size: 10px;
}

.quota-state-value {
	font-family: var(--vscode-editor-font-family, monospace);
	font-size: 10px;
	color: var(--vscode-foreground);
}

.quota-state-value.success {
	color: var(--vscode-notificationsInfoForeground, #3794ff);
}

.quota-state-value.warning {
	color: var(--vscode-notificationsWarningForeground, #ffa500);
}

.quota-state-value.error {
	color: var(--vscode-notificationsErrorForeground, #f14c4c);
}

/* Buttons */
.btn {
	display: inline-flex;
	align-items: center;
	gap: 6px;
	padding: 8px 14px;
	border: 1px solid transparent;
	border-radius: 12px;
	font-size: 12px;
	font-weight: 600;
	cursor: pointer;
	transition: opacity 0.15s ease;
}

.btn:hover {
	opacity: 0.85;
}

.btn-primary {
	background-color: var(--vscode-button-background);
	color: var(--vscode-button-foreground);
}

.btn-secondary {
	background-color: var(--vscode-button-secondaryBackground);
	color: var(--vscode-button-secondaryForeground);
	border-color: transparent;
}

.btn-ghost {
	background: transparent;
	border-color: var(--vscode-panel-border);
	color: var(--vscode-foreground);
}

.btn-ghost:hover {
	background: var(--vscode-list-hoverBackground);
}

.btn-danger {
	background-color: rgba(220, 53, 69, 0.15);
	color: var(--vscode-errorForeground, #dc3545);
	border: 1px solid rgba(220, 53, 69, 0.3);
}

.btn-icon {
	padding: 8px 10px;
	background: transparent;
	border: 1px solid var(--vscode-panel-border);
	min-width: 34px;
	justify-content: center;
}

.btn-icon:hover {
	background-color: var(--vscode-list-hoverBackground);
}

/* ===== SIMPLIFIED ACCOUNT CARD ===== */
.account-card-simple {
	display: flex;
	align-items: center;
	gap: 12px;
	padding: 12px 14px;
	border-radius: var(--radius-lg);
	border: 1px solid var(--vscode-panel-border);
	background: var(--vscode-editor-background);
	transition: all 0.15s ease;
}

.account-card-simple:hover {
	background: var(--vscode-list-hoverBackground);
	border-color: var(--vscode-focusBorder);
}

.account-card-simple.active {
	background: var(--vscode-list-inactiveSelectionBackground);
	border-color: var(--vscode-focusBorder);
}

.account-card-simple.quota-limited {
	border-color: var(--vscode-notificationsWarningBorder, #ffa500);
	background: var(
		--vscode-inputValidation-warningBackground,
		rgba(255, 165, 0, 0.05)
	);
}

.account-card-left {
	display: flex;
	align-items: center;
	gap: 12px;
	flex: 1;
	min-width: 0;
	cursor: pointer;
}

.account-info-compact {
	flex: 1;
	min-width: 0;
}

.account-name-row {
	display: flex;
	align-items: center;
	gap: 8px;
	flex-wrap: wrap;
}

.status-dot-inline {
	width: 8px;
	height: 8px;
	border-radius: 50%;
	background: var(--vscode-charts-green, #4caf50);
	flex-shrink: 0;
}

.status-dot-inline.inactive,
.status-dot-inline.error {
	background: var(--vscode-charts-red, #f14c4c);
}

.status-dot-inline.pending {
	background: var(--vscode-charts-yellow, #cca700);
}

.account-email-compact {
	font-size: 11px;
	color: var(--vscode-descriptionForeground);
	margin-top: 2px;
	overflow: hidden;
	text-overflow: ellipsis;
	white-space: nowrap;
}

.account-meta-compact {
	display: flex;
	gap: 12px;
	margin-top: 4px;
	font-size: 11px;
	color: var(--vscode-descriptionForeground);
}

.account-stats {
	font-family: var(--vscode-editor-font-family, monospace);
}

.quota-badge-compact {
	padding: 4px 10px;
	border-radius: 999px;
	background: var(
		--vscode-inputValidation-warningBackground,
		rgba(255, 165, 0, 0.15)
	);
	border: 1px solid var(--vscode-notificationsWarningBorder, #ffa500);
	font-size: 11px;
	font-weight: 600;
	color: var(--vscode-notificationsWarningForeground, #ffa500);
	white-space: nowrap;
}

.quota-countdown-compact {
	font-variant-numeric: tabular-nums;
}

/* Bigger, easier to click action buttons */
.account-actions-compact {
	display: flex;
	gap: 8px;
	flex-shrink: 0;
}

.btn-action {
	display: flex;
	align-items: center;
	justify-content: center;
	min-width: 44px;
	height: 44px;
	padding: 0 16px;
	border-radius: 12px;
	border: 1px solid var(--vscode-panel-border);
	background: transparent;
	color: var(--vscode-foreground);
	font-size: 14px;
	font-weight: 600;
	cursor: pointer;
	transition: all 0.15s ease;
}

.btn-action:hover {
	background: var(--vscode-list-hoverBackground);
}

.btn-action.btn-use {
	background: var(--vscode-button-background);
	color: var(--vscode-button-foreground);
	border-color: transparent;
	padding: 0 20px;
}

.btn-action.btn-use:hover {
	opacity: 0.9;
}

.btn-action.btn-info {
	font-size: 16px;
}

.btn-action.btn-delete {
	color: var(--vscode-errorForeground, #f14c4c);
	font-size: 16px;
}

.btn-action.btn-delete:hover {
	background: rgba(220, 53, 69, 0.15);
	border-color: rgba(220, 53, 69, 0.3);
}

/* Legacy account-card styles (keep for compatibility) */
.account-card {
	display: flex;
	align-items: flex-start;
	justify-content: space-between;
	gap: 12px;
	padding: 12px 12px;
	border-radius: var(--radius-lg);
	border: 1px solid var(--vscode-panel-border);
	background: var(--vscode-editor-background);
	transition:
		background-color 0.15s ease,
		border-color 0.15s ease;
	position: relative;
}

.account-card.clickable {
	cursor: pointer;
}

.account-card.clickable::after {
	content: "";
	position: absolute;
	inset: 0;
	border-radius: var(--radius-lg);
	box-shadow: inset 0 0 0 1px transparent;
	pointer-events: none;
	transition: box-shadow 0.15s ease;
}

.account-card.clickable:hover::after {
	box-shadow: inset 0 0 0 1px var(--vscode-focusBorder);
}

.account-card:hover {
	background: var(--vscode-list-hoverBackground);
	border-color: var(--vscode-focusBorder);
}

.account-card.active {
	background: var(--vscode-list-inactiveSelectionBackground);
	border-color: var(--vscode-focusBorder);
}

/* Quota limited account card - Simplified */
.account-card.quota-limited {
	border-color: var(--vscode-notificationsWarningBorder, #ffa500);
	background: var(
		--vscode-inputValidation-warningBackground,
		rgba(255, 165, 0, 0.05)
	);
}

.account-card-main {
	display: flex;
	align-items: flex-start;
	gap: 12px;
	min-width: 0;
	flex: 1;
}

.account-avatar {
	display: flex;
	align-items: center;
	justify-content: center;
	width: 32px;
	height: 32px;
	border-radius: 50%;
	background: var(--vscode-textLink-foreground, #3794ff);
	color: #fff;
	font-size: 12px;
	font-weight: 600;
	flex-shrink: 0;
	text-transform: uppercase;
}

.account-card-info {
	min-width: 0;
	flex: 1;
}

.account-card-title {
	display: flex;
	flex-wrap: wrap;
	gap: 6px;
	align-items: center;
}

.account-name {
	font-size: 13px;
	font-weight: 700;
	color: var(--vscode-foreground);
	margin-right: 2px;
}

.badge {
	display: inline-flex;
	align-items: center;
	gap: 6px;
	padding: 3px 8px;
	border-radius: 999px;
	font-size: 11px;
	font-weight: 700;
	border: 1px solid var(--vscode-panel-border);
	background: transparent;
	color: var(--vscode-foreground);
}

.badge-primary {
	background: var(--vscode-badge-background);
	border-color: transparent;
	color: var(--vscode-badge-foreground);
}

.badge-muted {
	color: var(--vscode-descriptionForeground);
}

.badge-warning {
	border-color: var(--vscode-notificationsWarningBorder, #ffa500);
	color: var(--vscode-notificationsWarningForeground, #ffa500);
	background: var(
		--vscode-inputValidation-warningBackground,
		rgba(255, 165, 0, 0.08)
	);
}

.badge-status {
	color: var(--vscode-descriptionForeground);
}

.account-quota-inline {
	margin-top: 8px;
	display: inline-flex;
	flex-wrap: wrap;
	align-items: center;
	gap: 8px;
	padding: 6px 10px;
	border-radius: 999px;
	border: 1px solid var(--vscode-notificationsWarningBorder, #ffa500);
	background: var(
		--vscode-inputValidation-warningBackground,
		rgba(255, 165, 0, 0.08)
	);
	font-size: 11px;
}

.quota-model {
	color: var(--vscode-foreground);
	font-weight: 600;
}

.quota-timer {
	color: var(--vscode-descriptionForeground);
	font-size: 11px;
}

.quota-timer .account-quota-countdown {
	font-weight: 600;
	color: var(--vscode-foreground);
	font-variant-numeric: tabular-nums;
	font-size: 12px;
}

.account-email {
	font-size: 11px;
	color: var(--vscode-descriptionForeground);
	margin-top: 2px;
}

.account-meta {
	display: flex;
	gap: 10px;
	margin-top: 4px;
	font-size: 11px;
	color: var(--vscode-descriptionForeground);
}

.account-meta-item {
	display: flex;
	align-items: center;
	gap: 4px;
}

/* Legacy status pills (still used in details modal) */
.account-status {
	display: inline-flex;
	align-items: center;
	gap: 6px;
	padding: 3px 10px;
	border-radius: 999px;
	font-size: 11px;
	font-weight: 700;
	border: 1px solid var(--vscode-panel-border);
}

.account-status.active {
	background: rgba(40, 167, 69, 0.12);
	border-color: rgba(40, 167, 69, 0.28);
	color: #28a745;
}

.account-status.inactive {
	background: rgba(108, 117, 125, 0.12);
	border-color: rgba(108, 117, 125, 0.28);
	color: #6c757d;
}

.account-status.expired {
	background: rgba(255, 193, 7, 0.12);
	border-color: rgba(255, 193, 7, 0.28);
	color: #ffc107;
}

.account-status.error {
	background: rgba(220, 53, 69, 0.12);
	border-color: rgba(220, 53, 69, 0.28);
	color: #dc3545;
}

.status-dot {
	width: 6px;
	height: 6px;
	border-radius: 50%;
}

.status-dot.active {
	background-color: #28a745;
}

.status-dot.inactive {
	background-color: #6c757d;
}

.status-dot.expired {
	background-color: #ffc107;
}

.status-dot.error {
	background-color: #dc3545;
}

.account-card-actions {
	display: flex;
	gap: 8px;
	align-items: center;
	justify-content: flex-end;
	flex-shrink: 0;
}

.btn-compact {
	padding: 6px 12px;
	font-size: 11px;
	border-radius: 10px;
}

/* Empty State - Simplified */
.empty-state {
	text-align: center;
	padding: 32px 16px;
	color: var(--vscode-descriptionForeground);
}

.empty-state-title {
	font-size: 15px;
	font-weight: 600;
	color: var(--vscode-foreground);
	margin-bottom: 8px;
}

.empty-state-description {
	font-size: 13px;
	margin-bottom: 16px;
	line-height: 1.5;
}

/* Modal - Simplified */
.modal-overlay {
	position: fixed;
	top: 0;
	left: 0;
	right: 0;
	bottom: 0;
	background-color: rgba(0, 0, 0, 0.5);
	display: flex;
	align-items: center;
	justify-content: center;
	z-index: 1000;
	animation: fadeIn 0.15s ease;
}

@keyframes fadeIn {
	from {
		opacity: 0;
	}
	to {
		opacity: 1;
	}
}

.modal {
	background-color: var(--vscode-editor-background);
	border-radius: var(--radius-lg);
	border: 1px solid var(--vscode-panel-border);
	max-width: 500px;
	width: 90%;
	max-height: 85vh;
	overflow: hidden;
	display: flex;
	flex-direction: column;
	animation: slideUp 0.15s ease;
}

@keyframes slideUp {
	from {
		opacity: 0;
		transform: translateY(10px);
	}
	to {
		opacity: 1;
		transform: translateY(0);
	}
}

.modal-header {
	display: flex;
	justify-content: space-between;
	align-items: center;
	padding: 14px 16px;
	border-bottom: 1px solid var(--vscode-panel-border);
	background: var(--vscode-editor-background);
}

.modal-title {
	font-size: 16px;
	font-weight: 600;
}

.modal-close {
	background: none;
	border: none;
	font-size: 20px;
	cursor: pointer;
	color: var(--vscode-foreground);
	opacity: 0.6;
	transition: opacity 0.15s ease;
	width: 28px;
	height: 28px;
	display: flex;
	align-items: center;
	justify-content: center;
	border-radius: 10px;
}

.modal-close:hover {
	opacity: 1;
	background-color: var(--vscode-list-hoverBackground);
}

.modal-body {
	padding: 16px;
	overflow-y: auto;
}

.modal-footer {
	display: flex;
	justify-content: flex-end;
	gap: 8px;
	padding: 14px 16px;
	border-top: 1px solid var(--vscode-panel-border);
	background-color: var(--vscode-editor-background);
}

/* Form Elements - Simplified */
.form-group {
	margin-bottom: 16px;
}

.form-label {
	display: block;
	font-size: 12px;
	font-weight: 600;
	margin-bottom: 6px;
	color: var(--vscode-foreground);
}

.form-input {
	width: 100%;
	padding: 8px 12px;
	font-size: 12px;
	border: 1px solid var(--vscode-input-border);
	border-radius: 12px;
	background-color: var(--vscode-input-background);
	color: var(--vscode-input-foreground);
	transition: border-color 0.15s ease;
}

.form-input:focus {
	outline: none;
	border-color: var(--vscode-focusBorder);
}

.form-input::placeholder {
	color: var(--vscode-input-placeholderForeground);
}

.form-select {
	width: 100%;
	padding: 8px 12px;
	font-size: 12px;
	border: 1px solid var(--vscode-input-border);
	border-radius: 12px;
	background-color: var(--vscode-input-background);
	color: var(--vscode-input-foreground);
	cursor: pointer;
	transition: border-color 0.15s ease;
}

.form-select:focus {
	outline: none;
	border-color: var(--vscode-focusBorder);
}

.form-hint {
	font-size: 11px;
	color: var(--vscode-descriptionForeground);
	margin-top: 4px;
	line-height: 1.4;
}

/* Provider Select Grid - Simplified */
.provider-select-grid {
	display: grid;
	grid-template-columns: repeat(2, 1fr);
	gap: 12px;
	margin-bottom: 16px;
}

.provider-select-item {
	display: flex;
	align-items: center;
	gap: 10px;
	padding: 10px;
	border: 1px solid var(--vscode-panel-border);
	border-radius: 12px;
	cursor: pointer;
	transition:
		border-color 0.15s ease,
		background-color 0.15s ease;
	background: var(--vscode-editor-background);
}

.provider-select-item:hover {
	border-color: var(--vscode-focusBorder);
	background: var(--vscode-list-hoverBackground);
}

.provider-select-item.selected {
	border-color: var(--vscode-textLink-foreground);
	background: var(--vscode-list-inactiveSelectionBackground);
}

.provider-select-icon {
	display: inline-flex;
	width: 32px;
	height: 32px;
	border-radius: var(--radius-sm);
	align-items: center;
	justify-content: center;
	background: var(--vscode-badge-background);
	color: var(--vscode-badge-foreground);
	font-size: 16px;
	flex-shrink: 0;
}

.provider-select-info {
	flex: 1;
}

.provider-select-name {
	font-weight: 600;
	font-size: 13px;
	margin-bottom: 2px;
}

.provider-select-type {
	font-size: 10px;
	color: var(--vscode-descriptionForeground);
	text-transform: uppercase;
	letter-spacing: 0.3px;
}

/* Toast Notifications - Simplified */
.toast-container {
	position: fixed;
	top: 16px;
	right: 16px;
	z-index: 2000;
	display: flex;
	flex-direction: column;
	gap: 8px;
}

.toast {
	display: flex;
	align-items: center;
	gap: 10px;
	padding: 10px 14px;
	border-radius: 12px;
	animation: slideIn 0.15s ease;
	min-width: 250px;
	font-size: 12px;
}

.toast.success {
	background: rgba(40, 167, 69, 0.9);
	color: white;
}

.toast.error {
	background: rgba(220, 53, 69, 0.9);
	color: white;
}

.toast.warning {
	background: rgba(255, 193, 7, 0.9);
	color: #000;
}

.toast.info {
	background: var(--vscode-button-background);
	color: var(--vscode-button-foreground);
}

@keyframes slideIn {
	from {
		transform: translateX(100%);
		opacity: 0;
	}
	to {
		transform: translateX(0);
		opacity: 1;
	}
}

/* Loading Spinner - Simplified */
.loading-spinner {
	display: inline-block;
	width: 14px;
	height: 14px;
	border: 2px solid var(--vscode-foreground);
	border-radius: 50%;
	border-top-color: transparent;
	animation: spin 0.7s linear infinite;
}

@keyframes spin {
	to {
		transform: rotate(360deg);
	}
}

/* Responsive - Simplified */
@media (max-width: 768px) {
	.layout {
		grid-template-columns: 1fr;
	}

	.sidebar {
		position: static;
		top: auto;
	}

	.provider-select-grid {
		grid-template-columns: 1fr;
	}

	/* Simplified account card on mobile */
	.account-card-simple {
		flex-wrap: wrap;
		gap: 10px;
	}

	.account-card-left {
		width: 100%;
	}

	.account-actions-compact {
		width: 100%;
		justify-content: flex-end;
	}

	.btn-action {
		min-width: 48px;
		height: 48px;
	}

	.btn-action.btn-use {
		flex: 1;
		max-width: 120px;
	}

	.quota-badge-compact {
		margin-left: auto;
	}
}

/* Scrollbar - Simplified */
::-webkit-scrollbar {
	width: 6px;
	height: 6px;
}

::-webkit-scrollbar-track {
	background: transparent;
}

::-webkit-scrollbar-thumb {
	background-color: var(--vscode-scrollbarSlider-background);
	border-radius: 3px;
}

::-webkit-scrollbar-thumb:hover {
	background-color: var(--vscode-scrollbarSlider-hoverBackground);
}
`});var hx,gx=ke(()=>{hx=`/**\r
 * Account Manager Page JavaScript\r
 * Handles all UI interactions for the Account Manager WebView\r
 */\r
\r
// VS Code API\r
const vscode = acquireVsCodeApi();\r
\r
// State\r
let accounts = [];\r
let providers = [];\r
let selectedProvider = null;\r
let antigravityQuota = null;\r
let antigravityQuotaTimer = null;\r
let codexRateLimits = [];\r
let accountQuotaStates = [];\r
let _providerImageUris = {};\r
\r
/**\r
 * Initialize the Account Manager\r
 */\r
function _initializeAccountManager(\r
    initialAccounts,\r
    initialProviders,\r
    initialAntigravityQuota,\r
    initialCodexRateLimits,\r
    initialAccountQuotaStates,\r
    initialProviderImageUris,\r
) {\r
    accounts = initialAccounts || [];\r
    providers = initialProviders || [];\r
    antigravityQuota = normalizeAntigravityQuota(initialAntigravityQuota);\r
    codexRateLimits = initialCodexRateLimits || [];\r
    accountQuotaStates = initialAccountQuotaStates || [];\r
    _providerImageUris = initialProviderImageUris || {};\r
\r
    // Restore selected provider from persisted state if possible\r
    try {\r
        const state = vscode.getState() || {};\r
        if (typeof state.selectedProvider === "string") {\r
            selectedProvider = state.selectedProvider;\r
        }\r
    } catch {\r
        // Ignore state restore failures\r
    }\r
    ensureSelectedProvider();\r
\r
    renderPage();\r
    setupEventListeners();\r
}\r
\r
/**\r
 * Render the entire page\r
 */\r
function renderPage() {\r
    const app = document.getElementById("app");\r
    if (!app) {\r
        console.error("Account Manager: app element not found");\r
        return;\r
    }\r
    ensureSelectedProvider();\r
    app.innerHTML = \`\r
        <div class="shell">\r
            \${renderHeader()}\r
            \${renderQuotaBanner()}\r
            \${renderMainLayout()}\r
            <div id="modal-container"></div>\r
            <div class="toast-container" id="toast-container"></div>\r
        </div>\r
    \`;\r
    startQuotaCountdown();\r
}\r
\r
/**\r
 * Render header section\r
 */\r
function renderHeader() {\r
    const totalAccounts = accounts.length;\r
    const providersWithAccounts = [...new Set(accounts.map((a) => a.provider))]\r
        .length;\r
    const subtitle = \`\${totalAccounts} account\${totalAccounts !== 1 ? "s" : ""} \xB7 \${providersWithAccounts} provider\${providersWithAccounts !== 1 ? "s" : ""}\`;\r
    return \`\r
        <div class="topbar">\r
            <div class="topbar-title">\r
                <div class="topbar-title-text">Account Manager</div>\r
                <div class="topbar-subtitle">\${escapeHtml(subtitle)}</div>\r
            </div>\r
            <div class="topbar-actions">\r
                <a class="settings-link" href="#" onclick="openGCMPSettings(); return false;" title="Configure load balancing and advanced settings for AI Chat Models">\r
                    <span class="settings-icon"></span>\r
                    <span class="settings-text">GCMP Settings</span>\r
                </a>\r
                <button class="btn btn-primary" onclick="showAddAccountModal()">Add account</button>\r
                <button class="btn btn-ghost" onclick="refreshAccounts()">Refresh</button>\r
            </div>\r
        </div>\r
    \`;\r
}\r
\r
/**\r
 * Open GCMP Settings page\r
 */\r
function _openGCMPSettings() {\r
    vscode.postMessage({\r
        command: "openSettings",\r
    });\r
}\r
\r
/**\r
 * Render Antigravity quota banner\r
 */\r
function renderQuotaBanner() {\r
    if (!antigravityQuota) {\r
        return "";\r
    }\r
\r
    const remaining = antigravityQuota.resetAt - Date.now();\r
    if (remaining <= 0) {\r
        return "";\r
    }\r
\r
    const modelLabel = antigravityQuota.modelName\r
        ? escapeHtml(antigravityQuota.modelName)\r
        : "Unknown model";\r
    const accountLabel = antigravityQuota.accountName\r
        ? escapeHtml(antigravityQuota.accountName)\r
        : "";\r
\r
    return \`\r
        <div class="notice notice-warning" id="quota-banner">\r
            <div class="notice-title">Quota exceeded</div>\r
            <div class="notice-body">\r
                <div><strong>\${modelLabel}</strong> \${accountLabel ? \`\xB7 \${accountLabel}\` : ""}</div>\r
                <div class="notice-meta">Retry in <span class="quota-countdown" id="quota-countdown">\${formatCountdown(remaining)}</span></div>\r
            </div>\r
        </div>\r
    \`;\r
}\r
\r
function renderMainLayout() {\r
    const providerSummary = getProviderSummary();\r
    if (providerSummary.length === 0) {\r
        return \`\r
            <div class="layout">\r
                <div class="surface sidebar">\r
                    <div class="sidebar-header">\r
                        <div class="sidebar-title">Providers</div>\r
                    </div>\r
                    <div class="sidebar-empty">No providers</div>\r
                </div>\r
                <div class="surface content">\r
                    \${renderEmptyState()}\r
                </div>\r
            </div>\r
        \`;\r
    }\r
\r
    // Ensure selected provider exists\r
    const selected =\r
        providerSummary.find((p) => p.id === selectedProvider) ||\r
        providerSummary[0];\r
    if (selected && selected.id !== selectedProvider) {\r
        setSelectedProvider(selected.id);\r
    }\r
\r
    const providerAccounts = accounts.filter(\r
        (a) => a.provider === selectedProvider,\r
    );\r
\r
    return \`\r
        <div class="layout">\r
            \${renderSidebar(providerSummary)}\r
            \${renderContent(selected, providerAccounts)}\r
        </div>\r
    \`;\r
}\r
\r
function renderSidebar(providerSummary) {\r
    return \`\r
        <div class="surface sidebar">\r
            <div class="sidebar-header">\r
                <div class="sidebar-title">Providers</div>\r
            </div>\r
            <div class="provider-list">\r
                \${providerSummary\r
            .map((p) => {\r
                const isActive = p.id === selectedProvider;\r
                return \`\r
                        <button class="provider-item \${isActive ? "active" : ""}" onclick="setSelectedProvider('\${p.id}')" title="\${escapeHtml(p.name)}">\r
                            <span class="provider-item-icon">\${getProviderIcon(p.id)}</span>\r
                            <span class="provider-item-name">\${escapeHtml(p.name)}</span>\r
                            <span class="provider-item-count">\${p.count}</span>\r
                        </button>\r
                    \`;\r
            })\r
            .join("")}\r
            </div>\r
            <div class="sidebar-footer">\r
                <button class="btn btn-ghost btn-block" onclick="showAddAccountModal()">Add account</button>\r
            </div>\r
        </div>\r
    \`;\r
}\r
\r
function renderContent(selectedProviderInfo, providerAccounts) {\r
    if (!selectedProviderInfo) {\r
        return \`<div class="surface content">\${renderEmptyState()}</div>\`;\r
    }\r
\r
    const title = escapeHtml(selectedProviderInfo.name);\r
    const countLabel = \`\${providerAccounts.length} account\${providerAccounts.length !== 1 ? "s" : ""}\`;\r
\r
    return \`\r
        <div class="surface content">\r
            <div class="content-header">\r
                <div>\r
                    <div class="content-title">\${title}</div>\r
                    <div class="content-subtitle">\${escapeHtml(countLabel)}</div>\r
                </div>\r
                <div class="content-actions">\r
                    <button class="btn btn-ghost" onclick="addAccountForProvider('\${selectedProviderInfo.id}')">Add</button>\r
                </div>\r
            </div>\r
\r
            \${providerAccounts.length > 0\r
            ? \`<div class="account-cards">\${providerAccounts.map((account) => renderAccountCard(account)).join("")}</div>\`\r
            : renderProviderEmptyState(selectedProviderInfo.id)\r
        }\r
        </div>\r
    \`;\r
}\r
\r
/**\r
 * Get quota state for a specific account\r
 */\r
function getAccountQuotaState(accountId) {\r
    console.log("[DEBUG] getAccountQuotaState called with accountId:", accountId);\r
    console.log(\r
        "[DEBUG] Available accountQuotaStates:",\r
        accountQuotaStates.map((qs) => ({\r
            accountId: qs.accountId,\r
            provider: qs.provider,\r
            successCount: qs.successCount,\r
        })),\r
    );\r
    const state = accountQuotaStates.find((qs) => qs.accountId === accountId);\r
    console.log(\r
        "[DEBUG] Found state for accountId",\r
        accountId,\r
        ":",\r
        state\r
            ? { successCount: state.successCount, failureCount: state.failureCount }\r
            : null,\r
    );\r
    return state || null;\r
}\r
\r
/**\r
 * Check if account is in quota cooldown\r
 */\r
function isAccountInQuotaCooldown(accountId) {\r
    const state = getAccountQuotaState(accountId);\r
    if (!state || !state.quotaExceeded || !state.quotaResetAt) {\r
        return false;\r
    }\r
    return Date.now() < state.quotaResetAt;\r
}\r
\r
/**\r
 * Render quota state info for an account\r
 */\r
function _renderAccountQuotaState(accountId) {\r
    const state = getAccountQuotaState(accountId);\r
    if (!state) {\r
        return "";\r
    }\r
\r
    const isInCooldown = isAccountInQuotaCooldown(accountId);\r
    const remaining = isInCooldown ? state.quotaResetAt - Date.now() : 0;\r
\r
    // Calculate success rate\r
    const totalRequests = state.successCount + state.failureCount;\r
    const successRate =\r
        totalRequests > 0\r
            ? Math.round((state.successCount / totalRequests) * 100)\r
            : 100;\r
\r
    let statusClass = "success";\r
    if (isInCooldown) {\r
        statusClass = "warning";\r
    } else if (successRate < 50) {\r
        statusClass = "error";\r
    } else if (successRate < 80) {\r
        statusClass = "warning";\r
    }\r
\r
    return \`\r
        <div class="account-quota-state \${statusClass}">\r
            <div class="quota-state-header">\r
                <span class="quota-state-icon">\${isInCooldown ? "WAIT" : "STATS"}</span>\r
                <span class="quota-state-title">Quota Status</span>\r
            </div>\r
            <div class="quota-state-content">\r
                \${isInCooldown\r
            ? \`\r
                    <div class="quota-state-row warning">\r
                        <span class="quota-state-label">Cooldown:</span>\r
                        <span class="quota-state-value account-quota-countdown" data-reset-at="\${state.quotaResetAt}">\${formatCountdown(remaining)}</span>\r
                    </div>\r
                    \${state.affectedModel\r
                ? \`\r
                        <div class="quota-state-row">\r
                            <span class="quota-state-label">Model:</span>\r
                            <span class="quota-state-value">\${escapeHtml(state.affectedModel)}</span>\r
                        </div>\r
                    \`\r
                : ""\r
            }\r
                \`\r
            : ""\r
        }\r
                <div class="quota-state-row">\r
                    <span class="quota-state-label">Success:</span>\r
                    <span class="quota-state-value">\${state.successCount} requests</span>\r
                </div>\r
                <div class="quota-state-row">\r
                    <span class="quota-state-label">Failures:</span>\r
                    <span class="quota-state-value">\${state.failureCount} requests</span>\r
                </div>\r
                <div class="quota-state-row">\r
                    <span class="quota-state-label">Rate:</span>\r
                    <span class="quota-state-value \${statusClass}">\${successRate}%</span>\r
                </div>\r
                \${state.lastSuccessAt\r
            ? \`\r
                    <div class="quota-state-row">\r
                        <span class="quota-state-label">Last success:</span>\r
                        <span class="quota-state-value">\${formatTimeAgo(state.lastSuccessAt)}</span>\r
                    </div>\r
                \`\r
            : ""\r
        }\r
                \${state.lastError\r
            ? \`\r
                    <div class="quota-state-row error">\r
                        <span class="quota-state-label">Last error:</span>\r
                        <span class="quota-state-value">\${escapeHtml(state.lastError)}</span>\r
                    </div>\r
                \`\r
            : ""\r
        }\r
            </div>\r
        </div>\r
    \`;\r
}\r
\r
/**\r
 * Format time ago\r
 */\r
function formatTimeAgo(timestamp) {\r
    const seconds = Math.floor((Date.now() - timestamp) / 1000);\r
    if (seconds < 60) return "just now";\r
    const minutes = Math.floor(seconds / 60);\r
    if (minutes < 60) return \`\${minutes}m ago\`;\r
    const hours = Math.floor(minutes / 60);\r
    if (hours < 24) return \`\${hours}h ago\`;\r
    const days = Math.floor(hours / 24);\r
    return \`\${days}d ago\`;\r
}\r
\r
/**\r
 * Get rate limit for a specific account\r
 */\r
function getCodexRateLimitForAccount(accountId) {\r
    return codexRateLimits.find((rl) => rl.accountId === accountId) || null;\r
}\r
\r
/**\r
 * Render rate limit info for a Codex account\r
 */\r
function _renderAccountRateLimit(accountId) {\r
    const rateLimit = getCodexRateLimitForAccount(accountId);\r
    if (!rateLimit) {\r
        return "";\r
    }\r
\r
    const primaryRemaining = rateLimit.primary\r
        ? 100 - rateLimit.primary.usedPercent\r
        : null;\r
    const secondaryRemaining = rateLimit.secondary\r
        ? 100 - rateLimit.secondary.usedPercent\r
        : null;\r
    const minRemaining = Math.min(\r
        primaryRemaining ?? 100,\r
        secondaryRemaining ?? 100,\r
    );\r
    const isWarning = minRemaining < 30;\r
\r
    const formatWindowLabel = (minutes) => {\r
        if (!minutes) {\r
            return "5h";\r
        }\r
        if (minutes < 60) {\r
            return \`\${minutes}m\`;\r
        }\r
        const hours = Math.floor(minutes / 60);\r
        if (hours < 24) {\r
            return \`\${hours}h\`;\r
        }\r
        const days = Math.floor(hours / 24);\r
        if (days === 7) {\r
            return "Weekly";\r
        }\r
        return \`\${days}d\`;\r
    };\r
\r
    const renderProgressBar = (percent) => {\r
        const filled = Math.round((percent / 100) * 10);\r
        const empty = 10 - filled;\r
        return "\u2588".repeat(filled) + "\u2591".repeat(empty);\r
    };\r
\r
    let content = "";\r
    if (rateLimit.primary) {\r
        const label = formatWindowLabel(rateLimit.primary.windowMinutes);\r
        const remaining = (100 - rateLimit.primary.usedPercent).toFixed(0);\r
        const bar = renderProgressBar(100 - rateLimit.primary.usedPercent);\r
        content += \`<div class="rate-limit-row"><span class="rate-limit-label">\${label}:</span><span class="rate-limit-bar">[\${bar}]</span><span class="rate-limit-value \${isWarning && remaining < 30 ? "warning" : ""}">\${remaining}%</span></div>\`;\r
    }\r
    if (rateLimit.secondary) {\r
        const label = formatWindowLabel(rateLimit.secondary.windowMinutes);\r
        const remaining = (100 - rateLimit.secondary.usedPercent).toFixed(0);\r
        const bar = renderProgressBar(100 - rateLimit.secondary.usedPercent);\r
        const rowWarning = remaining < 30;\r
        content += \`<div class="rate-limit-row"><span class="rate-limit-label">\${label}:</span><span class="rate-limit-bar">[\${bar}]</span><span class="rate-limit-value \${rowWarning ? "warning" : ""}">\${remaining}%</span></div>\`;\r
    }\r
\r
    const updatedAt = rateLimit.capturedAt\r
        ? new Date(rateLimit.capturedAt).toLocaleTimeString()\r
        : "";\r
\r
    return \`\r
        <div class="account-rate-limit \${isWarning ? "warning" : ""}">\r
            <div class="rate-limit-header-inline">\r
                <span class="rate-limit-icon"></span>\r
                <span class="rate-limit-title-small">Rate Limit</span>\r
                \${updatedAt ? \`<span class="rate-limit-updated">\${updatedAt}</span>\` : ""}\r
            </div>\r
            <div class="rate-limit-content">\r
                \${content}\r
            </div>\r
        </div>\r
    \`;\r
}\r
\r
/**\r
 * Render provider sections\r
 */\r
function _renderProviderSections() {\r
    // Group accounts by provider\r
    const accountsByProvider = {};\r
    for (const account of accounts) {\r
        if (!accountsByProvider[account.provider]) {\r
            accountsByProvider[account.provider] = [];\r
        }\r
        accountsByProvider[account.provider].push(account);\r
    }\r
\r
    // Get all providers (including those without accounts)\r
    const allProviders = [\r
        ...new Set([\r
            ...providers.map((p) => p.id),\r
            ...Object.keys(accountsByProvider),\r
        ]),\r
    ];\r
\r
    if (allProviders.length === 0) {\r
        return renderEmptyState();\r
    }\r
\r
    return allProviders\r
        .map((providerId) => {\r
            const providerInfo = providers.find((p) => p.id === providerId) || {\r
                id: providerId,\r
                name: providerId,\r
            };\r
            const providerAccounts = accountsByProvider[providerId] || [];\r
            const isCollapsed = collapsedProviders[providerId];\r
\r
            return \`\r
            <div class="provider-section" data-provider="\${providerId}">\r
                <div class="provider-header" onclick="toggleProvider('\${providerId}')">\r
                    <div class="provider-title">\r
                        <span class="provider-icon">\${getProviderIcon(providerId)}</span>\r
                        <span class="provider-name">\${escapeHtml(providerInfo.name || providerId)}</span>\r
                        <span class="provider-badge">\${providerAccounts.length} account\${providerAccounts.length !== 1 ? "s" : ""}</span>\r
                    </div>\r
                    <div class="provider-actions">\r
                        <button class="btn btn-icon" onclick="event.stopPropagation(); addAccountForProvider('\${providerId}')" title="Add account">\r
                            +\r
                        </button>\r
                        <span style="font-size: 12px; opacity: 0.6;">\${isCollapsed ? "\u25B8" : "\u25BE"}</span>\r
                    </div>\r
                </div>\r
                <div class="provider-content \${isCollapsed ? "collapsed" : ""}">\r
                    \${providerAccounts.length > 0\r
                    ? renderAccountList(providerAccounts)\r
                    : renderProviderEmptyState(providerId)\r
                }\r
                </div>\r
            </div>\r
        \`;\r
        })\r
        .join("");\r
}\r
\r
/**\r
 * Render account list for a provider\r
 */\r
function renderAccountList(providerAccounts) {\r
    return \`\r
        <div class="account-list">\r
            \${renderAccountListHeader()}\r
            \${providerAccounts.map((account) => renderAccountCard(account)).join("")}\r
        </div>\r
    \`;\r
}\r
\r
/**\r
 * Render account list header\r
 */\r
function renderAccountListHeader() {\r
    return \`\r
        <div class="account-list-header">\r
            <div class="account-col account-col-name">\u{1F464} Account</div>\r
            <div class="account-col account-col-status">Status</div>\r
            <div class="account-col account-col-auth">Auth Type</div>\r
            <div class="account-col account-col-created">Created</div>\r
            <div class="account-col account-col-actions">Actions</div>\r
        </div>\r
    \`;\r
}\r
\r
/**\r
 * Render a single account card - Simplified UI\r
 */\r
function renderAccountCard(account) {\r
    const initials = getInitials(account.displayName);\r
    const isDefault = account.isDefault;\r
    const isQuotaLimited =\r
        antigravityQuota &&\r
        account.provider === "antigravity" &&\r
        antigravityQuota.accountId === account.id;\r
    const isCodexAccount = account.provider === "codex";\r
    const _codexRateLimit = isCodexAccount\r
        ? getCodexRateLimitForAccount(account.id)\r
        : null;\r
\r
    // Check account quota state from cache\r
    const quotaState = getAccountQuotaState(account.id);\r
    const isInQuotaCooldown = isAccountInQuotaCooldown(account.id);\r
\r
    const statusClass = escapeHtml(account.status);\r
    const authLabel = account.authType === "oauth" ? "OAuth" : "API Key";\r
\r
    // Calculate success rate for compact display\r
    let statsText = "";\r
    if (quotaState) {\r
        const total = quotaState.successCount + quotaState.failureCount;\r
        const _rate =\r
            total > 0 ? Math.round((quotaState.successCount / total) * 100) : 100;\r
        statsText = \`\${quotaState.successCount}/\${quotaState.failureCount}\`;\r
    }\r
\r
    return \`\r
        <div class="account-card-simple \${isDefault ? "active" : ""} \${isQuotaLimited || isInQuotaCooldown ? "quota-limited" : ""}" data-account-id="\${account.id}">\r
            <div class="account-card-left" onclick="handleAccountCardClick(event, '\${account.id}', \${isDefault})">\r
                <div class="account-avatar">\${initials}</div>\r
                <div class="account-info-compact">\r
                    <div class="account-name-row">\r
                        <span class="account-name">\${escapeHtml(account.displayName)}</span>\r
                        \${isDefault ? '<span class="badge badge-primary">Current</span>' : ""}\r
                        <span class="badge badge-muted">\${escapeHtml(authLabel)}</span>\r
                        <span class="status-dot-inline \${statusClass}"></span>\r
                    </div>\r
                    \${account.email && account.email !== account.displayName ? \`<div class="account-email-compact">\${escapeHtml(account.email)}</div>\` : ""}\r
                    <div class="account-meta-compact">\r
                        <span>Created \${formatDate(account.createdAt)}</span>\r
                        \${statsText ? \`<span class="account-stats">\${statsText}</span>\` : ""}\r
                    </div>\r
                </div>\r
            </div>\r
            \${isQuotaLimited || isInQuotaCooldown\r
            ? \`\r
                <div class="quota-badge-compact">\r
                    <span class="quota-countdown-compact account-quota-countdown" data-reset-at="\${isQuotaLimited ? antigravityQuota.resetAt : quotaState.quotaResetAt}">\${formatCountdown((isQuotaLimited ? antigravityQuota.resetAt : quotaState.quotaResetAt) - Date.now())}</span>\r
                </div>\r
            \`\r
            : ""\r
        }\r
            <div class="account-actions-compact">\r
                \${!isDefault ? \`<button class="btn-action btn-use" onclick="event.stopPropagation(); setDefaultAccount('\${account.id}')" title="Use this account">Use</button>\` : ""}\r
                <button class="btn-action btn-info" onclick="event.stopPropagation(); showAccountDetails('\${account.id}')" title="View details">\u2139</button>\r
                <button class="btn-action btn-delete" onclick="event.stopPropagation(); confirmDeleteAccount('\${account.id}', '\${escapeHtml(account.displayName)}')" title="Delete account">\u2715</button>\r
            </div>\r
        </div>\r
    \`;\r
}\r
\r
/**\r
 * Render empty state when no accounts\r
 */\r
function renderEmptyState() {\r
    return \`\r
        <div class="empty-state">\r
            <div class="empty-state-title">No Accounts Configured</div>\r
            <div class="empty-state-description">\r
                Add your first account to start using AI models from different providers.\r
            </div>\r
            <button class="btn btn-primary" onclick="showAddAccountModal()">\r
                + Add Your First Account\r
            </button>\r
        </div>\r
    \`;\r
}\r
\r
/**\r
 * Render empty state for a specific provider\r
 */\r
function renderProviderEmptyState(providerId) {\r
    return \`\r
        <div class="empty-state" style="padding: 24px;">\r
            <div class="empty-state-description">No accounts for this provider yet.</div>\r
            <button class="btn btn-ghost" onclick="addAccountForProvider('\${providerId}')">Add</button>\r
        </div>\r
    \`;\r
}\r
\r
/**\r
 * Show add account modal\r
 */\r
function _showAddAccountModal() {\r
    const modalContainer = document.getElementById("modal-container");\r
    modalContainer.innerHTML = \`\r
        <div class="modal-overlay" onclick="closeModal(event)">\r
            <div class="modal" onclick="event.stopPropagation()">\r
                <div class="modal-header">\r
                    <h2 class="modal-title">Add New Account</h2>\r
                    <button class="modal-close" onclick="closeModal()">&times;</button>\r
                </div>\r
                <div class="modal-body">\r
                    <p style="margin-bottom: 16px; color: var(--vscode-descriptionForeground);">\r
                        Select a provider to add an account:\r
                    </p>\r
                   \r
                    <div class="provider-select-grid">\r
                        \${providers\r
            .map(\r
                (p) => \`\r
                            <div class="provider-select-item" onclick="selectProviderForAdd('\${p.id}')" data-provider="\${p.id}">\r
                                <div class="provider-select-icon">\${getProviderIcon(p.id)}</div>\r
                                <div class="provider-select-info">\r
                                    <div class="provider-select-name">\${escapeHtml(p.name)}</div>\r
                                    <div class="provider-select-type">\${p.authType === "oauth" ? "OAuth Login" : "API Key"}</div>\r
                                </div>\r
                            </div>\r
                        \`,\r
            )\r
            .join("")}\r
                    </div>\r
                </div>\r
            </div>\r
        </div>\r
    \`;\r
}\r
\r
/**\r
 * Select provider and show appropriate form\r
 */\r
function _selectProviderForAdd(providerId) {\r
    const provider = providers.find((p) => p.id === providerId);\r
    if (!provider) return;\r
\r
    if (provider.authType === "oauth") {\r
        // Trigger OAuth login\r
        vscode.postMessage({\r
            command: "addOAuthAccount",\r
            provider: providerId,\r
        });\r
        closeModal();\r
    } else {\r
        showApiKeyForm(providerId, provider.name);\r
    }\r
}\r
\r
/**\r
 * Show API Key form\r
 */\r
function showApiKeyForm(providerId, providerName) {\r
    const modalContainer = document.getElementById("modal-container");\r
    modalContainer.innerHTML = \`\r
        <div class="modal-overlay" onclick="closeModal(event)">\r
            <div class="modal" onclick="event.stopPropagation()">\r
                <div class="modal-header">\r
                    <h2 class="modal-title">Add \${escapeHtml(providerName)} Account</h2>\r
                    <button class="modal-close" onclick="closeModal()">&times;</button>\r
                </div>\r
                <div class="modal-body">\r
                    <form id="add-account-form" onsubmit="submitAddAccount(event, '\${providerId}')">\r
                        <div class="form-group">\r
                            <label class="form-label">Display Name *</label>\r
                            <input type="text" class="form-input" id="displayName" \r
                                   placeholder="e.g., Work Account, Personal" required>\r
                            <div class="form-hint">A friendly name to identify this account</div>\r
                        </div>\r
                        <div class="form-group">\r
                            <label class="form-label">API Key *</label>\r
                            <input type="password" class="form-input" id="apiKey" \r
                                   placeholder="sk-xxxxxxxxxxxxxxxxxxxxxxxx" required>\r
                            <div class="form-hint">Your \${escapeHtml(providerName)} API key</div>\r
                        </div>\r
                        <div class="form-group">\r
                            <label class="form-label">Base URL (Optional)</label>\r
                            <input type="url" class="form-input" id="endpoint" \r
                                   placeholder="http://154.53.47.9:8000/v1">\r
                            <div class="form-hint">Override the provider API base URL (e.g., proxy URL).</div>\r
                        </div>\r
                    </form>\r
                </div>\r
                <div class="modal-footer">\r
                    <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>\r
                    <button class="btn btn-primary" onclick="document.getElementById('add-account-form').requestSubmit()">\r
                        Add Account\r
                    </button>\r
                </div>\r
            </div>\r
        </div>\r
    \`;\r
}\r
\r
/**\r
 * Submit add account form\r
 */\r
function _submitAddAccount(event, providerId) {\r
    event.preventDefault();\r
\r
    const displayName = document.getElementById("displayName").value.trim();\r
    const apiKey = document.getElementById("apiKey").value.trim();\r
    const endpointEl = document.getElementById("endpoint");\r
    const endpoint = endpointEl ? endpointEl.value.trim() : undefined;\r
\r
    if (!displayName || !apiKey) {\r
        showToast("Please fill in all required fields", "error");\r
        return;\r
    }\r
\r
    vscode.postMessage({\r
        command: "addApiKeyAccount",\r
        provider: providerId,\r
        displayName: displayName,\r
        apiKey: apiKey,\r
        endpoint: endpoint,\r
    });\r
\r
    closeModal();\r
}\r
\r
/**\r
 * Add account for specific provider\r
 */\r
function _addAccountForProvider(providerId) {\r
    const provider = providers.find((p) => p.id === providerId);\r
    if (!provider) {\r
        // If provider not in list, assume API key\r
        showApiKeyForm(providerId, capitalizeFirst(providerId));\r
        return;\r
    }\r
\r
    if (provider.authType === "oauth") {\r
        vscode.postMessage({\r
            command: "addOAuthAccount",\r
            provider: providerId,\r
        });\r
    } else {\r
        showApiKeyForm(providerId, provider.name);\r
    }\r
}\r
\r
/**\r
 * Set account as default\r
 */\r
function setDefaultAccount(accountId) {\r
    const account = accounts.find((a) => a.id === accountId);\r
\r
    // Check quota for Antigravity accounts before switching\r
    if (account && account.provider === "antigravity") {\r
        checkQuotaBeforeSwitch(accountId);\r
    } else {\r
        // For non-Antigravity accounts, switch immediately\r
        vscode.postMessage({\r
            command: "setDefaultAccount",\r
            accountId: accountId,\r
        });\r
    }\r
}\r
\r
/**\r
 * Check quota before switching to Antigravity account\r
 */\r
function checkQuotaBeforeSwitch(accountId) {\r
    const account = accounts.find((a) => a.id === accountId);\r
    if (!account) return;\r
\r
    // Show loading state on the Use button\r
    const useButton = document.querySelector(\r
        \`[data-account-id="\${accountId}"] .btn-use\`,\r
    );\r
    if (useButton) {\r
        useButton.disabled = true;\r
        useButton.textContent = "Checking...";\r
    }\r
\r
    // Request quota check from backend\r
    vscode.postMessage({\r
        command: "checkQuota",\r
        accountId: accountId,\r
    });\r
}\r
\r
/**\r
 * Handle quota check result from backend\r
 */\r
function handleQuotaCheckResult(message) {\r
    const {\r
        accountId,\r
        success,\r
        quotaData,\r
        error,\r
        message: resultMessage,\r
    } = message;\r
    const _account = accounts.find((a) => a.id === accountId);\r
\r
    // Restore button state\r
    const useButton = document.querySelector(\r
        \`[data-account-id="\${accountId}"] .btn-use\`,\r
    );\r
    if (useButton) {\r
        useButton.disabled = false;\r
        useButton.textContent = "Use";\r
    }\r
\r
    if (success) {\r
        if (quotaData) {\r
            // Show quota info in toast with color coding\r
            const minQuota = quotaData.minQuota;\r
            let toastType = "success";\r
            let icon = "OK";\r
\r
            if (minQuota < 10) {\r
                toastType = "error";\r
                icon = "WARN";\r
            } else if (minQuota < 30) {\r
                toastType = "warning";\r
                icon = "WARN";\r
            }\r
            const quotaMsg = \`\${icon} Quota refreshed - Gemini: \${quotaData.geminiQuota}%, Claude: \${quotaData.claudeQuota}%\`;\r
            showToast(quotaMsg, toastType);\r
        } else if (resultMessage) {\r
            showToast(resultMessage, "info");\r
        }\r
\r
        // Proceed with account switch\r
        vscode.postMessage({\r
            command: "setDefaultAccount",\r
            accountId: accountId,\r
        });\r
    } else {\r
        // Show error\r
        showToast(error || "Failed to check quota", "error");\r
    }\r
}\r
\r
function _handleAccountCardClick(_event, accountId, isDefault) {\r
    if (isDefault) {\r
        return;\r
    }\r
    setDefaultAccount(accountId);\r
}\r
\r
/**\r
 * Show account details\r
 */\r
function _showAccountDetails(accountId) {\r
    const account = accounts.find((a) => a.id === accountId);\r
    if (!account) return;\r
\r
    // Find the endpoint for this account\r
    const accountEndpoint = window._accountEndpoints && window._accountEndpoints.find((ae) => ae.id === accountId);\r
    const endpoint = accountEndpoint?.endpoint;\r
\r
    const isQuotaLimited =\r
        antigravityQuota &&\r
        account.provider === "antigravity" &&\r
        antigravityQuota.accountId === account.id;\r
\r
    const quotaSection = isQuotaLimited\r
        ? \`\r
        <div style="margin-top: 16px; padding: 12px; background: rgba(255, 196, 0, 0.1); border-radius: 8px; border: 1px solid rgba(255, 196, 0, 0.3);">\r
            <div style="font-weight: 600; color: var(--vscode-notificationsWarningForeground, #ffc400); margin-bottom: 8px;">\r
                Quota Exceeded\r
            </div>\r
            <div style="display: grid; gap: 8px; font-size: 13px;">\r
                <div>\r
                    <strong>Model:</strong> \${escapeHtml(antigravityQuota.modelName || "Unknown")}\r
                </div>\r
                <div>\r
                    <strong>Retry in:</strong> <span style="font-weight: 600; color: var(--vscode-notificationsWarningForeground, #ffc400);">\${formatCountdown(antigravityQuota.resetAt - Date.now())}</span>\r
                </div>\r
                <div>\r
                    <strong>Reset at:</strong> \${formatDateTime(new Date(antigravityQuota.resetAt).toISOString())}\r
                </div>\r
            </div>\r
        </div>\r
    \`\r
        : "";\r
\r
    const modalContainer = document.getElementById("modal-container");\r
    modalContainer.innerHTML = \`\r
        <div class="modal-overlay" onclick="closeModal(event)">\r
            <div class="modal" onclick="event.stopPropagation()">\r
                <div class="modal-header">\r
                    <h2 class="modal-title">Account Details</h2>\r
                    <button class="modal-close" onclick="closeModal()">&times;</button>\r
                </div>\r
                <div class="modal-body">\r
                    <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 20px;">\r
                        <div class="account-avatar" style="width: 64px; height: 64px; font-size: 24px;">\r
                            \${getInitials(account.displayName)}\r
                        </div>\r
                        <div>\r
                            <div style="font-size: 18px; font-weight: 600;">\${escapeHtml(account.displayName)}</div>\r
                            \${account.email ? \`<div style="color: var(--vscode-descriptionForeground);">\${escapeHtml(account.email)}</div>\` : ""}\r
                        </div>\r
                    </div>\r
                    \${quotaSection}\r
                    <div style="display: grid; gap: 12px; \${isQuotaLimited ? "margin-top: 16px;" : ""}">\r
                        <div>\r
                            <strong>Provider:</strong> \${capitalizeFirst(account.provider)}\r
                        </div>\r
                        <div>\r
                            <strong>Auth Type:</strong> \${account.authType === "oauth" ? "OAuth" : "API Key"}\r
                        </div>\r
                        <div>\r
                            <strong>Status:</strong> \r
                            <span class="account-status \${account.status}" style="display: inline-flex;">\r
                                <span class="status-dot \${account.status}"></span>\r
                                \${capitalizeFirst(account.status)}\r
                            </span>\r
                        </div>\r
                        <div>\r
                            <strong>Created:</strong> \${formatDateTime(account.createdAt)}\r
                        </div>\r
                        <div>\r
                            <strong>Last Updated:</strong> \${formatDateTime(account.updatedAt)}\r
                        </div>\r
                        \${account.expiresAt\r
            ? \`\r
                            <div>\r
                                <strong>Expires:</strong> \${formatDateTime(account.expiresAt)}\r
                            </div>\r
                        \`\r
            : ""\r
        }\r
                        \${endpoint\r
            ? \`\r
                            <div>\r
                                <strong>Proxy/Base URL:</strong> \r
                                <div style="font-family: monospace; font-size: 12px; margin-top: 4px; word-break: break-all; color: var(--vscode-descriptionForeground);">\r
                                    \${escapeHtml(endpoint)}\r
                                </div>\r
                            </div>\r
                        \`\r
            : ""\r
        }\r
                        <div>\r
                            <strong>Default:</strong> \${account.isDefault ? "Yes \u2B50" : "No"}\r
                        </div>\r
                    </div>\r
                </div>\r
                <div class="modal-footer">\r
                    <button class="btn btn-secondary" onclick="closeModal()">Close</button>\r
                </div>\r
            </div>\r
        </div>\r
    \`;\r
}\r
\r
/**\r
 * Confirm delete account\r
 */\r
function _confirmDeleteAccount(accountId, displayName) {\r
    const modalContainer = document.getElementById("modal-container");\r
    modalContainer.innerHTML = \`\r
        <div class="modal-overlay" onclick="closeModal(event)">\r
            <div class="modal" onclick="event.stopPropagation()">\r
                <div class="modal-header">\r
                    <h2 class="modal-title">Delete Account</h2>\r
                    <button class="modal-close" onclick="closeModal()">&times;</button>\r
                </div>\r
                <div class="modal-body">\r
                    <p>Are you sure you want to delete the account "<strong>\${escapeHtml(displayName)}</strong>"?</p>\r
                    <p style="color: var(--vscode-errorForeground); margin-top: 12px;">\r
                        This action cannot be undone. All credentials will be permanently removed.\r
                    </p>\r
                </div>\r
                <div class="modal-footer">\r
                    <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>\r
                    <button class="btn btn-danger" onclick="deleteAccount('\${accountId}')">\r
                        Delete Account\r
                    </button>\r
                </div>\r
            </div>\r
        </div>\r
    \`;\r
}\r
\r
/**\r
 * Delete account\r
 */\r
function _deleteAccount(accountId) {\r
    vscode.postMessage({\r
        command: "deleteAccount",\r
        accountId: accountId,\r
    });\r
    closeModal();\r
}\r
\r
function ensureSelectedProvider() {\r
    const providerSummary = getProviderSummary();\r
    if (providerSummary.length === 0) {\r
        selectedProvider = null;\r
        return;\r
    }\r
    // If selected provider not present anymore, fall back\r
    const exists =\r
        selectedProvider && providerSummary.some((p) => p.id === selectedProvider);\r
    if (!exists) {\r
        selectedProvider = providerSummary[0].id;\r
        try {\r
            vscode.setState({ ...(vscode.getState() || {}), selectedProvider });\r
        } catch {\r
            // Ignore\r
        }\r
    }\r
}\r
\r
function setSelectedProvider(providerId) {\r
    selectedProvider = providerId;\r
    try {\r
        vscode.setState({ ...(vscode.getState() || {}), selectedProvider });\r
    } catch {\r
        // Ignore\r
    }\r
    renderPage();\r
}\r
\r
/**\r
 * Refresh accounts\r
 */\r
function _refreshAccounts() {\r
    vscode.postMessage({\r
        command: "refresh",\r
    });\r
}\r
\r
/**\r
 * Close modal\r
 */\r
function closeModal(event) {\r
    if (event && event.target !== event.currentTarget) return;\r
    document.getElementById("modal-container").innerHTML = "";\r
}\r
\r
/**\r
 * Show toast notification\r
 */\r
function showToast(message, type = "info") {\r
    const container = document.getElementById("toast-container");\r
    const toast = document.createElement("div");\r
    toast.className = \`toast \${type}\`;\r
    toast.innerHTML = \`\r
        <span>\${type === "success" ? "OK" : type === "error" ? "ERR" : "INFO"}</span>\r
        <span>\${escapeHtml(message)}</span>\r
    \`;\r
    container.appendChild(toast);\r
\r
    setTimeout(() => {\r
        toast.remove();\r
    }, 3000);\r
}\r
\r
/**\r
 * Update accounts data\r
 */\r
function updateAccounts(newAccounts) {\r
    accounts = newAccounts || [];\r
    ensureSelectedProvider();\r
    renderPage();\r
}\r
\r
/**\r
 * Update Antigravity quota notice\r
 */\r
function updateAntigravityQuota(notice) {\r
    antigravityQuota = normalizeAntigravityQuota(notice);\r
    renderPage();\r
}\r
\r
/**\r
 * Setup event listeners\r
 */\r
function setupEventListeners() {\r
    // Listen for messages from extension\r
    window.addEventListener("message", (event) => {\r
        const message = event.data;\r
        switch (message.command) {\r
            case "updateAccounts":\r
                updateAccounts(message.accounts);\r
                // Store account endpoints for displaying in details modal\r
                if (message.accountEndpoints) {\r
                    window._accountEndpoints = message.accountEndpoints;\r
                }\r
                break;\r
            case "showToast":\r
                showToast(message.message, message.type);\r
                break;\r
            case "updateAntigravityQuota":\r
                updateAntigravityQuota(message.notice);\r
                break;\r
            case "updateAccountQuotaState":\r
                updateAccountQuotaState(message.accountId, message.state);\r
                break;\r
            case "quotaCheckResult":\r
                handleQuotaCheckResult(message);\r
                break;\r
        }\r
    });\r
}\r
\r
/**\r
 * Update account quota state from extension\r
 */\r
function updateAccountQuotaState(accountId, state) {\r
    if (!state) {\r
        // Remove state\r
        accountQuotaStates = accountQuotaStates.filter(\r
            (s) => s.accountId !== accountId,\r
        );\r
    } else {\r
        // Update or add state\r
        const existingIndex = accountQuotaStates.findIndex(\r
            (s) => s.accountId === accountId,\r
        );\r
        if (existingIndex >= 0) {\r
            accountQuotaStates[existingIndex] = state;\r
        } else {\r
            accountQuotaStates.push(state);\r
        }\r
    }\r
\r
    // Re-render the affected account card\r
    const accountCard = document.querySelector(\r
        \`[data-account-id="\${accountId}"]\`,\r
    );\r
    if (accountCard) {\r
        const account = accounts.find((a) => a.id === accountId);\r
        if (account) {\r
            accountCard.outerHTML = renderAccountCard(account);\r
        }\r
    }\r
}\r
\r
// Utility functions\r
function getProviderIcon(providerId) {\r
    // Use image if available, otherwise fallback to emoji\r
    // if (providerImageUris[providerId]) {\r
    //     return \`<img src="\${providerImageUris[providerId]}" alt="\${providerId}" class="provider-icon-img" />\`;\r
    // }\r
\r
    // Fallback emoji icons\r
    const icons = {\r
        antigravity: "\u{1F310}",\r
        codex: "\u2728",\r
        zhipu: "\u{1F9E0}",\r
        moonshot: "\u{1F319}",\r
        minimax: "\u{1F537}",\r
        deepseek: "\u{1F50D}",\r
        deepinfra: "\u{1F680}",\r
        compatible: "\u2699\uFE0F",\r
    };\r
    return icons[providerId] || "\u{1F916}";\r
}\r
\r
function getProviderSummary() {\r
    const accountsByProvider = {};\r
    for (const account of accounts) {\r
        accountsByProvider[account.provider] =\r
            (accountsByProvider[account.provider] || 0) + 1;\r
    }\r
\r
    const allProviderIds = [\r
        ...new Set([\r
            ...providers.map((p) => p.id),\r
            ...Object.keys(accountsByProvider),\r
        ]),\r
    ];\r
    const summary = allProviderIds.map((id) => {\r
        const info = providers.find((p) => p.id === id);\r
        return {\r
            id,\r
            name: info?.name ? info.name : capitalizeFirst(id),\r
            authType: info?.authType ? info.authType : "apiKey",\r
            count: accountsByProvider[id] || 0,\r
        };\r
    });\r
\r
    // Sort: providers with accounts first, then by name\r
    summary.sort((a, b) => {\r
        if (a.count !== b.count) {\r
            return b.count - a.count;\r
        }\r
        return a.name.localeCompare(b.name);\r
    });\r
\r
    return summary;\r
}\r
\r
function getInitials(name) {\r
    if (!name) return "?";\r
    const words = name.trim().split(/\\s+/);\r
    if (words.length >= 2) {\r
        return (words[0][0] + words[1][0]).toUpperCase();\r
    }\r
    return name.substring(0, 2).toUpperCase();\r
}\r
\r
function escapeHtml(text) {\r
    if (!text) return "";\r
    const div = document.createElement("div");\r
    div.textContent = text;\r
    return div.innerHTML;\r
}\r
\r
function capitalizeFirst(str) {\r
    if (!str) return "";\r
    return str.charAt(0).toUpperCase() + str.slice(1);\r
}\r
\r
function formatDate(dateStr) {\r
    if (!dateStr) return "N/A";\r
    try {\r
        return new Date(dateStr).toLocaleDateString();\r
    } catch {\r
        return "N/A";\r
    }\r
}\r
\r
function formatDateTime(dateStr) {\r
    if (!dateStr) return "N/A";\r
    try {\r
        return new Date(dateStr).toLocaleString();\r
    } catch {\r
        return "N/A";\r
    }\r
}\r
\r
function normalizeAntigravityQuota(notice) {\r
    if (!notice || typeof notice.resetAt !== "number") {\r
        return null;\r
    }\r
    const modelName =\r
        typeof notice.modelName === "string" ? notice.modelName : "";\r
    const accountId =\r
        typeof notice.accountId === "string" ? notice.accountId : "";\r
    const accountName =\r
        typeof notice.accountName === "string" ? notice.accountName : "";\r
    return { resetAt: notice.resetAt, modelName, accountId, accountName };\r
}\r
\r
function startQuotaCountdown() {\r
    stopQuotaCountdown();\r
    if (!antigravityQuota) {\r
        return;\r
    }\r
    updateQuotaCountdown();\r
}\r
\r
function stopQuotaCountdown() {\r
    if (antigravityQuotaTimer) {\r
        clearTimeout(antigravityQuotaTimer);\r
        antigravityQuotaTimer = null;\r
    }\r
}\r
\r
function updateQuotaCountdown() {\r
    if (!antigravityQuota) {\r
        return;\r
    }\r
    const remaining = antigravityQuota.resetAt - Date.now();\r
    if (remaining <= 0) {\r
        antigravityQuota = null;\r
        renderPage();\r
        return;\r
    }\r
\r
    // Update main banner countdown\r
    const countdownEl = document.getElementById("quota-countdown");\r
    if (countdownEl) {\r
        countdownEl.textContent = formatCountdown(remaining);\r
    }\r
\r
    // Update account card countdown\r
    const accountCountdowns = document.querySelectorAll(\r
        ".account-quota-countdown",\r
    );\r
    accountCountdowns.forEach((el) => {\r
        const resetAt = parseInt(el.dataset.resetAt, 10);\r
        if (resetAt) {\r
            const accountRemaining = resetAt - Date.now();\r
            if (accountRemaining > 0) {\r
                el.textContent = formatCountdown(accountRemaining);\r
            }\r
        }\r
    });\r
\r
    antigravityQuotaTimer = setTimeout(\r
        updateQuotaCountdown,\r
        getCountdownUpdateInterval(remaining),\r
    );\r
}\r
\r
function formatCountdown(ms) {\r
    const totalSeconds = Math.max(0, Math.floor(ms / 1000));\r
    const seconds = totalSeconds % 60;\r
    const minutes = Math.floor(totalSeconds / 60) % 60;\r
    const hours = Math.floor(totalSeconds / 3600) % 24;\r
    const days = Math.floor(totalSeconds / 86400);\r
\r
    if (days > 0) {\r
        return \`\${days}d \${hours}h \${minutes}m\`;\r
    }\r
    if (hours > 0) {\r
        return \`\${hours}h \${minutes}m \${seconds}s\`;\r
    }\r
    if (minutes > 0) {\r
        return \`\${minutes}m \${seconds}s\`;\r
    }\r
    return \`\${seconds}s\`;\r
}\r
\r
function getCountdownUpdateInterval(remainingMs) {\r
    if (remainingMs >= 60 * 60 * 1000) {\r
        return 60 * 1000;\r
    }\r
    return 1000;\r
}\r
\r
// Expose handlers used by inline HTML and host initialization.\r
window.initializeAccountManager = _initializeAccountManager;\r
window.openGCMPSettings = _openGCMPSettings;\r
window.showAddAccountModal = _showAddAccountModal;\r
window.selectProviderForAdd = _selectProviderForAdd;\r
window.submitAddAccount = _submitAddAccount;\r
window.addAccountForProvider = _addAccountForProvider;\r
window.handleAccountCardClick = _handleAccountCardClick;\r
window.showAccountDetails = _showAccountDetails;\r
window.confirmDeleteAccount = _confirmDeleteAccount;\r
window.deleteAccount = _deleteAccount;\r
window.refreshAccounts = _refreshAccounts;\r
`});var yx,vx=ke(()=>{yx={displayName:"Antigravity (Google Cloud Code)",baseUrl:"https://api.antigravity.com/v1",apiKeyTemplate:"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx",models:[{id:"claude-opus-4-5-thinking",name:"Claude Opus 4.5 Thinking",tooltip:"Claude Opus 4.5 v\u1EDBi kh\u1EA3 n\u0103ng suy lu\u1EADn m\u1EDF r\u1ED9ng",sdkMode:"anthropic",maxInputTokens:2e5,maxOutputTokens:64e3,includeThinking:!0,capabilities:{toolCalling:!0,imageInput:!0}},{id:"claude-sonnet-4-5",name:"Claude Sonnet 4.5",tooltip:"Claude Sonnet 4.5 - m\xF4 h\xECnh c\xE2n b\u1EB1ng gi\u1EEFa hi\u1EC7u su\u1EA5t v\xE0 chi ph\xED",sdkMode:"anthropic",maxInputTokens:2e5,maxOutputTokens:8192,capabilities:{toolCalling:!0,imageInput:!0}},{id:"claude-sonnet-4-5-thinking",name:"Claude Sonnet 4.5 Thinking",tooltip:"Claude Sonnet 4.5 v\u1EDBi kh\u1EA3 n\u0103ng suy lu\u1EADn m\u1EDF r\u1ED9ng",sdkMode:"anthropic",maxInputTokens:2e5,maxOutputTokens:64e3,includeThinking:!0,capabilities:{toolCalling:!0,imageInput:!0}},{id:"gemini-3-flash",name:"Gemini 3 Flash",tooltip:"Gemini 3 Flash - m\xF4 h\xECnh nhanh v\xE0 hi\u1EC7u qu\u1EA3",sdkMode:"anthropic",maxInputTokens:1e6,maxOutputTokens:8192,capabilities:{toolCalling:!0,imageInput:!0}},{id:"gemini-3-pro-high",name:"Gemini 3 Pro High",tooltip:"Gemini 3 Pro v\u1EDBi ch\u1EBF \u0111\u1ED9 ch\u1EA5t l\u01B0\u1EE3ng cao",sdkMode:"anthropic",maxInputTokens:2e6,maxOutputTokens:32768,capabilities:{toolCalling:!0,imageInput:!0}},{id:"gemini-3-pro-image",name:"Gemini 3 Pro Image",tooltip:"Gemini 3 Pro t\u1ED1i \u01B0u cho x\u1EED l\xFD h\xECnh \u1EA3nh",sdkMode:"anthropic",maxInputTokens:2e6,maxOutputTokens:8192,capabilities:{toolCalling:!0,imageInput:!0}},{id:"gemini-3-pro-low",name:"Gemini 3 Pro Low",tooltip:"Gemini 3 Pro v\u1EDBi ch\u1EBF \u0111\u1ED9 ti\u1EBFt ki\u1EC7m chi ph\xED",sdkMode:"anthropic",maxInputTokens:2e6,maxOutputTokens:8192,capabilities:{toolCalling:!0,imageInput:!0}},{id:"gpt-oss-120b-medium",name:"GPT OSS 120B Medium",tooltip:"GPT Open Source 120B - m\xF4 h\xECnh m\xE3 ngu\u1ED3n m\u1EDF",sdkMode:"anthropic",maxInputTokens:128e3,maxOutputTokens:8192,capabilities:{toolCalling:!0,imageInput:!1}}]}});var bx,xx=ke(()=>{bx={displayName:"Chutes",baseUrl:"https://llm.chutes.ai/v1",apiKeyTemplate:"sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx",models:[{id:"qwen-qwen3-32b",name:"Qwen/Qwen3-32B",tooltip:"Qwen/Qwen3-32B by Chutes",maxInputTokens:1,maxOutputTokens:40960,model:"Qwen/Qwen3-32B",capabilities:{toolCalling:!0,imageInput:!1}},{id:"deepseek-ai-deepseek-v3-0324-tee",name:"deepseek-ai/DeepSeek-V3-0324-TEE",tooltip:"deepseek-ai/DeepSeek-V3-0324-TEE by Chutes",maxInputTokens:98304,maxOutputTokens:65536,model:"deepseek-ai/DeepSeek-V3-0324-TEE",capabilities:{toolCalling:!0,imageInput:!1}},{id:"deepseek-ai-deepseek-v3-2-tee",name:"deepseek-ai/DeepSeek-V3.2-TEE",tooltip:"deepseek-ai/DeepSeek-V3.2-TEE by Chutes",maxInputTokens:98304,maxOutputTokens:65536,model:"deepseek-ai/DeepSeek-V3.2-TEE",capabilities:{toolCalling:!0,imageInput:!1}},{id:"chutesai-mistral-small-3-1-24b-instruct-2503",name:"chutesai/Mistral-Small-3.1-24B-Instruct-2503",tooltip:"chutesai/Mistral-Small-3.1-24B-Instruct-2503 by Chutes",maxInputTokens:1,maxOutputTokens:131072,model:"chutesai/Mistral-Small-3.1-24B-Instruct-2503",capabilities:{toolCalling:!0,imageInput:!0}},{id:"unsloth-mistral-nemo-instruct-2407",name:"unsloth/Mistral-Nemo-Instruct-2407",tooltip:"unsloth/Mistral-Nemo-Instruct-2407 by Chutes",maxInputTokens:1,maxOutputTokens:131072,model:"unsloth/Mistral-Nemo-Instruct-2407",capabilities:{toolCalling:!1,imageInput:!1}},{id:"unsloth-gemma-3-27b-it",name:"unsloth/gemma-3-27b-it",tooltip:"unsloth/gemma-3-27b-it by Chutes",maxInputTokens:62464,maxOutputTokens:65536,model:"unsloth/gemma-3-27b-it",capabilities:{toolCalling:!0,imageInput:!0}},{id:"qwen-qwen3-235b-a22b-instruct-2507-tee",name:"Qwen/Qwen3-235B-A22B-Instruct-2507-TEE",tooltip:"Qwen/Qwen3-235B-A22B-Instruct-2507-TEE by Chutes",maxInputTokens:196608,maxOutputTokens:65536,model:"Qwen/Qwen3-235B-A22B-Instruct-2507-TEE",capabilities:{toolCalling:!0,imageInput:!1}},{id:"tngtech-deepseek-tng-r1t2-chimera",name:"tngtech/DeepSeek-TNG-R1T2-Chimera",tooltip:"tngtech/DeepSeek-TNG-R1T2-Chimera by Chutes",maxInputTokens:1,maxOutputTokens:163840,model:"tngtech/DeepSeek-TNG-R1T2-Chimera",capabilities:{toolCalling:!0,imageInput:!1}},{id:"qwen-qwen3-next-80b-a3b-instruct",name:"Qwen/Qwen3-Next-80B-A3B-Instruct",tooltip:"Qwen/Qwen3-Next-80B-A3B-Instruct by Chutes",maxInputTokens:1,maxOutputTokens:262144,model:"Qwen/Qwen3-Next-80B-A3B-Instruct",capabilities:{toolCalling:!0,imageInput:!1}},{id:"openai-gpt-oss-120b-tee",name:"openai/gpt-oss-120b-TEE",tooltip:"openai/gpt-oss-120b-TEE by Chutes",maxInputTokens:65536,maxOutputTokens:65536,model:"openai/gpt-oss-120b-TEE",capabilities:{toolCalling:!0,imageInput:!1}},{id:"zai-org-glm-4-6-tee",name:"zai-org/GLM-4.6-TEE",tooltip:"zai-org/GLM-4.6-TEE by Chutes",maxInputTokens:137216,maxOutputTokens:65536,model:"zai-org/GLM-4.6-TEE",capabilities:{toolCalling:!0,imageInput:!1}},{id:"zai-org-glm-4-7-tee",name:"zai-org/GLM-4.7-TEE",tooltip:"zai-org/GLM-4.7-TEE by Chutes",maxInputTokens:137217,maxOutputTokens:65535,model:"zai-org/GLM-4.7-TEE",capabilities:{toolCalling:!0,imageInput:!1}},{id:"nousresearch-hermes-4-70b",name:"NousResearch/Hermes-4-70B",tooltip:"NousResearch/Hermes-4-70B by Chutes",maxInputTokens:1,maxOutputTokens:131072,model:"NousResearch/Hermes-4-70B",capabilities:{toolCalling:!0,imageInput:!1}},{id:"deepseek-ai-deepseek-v3-1-tee",name:"deepseek-ai/DeepSeek-V3.1-TEE",tooltip:"deepseek-ai/DeepSeek-V3.1-TEE by Chutes",maxInputTokens:98304,maxOutputTokens:65536,model:"deepseek-ai/DeepSeek-V3.1-TEE",capabilities:{toolCalling:!0,imageInput:!1}},{id:"qwen-qwen3-30b-a3b-instruct-2507",name:"Qwen/Qwen3-30B-A3B-Instruct-2507",tooltip:"Qwen/Qwen3-30B-A3B-Instruct-2507 by Chutes",maxInputTokens:1,maxOutputTokens:262144,model:"Qwen/Qwen3-30B-A3B-Instruct-2507",capabilities:{toolCalling:!0,imageInput:!1}},{id:"deepseek-ai-deepseek-v3",name:"deepseek-ai/DeepSeek-V3",tooltip:"deepseek-ai/DeepSeek-V3 by Chutes",maxInputTokens:1,maxOutputTokens:163840,model:"deepseek-ai/DeepSeek-V3",capabilities:{toolCalling:!1,imageInput:!1}},{id:"nousresearch-hermes-4-3-36b",name:"NousResearch/Hermes-4.3-36B",tooltip:"NousResearch/Hermes-4.3-36B by Chutes",maxInputTokens:508288,maxOutputTokens:16e3,model:"NousResearch/Hermes-4.3-36B",capabilities:{toolCalling:!1,imageInput:!1}},{id:"nousresearch-hermes-4-405b-fp8-tee",name:"NousResearch/Hermes-4-405B-FP8-TEE",tooltip:"NousResearch/Hermes-4-405B-FP8-TEE by Chutes",maxInputTokens:65536,maxOutputTokens:65536,model:"NousResearch/Hermes-4-405B-FP8-TEE",capabilities:{toolCalling:!0,imageInput:!1}},{id:"chutesai-mistral-small-3-2-24b-instruct-2506",name:"chutesai/Mistral-Small-3.2-24B-Instruct-2506",tooltip:"chutesai/Mistral-Small-3.2-24B-Instruct-2506 by Chutes",maxInputTokens:1,maxOutputTokens:131072,model:"chutesai/Mistral-Small-3.2-24B-Instruct-2506",capabilities:{toolCalling:!0,imageInput:!0}},{id:"qwen-qwen3-14b",name:"Qwen/Qwen3-14B",tooltip:"Qwen/Qwen3-14B by Chutes",maxInputTokens:1,maxOutputTokens:40960,model:"Qwen/Qwen3-14B",capabilities:{toolCalling:!0,imageInput:!1}},{id:"moonshotai-kimi-k2-5-tee",name:"moonshotai/Kimi-K2.5-TEE",tooltip:"moonshotai/Kimi-K2.5-TEE by Chutes",maxInputTokens:196609,maxOutputTokens:65535,model:"moonshotai/Kimi-K2.5-TEE",capabilities:{toolCalling:!0,imageInput:!0}},{id:"deepseek-ai-deepseek-v3-1-terminus-tee",name:"deepseek-ai/DeepSeek-V3.1-Terminus-TEE",tooltip:"deepseek-ai/DeepSeek-V3.1-Terminus-TEE by Chutes",maxInputTokens:98304,maxOutputTokens:65536,model:"deepseek-ai/DeepSeek-V3.1-Terminus-TEE",capabilities:{toolCalling:!0,imageInput:!1}},{id:"xiaomimimo-mimo-v2-flash",name:"XiaomiMiMo/MiMo-V2-Flash",tooltip:"XiaomiMiMo/MiMo-V2-Flash by Chutes",maxInputTokens:246144,maxOutputTokens:16e3,model:"XiaomiMiMo/MiMo-V2-Flash",capabilities:{toolCalling:!1,imageInput:!1}},{id:"unsloth-gemma-3-4b-it",name:"unsloth/gemma-3-4b-it",tooltip:"unsloth/gemma-3-4b-it by Chutes",maxInputTokens:1,maxOutputTokens:96e3,model:"unsloth/gemma-3-4b-it",capabilities:{toolCalling:!1,imageInput:!0}},{id:"deepseek-ai-deepseek-r1-0528-tee",name:"deepseek-ai/DeepSeek-R1-0528-TEE",tooltip:"deepseek-ai/DeepSeek-R1-0528-TEE by Chutes",maxInputTokens:98304,maxOutputTokens:65536,model:"deepseek-ai/DeepSeek-R1-0528-TEE",capabilities:{toolCalling:!0,imageInput:!1}},{id:"qwen-qwen3-coder-480b-a35b-instruct-fp8-tee",name:"Qwen/Qwen3-Coder-480B-A35B-Instruct-FP8-TEE",tooltip:"Qwen/Qwen3-Coder-480B-A35B-Instruct-FP8-TEE by Chutes",maxInputTokens:1,maxOutputTokens:262144,model:"Qwen/Qwen3-Coder-480B-A35B-Instruct-FP8-TEE",capabilities:{toolCalling:!0,imageInput:!1}},{id:"opengvlab-internvl3-78b-tee",name:"OpenGVLab/InternVL3-78B-TEE",tooltip:"OpenGVLab/InternVL3-78B-TEE by Chutes",maxInputTokens:1,maxOutputTokens:32768,model:"OpenGVLab/InternVL3-78B-TEE",capabilities:{toolCalling:!1,imageInput:!0}},{id:"unsloth-gemma-3-12b-it",name:"unsloth/gemma-3-12b-it",tooltip:"unsloth/gemma-3-12b-it by Chutes",maxInputTokens:1,maxOutputTokens:131072,model:"unsloth/gemma-3-12b-it",capabilities:{toolCalling:!1,imageInput:!0}},{id:"qwen-qwen2-5-coder-32b-instruct",name:"Qwen/Qwen2.5-Coder-32B-Instruct",tooltip:"Qwen/Qwen2.5-Coder-32B-Instruct by Chutes",maxInputTokens:1,maxOutputTokens:32768,model:"Qwen/Qwen2.5-Coder-32B-Instruct",capabilities:{toolCalling:!1,imageInput:!1}},{id:"qwen-qwen3-235b-a22b-thinking-2507",name:"Qwen/Qwen3-235B-A22B-Thinking-2507",tooltip:"Qwen/Qwen3-235B-A22B-Thinking-2507 by Chutes",maxInputTokens:1,maxOutputTokens:262144,model:"Qwen/Qwen3-235B-A22B-Thinking-2507",capabilities:{toolCalling:!0,imageInput:!1}},{id:"tngtech-deepseek-r1t-chimera",name:"tngtech/DeepSeek-R1T-Chimera",tooltip:"tngtech/DeepSeek-R1T-Chimera by Chutes",maxInputTokens:1,maxOutputTokens:163840,model:"tngtech/DeepSeek-R1T-Chimera",capabilities:{toolCalling:!1,imageInput:!1}},{id:"qwen-qwen3-coder-next",name:"Qwen/Qwen3-Coder-Next",tooltip:"Qwen/Qwen3-Coder-Next by Chutes",maxInputTokens:196608,maxOutputTokens:65536,model:"Qwen/Qwen3-Coder-Next",capabilities:{toolCalling:!0,imageInput:!1}},{id:"qwen-qwen2-5-72b-instruct",name:"Qwen/Qwen2.5-72B-Instruct",tooltip:"Qwen/Qwen2.5-72B-Instruct by Chutes",maxInputTokens:1,maxOutputTokens:32768,model:"Qwen/Qwen2.5-72B-Instruct",capabilities:{toolCalling:!0,imageInput:!1}},{id:"moonshotai-kimi-k2-thinking-tee",name:"moonshotai/Kimi-K2-Thinking-TEE",tooltip:"moonshotai/Kimi-K2-Thinking-TEE by Chutes",maxInputTokens:196609,maxOutputTokens:65535,model:"moonshotai/Kimi-K2-Thinking-TEE",capabilities:{toolCalling:!0,imageInput:!1}},{id:"unsloth-mistral-small-24b-instruct-2501",name:"unsloth/Mistral-Small-24B-Instruct-2501",tooltip:"unsloth/Mistral-Small-24B-Instruct-2501 by Chutes",maxInputTokens:1,maxOutputTokens:32768,model:"unsloth/Mistral-Small-24B-Instruct-2501",capabilities:{toolCalling:!0,imageInput:!0}},{id:"qwen-qwen2-5-vl-72b-instruct-tee",name:"Qwen/Qwen2.5-VL-72B-Instruct-TEE",tooltip:"Qwen/Qwen2.5-VL-72B-Instruct-TEE by Chutes",maxInputTokens:1,maxOutputTokens:32768,model:"Qwen/Qwen2.5-VL-72B-Instruct-TEE",capabilities:{toolCalling:!1,imageInput:!0}},{id:"deepseek-ai-deepseek-r1-distill-llama-70b",name:"deepseek-ai/DeepSeek-R1-Distill-Llama-70B",tooltip:"deepseek-ai/DeepSeek-R1-Distill-Llama-70B by Chutes",maxInputTokens:1,maxOutputTokens:131072,model:"deepseek-ai/DeepSeek-R1-Distill-Llama-70B",capabilities:{toolCalling:!0,imageInput:!1}},{id:"minimaxai-minimax-m2-1-tee",name:"MiniMaxAI/MiniMax-M2.1-TEE",tooltip:"MiniMaxAI/MiniMax-M2.1-TEE by Chutes",maxInputTokens:131072,maxOutputTokens:65536,model:"MiniMaxAI/MiniMax-M2.1-TEE",capabilities:{toolCalling:!0,imageInput:!1}},{id:"zai-org-glm-4-7-fp8",name:"zai-org/GLM-4.7-FP8",tooltip:"zai-org/GLM-4.7-FP8 by Chutes",maxInputTokens:137217,maxOutputTokens:65535,model:"zai-org/GLM-4.7-FP8",capabilities:{toolCalling:!0,imageInput:!1}},{id:"zai-org-glm-4-5-tee",name:"zai-org/GLM-4.5-TEE",tooltip:"zai-org/GLM-4.5-TEE by Chutes",maxInputTokens:65536,maxOutputTokens:65536,model:"zai-org/GLM-4.5-TEE",capabilities:{toolCalling:!0,imageInput:!1}},{id:"qwen-qwen3-vl-235b-a22b-instruct",name:"Qwen/Qwen3-VL-235B-A22B-Instruct",tooltip:"Qwen/Qwen3-VL-235B-A22B-Instruct by Chutes",maxInputTokens:1,maxOutputTokens:262144,model:"Qwen/Qwen3-VL-235B-A22B-Instruct",capabilities:{toolCalling:!0,imageInput:!0}},{id:"nousresearch-deephermes-3-mistral-24b-preview",name:"NousResearch/DeepHermes-3-Mistral-24B-Preview",tooltip:"NousResearch/DeepHermes-3-Mistral-24B-Preview by Chutes",maxInputTokens:1,maxOutputTokens:32768,model:"NousResearch/DeepHermes-3-Mistral-24B-Preview",capabilities:{toolCalling:!0,imageInput:!1}},{id:"mistralai-devstral-2-123b-instruct-2512-tee",name:"mistralai/Devstral-2-123B-Instruct-2512-TEE",tooltip:"mistralai/Devstral-2-123B-Instruct-2512-TEE by Chutes",maxInputTokens:196608,maxOutputTokens:65536,model:"mistralai/Devstral-2-123B-Instruct-2512-TEE",capabilities:{toolCalling:!0,imageInput:!1}},{id:"deepseek-ai-deepseek-r1-tee",name:"deepseek-ai/DeepSeek-R1-TEE",tooltip:"deepseek-ai/DeepSeek-R1-TEE by Chutes",maxInputTokens:1,maxOutputTokens:163840,model:"deepseek-ai/DeepSeek-R1-TEE",capabilities:{toolCalling:!1,imageInput:!1}},{id:"openai-gpt-oss-20b",name:"openai/gpt-oss-20b",tooltip:"openai/gpt-oss-20b by Chutes",maxInputTokens:1,maxOutputTokens:131072,model:"openai/gpt-oss-20b",capabilities:{toolCalling:!0,imageInput:!1}},{id:"zai-org-glm-4-5-air",name:"zai-org/GLM-4.5-Air",tooltip:"zai-org/GLM-4.5-Air by Chutes",maxInputTokens:1,maxOutputTokens:131072,model:"zai-org/GLM-4.5-Air",capabilities:{toolCalling:!0,imageInput:!1}},{id:"qwen-qwen2-5-vl-32b-instruct",name:"Qwen/Qwen2.5-VL-32B-Instruct",tooltip:"Qwen/Qwen2.5-VL-32B-Instruct by Chutes",maxInputTokens:1,maxOutputTokens:16384,model:"Qwen/Qwen2.5-VL-32B-Instruct",capabilities:{toolCalling:!1,imageInput:!0}},{id:"zai-org-glm-4-6v",name:"zai-org/GLM-4.6V",tooltip:"zai-org/GLM-4.6V by Chutes",maxInputTokens:65536,maxOutputTokens:65536,model:"zai-org/GLM-4.6V",capabilities:{toolCalling:!0,imageInput:!0}},{id:"qwen-qwen3-235b-a22b",name:"Qwen/Qwen3-235B-A22B",tooltip:"Qwen/Qwen3-235B-A22B by Chutes",maxInputTokens:1,maxOutputTokens:40960,model:"Qwen/Qwen3-235B-A22B",capabilities:{toolCalling:!0,imageInput:!1}},{id:"zai-org-glm-4-6-fp8",name:"zai-org/GLM-4.6-FP8",tooltip:"zai-org/GLM-4.6-FP8 by Chutes",maxInputTokens:137217,maxOutputTokens:65535,model:"zai-org/GLM-4.6-FP8",capabilities:{toolCalling:!0,imageInput:!1}},{id:"zai-org-glm-4-7-flash",name:"zai-org/GLM-4.7-Flash",tooltip:"zai-org/GLM-4.7-Flash by Chutes",maxInputTokens:137217,maxOutputTokens:65535,model:"zai-org/GLM-4.7-Flash",capabilities:{toolCalling:!0,imageInput:!1}},{id:"qwen-qwen3-30b-a3b",name:"Qwen/Qwen3-30B-A3B",tooltip:"Qwen/Qwen3-30B-A3B by Chutes",maxInputTokens:1,maxOutputTokens:40960,model:"Qwen/Qwen3-30B-A3B",capabilities:{toolCalling:!0,imageInput:!1}},{id:"tngtech-tng-r1t-chimera-tee",name:"tngtech/TNG-R1T-Chimera-TEE",tooltip:"tngtech/TNG-R1T-Chimera-TEE by Chutes",maxInputTokens:98304,maxOutputTokens:65536,model:"tngtech/TNG-R1T-Chimera-TEE",capabilities:{toolCalling:!0,imageInput:!1}},{id:"deepseek-ai-deepseek-v3-2-speciale-tee",name:"deepseek-ai/DeepSeek-V3.2-Speciale-TEE",tooltip:"deepseek-ai/DeepSeek-V3.2-Speciale-TEE by Chutes",maxInputTokens:98304,maxOutputTokens:65536,model:"deepseek-ai/DeepSeek-V3.2-Speciale-TEE",capabilities:{toolCalling:!1,imageInput:!1}},{id:"nvidia-nvidia-nemotron-3-nano-30b-a3b-bf16",name:"nvidia/NVIDIA-Nemotron-3-Nano-30B-A3B-BF16",tooltip:"nvidia/NVIDIA-Nemotron-3-Nano-30B-A3B-BF16 by Chutes",maxInputTokens:1,maxOutputTokens:262144,model:"nvidia/NVIDIA-Nemotron-3-Nano-30B-A3B-BF16",capabilities:{toolCalling:!0,imageInput:!1}},{id:"zai-org-glm-4-5-fp8",name:"zai-org/GLM-4.5-FP8",tooltip:"zai-org/GLM-4.5-FP8 by Chutes",maxInputTokens:65536,maxOutputTokens:65536,model:"zai-org/GLM-4.5-FP8",capabilities:{toolCalling:!0,imageInput:!1}},{id:"tngtech-r1t2-chimera-speed",name:"tngtech/R1T2-Chimera-Speed",tooltip:"tngtech/R1T2-Chimera-Speed by Chutes",maxInputTokens:65536,maxOutputTokens:65536,model:"tngtech/R1T2-Chimera-Speed",capabilities:{toolCalling:!0,imageInput:!1}},{id:"miromind-ai-mirothinker-v1-5-235b",name:"miromind-ai/MiroThinker-v1.5-235B",tooltip:"miromind-ai/MiroThinker-v1.5-235B by Chutes",maxInputTokens:246144,maxOutputTokens:16e3,model:"miromind-ai/MiroThinker-v1.5-235B",capabilities:{toolCalling:!1,imageInput:!1}},{id:"nousresearch-hermes-4-14b",name:"NousResearch/Hermes-4-14B",tooltip:"NousResearch/Hermes-4-14B by Chutes",maxInputTokens:1,maxOutputTokens:40960,model:"NousResearch/Hermes-4-14B",capabilities:{toolCalling:!0,imageInput:!1}},{id:"qwen-qwen3guard-gen-0-6b",name:"Qwen/Qwen3Guard-Gen-0.6B",tooltip:"Qwen/Qwen3Guard-Gen-0.6B by Chutes",maxInputTokens:16768,maxOutputTokens:16e3,model:"Qwen/Qwen3Guard-Gen-0.6B",capabilities:{toolCalling:!1,imageInput:!1}},{id:"unsloth-llama-3-2-1b-instruct",name:"unsloth/Llama-3.2-1B-Instruct",tooltip:"unsloth/Llama-3.2-1B-Instruct by Chutes",maxInputTokens:384,maxOutputTokens:16e3,model:"unsloth/Llama-3.2-1B-Instruct",capabilities:{toolCalling:!1,imageInput:!1}},{id:"rednote-hilab-dots-ocr",name:"rednote-hilab/dots.ocr",tooltip:"rednote-hilab/dots.ocr by Chutes",maxInputTokens:1,maxOutputTokens:131072,model:"rednote-hilab/dots.ocr",capabilities:{toolCalling:!1,imageInput:!0}},{id:"tngtech-tng-r1t-chimera-turbo",name:"tngtech/TNG-R1T-Chimera-Turbo",tooltip:"tngtech/TNG-R1T-Chimera-Turbo by Chutes",maxInputTokens:98304,maxOutputTokens:65536,model:"tngtech/TNG-R1T-Chimera-Turbo",capabilities:{toolCalling:!0,imageInput:!1}},{id:"unsloth-llama-3-2-3b-instruct",name:"unsloth/Llama-3.2-3B-Instruct",tooltip:"unsloth/Llama-3.2-3B-Instruct by Chutes",maxInputTokens:384,maxOutputTokens:16e3,model:"unsloth/Llama-3.2-3B-Instruct",capabilities:{toolCalling:!1,imageInput:!1}},{id:"moonshotai-kimi-k2-instruct-0905",name:"moonshotai/Kimi-K2-Instruct-0905",tooltip:"moonshotai/Kimi-K2-Instruct-0905 by Chutes",maxInputTokens:1,maxOutputTokens:262144,model:"moonshotai/Kimi-K2-Instruct-0905",capabilities:{toolCalling:!0,imageInput:!1}}]}});var kx,wx=ke(()=>{kx={displayName:"Codex",baseUrl:"https://chatgpt.com/backend-api/codex",apiKeyTemplate:"",models:[{id:"gpt-5.2-codex-low",name:"GPT-5.2 Codex (Low Reasoning)",model:"gpt-5.2-codex",tooltip:"GPT-5.2 Codex with low reasoning effort - faster responses",maxInputTokens:4e5,maxOutputTokens:128e3,capabilities:{toolCalling:!0,imageInput:!0}},{id:"gpt-5.2-codex-medium",name:"GPT-5.2 Codex (Medium Reasoning)",model:"gpt-5.2-codex",tooltip:"GPT-5.2 Codex with medium reasoning effort - balanced",maxInputTokens:4e5,maxOutputTokens:128e3,capabilities:{toolCalling:!0,imageInput:!0}},{id:"gpt-5.2-codex-high",name:"GPT-5.2 Codex (High Reasoning)",model:"gpt-5.2-codex",tooltip:"GPT-5.2 Codex with high reasoning effort - most thorough",maxInputTokens:4e5,maxOutputTokens:128e3,capabilities:{toolCalling:!0,imageInput:!0}},{id:"gpt-5.2",name:"GPT-5.2",model:"gpt-5.2",tooltip:"GPT-5.2 - OpenAI's latest model",maxInputTokens:4e5,maxOutputTokens:128e3,capabilities:{toolCalling:!0,imageInput:!0}},{id:"gpt-5.2-low",name:"GPT-5.2 (Low Reasoning)",model:"gpt-5.2",tooltip:"GPT-5.2 with low reasoning effort",maxInputTokens:4e5,maxOutputTokens:128e3,capabilities:{toolCalling:!0,imageInput:!0}},{id:"gpt-5.2-medium",name:"GPT-5.2 (Medium Reasoning)",model:"gpt-5.2",tooltip:"GPT-5.2 with medium reasoning effort",maxInputTokens:4e5,maxOutputTokens:128e3,capabilities:{toolCalling:!0,imageInput:!0}},{id:"gpt-5.2-high",name:"GPT-5.2 (High Reasoning)",model:"gpt-5.2",tooltip:"GPT-5.2 with high reasoning effort",maxInputTokens:4e5,maxOutputTokens:128e3,capabilities:{toolCalling:!0,imageInput:!0}},{id:"gpt-5.1-codex-mini",name:"GPT-5.1 Codex Mini",model:"gpt-5.1-codex-mini",tooltip:"GPT-5.1 Codex Mini - OpenAI's optimized model",maxInputTokens:128e3,maxOutputTokens:8192,capabilities:{toolCalling:!0,imageInput:!0}}]}});var Cx,_x=ke(()=>{Cx={displayName:"DeepInfra",baseUrl:"https://api.deepinfra.com/v1/openai",apiKeyTemplate:"di-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx",models:[{id:"meta-llama/Meta-Llama-3.1-70B-Instruct",name:"Meta Llama 3.1 70B Instruct",tooltip:"Meta Llama 3.1 70B - Instruct by DeepInfra",maxInputTokens:2e5,maxOutputTokens:8192,capabilities:{toolCalling:!0,imageInput:!1}},{id:"Qwen/Qwen2-7B-Instruct",name:"Qwen 2 7B Instruct",tooltip:"Qwen2 7B - Instruct by DeepInfra",maxInputTokens:128e3,maxOutputTokens:8192,capabilities:{toolCalling:!0,imageInput:!1}}]}});var Ix,Tx=ke(()=>{Ix={displayName:"DeepSeek",baseUrl:"https://api.deepseek.com/v1",apiKeyTemplate:"sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx",models:[{id:"deepseek-chat",name:"DeepSeek-V3.2",tooltip:"DeepSeek V3.2 official model. DeepSeek-V3.2 aims to balance reasoning capability with output length, suitable for daily use such as Q&A and general Agent tasks. In public reasoning benchmarks, DeepSeek-V3.2 reached GPT-5 levels, slightly below Gemini-3.0-Pro; compared to Kimi-K2-Thinking, V3.2's output length is significantly reduced, notably decreasing computational overhead and user wait time.",sdkMode:"anthropic",baseUrl:"https://api.deepseek.com/anthropic",maxInputTokens:128e3,maxOutputTokens:8192,capabilities:{toolCalling:!0,imageInput:!1}},{id:"deepseek-reasoner",name:"DeepSeek-V3.2 (Reasoner)",tooltip:"DeepSeek V3.2 reasoning mode. DeepSeek-V3.2 aims to balance reasoning capability with output length, suitable for daily use such as Q&A and general Agent tasks. In public reasoning benchmarks, DeepSeek-V3.2 reached GPT-5 levels, slightly below Gemini-3.0-Pro; compared to Kimi-K2-Thinking, V3.2's output length is significantly reduced, notably decreasing computational overhead and user wait time.",sdkMode:"anthropic",baseUrl:"https://api.deepseek.com/anthropic",maxInputTokens:128e3,maxOutputTokens:64e3,includeThinking:!0,capabilities:{toolCalling:!0,imageInput:!1}}]}});var Px,Ax=ke(()=>{Px={displayName:"Gemini CLI",baseUrl:"https://cloudcode-pa.googleapis.com/v1internal",apiKeyTemplate:"OAuth via Gemini CLI",models:[{id:"gemini-2.5-pro",name:"Gemini 2.5 Pro",tooltip:"Gemini 2.5 Pro via CLI",maxInputTokens:1e6,maxOutputTokens:65536,sdkMode:"openai",capabilities:{toolCalling:!0,imageInput:!0}},{id:"gemini-2.5-flash",name:"Gemini 2.5 Flash",tooltip:"Gemini 2.5 Flash via CLI",maxInputTokens:1e6,maxOutputTokens:65536,sdkMode:"openai",capabilities:{toolCalling:!0,imageInput:!0}},{id:"gemini-2.5-flash-lite",name:"Gemini 2.5 Flash Lite",tooltip:"Gemini 2.5 Flash Lite via CLI",maxInputTokens:1e6,maxOutputTokens:65536,sdkMode:"openai",capabilities:{toolCalling:!0,imageInput:!0}},{id:"gemini-3-pro-preview",name:"Gemini 3 Pro Preview",tooltip:"Gemini 3 Pro Preview via CLI",maxInputTokens:1e6,maxOutputTokens:65536,sdkMode:"openai",capabilities:{toolCalling:!0,imageInput:!0}},{id:"gemini-3-flash-preview",name:"Gemini 3 Flash Preview",tooltip:"Gemini 3 Flash Preview via CLI",maxInputTokens:1e6,maxOutputTokens:65536,sdkMode:"openai",capabilities:{toolCalling:!0,imageInput:!0}}]}});var Sx,Mx=ke(()=>{Sx={displayName:"Hugging Face",baseUrl:"https://router.huggingface.co/v1",apiKeyTemplate:"hf_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx",models:[]}});var Ex,$x=ke(()=>{Ex={displayName:"Lightning AI",baseUrl:"https://lightning.ai/api/v1",apiKeyTemplate:"sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx",models:[{id:"openai/o3",name:"o3",tooltip:"o3 is a versatile, high-performing model across many domains. It raises the bar in math, science, coding, and visual reasoning, and it\u2019s excellent at technical writing and following instructions. Use it to tackle multi-step problems that combine text, code, and images.",maxInputTokens:184e3,maxOutputTokens:16e3,model:"openai/o3",capabilities:{toolCalling:!0,imageInput:!0}},{id:"openai/gpt-4o",name:"GPT 4o",tooltip:"GPT-4o is OpenAI\u2019s multimodal model, handling both text and image inputs with text outputs. It matches the intelligence of GPT-4 Turbo but runs twice as fast at half the cost. The model also brings stronger non-English language support and improved visual understanding.",maxInputTokens:112e3,maxOutputTokens:16e3,model:"openai/gpt-4o",capabilities:{toolCalling:!0,imageInput:!0}},{id:"openai/gpt-4",name:"GPT 4",tooltip:"The default GPT-4 model with an 8,192-token context window.",maxInputTokens:1,maxOutputTokens:16e3,model:"openai/gpt-4",capabilities:{toolCalling:!0,imageInput:!1}},{id:"google/gemini-2.5-flash-lite-preview-06-17",name:"Gemini 2.5 Flash Lite",tooltip:`Gemini 2.5 Flash-Lite is a model developed by Google DeepMind, designed to handle various tasks including reasoning, science, mathematics, code generation, and more. It features advanced capabilities in multilingual performance and long context understanding. It is optimized for low latency use cases, supporting multimodal input with a 1 million-token context length.

`,maxInputTokens:1032576,maxOutputTokens:16e3,model:"google/gemini-2.5-flash-lite-preview-06-17",capabilities:{toolCalling:!0,imageInput:!0}},{id:"lightning-ai/llama-3.3-70b",name:"llama-3.3-70b",tooltip:"Llama 3.3 is a text-only 70B instruction-tuned model that provides enhanced performance relative to Llama 3.1 70B\u2013and relative to Llama 3.2 90B when used for text-only applications. Moreover, for some applications, Llama 3.3 70B approaches the performance of Llama 3.1 405B.",maxInputTokens:112e3,maxOutputTokens:16e3,model:"lightning-ai/llama-3.3-70b",capabilities:{toolCalling:!0,imageInput:!1}},{id:"lightning-ai/DeepSeek-V3.1",name:"DeepSeek-V3.1",tooltip:"DeepSeek-V3.1 is a hybrid model that supports both thinking mode and non-thinking mode, switching between them with a simple chat template. It brings smarter tool calling, with much better performance in tool usage and agent tasks thanks to post-training optimization. The model also delivers higher thinking efficiency, reaching answer quality similar to DeepSeek-R1-0528 but with faster responses.",maxInputTokens:147840,maxOutputTokens:16e3,model:"lightning-ai/DeepSeek-V3.1",capabilities:{toolCalling:!0,imageInput:!1}},{id:"anthropic/claude-haiku-4-5-20251001",name:"Claude Haiku 4.5",tooltip:"Claude Haiku 4.5 delivers near-frontier performance with exceptional speed and cost-efficiency. It excels at real-time tasks like chat assistants, coding, and multi-agent workflows. Use it alone or alongside Sonnet 4.5 for fast, scalable execution.",maxInputTokens:136e3,maxOutputTokens:64e3,model:"anthropic/claude-haiku-4-5-20251001",capabilities:{toolCalling:!0,imageInput:!0}},{id:"anthropic/claude-sonnet-4-5-20250929",name:"Claude Sonnet 4.5",tooltip:"Claude Sonnet 4.5 is a frontier AI model that excels at coding, creating complex agents, and using computers for real-world tasks. It also features significant improvements in reasoning, math, and alignment, making it the most powerful model in its series.",maxInputTokens:184e3,maxOutputTokens:16e3,model:"anthropic/claude-sonnet-4-5-20250929",capabilities:{toolCalling:!0,imageInput:!0}},{id:"anthropic/claude-opus-4-5-20251101",name:"Claude Opus 4.5",tooltip:"Anthropic's Premium model combining maximum intelligence with practical performance",maxInputTokens:184e3,maxOutputTokens:16e3,model:"anthropic/claude-opus-4-5-20251101",capabilities:{toolCalling:!0,imageInput:!0}},{id:"openai/o3-mini",name:"o3 mini",tooltip:"OpenAI o3-mini is a lightweight, cost-efficient model built for STEM reasoning tasks like math, science, and coding. It lets you adjust its reasoning effort to balance speed and depth.The model delivers strong accuracy, matching the larger o1 on tough benchmarks while running faster and cheaper.",maxInputTokens:184e3,maxOutputTokens:16e3,model:"openai/o3-mini",capabilities:{toolCalling:!0,imageInput:!1}},{id:"anthropic/claude-sonnet-4-20250514",name:"Claude Sonnet 4",tooltip:`Claude Sonnet 4 improves on Sonnet 3.7 with stronger coding and reasoning skills, better precision, and greater reliability. It scores 72.7% on SWE-bench while staying efficient, making it ideal for both everyday coding and complex software projects.
`,maxInputTokens:184e3,maxOutputTokens:16e3,model:"anthropic/claude-sonnet-4-20250514",capabilities:{toolCalling:!0,imageInput:!0}},{id:"lightning-ai/gpt-oss-120b",name:"gpt-oss-120b",tooltip:"gpt-oss-120B is a 117 billion parameter language model, using a mixture-of-experts approach but activating only 5.1 billion per token for efficiency. It supports long contexts of up to 128k tokens, enabling it to handle extended conversations or documents smoothly. The model performs nearly at the level of o4-mini on reasoning tasks and surpasses many other open models in quality.",maxInputTokens:1,maxOutputTokens:131072,model:"lightning-ai/gpt-oss-120b",capabilities:{toolCalling:!0,imageInput:!1}},{id:"lightning-ai/gpt-oss-20b",name:"gpt-oss-20b",tooltip:"gpt-oss-20B is a 21-billion parameter language model built with a mixture-of-experts design that activates only about 3.6 billion parameters per token. This efficiency allows it to run on devices with as little as 16 GB of memory, making it well-suited for local setups or edge devices.",maxInputTokens:112e3,maxOutputTokens:16e3,model:"lightning-ai/gpt-oss-20b",capabilities:{toolCalling:!0,imageInput:!1}},{id:"anthropic/claude-opus-4-1-20250805",name:"Claude Opus 4.1",tooltip:"Claude Opus 4.1 is an enhanced version of Anthropic\u2019s flagship model, with stronger coding, reasoning, and agentic capabilities. It scores 74.5% on SWE-bench Verified and improves at multi-file refactoring, debugging, and detailed reasoning. With support for extended thinking up to 64K tokens, it\u2019s well-suited for research, data analysis, and tool-assisted problem solving.",maxInputTokens:168e3,maxOutputTokens:32e3,model:"anthropic/claude-opus-4-1-20250805",capabilities:{toolCalling:!0,imageInput:!0}},{id:"openai/gpt-5",name:"GPT 5",tooltip:`GPT-5 is OpenAI model that is built for complex, step-by-step tasks that demand precise instruction following and high-stakes accuracy. It supports test-time routing plus prompts like \u201Cthink hard about this.\u201D It also reduces hallucinations and sycophancy while improving performance in coding, writing, and health-related tasks.
`,maxInputTokens:384e3,maxOutputTokens:16e3,model:"openai/gpt-5",capabilities:{toolCalling:!0,imageInput:!1}},{id:"openai/gpt-5-mini",name:"GPT 5 mini",tooltip:"GPT-5 Mini is a smaller, more efficient variant of GPT-5 built for lighter reasoning tasks. It maintains the strong instruction-following and safety features of GPT-5 while offering faster responses and lower costs.",maxInputTokens:384e3,maxOutputTokens:16e3,model:"openai/gpt-5-mini",capabilities:{toolCalling:!0,imageInput:!1}},{id:"openai/gpt-5-nano",name:"GPT 5 nano",tooltip:"GPT-5-Nano is the smallest and fastest variant in the GPT-5 system, built as a unified system that can decide when to respond quickly or dig deeper depending on what you ask it. It gets much better across a wide range of skills \u2014 writing, coding, math, health, and visual tasks \u2014 and is more reliable and accurate in real-world scenarios. Compared to earlier models, it hallucinates less, follows instructions more faithfully, and understands the context better.",maxInputTokens:384e3,maxOutputTokens:16e3,model:"openai/gpt-5-nano",capabilities:{toolCalling:!0,imageInput:!1}},{id:"google/gemini-2.5-pro",name:"Gemini 2.5 Pro",tooltip:"Gemini 2.5 Pro is Google\u2019s AI model built for advanced reasoning, coding, math, and scientific work. With integrated \u201Cthinking\u201D capabilities, it delivers more accurate answers and handles context with greater nuance. It ranks at the top of multiple benchmarks, including first place on the LMArena leaderboard, showcasing strong human-preference alignment and exceptional problem-solving skills.",maxInputTokens:1032576,maxOutputTokens:16e3,model:"google/gemini-2.5-pro",capabilities:{toolCalling:!0,imageInput:!0}},{id:"google/gemini-2.5-flash",name:"Gemini 2.5 Flash",tooltip:"Gemini 2.5 Flash is Google\u2019s powerful model built for complex reasoning, coding, math, and scientific challenges. With integrated \u201Cthinking\u201D capabilities, it delivers more accurate answers and handles context with greater nuance.",maxInputTokens:1032576,maxOutputTokens:16e3,model:"google/gemini-2.5-flash",capabilities:{toolCalling:!0,imageInput:!0}},{id:"openai/gpt-5.2-2025-12-11",name:"GPT 5.2",tooltip:"GPT-5.2 is OpenAI's  flagship model for coding and agentic tasks across industries. ",maxInputTokens:384e3,maxOutputTokens:16e3,model:"openai/gpt-5.2-2025-12-11",capabilities:{toolCalling:!0,imageInput:!0}},{id:"openai/gpt-4.1",name:"GPT 4.1",tooltip:"OpenAI\u2019s fast and capable model for reasoning, coding, and chat. It responds quickly, supports long context (128k tokens), and runs efficiently at scale\u2014ideal for advanced API applications.",maxInputTokens:1031576,maxOutputTokens:16e3,model:"openai/gpt-4.1",capabilities:{toolCalling:!0,imageInput:!0}},{id:"openai/gpt-4-turbo-preview",name:"Lightning SDK expert",tooltip:"openai/gpt-4-turbo-preview by Lightning AI",maxInputTokens:112e3,maxOutputTokens:16e3,model:"openai/gpt-4-turbo-preview",capabilities:{toolCalling:!0,imageInput:!1}},{id:"openai/gpt-4-turbo-preview",name:"LitLogger helper",tooltip:"openai/gpt-4-turbo-preview by Lightning AI",maxInputTokens:112e3,maxOutputTokens:16e3,model:"openai/gpt-4-turbo-preview",capabilities:{toolCalling:!0,imageInput:!1}},{id:"anthropic/claude-opus-4-6",name:"Claude Opus 4.6",tooltip:"Claude Opus 4.6 is Anthropic\u2019s most intelligent model for building agents and coding",maxInputTokens:184e3,maxOutputTokens:16e3,model:"anthropic/claude-opus-4-6",capabilities:{toolCalling:!0,imageInput:!0}},{id:"lightning-ai/kimi-k2.5",name:"kimi-k2.5",tooltip:"Kimi K2.5 is an open-source, native multimodal agentic model built through continual pretraining on approximately 15 trillion mixed visual and text tokens atop Kimi-K2-Base. It seamlessly integrates vision and language understanding with advanced agentic capabilities, instant and thinking modes, as well as conversational and agentic paradigms.",maxInputTokens:24e4,maxOutputTokens:16e3,model:"lightning-ai/kimi-k2.5",capabilities:{toolCalling:!0,imageInput:!1}},{id:"google/gemini-3-flash-preview",name:"Gemini 3 Flash",tooltip:"Gemini 3 Flash Preview is designed to deliver strong agentic capabilities (near-Pro level) at substantial speed and value.",maxInputTokens:1032576,maxOutputTokens:16e3,model:"google/gemini-3-flash-preview",capabilities:{toolCalling:!0,imageInput:!0}},{id:"openai/gpt-4-turbo",name:"GPT 4 turbo",tooltip:"GPT-4 Turbo is an upgraded version of GPT-4, designed to deliver the same high intelligence while being faster and more cost-effective.",maxInputTokens:112e3,maxOutputTokens:16e3,model:"openai/gpt-4-turbo",capabilities:{toolCalling:!0,imageInput:!1}},{id:"google/gemini-3-pro-preview",name:"Gemini 3 Pro Preview",tooltip:"The best model in the world for multimodal understanding, and our most powerful agentic and vibe-coding model yet",maxInputTokens:1032576,maxOutputTokens:16e3,model:"google/gemini-3-pro-preview",capabilities:{toolCalling:!0,imageInput:!0}},{id:"anthropic/claude-opus-4-20250514",name:"Claude Opus 4",tooltip:"Claude Opus 4 is Anthropic\u2019s coding model, built for complex, long-running tasks and agent workflows. It leads in software engineering benchmarks with 72.5% on SWE-bench and 43.2% on Terminal-bench. The model is designed for extended use, sustaining thousands of task steps over hours without performance drop.",maxInputTokens:184e3,maxOutputTokens:16e3,model:"anthropic/claude-opus-4-20250514",capabilities:{toolCalling:!0,imageInput:!0}},{id:"openai/gpt-3.5-turbo",name:"GPT 3.5 turbo",tooltip:"GPT-3.5 Turbo is OpenAI's fastest model. It can understand and generate natural language or code, and is optimized for chat and traditional completion tasks.",maxInputTokens:385,maxOutputTokens:16e3,model:"openai/gpt-3.5-turbo",capabilities:{toolCalling:!0,imageInput:!1}}]}});var Ox,Rx=ke(()=>{Ox={displayName:"MiniMax",baseUrl:"https://api.minimaxi.com/v1",apiKeyTemplate:"This ApiKey is a long string with a JWT-like structure",models:[{id:"MiniMax-M2.1-Coding-Plan",name:"MiniMax-M2.1 (Coding Plan)",model:"MiniMax-M2.1",sdkMode:"anthropic",baseUrl:"https://api.minimaxi.com/anthropic",tooltip:"MiniMax-M2.1 - Strong multi-language programming capabilities, fully upgraded programming experience",provider:"minimax-coding",maxInputTokens:204800,maxOutputTokens:64e3,includeThinking:!0,capabilities:{toolCalling:!0,imageInput:!1}},{id:"MiniMax-M2-Coding-Plan",name:"MiniMax-M2 (Coding Plan)",model:"MiniMax-M2",sdkMode:"anthropic",baseUrl:"https://api.minimaxi.com/anthropic",tooltip:"MiniMax-M2 - Born for efficient coding and Agent workflows",provider:"minimax-coding",maxInputTokens:204800,maxOutputTokens:64e3,includeThinking:!0,capabilities:{toolCalling:!0,imageInput:!1}},{id:"MiniMax-M2.1",name:"MiniMax-M2.1 (Pay-per-use)",sdkMode:"anthropic",baseUrl:"https://api.minimaxi.com/anthropic",tooltip:"MiniMax-M2.1 - Strong multi-language programming capabilities, fully upgraded programming experience",maxInputTokens:204800,maxOutputTokens:128e3,includeThinking:!0,capabilities:{toolCalling:!0,imageInput:!1}},{id:"MiniMax-M2.1-Lightning",name:"MiniMax-M2.1-Lightning (2x Speed Rate)",sdkMode:"anthropic",baseUrl:"https://api.minimaxi.com/anthropic",tooltip:"MiniMax-M2.1 - Faster, more efficient - Strong multi-language programming capabilities, fully upgraded programming experience",maxInputTokens:204800,maxOutputTokens:128e3,includeThinking:!0,capabilities:{toolCalling:!0,imageInput:!1}},{id:"MiniMax-M2",name:"MiniMax-M2 (Pay-per-use)",sdkMode:"anthropic",baseUrl:"https://api.minimaxi.com/anthropic",tooltip:"MiniMax-M2 - Born for efficient coding and Agent workflows",maxInputTokens:204800,maxOutputTokens:64e3,includeThinking:!0,capabilities:{toolCalling:!0,imageInput:!1}}]}});var Nx,Lx=ke(()=>{Nx={displayName:"Mistral AI",baseUrl:"https://api.mistral.ai/v1",apiKeyTemplate:"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx",models:[{id:"devstral-small-latest",name:"Devstral Small 2",tooltip:"Devstral Small 2 - Latest version",maxInputTokens:256e3,maxOutputTokens:65536,capabilities:{toolCalling:!0,imageInput:!0}},{id:"devstral-latest",name:"Devstral 2",tooltip:"Devstral 2 - Latest version",maxInputTokens:256e3,maxOutputTokens:65536,capabilities:{toolCalling:!0,imageInput:!1}}]}});var Dx,zx=ke(()=>{Dx={displayName:"MoonshotAI",baseUrl:"https://api.moonshot.cn/v1",apiKeyTemplate:"sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx",models:[{id:"kimi-for-coding",name:"Kimi For Coding",sdkMode:"anthropic",baseUrl:"https://api.kimi.com/coding",provider:"kimi",tooltip:"Kimi For Coding - Professional programming model by Moonshot AI, providing strong code generation and understanding capabilities",maxInputTokens:256e3,maxOutputTokens:32e3,capabilities:{toolCalling:!0,imageInput:!1},customHeader:{"HTTP-Referer":"https://github.com/RooVetGit/Roo-Cline","X-Title":"Roo Code","User-Agent":"RooCode/3.36.16"}},{id:"kimi-k2-thinking",name:"Kimi-K2-Thinking",tooltip:"Moonshot AI Kimi-K2-Thinking - Model context length 256k, a thinking model with general Agentic and reasoning capabilities, excels at deep reasoning",maxInputTokens:256e3,maxOutputTokens:16e3,includeThinking:!0,capabilities:{toolCalling:!0,imageInput:!1},extraBody:{temperature:1,top_p:1}},{id:"kimi-k2-thinking-turbo",name:"Kimi-K2-Thinking-Turbo",tooltip:"Moonshot AI Kimi-K2-Thinking-Turbo - Model context length 256k, high-speed version of kimi-k2-thinking, suitable for scenarios requiring deep reasoning and extreme speed",maxInputTokens:256e3,maxOutputTokens:16e3,includeThinking:!0,capabilities:{toolCalling:!0,imageInput:!1},extraBody:{temperature:1,top_p:1}},{id:"kimi-k2-0905-preview",name:"Kimi-K2-0905-Preview",sdkMode:"anthropic",baseUrl:"https://api.moonshot.cn/anthropic",tooltip:"Moonshot AI Kimi-K2-0905-Preview - Stronger Agentic Coding capabilities, more prominent frontend code aesthetics and practicality, 256K context",maxInputTokens:256e3,maxOutputTokens:8192,capabilities:{toolCalling:!0,imageInput:!1}},{id:"kimi-k2-turbo-preview",name:"Kimi-K2-Turbo-Preview",sdkMode:"anthropic",baseUrl:"https://api.moonshot.cn/anthropic",tooltip:"Moonshot AI Kimi-K2-Turbo-Preview - High-speed version model, output speed 60-100 tokens/sec, 256K context",maxInputTokens:256e3,maxOutputTokens:8192,capabilities:{toolCalling:!0,imageInput:!1}},{id:"kimi-k2-0711-preview",name:"Kimi-K2-0711-Preview",sdkMode:"anthropic",baseUrl:"https://api.moonshot.cn/anthropic",tooltip:"Moonshot AI Kimi-K2-0711-Preview - K2 series base version, 128K context",maxInputTokens:128e3,maxOutputTokens:8192,version:"kimi-k2-0711-previw",capabilities:{toolCalling:!0,imageInput:!1}},{id:"kimi-latest",name:"Kimi-Latest",tooltip:"Moonshot AI Kimi-Latest - Latest generation visual model, 128K context, supports image understanding, automatic context caching, intelligent selection of 8K/32K/128K billing models",maxInputTokens:128e3,maxOutputTokens:8192,capabilities:{toolCalling:!0,imageInput:!0}}]}});var Fx,qx=ke(()=>{Fx={displayName:"OpenCode",baseUrl:"https://opencode.ai/zen/v1",apiKeyTemplate:"sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx",models:[{id:"claude-opus-4-6",name:"claude-opus-4-6",tooltip:"claude-opus-4-6 by OpenCode",maxInputTokens:112e3,maxOutputTokens:16e3,model:"claude-opus-4-6",capabilities:{toolCalling:!0,imageInput:!1}},{id:"claude-opus-4-5",name:"claude-opus-4-5",tooltip:"claude-opus-4-5 by OpenCode",maxInputTokens:112e3,maxOutputTokens:16e3,model:"claude-opus-4-5",capabilities:{toolCalling:!0,imageInput:!1}},{id:"claude-opus-4-1",name:"claude-opus-4-1",tooltip:"claude-opus-4-1 by OpenCode",maxInputTokens:112e3,maxOutputTokens:16e3,model:"claude-opus-4-1",capabilities:{toolCalling:!0,imageInput:!1}},{id:"claude-sonnet-4",name:"claude-sonnet-4",tooltip:"claude-sonnet-4 by OpenCode",maxInputTokens:112e3,maxOutputTokens:16e3,model:"claude-sonnet-4",capabilities:{toolCalling:!0,imageInput:!1}},{id:"claude-sonnet-4-5",name:"claude-sonnet-4-5",tooltip:"claude-sonnet-4-5 by OpenCode",maxInputTokens:112e3,maxOutputTokens:16e3,model:"claude-sonnet-4-5",capabilities:{toolCalling:!0,imageInput:!1}},{id:"claude-3-5-haiku",name:"claude-3-5-haiku",tooltip:"claude-3-5-haiku by OpenCode",maxInputTokens:112e3,maxOutputTokens:16e3,model:"claude-3-5-haiku",capabilities:{toolCalling:!0,imageInput:!1}},{id:"claude-haiku-4-5",name:"claude-haiku-4-5",tooltip:"claude-haiku-4-5 by OpenCode",maxInputTokens:112e3,maxOutputTokens:16e3,model:"claude-haiku-4-5",capabilities:{toolCalling:!0,imageInput:!1}},{id:"gemini-3-pro",name:"gemini-3-pro",tooltip:"gemini-3-pro by OpenCode",maxInputTokens:112e3,maxOutputTokens:16e3,model:"gemini-3-pro",capabilities:{toolCalling:!0,imageInput:!1}},{id:"gemini-3-flash",name:"gemini-3-flash",tooltip:"gemini-3-flash by OpenCode",maxInputTokens:112e3,maxOutputTokens:16e3,model:"gemini-3-flash",capabilities:{toolCalling:!0,imageInput:!1}},{id:"gpt-5.2",name:"gpt-5.2",tooltip:"gpt-5.2 by OpenCode",maxInputTokens:112e3,maxOutputTokens:16e3,model:"gpt-5.2",capabilities:{toolCalling:!0,imageInput:!1}},{id:"gpt-5.2-codex",name:"gpt-5.2-codex",tooltip:"gpt-5.2-codex by OpenCode",maxInputTokens:112e3,maxOutputTokens:16e3,model:"gpt-5.2-codex",capabilities:{toolCalling:!0,imageInput:!1}},{id:"gpt-5.1",name:"gpt-5.1",tooltip:"gpt-5.1 by OpenCode",maxInputTokens:112e3,maxOutputTokens:16e3,model:"gpt-5.1",capabilities:{toolCalling:!0,imageInput:!1}},{id:"gpt-5.1-codex-max",name:"gpt-5.1-codex-max",tooltip:"gpt-5.1-codex-max by OpenCode",maxInputTokens:112e3,maxOutputTokens:16e3,model:"gpt-5.1-codex-max",capabilities:{toolCalling:!0,imageInput:!1}},{id:"gpt-5.1-codex",name:"gpt-5.1-codex",tooltip:"gpt-5.1-codex by OpenCode",maxInputTokens:112e3,maxOutputTokens:16e3,model:"gpt-5.1-codex",capabilities:{toolCalling:!0,imageInput:!1}},{id:"gpt-5.1-codex-mini",name:"gpt-5.1-codex-mini",tooltip:"gpt-5.1-codex-mini by OpenCode",maxInputTokens:112e3,maxOutputTokens:16e3,model:"gpt-5.1-codex-mini",capabilities:{toolCalling:!0,imageInput:!1}},{id:"gpt-5",name:"gpt-5",tooltip:"gpt-5 by OpenCode",maxInputTokens:112e3,maxOutputTokens:16e3,model:"gpt-5",capabilities:{toolCalling:!0,imageInput:!1}},{id:"gpt-5-codex",name:"gpt-5-codex",tooltip:"gpt-5-codex by OpenCode",maxInputTokens:112e3,maxOutputTokens:16e3,model:"gpt-5-codex",capabilities:{toolCalling:!0,imageInput:!1}},{id:"gpt-5-nano",name:"gpt-5-nano",tooltip:"gpt-5-nano by OpenCode",maxInputTokens:112e3,maxOutputTokens:16e3,model:"gpt-5-nano",capabilities:{toolCalling:!0,imageInput:!1}},{id:"glm-4.7",name:"glm-4.7",tooltip:"glm-4.7 by OpenCode",maxInputTokens:112e3,maxOutputTokens:16e3,model:"glm-4.7",capabilities:{toolCalling:!0,imageInput:!1}},{id:"glm-4.6",name:"glm-4.6",tooltip:"glm-4.6 by OpenCode",maxInputTokens:112e3,maxOutputTokens:16e3,model:"glm-4.6",capabilities:{toolCalling:!0,imageInput:!1}},{id:"minimax-m2.1",name:"minimax-m2.1",tooltip:"minimax-m2.1 by OpenCode",maxInputTokens:112e3,maxOutputTokens:16e3,model:"minimax-m2.1",capabilities:{toolCalling:!0,imageInput:!1}},{id:"minimax-m2.5-free",name:"minimax-m2.5-free",tooltip:"minimax-m2.5-free by OpenCode",maxInputTokens:112e3,maxOutputTokens:16e3,model:"minimax-m2.5-free",capabilities:{toolCalling:!0,imageInput:!1}},{id:"minimax-m2.1-free",name:"minimax-m2.1-free",tooltip:"minimax-m2.1-free by OpenCode",maxInputTokens:112e3,maxOutputTokens:16e3,model:"minimax-m2.1-free",capabilities:{toolCalling:!0,imageInput:!1}},{id:"kimi-k2.5",name:"kimi-k2.5",tooltip:"kimi-k2.5 by OpenCode",maxInputTokens:112e3,maxOutputTokens:16e3,model:"kimi-k2.5",capabilities:{toolCalling:!0,imageInput:!1}},{id:"kimi-k2.5-free",name:"kimi-k2.5-free",tooltip:"kimi-k2.5-free by OpenCode",maxInputTokens:112e3,maxOutputTokens:16e3,model:"kimi-k2.5-free",capabilities:{toolCalling:!0,imageInput:!1}},{id:"kimi-k2",name:"kimi-k2",tooltip:"kimi-k2 by OpenCode",maxInputTokens:112e3,maxOutputTokens:16e3,model:"kimi-k2",capabilities:{toolCalling:!0,imageInput:!1}},{id:"kimi-k2-thinking",name:"kimi-k2-thinking",tooltip:"kimi-k2-thinking by OpenCode",maxInputTokens:112e3,maxOutputTokens:16e3,model:"kimi-k2-thinking",capabilities:{toolCalling:!0,imageInput:!1}},{id:"trinity-large-preview-free",name:"trinity-large-preview-free",tooltip:"trinity-large-preview-free by OpenCode",maxInputTokens:112e3,maxOutputTokens:16e3,model:"trinity-large-preview-free",capabilities:{toolCalling:!0,imageInput:!1}},{id:"glm-4.7-free",name:"glm-4.7-free",tooltip:"glm-4.7-free by OpenCode",maxInputTokens:112e3,maxOutputTokens:16e3,model:"glm-4.7-free",capabilities:{toolCalling:!0,imageInput:!1}},{id:"big-pickle",name:"big-pickle",tooltip:"big-pickle by OpenCode",maxInputTokens:112e3,maxOutputTokens:16e3,model:"big-pickle",capabilities:{toolCalling:!0,imageInput:!1}},{id:"alpha-g5",name:"alpha-g5",tooltip:"alpha-g5 by OpenCode",maxInputTokens:112e3,maxOutputTokens:16e3,model:"alpha-g5",capabilities:{toolCalling:!0,imageInput:!1}}]}});var Ux,Bx=ke(()=>{Ux={displayName:"Ollama Cloud",baseUrl:"https://ollama.com/v1",apiKeyTemplate:"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx.xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx",models:[{id:"cogito-2.1:671b",name:"cogito-2.1:671b",tooltip:"128K context window",maxInputTokens:128e3,maxOutputTokens:128e3,model:"cogito-2.1:671b",capabilities:{toolCalling:!0,imageInput:!1}},{id:"glm-4.6",name:"glm-4.6",tooltip:"Context expanded from 128K to 200K tokens",maxInputTokens:2e5,maxOutputTokens:131072,model:"glm-4.6",capabilities:{toolCalling:!0,imageInput:!1}},{id:"glm-4.7",name:"glm-4.7",tooltip:"200K+ token context window",maxInputTokens:204800,maxOutputTokens:131072,model:"glm-4.7",capabilities:{toolCalling:!0,imageInput:!1}},{id:"kimi-k2:1t",name:"kimi-k2:1t",tooltip:"Instruct variant, 128K context",maxInputTokens:128e3,maxOutputTokens:16384,model:"kimi-k2:1t",capabilities:{toolCalling:!0,imageInput:!1}},{id:"kimi-k2-thinking",name:"kimi-k2-thinking",tooltip:"256K context window with reasoning capabilities",maxInputTokens:256e3,maxOutputTokens:262144,model:"kimi-k2-thinking",capabilities:{toolCalling:!0,imageInput:!1}},{id:"kimi-k2.5",name:"kimi-k2.5",tooltip:"256K context window with reasoning capabilities",maxInputTokens:256e3,maxOutputTokens:262144,model:"kimi-k2.5",capabilities:{toolCalling:!0,imageInput:!1}},{id:"qwen3-coder:480b",name:"qwen3-coder:480b",tooltip:"Native 256K, extensible to 1M with Yarn",maxInputTokens:262144,maxOutputTokens:131072,model:"qwen3-coder:480b",capabilities:{toolCalling:!0,imageInput:!1}},{id:"qwen3-next:80b",name:"qwen3-next:80b",tooltip:"Native 262K tokens, extensible to 1M",maxInputTokens:262144,maxOutputTokens:65536,model:"qwen3-next:80b",capabilities:{toolCalling:!0,imageInput:!1}},{id:"deepseek-v3.2",name:"deepseek-v3.2",tooltip:"128K context, default max output 4K, maximum 8K",maxInputTokens:131072,maxOutputTokens:8192,model:"deepseek-v3.2",capabilities:{toolCalling:!0,imageInput:!1}},{id:"deepseek-v3.1:671b",name:"deepseek-v3.1:671b",tooltip:"128K context window, 671B total parameters, 37B active",maxInputTokens:131072,maxOutputTokens:8192,model:"deepseek-v3.1:671b",capabilities:{toolCalling:!0,imageInput:!1}},{id:"gpt-oss:120b",name:"gpt-oss:120b",tooltip:"128K context using RoPE, extended to 131K with YaRN",maxInputTokens:131072,maxOutputTokens:131072,model:"gpt-oss:120b",capabilities:{toolCalling:!0,imageInput:!1}},{id:"nemotron-3-nano:30b",name:"nemotron-3-nano:30b",tooltip:"1M token context window, output limit not specified",maxInputTokens:1e6,maxOutputTokens:131072,model:"nemotron-3-nano:30b",capabilities:{toolCalling:!0,imageInput:!1}},{id:"gpt-oss:20b",name:"gpt-oss:20b",tooltip:"Same 128K context as 120B variant",maxInputTokens:131072,maxOutputTokens:131072,model:"gpt-oss:20b",capabilities:{toolCalling:!0,imageInput:!1}},{id:"qwen3-vl:235b-instruct",name:"qwen3-vl:235b-instruct",tooltip:"256K context (262,144), vision-language model",maxInputTokens:262144,maxOutputTokens:32768,model:"qwen3-vl:235b-instruct",capabilities:{toolCalling:!0,imageInput:!0}},{id:"qwen3-vl:235b",name:"qwen3-vl:235b",tooltip:"256K context, base model variant",maxInputTokens:262144,maxOutputTokens:262144,model:"qwen3-vl:235b",capabilities:{toolCalling:!0,imageInput:!0}},{id:"minimax-m2",name:"minimax-m2",tooltip:"197K context length, 128K max output",maxInputTokens:196608,maxOutputTokens:131072,model:"minimax-m2",capabilities:{toolCalling:!0,imageInput:!1}},{id:"minimax-m2.1",name:"minimax-m2.1",tooltip:"204.8K context, enhanced from M2",maxInputTokens:204800,maxOutputTokens:131072,model:"minimax-m2.1",capabilities:{toolCalling:!0,imageInput:!1}},{id:"ministral-3:3b",name:"ministral-3:3b",tooltip:"256K context window",maxInputTokens:262144,maxOutputTokens:8192,model:"ministral-3:3b",capabilities:{toolCalling:!0,imageInput:!1}},{id:"ministral-3:8b",name:"ministral-3:8b",tooltip:"256K context window",maxInputTokens:262144,maxOutputTokens:8192,model:"ministral-3:8b",capabilities:{toolCalling:!0,imageInput:!1}},{id:"ministral-3:14b",name:"ministral-3:14b",tooltip:"256K context window",maxInputTokens:262144,maxOutputTokens:8192,model:"ministral-3:14b",capabilities:{toolCalling:!0,imageInput:!1}},{id:"mistral-large-3:675b",name:"mistral-large-3:675b",tooltip:"128K context, 262K max output capacity",maxInputTokens:131072,maxOutputTokens:262144,model:"mistral-large-3:675b",capabilities:{toolCalling:!0,imageInput:!1}},{id:"devstral-2:123b",name:"devstral-2:123b",tooltip:"256K context window, coding-focused",maxInputTokens:262144,maxOutputTokens:4096,model:"devstral-2:123b",capabilities:{toolCalling:!0,imageInput:!1}},{id:"devstral-small-2:24b",name:"devstral-small-2:24b",tooltip:"256K context window",maxInputTokens:262144,maxOutputTokens:4096,model:"devstral-small-2:24b",capabilities:{toolCalling:!0,imageInput:!0}},{id:"gemini-3-pro-preview",name:"gemini-3-pro-preview",tooltip:"1M input tokens, 64K output limit",maxInputTokens:1048576,maxOutputTokens:65536,model:"gemini-3-pro-preview",capabilities:{toolCalling:!0,imageInput:!0}},{id:"gemini-3-flash-preview",name:"gemini-3-flash-preview",tooltip:"1M input tokens, 64K output limit",maxInputTokens:1048576,maxOutputTokens:65536,model:"gemini-3-flash-preview",capabilities:{toolCalling:!0,imageInput:!0}},{id:"gemma3:4b",name:"gemma3:4b",tooltip:"128K context window",maxInputTokens:131072,maxOutputTokens:8192,model:"gemma3:4b",capabilities:{toolCalling:!0,imageInput:!1}},{id:"gemma3:12b",name:"gemma3:12b",tooltip:"128K context window",maxInputTokens:131072,maxOutputTokens:8192,model:"gemma3:12b",capabilities:{toolCalling:!0,imageInput:!1}},{id:"gemma3:27b",name:"gemma3:27b",tooltip:"128K context window",maxInputTokens:131072,maxOutputTokens:8192,model:"gemma3:27b",capabilities:{toolCalling:!0,imageInput:!1}},{id:"rnj-1:8b",name:"rnj-1:8b",tooltip:"32K context with YaRN extension, max output not specified",maxInputTokens:32768,maxOutputTokens:16e3,model:"rnj-1:8b",capabilities:{toolCalling:!0,imageInput:!1}}]}});var Kx,jx=ke(()=>{Kx={displayName:"Qwen Code CLI",baseUrl:"https://dashscope.aliyuncs.com/compatible-mode/v1",apiKeyTemplate:"OAuth via Qwen CLI",models:[{id:"coder-model",name:"Qwen Coder (CLI Default)",tooltip:"Qwen Coder via CLI",maxInputTokens:1e6,maxOutputTokens:65536,model:"coder-model",capabilities:{toolCalling:!0,imageInput:!1}},{id:"vision-model",name:"Qwen Vision",tooltip:"Qwen Vision model via CLI",maxInputTokens:1e6,maxOutputTokens:65536,model:"vision-model",capabilities:{toolCalling:!0,imageInput:!0}},{id:"qwen3-coder-plus",name:"Qwen3 Coder Plus",tooltip:"Qwen3 Coder Plus via CLI",maxInputTokens:1e6,maxOutputTokens:65536,model:"qwen3-coder-plus",capabilities:{toolCalling:!0,imageInput:!1}}]}});var Zx,Hx=ke(()=>{Zx={displayName:"Zenmux",baseUrl:"https://zenmux.ai/api/v1",apiKeyTemplate:"zm-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx",models:[{id:"kuaishou-kat-coder-pro-v1-free",name:"KwaiKAT: KAT-Coder-Pro-V1 Free",tooltip:"KwaiKAT: KAT-Coder-Pro-V1 Free by Zenmux",maxInputTokens:24e4,maxOutputTokens:16e3,model:"kuaishou/kat-coder-pro-v1-free",capabilities:{toolCalling:!0,imageInput:!1}},{id:"z-ai-glm-4-6v-flash-free",name:"Z.AI: GLM 4.6V Flash (Free)",tooltip:"Z.AI: GLM 4.6V Flash (Free) by Zenmux",maxInputTokens:184e3,maxOutputTokens:16e3,model:"z-ai/glm-4.6v-flash-free",capabilities:{toolCalling:!0,imageInput:!0}},{id:"xiaomi-mimo-v2-flash-free",name:"Xiaomi: MiMo-V2-Flash Free",tooltip:"Xiaomi: MiMo-V2-Flash Free by Zenmux",maxInputTokens:246144,maxOutputTokens:16e3,model:"xiaomi/mimo-v2-flash-free",capabilities:{toolCalling:!0,imageInput:!1}},{id:"openai-gpt-4-1-mini",name:"OpenAI: GPT-4.1 Mini",tooltip:"OpenAI: GPT-4.1 Mini by Zenmux",maxInputTokens:1031576,maxOutputTokens:16e3,model:"openai/gpt-4.1-mini",capabilities:{toolCalling:!0,imageInput:!0}},{id:"anthropic-claude-opus-4",name:"Anthropic: Claude Opus 4",tooltip:"Anthropic: Claude Opus 4 by Zenmux",maxInputTokens:184e3,maxOutputTokens:16e3,model:"anthropic/claude-opus-4",capabilities:{toolCalling:!0,imageInput:!0}},{id:"openai-gpt-4-1-nano",name:"OpenAI: GPT-4.1 Nano",tooltip:"OpenAI: GPT-4.1 Nano by Zenmux",maxInputTokens:1031576,maxOutputTokens:16e3,model:"openai/gpt-4.1-nano",capabilities:{toolCalling:!0,imageInput:!0}},{id:"openai-o4-mini",name:"OpenAI: o4 Mini",tooltip:"OpenAI: o4 Mini by Zenmux",maxInputTokens:184e3,maxOutputTokens:16e3,model:"openai/o4-mini",capabilities:{toolCalling:!0,imageInput:!0}},{id:"openai-gpt-5",name:"OpenAI: GPT-5",tooltip:"OpenAI: GPT-5 by Zenmux",maxInputTokens:384e3,maxOutputTokens:16e3,model:"openai/gpt-5",capabilities:{toolCalling:!0,imageInput:!0}},{id:"openai-gpt-4o",name:"OpenAI: GPT-4o",tooltip:"OpenAI: GPT-4o by Zenmux",maxInputTokens:112e3,maxOutputTokens:16e3,model:"openai/gpt-4o",capabilities:{toolCalling:!0,imageInput:!0}},{id:"openai-gpt-5-nano",name:"OpenAI: GPT-5 Nano",tooltip:"OpenAI: GPT-5 Nano by Zenmux",maxInputTokens:384e3,maxOutputTokens:16e3,model:"openai/gpt-5-nano",capabilities:{toolCalling:!0,imageInput:!0}},{id:"openai-gpt-4-1",name:"OpenAI: GPT-4.1",tooltip:"OpenAI: GPT-4.1 by Zenmux",maxInputTokens:1031576,maxOutputTokens:16e3,model:"openai/gpt-4.1",capabilities:{toolCalling:!0,imageInput:!0}},{id:"anthropic-claude-3-5-haiku",name:"Anthropic: Claude 3.5 Haiku",tooltip:"Anthropic: Claude 3.5 Haiku by Zenmux",maxInputTokens:184e3,maxOutputTokens:16e3,model:"anthropic/claude-3.5-haiku",capabilities:{toolCalling:!0,imageInput:!0}},{id:"google-gemini-2-5-flash-lite",name:"Google: Gemini 2.5 Flash Lite",tooltip:"Google: Gemini 2.5 Flash Lite by Zenmux",maxInputTokens:1032576,maxOutputTokens:16e3,model:"google/gemini-2.5-flash-lite",capabilities:{toolCalling:!0,imageInput:!0}},{id:"anthropic-claude-3-7-sonnet",name:"Anthropic: Claude 3.7 Sonnet",tooltip:"Anthropic: Claude 3.7 Sonnet by Zenmux",maxInputTokens:184e3,maxOutputTokens:16e3,model:"anthropic/claude-3.7-sonnet",capabilities:{toolCalling:!0,imageInput:!0}},{id:"deepseek-deepseek-r1-0528",name:"DeepSeek: R1 0528",tooltip:"DeepSeek: R1 0528 by Zenmux",maxInputTokens:48e3,maxOutputTokens:16e3,model:"deepseek/deepseek-r1-0528",capabilities:{toolCalling:!0,imageInput:!1}},{id:"anthropic-claude-opus-4-1",name:"Anthropic: Claude Opus 4.1",tooltip:"Anthropic: Claude Opus 4.1 by Zenmux",maxInputTokens:184e3,maxOutputTokens:16e3,model:"anthropic/claude-opus-4.1",capabilities:{toolCalling:!0,imageInput:!0}},{id:"anthropic-claude-sonnet-4",name:"Anthropic: Claude Sonnet 4",tooltip:"Anthropic: Claude Sonnet 4 by Zenmux",maxInputTokens:984e3,maxOutputTokens:16e3,model:"anthropic/claude-sonnet-4",capabilities:{toolCalling:!0,imageInput:!0}},{id:"openai-gpt-5-mini",name:"OpenAI: GPT-5 Mini",tooltip:"OpenAI: GPT-5 Mini by Zenmux",maxInputTokens:384e3,maxOutputTokens:16e3,model:"openai/gpt-5-mini",capabilities:{toolCalling:!0,imageInput:!0}},{id:"openai-gpt-5-chat",name:"OpenAI: GPT-5 Chat",tooltip:"OpenAI: GPT-5 Chat by Zenmux",maxInputTokens:112e3,maxOutputTokens:16e3,model:"openai/gpt-5-chat",capabilities:{toolCalling:!0,imageInput:!0}},{id:"google-gemini-2-5-flash",name:"Google: Gemini 2.5 Flash",tooltip:"Google: Gemini 2.5 Flash by Zenmux",maxInputTokens:1032576,maxOutputTokens:16e3,model:"google/gemini-2.5-flash",capabilities:{toolCalling:!0,imageInput:!0}},{id:"deepseek-deepseek-chat-v3-1",name:"DeepSeek: DeepSeek V3.1",tooltip:"DeepSeek: DeepSeek V3.1 by Zenmux",maxInputTokens:112e3,maxOutputTokens:16e3,model:"deepseek/deepseek-chat-v3.1",capabilities:{toolCalling:!0,imageInput:!1}},{id:"google-gemini-2-5-pro",name:"Google: Gemini 2.5 Pro",tooltip:"Google: Gemini 2.5 Pro by Zenmux",maxInputTokens:1032576,maxOutputTokens:16e3,model:"google/gemini-2.5-pro",capabilities:{toolCalling:!0,imageInput:!0}},{id:"google-gemini-2-0-flash",name:"Google: Gemini 2.0 Flash",tooltip:"Google: Gemini 2.0 Flash by Zenmux",maxInputTokens:1032576,maxOutputTokens:16e3,model:"google/gemini-2.0-flash",capabilities:{toolCalling:!0,imageInput:!0}},{id:"x-ai-grok-4",name:"xAI: Grok 4",tooltip:"xAI: Grok 4 by Zenmux",maxInputTokens:24e4,maxOutputTokens:16e3,model:"x-ai/grok-4",capabilities:{toolCalling:!0,imageInput:!0}},{id:"qwen-qwen3-235b-a22b-2507",name:"Qwen: Qwen3 235B A22B Instruct 2507",tooltip:"Qwen: Qwen3 235B A22B Instruct 2507 by Zenmux",maxInputTokens:24e4,maxOutputTokens:16e3,model:"qwen/qwen3-235b-a22b-2507",capabilities:{toolCalling:!0,imageInput:!1}},{id:"openai-gpt-4o-mini",name:"OpenAI: GPT-4o-mini",tooltip:"OpenAI: GPT-4o-mini by Zenmux",maxInputTokens:112e3,maxOutputTokens:16e3,model:"openai/gpt-4o-mini",capabilities:{toolCalling:!0,imageInput:!0}},{id:"qwen-qwen3-235b-a22b-thinking-2507",name:"Qwen: Qwen3 235B A22B Thinking 2507",tooltip:"Qwen: Qwen3 235B A22B Thinking 2507 by Zenmux",maxInputTokens:24e4,maxOutputTokens:16e3,model:"qwen/qwen3-235b-a22b-thinking-2507",capabilities:{toolCalling:!0,imageInput:!1}},{id:"qwen-qwen3-coder",name:"Qwen: Qwen3-Coder",tooltip:"Qwen: Qwen3-Coder by Zenmux",maxInputTokens:24e4,maxOutputTokens:16e3,model:"qwen/qwen3-coder",capabilities:{toolCalling:!0,imageInput:!1}},{id:"google-gemini-2-0-flash-lite-001",name:"Google: Gemini 2.0 Flash Lite",tooltip:"Google: Gemini 2.0 Flash Lite by Zenmux",maxInputTokens:1032576,maxOutputTokens:16e3,model:"google/gemini-2.0-flash-lite-001",capabilities:{toolCalling:!0,imageInput:!0}},{id:"z-ai-glm-4-5-air",name:"Z.AI: GLM 4.5 Air",tooltip:"Z.AI: GLM 4.5 Air by Zenmux",maxInputTokens:112e3,maxOutputTokens:16e3,model:"z-ai/glm-4.5-air",capabilities:{toolCalling:!0,imageInput:!1}},{id:"qwen-qwen3-coder-plus",name:"Qwen: Qwen3-Coder-Plus",tooltip:"Qwen: Qwen3-Coder-Plus by Zenmux",maxInputTokens:984e3,maxOutputTokens:16e3,model:"qwen/qwen3-coder-plus",capabilities:{toolCalling:!0,imageInput:!1}},{id:"deepseek-deepseek-chat",name:"DeepSeek: DeepSeek-V3.2 (Non-thinking Mode)",tooltip:"DeepSeek: DeepSeek-V3.2 (Non-thinking Mode) by Zenmux",maxInputTokens:112e3,maxOutputTokens:16e3,model:"deepseek/deepseek-chat",capabilities:{toolCalling:!0,imageInput:!1}},{id:"inclusionai-ring-mini-2-0",name:"inclusionAI: Ring-mini-2.0",tooltip:"inclusionAI: Ring-mini-2.0 by Zenmux",maxInputTokens:112e3,maxOutputTokens:16e3,model:"inclusionai/ring-mini-2.0",capabilities:{toolCalling:!0,imageInput:!1}},{id:"moonshotai-kimi-k2-0905",name:"MoonshotAI: Kimi K2 0905",tooltip:"MoonshotAI: Kimi K2 0905 by Zenmux",maxInputTokens:246100,maxOutputTokens:16e3,model:"moonshotai/kimi-k2-0905",capabilities:{toolCalling:!0,imageInput:!1}},{id:"inclusionai-ling-mini-2-0",name:"inclusionAI: Ling-mini-2.0",tooltip:"inclusionAI: Ling-mini-2.0 by Zenmux",maxInputTokens:112e3,maxOutputTokens:16e3,model:"inclusionai/ling-mini-2.0",capabilities:{toolCalling:!0,imageInput:!1}},{id:"z-ai-glm-4-5",name:"Z.AI: GLM 4.5",tooltip:"Z.AI: GLM 4.5 by Zenmux",maxInputTokens:112e3,maxOutputTokens:16e3,model:"z-ai/glm-4.5",capabilities:{toolCalling:!0,imageInput:!1}},{id:"moonshotai-kimi-k2-0711",name:"MoonshotAI: Kimi K2 0711",tooltip:"MoonshotAI: Kimi K2 0711 by Zenmux",maxInputTokens:112e3,maxOutputTokens:16e3,model:"moonshotai/kimi-k2-0711",capabilities:{toolCalling:!0,imageInput:!1}},{id:"inclusionai-ling-flash-2-0",name:"inclusionAI: Ling-flash-2.0",tooltip:"inclusionAI: Ling-flash-2.0 by Zenmux",maxInputTokens:112e3,maxOutputTokens:16e3,model:"inclusionai/ling-flash-2.0",capabilities:{toolCalling:!0,imageInput:!1}},{id:"inclusionai-ring-flash-2-0",name:"inclusionAI: Ring-flash-2.0",tooltip:"inclusionAI: Ring-flash-2.0 by Zenmux",maxInputTokens:112e3,maxOutputTokens:16e3,model:"inclusionai/ring-flash-2.0",capabilities:{toolCalling:!0,imageInput:!1}},{id:"x-ai-grok-code-fast-1",name:"xAI: Grok Code Fast 1",tooltip:"xAI: Grok Code Fast 1 by Zenmux",maxInputTokens:24e4,maxOutputTokens:16e3,model:"x-ai/grok-code-fast-1",capabilities:{toolCalling:!0,imageInput:!1}},{id:"x-ai-grok-4-fast",name:"xAI: Grok 4 Fast",tooltip:"xAI: Grok 4 Fast by Zenmux",maxInputTokens:1984e3,maxOutputTokens:16e3,model:"x-ai/grok-4-fast",capabilities:{toolCalling:!0,imageInput:!0}},{id:"x-ai-grok-4-fast-non-reasoning",name:"xAI: Grok 4 Fast None Reasoning",tooltip:"xAI: Grok 4 Fast None Reasoning by Zenmux",maxInputTokens:1984e3,maxOutputTokens:16e3,model:"x-ai/grok-4-fast-non-reasoning",capabilities:{toolCalling:!0,imageInput:!0}},{id:"qwen-qwen3-vl-plus",name:"Qwen: Qwen3-VL-Plus",tooltip:"Qwen: Qwen3-VL-Plus by Zenmux",maxInputTokens:246144,maxOutputTokens:16e3,model:"qwen/qwen3-vl-plus",capabilities:{toolCalling:!0,imageInput:!0}},{id:"qwen-qwen3-max",name:"Qwen: Qwen3-Max-Thinking",tooltip:"Qwen: Qwen3-Max-Thinking by Zenmux",maxInputTokens:24e4,maxOutputTokens:16e3,model:"qwen/qwen3-max",capabilities:{toolCalling:!0,imageInput:!1}},{id:"z-ai-glm-4-6",name:"Z.AI: GLM 4.6",tooltip:"Z.AI: GLM 4.6 by Zenmux",maxInputTokens:184e3,maxOutputTokens:16e3,model:"z-ai/glm-4.6",capabilities:{toolCalling:!0,imageInput:!1}},{id:"inclusionai-ling-1t",name:"inclusionAI: Ling-1T",tooltip:"inclusionAI: Ling-1T by Zenmux",maxInputTokens:112e3,maxOutputTokens:16e3,model:"inclusionai/ling-1t",capabilities:{toolCalling:!0,imageInput:!1}},{id:"inclusionai-ring-1t",name:"inclusionAI: Ring-1T",tooltip:"inclusionAI: Ring-1T by Zenmux",maxInputTokens:112e3,maxOutputTokens:16e3,model:"inclusionai/ring-1t",capabilities:{toolCalling:!0,imageInput:!1}},{id:"anthropic-claude-sonnet-4-5",name:"Anthropic: Claude Sonnet 4.5",tooltip:"Anthropic: Claude Sonnet 4.5 by Zenmux",maxInputTokens:984e3,maxOutputTokens:16e3,model:"anthropic/claude-sonnet-4.5",capabilities:{toolCalling:!0,imageInput:!0}},{id:"anthropic-claude-haiku-4-5",name:"Anthropic: Claude Haiku 4.5",tooltip:"Anthropic: Claude Haiku 4.5 by Zenmux",maxInputTokens:184e3,maxOutputTokens:16e3,model:"anthropic/claude-haiku-4.5",capabilities:{toolCalling:!0,imageInput:!0}},{id:"openai-gpt-5-pro",name:"OpenAI: GPT-5 Pro",tooltip:"OpenAI: GPT-5 Pro by Zenmux",maxInputTokens:384e3,maxOutputTokens:16e3,model:"openai/gpt-5-pro",capabilities:{toolCalling:!0,imageInput:!0}},{id:"openai-gpt-5-codex",name:"OpenAI: GPT-5 Codex",tooltip:"OpenAI: GPT-5 Codex by Zenmux",maxInputTokens:384e3,maxOutputTokens:16e3,model:"openai/gpt-5-codex",capabilities:{toolCalling:!0,imageInput:!0}},{id:"deepseek-deepseek-reasoner",name:"DeepSeek: DeepSeek-V3.2 (Thinking Mode)",tooltip:"DeepSeek: DeepSeek-V3.2 (Thinking Mode) by Zenmux",maxInputTokens:112e3,maxOutputTokens:16e3,model:"deepseek/deepseek-reasoner",capabilities:{toolCalling:!0,imageInput:!1}},{id:"kuaishou-kat-coder-pro-v1",name:"KwaiKAT: KAT-Coder-Pro-V1",tooltip:"KwaiKAT: KAT-Coder-Pro-V1 by Zenmux",maxInputTokens:24e4,maxOutputTokens:16e3,model:"kuaishou/kat-coder-pro-v1",capabilities:{toolCalling:!0,imageInput:!1}},{id:"minimax-minimax-m2",name:"MiniMax: MiniMax M2",tooltip:"MiniMax: MiniMax M2 by Zenmux",maxInputTokens:188800,maxOutputTokens:16e3,model:"minimax/minimax-m2",capabilities:{toolCalling:!0,imageInput:!1}},{id:"moonshotai-kimi-k2-thinking",name:"MoonshotAI: Kimi K2 Thinking",tooltip:"MoonshotAI: Kimi K2 Thinking by Zenmux",maxInputTokens:246144,maxOutputTokens:16e3,model:"moonshotai/kimi-k2-thinking",capabilities:{toolCalling:!0,imageInput:!1}},{id:"moonshotai-kimi-k2-thinking-turbo",name:"MoonshotAI: Kimi K2 Thinking Turbo",tooltip:"MoonshotAI: Kimi K2 Thinking Turbo by Zenmux",maxInputTokens:246144,maxOutputTokens:16e3,model:"moonshotai/kimi-k2-thinking-turbo",capabilities:{toolCalling:!0,imageInput:!1}},{id:"qwen-qwen3-max-preview",name:"Qwen: Qwen3 Max Thinking Preview",tooltip:"Qwen: Qwen3 Max Thinking Preview by Zenmux",maxInputTokens:246144,maxOutputTokens:16e3,model:"qwen/qwen3-max-preview",capabilities:{toolCalling:!0,imageInput:!1}},{id:"baidu-ernie-5-0-thinking-preview",name:"Baidu: ERNIE 5.0",tooltip:"Baidu: ERNIE 5.0 by Zenmux",maxInputTokens:112e3,maxOutputTokens:16e3,model:"baidu/ernie-5.0-thinking-preview",capabilities:{toolCalling:!0,imageInput:!0}},{id:"openai-gpt-5-1-codex",name:"OpenAI: GPT-5.1-Codex",tooltip:"OpenAI: GPT-5.1-Codex by Zenmux",maxInputTokens:384e3,maxOutputTokens:16e3,model:"openai/gpt-5.1-codex",capabilities:{toolCalling:!0,imageInput:!0}},{id:"openai-gpt-5-1-chat",name:"OpenAI: GPT-5.1 Chat",tooltip:"OpenAI: GPT-5.1 Chat by Zenmux",maxInputTokens:112e3,maxOutputTokens:16e3,model:"openai/gpt-5.1-chat",capabilities:{toolCalling:!0,imageInput:!0}},{id:"qwen-qwen3-14b",name:"Qwen: Qwen3 14B",tooltip:"Qwen: Qwen3 14B by Zenmux",maxInputTokens:16e3,maxOutputTokens:16e3,model:"qwen/qwen3-14b",capabilities:{toolCalling:!0,imageInput:!1}},{id:"openai-gpt-5-1-codex-mini",name:"OpenAI: GPT-5.1-Codex-Mini",tooltip:"OpenAI: GPT-5.1-Codex-Mini by Zenmux",maxInputTokens:384e3,maxOutputTokens:16e3,model:"openai/gpt-5.1-codex-mini",capabilities:{toolCalling:!0,imageInput:!0}},{id:"volcengine-doubao-seed-code",name:"VolcanoEngine: Doubao-Seed-Code",tooltip:"VolcanoEngine: Doubao-Seed-Code by Zenmux",maxInputTokens:24e4,maxOutputTokens:16e3,model:"volcengine/doubao-seed-code",capabilities:{toolCalling:!0,imageInput:!0}},{id:"openai-gpt-5-1",name:"OpenAI: GPT-5.1",tooltip:"OpenAI: GPT-5.1 by Zenmux",maxInputTokens:384e3,maxOutputTokens:16e3,model:"openai/gpt-5.1",capabilities:{toolCalling:!0,imageInput:!0}},{id:"x-ai-grok-4-1-fast",name:"xAI: Grok 4.1 Fast",tooltip:"xAI: Grok 4.1 Fast by Zenmux",maxInputTokens:1984e3,maxOutputTokens:16e3,model:"x-ai/grok-4.1-fast",capabilities:{toolCalling:!0,imageInput:!0}},{id:"x-ai-grok-4-1-fast-non-reasoning",name:"xAI: Grok 4.1 Fast Non Reasoning",tooltip:"xAI: Grok 4.1 Fast Non Reasoning by Zenmux",maxInputTokens:1984e3,maxOutputTokens:16e3,model:"x-ai/grok-4.1-fast-non-reasoning",capabilities:{toolCalling:!0,imageInput:!0}},{id:"google-gemini-3-pro-preview",name:"Google: Gemini 3 Pro Preview",tooltip:"Google: Gemini 3 Pro Preview by Zenmux",maxInputTokens:1032576,maxOutputTokens:16e3,model:"google/gemini-3-pro-preview",capabilities:{toolCalling:!0,imageInput:!0}},{id:"volcengine-doubao-seed-1-6-vision",name:"VolcanoEngine: Doubao-Seed-1.6-vision",tooltip:"VolcanoEngine: Doubao-Seed-1.6-vision by Zenmux",maxInputTokens:24e4,maxOutputTokens:16e3,model:"volcengine/doubao-seed-1-6-vision",capabilities:{toolCalling:!0,imageInput:!0}},{id:"google-gemma-3-12b-it",name:"Google: Gemma 3 12B",tooltip:"Google: Gemma 3 12B by Zenmux",maxInputTokens:112e3,maxOutputTokens:16e3,model:"google/gemma-3-12b-it",capabilities:{toolCalling:!0,imageInput:!0}},{id:"anthropic-claude-opus-4-5",name:"Anthropic: Claude Opus 4.5",tooltip:"Anthropic: Claude Opus 4.5 by Zenmux",maxInputTokens:184e3,maxOutputTokens:16e3,model:"anthropic/claude-opus-4.5",capabilities:{toolCalling:!0,imageInput:!0}},{id:"deepseek-deepseek-v3-2-exp",name:"DeepSeek: DeepSeek-V3.2-Exp",tooltip:"DeepSeek: DeepSeek-V3.2-Exp by Zenmux",maxInputTokens:147840,maxOutputTokens:16e3,model:"deepseek/deepseek-v3.2-exp",capabilities:{toolCalling:!0,imageInput:!1}},{id:"meta-llama-3-3-70b-instruct",name:"Meta: Llama 3.3 70B Instruct",tooltip:"Meta: Llama 3.3 70B Instruct by Zenmux",maxInputTokens:112e3,maxOutputTokens:16e3,model:"meta/llama-3.3-70b-instruct",capabilities:{toolCalling:!0,imageInput:!1}},{id:"mistralai-mistral-large-2512",name:"Mistral: Mistral Large 3",tooltip:"Mistral: Mistral Large 3 by Zenmux",maxInputTokens:24e4,maxOutputTokens:16e3,model:"mistralai/mistral-large-2512",capabilities:{toolCalling:!0,imageInput:!0}},{id:"meta-llama-4-scout-17b-16e-instruct",name:"Meta: Llama 4 Scout Instruct",tooltip:"Meta: Llama 4 Scout Instruct by Zenmux",maxInputTokens:115072,maxOutputTokens:16e3,model:"meta/llama-4-scout-17b-16e-instruct",capabilities:{toolCalling:!0,imageInput:!0}},{id:"baidu-ernie-x1-1-preview",name:"Baidu: ERNIE-X1.1-Preview",tooltip:"Baidu: ERNIE-X1.1-Preview by Zenmux",maxInputTokens:49536,maxOutputTokens:16e3,model:"baidu/ernie-x1.1-preview",capabilities:{toolCalling:!0,imageInput:!1}},{id:"z-ai-glm-4-6v-flash",name:"Z.AI: GLM 4.6V FlashX",tooltip:"Z.AI: GLM 4.6V FlashX by Zenmux",maxInputTokens:184e3,maxOutputTokens:16e3,model:"z-ai/glm-4.6v-flash",capabilities:{toolCalling:!0,imageInput:!0}},{id:"z-ai-glm-4-6v",name:"Z.AI: GLM 4.6V",tooltip:"Z.AI: GLM 4.6V by Zenmux",maxInputTokens:184e3,maxOutputTokens:16e3,model:"z-ai/glm-4.6v",capabilities:{toolCalling:!0,imageInput:!0}},{id:"deepseek-deepseek-v3-2",name:"DeepSeek: DeepSeek V3.2",tooltip:"DeepSeek: DeepSeek V3.2 by Zenmux",maxInputTokens:112e3,maxOutputTokens:16e3,model:"deepseek/deepseek-v3.2",capabilities:{toolCalling:!0,imageInput:!1}},{id:"openai-gpt-5-2-pro",name:"OpenAI: GPT-5.2 Pro",tooltip:"OpenAI: GPT-5.2 Pro by Zenmux",maxInputTokens:384e3,maxOutputTokens:16e3,model:"openai/gpt-5.2-pro",capabilities:{toolCalling:!0,imageInput:!0}},{id:"openai-gpt-5-2",name:"OpenAI: GPT-5.2",tooltip:"OpenAI: GPT-5.2 by Zenmux",maxInputTokens:384e3,maxOutputTokens:16e3,model:"openai/gpt-5.2",capabilities:{toolCalling:!0,imageInput:!0}},{id:"openai-gpt-5-2-chat",name:"OpenAI: GPT-5.2 Chat",tooltip:"OpenAI: GPT-5.2 Chat by Zenmux",maxInputTokens:112e3,maxOutputTokens:16e3,model:"openai/gpt-5.2-chat",capabilities:{toolCalling:!0,imageInput:!0}},{id:"google-gemini-3-flash-preview",name:"Google: Gemini 3 Flash Preview",tooltip:"Google: Gemini 3 Flash Preview by Zenmux",maxInputTokens:1032576,maxOutputTokens:16e3,model:"google/gemini-3-flash-preview",capabilities:{toolCalling:!0,imageInput:!0}},{id:"stepfun-step-3",name:"StepFun: Step-3",tooltip:"StepFun: Step-3 by Zenmux",maxInputTokens:49536,maxOutputTokens:16e3,model:"stepfun/step-3",capabilities:{toolCalling:!0,imageInput:!0}},{id:"inclusionai-llada2-0-flash-cap",name:"inclusionAI: LLaDA2-flash-CAP",tooltip:"inclusionAI: LLaDA2-flash-CAP by Zenmux",maxInputTokens:16e3,maxOutputTokens:16e3,model:"inclusionai/llada2.0-flash-cap",capabilities:{toolCalling:!0,imageInput:!1}},{id:"openai-gpt-5-2-codex",name:"OpenAI: GPT-5.2-Codex",tooltip:"OpenAI: GPT-5.2-Codex by Zenmux",maxInputTokens:384e3,maxOutputTokens:16e3,model:"openai/gpt-5.2-codex",capabilities:{toolCalling:!0,imageInput:!0}},{id:"xiaomi-mimo-v2-flash",name:"Xiaomi: MiMo-V2-Flash",tooltip:"Xiaomi: MiMo-V2-Flash by Zenmux",maxInputTokens:246144,maxOutputTokens:16e3,model:"xiaomi/mimo-v2-flash",capabilities:{toolCalling:!0,imageInput:!1}},{id:"volcengine-doubao-seed-1-8",name:"VolcanoEngine: Doubao-Seed-1.8",tooltip:"VolcanoEngine: Doubao-Seed-1.8 by Zenmux",maxInputTokens:24e4,maxOutputTokens:16e3,model:"volcengine/doubao-seed-1.8",capabilities:{toolCalling:!0,imageInput:!0}},{id:"minimax-minimax-m2-1",name:"MiniMax: MiniMax M2.1",tooltip:"MiniMax: MiniMax M2.1 by Zenmux",maxInputTokens:188800,maxOutputTokens:16e3,model:"minimax/minimax-m2.1",capabilities:{toolCalling:!0,imageInput:!1}},{id:"z-ai-glm-4-7",name:"Z.AI: GLM 4.7",tooltip:"Z.AI: GLM 4.7 by Zenmux",maxInputTokens:184e3,maxOutputTokens:16e3,model:"z-ai/glm-4.7",capabilities:{toolCalling:!0,imageInput:!1}},{id:"z-ai-glm-4-7-flash-free",name:"Z.AI: GLM 4.7 Flash (Free)",tooltip:"Z.AI: GLM 4.7 Flash (Free) by Zenmux",maxInputTokens:184e3,maxOutputTokens:16e3,model:"z-ai/glm-4.7-flash-free",capabilities:{toolCalling:!0,imageInput:!1}},{id:"z-ai-glm-4-7-flashx",name:"Z.AI: GLM 4.7 FlashX",tooltip:"Z.AI: GLM 4.7 FlashX by Zenmux",maxInputTokens:184e3,maxOutputTokens:16e3,model:"z-ai/glm-4.7-flashx",capabilities:{toolCalling:!0,imageInput:!1}},{id:"minimax-minimax-m2-her",name:"MiniMax: MiniMax M2-her",tooltip:"MiniMax: MiniMax M2-her by Zenmux",maxInputTokens:48e3,maxOutputTokens:16e3,model:"minimax/minimax-m2-her",capabilities:{toolCalling:!0,imageInput:!1}},{id:"moonshotai-kimi-k2-5",name:"MoonshotAI: Kimi K2.5",tooltip:"MoonshotAI: Kimi K2.5 by Zenmux",maxInputTokens:246144,maxOutputTokens:16e3,model:"moonshotai/kimi-k2.5",capabilities:{toolCalling:!0,imageInput:!0}},{id:"anthropic-claude-opus-4-6",name:"Anthropic: Claude Opus 4.6",tooltip:"Anthropic: Claude Opus 4.6 by Zenmux",maxInputTokens:984e3,maxOutputTokens:16e3,model:"anthropic/claude-opus-4.6",capabilities:{toolCalling:!0,imageInput:!0}},{id:"tencent-hunyuan-2-0-thinking",name:"Tencent: HY 2.0 Think",tooltip:"Tencent: HY 2.0 Think by Zenmux",maxInputTokens:112e3,maxOutputTokens:16e3,model:"tencent/hunyuan-2.0-thinking",capabilities:{toolCalling:!0,imageInput:!1}},{id:"stepfun-step-3-5-flash-free",name:"StepFun: Step 3.5 Flash (Free)",tooltip:"StepFun: Step 3.5 Flash (Free) by Zenmux",maxInputTokens:24e4,maxOutputTokens:16e3,model:"stepfun/step-3.5-flash-free",capabilities:{toolCalling:!0,imageInput:!1}},{id:"stepfun-step-3-5-flash",name:"StepFun: Step 3.5 Flash",tooltip:"StepFun: Step 3.5 Flash by Zenmux",maxInputTokens:24e4,maxOutputTokens:16e3,model:"stepfun/step-3.5-flash",capabilities:{toolCalling:!0,imageInput:!1}},{id:"z-ai-glm-5",name:"Z.AI: GLM 5",tooltip:"Z.AI: GLM 5 by Zenmux",maxInputTokens:184e3,maxOutputTokens:16e3,model:"z-ai/glm-5",capabilities:{toolCalling:!0,imageInput:!1}},{id:"inclusionai-ming-flash-omni-2-0",name:"inclusionAI: Ming-flash-omni-2.0",tooltip:"inclusionAI: Ming-flash-omni-2.0 by Zenmux",maxInputTokens:48e3,maxOutputTokens:16e3,model:"inclusionai/ming-flash-omni-2.0",capabilities:{toolCalling:!0,imageInput:!0}},{id:"minimax-minimax-m2-5",name:"MiniMax: MiniMax M2.5",tooltip:"MiniMax: MiniMax M2.5 by Zenmux",maxInputTokens:188800,maxOutputTokens:16e3,model:"minimax/minimax-m2.5",capabilities:{toolCalling:!0,imageInput:!1}},{id:"minimax-minimax-m2-5-lightning",name:"MiniMax: MiniMax M2.5 highspeed",tooltip:"MiniMax: MiniMax M2.5 highspeed by Zenmux",maxInputTokens:188800,maxOutputTokens:16e3,model:"minimax/minimax-m2.5-lightning",capabilities:{toolCalling:!0,imageInput:!1}}]}});var Vx,Gx=ke(()=>{Vx={displayName:"ZhipuAI",baseUrl:"https://api.z.ai/api/paas/v4",apiKeyTemplate:"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx.xxxxxxxxxxxxxxxx",models:[{id:"glm-4.5",name:"GLM-4.5",tooltip:"glm-4.5 by ZhipuAI",maxInputTokens:1e5,maxOutputTokens:28e3,model:"glm-4.5",sdkMode:"openai",baseUrl:"https://api.z.ai/api/paas/v4",capabilities:{toolCalling:!0,imageInput:!1}},{id:"glm-4.5-air",name:"GLM-4.5-Air",tooltip:"glm-4.5-air by ZhipuAI",maxInputTokens:1e5,maxOutputTokens:28e3,model:"glm-4.5-air",sdkMode:"openai",baseUrl:"https://api.z.ai/api/paas/v4",capabilities:{toolCalling:!0,imageInput:!1}},{id:"glm-4.6",name:"GLM-4.6",tooltip:"glm-4.6 by ZhipuAI",maxInputTokens:186e3,maxOutputTokens:16752,model:"glm-4.6",sdkMode:"openai",baseUrl:"https://api.z.ai/api/paas/v4",capabilities:{toolCalling:!0,imageInput:!1}},{id:"glm-4.7",name:"GLM-4.7",tooltip:"glm-4.7 by ZhipuAI",maxInputTokens:186e3,maxOutputTokens:16752,model:"glm-4.7",sdkMode:"openai",baseUrl:"https://api.z.ai/api/paas/v4",capabilities:{toolCalling:!0,imageInput:!1}},{id:"glm-5",name:"GLM-5 (Latest)",tooltip:"glm-5 by ZhipuAI",maxInputTokens:186e3,maxOutputTokens:16752,model:"glm-5",sdkMode:"openai",baseUrl:"https://api.z.ai/api/paas/v4",capabilities:{toolCalling:!0,imageInput:!1}},{id:"glm-4.7-flash",name:"GLM-4.7-Flash (Free, 1 Concurrent)",tooltip:"glm-4.7-flash by ZhipuAI",maxInputTokens:186e3,maxOutputTokens:16752,model:"glm-4.7-flash",sdkMode:"openai",baseUrl:"https://api.z.ai/api/paas/v4",capabilities:{toolCalling:!0,imageInput:!1}},{id:"glm-4.7-flashx",name:"GLM-4.7-FlashX (Paid)",tooltip:"glm-4.7-flashx by ZhipuAI",maxInputTokens:186e3,maxOutputTokens:16752,model:"glm-4.7-flashx",sdkMode:"openai",baseUrl:"https://api.z.ai/api/paas/v4",capabilities:{toolCalling:!0,imageInput:!1}}]}});var $m={};io($m,{configProviders:()=>vt});var mM,vt,ao=ke(()=>{"use strict";vx();xx();wx();_x();Tx();Ax();Mx();$x();Rx();Lx();zx();qx();Bx();jx();Hx();Gx();mM={zhipu:Vx,minimax:Ox,moonshot:Dx,deepseek:Ix,codex:kx,antigravity:yx,chutes:bx,opencode:Fx,ollama:Ux,qwencli:Kx,geminicli:Px,huggingface:Sx,lightningai:Ex,deepinfra:Cx,mistral:Nx,zenmux:Zx},vt=mM});var Qx={};io(Qx,{ApiKeyManager:()=>R});var ta,R,Ke=ke(()=>{"use strict";ta=D(require("vscode"));ce();R=class n{static context;static builtinProviders=null;static initialize(e){n.context=e}static async getBuiltinProviders(){if(n.builtinProviders!==null)return n.builtinProviders;try{let{configProviders:e}=await Promise.resolve().then(()=>(ao(),$m));n.builtinProviders=new Set(Object.keys(e))}catch(e){u.warn("Failed to get built-in provider list:",e),n.builtinProviders=new Set}return n.builtinProviders}static getSecretKey(e){return`${e}.apiKey`}static async hasValidApiKey(e){let t=n.getSecretKey(e),o=await n.context.secrets.get(t);return o!==void 0&&o.trim().length>0}static async getApiKey(e){let t=n.getSecretKey(e);return await n.context.secrets.get(t)}static validateApiKey(e,t){return!e||e.trim().length===0?{isValid:!0,isEmpty:!0}:{isValid:!0}}static async setApiKey(e,t){let o=n.getSecretKey(e);await n.context.secrets.store(o,t)}static async deleteApiKey(e){let t=n.getSecretKey(e);await n.context.secrets.delete(t)}static async ensureApiKey(e,t,o=!0){if(await n.hasValidApiKey(e))return!0;if((await n.getBuiltinProviders()).has(e)){let a=`chp.${e}.setApiKey`;await ta.commands.executeCommand(a)}else await n.promptAndSetApiKey(e,e,"sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx");let i=await n.hasValidApiKey(e);if(!i&&o)throw new Error(`API key required to use ${t} model`);return i}static processCustomHeader(e,t){if(!e)return{};let o={};for(let[r,i]of Object.entries(e)){let a=i.replace(/\$\{\s*APIKEY\s*\}/gi,t);o[r]=a}return o}static async promptAndSetApiKey(e,t,o){let r=await ta.window.showInputBox({prompt:`Please enter your ${t} API key (leave empty to clear key)`,password:!0,placeHolder:o});r!==void 0&&(n.validateApiKey(r,e).isEmpty?(await n.deleteApiKey(e),ta.window.showInformationMessage(`${t} API key cleared`)):(await n.setApiKey(e,r.trim()),ta.window.showInformationMessage(`${t} API key set`)),u.debug(`API key updated: ${e}`))}}});var Em,L,ot=ke(()=>{"use strict";Em=D(require("vscode"));ao();ce();L=class n{static CONFIG_SECTION="chp";static cache=null;static configListener=null;static initialize(){return n.configListener&&n.configListener.dispose(),n.configListener=Em.workspace.onDidChangeConfiguration(e=>{e.affectsConfiguration(n.CONFIG_SECTION)&&(n.cache=null,u.info("Copilot ++ updated, cache cleared"))}),u.debug("Configuration manager initialized"),n.configListener}static getConfig(){if(n.cache)return n.cache;let e=Em.workspace.getConfiguration(n.CONFIG_SECTION),t=n.buildProviderOverrides(e);return n.cache={temperature:n.validateTemperature(e.get("temperature",.1)),topP:n.validateTopP(e.get("topP",1)),maxTokens:n.validateMaxTokens(e.get("maxTokens",256e3)),rememberLastModel:e.get("rememberLastModel",!0),zhipu:{search:{enableMCP:e.get("zhipu.search.enableMCP",!0)},endpoint:e.get("zhipu.endpoint","open.bigmodel.cn"),plan:e.get("zhipu.plan","coding"),thinking:e.get("zhipu.thinking","auto"),clearThinking:e.get("zhipu.clearThinking",!0)},minimax:{endpoint:e.get("minimax.endpoint","minimaxi.com")},fimCompletion:{enabled:e.get("fimCompletion.enabled",!1),debounceMs:n.validateNESDebounceMs(e.get("fimCompletion.debounceMs",500)),timeoutMs:n.validateNESTimeoutMs(e.get("fimCompletion.timeoutMs",5e3)),modelConfig:{provider:e.get("fimCompletion.modelConfig.provider",""),baseUrl:e.get("fimCompletion.modelConfig.baseUrl",""),model:e.get("fimCompletion.modelConfig.model",""),maxTokens:n.validateNESMaxTokens(e.get("fimCompletion.modelConfig.maxTokens",200)),extraBody:e.get("fimCompletion.modelConfig.extraBody")}},nesCompletion:{enabled:e.get("nesCompletion.enabled",!1),debounceMs:n.validateNESDebounceMs(e.get("nesCompletion.debounceMs",500)),timeoutMs:n.validateNESTimeoutMs(e.get("nesCompletion.timeoutMs",5e3)),manualOnly:e.get("nesCompletion.manualOnly",!1),modelConfig:{provider:e.get("nesCompletion.modelConfig.provider",""),baseUrl:e.get("nesCompletion.modelConfig.baseUrl",""),model:e.get("nesCompletion.modelConfig.model",""),maxTokens:n.validateNESMaxTokens(e.get("nesCompletion.modelConfig.maxTokens",200)),extraBody:e.get("nesCompletion.modelConfig.extraBody")}},providerOverrides:t},u.debug("Configuration loaded",n.cache),n.cache}static getTemperature(){return n.getConfig().temperature}static getTopP(){return n.getConfig().topP}static getMaxTokens(){return n.getConfig().maxTokens}static getRememberLastModel(){return n.getConfig().rememberLastModel}static getZhipuSearchConfig(){return n.getConfig().zhipu.search}static getZhipuConfig(){return n.getConfig().zhipu}static getZhipuEndpoint(){return n.getConfig().zhipu.endpoint}static getZhipuPlan(){return n.getConfig().zhipu.plan}static getZhipuThinking(){return n.getConfig().zhipu.thinking}static getZhipuClearThinking(){return n.getConfig().zhipu.clearThinking}static getMinimaxEndpoint(){return n.getConfig().minimax.endpoint}static getFIMConfig(){return n.getConfig().fimCompletion}static getNESConfig(){return n.getConfig().nesCompletion}static getMaxTokensForModel(e){let t=n.getMaxTokens();return Math.min(e,t)}static validateTemperature(e){return Number.isNaN(e)||e<0||e>2?(u.warn(`Invalid temperature value: ${e}, using default value 0.1`),.1):e}static validateTopP(e){return Number.isNaN(e)||e<0||e>1?(u.warn(`Invalid topP value: ${e}, using default value 1.0`),1):e}static validateMaxTokens(e){return Number.isNaN(e)||e<32||e>256e3?(u.warn(`Invalid maxTokens value: ${e}, using default value 8192`),8192):Math.floor(e)}static validateNESDebounceMs(e){return Number.isNaN(e)||e<50||e>2e3?(u.warn(`Invalid debounceMs value: ${e}, using default value 500`),500):Math.floor(e)}static validateNESTimeoutMs(e){return Number.isNaN(e)||e<1e3||e>3e4?(u.warn(`Invalid timeoutMs value: ${e}, using default value 5000`),5e3):Math.floor(e)}static validateNESMaxTokens(e){return Number.isNaN(e)||e<50||e>16e3?(u.warn(`Invalid NES maxTokens value: ${e}, using default value 200`),200):Math.floor(e)}static getConfigProvider(){return vt}static getProviderOverrides(){return n.getConfig().providerOverrides}static buildProviderOverrides(e){let t=e.get("providerOverrides",{}),o={};for(let i of Object.keys(vt)){let a=e.get(`${i}.baseUrl`,"").trim();a&&(o[i]={baseUrl:a})}let r={...o};for(let[i,a]of Object.entries(t)){let s=r[i]?{...r[i]}:{},c=a.baseUrl?.trim(),l={...s,...a};!c&&s.baseUrl&&(l.baseUrl=s.baseUrl),r[i]=l}return r}static applyProviderOverrides(e,t){let r=n.getProviderOverrides()[e];if(!r)return t;u.info(`Applying provider ${e} configuration override`);let i=JSON.parse(JSON.stringify(t));if(r.baseUrl){i.baseUrl=r.baseUrl,u.debug(`  Override baseUrl: ${r.baseUrl}`);for(let a of i.models)a.baseUrl=r.baseUrl}if(r.customHeader)for(let a of i.models)a.customHeader={...r.customHeader,...a.customHeader};if(r.models&&r.models.length>0)for(let a of r.models){let s=i.models.findIndex(c=>c.id===a.id);if(s>=0){let c=i.models[s];a.model!==void 0&&(c.model=a.model,u.debug(`  Model ${a.id}: Override model = ${a.model}`)),a.maxInputTokens!==void 0&&(c.maxInputTokens=a.maxInputTokens,u.debug(`  Model ${a.id}: Override maxInputTokens = ${a.maxInputTokens}`)),a.maxOutputTokens!==void 0&&(c.maxOutputTokens=a.maxOutputTokens,u.debug(`  Model ${a.id}: Override maxOutputTokens = ${a.maxOutputTokens}`)),a.sdkMode!==void 0&&(c.sdkMode=a.sdkMode,u.debug(`  Model ${a.id}: Override sdkMode = ${a.sdkMode}`)),a.baseUrl!==void 0&&(c.baseUrl=a.baseUrl,u.debug(`  Model ${a.id}: Override baseUrl = ${a.baseUrl}`)),a.capabilities&&(c.capabilities={...c.capabilities,...a.capabilities},u.debug(`  Model ${a.id}: Merge capabilities = ${JSON.stringify(c.capabilities)}`)),a.customHeader&&(c.customHeader={...c.customHeader,...a.customHeader},u.debug(`  Model ${a.id}: Merge customHeader = ${JSON.stringify(c.customHeader)}`)),a.extraBody&&(c.extraBody={...c.extraBody,...a.extraBody},u.debug(`  Model ${a.id}: Merge extraBody = ${JSON.stringify(c.extraBody)}`)),a.outputThinking!==void 0&&(c.outputThinking=a.outputThinking,u.debug(`  Model ${a.id}: Override outputThinking = ${a.outputThinking}`))}else{let c=a,l={id:a.id,name:c?.name||a.id,tooltip:c?.tooltip||`User custom model: ${a.id}`,maxInputTokens:a.maxInputTokens||128e3,maxOutputTokens:a.maxOutputTokens||8192,capabilities:{toolCalling:a.capabilities?.toolCalling??!1,imageInput:a.capabilities?.imageInput??!1},...a.model&&{model:a.model},...a.sdkMode&&{sdkMode:a.sdkMode},...a.baseUrl&&{baseUrl:a.baseUrl},...r.baseUrl&&!a.baseUrl&&{baseUrl:r.baseUrl},...a.customHeader&&{customHeader:a.customHeader},...r.customHeader&&!a.customHeader&&{customHeader:r.customHeader},...a.extraBody&&{extraBody:a.extraBody},...a.outputThinking!==void 0&&{outputThinking:a.outputThinking}};i.models.push(l),u.info(`  Add new model: ${a.id}`)}}if(r.customHeader){for(let a of i.models)a.customHeader?a.customHeader={...r.customHeader,...a.customHeader}:a.customHeader={...r.customHeader};u.debug(`  Provider ${e}: Merge provider level customHeader into all models`)}return i}static dispose(){n.configListener&&(n.configListener.dispose(),n.configListener=null),n.cache=null,u.trace("Configuration manager disposed")}}});var bn,ac=ke(()=>{"use strict";bn={aihubmix:{displayName:"AIHubMix",customHeader:{"APP-Code":"TFUV4759"},openai:{baseUrl:"https://aihubmix.com/v1"},anthropic:{baseUrl:"https://aihubmix.com",extraBody:{top_p:null}}},aiping:{displayName:"AIPing"},codex:{displayName:"Codex"},modelscope:{displayName:"ModelScope"},openrouter:{displayName:"OpenRouter"},siliconflow:{displayName:"SiliconFlow"},tbox:{displayName:"Bailian"},chutes:{displayName:"Chutes"},opencode:{displayName:"OpenCode"},huggingface:{displayName:"Hugging Face"},lightningai:{displayName:"Lightning AI",openai:{baseUrl:"https://lightning.ai/api/v1"}},zenmux:{displayName:"Zenmux",openai:{baseUrl:"https://zenmux.ai/api/v1"}},deepinfra:{displayName:"DeepInfra",openai:{baseUrl:"https://api.deepinfra.com/v1/openai"}},mistral:{displayName:"Mistral AI",openai:{baseUrl:"https://api.mistral.ai/v1"}},qwencli:{displayName:"Qwen Code CLI"}}});var Wx,Jx=ke(()=>{Wx=`body {
	font-family: var(--vscode-font-family);
	font-size: var(--vscode-font-size);
	color: var(--vscode-foreground);
	background-color: var(--vscode-editor-background);
	padding: 15px 15px 60px 15px;
	line-height: 1.4;
	margin: 0;
}

.container {
	max-width: 680px;
	margin: 20px auto 80px;
}

.form-group {
	margin-bottom: 15px;
}

.form-group.no-bottom {
	margin-bottom: 0;
}

label {
	display: block;
	margin-bottom: 3px;
	font-weight: 500;
	color: var(--vscode-foreground);
	font-size: 1em;
}

.field-name {
	font-weight: normal;
	color: var(--vscode-descriptionForeground);
	font-size: 1em;
	margin-left: 4px;
}

input,
select,
textarea {
	width: 100%;
	padding: 6px 8px;
	border: 1px solid var(--vscode-input-border);
	background-color: var(--vscode-input-background);
	color: var(--vscode-input-foreground);
	border-radius: 3px;
	font-family: var(--vscode-font-family);
	font-size: 1em;
	box-sizing: border-box;
}

input.invalid,
select.invalid,
textarea.invalid {
	border-color: var(--vscode-inputValidation-errorBorder);
}

input[list] {
	background-color: var(--vscode-input-background);
	color: var(--vscode-input-foreground);
}

input:focus,
select:focus,
textarea:focus {
	outline: none;
	border-color: var(--vscode-focusBorder);
}

textarea {
	resize: none;
	min-height: 60px;
	font-family: monospace;
	overflow: hidden;
	box-sizing: border-box;
}

.checkbox-group {
	display: flex;
	align-items: center;
	gap: 8px;
	margin: 0;
}

input[type="checkbox"] {
	width: auto;
	margin: 0;
}

.button-group {
	position: fixed;
	bottom: 0;
	left: 0;
	right: 0;
	margin: 0;
	padding: 10px 15px;
	border-top: 1px solid var(--vscode-panel-border);
	background-color: var(--vscode-editor-background);
	z-index: 100;
}

.button-group-inner {
	max-width: 650px;
	margin: 0 auto;
	width: 100%;
	display: flex;
	gap: 10px;
	justify-content: space-between;
}

button {
	padding: 8px 16px;
	border: none;
	border-radius: 3px;
	cursor: pointer;
	font-size: 1.1em;
	min-width: 80px;
}

.primary-button {
	background-color: var(--vscode-button-background);
	color: var(--vscode-button-foreground);
}

.primary-button:hover {
	background-color: var(--vscode-button-hoverBackground);
}

.secondary-button {
	background-color: var(--vscode-button-secondaryBackground);
	color: var(--vscode-button-secondaryForeground);
}

.secondary-button:hover {
	background-color: var(--vscode-button-secondaryHoverBackground);
}

.delete-button {
	background-color: var(--vscode-inputValidation-errorBackground);
	color: var(--vscode-inputValidation-errorForeground);
}

.delete-button:hover {
	opacity: 0.8;
}

.section {
	margin-bottom: 15px;
	padding: 12px;
	border: 1px solid var(--vscode-panel-border);
	border-radius: 4px;
}

.section h3 {
	margin: 0 0 10px 0;
	color: var(--vscode-foreground);
	font-size: 1.2em;
	font-weight: 600;
}

.help-text {
	font-size: 1em;
	color: var(--vscode-descriptionForeground);
	margin-top: 2px;
}

.help-text.detailed {
	white-space: pre-wrap;
	word-wrap: break-word;
}

.readonly {
	background-color: var(--vscode-inputValidation-infoBackground);
	color: var(--vscode-inputValidation-infoForeground);
}

.json-input {
	font-family: monospace;
	font-size: 1em;
	min-height: 80px;
	padding: 8px;
	background-color: var(--vscode-editor-background);
	border: 2px solid var(--vscode-input-border);
	line-height: 1.5;
	tab-size: 2;
	resize: none;
	overflow: hidden;
	box-sizing: border-box;
}

.json-input:focus {
	border-color: var(--vscode-focusBorder);
}

.json-input.json-invalid {
	border-color: var(--vscode-inputValidation-errorBorder);
}

.json-container {
	position: relative;
}

.json-toolbar {
	display: flex;
	gap: 8px;
	margin-bottom: 6px;
	align-items: center;
}

.json-button {
	padding: 4px 10px;
	font-size: 1em;
	border: 1px solid var(--vscode-button-border);
	border-radius: 2px;
	background-color: var(--vscode-button-secondaryBackground);
	color: var(--vscode-button-secondaryForeground);
	cursor: pointer;
	transition: background-color 0.2s;
}

.json-button:hover {
	background-color: var(--vscode-button-secondaryHoverBackground);
}

.json-status {
	display: flex;
	align-items: center;
	gap: 6px;
	font-size: 1em;
	height: 16px;
}

.json-status-indicator {
	display: inline-block;
	width: 8px;
	height: 8px;
	border-radius: 50%;
	background-color: var(--vscode-descriptionForeground);
}

.json-status-indicator.invalid {
	background-color: var(--vscode-inputValidation-errorForeground);
}

.json-error {
	color: var(--vscode-testing-failed-foreground);
	font-size: 1em;
	margin-top: 2px;
	display: none;
}

.json-error.show {
	display: block;
}

.provider-dropdown {
	position: relative;
}

.provider-input {
	position: relative;
	z-index: 10;
}

.provider-list {
	position: absolute;
	top: 100%;
	left: 0;
	right: 0;
	background-color: var(--vscode-input-background);
	border: 1px solid var(--vscode-input-border);
	border-top: none;
	border-radius: 0 0 3px 3px;
	max-height: 200px;
	overflow-y: auto;
	box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
	display: none;
	z-index: 1000;
	margin-top: -1px;
}

.provider-list.show {
	display: block;
}

.provider-list-item {
	padding: 6px 8px;
	cursor: pointer;
	color: var(--vscode-input-foreground);
	user-select: none;
}

.provider-list-item:hover {
	background-color: var(--vscode-list-hoverBackground);
}

.provider-list-item.selected {
	background-color: var(--vscode-list-activeSelectionBackground);
	color: var(--vscode-list-activeSelectionForeground);
}

/* Global error banner styles */
.error-banner {
	display: none;
	position: sticky;
	top: 0;
	left: 0;
	right: 0;
	padding: 12px 16px;
	background-color: var(--vscode-inputValidation-errorBackground);
	color: var(--vscode-inputValidation-errorForeground);
	border: 1px solid var(--vscode-inputValidation-errorBorder);
	border-radius: 4px;
	margin-bottom: 16px;
	align-items: center;
	justify-content: space-between;
	gap: 12px;
	z-index: 200;
	box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
	animation: slideDown 0.3s ease-out;
}

@keyframes slideDown {
	from {
		opacity: 0;
		transform: translateY(-10px);
	}

	to {
		opacity: 1;
		transform: translateY(0);
	}
}

.error-banner span {
	flex: 1;
	white-space: pre-wrap;
	word-wrap: break-word;
	font-size: 1em;
	line-height: 1.5;
}

.error-banner-close {
	background: transparent;
	color: var(--vscode-inputValidation-errorForeground);
	border: 1px solid var(--vscode-inputValidation-errorBorder);
	border-radius: 3px;
	padding: 4px 10px;
	font-size: 1.2em;
	cursor: pointer;
	min-width: auto;
	line-height: 1;
	flex-shrink: 0;
}

.error-banner-close:hover {
	background-color: rgba(255, 255, 255, 0.1);
}
`});var Xx,Yx=ke(()=>{Xx=`\uFEFF/**
 * Model Editor - Client Script
 * Responsible for DOM creation, event binding and communication with VSCode
 */

// VSCode API
const vscode = acquireVsCodeApi();

// Type definitions
/**
 * @typedef {Object} Provider
 * @property {string} id - Provider ID
 * @property {string} name - Provider Name
 */

/**
 * @typedef {Object} ModelCapabilities
 * @property {boolean} toolCalling - Whether tool calling is supported
 * @property {boolean} imageInput - Whether image input is supported
 */

/**
 * @typedef {Object} ModelData
 * @property {string} id - Model ID
 * @property {string} name - Display Name
 * @property {string} [tooltip] - Description (optional)
 * @property {string} provider - Provider identifier
 * @property {string} [baseUrl] - API base URL (optional)
 * @property {string} [model] - Request model ID (optional)
 * @property {'openai'|'openai-sse'|'anthropic'} sdkMode - SDK compatibility mode
 * @property {number} maxInputTokens - Maximum input tokens
 * @property {number} maxOutputTokens - Maximum output tokens
 * @property {ModelCapabilities} capabilities - Capability configuration
 * @property {boolean} outputThinking - Whether to show thinking process in chat interface (recommended for thinking models)
 * @property {boolean} includeThinking - Whether to inject thinking content into context for multi-turn conversations (required for thinking models)
 * @property {Object} [customHeader] - Custom HTTP header (optional)
 * @property {Object} [extraBody] - Extra request body parameters (optional)
 */

// Global variables
/** @type {Provider[]} */
let allProviders = [];
/** @type {ModelData} */
let modelData = {};
/** @type {boolean} */
let isCreateMode = false;

/**
 * Initialize editor
 * @param {ModelData} data - Model data
 * @param {boolean} createMode - Whether it is in creation mode
 * @returns {void}
 */
function _initializeEditor(data, createMode) {
	modelData = data;
	isCreateMode = createMode;

	// Create DOM
	createDOM();

	// Bind events
	bindEvents();

	// Request providers list
	vscode.postMessage({ command: "getProviders" });

	// Initialize JSON validation
	validateJSON_UI("customHeader");
	validateJSON_UI("extraBody");
}

/**
 * Create DOM structure
 * @returns {void}
 */
function createDOM() {
	const container = document.getElementById("app");

	// Create basic information section
	const basicSection = createSection("Basic Information", [
		createFormGroup(
			"modelId",
			\`Model ID\${isCreateMode ? " *" : ""}\`,
			"id",
			"input",
			{
				type: "text",
				placeholder: "Example: zhipu:glm-4.6",
				value: modelData.id,
				readonly: !isCreateMode,
			},
			isCreateMode
				? "Unique model identifier, cannot be changed after creation"
				: "Unique model identifier, cannot be changed, please edit config file directly if modification needed.",
		),
		createFormGroup(
			"modelName",
			"Display Name *",
			"name",
			"input",
			{
				type: "text",
				placeholder: "Example: GLM-4.6 (Zhipu AI)",
				value: modelData.name,
			},
			"Name displayed in model selector",
		),
		createFormGroup(
			"modelTooltip",
			"Description",
			"tooltip",
			"textarea",
			{
				rows: 2,
				placeholder: "Detailed model description (optional)",
				value: modelData.tooltip,
			},
			"Tooltip displayed on hover",
		),
		createFormGroup(
			"requestModel",
			"Request Model ID",
			"model",
			"input",
			{
				type: "text",
				placeholder: "Example: gpt-4",
				value: modelData.model,
			},
			"Model ID used when making requests (optional), uses Model ID (id) value if left empty",
		),
	]);

	// Create API configuration section
	const apiSection = createSection("API Configuration", [
		createProviderFormGroup(),
		createFormGroup(
			"sdkMode",
			"SDK Mode",
			"sdkMode",
			"select",
			{
				options: [
					{
						value: "openai",
						label:
							"OpenAI SDK (use official SDK for streaming data processing)",
						selected: modelData.sdkMode === "openai",
					},
					{
						value: "openai-sse",
						label:
							"OpenAI SSE (use built-in compatible parser for streaming data processing)",
						selected: modelData.sdkMode === "openai-sse",
					},
					{
						value: "anthropic",
						label:
							"Anthropic SDK (use official SDK for streaming data processing)",
						selected: modelData.sdkMode === "anthropic",
					},
				],
			},
			"Compatibility mode used for model communication",
		),
		createFormGroup(
			"baseUrl",
			"BASE URL *",
			"baseUrl",
			"input",
			{
				type: "url",
				placeholder:
					"Example: https://api.openai.com/v1 or https://api.anthropic.com",
				value: modelData.baseUrl,
			},
			"Base URL address for API requests, must start with http:// or https://\\nExample: https://api.openai.com/v1 or https://api.anthropic.com",
		),
	]);

	// Create performance settings section
	const perfSection = createSection("Model Performance", [
		createFormGroup(
			"maxInputTokens",
			"Max Input Tokens",
			"maxInputTokens",
			"input",
			{
				type: "number",
				min: 128,
				value: modelData.maxInputTokens,
			},
			"Maximum input context limit supported by the model",
		),
		createFormGroup(
			"maxOutputTokens",
			"Max Output Tokens",
			"maxOutputTokens",
			"input",
			{
				type: "number",
				min: 8,
				value: modelData.maxOutputTokens,
			},
			"Maximum output token limit supported by the model",
		),
	]);

	// Create capability configuration section
	const capSection = createSection("Model Capabilities", [
		createCheckboxFormGroup(
			"toolCalling",
			"Support Tool Calling",
			"capabilities.toolCalling",
			modelData.toolCalling,
		),
		createCheckboxFormGroup(
			"imageInput",
			"Support Image Input",
			"capabilities.imageInput",
			modelData.imageInput,
		),
	]);

	// Create advanced settings section
	const advSection = createSection("Advanced Settings", [
		createCheckboxFormGroup(
			"outputThinking",
			"Show Thinking Process in Chat UI",
			"outputThinking",
			modelData.outputThinking,
			"Display model's thinking process in chat interface. Enable this to see <thinking> tags in responses. Recommended for thinking models like Claude Sonnet/Opus 4.5.",
		),
		createCheckboxFormGroup(
			"includeThinking",
			"Inject Thinking into Multi-turn Conversations",
			"includeThinking",
			modelData.includeThinking,
			"Include thinking content when sending conversation history to model. Required for thinking models to maintain context. Enable this for Claude Sonnet/Opus 4.5 thinking models.",
		),
		createJSONFormGroup(
			"customHeader",
			"Custom HTTP Header (JSON format)",
			"customHeader",
			modelData.customHeader,
			'{"Authorization": "Bearer \${APIKEY}", "X-Custom-Header": "value"}',
			"Optional custom HTTP header configuration. Supports \${APIKEY} placeholder to auto-replace with actual API key.",
		),
		createJSONFormGroup(
			"extraBody",
			"Extra Request Body Parameters (JSON format)",
			"extraBody",
			modelData.extraBody,
			'{"temperature": 1, "top_p": null}',
			"Extra request body parameters, will be merged into request body in API. If model doesn't support certain parameters, can set to null to remove corresponding values.",
		),
	]);

	// Create button group
	const buttonGroup = createButtonGroup();

	// Create global error banner
	const errorBanner = createErrorBanner();

	// Add to container (error banner at the very top)
	container.appendChild(errorBanner);
	container.appendChild(basicSection);
	container.appendChild(apiSection);
	container.appendChild(perfSection);
	container.appendChild(capSection);
	container.appendChild(advSection);
	container.appendChild(buttonGroup);
}

/**
 * Create section element
 * @param {string} title - Section title
 * @param {Array<HTMLElement>} formGroups - Array of form group elements
 * @returns {HTMLElement} Created section element
 */
function createSection(title, formGroups) {
	const section = document.createElement("div");
	section.className = "section";

	const h3 = document.createElement("h3");
	h3.textContent = title;
	section.appendChild(h3);

	for (const group of formGroups) {
		section.appendChild(group);
	}

	return section;
}

/**
 * Create form group
 * @param {string} id - ID of the form element
 * @param {string} labelText - Label display text
 * @param {string} fieldName - Field name (displayed in parentheses)
 * @param {string} elementType - Element type: 'input', 'textarea' or 'select'
 * @param {Object} attrs - Element attributes object
 * @param {string} [helpText] - Help text (optional)
 * @returns {HTMLElement} Created form group element
 */
function createFormGroup(
	id,
	labelText,
	fieldName,
	elementType,
	attrs,
	helpText,
) {
	const group = document.createElement("div");
	group.className = "form-group";

	const label = document.createElement("label");
	label.htmlFor = id;
	label.innerHTML = \`\${labelText} <span class="field-name">(\${fieldName})</span>\`;
	group.appendChild(label);

	let element;
	if (elementType === "input") {
		element = document.createElement("input");
		Object.entries(attrs).forEach(([key, value]) => {
			if (key === "readonly" && value) {
				element.setAttribute("readonly", "");
				element.classList.add("readonly");
			} else if (key !== "readonly") {
				element.setAttribute(key, value || "");
			}
		});
	} else if (elementType === "textarea") {
		element = document.createElement("textarea");
		Object.entries(attrs).forEach(([key, value]) => {
			if (key === "value") {
				element.textContent = value || "";
			} else {
				element.setAttribute(key, value || "");
			}
		});
	} else if (elementType === "select") {
		element = document.createElement("select");
		attrs.options.forEach((opt) => {
			const option = document.createElement("option");
			option.value = opt.value;
			option.textContent = opt.label;
			if (opt.selected) option.selected = true;
			element.appendChild(option);
		});
	}

	element.id = id;
	group.appendChild(element);

	if (helpText) {
		const help = document.createElement("div");
		help.className = "help-text detailed";
		help.textContent = helpText;
		group.appendChild(help);
	}

	return group;
}

/**
 * Create checkbox form group
 * @param {string} id - ID of the checkbox element
 * @param {string} labelText - Label display text
 * @param {string} fieldName - Field name (displayed in parentheses)
 * @param {boolean} checked - Whether the checkbox is checked
 * @param {string} [detailedHelp] - Detailed help text (optional)
 * @returns {HTMLElement} Created checkbox form group element
 */
function createCheckboxFormGroup(
	id,
	labelText,
	fieldName,
	checked,
	detailedHelp,
) {
	const group = document.createElement("div");
	group.className = "form-group";

	const checkboxGroup = document.createElement("div");
	checkboxGroup.className = "checkbox-group";

	const checkbox = document.createElement("input");
	checkbox.type = "checkbox";
	checkbox.id = id;
	checkbox.checked = checked || false;

	const label = document.createElement("label");
	label.htmlFor = id;
	label.innerHTML = \`\${labelText} <span class="field-name">(\${fieldName})</span>\`;

	checkboxGroup.appendChild(checkbox);
	checkboxGroup.appendChild(label);
	group.appendChild(checkboxGroup);

	if (detailedHelp) {
		const help = document.createElement("div");
		help.className = "help-text detailed";
		help.textContent = detailedHelp;
		group.appendChild(help);
	} else {
		group.classList.add("no-bottom");
	}

	return group;
}

/**
 * Create provider form group
 * @returns {HTMLElement} Created provider form group element
 */
function createProviderFormGroup() {
	const group = document.createElement("div");
	group.className = "form-group";

	const label = document.createElement("label");
	label.htmlFor = "provider";
	label.innerHTML = 'Provider * <span class="field-name">(provider)</span>';
	group.appendChild(label);

	const dropdown = document.createElement("div");
	dropdown.className = "provider-dropdown";

	const input = document.createElement("input");
	input.type = "text";
	input.id = "provider";
	input.className = "provider-input";
	input.value = modelData.provider;
	input.placeholder = "Example: zhipu";
	input.autocomplete = "off";

	const list = document.createElement("div");
	list.className = "provider-list";
	list.id = "providerList";

	dropdown.appendChild(input);
	dropdown.appendChild(list);
	group.appendChild(dropdown);

	const help = document.createElement("div");
	help.className = "help-text";
	help.textContent =
		"Model provider identifier (can select built-in/known providers or custom input)";
	group.appendChild(help);

	return group;
}

/**
 * Create JSON form group
 * @param {string} id - ID of the form element
 * @param {string} labelText - Label display text
 * @param {string} fieldName - Field name (displayed in parentheses)
 * @param {string} value - JSON string value
 * @param {string} placeholder - Placeholder text
 * @param {string} helpText - Help text
 * @returns {HTMLElement} Created JSON form group element
 */
function createJSONFormGroup(
	id,
	labelText,
	fieldName,
	value,
	placeholder,
	helpText,
) {
	const group = document.createElement("div");
	group.className = "form-group";

	const label = document.createElement("label");
	label.htmlFor = id;
	label.innerHTML = \`\${labelText} <span class="field-name">(\${fieldName})</span>\`;
	group.appendChild(label);

	const container = document.createElement("div");
	container.className = "json-container";

	const toolbar = document.createElement("div");
	toolbar.className = "json-toolbar";

	const formatBtn = document.createElement("button");
	formatBtn.type = "button";
	formatBtn.className = "json-button";
	formatBtn.textContent = "Format";
	formatBtn.onclick = (e) => {
		e.preventDefault();
		formatJSON(id);
	};

	const clearBtn = document.createElement("button");
	clearBtn.type = "button";
	clearBtn.className = "json-button";
	clearBtn.textContent = "Clear";
	clearBtn.onclick = (e) => {
		e.preventDefault();
		clearJSON(id);
	};

	const status = document.createElement("div");
	status.className = "json-status";
	status.id = \`\${id}Status\`;

	const indicator = document.createElement("span");
	indicator.className = "json-status-indicator";

	const statusText = document.createElement("span");
	statusText.id = \`\${id}StatusText\`;
	statusText.textContent = "No content";

	status.appendChild(indicator);
	status.appendChild(statusText);

	toolbar.appendChild(formatBtn);
	toolbar.appendChild(clearBtn);
	toolbar.appendChild(status);
	container.appendChild(toolbar);

	const textarea = document.createElement("textarea");
	textarea.id = id;
	textarea.className = "json-input";
	textarea.placeholder = placeholder;
	textarea.value = value || "";

	container.appendChild(textarea);

	const error = document.createElement("div");
	error.className = "json-error";
	error.id = \`\${id}Error\`;
	container.appendChild(error);

	group.appendChild(container);

	const help = document.createElement("div");
	help.className = "help-text detailed";
	help.textContent = helpText;
	group.appendChild(help);

	return group;
}

/**
 * Create global error notification area
 * @returns {HTMLElement} Created error notification element
 */
function createErrorBanner() {
	const banner = document.createElement("div");
	banner.id = "globalErrorBanner";
	banner.className = "error-banner";
	banner.style.display = "none";

	const messageSpan = document.createElement("span");
	messageSpan.id = "globalErrorMessage";

	const closeBtn = document.createElement("button");
	closeBtn.className = "error-banner-close";
	closeBtn.textContent = "\xD7";
	closeBtn.onclick = hideGlobalError;

	banner.appendChild(messageSpan);
	banner.appendChild(closeBtn);

	return banner;
}

/**
 * Create button group
 * @returns {HTMLElement} Created button group element
 */
function createButtonGroup() {
	const group = document.createElement("div");
	group.className = "button-group";

	// Create internal container for center alignment
	const inner = document.createElement("div");
	inner.className = "button-group-inner";

	// Left buttons container (Delete button)
	const leftButtons = document.createElement("div");
	leftButtons.style.display = "flex";
	leftButtons.style.gap = "10px";

	// Right buttons container (Save and Cancel buttons)
	const rightButtons = document.createElement("div");
	rightButtons.style.display = "flex";
	rightButtons.style.gap = "10px";

	// If in edit mode, add delete button to the left
	if (!isCreateMode) {
		const deleteBtn = document.createElement("button");
		deleteBtn.className = "delete-button";
		deleteBtn.textContent = "Delete";
		deleteBtn.onclick = deleteModel;
		leftButtons.appendChild(deleteBtn);
	}

	const saveBtn = document.createElement("button");
	saveBtn.className = "primary-button";
	saveBtn.textContent = isCreateMode ? "Create" : "Update";
	saveBtn.onclick = saveModel;

	const cancelBtn = document.createElement("button");
	cancelBtn.className = "secondary-button";
	cancelBtn.textContent = "Cancel";
	cancelBtn.onclick = cancelEdit;

	rightButtons.appendChild(saveBtn);
	rightButtons.appendChild(cancelBtn);

	inner.appendChild(leftButtons);
	inner.appendChild(rightButtons);
	group.appendChild(inner);

	return group;
}

/**
 * Automatically adjust height of a single textarea to fit content
 * @param {HTMLTextAreaElement} textarea - textarea element
 * @returns {void}
 */
function autoResizeTextarea(textarea) {
	if (!textarea) return;

	// Reset height to get correct scrollHeight
	textarea.style.height = "auto";

	// Set new height (scrollHeight + border)
	const newHeight = textarea.scrollHeight;
	textarea.style.height = \`\${newHeight}px\`;
}

/**
 * Add auto-expanding height functionality to all textarea elements
 * @returns {void}
 */
function autoResizeAllTextareas() {
	const textareas = document.querySelectorAll("textarea");

	textareas.forEach((textarea) => {
		// Adjust height once during initialization
		autoResizeTextarea(textarea);

		// Listen to input events, adjust height in real time
		textarea.addEventListener("input", function () {
			autoResizeTextarea(this);
		});

		// Listen to change events (e.g. after pasting)
		textarea.addEventListener("change", function () {
			autoResizeTextarea(this);
		});

		// Listen to paste events
		textarea.addEventListener("paste", function () {
			// Use setTimeout to ensure content has been pasted
			setTimeout(() => {
				autoResizeTextarea(this);
			}, 0);
		});
	});
}

/**
 * General input validation - non-empty validation
 * @param {HTMLElement} element - Input element to validate
 * @returns {void}
 */
function addSimpleValidation(element) {
	element.addEventListener("input", function () {
		if (this.value.trim()) {
			this.classList.remove("invalid");
		} else {
			this.classList.add("invalid");
		}
	});
}

/**
 * General number validation - must be a positive integer
 * @param {HTMLElement} element - Input element to validate
 * @returns {void}
 */
function addNumberValidation(element) {
	element.addEventListener("input", function () {
		const value = parseInt(this.value, 10);
		if (value && value > 0) {
			this.classList.remove("invalid");
		} else {
			this.classList.add("invalid");
		}
	});
}

/**
 * Check if it is a valid JSON object (not an array, not null, not a primitive type)
 * @param {*} parsed - Parsed JSON data
 * @returns {boolean} Whether it is a valid JSON object
 */
function isValidJSONObject(parsed) {
	return (
		typeof parsed === "object" && parsed !== null && !Array.isArray(parsed)
	);
}

/**
 * Bind event listeners
 * @returns {void}
 */
function bindEvents() {
	// Real-time validation for required fields
	const modelId = document.getElementById("modelId");
	const modelName = document.getElementById("modelName");
	const provider = document.getElementById("provider");
	const baseUrl = document.getElementById("baseUrl");
	const maxInputTokens = document.getElementById("maxInputTokens");
	const maxOutputTokens = document.getElementById("maxOutputTokens");

	// Add auto-expanding height functionality to all textarea elements
	autoResizeAllTextareas();

	// Model ID validation
	if (modelId && !modelId.readOnly) {
		addSimpleValidation(modelId);
	}

	// Display name validation
	addSimpleValidation(modelName);

	// Provider validation
	addSimpleValidation(provider);

	// baseUrl validation (required + URL format)
	baseUrl.addEventListener("input", function () {
		const value = this.value.trim();
		if (!value) {
			this.classList.add("invalid");
			return;
		}
		try {
			const urlObj = new URL(value);
			if (urlObj.protocol === "http:" || urlObj.protocol === "https:") {
				this.classList.remove("invalid");
			} else {
				this.classList.add("invalid");
			}
		} catch (_e) {
			this.classList.add("invalid");
		}
	});

	// Token count validation
	addNumberValidation(maxInputTokens);
	addNumberValidation(maxOutputTokens);

	// JSON validation events
	const customHeader = document.getElementById("customHeader");
	const extraBody = document.getElementById("extraBody");

	customHeader.addEventListener("input", () => validateJSON_UI("customHeader"));
	customHeader.addEventListener("change", () =>
		validateJSON_UI("customHeader"),
	);

	extraBody.addEventListener("input", () => validateJSON_UI("extraBody"));
	extraBody.addEventListener("change", () => validateJSON_UI("extraBody"));

	// Provider input events
	const providerInput = document.getElementById("provider");
	const providerList = document.getElementById("providerList");

	providerInput.addEventListener("input", function () {
		const searchText = this.value.toLowerCase();
		if (searchText) {
			const filtered = allProviders.filter(
				(p) =>
					p.id.toLowerCase().includes(searchText) ||
					p.name.toLowerCase().includes(searchText),
			);
			renderProviderList(filtered);
			providerList.classList.add("show");
		} else {
			providerList.classList.remove("show");
		}
	});

	providerInput.addEventListener("focus", () => {
		if (allProviders && allProviders.length > 0) {
			renderProviderList(allProviders);
			providerList.classList.add("show");
		}
	});

	document.addEventListener("click", (event) => {
		if (!event.target.closest(".provider-dropdown")) {
			providerList.classList.remove("show");
		}
	});

	// VSCode message events
	window.addEventListener("message", (event) => {
		const message = event.data;
		if (message.command === "setProviders") {
			updateProviderList(message.providers);
		}
	});
}

/**
 * Validate JSON string format
 * @param {string} jsonString - JSON string to validate
 * @returns {boolean} Whether JSON is valid
 */
function validateJSON(jsonString) {
	if (!jsonString || jsonString.trim() === "") {
		return true;
	}
	try {
		const parsed = JSON.parse(jsonString);
		// Must be object type, cannot be array, string, number, etc.
		return isValidJSONObject(parsed);
	} catch (_e) {
		return false;
	}
}

/**
 * Parse JSON string
 * @param {string} jsonString - JSON string to parse
 * @returns {Object|undefined} Parsed object, returns undefined if parsing fails or not an object
 */
function parseJSON(jsonString) {
	if (!jsonString || jsonString.trim() === "") {
		return undefined;
	}
	try {
		const parsed = JSON.parse(jsonString);
		// Must be object type, cannot be array, string, number, etc.
		if (isValidJSONObject(parsed)) {
			return parsed;
		}
		return undefined;
	} catch (_e) {
		return undefined;
	}
}

/**
 * Validate JSON and update UI state (visual feedback only, does not take focus)
 * @param {string} fieldId - Form field ID
 * @returns {boolean} Whether JSON is valid
 */
function validateJSON_UI(fieldId) {
	const textarea = document.getElementById(fieldId);
	const statusDiv = document.getElementById(\`\${fieldId}Status\`);
	const statusText = document.getElementById(\`\${fieldId}StatusText\`);
	const errorDiv = document.getElementById(\`\${fieldId}Error\`);
	const content = textarea.value.trim();

	// Remove all validation state classes
	textarea.classList.remove("json-valid", "json-invalid");
	if (errorDiv) {
		errorDiv.classList.remove("show");
	}

	if (!content) {
		const indicator = statusDiv.querySelector(".json-status-indicator");
		indicator.className = "json-status-indicator";
		statusText.textContent = "No content";
		return true;
	}

	try {
		const parsed = JSON.parse(content);
		// Must be object type, consistent with validateJSON logic
		if (isValidJSONObject(parsed)) {
			// Validation passed - restore default state (no green style added)
			const indicator = statusDiv.querySelector(".json-status-indicator");
			indicator.className = "json-status-indicator";
			statusText.textContent = "Valid";
			return true;
		} else {
			// Not an object type - show red error state
			textarea.classList.add("json-invalid");
			const indicator = statusDiv.querySelector(".json-status-indicator");
			indicator.className = "json-status-indicator invalid";
			statusText.textContent = "Invalid";
			if (errorDiv) {
				errorDiv.textContent =
					'Must be object type (like {"key": "value"}), cannot be array, number or string';
				errorDiv.classList.add("show");
			}
			return false;
		}
	} catch (e) {
		// JSON parsing error - show red error state
		textarea.classList.add("json-invalid");
		const indicator = statusDiv.querySelector(".json-status-indicator");
		indicator.className = "json-status-indicator invalid";
		statusText.textContent = "Invalid";
		if (errorDiv) {
			errorDiv.textContent = \`Error: \${e.message}\`;
			errorDiv.classList.add("show");
		}
		return false;
	}
}

/**
 * Format JSON string
 * @param {string} fieldId - Form field ID
 * @returns {void}
 */
function formatJSON(fieldId) {
	const textarea = document.getElementById(fieldId);
	const content = textarea.value.trim();

	if (!content) {
		showGlobalError("No content to format");
		return;
	}

	try {
		const parsed = JSON.parse(content);
		// Must be object type, consistent with validateJSON logic
		if (!isValidJSONObject(parsed)) {
			showGlobalError(
				'JSON format error: Must be object type (like {"key": "value"}), cannot be array, number or string',
			);
			return;
		}
		textarea.value = JSON.stringify(parsed, null, 2);
		validateJSON_UI(fieldId);
		// Adjust height after formatting
		autoResizeTextarea(textarea);
		textarea.style.opacity = "0.7";
		setTimeout(() => {
			textarea.style.opacity = "1";
		}, 200);
		// Clear error prompt when formatting is successful
		hideGlobalError();
	} catch (e) {
		showGlobalError(\`JSON format error, cannot format:\\n\${e.message}\`);
	}
}

/**
 * Clear JSON field content
 * @param {string} fieldId - Form field ID
 * @returns {void}
 */
function clearJSON(fieldId) {
	const textarea = document.getElementById(fieldId);
	// Clear directly without confirmation (user can restore via cancel save or Ctrl+Z)
	textarea.value = "";
	validateJSON_UI(fieldId);
	// Adjust height after clearing
	autoResizeTextarea(textarea);
}

/**
 * Provider list management
 * @param {Provider[]} providers - Provider list
 * @returns {void}
 */
function updateProviderList(providers) {
	allProviders = providers || [];
	renderProviderList(allProviders);
}

/**
 * Render provider list
 * @param {Provider[]} providers - Provider list
 * @returns {void}
 */
function renderProviderList(providers) {
	const providerListDiv = document.getElementById("providerList");
	const currentValue = document.getElementById("provider").value;

	providerListDiv.innerHTML = "";

	if (!providers || providers.length === 0) {
		const item = document.createElement("div");
		item.className = "provider-list-item";
		item.textContent = "No matching providers";
		item.style.pointerEvents = "none";
		item.style.opacity = "0.5";
		providerListDiv.appendChild(item);
		return;
	}

	providers.forEach((provider) => {
		const item = document.createElement("div");
		item.className = "provider-list-item";
		if (provider.id === currentValue) {
			item.classList.add("selected");
		}
		item.textContent = \`\${provider.name} (\${provider.id})\`;
		item.addEventListener("click", () => {
			const providerInput = document.getElementById("provider");
			providerInput.value = provider.id;
			// Remove error style (if any)
			providerInput.classList.remove("invalid");
			providerListDiv.classList.remove("show");
		});
		providerListDiv.appendChild(item);
	});
}

/**
 * Form validation
 */
/**
 * Show global error info
 * @param {string} message - Error message
 * @returns {void}
 */
function showGlobalError(message) {
	const banner = document.getElementById("globalErrorBanner");
	const messageSpan = document.getElementById("globalErrorMessage");

	if (banner && messageSpan) {
		messageSpan.textContent = message;
		banner.style.display = "flex";
		// Auto-scroll to top to ensure user sees error prompt
		banner.scrollIntoView({ behavior: "smooth", block: "nearest" });
	}
}

/**
 * Hide global error info
 * @returns {void}
 */
function hideGlobalError() {
	const banner = document.getElementById("globalErrorBanner");
	if (banner) {
		banner.style.display = "none";
	}
}

/**
 * Validate form data
 * @returns {boolean} Whether form is valid
 */
function validateForm() {
	const modelId = document.getElementById("modelId").value.trim();
	const modelName = document.getElementById("modelName").value.trim();
	const provider = document.getElementById("provider").value.trim();
	const baseUrl = document.getElementById("baseUrl").value.trim();
	const maxInputTokens = document.getElementById("maxInputTokens").value.trim();
	const maxOutputTokens = document
		.getElementById("maxOutputTokens")
		.value.trim();

	// Validate required fields
	if (!modelId) {
		showGlobalError("Please enter Model ID");
		document.getElementById("modelId").focus();
		return false;
	}
	if (!modelName) {
		showGlobalError("Please enter display name");
		document.getElementById("modelName").focus();
		return false;
	}
	if (!provider) {
		showGlobalError("Please enter provider");
		document.getElementById("provider").focus();
		return false;
	}
	if (!baseUrl) {
		showGlobalError("Please enter BASE URL");
		document.getElementById("baseUrl").focus();
		return false;
	}

	// Validate URL format
	if (baseUrl) {
		try {
			const urlObj = new URL(baseUrl);
			if (urlObj.protocol !== "http:" && urlObj.protocol !== "https:") {
				showGlobalError("BASE URL must start with http:// or https://");
				document.getElementById("baseUrl").focus();
				return false;
			}
		} catch (_e) {
			showGlobalError("BASE URL format is incorrect, please enter a valid URL");
			document.getElementById("baseUrl").focus();
			return false;
		}
	}

	// Validate token count
	if (
		!maxInputTokens ||
		Number.isNaN(parseInt(maxInputTokens, 10)) ||
		parseInt(maxInputTokens, 10) <= 0
	) {
		showGlobalError("Input token must be a number greater than 0");
		document.getElementById("maxInputTokens").focus();
		return false;
	}
	if (
		!maxOutputTokens ||
		Number.isNaN(parseInt(maxOutputTokens, 10)) ||
		parseInt(maxOutputTokens, 10) <= 0
	) {
		showGlobalError("Output token must be a number greater than 0");
		document.getElementById("maxOutputTokens").focus();
		return false;
	}

	// Validate JSON format
	const customHeaderJson = document.getElementById("customHeader").value.trim();
	if (customHeaderJson && !validateJSON(customHeaderJson)) {
		showGlobalError(
			"Custom HTTP header JSON format is incorrect, must be object type",
		);
		document.getElementById("customHeader").focus();
		return false;
	}

	const extraBodyJson = document.getElementById("extraBody").value.trim();
	if (extraBodyJson && !validateJSON(extraBodyJson)) {
		showGlobalError(
			"Extra request body parameters JSON format is incorrect, must be object type",
		);
		document.getElementById("extraBody").focus();
		return false;
	}

	return true;
}

/**
 * Save model configuration
 * @returns {void}
 */
function saveModel() {
	// Clear previous errors
	hideGlobalError();

	if (!validateForm()) {
		return;
	}

	const modelId = document.getElementById("modelId").value.trim();
	const modelName = document.getElementById("modelName").value.trim();
	const provider = document.getElementById("provider").value.trim();

	if (!modelId || !modelName || !provider) {
		showGlobalError("Please enter all required fields");
		return;
	}

	const tooltipText = document.getElementById("modelTooltip").value.trim();
	const requestModelText = document.getElementById("requestModel").value.trim();
	const baseUrlText = document.getElementById("baseUrl").value.trim();

	const model = {
		id: modelId,
		name: modelName,
		// tooltip: use null to clear (undefined will be ignored when JSON serializing)
		tooltip: tooltipText || null,
		provider: provider,
		// baseUrl: use null to clear
		baseUrl: baseUrlText || null,
		// model: use null to clear
		model: requestModelText || null,
		sdkMode: document.getElementById("sdkMode").value || "openai",
		maxInputTokens:
			parseInt(document.getElementById("maxInputTokens").value, 10) || 12800,
		maxOutputTokens:
			parseInt(document.getElementById("maxOutputTokens").value, 10) || 8192,
		capabilities: {
			toolCalling: document.getElementById("toolCalling").checked,
			imageInput: document.getElementById("imageInput").checked,
		},
		outputThinking: document.getElementById("outputThinking").checked,
		includeThinking: document.getElementById("includeThinking").checked,
	};

	const customHeaderText = document.getElementById("customHeader").value.trim();
	const customHeader = parseJSON(customHeaderText);
	// Explicitly set customHeader, use null to clear (undefined will be ignored when JSON serializing)
	model.customHeader = customHeader || null;

	const extraBodyText = document.getElementById("extraBody").value.trim();
	const extraBody = parseJSON(extraBodyText);
	// Explicitly set extraBody, use null to clear
	model.extraBody = extraBody || null;

	if (!model.id || !model.name || !model.provider) {
		showGlobalError("Model configuration is incomplete, please try again");
		return;
	}

	vscode.postMessage({
		command: "save",
		model: model,
	});
}

/**
 * Cancel editing
 * @returns {void}
 */
function cancelEdit() {
	vscode.postMessage({
		command: "cancel",
	});
}

/**
 * Delete model
 * @returns {void}
 */
function deleteModel() {
	// Send delete request to VSCode side, VSCode will show confirmation dialog
	vscode.postMessage({
		command: "delete",
		modelId: document.getElementById("modelId").value.trim(),
		modelName: document.getElementById("modelName").value.trim(),
	});
}
`});var Qr,sc,Rm=ke(()=>{"use strict";Qr=D(require("vscode"));ao();ac();Jx();Yx();sc=class n{static async show(e,t=!1){let o=Qr.window.createWebviewPanel("compatibleModelEditor",t?"Create New Model":`Edit Model: ${e.name||"Unnamed Model"}`,Qr.ViewColumn.One,{enableScripts:!0,retainContextWhenHidden:!0});return o.webview.html=n.generateHTML(e,t,o.webview),new Promise(r=>{let i=[];i.push(o.webview.onDidReceiveMessage(async a=>{switch(a.command){case"getProviders":n.sendProvidersList(o.webview);break;case"save":a.model&&typeof a.model=="object"&&a.model.id&&a.model.name&&a.model.provider?r(a.model):(Qr.window.showErrorMessage("Invalid saved model data"),r(void 0)),o.dispose();break;case"delete":if(a.modelId&&typeof a.modelId=="string"){let s=a.modelName||"this model";await Qr.window.showWarningMessage(`Are you sure you want to delete model "${s}"?`,{modal:!0},"Delete")==="Delete"&&(r({_deleteModel:!0,modelId:a.modelId}),o.dispose())}else Qr.window.showErrorMessage("Delete failed: Invalid model ID");break;case"cancel":r(void 0),o.dispose();break}},void 0,i)),i.push(o.onDidDispose(()=>{i.forEach(a=>{a.dispose()})},void 0,i))})}static generateHTML(e,t,o){let r=o.cspSource||"",i={id:e?.id||"",name:e?.name||"",provider:e?.provider||"",sdkMode:e?.sdkMode||"openai",tooltip:e?.tooltip||"",baseUrl:e?.baseUrl||"",model:e?.model||"",maxInputTokens:e?.maxInputTokens||128e3,maxOutputTokens:e?.maxOutputTokens||4096,toolCalling:e?.capabilities?.toolCalling||!1,imageInput:e?.capabilities?.imageInput||!1,outputThinking:e?.outputThinking!==!1,includeThinking:e?.includeThinking!==!1,customHeader:e?.customHeader?JSON.stringify(e.customHeader,null,2):"",extraBody:e?.extraBody?JSON.stringify(e.extraBody,null,2):""};return`<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>${t?"Create New Model":`Edit Model: ${n.escapeHtml(i.name)}`}</title>
        <meta http-equiv="Content-Security-Policy" content="default-src 'none'; style-src 'unsafe-inline' ${r}; script-src 'unsafe-inline' ${r};" />
        <style>
            ${Wx}
        </style>
    </head>
    <body>
        <div class="container">
            <div id="app"></div>
        </div>
        <script>
            ${Xx}

            // Initialize data
            const initialModelData = ${JSON.stringify(i)};
            const initialIsCreateMode = ${t};

            // Start editor
            document.addEventListener('DOMContentLoaded', function() {
                initializeEditor(initialModelData, initialIsCreateMode);
            });
        </script>
    </body>
</html>`}static escapeHtml(e){if(!e)return"";let t={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return e.replace(/[&<>"']/g,o=>t[o])}static sendProvidersList(e){let t=new Map;Object.entries(vt).forEach(([o,r])=>{t.set(o,{id:o,name:r.displayName||o})}),Object.entries(bn).forEach(([o,r])=>{t.has(o)||t.set(o,{id:o,name:r.displayName||o})}),e.postMessage({command:"setProviders",providers:Array.from(t.values())})}}});var eb={};io(eb,{CompatibleModelManager:()=>wn});function fM(n){return typeof n=="object"&&n?.back===!0}var Re,wn,cc=ke(()=>{"use strict";Re=D(require("vscode"));ao();Rm();Ke();ac();ce();wn=class n{static models=[];static configListener=null;static _onDidChangeModels=new Re.EventEmitter;static onDidChangeModels=n._onDidChangeModels.event;static isSaving=!1;static initialize(){n.loadModels(),n.setupConfigListener(),u.debug("Custom model manager initialized")}static dispose(){n.configListener&&(n.configListener.dispose(),n.configListener=null),n._onDidChangeModels.dispose(),u.trace("Custom model manager disposed")}static setupConfigListener(){n.configListener&&n.configListener.dispose(),n.configListener=Re.workspace.onDidChangeConfiguration(e=>{if(e.affectsConfiguration("chp.compatibleModels")){if(n.isSaving){u.debug("Saving configuration, skipping reload");return}u.info("Detected custom model configuration changes, reloading..."),n.loadModels(),n._onDidChangeModels.fire()}})}static loadModels(){try{let t=Re.workspace.getConfiguration("chp").get("compatibleModels",[]);n.models=(t||[]).filter(o=>o!=null&&typeof o=="object"&&o.id&&o.name&&o.provider),u.debug(`Loaded ${n.models.length} custom models`)}catch(e){u.error("Failed to load custom models:",e),n.models=[]}}static async saveModels(){try{n.isSaving=!0;let e=Re.workspace.getConfiguration("chp"),t=n.models.filter(o=>o!=null&&typeof o=="object").map(o=>{let{_isFromWizard:r,...i}=o,a={};for(let[s,c]of Object.entries(i))c!=null&&(a[s]=c);return a});u.debug("Preparing to save models, cleaned data:",JSON.stringify(t,null,2)),await e.update("compatibleModels",t,Re.ConfigurationTarget.Global),u.debug("Custom models saved to configuration"),n.loadModels(),n._onDidChangeModels.fire(),u.debug("Model change event triggered")}catch(e){throw u.error("Failed to save custom models:",e),e}finally{setTimeout(()=>{n.isSaving=!1},100)}}static getModels(){return n.models}static getRawModelFromConfig(e){try{return Re.workspace.getConfiguration("chp").get("compatibleModels",[]).find(i=>i&&i.id===e)}catch(t){u.error("Failed to read raw model data from configuration file:",t);return}}static async addModel(e){if(!e)throw new Error("Model configuration cannot be empty");if(!e.id||!e.name||!e.provider)throw new Error("Model configuration missing required fields (id, name, provider)");if(n.models.some(t=>t.id===e.id))throw new Error(`Model ID "${e.id}" already exists`);if(typeof e!="object")throw new Error("Model configuration must be a valid object");(!e.capabilities||typeof e.capabilities!="object")&&(e.capabilities={toolCalling:!1,imageInput:!1}),n.models.push(e),await n.saveModels(),u.info(`Added custom model: ${e.name} (${e.provider}, ${e.sdkMode})`)}static async updateModel(e,t){if(!t)throw new Error("Update data cannot be empty");let o=n.models.findIndex(r=>r.id===e);if(o===-1)throw new Error(`Model ID "${e}" not found`);if(!n.models[o])throw new Error(`Model data corrupted, cannot update model ID "${e}"`);n.models[o]={...n.models[o],...t},await n.saveModels(),u.info(`Updated custom model: ${e}`)}static async removeModel(e){let t=n.models.findIndex(r=>r.id===e);if(t===-1)throw new Error(`Model ID "${e}" not found`);let o=n.models[t];if(!o)throw new Error(`Model data corrupted, cannot delete model ID "${e}"`);n.models.splice(t,1),await n.saveModels(),u.info(`Deleted custom model: ${o.name}`)}static async removeModels(e){let t=0,o=0,r=e.filter(i=>n.models.some(a=>a.id===i));for(let i of r){let a=n.models.findIndex(s=>s.id===i);if(a!==-1){let s=n.models[a];n.models.splice(a,1),u.info(`Deleted custom model: ${s?.name||i}`),t++}else o++}return t>0&&await n.saveModels(),{success:t,failed:o}}static async configureModelOrUpdateAPIKey(){if(n.models.length===0){u.info("No custom models, directly entering add flow"),await n.configureModels();return}let e=[{label:"$(key) Manage API Keys",detail:"Update or configure provider or model API keys",action:"apiKey"},{label:"$(settings-gear) Configure Models",detail:"Add, edit, or delete model configurations",action:"configureModels"}],t=Re.window.createQuickPick();t.title="Manage OpenAI / Anthropic Compatible Models",t.placeholder="Select an action",t.items=e,t.ignoreFocusOut=!0;let o=await new Promise(r=>{t.onDidAccept(()=>{let i=t.selectedItems[0];r(i),t.hide()}),t.onDidHide(()=>{r(void 0)}),t.show()});o?.action==="apiKey"?await n.promptAndSetApiKey():o?.action==="configureModels"&&await n.configureModels()}static async promptAndSetApiKey(){try{let e=await n.getUniqueProviders();if(e.length===0){Re.window.showWarningMessage("No custom model configurations, please add a model first");return}if(e.length===1){await n.setApiKeyForProvider(e[0]);return}let t=await n.getHistoricalCustomProviders(),o=[],r=[],i=[];e.forEach(c=>{t.includes(c)?o.push(c):c in bn?r.push(c):c in vt?i.push(c):o.push(c)});let a=[];o.length>0&&a.push(...o.map(c=>({label:c}))),r.length>0&&(o.length>0&&a.push({label:"Known Providers",kind:Re.QuickPickItemKind.Separator}),a.push(...r.map(c=>({label:c,description:bn[c]?.displayName})))),i.length>0&&((o.length>0||r.length>0)&&a.push({label:"Built-in Providers",kind:Re.QuickPickItemKind.Separator}),a.push(...i.map(c=>({label:c,description:vt[c]?.displayName}))));let s=await Re.window.showQuickPick(a,{placeHolder:"Select provider to set API key for"});if(!s)return;await n.setApiKeyForProvider(s.label)}catch(e){u.error("Failed to set API key:",e),Re.window.showErrorMessage(`Failed to set API key: ${e instanceof Error?e.message:"Unknown error"}`)}}static async getUniqueProviders(){let e=new Set;for(let t of n.models)t.provider?.trim()?e.add(t.provider.trim()):e.add("compatible");return Array.from(e).sort()}static async setApiKeyForProvider(e){let t=await Re.window.showInputBox({prompt:`Please enter API key for "${e}" (leave empty to clear key)`,placeHolder:"sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx",password:!0});t!==void 0&&(t.trim().length===0?(await R.deleteApiKey(e),u.info(`API key for provider "${e}" has been cleared`)):(await R.setApiKey(e,t.trim()),u.info(`API key for provider "${e}" has been set`)))}static async configureModels(){for(;;){let e=[];for(let r of n.models){let i=[`$(arrow-up) ${r.maxInputTokens} $(arrow-down) ${r.maxOutputTokens}`,`$(chip) ${r.sdkMode==="openai"?"OpenAI":"Anthropic"}`];r.capabilities.toolCalling&&i.push("$(plug) Tool calling"),r.capabilities.imageInput&&i.push("$(circuit-board) Image understanding"),e.push({label:r.name,description:r.id,detail:i.join("	"),modelId:r.id,action:"edit"})}if(e.length===0){let r=await n.showVisualModelEditorForCreate();r&&await n.addModel(r);return}if(e.length>0){let r={label:"",kind:Re.QuickPickItemKind.Separator};e.push(r)}e.push({label:"$(add) Add New Model",detail:"Create new custom model configuration",action:"add"}),e.push({label:"$(trash) Bulk Delete Models",detail:"Select multiple models to delete at once",action:"bulkDelete"});let t=Re.window.createQuickPick();t.title="Custom Model Configuration",t.placeholder="Select a model to edit or add new model",t.items=e,t.ignoreFocusOut=!0;let o=await new Promise(r=>{let i=[];i.push(t.onDidAccept(()=>{let a=t.selectedItems[0];r(a),t.hide()})),i.push(t.onDidHide(()=>{r(void 0),i.forEach(a=>{a.dispose()})})),t.show()});if(!o||fM(o))return;if(o.action==="add"){let r=await n.showVisualModelEditorForCreate();r&&await n.addModel(r)}else if(o.action==="bulkDelete")await n.showBulkDeletePicker();else if(o.action==="edit"&&o.modelId){let r=n.models.find(i=>i.id===o.modelId);if(r){let i=await n._editModel(o.modelId,r);i&&(i.action==="update"&&i.config?await n.updateModel(i.id,i.config):i.action==="delete"&&await n.removeModel(i.id))}}}}static async showBulkDeletePicker(){let e=n.models.map(c=>({label:c.name,description:c.id,detail:`$(chip) ${c.sdkMode==="openai"?"OpenAI":"Anthropic"} | Provider: ${c.provider||"compatible"}`,modelId:c.id}));if(e.length===0){Re.window.showInformationMessage("No models to delete");return}let t=Re.window.createQuickPick();t.title="Bulk Delete Models",t.placeholder="Select models to delete (use Space to select, Enter to confirm)",t.items=e,t.canSelectMany=!0,t.ignoreFocusOut=!0;let o=await new Promise(c=>{t.onDidAccept(()=>{c([...t.selectedItems]),t.hide()}),t.onDidHide(()=>{c(void 0)}),t.show()});if(!o||o.length===0)return;let r=o.length===1?`Are you sure you want to delete "${o[0].label}"?`:`Are you sure you want to delete ${o.length} models?`;if(await Re.window.showWarningMessage(r,{modal:!0},"Delete")!=="Delete")return;let a=o.map(c=>c.modelId),s=await n.removeModels(a);if(s.success>0){let c=s.failed>0?`Deleted ${s.success} model(s), ${s.failed} failed`:`Successfully deleted ${s.success} model(s)`;Re.window.showInformationMessage(c)}else Re.window.showErrorMessage("Failed to delete models")}static async _editModel(e,t){let r=n.getRawModelFromConfig(e)||t,i=await n.showVisualModelEditor(r);if(i)return{action:"update",id:e,config:i}}static async showVisualModelEditorForCreate(){let e={id:"",name:"",provider:"",sdkMode:"openai",maxInputTokens:128e3,maxOutputTokens:4096,capabilities:{toolCalling:!0,imageInput:!1},outputThinking:!0,includeThinking:!0};return n.showVisualModelEditor(e,!0)}static async showVisualModelEditor(e,t=!1){let o=await sc.show(e,t);if(o&&"_deleteModel"in o&&o._deleteModel){try{await n.removeModel(o.modelId),Re.window.showInformationMessage("Model deleted")}catch(r){Re.window.showErrorMessage(`Failed to delete model: ${r instanceof Error?r.message:"Unknown error"}`)}return}return o}static async getHistoricalCustomProviders(){try{let{configProviders:e}=await Promise.resolve().then(()=>(ao(),$m)),t=Object.keys(e),o=Object.keys(bn),r=n.models.map(a=>a.provider).filter(a=>a&&a.trim()!=="");return[...new Set(r)].filter(a=>a!=="compatible"&&!t.includes(a)&&!o.includes(a))}catch(e){return u.error("Failed to get historical custom providers:",e),[]}}}});var zm={};io(zm,{AntigravityAuth:()=>et,antigravityLoginCommand:()=>uc,doAntigravityLogin:()=>rb,doAntigravityLoginForNewAccount:()=>ib});function gM(){let n=new Uint8Array(32);for(let e=0;e<n.length;e++)n[e]=Math.floor(Math.random()*256);return Array.from(n).map(e=>e.toString(16).padStart(2,"0")).join("")}function vM(n,e){let t=new na.URLSearchParams;return t.set("access_type","offline"),t.set("client_id",Nm),t.set("prompt","consent"),t.set("redirect_uri",n),t.set("response_type","code"),t.set("scope",hM.join(" ")),t.set("state",e),`https://accounts.google.com/o/oauth2/v2/auth?${t.toString()}`}function lc(n){try{return JSON.parse(n)}catch{return null}}async function yM(n,e){let t=new na.URLSearchParams;t.set("code",n),t.set("client_id",Nm),t.set("client_secret",nb),t.set("redirect_uri",e),t.set("grant_type","authorization_code");let o=await fetch("https://oauth2.googleapis.com/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:t.toString()}),r=await o.text(),i=lc(r);if(!i)throw new Error(`Failed to parse token response: ${r}`);if(!o.ok)throw new Error(`Token exchange failed: ${r}`);return i}async function xM(n){try{let e=await fetch("https://www.googleapis.com/oauth2/v1/userinfo?alt=json",{method:"GET",headers:{Authorization:`Bearer ${n}`}});if(!e.ok)return{email:""};let t=await e.text();return lc(t)||{email:""}}catch{return{email:""}}}async function ob(n){let e=JSON.stringify({metadata:{ideType:"IDE_UNSPECIFIED",platform:"PLATFORM_UNSPECIFIED",pluginType:"GEMINI"}});try{let t=await fetch("https://cloudcode-pa.googleapis.com/v1internal:loadCodeAssist",{method:"POST",headers:{Authorization:`Bearer ${n}`,"Content-Type":"application/json","User-Agent":"google-api-nodejs-client/9.15.1","X-Goog-Api-Client":"google-cloud-sdk vscode_cloudshelleditor/0.1","Client-Metadata":'{"ideType":"IDE_UNSPECIFIED","platform":"PLATFORM_UNSPECIFIED","pluginType":"GEMINI"}'},body:e});if(!t.ok)return"";let o=await t.text(),r=lc(o);return r?typeof r.cloudaicompanionProject=="string"?r.cloudaicompanionProject.trim():r.cloudaicompanionProject?.id?r.cloudaicompanionProject.id.trim():"":""}catch{return""}}function bM(){return new Promise((n,e)=>{let t,o,r=new Promise((a,s)=>{t=a,o=s}),i=tb.createServer((a,s)=>{if(a.url?.startsWith("/oauth-callback")){let c=new na.URL(a.url,`http://localhost:${Om}`),l=c.searchParams.get("code")||"",d=c.searchParams.get("state")||"",p=c.searchParams.get("error")||"";s.writeHead(200,{"Content-Type":"text/html; charset=utf-8"}),p?(s.end(`<html><head><title>Authentication Failed</title></head><body style="font-family: system-ui; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0;"><div style="text-align: center;"><h1 style="color: #dc3545;">Authentication Failed</h1><p>Error: ${p}</p><p>You can close this window.</p></div></body></html>`),o(new Error(`Authentication failed: ${p}`))):(s.end('<html><head><title>Authentication Successful</title></head><body style="font-family: system-ui; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0;"><div style="text-align: center;"><h1 style="color: #28a745;">Authentication Successful</h1><p>You can close this window and return to VS Code.</p></div></body></html>'),t({code:l,state:d}))}else s.writeHead(404),s.end("Not Found")});i.listen(Om,"localhost",()=>n({server:i,port:Om,resultPromise:r})),i.on("error",a=>e(new Error(`Failed to start callback server: ${a.message}`)))})}async function rb(){let n=gM(),e;try{e=await bM()}catch(i){return xt.window.showErrorMessage(`Failed to start OAuth server: ${i instanceof Error?i.message:"Unknown error"}`),null}let t=`http://localhost:${e.port}/oauth-callback`,o=vM(t,n);if(!await xt.env.openExternal(xt.Uri.parse(o)))if(await xt.window.showInformationMessage("Could not open browser. Copy the authentication URL to clipboard?","Copy URL","Cancel")==="Copy URL")await xt.env.clipboard.writeText(o),xt.window.showInformationMessage("URL copied to clipboard. Paste it in your browser to continue.");else return e.server.close(),null;xt.window.showInformationMessage("Waiting for authentication... Please complete the login in your browser.");try{let i=new Promise((f,m)=>setTimeout(()=>m(new Error("Authentication timed out after 5 minutes")),3e5)),{code:a,state:s}=await Promise.race([e.resultPromise,i]);if(s!==n)throw new Error("Invalid state - possible CSRF attack");if(!a)throw new Error("Missing authorization code");let c=await yM(a,t),l="";c.access_token&&(l=(await xM(c.access_token)).email?.trim()||"");let d="";c.access_token&&(d=await ob(c.access_token));let p=new Date(Date.now()+c.expires_in*1e3).toISOString();return{accessToken:c.access_token,refreshToken:c.refresh_token,email:l,projectId:d,expiresAt:p}}catch(i){return xt.window.showErrorMessage(`Authentication failed: ${i instanceof Error?i.message:"Unknown error"}`),null}finally{e.server.close()}}async function wM(n){let{CompatibleModelManager:e}=await Promise.resolve().then(()=>(cc(),eb)),t=L.getProviderOverrides().antigravity?.baseUrl||"https://cloudcode-pa.googleapis.com/v1internal",o=0;for(let r of n)try{await e.addModel({id:`${yt}:${r.id}`,name:`${r.displayName} (Antigravity)`,provider:yt,sdkMode:"openai",baseUrl:t,model:r.id,maxInputTokens:r.maxTokens||1e6,maxOutputTokens:r.maxOutputTokens||65536,capabilities:{toolCalling:!0,imageInput:!0}}),o++}catch{}o>0&&xt.window.showInformationMessage(`Automatically added ${o} Antigravity model(s) to Compatible Provider`)}async function Lm(n){let e=await rb();if(!e)return;let t=await et.fetchModels(e.accessToken),{AccountManager:o}=await Promise.resolve().then(()=>(Vr(),px)),r=o.getInstance(),i=r.getAccountsByProvider(yt),a=i.find(d=>d.email===e.email),s={accessToken:e.accessToken,refreshToken:e.refreshToken,expiresAt:e.expiresAt};if(a&&!n)await r.updateCredentials(a.id,s);else{let d=e.email?n?`${e.email} (${i.length+1})`:e.email:`Antigravity Account ${i.length+1}`;await r.addOAuthAccount(yt,d,e.email||"",s,{projectId:e.projectId,models:t})}await R.setApiKey(yt,JSON.stringify({type:yt,access_token:e.accessToken,refresh_token:e.refreshToken,email:e.email,project_id:e.projectId,expires_at:e.expiresAt,timestamp:Date.now(),models:t}));let c=e.email?`Antigravity login successful! Authenticated as ${e.email}`:"Antigravity login successful!",l=t.length>0?` | ${t.length} models available`:"";xt.window.showInformationMessage(e.projectId?`${c} (Project: ${e.projectId})${l}`:`${c}${l}`),t.length>0&&await wM(t)}async function uc(){if(await et.isLoggedIn()){let e=await xt.window.showQuickPick([{label:"$(add) Add Another Account",action:"addAccount"},{label:"$(list-unordered) Show Available Models",action:"models"},{label:"$(refresh) Refresh Models",action:"refresh"},{label:"$(sign-out) Logout",action:"logout"}],{placeHolder:"Antigravity - Already logged in"});if(!e)return;if(e.action==="addAccount"){await Lm(!0);return}if(e.action==="logout"){await et.logout();return}if(e.action==="refresh"){let t=await et.refreshModels();t.length>0?xt.window.showInformationMessage(`Refreshed ${t.length} Antigravity models`):xt.window.showWarningMessage("No models found from Antigravity");return}if(e.action==="models"){let t=await et.getCachedModels();if(t.length===0&&(t=await et.getModels()),t.length>0){let o=t.map(r=>`\u2022 ${r.displayName}`).join(`
`);xt.window.showInformationMessage(`Available Antigravity models (${t.length}):
${o}`,{modal:!1})}else xt.window.showWarningMessage("No models available from Antigravity");return}return}await Lm(!1)}async function ib(){await Lm(!0)}function kM(n){return n.startsWith("models/")?n.substring(7):n}var tb,na,xt,Nm,nb,Om,hM,yt,et,Wr=ke(()=>{"use strict";tb=D(require("node:http")),na=require("node:url"),xt=D(require("vscode"));sr();Ke();ot();ao();Nm="1071006060591-tmhssin2h21lcre235vtolojh4g403ep.apps.googleusercontent.com",nb="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",Om=51121,hM=["https://www.googleapis.com/auth/cloud-platform","https://www.googleapis.com/auth/userinfo.email","https://www.googleapis.com/auth/userinfo.profile","https://www.googleapis.com/auth/cclog","https://www.googleapis.com/auth/experimentsandconfigs"],yt="antigravity";et=class n{static async getProjectId(){let e=await R.getApiKey(yt);if(!e)return"";try{return(JSON.parse(e).project_id||"").trim()}catch{return""}}static async ensureProjectId(e){let t=await n.getProjectId();if(t)return t;let o=e||await n.getAccessToken();if(!o)return"";let r=await ob(o);if(!r)return"";let i=await R.getApiKey(yt);if(i)try{let a=JSON.parse(i);a.project_id=r,await R.setApiKey(yt,JSON.stringify(a))}catch{}return r}static async getAccessToken(){let e=await R.getApiKey(yt);if(!e)return null;try{let t=JSON.parse(e);return new Date(t.expires_at).getTime()-Date.now()>300*1e3?t.access_token:(await n.refreshToken(t.refresh_token))?.accessToken||null}catch{return null}}static async refreshToken(e,t){try{let o=new na.URLSearchParams;o.set("client_id",Nm),o.set("client_secret",nb),o.set("refresh_token",e),o.set("grant_type","refresh_token");let r=await fetch("https://oauth2.googleapis.com/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:o.toString()}),i=await r.text(),a=lc(i);if(!a||!r.ok)return null;let s=await R.getApiKey(yt),c=new Date(Date.now()+a.expires_in*1e3).toISOString();if(t?.persist!==!1&&s){let l=JSON.parse(s);l.access_token=a.access_token,l.expires_at=c,l.timestamp=Date.now(),await R.setApiKey(yt,JSON.stringify(l))}return{accessToken:a.access_token,expiresAt:c}}catch{return null}}static async logout(){await R.deleteApiKey(yt),xt.window.showInformationMessage("Antigravity logged out successfully")}static async isLoggedIn(){return!!await R.getApiKey(yt)}static async fetchModels(e){let o=vt[yt].models.map(a=>({id:a.id,name:a.name,displayName:a.name,ownedBy:"antigravity",maxTokens:a.maxInputTokens,maxOutputTokens:a.maxOutputTokens,quotaInfo:void 0})),r=["daily-cloudcode-pa.sandbox.googleapis.com","cloudcode-pa.googleapis.com"],i=new Map;for(let a of r)if(i=await n.tryFetchQuotaFromEndpoint(e,a),i.size>0)break;return o.map(a=>({...a,quotaInfo:i.get(a.id.toLowerCase())}))}static async tryFetchQuotaFromEndpoint(e,t){try{let o=await fetch(`https://${t}/v1internal:fetchAvailableModels`,{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json","User-Agent":"antigravity/1.11.5"},body:JSON.stringify({})});if(!o.ok)return new Map;let r=await o.text(),i=lc(r);if(!i?.models)return new Map;let a=new Map;for(let s of Object.keys(i.models)){let c=kM(s),l=i.models[s];c&&l?.quotaInfo&&a.set(c.toLowerCase(),{remainingFraction:l.quotaInfo.remainingFraction,resetTime:l.quotaInfo.resetTime})}return a}catch{return new Map}}static async getModels(){let e=await n.getAccessToken();return e?n.fetchModels(e):[]}static async getCachedModels(){let e=await R.getApiKey(yt);if(!e)return[];try{let o=JSON.parse(e).models||[];return vt[yt].models.map(i=>{let a=o.find(s=>s.id.toLowerCase()===i.id.toLowerCase());return{id:i.id,name:i.name,displayName:i.name,ownedBy:"antigravity",maxTokens:i.maxInputTokens,maxOutputTokens:i.maxOutputTokens,quotaInfo:a?.quotaInfo}})}catch{return[]}}static async refreshModels(){let e=await n.getAccessToken();if(!e)return[];let t=await n.fetchModels(e),o=await R.getApiKey(yt);if(o)try{let r=JSON.parse(o);r.models=t,await R.setApiKey(yt,JSON.stringify(r))}catch{}return t}}});var ab={};io(ab,{AccountManagerPage:()=>Jr,registerAccountManagerPageCommand:()=>_M});function _M(n){return kn.commands.registerCommand("chp.accounts.openManager",()=>{Jr.getInstance().show(n)})}var kn,Jr,Cu=ke(()=>{"use strict";kn=D(require("vscode"));sr();fx();gx();ce();Vr();cr();Jr=class n{static instance;static antigravityQuotaNotice=null;panel;accountManager;disposables=[];static providers=[{id:"antigravity",name:"Antigravity (Google)",authType:"oauth"},{id:"zhipu",name:"ZhipuAI (GLM Coding Plan)",authType:"apiKey"}];constructor(){this.accountManager=Ne.getInstance(),this.disposables.push(this.accountManager.onAccountChange(()=>{this.refreshWebview().catch(t=>u.warn("Failed to refresh account manager:",t))}));let e=it.getInstance();this.disposables.push(e.onQuotaStateChange(t=>{this.sendQuotaStateUpdate(t)}))}sendQuotaStateUpdate(e){this.panel&&this.sendToWebview({command:"updateAccountQuotaState",accountId:e.accountId,provider:e.provider,state:{accountId:e.state.accountId,accountName:e.state.accountName,provider:e.state.provider,quotaExceeded:e.state.quotaExceeded,quotaResetAt:e.state.quotaResetAt,affectedModel:e.state.affectedModel,lastError:e.state.lastError,successCount:e.state.successCount,failureCount:e.state.failureCount,lastSuccessAt:e.state.lastSuccessAt,lastFailureAt:e.state.lastFailureAt,updatedAt:e.state.updatedAt}})}static getInstance(){return n.instance||(n.instance=new n),n.instance}async show(e){if(this.panel){this.panel.reveal(kn.ViewColumn.One);return}let t=e?.extensionUri||kn.Uri.file(`${__dirname}/../..`);this.panel=kn.window.createWebviewPanel("chpAccountManager","Account Manager",kn.ViewColumn.One,{enableScripts:!0,retainContextWhenHidden:!0,localResourceRoots:[kn.Uri.joinPath(t,"images")]});let o=this.getImageUris(this.panel.webview,t);this.panel.webview.html=this.generateHTML(o),this.panel.webview.onDidReceiveMessage(async r=>{await this.handleMessage(r)},void 0,this.disposables),this.panel.onDidDispose(()=>{this.panel=void 0},void 0,this.disposables),u.info("Account Manager page opened")}static updateAntigravityQuotaNotice(e){n.antigravityQuotaNotice=e,n.instance?.panel&&n.instance.sendToWebview({command:"updateAntigravityQuota",notice:e})}getImageUris(e,t){let o={},r={codex:"codex.png",deepseek:"deepseek.png",zhipu:"z-ai.svg"};for(let[i,a]of Object.entries(r)){let s=kn.Uri.joinPath(t,"images",a);o[i]=e.asWebviewUri(s).toString()}return o}generateHTML(e={}){let t="[]",o="[]",r="null",i="[]",a="[]";try{let s=this.accountManager.getAllAccounts();t=JSON.stringify(s)}catch(s){u.error("Failed to get accounts:",s)}try{o=JSON.stringify(n.providers)}catch(s){u.error("Failed to serialize providers:",s)}try{r=JSON.stringify(n.antigravityQuotaNotice)}catch(s){u.error("Failed to serialize antigravity quota:",s)}try{let c=it.getInstance().getAllStates();i=JSON.stringify(c.map(l=>({accountId:l.accountId,accountName:l.accountName,provider:l.provider,quotaExceeded:l.quotaExceeded,quotaResetAt:l.quotaResetAt,affectedModel:l.affectedModel,lastError:l.lastError,successCount:l.successCount,failureCount:l.failureCount,lastSuccessAt:l.lastSuccessAt,lastFailureAt:l.lastFailureAt,updatedAt:l.updatedAt})))}catch(s){u.error("Failed to get account quota states:",s)}try{a="[]"}catch(s){u.error("Failed to get codex rate limits:",s)}return`<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Account Manager</title>
        <meta http-equiv="Content-Security-Policy" content="default-src 'none'; style-src 'unsafe-inline'; script-src 'unsafe-inline';" />
        <style>
            ${mx}
        </style>
    </head>
    <body>
        <div class="container">
            <div id="app">
                <div class="empty-state">
                    <div class="loading-spinner"></div>
                    <p>Loading...</p>
                </div>
            </div>
        </div>
        <script>
            ${hx}

            // Initialize with data
            const initialAccounts = ${t};
            const initialProviders = ${o};
            const initialAntigravityQuota = ${r};
            const initialCodexRateLimits = ${a};
            const initialAccountQuotaStates = ${i};
            const initialProviderImageUris = ${JSON.stringify(e)};

            // Always wait for DOM to be fully ready
            function safeInitialize() {
                try {
                    console.log('[AccountManager] Starting initialization...');
                    initializeAccountManager(initialAccounts, initialProviders, initialAntigravityQuota, initialCodexRateLimits, initialAccountQuotaStates, initialProviderImageUris);
                    console.log('[AccountManager] Initialization complete');
                } catch (error) {
                    console.error('[AccountManager] Initialization error:', error);
                    const app = document.getElementById('app');
                    if (app) {
                        app.innerHTML = '<div class="empty-state"><p style="color: red;">Error: ' + (error.message || error) + '</p></div>';
                    }
                }
            }
            
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', safeInitialize);
            } else {
                // DOM is already ready, but use setTimeout to ensure all scripts are loaded
                setTimeout(safeInitialize, 0);
            }
        </script>
    </body>
</html>`}async handleMessage(e){switch(e.command){case"addApiKeyAccount":await this.handleAddApiKeyAccount(e.provider,e.displayName,e.apiKey,e.endpoint);break;case"addOAuthAccount":await this.handleAddOAuthAccount(e.provider);break;case"setDefaultAccount":await this.handleSetDefaultAccount(e.accountId);break;case"deleteAccount":await this.handleDeleteAccount(e.accountId);break;case"refresh":await this.refreshWebview();break;case"openSettings":await kn.commands.executeCommand("chp.openSettings");break;case"checkQuota":await this.handleCheckQuota(e.accountId);break}}async handleAddApiKeyAccount(e,t,o,r){try{let i=await this.accountManager.addApiKeyAccount(e,t,o,{endpoint:r});i.success?(this.sendToWebview({command:"showToast",message:`Account "${t}" added successfully!`,type:"success"}),await this.refreshWebview()):this.sendToWebview({command:"showToast",message:`Failed to add account: ${i.error}`,type:"error"})}catch(i){u.error("Failed to add API key account:",i),this.sendToWebview({command:"showToast",message:"Failed to add account. Please try again.",type:"error"})}}async handleAddOAuthAccount(e){try{if(e==="antigravity"){let{doAntigravityLoginForNewAccount:t}=await Promise.resolve().then(()=>(Wr(),zm));await t(),await this.refreshWebview()}else if(e===xn.Codex){let{doCodexLoginForNewAccount:t}=await import("../providers/codex/codexAuth.js");await t(),await this.refreshWebview()}}catch(t){u.error("OAuth login failed:",t),this.sendToWebview({command:"showToast",message:"OAuth login failed. Please try again.",type:"error"})}}async handleSetDefaultAccount(e){try{let t=this.accountManager.getAccount(e);if(!t){this.sendToWebview({command:"showToast",message:"Account not found",type:"error"});return}await this.accountManager.switchAccount(t.provider,e),this.sendToWebview({command:"showToast",message:`"${t.displayName}" is now the default account`,type:"success"}),await this.refreshWebview()}catch(t){u.error("Failed to set default account:",t),this.sendToWebview({command:"showToast",message:"Failed to set default account",type:"error"})}}async handleCheckQuota(e){try{let t=this.accountManager.getAccount(e);if(!t){this.sendToWebview({command:"quotaCheckResult",accountId:e,success:!1,error:"Account not found"});return}if(t.provider!=="antigravity"){this.sendToWebview({command:"quotaCheckResult",accountId:e,success:!0,message:"Quota check not needed for this provider"});return}let r=this.accountManager.getActiveAccount(t.provider)?.id;await this.accountManager.switchAccount(t.provider,e),await kn.commands.executeCommand("chp.antigravity.refreshAndShowQuota"),await new Promise(i=>setTimeout(i,1e3)),r&&r!==e&&await this.accountManager.switchAccount(t.provider,r),this.sendToWebview({command:"quotaCheckResult",accountId:e,success:!0,message:"Quota refresh triggered"})}catch(t){u.error("Failed to check quota:",t),this.sendToWebview({command:"quotaCheckResult",accountId:e,success:!1,error:t instanceof Error?t.message:"Unknown error"})}}async handleDeleteAccount(e){try{let o=this.accountManager.getAccount(e)?.displayName||"Account";await this.accountManager.removeAccount(e)?(this.sendToWebview({command:"showToast",message:`"${o}" has been deleted`,type:"success"}),this.refreshWebview()):this.sendToWebview({command:"showToast",message:"Failed to delete account",type:"error"})}catch(t){u.error("Failed to delete account:",t),this.sendToWebview({command:"showToast",message:"Failed to delete account",type:"error"})}}async refreshWebview(){if(!this.panel)return;let e=this.accountManager.getAllAccounts(),t=[];for(let o of e){let r=await this.accountManager.getCredentials(o.id);r&&"endpoint"in r&&r.endpoint&&t.push({id:o.id,endpoint:r.endpoint})}this.sendToWebview({command:"updateAccounts",accounts:e,accountEndpoints:t})}sendToWebview(e){this.panel&&this.panel.webview.postMessage(e)}dispose(){this.panel&&this.panel.dispose();for(let e of this.disposables)e.dispose();this.disposables=[],n.instance=void 0}}});var Qw=U(yo=>{"use strict";Object.defineProperty(yo,"__esModule",{value:!0});yo.bytePairEncode=yo.BinaryMap=yo.binaryMapKey=void 0;var C$=(n,e,t)=>{let o=t-e,r=16777215>>>Math.max(0,(3-o)*8),i=(n[e+0]|n[e+1]<<8|n[e+2]<<16)&r,a=16777215>>>Math.min(31,Math.max(0,(6-o)*8)),s=(n[e+3]|n[e+4]<<8|n[e+5]<<16)&a;return i+16777216*s};yo.binaryMapKey=C$;var Vf=class n{constructor(){this.nested=new Map,this.final=new Map}get(e,t=0,o=e.length){let r=o<6+t,i=(0,yo.binaryMapKey)(e,t,o);return r?this.final.get(i):this.nested.get(i)?.get(e,6+t,o)}set(e,t){let o=(0,yo.binaryMapKey)(e,0,e.length);if(e.length<6){this.final.set(o,t);return}let i=this.nested.get(o);if(i instanceof n)i.set(e.subarray(6),t);else{let a=new n;a.set(e.subarray(6),t),this.nested.set(o,a)}}};yo.BinaryMap=Vf;var vo=new Int32Array(128),tn=new Int32Array(128);function T$(n,e,t){if(t===1)return[e.get(n)];let o=2147483647,r=-1;for(;vo.length<t*2;)tn=new Int32Array(tn.length*2),vo=new Int32Array(vo.length*2);for(let c=0;c<t-1;c++){let l=e.get(n,c,c+2)??2147483647;l<o&&(o=l,r=c),tn[c]=c,vo[c]=l}tn[t-1]=t-1,vo[t-1]=2147483647,tn[t]=t,vo[t]=2147483647;let i=t+1;function a(c,l=0){if(c+l+2<i){let d=e.get(n,tn[c],tn[c+l+2]);if(d!==void 0)return d}return 2147483647}for(;o!==2147483647;){vo[tn[r]]=a(r,1),r>0&&(vo[tn[r-1]]=a(r-1,1));for(let c=r+1;c<i-1;c++)tn[c]=tn[c+1];i--,r=-1,o=2147483647;for(let c=0;c<i-1;c++){let l=vo[tn[c]];vo[tn[c]]<o&&(o=l,r=c)}}let s=[];for(let c=0;c<i-1;c++)s.push(e.get(n,tn[c],tn[c+1]));return s}yo.bytePairEncode=T$});var Ww=U(Sd=>{"use strict";Object.defineProperty(Sd,"__esModule",{value:!0});Sd.makeTextEncoder=void 0;var Qf=class{constructor(){this.length=0,this.encoder=new TextEncoder}encode(e){let t=this.encoder.encode(e);return this.length=t.length,t}},Wf=class{constructor(){this.buffer=Buffer.alloc(256),this.length=0}encode(e){for(;;){if(this.length=this.buffer.write(e,"utf8"),this.length<this.buffer.length-4)return this.buffer;this.buffer=Buffer.alloc(this.length*2),this.length=this.buffer.write(e)}}},I$=()=>typeof Buffer<"u"?new Wf:new Qf;Sd.makeTextEncoder=I$});var Jw=U($d=>{"use strict";Object.defineProperty($d,"__esModule",{value:!0});$d.LRUCache=void 0;var Jf=class{constructor(e){this.size=e,this.nodes=new Map}get(e){let t=this.nodes.get(e);if(t)return this.moveToHead(t),t.value}set(e,t){let o=this.nodes.get(e);if(o)o.value=t,this.moveToHead(o);else{let r=new Xf(e,t);this.nodes.set(e,r),this.addNode(r),this.nodes.size>this.size&&(this.nodes.delete(this.tail.key),this.removeNode(this.tail))}}moveToHead(e){this.removeNode(e),e.next=void 0,e.prev=void 0,this.addNode(e)}addNode(e){this.head&&(this.head.prev=e,e.next=this.head),this.tail||(this.tail=e),this.head=e}removeNode(e){e.prev?e.prev.next=e.next:this.head=e.next,e.next?e.next.prev=e.prev:this.tail=e.prev}};$d.LRUCache=Jf;var Xf=class{constructor(e,t){this.key=e,this.value=t}}});var eh=U(Rd=>{"use strict";Object.defineProperty(Rd,"__esModule",{value:!0});Rd.TikTokenizer=void 0;var Ed=Qw(),A$=Ww(),P$=Jw();function M$(n){let e=new Map;try{let r=require("fs").readFileSync(n,"utf-8");return t(r),e}catch(o){throw new Error(`Failed to load from BPE encoder file stream: ${o}`)}function t(o){for(let r of o.split(/[\r\n]+/)){if(r.trim()==="")continue;let i=r.split(" ");if(i.length!==2)throw new Error("Invalid format in the BPE encoder file stream");let a=new Uint8Array(Buffer.from(i[0],"base64")),s=parseInt(i[1]);if(!isNaN(s))e.set(a,s);else throw new Error(`Can't parse ${i[1]} to integer`)}}}function S$(n){return n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}var Yf=class{constructor(e,t,o,r=8192){this.textEncoder=(0,A$.makeTextEncoder)(),this.textDecoder=new TextDecoder("utf-8"),this.cache=new P$.LRUCache(r);let i=typeof e=="string"?M$(e):e;this.init(i,t,o)}init(e,t,o){this.encoder=new Ed.BinaryMap;for(let[r,i]of e)this.encoder.set(r,i);this.regex=new RegExp(o,"gu"),this.specialTokensRegex=new RegExp(Array.from(t.keys()).map(r=>S$(r)).join("|")),this.specialTokensEncoder=t,this.decoder=new Map;for(let[r,i]of e)this.decoder.set(i,r);if(e.size!==this.decoder.size)throw new Error("Encoder and decoder sizes do not match");this.specialTokensDecoder=new Map;for(let[r,i]of t)this.specialTokensDecoder.set(i,r)}findNextSpecialToken(e,t,o){let r=t,i=null;if(o&&this.specialTokensRegex)for(;i=e.slice(r).match(this.specialTokensRegex),!(!i||o&&o.includes(i[0]));)r+=i.index+1;let a=i?r+i.index:e.length;return[i,a]}encode(e,t){let o=[],r=0;for(;;){let i,a;if([i,a]=this.findNextSpecialToken(e,r,t),a>r&&this.encodeByIndex(e,o,r,a),i){if(r=r+this.encodeSpecialToken(o,i),r>=e.length)break}else break}return o}encodeSpecialToken(e,t){let o=this.specialTokensEncoder?.get(t[0]);return e.push(o),t.index+t[0].length}encodeByIndex(e,t,o,r){let i,a=e.substring(o,r);for(this.regex.lastIndex=0;i=this.regex.exec(a);){let s=this.cache.get(i[0]);if(s)for(let c of s)t.push(c);else{let c=this.textEncoder.encode(i[0]),l=this.encoder.get(c,0,this.textEncoder.length);if(l!==void 0)t.push(l),this.cache.set(i[0],[l]);else{let d=(0,Ed.bytePairEncode)(c,this.encoder,this.textEncoder.length);for(let p of d)t.push(p);this.cache.set(i[0],d)}}}}encodeTrimSuffixByIndex(e,t,o,r,i,a,s){let c,l=e.substring(o,r);for(this.regex.lastIndex=0;c=this.regex.exec(l);){let d=c[0],p=this.cache.get(d);if(p)if(a+p.length<=i)a+=p.length,s+=d.length,t.push(...p);else{let f=i-a;a+=f,s+=d.length,t.push(...p.slice(0,f));break}else{let f=this.textEncoder.encode(d),m=this.encoder.get(f,0,f.length);if(m!==void 0)if(this.cache.set(d,[m]),a+1<=i)a++,s+=d.length,t.push(m);else break;else{let h=(0,Ed.bytePairEncode)(f,this.encoder,this.textEncoder.length);if(this.cache.set(d,h),a+h.length<=i){a+=h.length,s+=d.length;for(let g of h)t.push(g)}else{let g=i-a;a+=g,s+=d.length;for(let v=0;v<g;v++)t.push(h[v]);break}}}if(a>=i)break}return{tokenCount:a,encodeLength:s}}encodeTrimSuffix(e,t,o){let r=[],i=0,a=0,s=0;for(;;){let l,d;if([l,d]=this.findNextSpecialToken(e,i,o),d>i){let{tokenCount:p,encodeLength:f}=this.encodeTrimSuffixByIndex(e,r,i,d,t,a,s);if(a=p,s=f,a>=t)break}if(l!==null){if(a++,a<=t&&(i=i+this.encodeSpecialToken(r,l),s+=l[0].length,i>=e.length)||a>=t)break}else break}let c=s===e.length?e:e.slice(0,s);return{tokenIds:r,text:c}}encodeTrimPrefix(e,t,o){let r=[],i=0,a=0,s=0,c=new Map;for(c.set(a,s);;){let f,m;if([f,m]=this.findNextSpecialToken(e,i,o),m>i){let h,g=e.substring(i,m);for(this.regex.lastIndex=0;h=this.regex.exec(g);){let v=h[0],k=this.cache.get(v);if(k)a+=k.length,s+=v.length,r.push(...k),c.set(a,s);else{let x=this.textEncoder.encode(v),y=this.encoder.get(x);if(y!==void 0)this.cache.set(v,[y]),a++,s+=v.length,r.push(y),c.set(a,s);else{let w=(0,Ed.bytePairEncode)(x,this.encoder,this.textEncoder.length);this.cache.set(v,w),a+=w.length,s+=v.length;for(let b of w)r.push(b);c.set(a,s)}}}}if(f!==null){if(i=i+this.encodeSpecialToken(r,f),a++,s+=f[0].length,c.set(a,s),i>=e.length)break}else break}if(a<=t)return{tokenIds:r,text:e};let l=a-t,d=0,p=0;for(let[f,m]of c)if(f>=l){d=f,p=m;break}if(d>t){let f=this.encode(e,o),m=f.slice(f.length-t);return{tokenIds:m,text:this.decode(m)}}return{tokenIds:r.slice(d),text:e.slice(p)}}decode(e){let t=[];for(let o of e){let r=[],i=this.decoder?.get(o);if(i!==void 0)r=Array.from(i);else{let a=this.specialTokensDecoder?.get(o);if(a!==void 0){let s=this.textEncoder.encode(a);r=Array.from(s.subarray(0,this.textEncoder.length))}}t.push(...r)}return this.textDecoder.decode(new Uint8Array(t))}};Rd.TikTokenizer=Yf});var sk=U(pt=>{"use strict";Object.defineProperty(pt,"__esModule",{value:!0});pt.createTokenizer=pt.createByEncoderName=pt.createByModelName=pt.getRegexByModel=pt.getRegexByEncoder=pt.getSpecialTokensByModel=pt.getSpecialTokensByEncoder=pt.MODEL_TO_ENCODING=void 0;var $$=eh(),E$=new Map([["gpt-4o-","o200k_base"],["gpt-4-","cl100k_base"],["gpt-3.5-turbo-","cl100k_base"],["gpt-35-turbo-","cl100k_base"]]);pt.MODEL_TO_ENCODING=new Map([["gpt-4o","o200k_base"],["gpt-4","cl100k_base"],["gpt-3.5-turbo","cl100k_base"],["text-davinci-003","p50k_base"],["text-davinci-002","p50k_base"],["text-davinci-001","r50k_base"],["text-curie-001","r50k_base"],["text-babbage-001","r50k_base"],["text-ada-001","r50k_base"],["davinci","r50k_base"],["curie","r50k_base"],["babbage","r50k_base"],["ada","r50k_base"],["code-davinci-002","p50k_base"],["code-davinci-001","p50k_base"],["code-cushman-002","p50k_base"],["code-cushman-001","p50k_base"],["davinci-codex","p50k_base"],["cushman-codex","p50k_base"],["text-davinci-edit-001","p50k_edit"],["code-davinci-edit-001","p50k_edit"],["text-embedding-ada-002","cl100k_base"],["text-similarity-davinci-001","r50k_base"],["text-similarity-curie-001","r50k_base"],["text-similarity-babbage-001","r50k_base"],["text-similarity-ada-001","r50k_base"],["text-search-davinci-doc-001","r50k_base"],["text-search-curie-doc-001","r50k_base"],["text-search-babbage-doc-001","r50k_base"],["text-search-ada-doc-001","r50k_base"],["code-search-babbage-code-001","r50k_base"],["code-search-ada-code-001","r50k_base"],["gpt2","gpt2"]]);var Od="<|endoftext|>",Xw="<|fim_prefix|>",Yw="<|fim_middle|>",ek="<|fim_suffix|>",tk="<|endofprompt|>",Yc="'s|'t|'re|'ve|'m|'ll|'d| ?\\p{L}+| ?\\p{N}+| ?[^\\s\\p{L}\\p{N}]+|\\s+(?!\\S)|\\s+",nk="(?:'s|'S|'t|'T|'re|'RE|'Re|'eR|'ve|'VE|'vE|'Ve|'m|'M|'ll|'lL|'Ll|'LL|'d|'D)|[^\\r\\n\\p{L}\\p{N}]?\\p{L}+|\\p{N}{1,3}| ?[^\\s\\p{L}\\p{N}]+[\\r\\n]*|\\s*[\\r\\n]+|\\s+(?!\\S)|\\s+",R$=[`[^\r
\\p{L}\\p{N}]?[\\p{Lu}\\p{Lt}\\p{Lm}\\p{Lo}\\p{M}]*[\\p{Ll}\\p{Lm}\\p{Lo}\\p{M}]+(?:'s|'S|'t|'T|'re|'RE|'Re|'eR|'ve|'VE|'vE|'Ve|'m|'M|'ll|'lL|'Ll|'LL|'d|'D)?`,`[^\r
\\p{L}\\p{N}]?[\\p{Lu}\\p{Lt}\\p{Lm}\\p{Lo}\\p{M}]+[\\p{Ll}\\p{Lm}\\p{Lo}\\p{M}]*(?:'s|'S|'t|'T|'re|'RE|'Re|'eR|'ve|'VE|'vE|'Ve|'m|'M|'ll|'lL|'Ll|'LL|'d|'D)?`,"\\p{N}{1,3}"," ?[^\\s\\p{L}\\p{N}]+[\\r\\n/]*","\\s*[\\r\\n]+","\\s+(?!\\S)","\\s+"],ok=R$.join("|");function th(n){let e="";if(pt.MODEL_TO_ENCODING.has(n))e=pt.MODEL_TO_ENCODING.get(n);else for(let[t,o]of E$)if(n.startsWith(t)){e=o;break}return e}async function O$(n,e){let t=require("fs"),o=await fetch(n);if(!o.ok)throw new Error(`Failed to fetch file from ${n}. Status code: ${o.status}`);let r=await o.text();t.writeFileSync(e,r)}function nh(n){let e=new Map([[Od,50256]]);switch(n){case"o200k_base":e=new Map([[Od,199999],[tk,200018]]);break;case"cl100k_base":e=new Map([[Od,100257],[Xw,100258],[Yw,100259],[ek,100260],[tk,100276]]);break;case"p50k_edit":e=new Map([[Od,50256],[Xw,50281],[Yw,50282],[ek,50283]]);break;default:break}return e}pt.getSpecialTokensByEncoder=nh;function L$(n){let e=th(n);return nh(e)}pt.getSpecialTokensByModel=L$;function rk(n){switch(n){case"o200k_base":return ok;case"cl100k_base":return nk;default:break}return Yc}pt.getRegexByEncoder=rk;function N$(n){let e=th(n);return rk(e)}pt.getRegexByModel=N$;async function z$(n,e=null){return ik(th(n),e)}pt.createByModelName=z$;async function ik(n,e=null){let t,o,r=nh(n);switch(n){case"o200k_base":t=ok,o="https://openaipublic.blob.core.windows.net/encodings/o200k_base.tiktoken";break;case"cl100k_base":t=nk,o="https://openaipublic.blob.core.windows.net/encodings/cl100k_base.tiktoken";break;case"p50k_base":t=Yc,o="https://openaipublic.blob.core.windows.net/encodings/p50k_base.tiktoken";break;case"p50k_edit":t=Yc,o="https://openaipublic.blob.core.windows.net/encodings/p50k_base.tiktoken";break;case"r50k_base":t=Yc,o="https://openaipublic.blob.core.windows.net/encodings/r50k_base.tiktoken";break;case"gpt2":t=Yc,o="https://raw.githubusercontent.com/microsoft/Tokenizer/main/model/gpt2.tiktoken";break;default:throw new Error(`Doesn't support this encoder [${n}]`)}e!==null&&(r=new Map([...r,...e]));let i=require("fs"),a=require("path"),s=a.basename(o),c=a.resolve(__dirname,"..","model");i.existsSync(c)||i.mkdirSync(c,{recursive:!0});let l=a.resolve(c,s);return i.existsSync(l)||(console.log(`Downloading file from ${o}`),await O$(o,l),console.log(`Saved file to ${l}`)),ak(l,r,t)}pt.createByEncoderName=ik;function ak(n,e,t,o=8192){return new $$.TikTokenizer(n,e,t,o)}pt.createTokenizer=ak});var ck=U(mt=>{"use strict";Object.defineProperty(mt,"__esModule",{value:!0});mt.createTokenizer=mt.createByEncoderName=mt.createByModelName=mt.getSpecialTokensByModel=mt.getSpecialTokensByEncoder=mt.getRegexByModel=mt.getRegexByEncoder=mt.MODEL_TO_ENCODING=mt.TikTokenizer=void 0;var D$=eh();Object.defineProperty(mt,"TikTokenizer",{enumerable:!0,get:function(){return D$.TikTokenizer}});var Rr=sk();Object.defineProperty(mt,"MODEL_TO_ENCODING",{enumerable:!0,get:function(){return Rr.MODEL_TO_ENCODING}});Object.defineProperty(mt,"getRegexByEncoder",{enumerable:!0,get:function(){return Rr.getRegexByEncoder}});Object.defineProperty(mt,"getRegexByModel",{enumerable:!0,get:function(){return Rr.getRegexByModel}});Object.defineProperty(mt,"getSpecialTokensByEncoder",{enumerable:!0,get:function(){return Rr.getSpecialTokensByEncoder}});Object.defineProperty(mt,"getSpecialTokensByModel",{enumerable:!0,get:function(){return Rr.getSpecialTokensByModel}});Object.defineProperty(mt,"createByModelName",{enumerable:!0,get:function(){return Rr.createByModelName}});Object.defineProperty(mt,"createByEncoderName",{enumerable:!0,get:function(){return Rr.createByEncoderName}});Object.defineProperty(mt,"createTokenizer",{enumerable:!0,get:function(){return Rr.createTokenizer}})});var Il=U(ye=>{"use strict";Object.defineProperty(ye,"__esModule",{value:!0});ye.regexpCode=ye.getEsmExportName=ye.getProperty=ye.safeStringify=ye.stringify=ye.strConcat=ye.addCodeArg=ye.str=ye._=ye.nil=ye._Code=ye.Name=ye.IDENTIFIER=ye._CodeOrName=void 0;var Cl=class{};ye._CodeOrName=Cl;ye.IDENTIFIER=/^[a-z$_][a-z$_0-9]*$/i;var Li=class extends Cl{constructor(e){if(super(),!ye.IDENTIFIER.test(e))throw new Error("CodeGen: name must be a valid identifier");this.str=e}toString(){return this.str}emptyStr(){return!1}get names(){return{[this.str]:1}}};ye.Name=Li;var Dn=class extends Cl{constructor(e){super(),this._items=typeof e=="string"?[e]:e}toString(){return this.str}emptyStr(){if(this._items.length>1)return!1;let e=this._items[0];return e===""||e==='""'}get str(){var e;return(e=this._str)!==null&&e!==void 0?e:this._str=this._items.reduce((t,o)=>`${t}${o}`,"")}get names(){var e;return(e=this._names)!==null&&e!==void 0?e:this._names=this._items.reduce((t,o)=>(o instanceof Li&&(t[o.str]=(t[o.str]||0)+1),t),{})}};ye._Code=Dn;ye.nil=new Dn("");function oT(n,...e){let t=[n[0]],o=0;for(;o<e.length;)Dg(t,e[o]),t.push(n[++o]);return new Dn(t)}ye._=oT;var zg=new Dn("+");function rT(n,...e){let t=[Tl(n[0])],o=0;for(;o<e.length;)t.push(zg),Dg(t,e[o]),t.push(zg,Tl(n[++o]));return l1(t),new Dn(t)}ye.str=rT;function Dg(n,e){e instanceof Dn?n.push(...e._items):e instanceof Li?n.push(e):n.push(p1(e))}ye.addCodeArg=Dg;function l1(n){let e=1;for(;e<n.length-1;){if(n[e]===zg){let t=u1(n[e-1],n[e+1]);if(t!==void 0){n.splice(e-1,3,t);continue}n[e++]="+"}e++}}function u1(n,e){if(e==='""')return n;if(n==='""')return e;if(typeof n=="string")return e instanceof Li||n[n.length-1]!=='"'?void 0:typeof e!="string"?`${n.slice(0,-1)}${e}"`:e[0]==='"'?n.slice(0,-1)+e.slice(1):void 0;if(typeof e=="string"&&e[0]==='"'&&!(n instanceof Li))return`"${n}${e.slice(1)}`}function d1(n,e){return e.emptyStr()?n:n.emptyStr()?e:rT`${n}${e}`}ye.strConcat=d1;function p1(n){return typeof n=="number"||typeof n=="boolean"||n===null?n:Tl(Array.isArray(n)?n.join(","):n)}function m1(n){return new Dn(Tl(n))}ye.stringify=m1;function Tl(n){return JSON.stringify(n).replace(/\u2028/g,"\\u2028").replace(/\u2029/g,"\\u2029")}ye.safeStringify=Tl;function f1(n){return typeof n=="string"&&ye.IDENTIFIER.test(n)?new Dn(`.${n}`):oT`[${n}]`}ye.getProperty=f1;function h1(n){if(typeof n=="string"&&ye.IDENTIFIER.test(n))return new Dn(`${n}`);throw new Error(`CodeGen: invalid export name: ${n}, use explicit $id name mapping`)}ye.getEsmExportName=h1;function g1(n){return new Dn(n.toString())}ye.regexpCode=g1});var Bg=U(fn=>{"use strict";Object.defineProperty(fn,"__esModule",{value:!0});fn.ValueScope=fn.ValueScopeName=fn.Scope=fn.varKinds=fn.UsedValueState=void 0;var mn=Il(),qg=class extends Error{constructor(e){super(`CodeGen: "code" for ${e} not defined`),this.value=e.value}},fp;(function(n){n[n.Started=0]="Started",n[n.Completed=1]="Completed"})(fp||(fn.UsedValueState=fp={}));fn.varKinds={const:new mn.Name("const"),let:new mn.Name("let"),var:new mn.Name("var")};var hp=class{constructor({prefixes:e,parent:t}={}){this._names={},this._prefixes=e,this._parent=t}toName(e){return e instanceof mn.Name?e:this.name(e)}name(e){return new mn.Name(this._newName(e))}_newName(e){let t=this._names[e]||this._nameGroup(e);return`${e}${t.index++}`}_nameGroup(e){var t,o;if(!((o=(t=this._parent)===null||t===void 0?void 0:t._prefixes)===null||o===void 0)&&o.has(e)||this._prefixes&&!this._prefixes.has(e))throw new Error(`CodeGen: prefix "${e}" is not allowed in this scope`);return this._names[e]={prefix:e,index:0}}};fn.Scope=hp;var gp=class extends mn.Name{constructor(e,t){super(t),this.prefix=e}setValue(e,{property:t,itemIndex:o}){this.value=e,this.scopePath=(0,mn._)`.${new mn.Name(t)}[${o}]`}};fn.ValueScopeName=gp;var v1=(0,mn._)`\n`,Fg=class extends hp{constructor(e){super(e),this._values={},this._scope=e.scope,this.opts={...e,_n:e.lines?v1:mn.nil}}get(){return this._scope}name(e){return new gp(e,this._newName(e))}value(e,t){var o;if(t.ref===void 0)throw new Error("CodeGen: ref must be passed in value");let r=this.toName(e),{prefix:i}=r,a=(o=t.key)!==null&&o!==void 0?o:t.ref,s=this._values[i];if(s){let d=s.get(a);if(d)return d}else s=this._values[i]=new Map;s.set(a,r);let c=this._scope[i]||(this._scope[i]=[]),l=c.length;return c[l]=t.ref,r.setValue(t,{property:i,itemIndex:l}),r}getValue(e,t){let o=this._values[e];if(o)return o.get(t)}scopeRefs(e,t=this._values){return this._reduceValues(t,o=>{if(o.scopePath===void 0)throw new Error(`CodeGen: name "${o}" has no value`);return(0,mn._)`${e}${o.scopePath}`})}scopeCode(e=this._values,t,o){return this._reduceValues(e,r=>{if(r.value===void 0)throw new Error(`CodeGen: name "${r}" has no value`);return r.value.code},t,o)}_reduceValues(e,t,o={},r){let i=mn.nil;for(let a in e){let s=e[a];if(!s)continue;let c=o[a]=o[a]||new Map;s.forEach(l=>{if(c.has(l))return;c.set(l,fp.Started);let d=t(l);if(d){let p=this.opts.es5?fn.varKinds.var:fn.varKinds.const;i=(0,mn._)`${i}${p} ${l} = ${d};${this.opts._n}`}else if(d=r?.(l))i=(0,mn._)`${i}${d}${this.opts._n}`;else throw new qg(l);c.set(l,fp.Completed)})}return i}};fn.ValueScope=Fg});var le=U(de=>{"use strict";Object.defineProperty(de,"__esModule",{value:!0});de.or=de.and=de.not=de.CodeGen=de.operators=de.varKinds=de.ValueScopeName=de.ValueScope=de.Scope=de.Name=de.regexpCode=de.stringify=de.getProperty=de.nil=de.strConcat=de.str=de._=void 0;var ge=Il(),Yn=Bg(),Dr=Il();Object.defineProperty(de,"_",{enumerable:!0,get:function(){return Dr._}});Object.defineProperty(de,"str",{enumerable:!0,get:function(){return Dr.str}});Object.defineProperty(de,"strConcat",{enumerable:!0,get:function(){return Dr.strConcat}});Object.defineProperty(de,"nil",{enumerable:!0,get:function(){return Dr.nil}});Object.defineProperty(de,"getProperty",{enumerable:!0,get:function(){return Dr.getProperty}});Object.defineProperty(de,"stringify",{enumerable:!0,get:function(){return Dr.stringify}});Object.defineProperty(de,"regexpCode",{enumerable:!0,get:function(){return Dr.regexpCode}});Object.defineProperty(de,"Name",{enumerable:!0,get:function(){return Dr.Name}});var bp=Bg();Object.defineProperty(de,"Scope",{enumerable:!0,get:function(){return bp.Scope}});Object.defineProperty(de,"ValueScope",{enumerable:!0,get:function(){return bp.ValueScope}});Object.defineProperty(de,"ValueScopeName",{enumerable:!0,get:function(){return bp.ValueScopeName}});Object.defineProperty(de,"varKinds",{enumerable:!0,get:function(){return bp.varKinds}});de.operators={GT:new ge._Code(">"),GTE:new ge._Code(">="),LT:new ge._Code("<"),LTE:new ge._Code("<="),EQ:new ge._Code("==="),NEQ:new ge._Code("!=="),NOT:new ge._Code("!"),OR:new ge._Code("||"),AND:new ge._Code("&&"),ADD:new ge._Code("+")};var Jo=class{optimizeNodes(){return this}optimizeNames(e,t){return this}},Ug=class extends Jo{constructor(e,t,o){super(),this.varKind=e,this.name=t,this.rhs=o}render({es5:e,_n:t}){let o=e?Yn.varKinds.var:this.varKind,r=this.rhs===void 0?"":` = ${this.rhs}`;return`${o} ${this.name}${r};`+t}optimizeNames(e,t){if(e[this.name.str])return this.rhs&&(this.rhs=Es(this.rhs,e,t)),this}get names(){return this.rhs instanceof ge._CodeOrName?this.rhs.names:{}}},vp=class extends Jo{constructor(e,t,o){super(),this.lhs=e,this.rhs=t,this.sideEffects=o}render({_n:e}){return`${this.lhs} = ${this.rhs};`+e}optimizeNames(e,t){if(!(this.lhs instanceof ge.Name&&!e[this.lhs.str]&&!this.sideEffects))return this.rhs=Es(this.rhs,e,t),this}get names(){let e=this.lhs instanceof ge.Name?{}:{...this.lhs.names};return xp(e,this.rhs)}},jg=class extends vp{constructor(e,t,o,r){super(e,o,r),this.op=t}render({_n:e}){return`${this.lhs} ${this.op}= ${this.rhs};`+e}},Kg=class extends Jo{constructor(e){super(),this.label=e,this.names={}}render({_n:e}){return`${this.label}:`+e}},Hg=class extends Jo{constructor(e){super(),this.label=e,this.names={}}render({_n:e}){return`break${this.label?` ${this.label}`:""};`+e}},Zg=class extends Jo{constructor(e){super(),this.error=e}render({_n:e}){return`throw ${this.error};`+e}get names(){return this.error.names}},Gg=class extends Jo{constructor(e){super(),this.code=e}render({_n:e}){return`${this.code};`+e}optimizeNodes(){return`${this.code}`?this:void 0}optimizeNames(e,t){return this.code=Es(this.code,e,t),this}get names(){return this.code instanceof ge._CodeOrName?this.code.names:{}}},Al=class extends Jo{constructor(e=[]){super(),this.nodes=e}render(e){return this.nodes.reduce((t,o)=>t+o.render(e),"")}optimizeNodes(){let{nodes:e}=this,t=e.length;for(;t--;){let o=e[t].optimizeNodes();Array.isArray(o)?e.splice(t,1,...o):o?e[t]=o:e.splice(t,1)}return e.length>0?this:void 0}optimizeNames(e,t){let{nodes:o}=this,r=o.length;for(;r--;){let i=o[r];i.optimizeNames(e,t)||(y1(e,i.names),o.splice(r,1))}return o.length>0?this:void 0}get names(){return this.nodes.reduce((e,t)=>Di(e,t.names),{})}},Xo=class extends Al{render(e){return"{"+e._n+super.render(e)+"}"+e._n}},Vg=class extends Al{},$s=class extends Xo{};$s.kind="else";var Ni=class n extends Xo{constructor(e,t){super(t),this.condition=e}render(e){let t=`if(${this.condition})`+super.render(e);return this.else&&(t+="else "+this.else.render(e)),t}optimizeNodes(){super.optimizeNodes();let e=this.condition;if(e===!0)return this.nodes;let t=this.else;if(t){let o=t.optimizeNodes();t=this.else=Array.isArray(o)?new $s(o):o}if(t)return e===!1?t instanceof n?t:t.nodes:this.nodes.length?this:new n(iT(e),t instanceof n?[t]:t.nodes);if(!(e===!1||!this.nodes.length))return this}optimizeNames(e,t){var o;if(this.else=(o=this.else)===null||o===void 0?void 0:o.optimizeNames(e,t),!!(super.optimizeNames(e,t)||this.else))return this.condition=Es(this.condition,e,t),this}get names(){let e=super.names;return xp(e,this.condition),this.else&&Di(e,this.else.names),e}};Ni.kind="if";var zi=class extends Xo{};zi.kind="for";var Qg=class extends zi{constructor(e){super(),this.iteration=e}render(e){return`for(${this.iteration})`+super.render(e)}optimizeNames(e,t){if(super.optimizeNames(e,t))return this.iteration=Es(this.iteration,e,t),this}get names(){return Di(super.names,this.iteration.names)}},Wg=class extends zi{constructor(e,t,o,r){super(),this.varKind=e,this.name=t,this.from=o,this.to=r}render(e){let t=e.es5?Yn.varKinds.var:this.varKind,{name:o,from:r,to:i}=this;return`for(${t} ${o}=${r}; ${o}<${i}; ${o}++)`+super.render(e)}get names(){let e=xp(super.names,this.from);return xp(e,this.to)}},yp=class extends zi{constructor(e,t,o,r){super(),this.loop=e,this.varKind=t,this.name=o,this.iterable=r}render(e){return`for(${this.varKind} ${this.name} ${this.loop} ${this.iterable})`+super.render(e)}optimizeNames(e,t){if(super.optimizeNames(e,t))return this.iterable=Es(this.iterable,e,t),this}get names(){return Di(super.names,this.iterable.names)}},Pl=class extends Xo{constructor(e,t,o){super(),this.name=e,this.args=t,this.async=o}render(e){return`${this.async?"async ":""}function ${this.name}(${this.args})`+super.render(e)}};Pl.kind="func";var Ml=class extends Al{render(e){return"return "+super.render(e)}};Ml.kind="return";var Jg=class extends Xo{render(e){let t="try"+super.render(e);return this.catch&&(t+=this.catch.render(e)),this.finally&&(t+=this.finally.render(e)),t}optimizeNodes(){var e,t;return super.optimizeNodes(),(e=this.catch)===null||e===void 0||e.optimizeNodes(),(t=this.finally)===null||t===void 0||t.optimizeNodes(),this}optimizeNames(e,t){var o,r;return super.optimizeNames(e,t),(o=this.catch)===null||o===void 0||o.optimizeNames(e,t),(r=this.finally)===null||r===void 0||r.optimizeNames(e,t),this}get names(){let e=super.names;return this.catch&&Di(e,this.catch.names),this.finally&&Di(e,this.finally.names),e}},Sl=class extends Xo{constructor(e){super(),this.error=e}render(e){return`catch(${this.error})`+super.render(e)}};Sl.kind="catch";var $l=class extends Xo{render(e){return"finally"+super.render(e)}};$l.kind="finally";var Xg=class{constructor(e,t={}){this._values={},this._blockStarts=[],this._constants={},this.opts={...t,_n:t.lines?`
`:""},this._extScope=e,this._scope=new Yn.Scope({parent:e}),this._nodes=[new Vg]}toString(){return this._root.render(this.opts)}name(e){return this._scope.name(e)}scopeName(e){return this._extScope.name(e)}scopeValue(e,t){let o=this._extScope.value(e,t);return(this._values[o.prefix]||(this._values[o.prefix]=new Set)).add(o),o}getScopeValue(e,t){return this._extScope.getValue(e,t)}scopeRefs(e){return this._extScope.scopeRefs(e,this._values)}scopeCode(){return this._extScope.scopeCode(this._values)}_def(e,t,o,r){let i=this._scope.toName(t);return o!==void 0&&r&&(this._constants[i.str]=o),this._leafNode(new Ug(e,i,o)),i}const(e,t,o){return this._def(Yn.varKinds.const,e,t,o)}let(e,t,o){return this._def(Yn.varKinds.let,e,t,o)}var(e,t,o){return this._def(Yn.varKinds.var,e,t,o)}assign(e,t,o){return this._leafNode(new vp(e,t,o))}add(e,t){return this._leafNode(new jg(e,de.operators.ADD,t))}code(e){return typeof e=="function"?e():e!==ge.nil&&this._leafNode(new Gg(e)),this}object(...e){let t=["{"];for(let[o,r]of e)t.length>1&&t.push(","),t.push(o),(o!==r||this.opts.es5)&&(t.push(":"),(0,ge.addCodeArg)(t,r));return t.push("}"),new ge._Code(t)}if(e,t,o){if(this._blockNode(new Ni(e)),t&&o)this.code(t).else().code(o).endIf();else if(t)this.code(t).endIf();else if(o)throw new Error('CodeGen: "else" body without "then" body');return this}elseIf(e){return this._elseNode(new Ni(e))}else(){return this._elseNode(new $s)}endIf(){return this._endBlockNode(Ni,$s)}_for(e,t){return this._blockNode(e),t&&this.code(t).endFor(),this}for(e,t){return this._for(new Qg(e),t)}forRange(e,t,o,r,i=this.opts.es5?Yn.varKinds.var:Yn.varKinds.let){let a=this._scope.toName(e);return this._for(new Wg(i,a,t,o),()=>r(a))}forOf(e,t,o,r=Yn.varKinds.const){let i=this._scope.toName(e);if(this.opts.es5){let a=t instanceof ge.Name?t:this.var("_arr",t);return this.forRange("_i",0,(0,ge._)`${a}.length`,s=>{this.var(i,(0,ge._)`${a}[${s}]`),o(i)})}return this._for(new yp("of",r,i,t),()=>o(i))}forIn(e,t,o,r=this.opts.es5?Yn.varKinds.var:Yn.varKinds.const){if(this.opts.ownProperties)return this.forOf(e,(0,ge._)`Object.keys(${t})`,o);let i=this._scope.toName(e);return this._for(new yp("in",r,i,t),()=>o(i))}endFor(){return this._endBlockNode(zi)}label(e){return this._leafNode(new Kg(e))}break(e){return this._leafNode(new Hg(e))}return(e){let t=new Ml;if(this._blockNode(t),this.code(e),t.nodes.length!==1)throw new Error('CodeGen: "return" should have one node');return this._endBlockNode(Ml)}try(e,t,o){if(!t&&!o)throw new Error('CodeGen: "try" without "catch" and "finally"');let r=new Jg;if(this._blockNode(r),this.code(e),t){let i=this.name("e");this._currNode=r.catch=new Sl(i),t(i)}return o&&(this._currNode=r.finally=new $l,this.code(o)),this._endBlockNode(Sl,$l)}throw(e){return this._leafNode(new Zg(e))}block(e,t){return this._blockStarts.push(this._nodes.length),e&&this.code(e).endBlock(t),this}endBlock(e){let t=this._blockStarts.pop();if(t===void 0)throw new Error("CodeGen: not in self-balancing block");let o=this._nodes.length-t;if(o<0||e!==void 0&&o!==e)throw new Error(`CodeGen: wrong number of nodes: ${o} vs ${e} expected`);return this._nodes.length=t,this}func(e,t=ge.nil,o,r){return this._blockNode(new Pl(e,t,o)),r&&this.code(r).endFunc(),this}endFunc(){return this._endBlockNode(Pl)}optimize(e=1){for(;e-- >0;)this._root.optimizeNodes(),this._root.optimizeNames(this._root.names,this._constants)}_leafNode(e){return this._currNode.nodes.push(e),this}_blockNode(e){this._currNode.nodes.push(e),this._nodes.push(e)}_endBlockNode(e,t){let o=this._currNode;if(o instanceof e||t&&o instanceof t)return this._nodes.pop(),this;throw new Error(`CodeGen: not in block "${t?`${e.kind}/${t.kind}`:e.kind}"`)}_elseNode(e){let t=this._currNode;if(!(t instanceof Ni))throw new Error('CodeGen: "else" without "if"');return this._currNode=t.else=e,this}get _root(){return this._nodes[0]}get _currNode(){let e=this._nodes;return e[e.length-1]}set _currNode(e){let t=this._nodes;t[t.length-1]=e}};de.CodeGen=Xg;function Di(n,e){for(let t in e)n[t]=(n[t]||0)+(e[t]||0);return n}function xp(n,e){return e instanceof ge._CodeOrName?Di(n,e.names):n}function Es(n,e,t){if(n instanceof ge.Name)return o(n);if(!r(n))return n;return new ge._Code(n._items.reduce((i,a)=>(a instanceof ge.Name&&(a=o(a)),a instanceof ge._Code?i.push(...a._items):i.push(a),i),[]));function o(i){let a=t[i.str];return a===void 0||e[i.str]!==1?i:(delete e[i.str],a)}function r(i){return i instanceof ge._Code&&i._items.some(a=>a instanceof ge.Name&&e[a.str]===1&&t[a.str]!==void 0)}}function y1(n,e){for(let t in e)n[t]=(n[t]||0)-(e[t]||0)}function iT(n){return typeof n=="boolean"||typeof n=="number"||n===null?!n:(0,ge._)`!${Yg(n)}`}de.not=iT;var x1=aT(de.operators.AND);function b1(...n){return n.reduce(x1)}de.and=b1;var w1=aT(de.operators.OR);function k1(...n){return n.reduce(w1)}de.or=k1;function aT(n){return(e,t)=>e===ge.nil?t:t===ge.nil?e:(0,ge._)`${Yg(e)} ${n} ${Yg(t)}`}function Yg(n){return n instanceof ge.Name?n:(0,ge._)`(${n})`}});var xe=U(pe=>{"use strict";Object.defineProperty(pe,"__esModule",{value:!0});pe.checkStrictMode=pe.getErrorPath=pe.Type=pe.useFunc=pe.setEvaluated=pe.evaluatedPropsToName=pe.mergeEvaluated=pe.eachItem=pe.unescapeJsonPointer=pe.escapeJsonPointer=pe.escapeFragment=pe.unescapeFragment=pe.schemaRefOrVal=pe.schemaHasRulesButRef=pe.schemaHasRules=pe.checkUnknownRules=pe.alwaysValidSchema=pe.toHash=void 0;var Le=le(),_1=Il();function C1(n){let e={};for(let t of n)e[t]=!0;return e}pe.toHash=C1;function T1(n,e){return typeof e=="boolean"?e:Object.keys(e).length===0?!0:(lT(n,e),!uT(e,n.self.RULES.all))}pe.alwaysValidSchema=T1;function lT(n,e=n.schema){let{opts:t,self:o}=n;if(!t.strictSchema||typeof e=="boolean")return;let r=o.RULES.keywords;for(let i in e)r[i]||mT(n,`unknown keyword: "${i}"`)}pe.checkUnknownRules=lT;function uT(n,e){if(typeof n=="boolean")return!n;for(let t in n)if(e[t])return!0;return!1}pe.schemaHasRules=uT;function I1(n,e){if(typeof n=="boolean")return!n;for(let t in n)if(t!=="$ref"&&e.all[t])return!0;return!1}pe.schemaHasRulesButRef=I1;function A1({topSchemaRef:n,schemaPath:e},t,o,r){if(!r){if(typeof t=="number"||typeof t=="boolean")return t;if(typeof t=="string")return(0,Le._)`${t}`}return(0,Le._)`${n}${e}${(0,Le.getProperty)(o)}`}pe.schemaRefOrVal=A1;function P1(n){return dT(decodeURIComponent(n))}pe.unescapeFragment=P1;function M1(n){return encodeURIComponent(tv(n))}pe.escapeFragment=M1;function tv(n){return typeof n=="number"?`${n}`:n.replace(/~/g,"~0").replace(/\//g,"~1")}pe.escapeJsonPointer=tv;function dT(n){return n.replace(/~1/g,"/").replace(/~0/g,"~")}pe.unescapeJsonPointer=dT;function S1(n,e){if(Array.isArray(n))for(let t of n)e(t);else e(n)}pe.eachItem=S1;function sT({mergeNames:n,mergeToName:e,mergeValues:t,resultToName:o}){return(r,i,a,s)=>{let c=a===void 0?i:a instanceof Le.Name?(i instanceof Le.Name?n(r,i,a):e(r,i,a),a):i instanceof Le.Name?(e(r,a,i),i):t(i,a);return s===Le.Name&&!(c instanceof Le.Name)?o(r,c):c}}pe.mergeEvaluated={props:sT({mergeNames:(n,e,t)=>n.if((0,Le._)`${t} !== true && ${e} !== undefined`,()=>{n.if((0,Le._)`${e} === true`,()=>n.assign(t,!0),()=>n.assign(t,(0,Le._)`${t} || {}`).code((0,Le._)`Object.assign(${t}, ${e})`))}),mergeToName:(n,e,t)=>n.if((0,Le._)`${t} !== true`,()=>{e===!0?n.assign(t,!0):(n.assign(t,(0,Le._)`${t} || {}`),nv(n,t,e))}),mergeValues:(n,e)=>n===!0?!0:{...n,...e},resultToName:pT}),items:sT({mergeNames:(n,e,t)=>n.if((0,Le._)`${t} !== true && ${e} !== undefined`,()=>n.assign(t,(0,Le._)`${e} === true ? true : ${t} > ${e} ? ${t} : ${e}`)),mergeToName:(n,e,t)=>n.if((0,Le._)`${t} !== true`,()=>n.assign(t,e===!0?!0:(0,Le._)`${t} > ${e} ? ${t} : ${e}`)),mergeValues:(n,e)=>n===!0?!0:Math.max(n,e),resultToName:(n,e)=>n.var("items",e)})};function pT(n,e){if(e===!0)return n.var("props",!0);let t=n.var("props",(0,Le._)`{}`);return e!==void 0&&nv(n,t,e),t}pe.evaluatedPropsToName=pT;function nv(n,e,t){Object.keys(t).forEach(o=>n.assign((0,Le._)`${e}${(0,Le.getProperty)(o)}`,!0))}pe.setEvaluated=nv;var cT={};function $1(n,e){return n.scopeValue("func",{ref:e,code:cT[e.code]||(cT[e.code]=new _1._Code(e.code))})}pe.useFunc=$1;var ev;(function(n){n[n.Num=0]="Num",n[n.Str=1]="Str"})(ev||(pe.Type=ev={}));function E1(n,e,t){if(n instanceof Le.Name){let o=e===ev.Num;return t?o?(0,Le._)`"[" + ${n} + "]"`:(0,Le._)`"['" + ${n} + "']"`:o?(0,Le._)`"/" + ${n}`:(0,Le._)`"/" + ${n}.replace(/~/g, "~0").replace(/\\//g, "~1")`}return t?(0,Le.getProperty)(n).toString():"/"+tv(n)}pe.getErrorPath=E1;function mT(n,e,t=n.opts.strictSchema){if(t){if(e=`strict mode: ${e}`,t===!0)throw new Error(e);n.self.logger.warn(e)}}pe.checkStrictMode=mT});var Yo=U(ov=>{"use strict";Object.defineProperty(ov,"__esModule",{value:!0});var Wt=le(),R1={data:new Wt.Name("data"),valCxt:new Wt.Name("valCxt"),instancePath:new Wt.Name("instancePath"),parentData:new Wt.Name("parentData"),parentDataProperty:new Wt.Name("parentDataProperty"),rootData:new Wt.Name("rootData"),dynamicAnchors:new Wt.Name("dynamicAnchors"),vErrors:new Wt.Name("vErrors"),errors:new Wt.Name("errors"),this:new Wt.Name("this"),self:new Wt.Name("self"),scope:new Wt.Name("scope"),json:new Wt.Name("json"),jsonPos:new Wt.Name("jsonPos"),jsonLen:new Wt.Name("jsonLen"),jsonPart:new Wt.Name("jsonPart")};ov.default=R1});var El=U(Jt=>{"use strict";Object.defineProperty(Jt,"__esModule",{value:!0});Jt.extendErrors=Jt.resetErrorsCount=Jt.reportExtraError=Jt.reportError=Jt.keyword$DataError=Jt.keywordError=void 0;var ve=le(),wp=xe(),nn=Yo();Jt.keywordError={message:({keyword:n})=>(0,ve.str)`must pass "${n}" keyword validation`};Jt.keyword$DataError={message:({keyword:n,schemaType:e})=>e?(0,ve.str)`"${n}" keyword must be ${e} ($data)`:(0,ve.str)`"${n}" keyword is invalid ($data)`};function O1(n,e=Jt.keywordError,t,o){let{it:r}=n,{gen:i,compositeRule:a,allErrors:s}=r,c=gT(n,e,t);o??(a||s)?fT(i,c):hT(r,(0,ve._)`[${c}]`)}Jt.reportError=O1;function L1(n,e=Jt.keywordError,t){let{it:o}=n,{gen:r,compositeRule:i,allErrors:a}=o,s=gT(n,e,t);fT(r,s),i||a||hT(o,nn.default.vErrors)}Jt.reportExtraError=L1;function N1(n,e){n.assign(nn.default.errors,e),n.if((0,ve._)`${nn.default.vErrors} !== null`,()=>n.if(e,()=>n.assign((0,ve._)`${nn.default.vErrors}.length`,e),()=>n.assign(nn.default.vErrors,null)))}Jt.resetErrorsCount=N1;function z1({gen:n,keyword:e,schemaValue:t,data:o,errsCount:r,it:i}){if(r===void 0)throw new Error("ajv implementation error");let a=n.name("err");n.forRange("i",r,nn.default.errors,s=>{n.const(a,(0,ve._)`${nn.default.vErrors}[${s}]`),n.if((0,ve._)`${a}.instancePath === undefined`,()=>n.assign((0,ve._)`${a}.instancePath`,(0,ve.strConcat)(nn.default.instancePath,i.errorPath))),n.assign((0,ve._)`${a}.schemaPath`,(0,ve.str)`${i.errSchemaPath}/${e}`),i.opts.verbose&&(n.assign((0,ve._)`${a}.schema`,t),n.assign((0,ve._)`${a}.data`,o))})}Jt.extendErrors=z1;function fT(n,e){let t=n.const("err",e);n.if((0,ve._)`${nn.default.vErrors} === null`,()=>n.assign(nn.default.vErrors,(0,ve._)`[${t}]`),(0,ve._)`${nn.default.vErrors}.push(${t})`),n.code((0,ve._)`${nn.default.errors}++`)}function hT(n,e){let{gen:t,validateName:o,schemaEnv:r}=n;r.$async?t.throw((0,ve._)`new ${n.ValidationError}(${e})`):(t.assign((0,ve._)`${o}.errors`,e),t.return(!1))}var qi={keyword:new ve.Name("keyword"),schemaPath:new ve.Name("schemaPath"),params:new ve.Name("params"),propertyName:new ve.Name("propertyName"),message:new ve.Name("message"),schema:new ve.Name("schema"),parentSchema:new ve.Name("parentSchema")};function gT(n,e,t){let{createErrors:o}=n.it;return o===!1?(0,ve._)`{}`:D1(n,e,t)}function D1(n,e,t={}){let{gen:o,it:r}=n,i=[q1(r,t),F1(n,t)];return B1(n,e,i),o.object(...i)}function q1({errorPath:n},{instancePath:e}){let t=e?(0,ve.str)`${n}${(0,wp.getErrorPath)(e,wp.Type.Str)}`:n;return[nn.default.instancePath,(0,ve.strConcat)(nn.default.instancePath,t)]}function F1({keyword:n,it:{errSchemaPath:e}},{schemaPath:t,parentSchema:o}){let r=o?e:(0,ve.str)`${e}/${n}`;return t&&(r=(0,ve.str)`${r}${(0,wp.getErrorPath)(t,wp.Type.Str)}`),[qi.schemaPath,r]}function B1(n,{params:e,message:t},o){let{keyword:r,data:i,schemaValue:a,it:s}=n,{opts:c,propertyName:l,topSchemaRef:d,schemaPath:p}=s;o.push([qi.keyword,r],[qi.params,typeof e=="function"?e(n):e||(0,ve._)`{}`]),c.messages&&o.push([qi.message,typeof t=="function"?t(n):t]),c.verbose&&o.push([qi.schema,a],[qi.parentSchema,(0,ve._)`${d}${p}`],[nn.default.data,i]),l&&o.push([qi.propertyName,l])}});var yT=U(Rs=>{"use strict";Object.defineProperty(Rs,"__esModule",{value:!0});Rs.boolOrEmptySchema=Rs.topBoolOrEmptySchema=void 0;var U1=El(),j1=le(),K1=Yo(),H1={message:"boolean schema is false"};function Z1(n){let{gen:e,schema:t,validateName:o}=n;t===!1?vT(n,!1):typeof t=="object"&&t.$async===!0?e.return(K1.default.data):(e.assign((0,j1._)`${o}.errors`,null),e.return(!0))}Rs.topBoolOrEmptySchema=Z1;function G1(n,e){let{gen:t,schema:o}=n;o===!1?(t.var(e,!1),vT(n)):t.var(e,!0)}Rs.boolOrEmptySchema=G1;function vT(n,e){let{gen:t,data:o}=n,r={gen:t,keyword:"false schema",data:o,schema:!1,schemaCode:!1,schemaValue:!1,params:{},it:n};(0,U1.reportError)(r,H1,void 0,e)}});var rv=U(Os=>{"use strict";Object.defineProperty(Os,"__esModule",{value:!0});Os.getRules=Os.isJSONType=void 0;var V1=["string","number","integer","boolean","null","object","array"],Q1=new Set(V1);function W1(n){return typeof n=="string"&&Q1.has(n)}Os.isJSONType=W1;function J1(){let n={number:{type:"number",rules:[]},string:{type:"string",rules:[]},array:{type:"array",rules:[]},object:{type:"object",rules:[]}};return{types:{...n,integer:!0,boolean:!0,null:!0},rules:[{rules:[]},n.number,n.string,n.array,n.object],post:{rules:[]},all:{},keywords:{}}}Os.getRules=J1});var iv=U(qr=>{"use strict";Object.defineProperty(qr,"__esModule",{value:!0});qr.shouldUseRule=qr.shouldUseGroup=qr.schemaHasRulesForType=void 0;function X1({schema:n,self:e},t){let o=e.RULES.types[t];return o&&o!==!0&&xT(n,o)}qr.schemaHasRulesForType=X1;function xT(n,e){return e.rules.some(t=>bT(n,t))}qr.shouldUseGroup=xT;function bT(n,e){var t;return n[e.keyword]!==void 0||((t=e.definition.implements)===null||t===void 0?void 0:t.some(o=>n[o]!==void 0))}qr.shouldUseRule=bT});var Rl=U(Xt=>{"use strict";Object.defineProperty(Xt,"__esModule",{value:!0});Xt.reportTypeError=Xt.checkDataTypes=Xt.checkDataType=Xt.coerceAndCheckDataType=Xt.getJSONTypes=Xt.getSchemaTypes=Xt.DataType=void 0;var Y1=rv(),eL=iv(),tL=El(),se=le(),wT=xe(),Ls;(function(n){n[n.Correct=0]="Correct",n[n.Wrong=1]="Wrong"})(Ls||(Xt.DataType=Ls={}));function nL(n){let e=kT(n.type);if(e.includes("null")){if(n.nullable===!1)throw new Error("type: null contradicts nullable: false")}else{if(!e.length&&n.nullable!==void 0)throw new Error('"nullable" cannot be used without "type"');n.nullable===!0&&e.push("null")}return e}Xt.getSchemaTypes=nL;function kT(n){let e=Array.isArray(n)?n:n?[n]:[];if(e.every(Y1.isJSONType))return e;throw new Error("type must be JSONType or JSONType[]: "+e.join(","))}Xt.getJSONTypes=kT;function oL(n,e){let{gen:t,data:o,opts:r}=n,i=rL(e,r.coerceTypes),a=e.length>0&&!(i.length===0&&e.length===1&&(0,eL.schemaHasRulesForType)(n,e[0]));if(a){let s=sv(e,o,r.strictNumbers,Ls.Wrong);t.if(s,()=>{i.length?iL(n,e,i):cv(n)})}return a}Xt.coerceAndCheckDataType=oL;var _T=new Set(["string","number","integer","boolean","null"]);function rL(n,e){return e?n.filter(t=>_T.has(t)||e==="array"&&t==="array"):[]}function iL(n,e,t){let{gen:o,data:r,opts:i}=n,a=o.let("dataType",(0,se._)`typeof ${r}`),s=o.let("coerced",(0,se._)`undefined`);i.coerceTypes==="array"&&o.if((0,se._)`${a} == 'object' && Array.isArray(${r}) && ${r}.length == 1`,()=>o.assign(r,(0,se._)`${r}[0]`).assign(a,(0,se._)`typeof ${r}`).if(sv(e,r,i.strictNumbers),()=>o.assign(s,r))),o.if((0,se._)`${s} !== undefined`);for(let l of t)(_T.has(l)||l==="array"&&i.coerceTypes==="array")&&c(l);o.else(),cv(n),o.endIf(),o.if((0,se._)`${s} !== undefined`,()=>{o.assign(r,s),aL(n,s)});function c(l){switch(l){case"string":o.elseIf((0,se._)`${a} == "number" || ${a} == "boolean"`).assign(s,(0,se._)`"" + ${r}`).elseIf((0,se._)`${r} === null`).assign(s,(0,se._)`""`);return;case"number":o.elseIf((0,se._)`${a} == "boolean" || ${r} === null
              || (${a} == "string" && ${r} && ${r} == +${r})`).assign(s,(0,se._)`+${r}`);return;case"integer":o.elseIf((0,se._)`${a} === "boolean" || ${r} === null
              || (${a} === "string" && ${r} && ${r} == +${r} && !(${r} % 1))`).assign(s,(0,se._)`+${r}`);return;case"boolean":o.elseIf((0,se._)`${r} === "false" || ${r} === 0 || ${r} === null`).assign(s,!1).elseIf((0,se._)`${r} === "true" || ${r} === 1`).assign(s,!0);return;case"null":o.elseIf((0,se._)`${r} === "" || ${r} === 0 || ${r} === false`),o.assign(s,null);return;case"array":o.elseIf((0,se._)`${a} === "string" || ${a} === "number"
              || ${a} === "boolean" || ${r} === null`).assign(s,(0,se._)`[${r}]`)}}}function aL({gen:n,parentData:e,parentDataProperty:t},o){n.if((0,se._)`${e} !== undefined`,()=>n.assign((0,se._)`${e}[${t}]`,o))}function av(n,e,t,o=Ls.Correct){let r=o===Ls.Correct?se.operators.EQ:se.operators.NEQ,i;switch(n){case"null":return(0,se._)`${e} ${r} null`;case"array":i=(0,se._)`Array.isArray(${e})`;break;case"object":i=(0,se._)`${e} && typeof ${e} == "object" && !Array.isArray(${e})`;break;case"integer":i=a((0,se._)`!(${e} % 1) && !isNaN(${e})`);break;case"number":i=a();break;default:return(0,se._)`typeof ${e} ${r} ${n}`}return o===Ls.Correct?i:(0,se.not)(i);function a(s=se.nil){return(0,se.and)((0,se._)`typeof ${e} == "number"`,s,t?(0,se._)`isFinite(${e})`:se.nil)}}Xt.checkDataType=av;function sv(n,e,t,o){if(n.length===1)return av(n[0],e,t,o);let r,i=(0,wT.toHash)(n);if(i.array&&i.object){let a=(0,se._)`typeof ${e} != "object"`;r=i.null?a:(0,se._)`!${e} || ${a}`,delete i.null,delete i.array,delete i.object}else r=se.nil;i.number&&delete i.integer;for(let a in i)r=(0,se.and)(r,av(a,e,t,o));return r}Xt.checkDataTypes=sv;var sL={message:({schema:n})=>`must be ${n}`,params:({schema:n,schemaValue:e})=>typeof n=="string"?(0,se._)`{type: ${n}}`:(0,se._)`{type: ${e}}`};function cv(n){let e=cL(n);(0,tL.reportError)(e,sL)}Xt.reportTypeError=cv;function cL(n){let{gen:e,data:t,schema:o}=n,r=(0,wT.schemaRefOrVal)(n,o,"type");return{gen:e,keyword:"type",data:t,schema:o.type,schemaCode:r,schemaValue:r,parentSchema:o,params:{},it:n}}});var TT=U(kp=>{"use strict";Object.defineProperty(kp,"__esModule",{value:!0});kp.assignDefaults=void 0;var Ns=le(),lL=xe();function uL(n,e){let{properties:t,items:o}=n.schema;if(e==="object"&&t)for(let r in t)CT(n,r,t[r].default);else e==="array"&&Array.isArray(o)&&o.forEach((r,i)=>CT(n,i,r.default))}kp.assignDefaults=uL;function CT(n,e,t){let{gen:o,compositeRule:r,data:i,opts:a}=n;if(t===void 0)return;let s=(0,Ns._)`${i}${(0,Ns.getProperty)(e)}`;if(r){(0,lL.checkStrictMode)(n,`default is ignored for: ${s}`);return}let c=(0,Ns._)`${s} === undefined`;a.useDefaults==="empty"&&(c=(0,Ns._)`${c} || ${s} === null || ${s} === ""`),o.if(c,(0,Ns._)`${s} = ${(0,Ns.stringify)(t)}`)}});var qn=U(Ee=>{"use strict";Object.defineProperty(Ee,"__esModule",{value:!0});Ee.validateUnion=Ee.validateArray=Ee.usePattern=Ee.callValidateCode=Ee.schemaProperties=Ee.allSchemaProperties=Ee.noPropertyInData=Ee.propertyInData=Ee.isOwnProperty=Ee.hasPropFunc=Ee.reportMissingProp=Ee.checkMissingProp=Ee.checkReportMissingProp=void 0;var Ze=le(),lv=xe(),Fr=Yo(),dL=xe();function pL(n,e){let{gen:t,data:o,it:r}=n;t.if(dv(t,o,e,r.opts.ownProperties),()=>{n.setParams({missingProperty:(0,Ze._)`${e}`},!0),n.error()})}Ee.checkReportMissingProp=pL;function mL({gen:n,data:e,it:{opts:t}},o,r){return(0,Ze.or)(...o.map(i=>(0,Ze.and)(dv(n,e,i,t.ownProperties),(0,Ze._)`${r} = ${i}`)))}Ee.checkMissingProp=mL;function fL(n,e){n.setParams({missingProperty:e},!0),n.error()}Ee.reportMissingProp=fL;function IT(n){return n.scopeValue("func",{ref:Object.prototype.hasOwnProperty,code:(0,Ze._)`Object.prototype.hasOwnProperty`})}Ee.hasPropFunc=IT;function uv(n,e,t){return(0,Ze._)`${IT(n)}.call(${e}, ${t})`}Ee.isOwnProperty=uv;function hL(n,e,t,o){let r=(0,Ze._)`${e}${(0,Ze.getProperty)(t)} !== undefined`;return o?(0,Ze._)`${r} && ${uv(n,e,t)}`:r}Ee.propertyInData=hL;function dv(n,e,t,o){let r=(0,Ze._)`${e}${(0,Ze.getProperty)(t)} === undefined`;return o?(0,Ze.or)(r,(0,Ze.not)(uv(n,e,t))):r}Ee.noPropertyInData=dv;function AT(n){return n?Object.keys(n).filter(e=>e!=="__proto__"):[]}Ee.allSchemaProperties=AT;function gL(n,e){return AT(e).filter(t=>!(0,lv.alwaysValidSchema)(n,e[t]))}Ee.schemaProperties=gL;function vL({schemaCode:n,data:e,it:{gen:t,topSchemaRef:o,schemaPath:r,errorPath:i},it:a},s,c,l){let d=l?(0,Ze._)`${n}, ${e}, ${o}${r}`:e,p=[[Fr.default.instancePath,(0,Ze.strConcat)(Fr.default.instancePath,i)],[Fr.default.parentData,a.parentData],[Fr.default.parentDataProperty,a.parentDataProperty],[Fr.default.rootData,Fr.default.rootData]];a.opts.dynamicRef&&p.push([Fr.default.dynamicAnchors,Fr.default.dynamicAnchors]);let f=(0,Ze._)`${d}, ${t.object(...p)}`;return c!==Ze.nil?(0,Ze._)`${s}.call(${c}, ${f})`:(0,Ze._)`${s}(${f})`}Ee.callValidateCode=vL;var yL=(0,Ze._)`new RegExp`;function xL({gen:n,it:{opts:e}},t){let o=e.unicodeRegExp?"u":"",{regExp:r}=e.code,i=r(t,o);return n.scopeValue("pattern",{key:i.toString(),ref:i,code:(0,Ze._)`${r.code==="new RegExp"?yL:(0,dL.useFunc)(n,r)}(${t}, ${o})`})}Ee.usePattern=xL;function bL(n){let{gen:e,data:t,keyword:o,it:r}=n,i=e.name("valid");if(r.allErrors){let s=e.let("valid",!0);return a(()=>e.assign(s,!1)),s}return e.var(i,!0),a(()=>e.break()),i;function a(s){let c=e.const("len",(0,Ze._)`${t}.length`);e.forRange("i",0,c,l=>{n.subschema({keyword:o,dataProp:l,dataPropType:lv.Type.Num},i),e.if((0,Ze.not)(i),s)})}}Ee.validateArray=bL;function wL(n){let{gen:e,schema:t,keyword:o,it:r}=n;if(!Array.isArray(t))throw new Error("ajv implementation error");if(t.some(c=>(0,lv.alwaysValidSchema)(r,c))&&!r.opts.unevaluated)return;let a=e.let("valid",!1),s=e.name("_valid");e.block(()=>t.forEach((c,l)=>{let d=n.subschema({keyword:o,schemaProp:l,compositeRule:!0},s);e.assign(a,(0,Ze._)`${a} || ${s}`),n.mergeValidEvaluated(d,s)||e.if((0,Ze.not)(a))})),n.result(a,()=>n.reset(),()=>n.error(!0))}Ee.validateUnion=wL});var ST=U(wo=>{"use strict";Object.defineProperty(wo,"__esModule",{value:!0});wo.validateKeywordUsage=wo.validSchemaType=wo.funcKeywordCode=wo.macroKeywordCode=void 0;var on=le(),Fi=Yo(),kL=qn(),_L=El();function CL(n,e){let{gen:t,keyword:o,schema:r,parentSchema:i,it:a}=n,s=e.macro.call(a.self,r,i,a),c=MT(t,o,s);a.opts.validateSchema!==!1&&a.self.validateSchema(s,!0);let l=t.name("valid");n.subschema({schema:s,schemaPath:on.nil,errSchemaPath:`${a.errSchemaPath}/${o}`,topSchemaRef:c,compositeRule:!0},l),n.pass(l,()=>n.error(!0))}wo.macroKeywordCode=CL;function TL(n,e){var t;let{gen:o,keyword:r,schema:i,parentSchema:a,$data:s,it:c}=n;AL(c,e);let l=!s&&e.compile?e.compile.call(c.self,i,a,c):e.validate,d=MT(o,r,l),p=o.let("valid");n.block$data(p,f),n.ok((t=e.valid)!==null&&t!==void 0?t:p);function f(){if(e.errors===!1)g(),e.modifying&&PT(n),v(()=>n.error());else{let k=e.async?m():h();e.modifying&&PT(n),v(()=>IL(n,k))}}function m(){let k=o.let("ruleErrs",null);return o.try(()=>g((0,on._)`await `),x=>o.assign(p,!1).if((0,on._)`${x} instanceof ${c.ValidationError}`,()=>o.assign(k,(0,on._)`${x}.errors`),()=>o.throw(x))),k}function h(){let k=(0,on._)`${d}.errors`;return o.assign(k,null),g(on.nil),k}function g(k=e.async?(0,on._)`await `:on.nil){let x=c.opts.passContext?Fi.default.this:Fi.default.self,y=!("compile"in e&&!s||e.schema===!1);o.assign(p,(0,on._)`${k}${(0,kL.callValidateCode)(n,d,x,y)}`,e.modifying)}function v(k){var x;o.if((0,on.not)((x=e.valid)!==null&&x!==void 0?x:p),k)}}wo.funcKeywordCode=TL;function PT(n){let{gen:e,data:t,it:o}=n;e.if(o.parentData,()=>e.assign(t,(0,on._)`${o.parentData}[${o.parentDataProperty}]`))}function IL(n,e){let{gen:t}=n;t.if((0,on._)`Array.isArray(${e})`,()=>{t.assign(Fi.default.vErrors,(0,on._)`${Fi.default.vErrors} === null ? ${e} : ${Fi.default.vErrors}.concat(${e})`).assign(Fi.default.errors,(0,on._)`${Fi.default.vErrors}.length`),(0,_L.extendErrors)(n)},()=>n.error())}function AL({schemaEnv:n},e){if(e.async&&!n.$async)throw new Error("async keyword in sync schema")}function MT(n,e,t){if(t===void 0)throw new Error(`keyword "${e}" failed to compile`);return n.scopeValue("keyword",typeof t=="function"?{ref:t}:{ref:t,code:(0,on.stringify)(t)})}function PL(n,e,t=!1){return!e.length||e.some(o=>o==="array"?Array.isArray(n):o==="object"?n&&typeof n=="object"&&!Array.isArray(n):typeof n==o||t&&typeof n>"u")}wo.validSchemaType=PL;function ML({schema:n,opts:e,self:t,errSchemaPath:o},r,i){if(Array.isArray(r.keyword)?!r.keyword.includes(i):r.keyword!==i)throw new Error("ajv implementation error");let a=r.dependencies;if(a?.some(s=>!Object.prototype.hasOwnProperty.call(n,s)))throw new Error(`parent schema must have dependencies of ${i}: ${a.join(",")}`);if(r.validateSchema&&!r.validateSchema(n[i])){let c=`keyword "${i}" value is invalid at path "${o}": `+t.errorsText(r.validateSchema.errors);if(e.validateSchema==="log")t.logger.error(c);else throw new Error(c)}}wo.validateKeywordUsage=ML});var ET=U(Br=>{"use strict";Object.defineProperty(Br,"__esModule",{value:!0});Br.extendSubschemaMode=Br.extendSubschemaData=Br.getSubschema=void 0;var ko=le(),$T=xe();function SL(n,{keyword:e,schemaProp:t,schema:o,schemaPath:r,errSchemaPath:i,topSchemaRef:a}){if(e!==void 0&&o!==void 0)throw new Error('both "keyword" and "schema" passed, only one allowed');if(e!==void 0){let s=n.schema[e];return t===void 0?{schema:s,schemaPath:(0,ko._)`${n.schemaPath}${(0,ko.getProperty)(e)}`,errSchemaPath:`${n.errSchemaPath}/${e}`}:{schema:s[t],schemaPath:(0,ko._)`${n.schemaPath}${(0,ko.getProperty)(e)}${(0,ko.getProperty)(t)}`,errSchemaPath:`${n.errSchemaPath}/${e}/${(0,$T.escapeFragment)(t)}`}}if(o!==void 0){if(r===void 0||i===void 0||a===void 0)throw new Error('"schemaPath", "errSchemaPath" and "topSchemaRef" are required with "schema"');return{schema:o,schemaPath:r,topSchemaRef:a,errSchemaPath:i}}throw new Error('either "keyword" or "schema" must be passed')}Br.getSubschema=SL;function $L(n,e,{dataProp:t,dataPropType:o,data:r,dataTypes:i,propertyName:a}){if(r!==void 0&&t!==void 0)throw new Error('both "data" and "dataProp" passed, only one allowed');let{gen:s}=e;if(t!==void 0){let{errorPath:l,dataPathArr:d,opts:p}=e,f=s.let("data",(0,ko._)`${e.data}${(0,ko.getProperty)(t)}`,!0);c(f),n.errorPath=(0,ko.str)`${l}${(0,$T.getErrorPath)(t,o,p.jsPropertySyntax)}`,n.parentDataProperty=(0,ko._)`${t}`,n.dataPathArr=[...d,n.parentDataProperty]}if(r!==void 0){let l=r instanceof ko.Name?r:s.let("data",r,!0);c(l),a!==void 0&&(n.propertyName=a)}i&&(n.dataTypes=i);function c(l){n.data=l,n.dataLevel=e.dataLevel+1,n.dataTypes=[],e.definedProperties=new Set,n.parentData=e.data,n.dataNames=[...e.dataNames,l]}}Br.extendSubschemaData=$L;function EL(n,{jtdDiscriminator:e,jtdMetadata:t,compositeRule:o,createErrors:r,allErrors:i}){o!==void 0&&(n.compositeRule=o),r!==void 0&&(n.createErrors=r),i!==void 0&&(n.allErrors=i),n.jtdDiscriminator=e,n.jtdMetadata=t}Br.extendSubschemaMode=EL});var pv=U((HX,RT)=>{"use strict";RT.exports=function n(e,t){if(e===t)return!0;if(e&&t&&typeof e=="object"&&typeof t=="object"){if(e.constructor!==t.constructor)return!1;var o,r,i;if(Array.isArray(e)){if(o=e.length,o!=t.length)return!1;for(r=o;r--!==0;)if(!n(e[r],t[r]))return!1;return!0}if(e.constructor===RegExp)return e.source===t.source&&e.flags===t.flags;if(e.valueOf!==Object.prototype.valueOf)return e.valueOf()===t.valueOf();if(e.toString!==Object.prototype.toString)return e.toString()===t.toString();if(i=Object.keys(e),o=i.length,o!==Object.keys(t).length)return!1;for(r=o;r--!==0;)if(!Object.prototype.hasOwnProperty.call(t,i[r]))return!1;for(r=o;r--!==0;){var a=i[r];if(!n(e[a],t[a]))return!1}return!0}return e!==e&&t!==t}});var LT=U((ZX,OT)=>{"use strict";var Ur=OT.exports=function(n,e,t){typeof e=="function"&&(t=e,e={}),t=e.cb||t;var o=typeof t=="function"?t:t.pre||function(){},r=t.post||function(){};_p(e,o,r,n,"",n)};Ur.keywords={additionalItems:!0,items:!0,contains:!0,additionalProperties:!0,propertyNames:!0,not:!0,if:!0,then:!0,else:!0};Ur.arrayKeywords={items:!0,allOf:!0,anyOf:!0,oneOf:!0};Ur.propsKeywords={$defs:!0,definitions:!0,properties:!0,patternProperties:!0,dependencies:!0};Ur.skipKeywords={default:!0,enum:!0,const:!0,required:!0,maximum:!0,minimum:!0,exclusiveMaximum:!0,exclusiveMinimum:!0,multipleOf:!0,maxLength:!0,minLength:!0,pattern:!0,format:!0,maxItems:!0,minItems:!0,uniqueItems:!0,maxProperties:!0,minProperties:!0};function _p(n,e,t,o,r,i,a,s,c,l){if(o&&typeof o=="object"&&!Array.isArray(o)){e(o,r,i,a,s,c,l);for(var d in o){var p=o[d];if(Array.isArray(p)){if(d in Ur.arrayKeywords)for(var f=0;f<p.length;f++)_p(n,e,t,p[f],r+"/"+d+"/"+f,i,r,d,o,f)}else if(d in Ur.propsKeywords){if(p&&typeof p=="object")for(var m in p)_p(n,e,t,p[m],r+"/"+d+"/"+RL(m),i,r,d,o,m)}else(d in Ur.keywords||n.allKeys&&!(d in Ur.skipKeywords))&&_p(n,e,t,p,r+"/"+d,i,r,d,o)}t(o,r,i,a,s,c,l)}}function RL(n){return n.replace(/~/g,"~0").replace(/\//g,"~1")}});var Ol=U(hn=>{"use strict";Object.defineProperty(hn,"__esModule",{value:!0});hn.getSchemaRefs=hn.resolveUrl=hn.normalizeId=hn._getFullPath=hn.getFullPath=hn.inlineRef=void 0;var OL=xe(),LL=pv(),NL=LT(),zL=new Set(["type","format","pattern","maxLength","minLength","maxProperties","minProperties","maxItems","minItems","maximum","minimum","uniqueItems","multipleOf","required","enum","const"]);function DL(n,e=!0){return typeof n=="boolean"?!0:e===!0?!mv(n):e?NT(n)<=e:!1}hn.inlineRef=DL;var qL=new Set(["$ref","$recursiveRef","$recursiveAnchor","$dynamicRef","$dynamicAnchor"]);function mv(n){for(let e in n){if(qL.has(e))return!0;let t=n[e];if(Array.isArray(t)&&t.some(mv)||typeof t=="object"&&mv(t))return!0}return!1}function NT(n){let e=0;for(let t in n){if(t==="$ref")return 1/0;if(e++,!zL.has(t)&&(typeof n[t]=="object"&&(0,OL.eachItem)(n[t],o=>e+=NT(o)),e===1/0))return 1/0}return e}function zT(n,e="",t){t!==!1&&(e=zs(e));let o=n.parse(e);return DT(n,o)}hn.getFullPath=zT;function DT(n,e){return n.serialize(e).split("#")[0]+"#"}hn._getFullPath=DT;var FL=/#\/?$/;function zs(n){return n?n.replace(FL,""):""}hn.normalizeId=zs;function BL(n,e,t){return t=zs(t),n.resolve(e,t)}hn.resolveUrl=BL;var UL=/^[a-z_][-a-z0-9._]*$/i;function jL(n,e){if(typeof n=="boolean")return{};let{schemaId:t,uriResolver:o}=this.opts,r=zs(n[t]||e),i={"":r},a=zT(o,r,!1),s={},c=new Set;return NL(n,{allKeys:!0},(p,f,m,h)=>{if(h===void 0)return;let g=a+f,v=i[h];typeof p[t]=="string"&&(v=k.call(this,p[t])),x.call(this,p.$anchor),x.call(this,p.$dynamicAnchor),i[f]=v;function k(y){let w=this.opts.uriResolver.resolve;if(y=zs(v?w(v,y):y),c.has(y))throw d(y);c.add(y);let b=this.refs[y];return typeof b=="string"&&(b=this.refs[b]),typeof b=="object"?l(p,b.schema,y):y!==zs(g)&&(y[0]==="#"?(l(p,s[y],y),s[y]=p):this.refs[y]=g),y}function x(y){if(typeof y=="string"){if(!UL.test(y))throw new Error(`invalid anchor "${y}"`);k.call(this,`#${y}`)}}}),s;function l(p,f,m){if(f!==void 0&&!LL(p,f))throw d(m)}function d(p){return new Error(`reference "${p}" resolves to more than one schema`)}}hn.getSchemaRefs=jL});var zl=U(jr=>{"use strict";Object.defineProperty(jr,"__esModule",{value:!0});jr.getData=jr.KeywordCxt=jr.validateFunctionCode=void 0;var jT=yT(),qT=Rl(),hv=iv(),Cp=Rl(),KL=TT(),Nl=ST(),fv=ET(),Q=le(),ne=Yo(),HL=Ol(),er=xe(),Ll=El();function ZL(n){if(ZT(n)&&(GT(n),HT(n))){QL(n);return}KT(n,()=>(0,jT.topBoolOrEmptySchema)(n))}jr.validateFunctionCode=ZL;function KT({gen:n,validateName:e,schema:t,schemaEnv:o,opts:r},i){r.code.es5?n.func(e,(0,Q._)`${ne.default.data}, ${ne.default.valCxt}`,o.$async,()=>{n.code((0,Q._)`"use strict"; ${FT(t,r)}`),VL(n,r),n.code(i)}):n.func(e,(0,Q._)`${ne.default.data}, ${GL(r)}`,o.$async,()=>n.code(FT(t,r)).code(i))}function GL(n){return(0,Q._)`{${ne.default.instancePath}="", ${ne.default.parentData}, ${ne.default.parentDataProperty}, ${ne.default.rootData}=${ne.default.data}${n.dynamicRef?(0,Q._)`, ${ne.default.dynamicAnchors}={}`:Q.nil}}={}`}function VL(n,e){n.if(ne.default.valCxt,()=>{n.var(ne.default.instancePath,(0,Q._)`${ne.default.valCxt}.${ne.default.instancePath}`),n.var(ne.default.parentData,(0,Q._)`${ne.default.valCxt}.${ne.default.parentData}`),n.var(ne.default.parentDataProperty,(0,Q._)`${ne.default.valCxt}.${ne.default.parentDataProperty}`),n.var(ne.default.rootData,(0,Q._)`${ne.default.valCxt}.${ne.default.rootData}`),e.dynamicRef&&n.var(ne.default.dynamicAnchors,(0,Q._)`${ne.default.valCxt}.${ne.default.dynamicAnchors}`)},()=>{n.var(ne.default.instancePath,(0,Q._)`""`),n.var(ne.default.parentData,(0,Q._)`undefined`),n.var(ne.default.parentDataProperty,(0,Q._)`undefined`),n.var(ne.default.rootData,ne.default.data),e.dynamicRef&&n.var(ne.default.dynamicAnchors,(0,Q._)`{}`)})}function QL(n){let{schema:e,opts:t,gen:o}=n;KT(n,()=>{t.$comment&&e.$comment&&QT(n),e2(n),o.let(ne.default.vErrors,null),o.let(ne.default.errors,0),t.unevaluated&&WL(n),VT(n),o2(n)})}function WL(n){let{gen:e,validateName:t}=n;n.evaluated=e.const("evaluated",(0,Q._)`${t}.evaluated`),e.if((0,Q._)`${n.evaluated}.dynamicProps`,()=>e.assign((0,Q._)`${n.evaluated}.props`,(0,Q._)`undefined`)),e.if((0,Q._)`${n.evaluated}.dynamicItems`,()=>e.assign((0,Q._)`${n.evaluated}.items`,(0,Q._)`undefined`))}function FT(n,e){let t=typeof n=="object"&&n[e.schemaId];return t&&(e.code.source||e.code.process)?(0,Q._)`/*# sourceURL=${t} */`:Q.nil}function JL(n,e){if(ZT(n)&&(GT(n),HT(n))){XL(n,e);return}(0,jT.boolOrEmptySchema)(n,e)}function HT({schema:n,self:e}){if(typeof n=="boolean")return!n;for(let t in n)if(e.RULES.all[t])return!0;return!1}function ZT(n){return typeof n.schema!="boolean"}function XL(n,e){let{schema:t,gen:o,opts:r}=n;r.$comment&&t.$comment&&QT(n),t2(n),n2(n);let i=o.const("_errs",ne.default.errors);VT(n,i),o.var(e,(0,Q._)`${i} === ${ne.default.errors}`)}function GT(n){(0,er.checkUnknownRules)(n),YL(n)}function VT(n,e){if(n.opts.jtd)return BT(n,[],!1,e);let t=(0,qT.getSchemaTypes)(n.schema),o=(0,qT.coerceAndCheckDataType)(n,t);BT(n,t,!o,e)}function YL(n){let{schema:e,errSchemaPath:t,opts:o,self:r}=n;e.$ref&&o.ignoreKeywordsWithRef&&(0,er.schemaHasRulesButRef)(e,r.RULES)&&r.logger.warn(`$ref: keywords ignored in schema at path "${t}"`)}function e2(n){let{schema:e,opts:t}=n;e.default!==void 0&&t.useDefaults&&t.strictSchema&&(0,er.checkStrictMode)(n,"default is ignored in the schema root")}function t2(n){let e=n.schema[n.opts.schemaId];e&&(n.baseId=(0,HL.resolveUrl)(n.opts.uriResolver,n.baseId,e))}function n2(n){if(n.schema.$async&&!n.schemaEnv.$async)throw new Error("async schema in sync schema")}function QT({gen:n,schemaEnv:e,schema:t,errSchemaPath:o,opts:r}){let i=t.$comment;if(r.$comment===!0)n.code((0,Q._)`${ne.default.self}.logger.log(${i})`);else if(typeof r.$comment=="function"){let a=(0,Q.str)`${o}/$comment`,s=n.scopeValue("root",{ref:e.root});n.code((0,Q._)`${ne.default.self}.opts.$comment(${i}, ${a}, ${s}.schema)`)}}function o2(n){let{gen:e,schemaEnv:t,validateName:o,ValidationError:r,opts:i}=n;t.$async?e.if((0,Q._)`${ne.default.errors} === 0`,()=>e.return(ne.default.data),()=>e.throw((0,Q._)`new ${r}(${ne.default.vErrors})`)):(e.assign((0,Q._)`${o}.errors`,ne.default.vErrors),i.unevaluated&&r2(n),e.return((0,Q._)`${ne.default.errors} === 0`))}function r2({gen:n,evaluated:e,props:t,items:o}){t instanceof Q.Name&&n.assign((0,Q._)`${e}.props`,t),o instanceof Q.Name&&n.assign((0,Q._)`${e}.items`,o)}function BT(n,e,t,o){let{gen:r,schema:i,data:a,allErrors:s,opts:c,self:l}=n,{RULES:d}=l;if(i.$ref&&(c.ignoreKeywordsWithRef||!(0,er.schemaHasRulesButRef)(i,d))){r.block(()=>JT(n,"$ref",d.all.$ref.definition));return}c.jtd||i2(n,e),r.block(()=>{for(let f of d.rules)p(f);p(d.post)});function p(f){(0,hv.shouldUseGroup)(i,f)&&(f.type?(r.if((0,Cp.checkDataType)(f.type,a,c.strictNumbers)),UT(n,f),e.length===1&&e[0]===f.type&&t&&(r.else(),(0,Cp.reportTypeError)(n)),r.endIf()):UT(n,f),s||r.if((0,Q._)`${ne.default.errors} === ${o||0}`))}}function UT(n,e){let{gen:t,schema:o,opts:{useDefaults:r}}=n;r&&(0,KL.assignDefaults)(n,e.type),t.block(()=>{for(let i of e.rules)(0,hv.shouldUseRule)(o,i)&&JT(n,i.keyword,i.definition,e.type)})}function i2(n,e){n.schemaEnv.meta||!n.opts.strictTypes||(a2(n,e),n.opts.allowUnionTypes||s2(n,e),c2(n,n.dataTypes))}function a2(n,e){if(e.length){if(!n.dataTypes.length){n.dataTypes=e;return}e.forEach(t=>{WT(n.dataTypes,t)||gv(n,`type "${t}" not allowed by context "${n.dataTypes.join(",")}"`)}),u2(n,e)}}function s2(n,e){e.length>1&&!(e.length===2&&e.includes("null"))&&gv(n,"use allowUnionTypes to allow union type keyword")}function c2(n,e){let t=n.self.RULES.all;for(let o in t){let r=t[o];if(typeof r=="object"&&(0,hv.shouldUseRule)(n.schema,r)){let{type:i}=r.definition;i.length&&!i.some(a=>l2(e,a))&&gv(n,`missing type "${i.join(",")}" for keyword "${o}"`)}}}function l2(n,e){return n.includes(e)||e==="number"&&n.includes("integer")}function WT(n,e){return n.includes(e)||e==="integer"&&n.includes("number")}function u2(n,e){let t=[];for(let o of n.dataTypes)WT(e,o)?t.push(o):e.includes("integer")&&o==="number"&&t.push("integer");n.dataTypes=t}function gv(n,e){let t=n.schemaEnv.baseId+n.errSchemaPath;e+=` at "${t}" (strictTypes)`,(0,er.checkStrictMode)(n,e,n.opts.strictTypes)}var Tp=class{constructor(e,t,o){if((0,Nl.validateKeywordUsage)(e,t,o),this.gen=e.gen,this.allErrors=e.allErrors,this.keyword=o,this.data=e.data,this.schema=e.schema[o],this.$data=t.$data&&e.opts.$data&&this.schema&&this.schema.$data,this.schemaValue=(0,er.schemaRefOrVal)(e,this.schema,o,this.$data),this.schemaType=t.schemaType,this.parentSchema=e.schema,this.params={},this.it=e,this.def=t,this.$data)this.schemaCode=e.gen.const("vSchema",XT(this.$data,e));else if(this.schemaCode=this.schemaValue,!(0,Nl.validSchemaType)(this.schema,t.schemaType,t.allowUndefined))throw new Error(`${o} value must be ${JSON.stringify(t.schemaType)}`);("code"in t?t.trackErrors:t.errors!==!1)&&(this.errsCount=e.gen.const("_errs",ne.default.errors))}result(e,t,o){this.failResult((0,Q.not)(e),t,o)}failResult(e,t,o){this.gen.if(e),o?o():this.error(),t?(this.gen.else(),t(),this.allErrors&&this.gen.endIf()):this.allErrors?this.gen.endIf():this.gen.else()}pass(e,t){this.failResult((0,Q.not)(e),void 0,t)}fail(e){if(e===void 0){this.error(),this.allErrors||this.gen.if(!1);return}this.gen.if(e),this.error(),this.allErrors?this.gen.endIf():this.gen.else()}fail$data(e){if(!this.$data)return this.fail(e);let{schemaCode:t}=this;this.fail((0,Q._)`${t} !== undefined && (${(0,Q.or)(this.invalid$data(),e)})`)}error(e,t,o){if(t){this.setParams(t),this._error(e,o),this.setParams({});return}this._error(e,o)}_error(e,t){(e?Ll.reportExtraError:Ll.reportError)(this,this.def.error,t)}$dataError(){(0,Ll.reportError)(this,this.def.$dataError||Ll.keyword$DataError)}reset(){if(this.errsCount===void 0)throw new Error('add "trackErrors" to keyword definition');(0,Ll.resetErrorsCount)(this.gen,this.errsCount)}ok(e){this.allErrors||this.gen.if(e)}setParams(e,t){t?Object.assign(this.params,e):this.params=e}block$data(e,t,o=Q.nil){this.gen.block(()=>{this.check$data(e,o),t()})}check$data(e=Q.nil,t=Q.nil){if(!this.$data)return;let{gen:o,schemaCode:r,schemaType:i,def:a}=this;o.if((0,Q.or)((0,Q._)`${r} === undefined`,t)),e!==Q.nil&&o.assign(e,!0),(i.length||a.validateSchema)&&(o.elseIf(this.invalid$data()),this.$dataError(),e!==Q.nil&&o.assign(e,!1)),o.else()}invalid$data(){let{gen:e,schemaCode:t,schemaType:o,def:r,it:i}=this;return(0,Q.or)(a(),s());function a(){if(o.length){if(!(t instanceof Q.Name))throw new Error("ajv implementation error");let c=Array.isArray(o)?o:[o];return(0,Q._)`${(0,Cp.checkDataTypes)(c,t,i.opts.strictNumbers,Cp.DataType.Wrong)}`}return Q.nil}function s(){if(r.validateSchema){let c=e.scopeValue("validate$data",{ref:r.validateSchema});return(0,Q._)`!${c}(${t})`}return Q.nil}}subschema(e,t){let o=(0,fv.getSubschema)(this.it,e);(0,fv.extendSubschemaData)(o,this.it,e),(0,fv.extendSubschemaMode)(o,e);let r={...this.it,...o,items:void 0,props:void 0};return JL(r,t),r}mergeEvaluated(e,t){let{it:o,gen:r}=this;o.opts.unevaluated&&(o.props!==!0&&e.props!==void 0&&(o.props=er.mergeEvaluated.props(r,e.props,o.props,t)),o.items!==!0&&e.items!==void 0&&(o.items=er.mergeEvaluated.items(r,e.items,o.items,t)))}mergeValidEvaluated(e,t){let{it:o,gen:r}=this;if(o.opts.unevaluated&&(o.props!==!0||o.items!==!0))return r.if(t,()=>this.mergeEvaluated(e,Q.Name)),!0}};jr.KeywordCxt=Tp;function JT(n,e,t,o){let r=new Tp(n,t,e);"code"in t?t.code(r,o):r.$data&&t.validate?(0,Nl.funcKeywordCode)(r,t):"macro"in t?(0,Nl.macroKeywordCode)(r,t):(t.compile||t.validate)&&(0,Nl.funcKeywordCode)(r,t)}var d2=/^\/(?:[^~]|~0|~1)*$/,p2=/^([0-9]+)(#|\/(?:[^~]|~0|~1)*)?$/;function XT(n,{dataLevel:e,dataNames:t,dataPathArr:o}){let r,i;if(n==="")return ne.default.rootData;if(n[0]==="/"){if(!d2.test(n))throw new Error(`Invalid JSON-pointer: ${n}`);r=n,i=ne.default.rootData}else{let l=p2.exec(n);if(!l)throw new Error(`Invalid JSON-pointer: ${n}`);let d=+l[1];if(r=l[2],r==="#"){if(d>=e)throw new Error(c("property/index",d));return o[e-d]}if(d>e)throw new Error(c("data",d));if(i=t[e-d],!r)return i}let a=i,s=r.split("/");for(let l of s)l&&(i=(0,Q._)`${i}${(0,Q.getProperty)((0,er.unescapeJsonPointer)(l))}`,a=(0,Q._)`${a} && ${i}`);return a;function c(l,d){return`Cannot access ${l} ${d} levels up, current level is ${e}`}}jr.getData=XT});var Ip=U(yv=>{"use strict";Object.defineProperty(yv,"__esModule",{value:!0});var vv=class extends Error{constructor(e){super("validation failed"),this.errors=e,this.ajv=this.validation=!0}};yv.default=vv});var Dl=U(wv=>{"use strict";Object.defineProperty(wv,"__esModule",{value:!0});var xv=Ol(),bv=class extends Error{constructor(e,t,o,r){super(r||`can't resolve reference ${o} from id ${t}`),this.missingRef=(0,xv.resolveUrl)(e,t,o),this.missingSchema=(0,xv.normalizeId)((0,xv.getFullPath)(e,this.missingRef))}};wv.default=bv});var Pp=U(Fn=>{"use strict";Object.defineProperty(Fn,"__esModule",{value:!0});Fn.resolveSchema=Fn.getCompilingSchema=Fn.resolveRef=Fn.compileSchema=Fn.SchemaEnv=void 0;var eo=le(),m2=Ip(),Bi=Yo(),to=Ol(),YT=xe(),f2=zl(),Ds=class{constructor(e){var t;this.refs={},this.dynamicAnchors={};let o;typeof e.schema=="object"&&(o=e.schema),this.schema=e.schema,this.schemaId=e.schemaId,this.root=e.root||this,this.baseId=(t=e.baseId)!==null&&t!==void 0?t:(0,to.normalizeId)(o?.[e.schemaId||"$id"]),this.schemaPath=e.schemaPath,this.localRefs=e.localRefs,this.meta=e.meta,this.$async=o?.$async,this.refs={}}};Fn.SchemaEnv=Ds;function _v(n){let e=eI.call(this,n);if(e)return e;let t=(0,to.getFullPath)(this.opts.uriResolver,n.root.baseId),{es5:o,lines:r}=this.opts.code,{ownProperties:i}=this.opts,a=new eo.CodeGen(this.scope,{es5:o,lines:r,ownProperties:i}),s;n.$async&&(s=a.scopeValue("Error",{ref:m2.default,code:(0,eo._)`require("ajv/dist/runtime/validation_error").default`}));let c=a.scopeName("validate");n.validateName=c;let l={gen:a,allErrors:this.opts.allErrors,data:Bi.default.data,parentData:Bi.default.parentData,parentDataProperty:Bi.default.parentDataProperty,dataNames:[Bi.default.data],dataPathArr:[eo.nil],dataLevel:0,dataTypes:[],definedProperties:new Set,topSchemaRef:a.scopeValue("schema",this.opts.code.source===!0?{ref:n.schema,code:(0,eo.stringify)(n.schema)}:{ref:n.schema}),validateName:c,ValidationError:s,schema:n.schema,schemaEnv:n,rootId:t,baseId:n.baseId||t,schemaPath:eo.nil,errSchemaPath:n.schemaPath||(this.opts.jtd?"":"#"),errorPath:(0,eo._)`""`,opts:this.opts,self:this},d;try{this._compilations.add(n),(0,f2.validateFunctionCode)(l),a.optimize(this.opts.code.optimize);let p=a.toString();d=`${a.scopeRefs(Bi.default.scope)}return ${p}`,this.opts.code.process&&(d=this.opts.code.process(d,n));let m=new Function(`${Bi.default.self}`,`${Bi.default.scope}`,d)(this,this.scope.get());if(this.scope.value(c,{ref:m}),m.errors=null,m.schema=n.schema,m.schemaEnv=n,n.$async&&(m.$async=!0),this.opts.code.source===!0&&(m.source={validateName:c,validateCode:p,scopeValues:a._values}),this.opts.unevaluated){let{props:h,items:g}=l;m.evaluated={props:h instanceof eo.Name?void 0:h,items:g instanceof eo.Name?void 0:g,dynamicProps:h instanceof eo.Name,dynamicItems:g instanceof eo.Name},m.source&&(m.source.evaluated=(0,eo.stringify)(m.evaluated))}return n.validate=m,n}catch(p){throw delete n.validate,delete n.validateName,d&&this.logger.error("Error compiling schema, function code:",d),p}finally{this._compilations.delete(n)}}Fn.compileSchema=_v;function h2(n,e,t){var o;t=(0,to.resolveUrl)(this.opts.uriResolver,e,t);let r=n.refs[t];if(r)return r;let i=y2.call(this,n,t);if(i===void 0){let a=(o=n.localRefs)===null||o===void 0?void 0:o[t],{schemaId:s}=this.opts;a&&(i=new Ds({schema:a,schemaId:s,root:n,baseId:e}))}if(i!==void 0)return n.refs[t]=g2.call(this,i)}Fn.resolveRef=h2;function g2(n){return(0,to.inlineRef)(n.schema,this.opts.inlineRefs)?n.schema:n.validate?n:_v.call(this,n)}function eI(n){for(let e of this._compilations)if(v2(e,n))return e}Fn.getCompilingSchema=eI;function v2(n,e){return n.schema===e.schema&&n.root===e.root&&n.baseId===e.baseId}function y2(n,e){let t;for(;typeof(t=this.refs[e])=="string";)e=t;return t||this.schemas[e]||Ap.call(this,n,e)}function Ap(n,e){let t=this.opts.uriResolver.parse(e),o=(0,to._getFullPath)(this.opts.uriResolver,t),r=(0,to.getFullPath)(this.opts.uriResolver,n.baseId,void 0);if(Object.keys(n.schema).length>0&&o===r)return kv.call(this,t,n);let i=(0,to.normalizeId)(o),a=this.refs[i]||this.schemas[i];if(typeof a=="string"){let s=Ap.call(this,n,a);return typeof s?.schema!="object"?void 0:kv.call(this,t,s)}if(typeof a?.schema=="object"){if(a.validate||_v.call(this,a),i===(0,to.normalizeId)(e)){let{schema:s}=a,{schemaId:c}=this.opts,l=s[c];return l&&(r=(0,to.resolveUrl)(this.opts.uriResolver,r,l)),new Ds({schema:s,schemaId:c,root:n,baseId:r})}return kv.call(this,t,a)}}Fn.resolveSchema=Ap;var x2=new Set(["properties","patternProperties","enum","dependencies","definitions"]);function kv(n,{baseId:e,schema:t,root:o}){var r;if(((r=n.fragment)===null||r===void 0?void 0:r[0])!=="/")return;for(let s of n.fragment.slice(1).split("/")){if(typeof t=="boolean")return;let c=t[(0,YT.unescapeFragment)(s)];if(c===void 0)return;t=c;let l=typeof t=="object"&&t[this.opts.schemaId];!x2.has(s)&&l&&(e=(0,to.resolveUrl)(this.opts.uriResolver,e,l))}let i;if(typeof t!="boolean"&&t.$ref&&!(0,YT.schemaHasRulesButRef)(t,this.RULES)){let s=(0,to.resolveUrl)(this.opts.uriResolver,e,t.$ref);i=Ap.call(this,o,s)}let{schemaId:a}=this.opts;if(i=i||new Ds({schema:t,schemaId:a,root:o,baseId:e}),i.schema!==i.root.schema)return i}});var tI=U((XX,b2)=>{b2.exports={$id:"https://raw.githubusercontent.com/ajv-validator/ajv/master/lib/refs/data.json#",description:"Meta-schema for $data reference (JSON AnySchema extension proposal)",type:"object",required:["$data"],properties:{$data:{type:"string",anyOf:[{format:"relative-json-pointer"},{format:"json-pointer"}]}},additionalProperties:!1}});var Tv=U((YX,iI)=>{"use strict";var w2=RegExp.prototype.test.bind(/^[\da-f]{8}-[\da-f]{4}-[\da-f]{4}-[\da-f]{4}-[\da-f]{12}$/iu),oI=RegExp.prototype.test.bind(/^(?:(?:25[0-5]|2[0-4]\d|1\d{2}|[1-9]\d|\d)\.){3}(?:25[0-5]|2[0-4]\d|1\d{2}|[1-9]\d|\d)$/u);function Cv(n){let e="",t=0,o=0;for(o=0;o<n.length;o++)if(t=n[o].charCodeAt(0),t!==48){if(!(t>=48&&t<=57||t>=65&&t<=70||t>=97&&t<=102))return"";e+=n[o];break}for(o+=1;o<n.length;o++){if(t=n[o].charCodeAt(0),!(t>=48&&t<=57||t>=65&&t<=70||t>=97&&t<=102))return"";e+=n[o]}return e}var k2=RegExp.prototype.test.bind(/[^!"$&'()*+,\-.;=_`a-z{}~]/u);function nI(n){return n.length=0,!0}function _2(n,e,t){if(n.length){let o=Cv(n);if(o!=="")e.push(o);else return t.error=!0,!1;n.length=0}return!0}function C2(n){let e=0,t={error:!1,address:"",zone:""},o=[],r=[],i=!1,a=!1,s=_2;for(let c=0;c<n.length;c++){let l=n[c];if(!(l==="["||l==="]"))if(l===":"){if(i===!0&&(a=!0),!s(r,o,t))break;if(++e>7){t.error=!0;break}c>0&&n[c-1]===":"&&(i=!0),o.push(":");continue}else if(l==="%"){if(!s(r,o,t))break;s=nI}else{r.push(l);continue}}return r.length&&(s===nI?t.zone=r.join(""):a?o.push(r.join("")):o.push(Cv(r))),t.address=o.join(""),t}function rI(n){if(T2(n,":")<2)return{host:n,isIPV6:!1};let e=C2(n);if(e.error)return{host:n,isIPV6:!1};{let t=e.address,o=e.address;return e.zone&&(t+="%"+e.zone,o+="%25"+e.zone),{host:t,isIPV6:!0,escapedHost:o}}}function T2(n,e){let t=0;for(let o=0;o<n.length;o++)n[o]===e&&t++;return t}function I2(n){let e=n,t=[],o=-1,r=0;for(;r=e.length;){if(r===1){if(e===".")break;if(e==="/"){t.push("/");break}else{t.push(e);break}}else if(r===2){if(e[0]==="."){if(e[1]===".")break;if(e[1]==="/"){e=e.slice(2);continue}}else if(e[0]==="/"&&(e[1]==="."||e[1]==="/")){t.push("/");break}}else if(r===3&&e==="/.."){t.length!==0&&t.pop(),t.push("/");break}if(e[0]==="."){if(e[1]==="."){if(e[2]==="/"){e=e.slice(3);continue}}else if(e[1]==="/"){e=e.slice(2);continue}}else if(e[0]==="/"&&e[1]==="."){if(e[2]==="/"){e=e.slice(2);continue}else if(e[2]==="."&&e[3]==="/"){e=e.slice(3),t.length!==0&&t.pop();continue}}if((o=e.indexOf("/",1))===-1){t.push(e);break}else t.push(e.slice(0,o)),e=e.slice(o)}return t.join("")}function A2(n,e){let t=e!==!0?escape:unescape;return n.scheme!==void 0&&(n.scheme=t(n.scheme)),n.userinfo!==void 0&&(n.userinfo=t(n.userinfo)),n.host!==void 0&&(n.host=t(n.host)),n.path!==void 0&&(n.path=t(n.path)),n.query!==void 0&&(n.query=t(n.query)),n.fragment!==void 0&&(n.fragment=t(n.fragment)),n}function P2(n){let e=[];if(n.userinfo!==void 0&&(e.push(n.userinfo),e.push("@")),n.host!==void 0){let t=unescape(n.host);if(!oI(t)){let o=rI(t);o.isIPV6===!0?t=`[${o.escapedHost}]`:t=n.host}e.push(t)}return(typeof n.port=="number"||typeof n.port=="string")&&(e.push(":"),e.push(String(n.port))),e.length?e.join(""):void 0}iI.exports={nonSimpleDomain:k2,recomposeAuthority:P2,normalizeComponentEncoding:A2,removeDotSegments:I2,isIPv4:oI,isUUID:w2,normalizeIPv6:rI,stringArrayToHexStripped:Cv}});var uI=U((eY,lI)=>{"use strict";var{isUUID:M2}=Tv(),S2=/([\da-z][\d\-a-z]{0,31}):((?:[\w!$'()*+,\-.:;=@]|%[\da-f]{2})+)/iu,$2=["http","https","ws","wss","urn","urn:uuid"];function E2(n){return $2.indexOf(n)!==-1}function Iv(n){return n.secure===!0?!0:n.secure===!1?!1:n.scheme?n.scheme.length===3&&(n.scheme[0]==="w"||n.scheme[0]==="W")&&(n.scheme[1]==="s"||n.scheme[1]==="S")&&(n.scheme[2]==="s"||n.scheme[2]==="S"):!1}function aI(n){return n.host||(n.error=n.error||"HTTP URIs must have a host."),n}function sI(n){let e=String(n.scheme).toLowerCase()==="https";return(n.port===(e?443:80)||n.port==="")&&(n.port=void 0),n.path||(n.path="/"),n}function R2(n){return n.secure=Iv(n),n.resourceName=(n.path||"/")+(n.query?"?"+n.query:""),n.path=void 0,n.query=void 0,n}function O2(n){if((n.port===(Iv(n)?443:80)||n.port==="")&&(n.port=void 0),typeof n.secure=="boolean"&&(n.scheme=n.secure?"wss":"ws",n.secure=void 0),n.resourceName){let[e,t]=n.resourceName.split("?");n.path=e&&e!=="/"?e:void 0,n.query=t,n.resourceName=void 0}return n.fragment=void 0,n}function L2(n,e){if(!n.path)return n.error="URN can not be parsed",n;let t=n.path.match(S2);if(t){let o=e.scheme||n.scheme||"urn";n.nid=t[1].toLowerCase(),n.nss=t[2];let r=`${o}:${e.nid||n.nid}`,i=Av(r);n.path=void 0,i&&(n=i.parse(n,e))}else n.error=n.error||"URN can not be parsed.";return n}function N2(n,e){if(n.nid===void 0)throw new Error("URN without nid cannot be serialized");let t=e.scheme||n.scheme||"urn",o=n.nid.toLowerCase(),r=`${t}:${e.nid||o}`,i=Av(r);i&&(n=i.serialize(n,e));let a=n,s=n.nss;return a.path=`${o||e.nid}:${s}`,e.skipEscape=!0,a}function z2(n,e){let t=n;return t.uuid=t.nss,t.nss=void 0,!e.tolerant&&(!t.uuid||!M2(t.uuid))&&(t.error=t.error||"UUID is not valid."),t}function D2(n){let e=n;return e.nss=(n.uuid||"").toLowerCase(),e}var cI={scheme:"http",domainHost:!0,parse:aI,serialize:sI},q2={scheme:"https",domainHost:cI.domainHost,parse:aI,serialize:sI},Mp={scheme:"ws",domainHost:!0,parse:R2,serialize:O2},F2={scheme:"wss",domainHost:Mp.domainHost,parse:Mp.parse,serialize:Mp.serialize},B2={scheme:"urn",parse:L2,serialize:N2,skipNormalize:!0},U2={scheme:"urn:uuid",parse:z2,serialize:D2,skipNormalize:!0},Sp={http:cI,https:q2,ws:Mp,wss:F2,urn:B2,"urn:uuid":U2};Object.setPrototypeOf(Sp,null);function Av(n){return n&&(Sp[n]||Sp[n.toLowerCase()])||void 0}lI.exports={wsIsSecure:Iv,SCHEMES:Sp,isValidSchemeName:E2,getSchemeHandler:Av}});var mI=U((tY,Ep)=>{"use strict";var{normalizeIPv6:j2,removeDotSegments:ql,recomposeAuthority:K2,normalizeComponentEncoding:$p,isIPv4:H2,nonSimpleDomain:Z2}=Tv(),{SCHEMES:G2,getSchemeHandler:dI}=uI();function V2(n,e){return typeof n=="string"?n=_o(tr(n,e),e):typeof n=="object"&&(n=tr(_o(n,e),e)),n}function Q2(n,e,t){let o=t?Object.assign({scheme:"null"},t):{scheme:"null"},r=pI(tr(n,o),tr(e,o),o,!0);return o.skipEscape=!0,_o(r,o)}function pI(n,e,t,o){let r={};return o||(n=tr(_o(n,t),t),e=tr(_o(e,t),t)),t=t||{},!t.tolerant&&e.scheme?(r.scheme=e.scheme,r.userinfo=e.userinfo,r.host=e.host,r.port=e.port,r.path=ql(e.path||""),r.query=e.query):(e.userinfo!==void 0||e.host!==void 0||e.port!==void 0?(r.userinfo=e.userinfo,r.host=e.host,r.port=e.port,r.path=ql(e.path||""),r.query=e.query):(e.path?(e.path[0]==="/"?r.path=ql(e.path):((n.userinfo!==void 0||n.host!==void 0||n.port!==void 0)&&!n.path?r.path="/"+e.path:n.path?r.path=n.path.slice(0,n.path.lastIndexOf("/")+1)+e.path:r.path=e.path,r.path=ql(r.path)),r.query=e.query):(r.path=n.path,e.query!==void 0?r.query=e.query:r.query=n.query),r.userinfo=n.userinfo,r.host=n.host,r.port=n.port),r.scheme=n.scheme),r.fragment=e.fragment,r}function W2(n,e,t){return typeof n=="string"?(n=unescape(n),n=_o($p(tr(n,t),!0),{...t,skipEscape:!0})):typeof n=="object"&&(n=_o($p(n,!0),{...t,skipEscape:!0})),typeof e=="string"?(e=unescape(e),e=_o($p(tr(e,t),!0),{...t,skipEscape:!0})):typeof e=="object"&&(e=_o($p(e,!0),{...t,skipEscape:!0})),n.toLowerCase()===e.toLowerCase()}function _o(n,e){let t={host:n.host,scheme:n.scheme,userinfo:n.userinfo,port:n.port,path:n.path,query:n.query,nid:n.nid,nss:n.nss,uuid:n.uuid,fragment:n.fragment,reference:n.reference,resourceName:n.resourceName,secure:n.secure,error:""},o=Object.assign({},e),r=[],i=dI(o.scheme||t.scheme);i&&i.serialize&&i.serialize(t,o),t.path!==void 0&&(o.skipEscape?t.path=unescape(t.path):(t.path=escape(t.path),t.scheme!==void 0&&(t.path=t.path.split("%3A").join(":")))),o.reference!=="suffix"&&t.scheme&&r.push(t.scheme,":");let a=K2(t);if(a!==void 0&&(o.reference!=="suffix"&&r.push("//"),r.push(a),t.path&&t.path[0]!=="/"&&r.push("/")),t.path!==void 0){let s=t.path;!o.absolutePath&&(!i||!i.absolutePath)&&(s=ql(s)),a===void 0&&s[0]==="/"&&s[1]==="/"&&(s="/%2F"+s.slice(2)),r.push(s)}return t.query!==void 0&&r.push("?",t.query),t.fragment!==void 0&&r.push("#",t.fragment),r.join("")}var J2=/^(?:([^#/:?]+):)?(?:\/\/((?:([^#/?@]*)@)?(\[[^#/?\]]+\]|[^#/:?]*)(?::(\d*))?))?([^#?]*)(?:\?([^#]*))?(?:#((?:.|[\n\r])*))?/u;function tr(n,e){let t=Object.assign({},e),o={scheme:void 0,userinfo:void 0,host:"",port:void 0,path:"",query:void 0,fragment:void 0},r=!1;t.reference==="suffix"&&(t.scheme?n=t.scheme+":"+n:n="//"+n);let i=n.match(J2);if(i){if(o.scheme=i[1],o.userinfo=i[3],o.host=i[4],o.port=parseInt(i[5],10),o.path=i[6]||"",o.query=i[7],o.fragment=i[8],isNaN(o.port)&&(o.port=i[5]),o.host)if(H2(o.host)===!1){let c=j2(o.host);o.host=c.host.toLowerCase(),r=c.isIPV6}else r=!0;o.scheme===void 0&&o.userinfo===void 0&&o.host===void 0&&o.port===void 0&&o.query===void 0&&!o.path?o.reference="same-document":o.scheme===void 0?o.reference="relative":o.fragment===void 0?o.reference="absolute":o.reference="uri",t.reference&&t.reference!=="suffix"&&t.reference!==o.reference&&(o.error=o.error||"URI is not a "+t.reference+" reference.");let a=dI(t.scheme||o.scheme);if(!t.unicodeSupport&&(!a||!a.unicodeSupport)&&o.host&&(t.domainHost||a&&a.domainHost)&&r===!1&&Z2(o.host))try{o.host=URL.domainToASCII(o.host.toLowerCase())}catch(s){o.error=o.error||"Host's domain name can not be converted to ASCII: "+s}(!a||a&&!a.skipNormalize)&&(n.indexOf("%")!==-1&&(o.scheme!==void 0&&(o.scheme=unescape(o.scheme)),o.host!==void 0&&(o.host=unescape(o.host))),o.path&&(o.path=escape(unescape(o.path))),o.fragment&&(o.fragment=encodeURI(decodeURIComponent(o.fragment)))),a&&a.parse&&a.parse(o,t)}else o.error=o.error||"URI can not be parsed.";return o}var Pv={SCHEMES:G2,normalize:V2,resolve:Q2,resolveComponent:pI,equal:W2,serialize:_o,parse:tr};Ep.exports=Pv;Ep.exports.default=Pv;Ep.exports.fastUri=Pv});var hI=U(Mv=>{"use strict";Object.defineProperty(Mv,"__esModule",{value:!0});var fI=mI();fI.code='require("ajv/dist/runtime/uri").default';Mv.default=fI});var _I=U(Ut=>{"use strict";Object.defineProperty(Ut,"__esModule",{value:!0});Ut.CodeGen=Ut.Name=Ut.nil=Ut.stringify=Ut.str=Ut._=Ut.KeywordCxt=void 0;var X2=zl();Object.defineProperty(Ut,"KeywordCxt",{enumerable:!0,get:function(){return X2.KeywordCxt}});var qs=le();Object.defineProperty(Ut,"_",{enumerable:!0,get:function(){return qs._}});Object.defineProperty(Ut,"str",{enumerable:!0,get:function(){return qs.str}});Object.defineProperty(Ut,"stringify",{enumerable:!0,get:function(){return qs.stringify}});Object.defineProperty(Ut,"nil",{enumerable:!0,get:function(){return qs.nil}});Object.defineProperty(Ut,"Name",{enumerable:!0,get:function(){return qs.Name}});Object.defineProperty(Ut,"CodeGen",{enumerable:!0,get:function(){return qs.CodeGen}});var Y2=Ip(),bI=Dl(),eN=rv(),Fl=Pp(),tN=le(),Bl=Ol(),Rp=Rl(),$v=xe(),gI=tI(),nN=hI(),wI=(n,e)=>new RegExp(n,e);wI.code="new RegExp";var oN=["removeAdditional","useDefaults","coerceTypes"],rN=new Set(["validate","serialize","parse","wrapper","root","schema","keyword","pattern","formats","validate$data","func","obj","Error"]),iN={errorDataPath:"",format:"`validateFormats: false` can be used instead.",nullable:'"nullable" keyword is supported by default.',jsonPointers:"Deprecated jsPropertySyntax can be used instead.",extendRefs:"Deprecated ignoreKeywordsWithRef can be used instead.",missingRefs:"Pass empty schema with $id that should be ignored to ajv.addSchema.",processCode:"Use option `code: {process: (code, schemaEnv: object) => string}`",sourceCode:"Use option `code: {source: true}`",strictDefaults:"It is default now, see option `strict`.",strictKeywords:"It is default now, see option `strict`.",uniqueItems:'"uniqueItems" keyword is always validated.',unknownFormats:"Disable strict mode or pass `true` to `ajv.addFormat` (or `formats` option).",cache:"Map is used as cache, schema object as key.",serialize:"Map is used as cache, schema object as key.",ajvErrors:"It is default now."},aN={ignoreKeywordsWithRef:"",jsPropertySyntax:"",unicode:'"minLength"/"maxLength" account for unicode characters by default.'},vI=200;function sN(n){var e,t,o,r,i,a,s,c,l,d,p,f,m,h,g,v,k,x,y,w,b,C,I,$,M;let A=n.strict,z=(e=n.code)===null||e===void 0?void 0:e.optimize,F=z===!0||z===void 0?1:z||0,q=(o=(t=n.code)===null||t===void 0?void 0:t.regExp)!==null&&o!==void 0?o:wI,oe=(r=n.uriResolver)!==null&&r!==void 0?r:nN.default;return{strictSchema:(a=(i=n.strictSchema)!==null&&i!==void 0?i:A)!==null&&a!==void 0?a:!0,strictNumbers:(c=(s=n.strictNumbers)!==null&&s!==void 0?s:A)!==null&&c!==void 0?c:!0,strictTypes:(d=(l=n.strictTypes)!==null&&l!==void 0?l:A)!==null&&d!==void 0?d:"log",strictTuples:(f=(p=n.strictTuples)!==null&&p!==void 0?p:A)!==null&&f!==void 0?f:"log",strictRequired:(h=(m=n.strictRequired)!==null&&m!==void 0?m:A)!==null&&h!==void 0?h:!1,code:n.code?{...n.code,optimize:F,regExp:q}:{optimize:F,regExp:q},loopRequired:(g=n.loopRequired)!==null&&g!==void 0?g:vI,loopEnum:(v=n.loopEnum)!==null&&v!==void 0?v:vI,meta:(k=n.meta)!==null&&k!==void 0?k:!0,messages:(x=n.messages)!==null&&x!==void 0?x:!0,inlineRefs:(y=n.inlineRefs)!==null&&y!==void 0?y:!0,schemaId:(w=n.schemaId)!==null&&w!==void 0?w:"$id",addUsedSchema:(b=n.addUsedSchema)!==null&&b!==void 0?b:!0,validateSchema:(C=n.validateSchema)!==null&&C!==void 0?C:!0,validateFormats:(I=n.validateFormats)!==null&&I!==void 0?I:!0,unicodeRegExp:($=n.unicodeRegExp)!==null&&$!==void 0?$:!0,int32range:(M=n.int32range)!==null&&M!==void 0?M:!0,uriResolver:oe}}var Ul=class{constructor(e={}){this.schemas={},this.refs={},this.formats={},this._compilations=new Set,this._loading={},this._cache=new Map,e=this.opts={...e,...sN(e)};let{es5:t,lines:o}=this.opts.code;this.scope=new tN.ValueScope({scope:{},prefixes:rN,es5:t,lines:o}),this.logger=mN(e.logger);let r=e.validateFormats;e.validateFormats=!1,this.RULES=(0,eN.getRules)(),yI.call(this,iN,e,"NOT SUPPORTED"),yI.call(this,aN,e,"DEPRECATED","warn"),this._metaOpts=dN.call(this),e.formats&&lN.call(this),this._addVocabularies(),this._addDefaultMetaSchema(),e.keywords&&uN.call(this,e.keywords),typeof e.meta=="object"&&this.addMetaSchema(e.meta),cN.call(this),e.validateFormats=r}_addVocabularies(){this.addKeyword("$async")}_addDefaultMetaSchema(){let{$data:e,meta:t,schemaId:o}=this.opts,r=gI;o==="id"&&(r={...gI},r.id=r.$id,delete r.$id),t&&e&&this.addMetaSchema(r,r[o],!1)}defaultMeta(){let{meta:e,schemaId:t}=this.opts;return this.opts.defaultMeta=typeof e=="object"?e[t]||e:void 0}validate(e,t){let o;if(typeof e=="string"){if(o=this.getSchema(e),!o)throw new Error(`no schema with key or ref "${e}"`)}else o=this.compile(e);let r=o(t);return"$async"in o||(this.errors=o.errors),r}compile(e,t){let o=this._addSchema(e,t);return o.validate||this._compileSchemaEnv(o)}compileAsync(e,t){if(typeof this.opts.loadSchema!="function")throw new Error("options.loadSchema should be a function");let{loadSchema:o}=this.opts;return r.call(this,e,t);async function r(d,p){await i.call(this,d.$schema);let f=this._addSchema(d,p);return f.validate||a.call(this,f)}async function i(d){d&&!this.getSchema(d)&&await r.call(this,{$ref:d},!0)}async function a(d){try{return this._compileSchemaEnv(d)}catch(p){if(!(p instanceof bI.default))throw p;return s.call(this,p),await c.call(this,p.missingSchema),a.call(this,d)}}function s({missingSchema:d,missingRef:p}){if(this.refs[d])throw new Error(`AnySchema ${d} is loaded but ${p} cannot be resolved`)}async function c(d){let p=await l.call(this,d);this.refs[d]||await i.call(this,p.$schema),this.refs[d]||this.addSchema(p,d,t)}async function l(d){let p=this._loading[d];if(p)return p;try{return await(this._loading[d]=o(d))}finally{delete this._loading[d]}}}addSchema(e,t,o,r=this.opts.validateSchema){if(Array.isArray(e)){for(let a of e)this.addSchema(a,void 0,o,r);return this}let i;if(typeof e=="object"){let{schemaId:a}=this.opts;if(i=e[a],i!==void 0&&typeof i!="string")throw new Error(`schema ${a} must be string`)}return t=(0,Bl.normalizeId)(t||i),this._checkUnique(t),this.schemas[t]=this._addSchema(e,o,t,r,!0),this}addMetaSchema(e,t,o=this.opts.validateSchema){return this.addSchema(e,t,!0,o),this}validateSchema(e,t){if(typeof e=="boolean")return!0;let o;if(o=e.$schema,o!==void 0&&typeof o!="string")throw new Error("$schema must be a string");if(o=o||this.opts.defaultMeta||this.defaultMeta(),!o)return this.logger.warn("meta-schema not available"),this.errors=null,!0;let r=this.validate(o,e);if(!r&&t){let i="schema is invalid: "+this.errorsText();if(this.opts.validateSchema==="log")this.logger.error(i);else throw new Error(i)}return r}getSchema(e){let t;for(;typeof(t=xI.call(this,e))=="string";)e=t;if(t===void 0){let{schemaId:o}=this.opts,r=new Fl.SchemaEnv({schema:{},schemaId:o});if(t=Fl.resolveSchema.call(this,r,e),!t)return;this.refs[e]=t}return t.validate||this._compileSchemaEnv(t)}removeSchema(e){if(e instanceof RegExp)return this._removeAllSchemas(this.schemas,e),this._removeAllSchemas(this.refs,e),this;switch(typeof e){case"undefined":return this._removeAllSchemas(this.schemas),this._removeAllSchemas(this.refs),this._cache.clear(),this;case"string":{let t=xI.call(this,e);return typeof t=="object"&&this._cache.delete(t.schema),delete this.schemas[e],delete this.refs[e],this}case"object":{let t=e;this._cache.delete(t);let o=e[this.opts.schemaId];return o&&(o=(0,Bl.normalizeId)(o),delete this.schemas[o],delete this.refs[o]),this}default:throw new Error("ajv.removeSchema: invalid parameter")}}addVocabulary(e){for(let t of e)this.addKeyword(t);return this}addKeyword(e,t){let o;if(typeof e=="string")o=e,typeof t=="object"&&(this.logger.warn("these parameters are deprecated, see docs for addKeyword"),t.keyword=o);else if(typeof e=="object"&&t===void 0){if(t=e,o=t.keyword,Array.isArray(o)&&!o.length)throw new Error("addKeywords: keyword must be string or non-empty array")}else throw new Error("invalid addKeywords parameters");if(hN.call(this,o,t),!t)return(0,$v.eachItem)(o,i=>Sv.call(this,i)),this;vN.call(this,t);let r={...t,type:(0,Rp.getJSONTypes)(t.type),schemaType:(0,Rp.getJSONTypes)(t.schemaType)};return(0,$v.eachItem)(o,r.type.length===0?i=>Sv.call(this,i,r):i=>r.type.forEach(a=>Sv.call(this,i,r,a))),this}getKeyword(e){let t=this.RULES.all[e];return typeof t=="object"?t.definition:!!t}removeKeyword(e){let{RULES:t}=this;delete t.keywords[e],delete t.all[e];for(let o of t.rules){let r=o.rules.findIndex(i=>i.keyword===e);r>=0&&o.rules.splice(r,1)}return this}addFormat(e,t){return typeof t=="string"&&(t=new RegExp(t)),this.formats[e]=t,this}errorsText(e=this.errors,{separator:t=", ",dataVar:o="data"}={}){return!e||e.length===0?"No errors":e.map(r=>`${o}${r.instancePath} ${r.message}`).reduce((r,i)=>r+t+i)}$dataMetaSchema(e,t){let o=this.RULES.all;e=JSON.parse(JSON.stringify(e));for(let r of t){let i=r.split("/").slice(1),a=e;for(let s of i)a=a[s];for(let s in o){let c=o[s];if(typeof c!="object")continue;let{$data:l}=c.definition,d=a[s];l&&d&&(a[s]=kI(d))}}return e}_removeAllSchemas(e,t){for(let o in e){let r=e[o];(!t||t.test(o))&&(typeof r=="string"?delete e[o]:r&&!r.meta&&(this._cache.delete(r.schema),delete e[o]))}}_addSchema(e,t,o,r=this.opts.validateSchema,i=this.opts.addUsedSchema){let a,{schemaId:s}=this.opts;if(typeof e=="object")a=e[s];else{if(this.opts.jtd)throw new Error("schema must be object");if(typeof e!="boolean")throw new Error("schema must be object or boolean")}let c=this._cache.get(e);if(c!==void 0)return c;o=(0,Bl.normalizeId)(a||o);let l=Bl.getSchemaRefs.call(this,e,o);return c=new Fl.SchemaEnv({schema:e,schemaId:s,meta:t,baseId:o,localRefs:l}),this._cache.set(c.schema,c),i&&!o.startsWith("#")&&(o&&this._checkUnique(o),this.refs[o]=c),r&&this.validateSchema(e,!0),c}_checkUnique(e){if(this.schemas[e]||this.refs[e])throw new Error(`schema with key or id "${e}" already exists`)}_compileSchemaEnv(e){if(e.meta?this._compileMetaSchema(e):Fl.compileSchema.call(this,e),!e.validate)throw new Error("ajv implementation error");return e.validate}_compileMetaSchema(e){let t=this.opts;this.opts=this._metaOpts;try{Fl.compileSchema.call(this,e)}finally{this.opts=t}}};Ul.ValidationError=Y2.default;Ul.MissingRefError=bI.default;Ut.default=Ul;function yI(n,e,t,o="error"){for(let r in n){let i=r;i in e&&this.logger[o](`${t}: option ${r}. ${n[i]}`)}}function xI(n){return n=(0,Bl.normalizeId)(n),this.schemas[n]||this.refs[n]}function cN(){let n=this.opts.schemas;if(n)if(Array.isArray(n))this.addSchema(n);else for(let e in n)this.addSchema(n[e],e)}function lN(){for(let n in this.opts.formats){let e=this.opts.formats[n];e&&this.addFormat(n,e)}}function uN(n){if(Array.isArray(n)){this.addVocabulary(n);return}this.logger.warn("keywords option as map is deprecated, pass array");for(let e in n){let t=n[e];t.keyword||(t.keyword=e),this.addKeyword(t)}}function dN(){let n={...this.opts};for(let e of oN)delete n[e];return n}var pN={log(){},warn(){},error(){}};function mN(n){if(n===!1)return pN;if(n===void 0)return console;if(n.log&&n.warn&&n.error)return n;throw new Error("logger must implement log, warn and error methods")}var fN=/^[a-z_$][a-z0-9_$:-]*$/i;function hN(n,e){let{RULES:t}=this;if((0,$v.eachItem)(n,o=>{if(t.keywords[o])throw new Error(`Keyword ${o} is already defined`);if(!fN.test(o))throw new Error(`Keyword ${o} has invalid name`)}),!!e&&e.$data&&!("code"in e||"validate"in e))throw new Error('$data keyword must have "code" or "validate" function')}function Sv(n,e,t){var o;let r=e?.post;if(t&&r)throw new Error('keyword with "post" flag cannot have "type"');let{RULES:i}=this,a=r?i.post:i.rules.find(({type:c})=>c===t);if(a||(a={type:t,rules:[]},i.rules.push(a)),i.keywords[n]=!0,!e)return;let s={keyword:n,definition:{...e,type:(0,Rp.getJSONTypes)(e.type),schemaType:(0,Rp.getJSONTypes)(e.schemaType)}};e.before?gN.call(this,a,s,e.before):a.rules.push(s),i.all[n]=s,(o=e.implements)===null||o===void 0||o.forEach(c=>this.addKeyword(c))}function gN(n,e,t){let o=n.rules.findIndex(r=>r.keyword===t);o>=0?n.rules.splice(o,0,e):(n.rules.push(e),this.logger.warn(`rule ${t} is not defined`))}function vN(n){let{metaSchema:e}=n;e!==void 0&&(n.$data&&this.opts.$data&&(e=kI(e)),n.validateSchema=this.compile(e,!0))}var yN={$ref:"https://raw.githubusercontent.com/ajv-validator/ajv/master/lib/refs/data.json#"};function kI(n){return{anyOf:[n,yN]}}});var CI=U(Ev=>{"use strict";Object.defineProperty(Ev,"__esModule",{value:!0});var xN={keyword:"id",code(){throw new Error('NOT SUPPORTED: keyword "id", use "$id" for schema ID')}};Ev.default=xN});var PI=U(Ui=>{"use strict";Object.defineProperty(Ui,"__esModule",{value:!0});Ui.callRef=Ui.getValidate=void 0;var bN=Dl(),TI=qn(),gn=le(),Fs=Yo(),II=Pp(),Op=xe(),wN={keyword:"$ref",schemaType:"string",code(n){let{gen:e,schema:t,it:o}=n,{baseId:r,schemaEnv:i,validateName:a,opts:s,self:c}=o,{root:l}=i;if((t==="#"||t==="#/")&&r===l.baseId)return p();let d=II.resolveRef.call(c,l,r,t);if(d===void 0)throw new bN.default(o.opts.uriResolver,r,t);if(d instanceof II.SchemaEnv)return f(d);return m(d);function p(){if(i===l)return Lp(n,a,i,i.$async);let h=e.scopeValue("root",{ref:l});return Lp(n,(0,gn._)`${h}.validate`,l,l.$async)}function f(h){let g=AI(n,h);Lp(n,g,h,h.$async)}function m(h){let g=e.scopeValue("schema",s.code.source===!0?{ref:h,code:(0,gn.stringify)(h)}:{ref:h}),v=e.name("valid"),k=n.subschema({schema:h,dataTypes:[],schemaPath:gn.nil,topSchemaRef:g,errSchemaPath:t},v);n.mergeEvaluated(k),n.ok(v)}}};function AI(n,e){let{gen:t}=n;return e.validate?t.scopeValue("validate",{ref:e.validate}):(0,gn._)`${t.scopeValue("wrapper",{ref:e})}.validate`}Ui.getValidate=AI;function Lp(n,e,t,o){let{gen:r,it:i}=n,{allErrors:a,schemaEnv:s,opts:c}=i,l=c.passContext?Fs.default.this:gn.nil;o?d():p();function d(){if(!s.$async)throw new Error("async schema referenced by sync schema");let h=r.let("valid");r.try(()=>{r.code((0,gn._)`await ${(0,TI.callValidateCode)(n,e,l)}`),m(e),a||r.assign(h,!0)},g=>{r.if((0,gn._)`!(${g} instanceof ${i.ValidationError})`,()=>r.throw(g)),f(g),a||r.assign(h,!1)}),n.ok(h)}function p(){n.result((0,TI.callValidateCode)(n,e,l),()=>m(e),()=>f(e))}function f(h){let g=(0,gn._)`${h}.errors`;r.assign(Fs.default.vErrors,(0,gn._)`${Fs.default.vErrors} === null ? ${g} : ${Fs.default.vErrors}.concat(${g})`),r.assign(Fs.default.errors,(0,gn._)`${Fs.default.vErrors}.length`)}function m(h){var g;if(!i.opts.unevaluated)return;let v=(g=t?.validate)===null||g===void 0?void 0:g.evaluated;if(i.props!==!0)if(v&&!v.dynamicProps)v.props!==void 0&&(i.props=Op.mergeEvaluated.props(r,v.props,i.props));else{let k=r.var("props",(0,gn._)`${h}.evaluated.props`);i.props=Op.mergeEvaluated.props(r,k,i.props,gn.Name)}if(i.items!==!0)if(v&&!v.dynamicItems)v.items!==void 0&&(i.items=Op.mergeEvaluated.items(r,v.items,i.items));else{let k=r.var("items",(0,gn._)`${h}.evaluated.items`);i.items=Op.mergeEvaluated.items(r,k,i.items,gn.Name)}}}Ui.callRef=Lp;Ui.default=wN});var MI=U(Rv=>{"use strict";Object.defineProperty(Rv,"__esModule",{value:!0});var kN=CI(),_N=PI(),CN=["$schema","$id","$defs","$vocabulary",{keyword:"$comment"},"definitions",kN.default,_N.default];Rv.default=CN});var SI=U(Ov=>{"use strict";Object.defineProperty(Ov,"__esModule",{value:!0});var Np=le(),Kr=Np.operators,zp={maximum:{okStr:"<=",ok:Kr.LTE,fail:Kr.GT},minimum:{okStr:">=",ok:Kr.GTE,fail:Kr.LT},exclusiveMaximum:{okStr:"<",ok:Kr.LT,fail:Kr.GTE},exclusiveMinimum:{okStr:">",ok:Kr.GT,fail:Kr.LTE}},TN={message:({keyword:n,schemaCode:e})=>(0,Np.str)`must be ${zp[n].okStr} ${e}`,params:({keyword:n,schemaCode:e})=>(0,Np._)`{comparison: ${zp[n].okStr}, limit: ${e}}`},IN={keyword:Object.keys(zp),type:"number",schemaType:"number",$data:!0,error:TN,code(n){let{keyword:e,data:t,schemaCode:o}=n;n.fail$data((0,Np._)`${t} ${zp[e].fail} ${o} || isNaN(${t})`)}};Ov.default=IN});var $I=U(Lv=>{"use strict";Object.defineProperty(Lv,"__esModule",{value:!0});var jl=le(),AN={message:({schemaCode:n})=>(0,jl.str)`must be multiple of ${n}`,params:({schemaCode:n})=>(0,jl._)`{multipleOf: ${n}}`},PN={keyword:"multipleOf",type:"number",schemaType:"number",$data:!0,error:AN,code(n){let{gen:e,data:t,schemaCode:o,it:r}=n,i=r.opts.multipleOfPrecision,a=e.let("res"),s=i?(0,jl._)`Math.abs(Math.round(${a}) - ${a}) > 1e-${i}`:(0,jl._)`${a} !== parseInt(${a})`;n.fail$data((0,jl._)`(${o} === 0 || (${a} = ${t}/${o}, ${s}))`)}};Lv.default=PN});var RI=U(Nv=>{"use strict";Object.defineProperty(Nv,"__esModule",{value:!0});function EI(n){let e=n.length,t=0,o=0,r;for(;o<e;)t++,r=n.charCodeAt(o++),r>=55296&&r<=56319&&o<e&&(r=n.charCodeAt(o),(r&64512)===56320&&o++);return t}Nv.default=EI;EI.code='require("ajv/dist/runtime/ucs2length").default'});var OI=U(zv=>{"use strict";Object.defineProperty(zv,"__esModule",{value:!0});var ji=le(),MN=xe(),SN=RI(),$N={message({keyword:n,schemaCode:e}){let t=n==="maxLength"?"more":"fewer";return(0,ji.str)`must NOT have ${t} than ${e} characters`},params:({schemaCode:n})=>(0,ji._)`{limit: ${n}}`},EN={keyword:["maxLength","minLength"],type:"string",schemaType:"number",$data:!0,error:$N,code(n){let{keyword:e,data:t,schemaCode:o,it:r}=n,i=e==="maxLength"?ji.operators.GT:ji.operators.LT,a=r.opts.unicode===!1?(0,ji._)`${t}.length`:(0,ji._)`${(0,MN.useFunc)(n.gen,SN.default)}(${t})`;n.fail$data((0,ji._)`${a} ${i} ${o}`)}};zv.default=EN});var LI=U(Dv=>{"use strict";Object.defineProperty(Dv,"__esModule",{value:!0});var RN=qn(),Dp=le(),ON={message:({schemaCode:n})=>(0,Dp.str)`must match pattern "${n}"`,params:({schemaCode:n})=>(0,Dp._)`{pattern: ${n}}`},LN={keyword:"pattern",type:"string",schemaType:"string",$data:!0,error:ON,code(n){let{data:e,$data:t,schema:o,schemaCode:r,it:i}=n,a=i.opts.unicodeRegExp?"u":"",s=t?(0,Dp._)`(new RegExp(${r}, ${a}))`:(0,RN.usePattern)(n,o);n.fail$data((0,Dp._)`!${s}.test(${e})`)}};Dv.default=LN});var NI=U(qv=>{"use strict";Object.defineProperty(qv,"__esModule",{value:!0});var Kl=le(),NN={message({keyword:n,schemaCode:e}){let t=n==="maxProperties"?"more":"fewer";return(0,Kl.str)`must NOT have ${t} than ${e} properties`},params:({schemaCode:n})=>(0,Kl._)`{limit: ${n}}`},zN={keyword:["maxProperties","minProperties"],type:"object",schemaType:"number",$data:!0,error:NN,code(n){let{keyword:e,data:t,schemaCode:o}=n,r=e==="maxProperties"?Kl.operators.GT:Kl.operators.LT;n.fail$data((0,Kl._)`Object.keys(${t}).length ${r} ${o}`)}};qv.default=zN});var zI=U(Fv=>{"use strict";Object.defineProperty(Fv,"__esModule",{value:!0});var Hl=qn(),Zl=le(),DN=xe(),qN={message:({params:{missingProperty:n}})=>(0,Zl.str)`must have required property '${n}'`,params:({params:{missingProperty:n}})=>(0,Zl._)`{missingProperty: ${n}}`},FN={keyword:"required",type:"object",schemaType:"array",$data:!0,error:qN,code(n){let{gen:e,schema:t,schemaCode:o,data:r,$data:i,it:a}=n,{opts:s}=a;if(!i&&t.length===0)return;let c=t.length>=s.loopRequired;if(a.allErrors?l():d(),s.strictRequired){let m=n.parentSchema.properties,{definedProperties:h}=n.it;for(let g of t)if(m?.[g]===void 0&&!h.has(g)){let v=a.schemaEnv.baseId+a.errSchemaPath,k=`required property "${g}" is not defined at "${v}" (strictRequired)`;(0,DN.checkStrictMode)(a,k,a.opts.strictRequired)}}function l(){if(c||i)n.block$data(Zl.nil,p);else for(let m of t)(0,Hl.checkReportMissingProp)(n,m)}function d(){let m=e.let("missing");if(c||i){let h=e.let("valid",!0);n.block$data(h,()=>f(m,h)),n.ok(h)}else e.if((0,Hl.checkMissingProp)(n,t,m)),(0,Hl.reportMissingProp)(n,m),e.else()}function p(){e.forOf("prop",o,m=>{n.setParams({missingProperty:m}),e.if((0,Hl.noPropertyInData)(e,r,m,s.ownProperties),()=>n.error())})}function f(m,h){n.setParams({missingProperty:m}),e.forOf(m,o,()=>{e.assign(h,(0,Hl.propertyInData)(e,r,m,s.ownProperties)),e.if((0,Zl.not)(h),()=>{n.error(),e.break()})},Zl.nil)}}};Fv.default=FN});var DI=U(Bv=>{"use strict";Object.defineProperty(Bv,"__esModule",{value:!0});var Gl=le(),BN={message({keyword:n,schemaCode:e}){let t=n==="maxItems"?"more":"fewer";return(0,Gl.str)`must NOT have ${t} than ${e} items`},params:({schemaCode:n})=>(0,Gl._)`{limit: ${n}}`},UN={keyword:["maxItems","minItems"],type:"array",schemaType:"number",$data:!0,error:BN,code(n){let{keyword:e,data:t,schemaCode:o}=n,r=e==="maxItems"?Gl.operators.GT:Gl.operators.LT;n.fail$data((0,Gl._)`${t}.length ${r} ${o}`)}};Bv.default=UN});var qp=U(Uv=>{"use strict";Object.defineProperty(Uv,"__esModule",{value:!0});var qI=pv();qI.code='require("ajv/dist/runtime/equal").default';Uv.default=qI});var FI=U(Kv=>{"use strict";Object.defineProperty(Kv,"__esModule",{value:!0});var jv=Rl(),jt=le(),jN=xe(),KN=qp(),HN={message:({params:{i:n,j:e}})=>(0,jt.str)`must NOT have duplicate items (items ## ${e} and ${n} are identical)`,params:({params:{i:n,j:e}})=>(0,jt._)`{i: ${n}, j: ${e}}`},ZN={keyword:"uniqueItems",type:"array",schemaType:"boolean",$data:!0,error:HN,code(n){let{gen:e,data:t,$data:o,schema:r,parentSchema:i,schemaCode:a,it:s}=n;if(!o&&!r)return;let c=e.let("valid"),l=i.items?(0,jv.getSchemaTypes)(i.items):[];n.block$data(c,d,(0,jt._)`${a} === false`),n.ok(c);function d(){let h=e.let("i",(0,jt._)`${t}.length`),g=e.let("j");n.setParams({i:h,j:g}),e.assign(c,!0),e.if((0,jt._)`${h} > 1`,()=>(p()?f:m)(h,g))}function p(){return l.length>0&&!l.some(h=>h==="object"||h==="array")}function f(h,g){let v=e.name("item"),k=(0,jv.checkDataTypes)(l,v,s.opts.strictNumbers,jv.DataType.Wrong),x=e.const("indices",(0,jt._)`{}`);e.for((0,jt._)`;${h}--;`,()=>{e.let(v,(0,jt._)`${t}[${h}]`),e.if(k,(0,jt._)`continue`),l.length>1&&e.if((0,jt._)`typeof ${v} == "string"`,(0,jt._)`${v} += "_"`),e.if((0,jt._)`typeof ${x}[${v}] == "number"`,()=>{e.assign(g,(0,jt._)`${x}[${v}]`),n.error(),e.assign(c,!1).break()}).code((0,jt._)`${x}[${v}] = ${h}`)})}function m(h,g){let v=(0,jN.useFunc)(e,KN.default),k=e.name("outer");e.label(k).for((0,jt._)`;${h}--;`,()=>e.for((0,jt._)`${g} = ${h}; ${g}--;`,()=>e.if((0,jt._)`${v}(${t}[${h}], ${t}[${g}])`,()=>{n.error(),e.assign(c,!1).break(k)})))}}};Kv.default=ZN});var BI=U(Zv=>{"use strict";Object.defineProperty(Zv,"__esModule",{value:!0});var Hv=le(),GN=xe(),VN=qp(),QN={message:"must be equal to constant",params:({schemaCode:n})=>(0,Hv._)`{allowedValue: ${n}}`},WN={keyword:"const",$data:!0,error:QN,code(n){let{gen:e,data:t,$data:o,schemaCode:r,schema:i}=n;o||i&&typeof i=="object"?n.fail$data((0,Hv._)`!${(0,GN.useFunc)(e,VN.default)}(${t}, ${r})`):n.fail((0,Hv._)`${i} !== ${t}`)}};Zv.default=WN});var UI=U(Gv=>{"use strict";Object.defineProperty(Gv,"__esModule",{value:!0});var Vl=le(),JN=xe(),XN=qp(),YN={message:"must be equal to one of the allowed values",params:({schemaCode:n})=>(0,Vl._)`{allowedValues: ${n}}`},ez={keyword:"enum",schemaType:"array",$data:!0,error:YN,code(n){let{gen:e,data:t,$data:o,schema:r,schemaCode:i,it:a}=n;if(!o&&r.length===0)throw new Error("enum must have non-empty array");let s=r.length>=a.opts.loopEnum,c,l=()=>c??(c=(0,JN.useFunc)(e,XN.default)),d;if(s||o)d=e.let("valid"),n.block$data(d,p);else{if(!Array.isArray(r))throw new Error("ajv implementation error");let m=e.const("vSchema",i);d=(0,Vl.or)(...r.map((h,g)=>f(m,g)))}n.pass(d);function p(){e.assign(d,!1),e.forOf("v",i,m=>e.if((0,Vl._)`${l()}(${t}, ${m})`,()=>e.assign(d,!0).break()))}function f(m,h){let g=r[h];return typeof g=="object"&&g!==null?(0,Vl._)`${l()}(${t}, ${m}[${h}])`:(0,Vl._)`${t} === ${g}`}}};Gv.default=ez});var jI=U(Vv=>{"use strict";Object.defineProperty(Vv,"__esModule",{value:!0});var tz=SI(),nz=$I(),oz=OI(),rz=LI(),iz=NI(),az=zI(),sz=DI(),cz=FI(),lz=BI(),uz=UI(),dz=[tz.default,nz.default,oz.default,rz.default,iz.default,az.default,sz.default,cz.default,{keyword:"type",schemaType:["string","array"]},{keyword:"nullable",schemaType:"boolean"},lz.default,uz.default];Vv.default=dz});var Wv=U(Ql=>{"use strict";Object.defineProperty(Ql,"__esModule",{value:!0});Ql.validateAdditionalItems=void 0;var Ki=le(),Qv=xe(),pz={message:({params:{len:n}})=>(0,Ki.str)`must NOT have more than ${n} items`,params:({params:{len:n}})=>(0,Ki._)`{limit: ${n}}`},mz={keyword:"additionalItems",type:"array",schemaType:["boolean","object"],before:"uniqueItems",error:pz,code(n){let{parentSchema:e,it:t}=n,{items:o}=e;if(!Array.isArray(o)){(0,Qv.checkStrictMode)(t,'"additionalItems" is ignored when "items" is not an array of schemas');return}KI(n,o)}};function KI(n,e){let{gen:t,schema:o,data:r,keyword:i,it:a}=n;a.items=!0;let s=t.const("len",(0,Ki._)`${r}.length`);if(o===!1)n.setParams({len:e.length}),n.pass((0,Ki._)`${s} <= ${e.length}`);else if(typeof o=="object"&&!(0,Qv.alwaysValidSchema)(a,o)){let l=t.var("valid",(0,Ki._)`${s} <= ${e.length}`);t.if((0,Ki.not)(l),()=>c(l)),n.ok(l)}function c(l){t.forRange("i",e.length,s,d=>{n.subschema({keyword:i,dataProp:d,dataPropType:Qv.Type.Num},l),a.allErrors||t.if((0,Ki.not)(l),()=>t.break())})}}Ql.validateAdditionalItems=KI;Ql.default=mz});var Jv=U(Wl=>{"use strict";Object.defineProperty(Wl,"__esModule",{value:!0});Wl.validateTuple=void 0;var HI=le(),Fp=xe(),fz=qn(),hz={keyword:"items",type:"array",schemaType:["object","array","boolean"],before:"uniqueItems",code(n){let{schema:e,it:t}=n;if(Array.isArray(e))return ZI(n,"additionalItems",e);t.items=!0,!(0,Fp.alwaysValidSchema)(t,e)&&n.ok((0,fz.validateArray)(n))}};function ZI(n,e,t=n.schema){let{gen:o,parentSchema:r,data:i,keyword:a,it:s}=n;d(r),s.opts.unevaluated&&t.length&&s.items!==!0&&(s.items=Fp.mergeEvaluated.items(o,t.length,s.items));let c=o.name("valid"),l=o.const("len",(0,HI._)`${i}.length`);t.forEach((p,f)=>{(0,Fp.alwaysValidSchema)(s,p)||(o.if((0,HI._)`${l} > ${f}`,()=>n.subschema({keyword:a,schemaProp:f,dataProp:f},c)),n.ok(c))});function d(p){let{opts:f,errSchemaPath:m}=s,h=t.length,g=h===p.minItems&&(h===p.maxItems||p[e]===!1);if(f.strictTuples&&!g){let v=`"${a}" is ${h}-tuple, but minItems or maxItems/${e} are not specified or different at path "${m}"`;(0,Fp.checkStrictMode)(s,v,f.strictTuples)}}}Wl.validateTuple=ZI;Wl.default=hz});var GI=U(Xv=>{"use strict";Object.defineProperty(Xv,"__esModule",{value:!0});var gz=Jv(),vz={keyword:"prefixItems",type:"array",schemaType:["array"],before:"uniqueItems",code:n=>(0,gz.validateTuple)(n,"items")};Xv.default=vz});var QI=U(Yv=>{"use strict";Object.defineProperty(Yv,"__esModule",{value:!0});var VI=le(),yz=xe(),xz=qn(),bz=Wv(),wz={message:({params:{len:n}})=>(0,VI.str)`must NOT have more than ${n} items`,params:({params:{len:n}})=>(0,VI._)`{limit: ${n}}`},kz={keyword:"items",type:"array",schemaType:["object","boolean"],before:"uniqueItems",error:wz,code(n){let{schema:e,parentSchema:t,it:o}=n,{prefixItems:r}=t;o.items=!0,!(0,yz.alwaysValidSchema)(o,e)&&(r?(0,bz.validateAdditionalItems)(n,r):n.ok((0,xz.validateArray)(n)))}};Yv.default=kz});var WI=U(ey=>{"use strict";Object.defineProperty(ey,"__esModule",{value:!0});var Bn=le(),Bp=xe(),_z={message:({params:{min:n,max:e}})=>e===void 0?(0,Bn.str)`must contain at least ${n} valid item(s)`:(0,Bn.str)`must contain at least ${n} and no more than ${e} valid item(s)`,params:({params:{min:n,max:e}})=>e===void 0?(0,Bn._)`{minContains: ${n}}`:(0,Bn._)`{minContains: ${n}, maxContains: ${e}}`},Cz={keyword:"contains",type:"array",schemaType:["object","boolean"],before:"uniqueItems",trackErrors:!0,error:_z,code(n){let{gen:e,schema:t,parentSchema:o,data:r,it:i}=n,a,s,{minContains:c,maxContains:l}=o;i.opts.next?(a=c===void 0?1:c,s=l):a=1;let d=e.const("len",(0,Bn._)`${r}.length`);if(n.setParams({min:a,max:s}),s===void 0&&a===0){(0,Bp.checkStrictMode)(i,'"minContains" == 0 without "maxContains": "contains" keyword ignored');return}if(s!==void 0&&a>s){(0,Bp.checkStrictMode)(i,'"minContains" > "maxContains" is always invalid'),n.fail();return}if((0,Bp.alwaysValidSchema)(i,t)){let g=(0,Bn._)`${d} >= ${a}`;s!==void 0&&(g=(0,Bn._)`${g} && ${d} <= ${s}`),n.pass(g);return}i.items=!0;let p=e.name("valid");s===void 0&&a===1?m(p,()=>e.if(p,()=>e.break())):a===0?(e.let(p,!0),s!==void 0&&e.if((0,Bn._)`${r}.length > 0`,f)):(e.let(p,!1),f()),n.result(p,()=>n.reset());function f(){let g=e.name("_valid"),v=e.let("count",0);m(g,()=>e.if(g,()=>h(v)))}function m(g,v){e.forRange("i",0,d,k=>{n.subschema({keyword:"contains",dataProp:k,dataPropType:Bp.Type.Num,compositeRule:!0},g),v()})}function h(g){e.code((0,Bn._)`${g}++`),s===void 0?e.if((0,Bn._)`${g} >= ${a}`,()=>e.assign(p,!0).break()):(e.if((0,Bn._)`${g} > ${s}`,()=>e.assign(p,!1).break()),a===1?e.assign(p,!0):e.if((0,Bn._)`${g} >= ${a}`,()=>e.assign(p,!0)))}}};ey.default=Cz});var YI=U(Co=>{"use strict";Object.defineProperty(Co,"__esModule",{value:!0});Co.validateSchemaDeps=Co.validatePropertyDeps=Co.error=void 0;var ty=le(),Tz=xe(),Jl=qn();Co.error={message:({params:{property:n,depsCount:e,deps:t}})=>{let o=e===1?"property":"properties";return(0,ty.str)`must have ${o} ${t} when property ${n} is present`},params:({params:{property:n,depsCount:e,deps:t,missingProperty:o}})=>(0,ty._)`{property: ${n},
    missingProperty: ${o},
    depsCount: ${e},
    deps: ${t}}`};var Iz={keyword:"dependencies",type:"object",schemaType:"object",error:Co.error,code(n){let[e,t]=Az(n);JI(n,e),XI(n,t)}};function Az({schema:n}){let e={},t={};for(let o in n){if(o==="__proto__")continue;let r=Array.isArray(n[o])?e:t;r[o]=n[o]}return[e,t]}function JI(n,e=n.schema){let{gen:t,data:o,it:r}=n;if(Object.keys(e).length===0)return;let i=t.let("missing");for(let a in e){let s=e[a];if(s.length===0)continue;let c=(0,Jl.propertyInData)(t,o,a,r.opts.ownProperties);n.setParams({property:a,depsCount:s.length,deps:s.join(", ")}),r.allErrors?t.if(c,()=>{for(let l of s)(0,Jl.checkReportMissingProp)(n,l)}):(t.if((0,ty._)`${c} && (${(0,Jl.checkMissingProp)(n,s,i)})`),(0,Jl.reportMissingProp)(n,i),t.else())}}Co.validatePropertyDeps=JI;function XI(n,e=n.schema){let{gen:t,data:o,keyword:r,it:i}=n,a=t.name("valid");for(let s in e)(0,Tz.alwaysValidSchema)(i,e[s])||(t.if((0,Jl.propertyInData)(t,o,s,i.opts.ownProperties),()=>{let c=n.subschema({keyword:r,schemaProp:s},a);n.mergeValidEvaluated(c,a)},()=>t.var(a,!0)),n.ok(a))}Co.validateSchemaDeps=XI;Co.default=Iz});var tA=U(ny=>{"use strict";Object.defineProperty(ny,"__esModule",{value:!0});var eA=le(),Pz=xe(),Mz={message:"property name must be valid",params:({params:n})=>(0,eA._)`{propertyName: ${n.propertyName}}`},Sz={keyword:"propertyNames",type:"object",schemaType:["object","boolean"],error:Mz,code(n){let{gen:e,schema:t,data:o,it:r}=n;if((0,Pz.alwaysValidSchema)(r,t))return;let i=e.name("valid");e.forIn("key",o,a=>{n.setParams({propertyName:a}),n.subschema({keyword:"propertyNames",data:a,dataTypes:["string"],propertyName:a,compositeRule:!0},i),e.if((0,eA.not)(i),()=>{n.error(!0),r.allErrors||e.break()})}),n.ok(i)}};ny.default=Sz});var ry=U(oy=>{"use strict";Object.defineProperty(oy,"__esModule",{value:!0});var Up=qn(),no=le(),$z=Yo(),jp=xe(),Ez={message:"must NOT have additional properties",params:({params:n})=>(0,no._)`{additionalProperty: ${n.additionalProperty}}`},Rz={keyword:"additionalProperties",type:["object"],schemaType:["boolean","object"],allowUndefined:!0,trackErrors:!0,error:Ez,code(n){let{gen:e,schema:t,parentSchema:o,data:r,errsCount:i,it:a}=n;if(!i)throw new Error("ajv implementation error");let{allErrors:s,opts:c}=a;if(a.props=!0,c.removeAdditional!=="all"&&(0,jp.alwaysValidSchema)(a,t))return;let l=(0,Up.allSchemaProperties)(o.properties),d=(0,Up.allSchemaProperties)(o.patternProperties);p(),n.ok((0,no._)`${i} === ${$z.default.errors}`);function p(){e.forIn("key",r,v=>{!l.length&&!d.length?h(v):e.if(f(v),()=>h(v))})}function f(v){let k;if(l.length>8){let x=(0,jp.schemaRefOrVal)(a,o.properties,"properties");k=(0,Up.isOwnProperty)(e,x,v)}else l.length?k=(0,no.or)(...l.map(x=>(0,no._)`${v} === ${x}`)):k=no.nil;return d.length&&(k=(0,no.or)(k,...d.map(x=>(0,no._)`${(0,Up.usePattern)(n,x)}.test(${v})`))),(0,no.not)(k)}function m(v){e.code((0,no._)`delete ${r}[${v}]`)}function h(v){if(c.removeAdditional==="all"||c.removeAdditional&&t===!1){m(v);return}if(t===!1){n.setParams({additionalProperty:v}),n.error(),s||e.break();return}if(typeof t=="object"&&!(0,jp.alwaysValidSchema)(a,t)){let k=e.name("valid");c.removeAdditional==="failing"?(g(v,k,!1),e.if((0,no.not)(k),()=>{n.reset(),m(v)})):(g(v,k),s||e.if((0,no.not)(k),()=>e.break()))}}function g(v,k,x){let y={keyword:"additionalProperties",dataProp:v,dataPropType:jp.Type.Str};x===!1&&Object.assign(y,{compositeRule:!0,createErrors:!1,allErrors:!1}),n.subschema(y,k)}}};oy.default=Rz});var rA=U(ay=>{"use strict";Object.defineProperty(ay,"__esModule",{value:!0});var Oz=zl(),nA=qn(),iy=xe(),oA=ry(),Lz={keyword:"properties",type:"object",schemaType:"object",code(n){let{gen:e,schema:t,parentSchema:o,data:r,it:i}=n;i.opts.removeAdditional==="all"&&o.additionalProperties===void 0&&oA.default.code(new Oz.KeywordCxt(i,oA.default,"additionalProperties"));let a=(0,nA.allSchemaProperties)(t);for(let p of a)i.definedProperties.add(p);i.opts.unevaluated&&a.length&&i.props!==!0&&(i.props=iy.mergeEvaluated.props(e,(0,iy.toHash)(a),i.props));let s=a.filter(p=>!(0,iy.alwaysValidSchema)(i,t[p]));if(s.length===0)return;let c=e.name("valid");for(let p of s)l(p)?d(p):(e.if((0,nA.propertyInData)(e,r,p,i.opts.ownProperties)),d(p),i.allErrors||e.else().var(c,!0),e.endIf()),n.it.definedProperties.add(p),n.ok(c);function l(p){return i.opts.useDefaults&&!i.compositeRule&&t[p].default!==void 0}function d(p){n.subschema({keyword:"properties",schemaProp:p,dataProp:p},c)}}};ay.default=Lz});var cA=U(sy=>{"use strict";Object.defineProperty(sy,"__esModule",{value:!0});var iA=qn(),Kp=le(),aA=xe(),sA=xe(),Nz={keyword:"patternProperties",type:"object",schemaType:"object",code(n){let{gen:e,schema:t,data:o,parentSchema:r,it:i}=n,{opts:a}=i,s=(0,iA.allSchemaProperties)(t),c=s.filter(g=>(0,aA.alwaysValidSchema)(i,t[g]));if(s.length===0||c.length===s.length&&(!i.opts.unevaluated||i.props===!0))return;let l=a.strictSchema&&!a.allowMatchingProperties&&r.properties,d=e.name("valid");i.props!==!0&&!(i.props instanceof Kp.Name)&&(i.props=(0,sA.evaluatedPropsToName)(e,i.props));let{props:p}=i;f();function f(){for(let g of s)l&&m(g),i.allErrors?h(g):(e.var(d,!0),h(g),e.if(d))}function m(g){for(let v in l)new RegExp(g).test(v)&&(0,aA.checkStrictMode)(i,`property ${v} matches pattern ${g} (use allowMatchingProperties)`)}function h(g){e.forIn("key",o,v=>{e.if((0,Kp._)`${(0,iA.usePattern)(n,g)}.test(${v})`,()=>{let k=c.includes(g);k||n.subschema({keyword:"patternProperties",schemaProp:g,dataProp:v,dataPropType:sA.Type.Str},d),i.opts.unevaluated&&p!==!0?e.assign((0,Kp._)`${p}[${v}]`,!0):!k&&!i.allErrors&&e.if((0,Kp.not)(d),()=>e.break())})})}}};sy.default=Nz});var lA=U(cy=>{"use strict";Object.defineProperty(cy,"__esModule",{value:!0});var zz=xe(),Dz={keyword:"not",schemaType:["object","boolean"],trackErrors:!0,code(n){let{gen:e,schema:t,it:o}=n;if((0,zz.alwaysValidSchema)(o,t)){n.fail();return}let r=e.name("valid");n.subschema({keyword:"not",compositeRule:!0,createErrors:!1,allErrors:!1},r),n.failResult(r,()=>n.reset(),()=>n.error())},error:{message:"must NOT be valid"}};cy.default=Dz});var uA=U(ly=>{"use strict";Object.defineProperty(ly,"__esModule",{value:!0});var qz=qn(),Fz={keyword:"anyOf",schemaType:"array",trackErrors:!0,code:qz.validateUnion,error:{message:"must match a schema in anyOf"}};ly.default=Fz});var dA=U(uy=>{"use strict";Object.defineProperty(uy,"__esModule",{value:!0});var Hp=le(),Bz=xe(),Uz={message:"must match exactly one schema in oneOf",params:({params:n})=>(0,Hp._)`{passingSchemas: ${n.passing}}`},jz={keyword:"oneOf",schemaType:"array",trackErrors:!0,error:Uz,code(n){let{gen:e,schema:t,parentSchema:o,it:r}=n;if(!Array.isArray(t))throw new Error("ajv implementation error");if(r.opts.discriminator&&o.discriminator)return;let i=t,a=e.let("valid",!1),s=e.let("passing",null),c=e.name("_valid");n.setParams({passing:s}),e.block(l),n.result(a,()=>n.reset(),()=>n.error(!0));function l(){i.forEach((d,p)=>{let f;(0,Bz.alwaysValidSchema)(r,d)?e.var(c,!0):f=n.subschema({keyword:"oneOf",schemaProp:p,compositeRule:!0},c),p>0&&e.if((0,Hp._)`${c} && ${a}`).assign(a,!1).assign(s,(0,Hp._)`[${s}, ${p}]`).else(),e.if(c,()=>{e.assign(a,!0),e.assign(s,p),f&&n.mergeEvaluated(f,Hp.Name)})})}}};uy.default=jz});var pA=U(dy=>{"use strict";Object.defineProperty(dy,"__esModule",{value:!0});var Kz=xe(),Hz={keyword:"allOf",schemaType:"array",code(n){let{gen:e,schema:t,it:o}=n;if(!Array.isArray(t))throw new Error("ajv implementation error");let r=e.name("valid");t.forEach((i,a)=>{if((0,Kz.alwaysValidSchema)(o,i))return;let s=n.subschema({keyword:"allOf",schemaProp:a},r);n.ok(r),n.mergeEvaluated(s)})}};dy.default=Hz});var hA=U(py=>{"use strict";Object.defineProperty(py,"__esModule",{value:!0});var Zp=le(),fA=xe(),Zz={message:({params:n})=>(0,Zp.str)`must match "${n.ifClause}" schema`,params:({params:n})=>(0,Zp._)`{failingKeyword: ${n.ifClause}}`},Gz={keyword:"if",schemaType:["object","boolean"],trackErrors:!0,error:Zz,code(n){let{gen:e,parentSchema:t,it:o}=n;t.then===void 0&&t.else===void 0&&(0,fA.checkStrictMode)(o,'"if" without "then" and "else" is ignored');let r=mA(o,"then"),i=mA(o,"else");if(!r&&!i)return;let a=e.let("valid",!0),s=e.name("_valid");if(c(),n.reset(),r&&i){let d=e.let("ifClause");n.setParams({ifClause:d}),e.if(s,l("then",d),l("else",d))}else r?e.if(s,l("then")):e.if((0,Zp.not)(s),l("else"));n.pass(a,()=>n.error(!0));function c(){let d=n.subschema({keyword:"if",compositeRule:!0,createErrors:!1,allErrors:!1},s);n.mergeEvaluated(d)}function l(d,p){return()=>{let f=n.subschema({keyword:d},s);e.assign(a,s),n.mergeValidEvaluated(f,a),p?e.assign(p,(0,Zp._)`${d}`):n.setParams({ifClause:d})}}}};function mA(n,e){let t=n.schema[e];return t!==void 0&&!(0,fA.alwaysValidSchema)(n,t)}py.default=Gz});var gA=U(my=>{"use strict";Object.defineProperty(my,"__esModule",{value:!0});var Vz=xe(),Qz={keyword:["then","else"],schemaType:["object","boolean"],code({keyword:n,parentSchema:e,it:t}){e.if===void 0&&(0,Vz.checkStrictMode)(t,`"${n}" without "if" is ignored`)}};my.default=Qz});var vA=U(fy=>{"use strict";Object.defineProperty(fy,"__esModule",{value:!0});var Wz=Wv(),Jz=GI(),Xz=Jv(),Yz=QI(),eD=WI(),tD=YI(),nD=tA(),oD=ry(),rD=rA(),iD=cA(),aD=lA(),sD=uA(),cD=dA(),lD=pA(),uD=hA(),dD=gA();function pD(n=!1){let e=[aD.default,sD.default,cD.default,lD.default,uD.default,dD.default,nD.default,oD.default,tD.default,rD.default,iD.default];return n?e.push(Jz.default,Yz.default):e.push(Wz.default,Xz.default),e.push(eD.default),e}fy.default=pD});var yA=U(hy=>{"use strict";Object.defineProperty(hy,"__esModule",{value:!0});var ct=le(),mD={message:({schemaCode:n})=>(0,ct.str)`must match format "${n}"`,params:({schemaCode:n})=>(0,ct._)`{format: ${n}}`},fD={keyword:"format",type:["number","string"],schemaType:"string",$data:!0,error:mD,code(n,e){let{gen:t,data:o,$data:r,schema:i,schemaCode:a,it:s}=n,{opts:c,errSchemaPath:l,schemaEnv:d,self:p}=s;if(!c.validateFormats)return;r?f():m();function f(){let h=t.scopeValue("formats",{ref:p.formats,code:c.code.formats}),g=t.const("fDef",(0,ct._)`${h}[${a}]`),v=t.let("fType"),k=t.let("format");t.if((0,ct._)`typeof ${g} == "object" && !(${g} instanceof RegExp)`,()=>t.assign(v,(0,ct._)`${g}.type || "string"`).assign(k,(0,ct._)`${g}.validate`),()=>t.assign(v,(0,ct._)`"string"`).assign(k,g)),n.fail$data((0,ct.or)(x(),y()));function x(){return c.strictSchema===!1?ct.nil:(0,ct._)`${a} && !${k}`}function y(){let w=d.$async?(0,ct._)`(${g}.async ? await ${k}(${o}) : ${k}(${o}))`:(0,ct._)`${k}(${o})`,b=(0,ct._)`(typeof ${k} == "function" ? ${w} : ${k}.test(${o}))`;return(0,ct._)`${k} && ${k} !== true && ${v} === ${e} && !${b}`}}function m(){let h=p.formats[i];if(!h){x();return}if(h===!0)return;let[g,v,k]=y(h);g===e&&n.pass(w());function x(){if(c.strictSchema===!1){p.logger.warn(b());return}throw new Error(b());function b(){return`unknown format "${i}" ignored in schema at path "${l}"`}}function y(b){let C=b instanceof RegExp?(0,ct.regexpCode)(b):c.code.formats?(0,ct._)`${c.code.formats}${(0,ct.getProperty)(i)}`:void 0,I=t.scopeValue("formats",{key:i,ref:b,code:C});return typeof b=="object"&&!(b instanceof RegExp)?[b.type||"string",b.validate,(0,ct._)`${I}.validate`]:["string",b,I]}function w(){if(typeof h=="object"&&!(h instanceof RegExp)&&h.async){if(!d.$async)throw new Error("async format in sync schema");return(0,ct._)`await ${k}(${o})`}return typeof v=="function"?(0,ct._)`${k}(${o})`:(0,ct._)`${k}.test(${o})`}}}};hy.default=fD});var xA=U(gy=>{"use strict";Object.defineProperty(gy,"__esModule",{value:!0});var hD=yA(),gD=[hD.default];gy.default=gD});var bA=U(Bs=>{"use strict";Object.defineProperty(Bs,"__esModule",{value:!0});Bs.contentVocabulary=Bs.metadataVocabulary=void 0;Bs.metadataVocabulary=["title","description","default","deprecated","readOnly","writeOnly","examples"];Bs.contentVocabulary=["contentMediaType","contentEncoding","contentSchema"]});var kA=U(vy=>{"use strict";Object.defineProperty(vy,"__esModule",{value:!0});var vD=MI(),yD=jI(),xD=vA(),bD=xA(),wA=bA(),wD=[vD.default,yD.default,(0,xD.default)(),bD.default,wA.metadataVocabulary,wA.contentVocabulary];vy.default=wD});var CA=U(Gp=>{"use strict";Object.defineProperty(Gp,"__esModule",{value:!0});Gp.DiscrError=void 0;var _A;(function(n){n.Tag="tag",n.Mapping="mapping"})(_A||(Gp.DiscrError=_A={}))});var IA=U(xy=>{"use strict";Object.defineProperty(xy,"__esModule",{value:!0});var Us=le(),yy=CA(),TA=Pp(),kD=Dl(),_D=xe(),CD={message:({params:{discrError:n,tagName:e}})=>n===yy.DiscrError.Tag?`tag "${e}" must be string`:`value of tag "${e}" must be in oneOf`,params:({params:{discrError:n,tag:e,tagName:t}})=>(0,Us._)`{error: ${n}, tag: ${t}, tagValue: ${e}}`},TD={keyword:"discriminator",type:"object",schemaType:"object",error:CD,code(n){let{gen:e,data:t,schema:o,parentSchema:r,it:i}=n,{oneOf:a}=r;if(!i.opts.discriminator)throw new Error("discriminator: requires discriminator option");let s=o.propertyName;if(typeof s!="string")throw new Error("discriminator: requires propertyName");if(o.mapping)throw new Error("discriminator: mapping is not supported");if(!a)throw new Error("discriminator: requires oneOf keyword");let c=e.let("valid",!1),l=e.const("tag",(0,Us._)`${t}${(0,Us.getProperty)(s)}`);e.if((0,Us._)`typeof ${l} == "string"`,()=>d(),()=>n.error(!1,{discrError:yy.DiscrError.Tag,tag:l,tagName:s})),n.ok(c);function d(){let m=f();e.if(!1);for(let h in m)e.elseIf((0,Us._)`${l} === ${h}`),e.assign(c,p(m[h]));e.else(),n.error(!1,{discrError:yy.DiscrError.Mapping,tag:l,tagName:s}),e.endIf()}function p(m){let h=e.name("valid"),g=n.subschema({keyword:"oneOf",schemaProp:m},h);return n.mergeEvaluated(g,Us.Name),h}function f(){var m;let h={},g=k(r),v=!0;for(let w=0;w<a.length;w++){let b=a[w];if(b?.$ref&&!(0,_D.schemaHasRulesButRef)(b,i.self.RULES)){let I=b.$ref;if(b=TA.resolveRef.call(i.self,i.schemaEnv.root,i.baseId,I),b instanceof TA.SchemaEnv&&(b=b.schema),b===void 0)throw new kD.default(i.opts.uriResolver,i.baseId,I)}let C=(m=b?.properties)===null||m===void 0?void 0:m[s];if(typeof C!="object")throw new Error(`discriminator: oneOf subschemas (or referenced schemas) must have "properties/${s}"`);v=v&&(g||k(b)),x(C,w)}if(!v)throw new Error(`discriminator: "${s}" must be required`);return h;function k({required:w}){return Array.isArray(w)&&w.includes(s)}function x(w,b){if(w.const)y(w.const,b);else if(w.enum)for(let C of w.enum)y(C,b);else throw new Error(`discriminator: "properties/${s}" must have "const" or "enum"`)}function y(w,b){if(typeof w!="string"||w in h)throw new Error(`discriminator: "${s}" values must be unique strings`);h[w]=b}}}};xy.default=TD});var AA=U((jY,ID)=>{ID.exports={$schema:"http://json-schema.org/draft-07/schema#",$id:"http://json-schema.org/draft-07/schema#",title:"Core schema meta-schema",definitions:{schemaArray:{type:"array",minItems:1,items:{$ref:"#"}},nonNegativeInteger:{type:"integer",minimum:0},nonNegativeIntegerDefault0:{allOf:[{$ref:"#/definitions/nonNegativeInteger"},{default:0}]},simpleTypes:{enum:["array","boolean","integer","null","number","object","string"]},stringArray:{type:"array",items:{type:"string"},uniqueItems:!0,default:[]}},type:["object","boolean"],properties:{$id:{type:"string",format:"uri-reference"},$schema:{type:"string",format:"uri"},$ref:{type:"string",format:"uri-reference"},$comment:{type:"string"},title:{type:"string"},description:{type:"string"},default:!0,readOnly:{type:"boolean",default:!1},examples:{type:"array",items:!0},multipleOf:{type:"number",exclusiveMinimum:0},maximum:{type:"number"},exclusiveMaximum:{type:"number"},minimum:{type:"number"},exclusiveMinimum:{type:"number"},maxLength:{$ref:"#/definitions/nonNegativeInteger"},minLength:{$ref:"#/definitions/nonNegativeIntegerDefault0"},pattern:{type:"string",format:"regex"},additionalItems:{$ref:"#"},items:{anyOf:[{$ref:"#"},{$ref:"#/definitions/schemaArray"}],default:!0},maxItems:{$ref:"#/definitions/nonNegativeInteger"},minItems:{$ref:"#/definitions/nonNegativeIntegerDefault0"},uniqueItems:{type:"boolean",default:!1},contains:{$ref:"#"},maxProperties:{$ref:"#/definitions/nonNegativeInteger"},minProperties:{$ref:"#/definitions/nonNegativeIntegerDefault0"},required:{$ref:"#/definitions/stringArray"},additionalProperties:{$ref:"#"},definitions:{type:"object",additionalProperties:{$ref:"#"},default:{}},properties:{type:"object",additionalProperties:{$ref:"#"},default:{}},patternProperties:{type:"object",additionalProperties:{$ref:"#"},propertyNames:{format:"regex"},default:{}},dependencies:{type:"object",additionalProperties:{anyOf:[{$ref:"#"},{$ref:"#/definitions/stringArray"}]}},propertyNames:{$ref:"#"},const:!0,enum:{type:"array",items:!0,minItems:1,uniqueItems:!0},type:{anyOf:[{$ref:"#/definitions/simpleTypes"},{type:"array",items:{$ref:"#/definitions/simpleTypes"},minItems:1,uniqueItems:!0}]},format:{type:"string"},contentMediaType:{type:"string"},contentEncoding:{type:"string"},if:{$ref:"#"},then:{$ref:"#"},else:{$ref:"#"},allOf:{$ref:"#/definitions/schemaArray"},anyOf:{$ref:"#/definitions/schemaArray"},oneOf:{$ref:"#/definitions/schemaArray"},not:{$ref:"#"}},default:!0}});var wy=U((Ge,by)=>{"use strict";Object.defineProperty(Ge,"__esModule",{value:!0});Ge.MissingRefError=Ge.ValidationError=Ge.CodeGen=Ge.Name=Ge.nil=Ge.stringify=Ge.str=Ge._=Ge.KeywordCxt=Ge.Ajv=void 0;var AD=_I(),PD=kA(),MD=IA(),PA=AA(),SD=["/properties"],Vp="http://json-schema.org/draft-07/schema",js=class extends AD.default{_addVocabularies(){super._addVocabularies(),PD.default.forEach(e=>this.addVocabulary(e)),this.opts.discriminator&&this.addKeyword(MD.default)}_addDefaultMetaSchema(){if(super._addDefaultMetaSchema(),!this.opts.meta)return;let e=this.opts.$data?this.$dataMetaSchema(PA,SD):PA;this.addMetaSchema(e,Vp,!1),this.refs["http://json-schema.org/schema"]=Vp}defaultMeta(){return this.opts.defaultMeta=super.defaultMeta()||(this.getSchema(Vp)?Vp:void 0)}};Ge.Ajv=js;by.exports=Ge=js;by.exports.Ajv=js;Object.defineProperty(Ge,"__esModule",{value:!0});Ge.default=js;var $D=zl();Object.defineProperty(Ge,"KeywordCxt",{enumerable:!0,get:function(){return $D.KeywordCxt}});var Ks=le();Object.defineProperty(Ge,"_",{enumerable:!0,get:function(){return Ks._}});Object.defineProperty(Ge,"str",{enumerable:!0,get:function(){return Ks.str}});Object.defineProperty(Ge,"stringify",{enumerable:!0,get:function(){return Ks.stringify}});Object.defineProperty(Ge,"nil",{enumerable:!0,get:function(){return Ks.nil}});Object.defineProperty(Ge,"Name",{enumerable:!0,get:function(){return Ks.Name}});Object.defineProperty(Ge,"CodeGen",{enumerable:!0,get:function(){return Ks.CodeGen}});var ED=Ip();Object.defineProperty(Ge,"ValidationError",{enumerable:!0,get:function(){return ED.default}});var RD=Dl();Object.defineProperty(Ge,"MissingRefError",{enumerable:!0,get:function(){return RD.default}})});var NA=U(Io=>{"use strict";Object.defineProperty(Io,"__esModule",{value:!0});Io.formatNames=Io.fastFormats=Io.fullFormats=void 0;function To(n,e){return{validate:n,compare:e}}Io.fullFormats={date:To(EA,Ty),time:To(_y(!0),Iy),"date-time":To(MA(!0),OA),"iso-time":To(_y(),RA),"iso-date-time":To(MA(),LA),duration:/^P(?!$)((\d+Y)?(\d+M)?(\d+D)?(T(?=\d)(\d+H)?(\d+M)?(\d+S)?)?|(\d+W)?)$/,uri:qD,"uri-reference":/^(?:[a-z][a-z0-9+\-.]*:)?(?:\/?\/(?:(?:[a-z0-9\-._~!$&'()*+,;=:]|%[0-9a-f]{2})*@)?(?:\[(?:(?:(?:(?:[0-9a-f]{1,4}:){6}|::(?:[0-9a-f]{1,4}:){5}|(?:[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){4}|(?:(?:[0-9a-f]{1,4}:){0,1}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){3}|(?:(?:[0-9a-f]{1,4}:){0,2}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){2}|(?:(?:[0-9a-f]{1,4}:){0,3}[0-9a-f]{1,4})?::[0-9a-f]{1,4}:|(?:(?:[0-9a-f]{1,4}:){0,4}[0-9a-f]{1,4})?::)(?:[0-9a-f]{1,4}:[0-9a-f]{1,4}|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?))|(?:(?:[0-9a-f]{1,4}:){0,5}[0-9a-f]{1,4})?::[0-9a-f]{1,4}|(?:(?:[0-9a-f]{1,4}:){0,6}[0-9a-f]{1,4})?::)|[Vv][0-9a-f]+\.[a-z0-9\-._~!$&'()*+,;=:]+)\]|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)|(?:[a-z0-9\-._~!$&'"()*+,;=]|%[0-9a-f]{2})*)(?::\d*)?(?:\/(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})*)*|\/(?:(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})*)*)?|(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})*)*)?(?:\?(?:[a-z0-9\-._~!$&'"()*+,;=:@/?]|%[0-9a-f]{2})*)?(?:#(?:[a-z0-9\-._~!$&'"()*+,;=:@/?]|%[0-9a-f]{2})*)?$/i,"uri-template":/^(?:(?:[^\x00-\x20"'<>%\\^`{|}]|%[0-9a-f]{2})|\{[+#./;?&=,!@|]?(?:[a-z0-9_]|%[0-9a-f]{2})+(?::[1-9][0-9]{0,3}|\*)?(?:,(?:[a-z0-9_]|%[0-9a-f]{2})+(?::[1-9][0-9]{0,3}|\*)?)*\})*$/i,url:/^(?:https?|ftp):\/\/(?:\S+(?::\S*)?@)?(?:(?!(?:10|127)(?:\.\d{1,3}){3})(?!(?:169\.254|192\.168)(?:\.\d{1,3}){2})(?!172\.(?:1[6-9]|2\d|3[0-1])(?:\.\d{1,3}){2})(?:[1-9]\d?|1\d\d|2[01]\d|22[0-3])(?:\.(?:1?\d{1,2}|2[0-4]\d|25[0-5])){2}(?:\.(?:[1-9]\d?|1\d\d|2[0-4]\d|25[0-4]))|(?:(?:[a-z0-9\u{00a1}-\u{ffff}]+-)*[a-z0-9\u{00a1}-\u{ffff}]+)(?:\.(?:[a-z0-9\u{00a1}-\u{ffff}]+-)*[a-z0-9\u{00a1}-\u{ffff}]+)*(?:\.(?:[a-z\u{00a1}-\u{ffff}]{2,})))(?::\d{2,5})?(?:\/[^\s]*)?$/iu,email:/^[a-z0-9!#$%&'*+/=?^_`{|}~-]+(?:\.[a-z0-9!#$%&'*+/=?^_`{|}~-]+)*@(?:[a-z0-9](?:[a-z0-9-]*[a-z0-9])?\.)+[a-z0-9](?:[a-z0-9-]*[a-z0-9])?$/i,hostname:/^(?=.{1,253}\.?$)[a-z0-9](?:[a-z0-9-]{0,61}[a-z0-9])?(?:\.[a-z0-9](?:[-0-9a-z]{0,61}[0-9a-z])?)*\.?$/i,ipv4:/^(?:(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)\.){3}(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)$/,ipv6:/^((([0-9a-f]{1,4}:){7}([0-9a-f]{1,4}|:))|(([0-9a-f]{1,4}:){6}(:[0-9a-f]{1,4}|((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9a-f]{1,4}:){5}(((:[0-9a-f]{1,4}){1,2})|:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9a-f]{1,4}:){4}(((:[0-9a-f]{1,4}){1,3})|((:[0-9a-f]{1,4})?:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9a-f]{1,4}:){3}(((:[0-9a-f]{1,4}){1,4})|((:[0-9a-f]{1,4}){0,2}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9a-f]{1,4}:){2}(((:[0-9a-f]{1,4}){1,5})|((:[0-9a-f]{1,4}){0,3}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9a-f]{1,4}:){1}(((:[0-9a-f]{1,4}){1,6})|((:[0-9a-f]{1,4}){0,4}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(:(((:[0-9a-f]{1,4}){1,7})|((:[0-9a-f]{1,4}){0,5}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:)))$/i,regex:ZD,uuid:/^(?:urn:uuid:)?[0-9a-f]{8}-(?:[0-9a-f]{4}-){3}[0-9a-f]{12}$/i,"json-pointer":/^(?:\/(?:[^~/]|~0|~1)*)*$/,"json-pointer-uri-fragment":/^#(?:\/(?:[a-z0-9_\-.!$&'()*+,;:=@]|%[0-9a-f]{2}|~0|~1)*)*$/i,"relative-json-pointer":/^(?:0|[1-9][0-9]*)(?:#|(?:\/(?:[^~/]|~0|~1)*)*)$/,byte:FD,int32:{type:"number",validate:jD},int64:{type:"number",validate:KD},float:{type:"number",validate:$A},double:{type:"number",validate:$A},password:!0,binary:!0};Io.fastFormats={...Io.fullFormats,date:To(/^\d\d\d\d-[0-1]\d-[0-3]\d$/,Ty),time:To(/^(?:[0-2]\d:[0-5]\d:[0-5]\d|23:59:60)(?:\.\d+)?(?:z|[+-]\d\d(?::?\d\d)?)$/i,Iy),"date-time":To(/^\d\d\d\d-[0-1]\d-[0-3]\dt(?:[0-2]\d:[0-5]\d:[0-5]\d|23:59:60)(?:\.\d+)?(?:z|[+-]\d\d(?::?\d\d)?)$/i,OA),"iso-time":To(/^(?:[0-2]\d:[0-5]\d:[0-5]\d|23:59:60)(?:\.\d+)?(?:z|[+-]\d\d(?::?\d\d)?)?$/i,RA),"iso-date-time":To(/^\d\d\d\d-[0-1]\d-[0-3]\d[t\s](?:[0-2]\d:[0-5]\d:[0-5]\d|23:59:60)(?:\.\d+)?(?:z|[+-]\d\d(?::?\d\d)?)?$/i,LA),uri:/^(?:[a-z][a-z0-9+\-.]*:)(?:\/?\/)?[^\s]*$/i,"uri-reference":/^(?:(?:[a-z][a-z0-9+\-.]*:)?\/?\/)?(?:[^\\\s#][^\s#]*)?(?:#[^\\\s]*)?$/i,email:/^[a-z0-9.!#$%&'*+/=?^_`{|}~-]+@[a-z0-9](?:[a-z0-9-]{0,61}[a-z0-9])?(?:\.[a-z0-9](?:[a-z0-9-]{0,61}[a-z0-9])?)*$/i};Io.formatNames=Object.keys(Io.fullFormats);function OD(n){return n%4===0&&(n%100!==0||n%400===0)}var LD=/^(\d\d\d\d)-(\d\d)-(\d\d)$/,ND=[0,31,28,31,30,31,30,31,31,30,31,30,31];function EA(n){let e=LD.exec(n);if(!e)return!1;let t=+e[1],o=+e[2],r=+e[3];return o>=1&&o<=12&&r>=1&&r<=(o===2&&OD(t)?29:ND[o])}function Ty(n,e){if(n&&e)return n>e?1:n<e?-1:0}var ky=/^(\d\d):(\d\d):(\d\d(?:\.\d+)?)(z|([+-])(\d\d)(?::?(\d\d))?)?$/i;function _y(n){return function(t){let o=ky.exec(t);if(!o)return!1;let r=+o[1],i=+o[2],a=+o[3],s=o[4],c=o[5]==="-"?-1:1,l=+(o[6]||0),d=+(o[7]||0);if(l>23||d>59||n&&!s)return!1;if(r<=23&&i<=59&&a<60)return!0;let p=i-d*c,f=r-l*c-(p<0?1:0);return(f===23||f===-1)&&(p===59||p===-1)&&a<61}}function Iy(n,e){if(!(n&&e))return;let t=new Date("2020-01-01T"+n).valueOf(),o=new Date("2020-01-01T"+e).valueOf();if(t&&o)return t-o}function RA(n,e){if(!(n&&e))return;let t=ky.exec(n),o=ky.exec(e);if(t&&o)return n=t[1]+t[2]+t[3],e=o[1]+o[2]+o[3],n>e?1:n<e?-1:0}var Cy=/t|\s/i;function MA(n){let e=_y(n);return function(o){let r=o.split(Cy);return r.length===2&&EA(r[0])&&e(r[1])}}function OA(n,e){if(!(n&&e))return;let t=new Date(n).valueOf(),o=new Date(e).valueOf();if(t&&o)return t-o}function LA(n,e){if(!(n&&e))return;let[t,o]=n.split(Cy),[r,i]=e.split(Cy),a=Ty(t,r);if(a!==void 0)return a||Iy(o,i)}var zD=/\/|:/,DD=/^(?:[a-z][a-z0-9+\-.]*:)(?:\/?\/(?:(?:[a-z0-9\-._~!$&'()*+,;=:]|%[0-9a-f]{2})*@)?(?:\[(?:(?:(?:(?:[0-9a-f]{1,4}:){6}|::(?:[0-9a-f]{1,4}:){5}|(?:[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){4}|(?:(?:[0-9a-f]{1,4}:){0,1}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){3}|(?:(?:[0-9a-f]{1,4}:){0,2}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){2}|(?:(?:[0-9a-f]{1,4}:){0,3}[0-9a-f]{1,4})?::[0-9a-f]{1,4}:|(?:(?:[0-9a-f]{1,4}:){0,4}[0-9a-f]{1,4})?::)(?:[0-9a-f]{1,4}:[0-9a-f]{1,4}|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?))|(?:(?:[0-9a-f]{1,4}:){0,5}[0-9a-f]{1,4})?::[0-9a-f]{1,4}|(?:(?:[0-9a-f]{1,4}:){0,6}[0-9a-f]{1,4})?::)|[Vv][0-9a-f]+\.[a-z0-9\-._~!$&'()*+,;=:]+)\]|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)|(?:[a-z0-9\-._~!$&'()*+,;=]|%[0-9a-f]{2})*)(?::\d*)?(?:\/(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})*)*|\/(?:(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})*)*)?|(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})*)*)(?:\?(?:[a-z0-9\-._~!$&'()*+,;=:@/?]|%[0-9a-f]{2})*)?(?:#(?:[a-z0-9\-._~!$&'()*+,;=:@/?]|%[0-9a-f]{2})*)?$/i;function qD(n){return zD.test(n)&&DD.test(n)}var SA=/^(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=)?$/gm;function FD(n){return SA.lastIndex=0,SA.test(n)}var BD=-(2**31),UD=2**31-1;function jD(n){return Number.isInteger(n)&&n<=UD&&n>=BD}function KD(n){return Number.isInteger(n)}function $A(){return!0}var HD=/[^\\]\\Z/;function ZD(n){if(HD.test(n))return!1;try{return new RegExp(n),!0}catch{return!1}}});var zA=U(Hs=>{"use strict";Object.defineProperty(Hs,"__esModule",{value:!0});Hs.formatLimitDefinition=void 0;var GD=wy(),oo=le(),Hr=oo.operators,Qp={formatMaximum:{okStr:"<=",ok:Hr.LTE,fail:Hr.GT},formatMinimum:{okStr:">=",ok:Hr.GTE,fail:Hr.LT},formatExclusiveMaximum:{okStr:"<",ok:Hr.LT,fail:Hr.GTE},formatExclusiveMinimum:{okStr:">",ok:Hr.GT,fail:Hr.LTE}},VD={message:({keyword:n,schemaCode:e})=>(0,oo.str)`should be ${Qp[n].okStr} ${e}`,params:({keyword:n,schemaCode:e})=>(0,oo._)`{comparison: ${Qp[n].okStr}, limit: ${e}}`};Hs.formatLimitDefinition={keyword:Object.keys(Qp),type:"string",schemaType:"string",$data:!0,error:VD,code(n){let{gen:e,data:t,schemaCode:o,keyword:r,it:i}=n,{opts:a,self:s}=i;if(!a.validateFormats)return;let c=new GD.KeywordCxt(i,s.RULES.all.format.definition,"format");c.$data?l():d();function l(){let f=e.scopeValue("formats",{ref:s.formats,code:a.code.formats}),m=e.const("fmt",(0,oo._)`${f}[${c.schemaCode}]`);n.fail$data((0,oo.or)((0,oo._)`typeof ${m} != "object"`,(0,oo._)`${m} instanceof RegExp`,(0,oo._)`typeof ${m}.compare != "function"`,p(m)))}function d(){let f=c.schema,m=s.formats[f];if(!m||m===!0)return;if(typeof m!="object"||m instanceof RegExp||typeof m.compare!="function")throw new Error(`"${r}": format "${f}" does not define "compare" function`);let h=e.scopeValue("formats",{key:f,ref:m,code:a.code.formats?(0,oo._)`${a.code.formats}${(0,oo.getProperty)(f)}`:void 0});n.fail$data(p(h))}function p(f){return(0,oo._)`${f}.compare(${t}, ${o}) ${Qp[r].fail} 0`}},dependencies:["format"]};var QD=n=>(n.addKeyword(Hs.formatLimitDefinition),n);Hs.default=QD});var BA=U((Xl,FA)=>{"use strict";Object.defineProperty(Xl,"__esModule",{value:!0});var Zs=NA(),WD=zA(),Ay=le(),DA=new Ay.Name("fullFormats"),JD=new Ay.Name("fastFormats"),Py=(n,e={keywords:!0})=>{if(Array.isArray(e))return qA(n,e,Zs.fullFormats,DA),n;let[t,o]=e.mode==="fast"?[Zs.fastFormats,JD]:[Zs.fullFormats,DA],r=e.formats||Zs.formatNames;return qA(n,r,t,o),e.keywords&&(0,WD.default)(n),n};Py.get=(n,e="full")=>{let o=(e==="fast"?Zs.fastFormats:Zs.fullFormats)[n];if(!o)throw new Error(`Unknown format "${n}"`);return o};function qA(n,e,t,o){var r,i;(r=(i=n.opts.code).formats)!==null&&r!==void 0||(i.formats=(0,Ay._)`require("ajv-formats/dist/formats").${o}`);for(let a of e)n.addFormat(a,t[a])}FA.exports=Xl=Py;Object.defineProperty(Xl,"__esModule",{value:!0});Xl.default=Py});var iF={};io(iF,{activate:()=>oF,deactivate:()=>rF});module.exports=WP(iF);var Se=D(require("vscode"));Vr();Cu();cr();sr();Ke();ce();Vr();var Tu=class n{static instance;accountManager;disposables=[];constructor(){this.accountManager=Ne.getInstance(),this.disposables.push(this.accountManager.onAccountChange(async e=>{try{e.type==="added"||e.type==="switched"||e.type==="updated"?await this.syncToApiKeyManager(e.provider):e.type==="removed"&&await this.handleAccountRemoval(e.provider)}catch(t){u.warn(`Failed to sync ${e.provider} to ApiKeyManager:`,t)}}))}static initialize(){return n.instance||(n.instance=new n),n.instance}static getInstance(){if(!n.instance)throw new Error("AccountSyncAdapter not initialized");return n.instance}async syncAntigravityAccount(){try{let e=await R.getApiKey("antigravity");if(!e)return;let t=JSON.parse(e),r=this.accountManager.getAccountsByProvider("antigravity").find(i=>i.email===t.email);if(r){let i={accessToken:t.access_token,refreshToken:t.refresh_token,expiresAt:t.expires_at};await this.accountManager.updateCredentials(r.id,i),u.debug(`Updated Antigravity account: ${t.email}`)}else{let i=t.email||"Antigravity Account",a={accessToken:t.access_token,refreshToken:t.refresh_token,expiresAt:t.expires_at};await this.accountManager.addOAuthAccount("antigravity",i,t.email||"",a,{projectId:t.project_id}),u.info(`Synced Antigravity account: ${i}`)}}catch(e){u.error("Failed to sync Antigravity account:",e)}}async syncCodexAccount(){try{let e=await R.getApiKey("codex");if(!e)return;let t=JSON.parse(e),r=this.accountManager.getAccountsByProvider("codex").find(i=>i.email===t.email);if(r){let i={accessToken:t.access_token,refreshToken:t.refresh_token,expiresAt:t.expires_at};await this.accountManager.updateCredentials(r.id,i),u.debug(`Updated Codex account: ${t.email}`)}else{let i=t.email||"Codex Account",a={accessToken:t.access_token,refreshToken:t.refresh_token,expiresAt:t.expires_at};await this.accountManager.addOAuthAccount("codex",i,t.email||"",a),u.info(`Synced Codex account: ${i}`)}}catch(e){u.error("Failed to sync Codex account:",e)}}async syncApiKeyAccount(e,t){try{let o=await R.getApiKey(e);if(!o)return;if(this.accountManager.getAccountsByProvider(e).length===0){let i=t||`${e} Account`;await this.accountManager.addApiKeyAccount(e,i,o),u.info(`Synced ${e} account from ApiKeyManager`)}}catch(o){u.error(`Failed to sync ${e} account:`,o)}}async syncAllAccounts(){let e=["zhipu","moonshot","minimax","deepseek"];await this.syncAntigravityAccount(),await this.syncCodexAccount();for(let o of e)await this.syncApiKeyAccount(o);let t=["antigravity",xn.Codex,...e];for(let o of t)await this.syncToApiKeyManager(o)}async syncToApiKeyManager(e){let t=await this.accountManager.getActiveCredentials(e);if(t){if("apiKey"in t)await R.setApiKey(e,t.apiKey);else if("accessToken"in t&&e==="antigravity"){let o=this.accountManager.getActiveAccount(e),r={type:"antigravity",access_token:t.accessToken,refresh_token:t.refreshToken,email:o?.email||"",project_id:o?.metadata?.projectId||"",expires_at:t.expiresAt,timestamp:Date.now()};await R.setApiKey("antigravity",JSON.stringify(r))}else if("accessToken"in t&&e===xn.Codex){let o=this.accountManager.getActiveAccount(e),r=await R.getApiKey("codex"),i={};if(r)try{i=JSON.parse(r)}catch{}let a={type:"codex",access_token:t.accessToken,refresh_token:t.refreshToken,email:o?.email||"",account_id:i.account_id||o?.metadata?.accountId,organization_id:i.organization_id,project_id:i.project_id,organizations:i.organizations,expires_at:t.expiresAt,timestamp:Date.now()};u.info("[accountSync] Preserving Codex account/org data during sync"),await R.setApiKey("codex",JSON.stringify(a))}}}async handleAccountRemoval(e){if(this.accountManager.getAccountsByProvider(e).length===0){await R.deleteApiKey(e);return}await this.syncToApiKeyManager(e)}dispose(){for(let e of this.disposables)e.dispose()}};var J=D(require("vscode"));Wr();sr();ce();Vr();var So=class n{static instance;accountManager;constructor(){this.accountManager=Ne.getInstance()}static getInstance(){return n.instance||(n.instance=new n),n.instance}async showAccountManager(){let e=[{label:"$(window) Open Account Manager",description:"Open full account management page",detail:"Visual interface for managing all accounts"},{label:"$(add) Add New Account",description:"Add a new account for any provider",detail:"Add API Key or OAuth account"},{label:"$(list-unordered) View All Accounts",description:"View and manage all accounts",detail:`${this.accountManager.getAllAccounts().length} accounts configured`},{label:"$(arrow-swap) Switch Account",description:"Switch active account for a provider",detail:"Change which account is used for requests"},{label:"$(trash) Remove Account",description:"Remove an existing account",detail:"Delete account and its credentials"},{label:"$(settings) Antigravity Model Routing",description:"Assign Antigravity models to accounts",detail:"Choose which account handles each model"},{label:"$(pulse) Antigravity Load Balance",description:this.accountManager.getLoadBalanceEnabled("antigravity")?"Enabled":"Disabled",detail:"Auto switch accounts when quota is hit"}],t=await J.window.showQuickPick(e,{title:"Account Manager",placeHolder:"Select an action"});if(t)switch(t.label){case"$(window) Open Account Manager":await J.commands.executeCommand("chp.accounts.openManager");break;case"$(add) Add New Account":await this.showAddAccountFlow();break;case"$(list-unordered) View All Accounts":await this.showAllAccounts();break;case"$(arrow-swap) Switch Account":await this.showSwitchAccountFlow();break;case"$(trash) Remove Account":await this.showRemoveAccountFlow();break;case"$(settings) Antigravity Model Routing":await this.showAntigravityModelRouting();break;case"$(pulse) Antigravity Load Balance":await this.showAntigravityLoadBalanceToggle();break}}async showAddAccountFlow(){let t=[{label:"Antigravity (Google)",value:"antigravity",authType:"oauth"},{label:"Codex (OpenAI)",value:xn.Codex,authType:"oauth"},{label:"ZhipuAI",value:"zhipu",authType:"apiKey"},{label:"Moonshot",value:"moonshot",authType:"apiKey"},{label:"MiniMax",value:"minimax",authType:"apiKey"},{label:"DeepSeek",value:"deepseek",authType:"apiKey"},{label:"DeepInfra",value:"deepinfra",authType:"apiKey"},{label:"Compatible (Custom)",value:"compatible",authType:"apiKey"}].map(r=>({label:r.label,description:r.authType==="oauth"?"OAuth Login":"API Key",provider:r.value,authType:r.authType})),o=await J.window.showQuickPick(t,{title:"Add Account - Select Provider",placeHolder:"Choose a provider"});o&&(o.authType==="oauth"?await this.addOAuthAccount(o.provider):await this.addApiKeyAccount(o.provider,o.label))}async addApiKeyAccount(e,t){let o=await J.window.showInputBox({title:`Add ${t} Account`,prompt:"Enter a display name for this account",placeHolder:"e.g., Work Account, Personal, etc.",validateInput:s=>{if(!s||s.trim().length===0)return"Display name is required"}});if(!o)return;let r=await J.window.showInputBox({title:`Add ${t} Account`,prompt:`Enter your ${t} API Key`,password:!0,placeHolder:"sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx",validateInput:s=>{if(!s||s.trim().length===0)return"API Key is required"}});if(!r)return;let i=await J.window.showInputBox({title:`Add ${t} Account`,prompt:"Enter custom base URL or proxy endpoint (optional)",placeHolder:"http://154.53.47.9:8000/v1 or https://proxy.example.com/v1",validateInput:s=>{if(s&&s.trim().length>0&&!s.startsWith("http://")&&!s.startsWith("https://"))return"Base URL must start with http:// or https://"}}),a=await this.accountManager.addApiKeyAccount(e,o.trim(),r.trim(),{endpoint:i?i.trim():void 0});a.success?J.window.showInformationMessage(`Account "${o}" added successfully for ${t}`):J.window.showErrorMessage(`Failed to add account: ${a.error}`)}async addOAuthAccount(e){if(e==="antigravity")try{let{doAntigravityLoginForNewAccount:t}=await Promise.resolve().then(()=>(Wr(),zm));await t()}catch(t){u.error("OAuth login failed:",t),J.window.showErrorMessage("OAuth login failed. Please try again.")}else if(e===xn.Codex)try{let{doCodexLoginForNewAccount:t}=await import("../providers/codex/codexAuth.js");await t()}catch(t){u.error("Codex OAuth login failed:",t),J.window.showErrorMessage("Codex OAuth login failed. Please try again.")}}async showAllAccounts(){let e=this.accountManager.getAllAccounts();if(e.length===0){await J.window.showInformationMessage("No accounts configured yet.","Add Account")==="Add Account"&&await this.showAddAccountFlow();return}let t=new Map;for(let r of e){let i=t.get(r.provider)||[];i.push(r),t.set(r.provider,i)}let o=[];for(let[r,i]of t){o.push({label:r.toUpperCase(),kind:J.QuickPickItemKind.Separator});for(let a of i){let s=a.isDefault,c=this.getStatusIcon(a.status),l=s?"$(check) ":"";o.push({label:`${l}${c} ${a.displayName}`,description:a.email||a.authType,detail:`Created: ${new Date(a.createdAt).toLocaleDateString()} | Status: ${a.status}`})}}await J.window.showQuickPick(o,{title:"All Accounts",placeHolder:"View your configured accounts"})}async showSwitchAccountFlow(){let e=this.accountManager.getAllAccounts(),t=new Map;for(let d of e)t.set(d.provider,(t.get(d.provider)||0)+1);let o=Array.from(t.entries()).filter(([d,p])=>p>1).map(([d])=>d);if(o.length===0){J.window.showInformationMessage("No providers have multiple accounts. Add more accounts first.");return}let r=o.map(d=>({label:d.charAt(0).toUpperCase()+d.slice(1),description:`${t.get(d)} accounts`,provider:d})),i=await J.window.showQuickPick(r,{title:"Switch Account - Select Provider",placeHolder:"Choose a provider"});if(!i)return;let s=this.accountManager.getAccountsByProvider(i.provider).map(d=>({label:`${d.isDefault?"$(check) ":""}${d.displayName}`,description:d.email||d.authType,detail:d.isDefault?"Currently active":"Click to switch",account:d})),c=await J.window.showQuickPick(s,{title:`Switch ${i.label} Account`,placeHolder:"Select an account to switch to"});if(!c||c.account.isDefault)return;await this.accountManager.switchAccount(i.provider,c.account.id)?J.window.showInformationMessage(`Switched to "${c.account.displayName}"`):J.window.showErrorMessage(`Failed to switch to "${c.account.displayName}"`)}async showRemoveAccountFlow(){let e=this.accountManager.getAllAccounts();if(e.length===0){J.window.showInformationMessage("No accounts to remove.");return}let t=e.map(a=>({label:`${a.displayName}`,description:`${a.provider} - ${a.email||a.authType}`,detail:a.isDefault?"This is the active account":void 0,account:a})),o=await J.window.showQuickPick(t,{title:"Remove Account",placeHolder:"Select an account to remove"});if(!o||await J.window.showWarningMessage(`Are you sure you want to remove "${o.account.displayName}"?`,{modal:!0},"Remove")!=="Remove")return;await this.accountManager.removeAccount(o.account.id)?J.window.showInformationMessage(`Account "${o.account.displayName}" removed`):J.window.showErrorMessage("Failed to remove account")}async showAccountPicker(e){let t=this.accountManager.getAccountsByProvider(e);if(t.length===0)return await J.window.showInformationMessage(`No ${e} accounts configured.`,"Add Account")==="Add Account"?(await this.addApiKeyAccount(e,e),this.accountManager.getActiveAccount(e)):void 0;if(t.length===1)return t[0];let o=t.map(i=>({label:`${i.isDefault?"$(check) ":""}${i.displayName}`,description:i.email||i.authType,account:i}));return(await J.window.showQuickPick(o,{title:`Select ${e} Account`,placeHolder:"Choose an account"}))?.account}async showAntigravityModelRouting(){let e="antigravity",t=this.accountManager.getAccountsByProvider(e);if(t.length===0){J.window.showInformationMessage("No Antigravity accounts configured. Add an account first.");return}let o=await et.getCachedModels();if(o.length===0&&(o=await et.getModels()),o.length===0){J.window.showWarningMessage("No Antigravity models available. Please login and refresh models.");return}let r=this.accountManager.getModelAccountAssignments(e),i=o.map(d=>{let p=r[d.id],f=t.find(m=>m.id===p);return{label:d.displayName||d.name,description:d.id,detail:f?`Assigned to ${f.displayName}`:"Auto (use active account or load balance)",modelId:d.id}}),a=await J.window.showQuickPick(i,{title:"Antigravity Model Routing",placeHolder:"Select a model to assign"});if(!a)return;let s=[{label:"$(circle-outline) Auto",description:"Use active account or load balance",accountId:void 0},...t.map(d=>({label:`${d.isDefault?"$(check) ":""}${d.displayName}`,description:d.email||d.authType,detail:d.status==="active"?void 0:`Status: ${d.status}`,accountId:d.id}))],c=await J.window.showQuickPick(s,{title:`Assign Account for ${a.label}`,placeHolder:"Select an account"});if(!c)return;await this.accountManager.setAccountForModel(e,a.modelId,c.accountId);let l=c.accountId?c.label.replace(/^\$\(check\)\s*/,""):"Auto";J.window.showInformationMessage(`Updated routing for ${a.label}: ${l}`)}async showAntigravityLoadBalanceToggle(){let e="antigravity",t=this.accountManager.getLoadBalanceEnabled(e);await J.window.showQuickPick([{label:t?"Disable Load Balance":"Enable Load Balance",description:t?"Keep current account selection":"Auto switch on quota limits"}],{title:"Antigravity Load Balance",placeHolder:"Toggle load balance"})&&(await this.accountManager.setLoadBalanceEnabled(e,!t),J.window.showInformationMessage(`Antigravity load balance ${t?"disabled":"enabled"}.`))}async showQuickSwitch(){let e=this.accountManager.getAllAccounts();if(e.length===0){await J.window.showInformationMessage("No accounts configured. Add your first account?","Add Account")==="Add Account"&&await this.showAddAccountFlow();return}let t=new Map;for(let i of e){let a=t.get(i.provider)||[];a.push(i),t.set(i.provider,a)}let o=J.window.createQuickPick();o.title="Quick Switch Account",o.placeholder="Select an account to switch to (or type to filter)",o.matchOnDescription=!0,o.matchOnDetail=!0;let r=[];for(let[i,a]of t){r.push({label:`$(folder) ${this.getProviderDisplayName(i)}`,kind:J.QuickPickItemKind.Separator,account:null,provider:i});for(let s of a){let c=s.isDefault,l=this.getStatusIcon(s.status);r.push({label:`${c?"$(check) ":"    "}${l} ${s.displayName}`,description:`${i}${s.email?` \u2022 ${s.email}`:""}`,detail:c?"$(star-full) Currently active":"$(arrow-right) Click to switch",account:s,provider:i,buttons:c?[]:[{iconPath:new J.ThemeIcon("arrow-swap"),tooltip:"Switch to this account"}]})}}r.push({label:"",kind:J.QuickPickItemKind.Separator,account:null}),r.push({label:"$(add) Add New Account",description:"Add a new account for any provider",account:null,alwaysShow:!0}),r.push({label:"$(settings-gear) Open Account Manager",description:"Full account management interface",account:null,alwaysShow:!0}),r.push({label:"$(gear) Open Settings",description:"Configure Copilot ++ extension settings",account:null,alwaysShow:!0}),o.items=r,o.onDidAccept(async()=>{let i=o.selectedItems[0];if(o.hide(),!!i){if(i.label==="$(add) Add New Account"){await this.showAddAccountFlow();return}if(i.label==="$(settings-gear) Open Account Manager"){await J.commands.executeCommand("chp.accounts.openManager");return}if(i.label==="$(gear) Open Settings"){await J.commands.executeCommand("chp.openSettings");return}i.account&&!i.account.isDefault&&await this.switchToAccount(i.account)}}),o.onDidTriggerItemButton(async i=>{let a=i.item;a.account&&!a.account.isDefault&&(o.hide(),await this.switchToAccount(a.account))}),o.onDidHide(()=>o.dispose()),o.show()}async showQuickSwitchForProvider(e){let t=this.accountManager.getAccountsByProvider(e);if(t.length===0){await J.window.showInformationMessage(`No ${this.getProviderDisplayName(e)} accounts configured.`,"Add Account")==="Add Account"&&await this.showAddAccountFlow();return}if(t.length===1){J.window.showInformationMessage(`Only one ${this.getProviderDisplayName(e)} account configured: ${t[0].displayName}`);return}let o=J.window.createQuickPick();o.title=`Switch ${this.getProviderDisplayName(e)} Account`,o.placeholder="Select an account to switch to";let r=t.map(i=>{let a=i.isDefault,s=this.getStatusIcon(i.status);return{label:`${a?"$(check) ":""}${s} ${i.displayName}`,description:i.email||i.authType,detail:a?"$(star-full) Currently active":"$(arrow-right) Click to switch",account:i}});o.items=r,o.onDidAccept(async()=>{let i=o.selectedItems[0];o.hide(),i?.account&&!i.account.isDefault&&await this.switchToAccount(i.account)}),o.onDidHide(()=>o.dispose()),o.show()}async switchToAccount(e){await this.accountManager.switchAccount(e.provider,e.id)?J.window.showInformationMessage(`Now using: ${e.displayName} (${this.getProviderDisplayName(e.provider)})`):J.window.showErrorMessage(`Failed to switch to "${e.displayName}"`)}getProviderDisplayName(e){return{antigravity:"Antigravity (Google)",codex:"Codex (OpenAI)",zhipu:"ZhipuAI",moonshot:"Moonshot",minimax:"MiniMax",deepseek:"DeepSeek",deepinfra:"DeepInfra",compatible:"Compatible"}[e]||e.charAt(0).toUpperCase()+e.slice(1)}getStatusIcon(e){switch(e){case"active":return"$(pass-filled)";case"inactive":return"$(circle-outline)";case"expired":return"$(warning)";case"error":return"$(error)";default:return"$(question)"}}};function sb(n){let e=[];return e.push(J.commands.registerCommand("chp.accounts.manage",async()=>{await So.getInstance().showAccountManager()})),e.push(J.commands.registerCommand("chp.accounts.add",async()=>{await So.getInstance().showAddAccountFlow()})),e.push(J.commands.registerCommand("chp.accounts.switch",async()=>{await So.getInstance().showSwitchAccountFlow()})),e.push(J.commands.registerCommand("chp.accounts.remove",async()=>{await So.getInstance().showRemoveAccountFlow()})),e.push(J.commands.registerCommand("chp.accounts.list",async()=>{await So.getInstance().showAllAccounts()})),e.push(J.commands.registerCommand("chp.accounts.openManager",async()=>{let{AccountManagerPage:t}=await Promise.resolve().then(()=>(Cu(),ab));await t.getInstance().show()})),e.push(J.commands.registerCommand("chp.accounts.quickSwitch",async()=>{await So.getInstance().showQuickSwitch()})),e.push(J.commands.registerCommand("chp.accounts.quickSwitchProvider",async t=>{let o=So.getInstance();t?await o.showQuickSwitchForProvider(t):await o.showQuickSwitch()})),e}var Yt=D(require("vscode"));Ke();var cb=D(require("vscode")),$o=class n{static outputChannel;static initialize(e="CHP-Completion"){n.outputChannel=cb.window.createOutputChannel(e,{log:!0})}static trace(e,...t){n.outputChannel&&n.outputChannel.trace(e,...t)}static debug(e,...t){n.outputChannel&&n.outputChannel.debug(e,...t)}static info(e,...t){n.outputChannel&&n.outputChannel.info(e,...t)}static warn(e,...t){n.outputChannel&&n.outputChannel.warn(e,...t)}static error(e,...t){n.outputChannel&&n.outputChannel.error(e,...t)}static dispose(){n.outputChannel&&n.outputChannel.dispose()}};ot();function lr(){return globalThis.__chp_singletons?.CompletionLogger||$o}var Iu=class n{constructor(e){this.context=e;this.disposables.push(this.onDidChangeEmitter)}disposables=[];onDidChangeEmitter=new Yt.EventEmitter;onDidChange=this.onDidChangeEmitter.event;_realProvider=null;_loadingPromise=null;isFIMEnabled(){return Yt.workspace.getConfiguration("chp.fimCompletion").get("enabled",!1)}isNESEnabled(){return Yt.workspace.getConfiguration("chp.nesCompletion").get("enabled",!1)}async loadRealProvider(){return this._realProvider?this._realProvider:this._loadingPromise?this._loadingPromise:(this._loadingPromise=(async()=>{try{let e=lr(),t=Date.now();e.trace("[InlineCompletionShim] Starting to load copilot module...");let o=require("../dist/copilot.bundle.js"),{InlineCompletionProvider:r}=o;this._realProvider=new r(this.context),this._realProvider.activate();let i=this._realProvider.onDidChange(()=>{this.onDidChangeEmitter.fire()});this.disposables.push(i);let a=Date.now()-t;return e.info(`[InlineCompletionShim] copilot module loading complete (elapsed: ${a}ms)`),this._realProvider}catch(e){return lr().error("[InlineCompletionShim] Failed to load copilot module:",e),this._loadingPromise=null,null}})(),this._loadingPromise)}activate(){let e=lr();e.trace("[InlineCompletionShim] Activate lightweight proxy (lazy loading mode)");try{let t=Yt.languages.registerInlineCompletionItemProvider({pattern:"**/*"},this);this.disposables.push(t),this.disposables.push(Yt.commands.registerCommand("chp.nesCompletion.toggleManual",async()=>{let o=lr(),a=!Yt.workspace.getConfiguration("chp.nesCompletion").get("manualOnly",!1);await Yt.workspace.getConfiguration("chp.nesCompletion").update("manualOnly",a,Yt.ConfigurationTarget.Global),Yt.window.showInformationMessage(`Copilot ++: Next Edit Suggestion Trigger Mode: ${a?"Manual Trigger":"Auto Trigger"}`),o.info(`[InlineCompletionShim] NES manual trigger mode ${a?"enabled":"disabled"}`)})),e.info("[InlineCompletionShim] Activated (using lazy loading strategy)")}catch(t){throw e.error("[InlineCompletionShim] Activation failed:",t),t}}async provideInlineCompletionItems(e,t,o,r){if(!this.isFIMEnabled()&&!this.isNESEnabled())return;let i=await this.loadRealProvider();if(i&&!r.isCancellationRequested)try{return await i.provideInlineCompletionItems(e,t,o,r)??void 0}catch(a){lr().error("[InlineCompletionShim] Completion request failed:",a);return}}dispose(){let e=lr();e.trace("[InlineCompletionShim] Start releasing resources"),this._realProvider&&(this._realProvider.dispose(),this._realProvider=null),this.disposables.forEach(t=>{try{t.dispose()}catch(o){lr().warn("[InlineCompletionShim] Error releasing resources:",o)}}),this.disposables.length=0,e.info("[InlineCompletionShim] All resources released")}static createAndActivate(e){let t=new n(e);return t.activate(),{provider:t,disposables:t.disposables}}};var Ji=D(require("vscode"));sr();function Z(n,e,t,o,r){if(o==="m")throw new TypeError("Private method is not writable");if(o==="a"&&!r)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?n!==e||!r:!e.has(n))throw new TypeError("Cannot write private member to an object whose class did not declare it");return o==="a"?r.call(n,t):r?r.value=t:e.set(n,t),t}function P(n,e,t,o){if(t==="a"&&!o)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?n!==e||!o:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?o:t==="a"?o.call(n):o?o.value:e.get(n)}var Dm=function(){let{crypto:n}=globalThis;if(n?.randomUUID)return Dm=n.randomUUID.bind(n),n.randomUUID();let e=new Uint8Array(1),t=n?()=>n.getRandomValues(e)[0]:()=>Math.random()*255&255;return"10000000-1000-4000-8000-100000000000".replace(/[018]/g,o=>(+o^t()&15>>+o/4).toString(16))};function Eo(n){return typeof n=="object"&&n!==null&&("name"in n&&n.name==="AbortError"||"message"in n&&String(n.message).includes("FetchRequestCanceledException"))}var dc=n=>{if(n instanceof Error)return n;if(typeof n=="object"&&n!==null){try{if(Object.prototype.toString.call(n)==="[object Error]"){let e=new Error(n.message,n.cause?{cause:n.cause}:{});return n.stack&&(e.stack=n.stack),n.cause&&!e.cause&&(e.cause=n.cause),n.name&&(e.name=n.name),e}}catch{}try{return new Error(JSON.stringify(n))}catch{}}return new Error(n)};var Y=class extends Error{},At=class n extends Y{constructor(e,t,o,r){super(`${n.makeMessage(e,t,o)}`),this.status=e,this.headers=r,this.requestID=r?.get("request-id"),this.error=t}static makeMessage(e,t,o){let r=t?.message?typeof t.message=="string"?t.message:JSON.stringify(t.message):t?JSON.stringify(t):o;return e&&r?`${e} ${r}`:e?`${e} status code (no body)`:r||"(no status code or body)"}static generate(e,t,o,r){if(!e||!r)return new ur({message:o,cause:dc(t)});let i=t;return e===400?new ra(e,i,o,r):e===401?new ia(e,i,o,r):e===403?new aa(e,i,o,r):e===404?new sa(e,i,o,r):e===409?new ca(e,i,o,r):e===422?new la(e,i,o,r):e===429?new ua(e,i,o,r):e>=500?new da(e,i,o,r):new n(e,i,o,r)}},Lt=class extends At{constructor({message:e}={}){super(void 0,void 0,e||"Request was aborted.",void 0)}},ur=class extends At{constructor({message:e,cause:t}){super(void 0,void 0,e||"Connection error.",void 0),t&&(this.cause=t)}},oa=class extends ur{constructor({message:e}={}){super({message:e??"Request timed out."})}},ra=class extends At{},ia=class extends At{},aa=class extends At{},sa=class extends At{},ca=class extends At{},la=class extends At{},ua=class extends At{},da=class extends At{};var TM=/^[a-z][a-z0-9+.-]*:/i,lb=n=>TM.test(n),qm=n=>(qm=Array.isArray,qm(n)),Fm=qm;function Au(n){return typeof n!="object"?{}:n??{}}function ub(n){if(!n)return!0;for(let e in n)return!1;return!0}function db(n,e){return Object.prototype.hasOwnProperty.call(n,e)}var pb=(n,e)=>{if(typeof e!="number"||!Number.isInteger(e))throw new Y(`${n} must be an integer`);if(e<0)throw new Y(`${n} must be a positive integer`);return e};var Pu=n=>{try{return JSON.parse(n)}catch{return}};var mb=n=>new Promise(e=>setTimeout(e,n));var dr="0.67.0";var vb=()=>typeof window<"u"&&typeof window.document<"u"&&typeof navigator<"u";function IM(){return typeof Deno<"u"&&Deno.build!=null?"deno":typeof EdgeRuntime<"u"?"edge":Object.prototype.toString.call(typeof globalThis.process<"u"?globalThis.process:0)==="[object process]"?"node":"unknown"}var AM=()=>{let n=IM();if(n==="deno")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":dr,"X-Stainless-OS":hb(Deno.build.os),"X-Stainless-Arch":fb(Deno.build.arch),"X-Stainless-Runtime":"deno","X-Stainless-Runtime-Version":typeof Deno.version=="string"?Deno.version:Deno.version?.deno??"unknown"};if(typeof EdgeRuntime<"u")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":dr,"X-Stainless-OS":"Unknown","X-Stainless-Arch":`other:${EdgeRuntime}`,"X-Stainless-Runtime":"edge","X-Stainless-Runtime-Version":globalThis.process.version};if(n==="node")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":dr,"X-Stainless-OS":hb(globalThis.process.platform??"unknown"),"X-Stainless-Arch":fb(globalThis.process.arch??"unknown"),"X-Stainless-Runtime":"node","X-Stainless-Runtime-Version":globalThis.process.version??"unknown"};let e=PM();return e?{"X-Stainless-Lang":"js","X-Stainless-Package-Version":dr,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":`browser:${e.browser}`,"X-Stainless-Runtime-Version":e.version}:{"X-Stainless-Lang":"js","X-Stainless-Package-Version":dr,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":"unknown","X-Stainless-Runtime-Version":"unknown"}};function PM(){if(typeof navigator>"u"||!navigator)return null;let n=[{key:"edge",pattern:/Edge(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/MSIE(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/Trident(?:.*rv\:(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"chrome",pattern:/Chrome(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"firefox",pattern:/Firefox(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"safari",pattern:/(?:Version\W+(\d+)\.(\d+)(?:\.(\d+))?)?(?:\W+Mobile\S*)?\W+Safari/}];for(let{key:e,pattern:t}of n){let o=t.exec(navigator.userAgent);if(o){let r=o[1]||0,i=o[2]||0,a=o[3]||0;return{browser:e,version:`${r}.${i}.${a}`}}}return null}var fb=n=>n==="x32"?"x32":n==="x86_64"||n==="x64"?"x64":n==="arm"?"arm":n==="aarch64"||n==="arm64"?"arm64":n?`other:${n}`:"unknown",hb=n=>(n=n.toLowerCase(),n.includes("ios")?"iOS":n==="android"?"Android":n==="darwin"?"MacOS":n==="win32"?"Windows":n==="freebsd"?"FreeBSD":n==="openbsd"?"OpenBSD":n==="linux"?"Linux":n?`Other:${n}`:"Unknown"),gb,yb=()=>gb??(gb=AM());function xb(){if(typeof fetch<"u")return fetch;throw new Error("`fetch` is not defined as a global; Either pass `fetch` to the client, `new Anthropic({ fetch })` or polyfill the global, `globalThis.fetch = fetch`")}function Bm(...n){let e=globalThis.ReadableStream;if(typeof e>"u")throw new Error("`ReadableStream` is not defined as a global; You will need to polyfill it, `globalThis.ReadableStream = ReadableStream`");return new e(...n)}function Mu(n){let e=Symbol.asyncIterator in n?n[Symbol.asyncIterator]():n[Symbol.iterator]();return Bm({start(){},async pull(t){let{done:o,value:r}=await e.next();o?t.close():t.enqueue(r)},async cancel(){await e.return?.()}})}function pc(n){if(n[Symbol.asyncIterator])return n;let e=n.getReader();return{async next(){try{let t=await e.read();return t?.done&&e.releaseLock(),t}catch(t){throw e.releaseLock(),t}},async return(){let t=e.cancel();return e.releaseLock(),await t,{done:!0,value:void 0}},[Symbol.asyncIterator](){return this}}}async function bb(n){if(n===null||typeof n!="object")return;if(n[Symbol.asyncIterator]){await n[Symbol.asyncIterator]().return?.();return}let e=n.getReader(),t=e.cancel();e.releaseLock(),await t}var wb=({headers:n,body:e})=>({bodyHeaders:{"content-type":"application/json"},body:JSON.stringify(e)});function Cb(n){let e=0;for(let r of n)e+=r.length;let t=new Uint8Array(e),o=0;for(let r of n)t.set(r,o),o+=r.length;return t}var kb;function mc(n){let e;return(kb??(e=new globalThis.TextEncoder,kb=e.encode.bind(e)))(n)}var _b;function Um(n){let e;return(_b??(e=new globalThis.TextDecoder,_b=e.decode.bind(e)))(n)}var _n,Cn,Ro=class{constructor(){_n.set(this,void 0),Cn.set(this,void 0),Z(this,_n,new Uint8Array,"f"),Z(this,Cn,null,"f")}decode(e){if(e==null)return[];let t=e instanceof ArrayBuffer?new Uint8Array(e):typeof e=="string"?mc(e):e;Z(this,_n,Cb([P(this,_n,"f"),t]),"f");let o=[],r;for(;(r=$M(P(this,_n,"f"),P(this,Cn,"f")))!=null;){if(r.carriage&&P(this,Cn,"f")==null){Z(this,Cn,r.index,"f");continue}if(P(this,Cn,"f")!=null&&(r.index!==P(this,Cn,"f")+1||r.carriage)){o.push(Um(P(this,_n,"f").subarray(0,P(this,Cn,"f")-1))),Z(this,_n,P(this,_n,"f").subarray(P(this,Cn,"f")),"f"),Z(this,Cn,null,"f");continue}let i=P(this,Cn,"f")!==null?r.preceding-1:r.preceding,a=Um(P(this,_n,"f").subarray(0,i));o.push(a),Z(this,_n,P(this,_n,"f").subarray(r.index),"f"),Z(this,Cn,null,"f")}return o}flush(){return P(this,_n,"f").length?this.decode(`
`):[]}};_n=new WeakMap,Cn=new WeakMap;Ro.NEWLINE_CHARS=new Set([`
`,"\r"]);Ro.NEWLINE_REGEXP=/\r\n|[\n\r]/g;function $M(n,e){for(let r=e??0;r<n.length;r++){if(n[r]===10)return{preceding:r,index:r+1,carriage:!1};if(n[r]===13)return{preceding:r,index:r+1,carriage:!0}}return null}function Tb(n){for(let o=0;o<n.length-1;o++){if(n[o]===10&&n[o+1]===10||n[o]===13&&n[o+1]===13)return o+2;if(n[o]===13&&n[o+1]===10&&o+3<n.length&&n[o+2]===13&&n[o+3]===10)return o+4}return-1}var $u={off:0,error:200,warn:300,info:400,debug:500},jm=(n,e,t)=>{if(n){if(db($u,n))return n;Pt(t).warn(`${e} was set to ${JSON.stringify(n)}, expected one of ${JSON.stringify(Object.keys($u))}`)}};function fc(){}function Su(n,e,t){return!e||$u[n]>$u[t]?fc:e[n].bind(e)}var EM={error:fc,warn:fc,info:fc,debug:fc},Ib=new WeakMap;function Pt(n){let e=n.logger,t=n.logLevel??"off";if(!e)return EM;let o=Ib.get(e);if(o&&o[0]===t)return o[1];let r={error:Su("error",e,t),warn:Su("warn",e,t),info:Su("info",e,t),debug:Su("debug",e,t)};return Ib.set(e,[t,r]),r}var Oo=n=>(n.options&&(n.options={...n.options},delete n.options.headers),n.headers&&(n.headers=Object.fromEntries((n.headers instanceof Headers?[...n.headers]:Object.entries(n.headers)).map(([e,t])=>[e,e.toLowerCase()==="x-api-key"||e.toLowerCase()==="authorization"||e.toLowerCase()==="cookie"||e.toLowerCase()==="set-cookie"?"***":t]))),"retryOfRequestLogID"in n&&(n.retryOfRequestLogID&&(n.retryOf=n.retryOfRequestLogID),delete n.retryOfRequestLogID),n);var hc,so=class n{constructor(e,t,o){this.iterator=e,hc.set(this,void 0),this.controller=t,Z(this,hc,o,"f")}static fromSSEResponse(e,t,o){let r=!1,i=o?Pt(o):console;async function*a(){if(r)throw new Y("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");r=!0;let s=!1;try{for await(let c of RM(e,t)){if(c.event==="completion")try{yield JSON.parse(c.data)}catch(l){throw i.error("Could not parse message into JSON:",c.data),i.error("From chunk:",c.raw),l}if(c.event==="message_start"||c.event==="message_delta"||c.event==="message_stop"||c.event==="content_block_start"||c.event==="content_block_delta"||c.event==="content_block_stop")try{yield JSON.parse(c.data)}catch(l){throw i.error("Could not parse message into JSON:",c.data),i.error("From chunk:",c.raw),l}if(c.event!=="ping"&&c.event==="error")throw new At(void 0,Pu(c.data)??c.data,void 0,e.headers)}s=!0}catch(c){if(Eo(c))return;throw c}finally{s||t.abort()}}return new n(a,t,o)}static fromReadableStream(e,t,o){let r=!1;async function*i(){let s=new Ro,c=pc(e);for await(let l of c)for(let d of s.decode(l))yield d;for(let l of s.flush())yield l}async function*a(){if(r)throw new Y("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");r=!0;let s=!1;try{for await(let c of i())s||c&&(yield JSON.parse(c));s=!0}catch(c){if(Eo(c))return;throw c}finally{s||t.abort()}}return new n(a,t,o)}[(hc=new WeakMap,Symbol.asyncIterator)](){return this.iterator()}tee(){let e=[],t=[],o=this.iterator(),r=i=>({next:()=>{if(i.length===0){let a=o.next();e.push(a),t.push(a)}return i.shift()}});return[new n(()=>r(e),this.controller,P(this,hc,"f")),new n(()=>r(t),this.controller,P(this,hc,"f"))]}toReadableStream(){let e=this,t;return Bm({async start(){t=e[Symbol.asyncIterator]()},async pull(o){try{let{value:r,done:i}=await t.next();if(i)return o.close();let a=mc(JSON.stringify(r)+`
`);o.enqueue(a)}catch(r){o.error(r)}},async cancel(){await t.return?.()}})}};async function*RM(n,e){if(!n.body)throw e.abort(),typeof globalThis.navigator<"u"&&globalThis.navigator.product==="ReactNative"?new Y("The default react-native fetch implementation does not support streaming. Please use expo/fetch: https://docs.expo.dev/versions/latest/sdk/expo/#expofetch-api"):new Y("Attempted to iterate over a response with no body");let t=new Km,o=new Ro,r=pc(n.body);for await(let i of OM(r))for(let a of o.decode(i)){let s=t.decode(a);s&&(yield s)}for(let i of o.flush()){let a=t.decode(i);a&&(yield a)}}async function*OM(n){let e=new Uint8Array;for await(let t of n){if(t==null)continue;let o=t instanceof ArrayBuffer?new Uint8Array(t):typeof t=="string"?mc(t):t,r=new Uint8Array(e.length+o.length);r.set(e),r.set(o,e.length),e=r;let i;for(;(i=Tb(e))!==-1;)yield e.slice(0,i),e=e.slice(i)}e.length>0&&(yield e)}var Km=class{constructor(){this.event=null,this.data=[],this.chunks=[]}decode(e){if(e.endsWith("\r")&&(e=e.substring(0,e.length-1)),!e){if(!this.event&&!this.data.length)return null;let i={event:this.event,data:this.data.join(`
`),raw:this.chunks};return this.event=null,this.data=[],this.chunks=[],i}if(this.chunks.push(e),e.startsWith(":"))return null;let[t,o,r]=LM(e,":");return r.startsWith(" ")&&(r=r.substring(1)),t==="event"?this.event=r:t==="data"&&this.data.push(r),null}};function LM(n,e){let t=n.indexOf(e);return t!==-1?[n.substring(0,t),e,n.substring(t+e.length)]:[n,"",""]}async function Eu(n,e){let{response:t,requestLogID:o,retryOfRequestLogID:r,startTime:i}=e,a=await(async()=>{if(e.options.stream)return Pt(n).debug("response",t.status,t.url,t.headers,t.body),e.options.__streamClass?e.options.__streamClass.fromSSEResponse(t,e.controller):so.fromSSEResponse(t,e.controller);if(t.status===204)return null;if(e.options.__binaryResponse)return t;let c=t.headers.get("content-type")?.split(";")[0]?.trim();if(c?.includes("application/json")||c?.endsWith("+json")){let p=await t.json();return Hm(p,t)}return await t.text()})();return Pt(n).debug(`[${o}] response parsed`,Oo({retryOfRequestLogID:r,url:t.url,status:t.status,body:a,durationMs:Date.now()-i})),a}function Hm(n,e){return!n||typeof n!="object"||Array.isArray(n)?n:Object.defineProperty(n,"_request_id",{value:e.headers.get("request-id"),enumerable:!1})}var gc,Xr=class n extends Promise{constructor(e,t,o=Eu){super(r=>{r(null)}),this.responsePromise=t,this.parseResponse=o,gc.set(this,void 0),Z(this,gc,e,"f")}_thenUnwrap(e){return new n(P(this,gc,"f"),this.responsePromise,async(t,o)=>Hm(e(await this.parseResponse(t,o),o),o.response))}asResponse(){return this.responsePromise.then(e=>e.response)}async withResponse(){let[e,t]=await Promise.all([this.parse(),this.asResponse()]);return{data:e,response:t,request_id:t.headers.get("request-id")}}parse(){return this.parsedPromise||(this.parsedPromise=this.responsePromise.then(e=>this.parseResponse(P(this,gc,"f"),e))),this.parsedPromise}then(e,t){return this.parse().then(e,t)}catch(e){return this.parse().catch(e)}finally(e){return this.parse().finally(e)}};gc=new WeakMap;var Ru,Ou=class{constructor(e,t,o,r){Ru.set(this,void 0),Z(this,Ru,e,"f"),this.options=r,this.response=t,this.body=o}hasNextPage(){return this.getPaginatedItems().length?this.nextPageRequestOptions()!=null:!1}async getNextPage(){let e=this.nextPageRequestOptions();if(!e)throw new Y("No next page expected; please check `.hasNextPage()` before calling `.getNextPage()`.");return await P(this,Ru,"f").requestAPIList(this.constructor,e)}async*iterPages(){let e=this;for(yield e;e.hasNextPage();)e=await e.getNextPage(),yield e}async*[(Ru=new WeakMap,Symbol.asyncIterator)](){for await(let e of this.iterPages())for(let t of e.getPaginatedItems())yield t}},vc=class extends Xr{constructor(e,t,o){super(e,t,async(r,i)=>new o(r,i.response,await Eu(r,i),i.options))}async*[Symbol.asyncIterator](){let e=await this;for await(let t of e)yield t}},En=class extends Ou{constructor(e,t,o,r){super(e,t,o,r),this.data=o.data||[],this.has_more=o.has_more||!1,this.first_id=o.first_id||null,this.last_id=o.last_id||null}getPaginatedItems(){return this.data??[]}hasNextPage(){return this.has_more===!1?!1:super.hasNextPage()}nextPageRequestOptions(){if(this.options.query?.before_id){let t=this.first_id;return t?{...this.options,query:{...Au(this.options.query),before_id:t}}:null}let e=this.last_id;return e?{...this.options,query:{...Au(this.options.query),after_id:e}}:null}};var pa=class extends Ou{constructor(e,t,o,r){super(e,t,o,r),this.data=o.data||[],this.has_more=o.has_more||!1,this.next_page=o.next_page||null}getPaginatedItems(){return this.data??[]}hasNextPage(){return this.has_more===!1?!1:super.hasNextPage()}nextPageRequestOptions(){let e=this.next_page;return e?{...this.options,query:{...Au(this.options.query),page:e}}:null}};var Gm=()=>{if(typeof File>"u"){let{process:n}=globalThis,e=typeof n?.versions?.node=="string"&&parseInt(n.versions.node.split("."))<20;throw new Error("`File` is not defined as a global, which is required for file uploads."+(e?" Update to Node 20 LTS or newer, or set `globalThis.File` to `import('node:buffer').File`.":""))}};function Yr(n,e,t){return Gm(),new File(n,e??"unknown_file",t)}function yc(n){return(typeof n=="object"&&n!==null&&("name"in n&&n.name&&String(n.name)||"url"in n&&n.url&&String(n.url)||"filename"in n&&n.filename&&String(n.filename)||"path"in n&&n.path&&String(n.path))||"").split(/[\\/]/).pop()||void 0}var Vm=n=>n!=null&&typeof n=="object"&&typeof n[Symbol.asyncIterator]=="function";var ma=async(n,e)=>({...n,body:await DM(n.body,e)}),Ab=new WeakMap;function zM(n){let e=typeof n=="function"?n:n.fetch,t=Ab.get(e);if(t)return t;let o=(async()=>{try{let r="Response"in e?e.Response:(await e("data:,")).constructor,i=new FormData;return i.toString()!==await new r(i).text()}catch{return!0}})();return Ab.set(e,o),o}var DM=async(n,e)=>{if(!await zM(e))throw new TypeError("The provided fetch function does not support file uploads with the current global FormData class.");let t=new FormData;return await Promise.all(Object.entries(n||{}).map(([o,r])=>Zm(t,o,r))),t},qM=n=>n instanceof Blob&&"name"in n;var Zm=async(n,e,t)=>{if(t!==void 0){if(t==null)throw new TypeError(`Received null for "${e}"; to pass null in FormData, you must use the string 'null'`);if(typeof t=="string"||typeof t=="number"||typeof t=="boolean")n.append(e,String(t));else if(t instanceof Response){let o={},r=t.headers.get("Content-Type");r&&(o={type:r}),n.append(e,Yr([await t.blob()],yc(t),o))}else if(Vm(t))n.append(e,Yr([await new Response(Mu(t)).blob()],yc(t)));else if(qM(t))n.append(e,Yr([t],yc(t),{type:t.type}));else if(Array.isArray(t))await Promise.all(t.map(o=>Zm(n,e+"[]",o)));else if(typeof t=="object")await Promise.all(Object.entries(t).map(([o,r])=>Zm(n,`${e}[${o}]`,r)));else throw new TypeError(`Invalid value given to form, expected a string, number, boolean, object, Array, File or Blob but got ${t} instead`)}};var Pb=n=>n!=null&&typeof n=="object"&&typeof n.size=="number"&&typeof n.type=="string"&&typeof n.text=="function"&&typeof n.slice=="function"&&typeof n.arrayBuffer=="function",FM=n=>n!=null&&typeof n=="object"&&typeof n.name=="string"&&typeof n.lastModified=="number"&&Pb(n),BM=n=>n!=null&&typeof n=="object"&&typeof n.url=="string"&&typeof n.blob=="function";async function Lu(n,e,t){if(Gm(),n=await n,e||(e=yc(n)),FM(n))return n instanceof File&&e==null&&t==null?n:Yr([await n.arrayBuffer()],e??n.name,{type:n.type,lastModified:n.lastModified,...t});if(BM(n)){let r=await n.blob();return e||(e=new URL(n.url).pathname.split(/[\\/]/).pop()),Yr(await Qm(r),e,t)}let o=await Qm(n);if(!t?.type){let r=o.find(i=>typeof i=="object"&&"type"in i&&i.type);typeof r=="string"&&(t={...t,type:r})}return Yr(o,e,t)}async function Qm(n){let e=[];if(typeof n=="string"||ArrayBuffer.isView(n)||n instanceof ArrayBuffer)e.push(n);else if(Pb(n))e.push(n instanceof Blob?n:await n.arrayBuffer());else if(Vm(n))for await(let t of n)e.push(...await Qm(t));else{let t=n?.constructor?.name;throw new Error(`Unexpected data type: ${typeof n}${t?`; constructor: ${t}`:""}${UM(n)}`)}return e}function UM(n){return typeof n!="object"||n===null?"":`; props: [${Object.getOwnPropertyNames(n).map(t=>`"${t}"`).join(", ")}]`}var Qe=class{constructor(e){this._client=e}};var Mb=Symbol.for("brand.privateNullableHeaders");function*KM(n){if(!n)return;if(Mb in n){let{values:o,nulls:r}=n;yield*o.entries();for(let i of r)yield[i,null];return}let e=!1,t;n instanceof Headers?t=n.entries():Fm(n)?t=n:(e=!0,t=Object.entries(n??{}));for(let o of t){let r=o[0];if(typeof r!="string")throw new TypeError("expected header name to be a string");let i=Fm(o[1])?o[1]:[o[1]],a=!1;for(let s of i)s!==void 0&&(e&&!a&&(a=!0,yield[r,null]),yield[r,s])}}var re=n=>{let e=new Headers,t=new Set;for(let o of n){let r=new Set;for(let[i,a]of KM(o)){let s=i.toLowerCase();r.has(s)||(e.delete(i),r.add(s)),a===null?(e.delete(i),t.add(s)):(e.append(i,a),t.delete(s))}}return{[Mb]:!0,values:e,nulls:t}};function $b(n){return n.replace(/[^A-Za-z0-9\-._~!$&'()*+,;=:@]+/g,encodeURIComponent)}var Sb=Object.freeze(Object.create(null)),HM=(n=$b)=>function(t,...o){if(t.length===1)return t[0];let r=!1,i=[],a=t.reduce((d,p,f)=>{/[?#]/.test(p)&&(r=!0);let m=o[f],h=(r?encodeURIComponent:n)(""+m);return f!==o.length&&(m==null||typeof m=="object"&&m.toString===Object.getPrototypeOf(Object.getPrototypeOf(m.hasOwnProperty??Sb)??Sb)?.toString)&&(h=m+"",i.push({start:d.length+p.length,length:h.length,error:`Value of type ${Object.prototype.toString.call(m).slice(8,-1)} is not a valid path parameter`})),d+p+(f===o.length?"":h)},""),s=a.split(/[?#]/,1)[0],c=/(?<=^|\/)(?:\.|%2e){1,2}(?=\/|$)/gi,l;for(;(l=c.exec(s))!==null;)i.push({start:l.index,length:l[0].length,error:`Value "${l[0]}" can't be safely passed as a path parameter`});if(i.sort((d,p)=>d.start-p.start),i.length>0){let d=0,p=i.reduce((f,m)=>{let h=" ".repeat(m.start-d),g="^".repeat(m.length);return d=m.start+m.length,f+h+g},"");throw new Y(`Path parameters result in path with invalid segments:
${i.map(f=>f.error).join(`
`)}
${a}
${p}`)}return a},We=HM($b);var fa=class extends Qe{list(e={},t){let{betas:o,...r}=e??{};return this._client.getAPIList("/v1/files",En,{query:r,...t,headers:re([{"anthropic-beta":[...o??[],"files-api-2025-04-14"].toString()},t?.headers])})}delete(e,t={},o){let{betas:r}=t??{};return this._client.delete(We`/v1/files/${e}`,{...o,headers:re([{"anthropic-beta":[...r??[],"files-api-2025-04-14"].toString()},o?.headers])})}download(e,t={},o){let{betas:r}=t??{};return this._client.get(We`/v1/files/${e}/content`,{...o,headers:re([{"anthropic-beta":[...r??[],"files-api-2025-04-14"].toString(),Accept:"application/binary"},o?.headers]),__binaryResponse:!0})}retrieveMetadata(e,t={},o){let{betas:r}=t??{};return this._client.get(We`/v1/files/${e}`,{...o,headers:re([{"anthropic-beta":[...r??[],"files-api-2025-04-14"].toString()},o?.headers])})}upload(e,t){let{betas:o,...r}=e;return this._client.post("/v1/files",ma({body:r,...t,headers:re([{"anthropic-beta":[...o??[],"files-api-2025-04-14"].toString()},t?.headers])},this._client))}};var ha=class extends Qe{retrieve(e,t={},o){let{betas:r}=t??{};return this._client.get(We`/v1/models/${e}?beta=true`,{...o,headers:re([{...r?.toString()!=null?{"anthropic-beta":r?.toString()}:void 0},o?.headers])})}list(e={},t){let{betas:o,...r}=e??{};return this._client.getAPIList("/v1/models?beta=true",En,{query:r,...t,headers:re([{...o?.toString()!=null?{"anthropic-beta":o?.toString()}:void 0},t?.headers])})}};var ga=class n{constructor(e,t){this.iterator=e,this.controller=t}async*decoder(){let e=new Ro;for await(let t of this.iterator)for(let o of e.decode(t))yield JSON.parse(o);for(let t of e.flush())yield JSON.parse(t)}[Symbol.asyncIterator](){return this.decoder()}static fromResponse(e,t){if(!e.body)throw t.abort(),typeof globalThis.navigator<"u"&&globalThis.navigator.product==="ReactNative"?new Y("The default react-native fetch implementation does not support streaming. Please use expo/fetch: https://docs.expo.dev/versions/latest/sdk/expo/#expofetch-api"):new Y("Attempted to iterate over a response with no body");return new n(pc(e.body),t)}};var va=class extends Qe{create(e,t){let{betas:o,...r}=e;return this._client.post("/v1/messages/batches?beta=true",{body:r,...t,headers:re([{"anthropic-beta":[...o??[],"message-batches-2024-09-24"].toString()},t?.headers])})}retrieve(e,t={},o){let{betas:r}=t??{};return this._client.get(We`/v1/messages/batches/${e}?beta=true`,{...o,headers:re([{"anthropic-beta":[...r??[],"message-batches-2024-09-24"].toString()},o?.headers])})}list(e={},t){let{betas:o,...r}=e??{};return this._client.getAPIList("/v1/messages/batches?beta=true",En,{query:r,...t,headers:re([{"anthropic-beta":[...o??[],"message-batches-2024-09-24"].toString()},t?.headers])})}delete(e,t={},o){let{betas:r}=t??{};return this._client.delete(We`/v1/messages/batches/${e}?beta=true`,{...o,headers:re([{"anthropic-beta":[...r??[],"message-batches-2024-09-24"].toString()},o?.headers])})}cancel(e,t={},o){let{betas:r}=t??{};return this._client.post(We`/v1/messages/batches/${e}/cancel?beta=true`,{...o,headers:re([{"anthropic-beta":[...r??[],"message-batches-2024-09-24"].toString()},o?.headers])})}async results(e,t={},o){let r=await this.retrieve(e);if(!r.results_url)throw new Y(`No batch \`results_url\`; Has it finished processing? ${r.processing_status} - ${r.id}`);let{betas:i}=t??{};return this._client.get(r.results_url,{...o,headers:re([{"anthropic-beta":[...i??[],"message-batches-2024-09-24"].toString(),Accept:"application/binary"},o?.headers]),stream:!0,__binaryResponse:!0})._thenUnwrap((a,s)=>ga.fromResponse(s.response,s.controller))}};var QM=n=>{let e=0,t=[];for(;e<n.length;){let o=n[e];if(o==="\\"){e++;continue}if(o==="{"){t.push({type:"brace",value:"{"}),e++;continue}if(o==="}"){t.push({type:"brace",value:"}"}),e++;continue}if(o==="["){t.push({type:"paren",value:"["}),e++;continue}if(o==="]"){t.push({type:"paren",value:"]"}),e++;continue}if(o===":"){t.push({type:"separator",value:":"}),e++;continue}if(o===","){t.push({type:"delimiter",value:","}),e++;continue}if(o==='"'){let s="",c=!1;for(o=n[++e];o!=='"';){if(e===n.length){c=!0;break}if(o==="\\"){if(e++,e===n.length){c=!0;break}s+=o+n[e],o=n[++e]}else s+=o,o=n[++e]}o=n[++e],c||t.push({type:"string",value:s});continue}if(o&&/\s/.test(o)){e++;continue}let i=/[0-9]/;if(o&&i.test(o)||o==="-"||o==="."){let s="";for(o==="-"&&(s+=o,o=n[++e]);o&&i.test(o)||o===".";)s+=o,o=n[++e];t.push({type:"number",value:s});continue}let a=/[a-z]/i;if(o&&a.test(o)){let s="";for(;o&&a.test(o)&&e!==n.length;)s+=o,o=n[++e];if(s=="true"||s=="false"||s==="null")t.push({type:"name",value:s});else{e++;continue}continue}e++}return t},ya=n=>{if(n.length===0)return n;let e=n[n.length-1];switch(e.type){case"separator":return n=n.slice(0,n.length-1),ya(n);break;case"number":let t=e.value[e.value.length-1];if(t==="."||t==="-")return n=n.slice(0,n.length-1),ya(n);case"string":let o=n[n.length-2];if(o?.type==="delimiter")return n=n.slice(0,n.length-1),ya(n);if(o?.type==="brace"&&o.value==="{")return n=n.slice(0,n.length-1),ya(n);break;case"delimiter":return n=n.slice(0,n.length-1),ya(n);break}return n},WM=n=>{let e=[];return n.map(t=>{t.type==="brace"&&(t.value==="{"?e.push("}"):e.splice(e.lastIndexOf("}"),1)),t.type==="paren"&&(t.value==="["?e.push("]"):e.splice(e.lastIndexOf("]"),1))}),e.length>0&&e.reverse().map(t=>{t==="}"?n.push({type:"brace",value:"}"}):t==="]"&&n.push({type:"paren",value:"]"})}),n},JM=n=>{let e="";return n.map(t=>{switch(t.type){case"string":e+='"'+t.value+'"';break;default:e+=t.value;break}}),e},Nu=n=>JSON.parse(JM(WM(ya(QM(n)))));var Rn,pr,xc,zu,bc,wc,Du,kc,Lo,_c,qu,Fu,xa,Bu,Uu,Wm,Eb,ju,Jm,Xm,Ym,Rb,Ob="__json_buf";function Lb(n){return n.type==="tool_use"||n.type==="server_tool_use"||n.type==="mcp_tool_use"}var Ku=class n{constructor(){Rn.add(this),this.messages=[],this.receivedMessages=[],pr.set(this,void 0),this.controller=new AbortController,xc.set(this,void 0),zu.set(this,()=>{}),bc.set(this,()=>{}),wc.set(this,void 0),Du.set(this,()=>{}),kc.set(this,()=>{}),Lo.set(this,{}),_c.set(this,!1),qu.set(this,!1),Fu.set(this,!1),xa.set(this,!1),Bu.set(this,void 0),Uu.set(this,void 0),ju.set(this,e=>{if(Z(this,qu,!0,"f"),Eo(e)&&(e=new Lt),e instanceof Lt)return Z(this,Fu,!0,"f"),this._emit("abort",e);if(e instanceof Y)return this._emit("error",e);if(e instanceof Error){let t=new Y(e.message);return t.cause=e,this._emit("error",t)}return this._emit("error",new Y(String(e)))}),Z(this,xc,new Promise((e,t)=>{Z(this,zu,e,"f"),Z(this,bc,t,"f")}),"f"),Z(this,wc,new Promise((e,t)=>{Z(this,Du,e,"f"),Z(this,kc,t,"f")}),"f"),P(this,xc,"f").catch(()=>{}),P(this,wc,"f").catch(()=>{})}get response(){return P(this,Bu,"f")}get request_id(){return P(this,Uu,"f")}async withResponse(){let e=await P(this,xc,"f");if(!e)throw new Error("Could not resolve a `Response` object");return{data:this,response:e,request_id:e.headers.get("request-id")}}static fromReadableStream(e){let t=new n;return t._run(()=>t._fromReadableStream(e)),t}static createMessage(e,t,o){let r=new n;for(let i of t.messages)r._addMessageParam(i);return r._run(()=>r._createMessage(e,{...t,stream:!0},{...o,headers:{...o?.headers,"X-Stainless-Helper-Method":"stream"}})),r}_run(e){e().then(()=>{this._emitFinal(),this._emit("end")},P(this,ju,"f"))}_addMessageParam(e){this.messages.push(e)}_addMessage(e,t=!0){this.receivedMessages.push(e),t&&this._emit("message",e)}async _createMessage(e,t,o){let r=o?.signal,i;r&&(r.aborted&&this.controller.abort(),i=this.controller.abort.bind(this.controller),r.addEventListener("abort",i));try{P(this,Rn,"m",Jm).call(this);let{response:a,data:s}=await e.create({...t,stream:!0},{...o,signal:this.controller.signal}).withResponse();this._connected(a);for await(let c of s)P(this,Rn,"m",Xm).call(this,c);if(s.controller.signal?.aborted)throw new Lt;P(this,Rn,"m",Ym).call(this)}finally{r&&i&&r.removeEventListener("abort",i)}}_connected(e){this.ended||(Z(this,Bu,e,"f"),Z(this,Uu,e?.headers.get("request-id"),"f"),P(this,zu,"f").call(this,e),this._emit("connect"))}get ended(){return P(this,_c,"f")}get errored(){return P(this,qu,"f")}get aborted(){return P(this,Fu,"f")}abort(){this.controller.abort()}on(e,t){return(P(this,Lo,"f")[e]||(P(this,Lo,"f")[e]=[])).push({listener:t}),this}off(e,t){let o=P(this,Lo,"f")[e];if(!o)return this;let r=o.findIndex(i=>i.listener===t);return r>=0&&o.splice(r,1),this}once(e,t){return(P(this,Lo,"f")[e]||(P(this,Lo,"f")[e]=[])).push({listener:t,once:!0}),this}emitted(e){return new Promise((t,o)=>{Z(this,xa,!0,"f"),e!=="error"&&this.once("error",o),this.once(e,t)})}async done(){Z(this,xa,!0,"f"),await P(this,wc,"f")}get currentMessage(){return P(this,pr,"f")}async finalMessage(){return await this.done(),P(this,Rn,"m",Wm).call(this)}async finalText(){return await this.done(),P(this,Rn,"m",Eb).call(this)}_emit(e,...t){if(P(this,_c,"f"))return;e==="end"&&(Z(this,_c,!0,"f"),P(this,Du,"f").call(this));let o=P(this,Lo,"f")[e];if(o&&(P(this,Lo,"f")[e]=o.filter(r=>!r.once),o.forEach(({listener:r})=>r(...t))),e==="abort"){let r=t[0];!P(this,xa,"f")&&!o?.length&&Promise.reject(r),P(this,bc,"f").call(this,r),P(this,kc,"f").call(this,r),this._emit("end");return}if(e==="error"){let r=t[0];!P(this,xa,"f")&&!o?.length&&Promise.reject(r),P(this,bc,"f").call(this,r),P(this,kc,"f").call(this,r),this._emit("end")}}_emitFinal(){this.receivedMessages.at(-1)&&this._emit("finalMessage",P(this,Rn,"m",Wm).call(this))}async _fromReadableStream(e,t){let o=t?.signal,r;o&&(o.aborted&&this.controller.abort(),r=this.controller.abort.bind(this.controller),o.addEventListener("abort",r));try{P(this,Rn,"m",Jm).call(this),this._connected(null);let i=so.fromReadableStream(e,this.controller);for await(let a of i)P(this,Rn,"m",Xm).call(this,a);if(i.controller.signal?.aborted)throw new Lt;P(this,Rn,"m",Ym).call(this)}finally{o&&r&&o.removeEventListener("abort",r)}}[(pr=new WeakMap,xc=new WeakMap,zu=new WeakMap,bc=new WeakMap,wc=new WeakMap,Du=new WeakMap,kc=new WeakMap,Lo=new WeakMap,_c=new WeakMap,qu=new WeakMap,Fu=new WeakMap,xa=new WeakMap,Bu=new WeakMap,Uu=new WeakMap,ju=new WeakMap,Rn=new WeakSet,Wm=function(){if(this.receivedMessages.length===0)throw new Y("stream ended without producing a Message with role=assistant");return this.receivedMessages.at(-1)},Eb=function(){if(this.receivedMessages.length===0)throw new Y("stream ended without producing a Message with role=assistant");let t=this.receivedMessages.at(-1).content.filter(o=>o.type==="text").map(o=>o.text);if(t.length===0)throw new Y("stream ended without producing a content block with type=text");return t.join(" ")},Jm=function(){this.ended||Z(this,pr,void 0,"f")},Xm=function(t){if(this.ended)return;let o=P(this,Rn,"m",Rb).call(this,t);switch(this._emit("streamEvent",t,o),t.type){case"content_block_delta":{let r=o.content.at(-1);switch(t.delta.type){case"text_delta":{r.type==="text"&&this._emit("text",t.delta.text,r.text||"");break}case"citations_delta":{r.type==="text"&&this._emit("citation",t.delta.citation,r.citations??[]);break}case"input_json_delta":{Lb(r)&&r.input&&this._emit("inputJson",t.delta.partial_json,r.input);break}case"thinking_delta":{r.type==="thinking"&&this._emit("thinking",t.delta.thinking,r.thinking);break}case"signature_delta":{r.type==="thinking"&&this._emit("signature",r.signature);break}default:t.delta}break}case"message_stop":{this._addMessageParam(o),this._addMessage(o,!0);break}case"content_block_stop":{this._emit("contentBlock",o.content.at(-1));break}case"message_start":{Z(this,pr,o,"f");break}case"content_block_start":case"message_delta":break}},Ym=function(){if(this.ended)throw new Y("stream has ended, this shouldn't happen");let t=P(this,pr,"f");if(!t)throw new Y("request ended without sending any chunks");return Z(this,pr,void 0,"f"),t},Rb=function(t){let o=P(this,pr,"f");if(t.type==="message_start"){if(o)throw new Y(`Unexpected event order, got ${t.type} before receiving "message_stop"`);return t.message}if(!o)throw new Y(`Unexpected event order, got ${t.type} before "message_start"`);switch(t.type){case"message_stop":return o;case"message_delta":return o.container=t.delta.container,o.stop_reason=t.delta.stop_reason,o.stop_sequence=t.delta.stop_sequence,o.usage.output_tokens=t.usage.output_tokens,o.context_management=t.context_management,t.usage.input_tokens!=null&&(o.usage.input_tokens=t.usage.input_tokens),t.usage.cache_creation_input_tokens!=null&&(o.usage.cache_creation_input_tokens=t.usage.cache_creation_input_tokens),t.usage.cache_read_input_tokens!=null&&(o.usage.cache_read_input_tokens=t.usage.cache_read_input_tokens),t.usage.server_tool_use!=null&&(o.usage.server_tool_use=t.usage.server_tool_use),o;case"content_block_start":return o.content.push(t.content_block),o;case"content_block_delta":{let r=o.content.at(t.index);switch(t.delta.type){case"text_delta":{r?.type==="text"&&(o.content[t.index]={...r,text:(r.text||"")+t.delta.text});break}case"citations_delta":{r?.type==="text"&&(o.content[t.index]={...r,citations:[...r.citations??[],t.delta.citation]});break}case"input_json_delta":{if(r&&Lb(r)){let i=r[Ob]||"";i+=t.delta.partial_json;let a={...r};if(Object.defineProperty(a,Ob,{value:i,enumerable:!1,writable:!0}),i)try{a.input=Nu(i)}catch(s){let c=new Y(`Unable to parse tool parameter JSON from model. Please retry your request or adjust your prompt. Error: ${s}. JSON: ${i}`);P(this,ju,"f").call(this,c)}o.content[t.index]=a}break}case"thinking_delta":{r?.type==="thinking"&&(o.content[t.index]={...r,thinking:r.thinking+t.delta.thinking});break}case"signature_delta":{r?.type==="thinking"&&(o.content[t.index]={...r,signature:t.delta.signature});break}default:t.delta}return o}case"content_block_stop":return o}},Symbol.asyncIterator)](){let e=[],t=[],o=!1;return this.on("streamEvent",r=>{let i=t.shift();i?i.resolve(r):e.push(r)}),this.on("end",()=>{o=!0;for(let r of t)r.resolve(void 0);t.length=0}),this.on("abort",r=>{o=!0;for(let i of t)i.reject(r);t.length=0}),this.on("error",r=>{o=!0;for(let i of t)i.reject(r);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:o?{value:void 0,done:!0}:new Promise((i,a)=>t.push({resolve:i,reject:a})).then(i=>i?{value:i,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}toReadableStream(){return new so(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}};var Hu={"claude-opus-4-20250514":8192,"claude-opus-4-0":8192,"claude-4-opus-20250514":8192,"anthropic.claude-opus-4-20250514-v1:0":8192,"claude-opus-4@20250514":8192,"claude-opus-4-1-20250805":8192,"anthropic.claude-opus-4-1-20250805-v1:0":8192,"claude-opus-4-1@20250805":8192};var Zu,ba,ei,sn,Cc,Un,No,mr,Tc,ef;function Nb(){let n,e;return{promise:new Promise((o,r)=>{n=o,e=r}),resolve:n,reject:e}}var wa=class{constructor(e,t,o){Zu.add(this),this.client=e,ba.set(this,!1),ei.set(this,!1),sn.set(this,void 0),Cc.set(this,void 0),Un.set(this,void 0),No.set(this,void 0),mr.set(this,void 0),Tc.set(this,0),Z(this,sn,{params:{...t,messages:structuredClone(t.messages)}},"f"),Z(this,Cc,{...o,headers:re([{"x-stainless-helper":"BetaToolRunner"},o?.headers])},"f"),Z(this,mr,Nb(),"f")}async*[(ba=new WeakMap,ei=new WeakMap,sn=new WeakMap,Cc=new WeakMap,Un=new WeakMap,No=new WeakMap,mr=new WeakMap,Tc=new WeakMap,Zu=new WeakSet,Symbol.asyncIterator)](){var e;if(P(this,ba,"f"))throw new Y("Cannot iterate over a consumed stream");Z(this,ba,!0,"f"),Z(this,ei,!0,"f"),Z(this,No,void 0,"f");try{for(;;){let t;try{if(P(this,sn,"f").params.max_iterations&&P(this,Tc,"f")>=P(this,sn,"f").params.max_iterations)break;Z(this,ei,!1,"f"),Z(this,Un,void 0,"f"),Z(this,No,void 0,"f"),Z(this,Tc,(e=P(this,Tc,"f"),e++,e),"f");let{max_iterations:o,...r}=P(this,sn,"f").params;if(r.stream?(t=this.client.beta.messages.stream({...r},P(this,Cc,"f")),Z(this,Un,t.finalMessage(),"f"),P(this,Un,"f").catch(()=>{}),yield t):(Z(this,Un,this.client.beta.messages.create({...r,stream:!1},P(this,Cc,"f")),"f"),yield P(this,Un,"f")),!P(this,ei,"f")){let{role:a,content:s}=await P(this,Un,"f");P(this,sn,"f").params.messages.push({role:a,content:s})}let i=await P(this,Zu,"m",ef).call(this,P(this,sn,"f").params.messages.at(-1));if(i&&P(this,sn,"f").params.messages.push(i),!i&&!P(this,ei,"f"))break}finally{t&&t.abort()}}if(!P(this,Un,"f"))throw new Y("ToolRunner concluded without a message from the server");P(this,mr,"f").resolve(await P(this,Un,"f"))}catch(t){throw Z(this,ba,!1,"f"),P(this,mr,"f").promise.catch(()=>{}),P(this,mr,"f").reject(t),Z(this,mr,Nb(),"f"),t}}setMessagesParams(e){typeof e=="function"?P(this,sn,"f").params=e(P(this,sn,"f").params):P(this,sn,"f").params=e,Z(this,ei,!0,"f"),Z(this,No,void 0,"f")}async generateToolResponse(){let e=await P(this,Un,"f")??this.params.messages.at(-1);return e?P(this,Zu,"m",ef).call(this,e):null}done(){return P(this,mr,"f").promise}async runUntilDone(){if(!P(this,ba,"f"))for await(let e of this);return this.done()}get params(){return P(this,sn,"f").params}pushMessages(...e){this.setMessagesParams(t=>({...t,messages:[...t.messages,...e]}))}then(e,t){return this.runUntilDone().then(e,t)}};ef=async function(e){return P(this,No,"f")!==void 0?P(this,No,"f"):(Z(this,No,XM(P(this,sn,"f").params,e),"f"),P(this,No,"f"))};async function XM(n,e=n.messages.at(-1)){if(!e||e.role!=="assistant"||!e.content||typeof e.content=="string")return null;let t=e.content.filter(r=>r.type==="tool_use");return t.length===0?null:{role:"user",content:await Promise.all(t.map(async r=>{let i=n.tools.find(a=>a.name===r.name);if(!i||!("run"in i))return{type:"tool_result",tool_use_id:r.id,content:`Error: Tool '${r.name}' not found`,is_error:!0};try{let a=r.input;"parse"in i&&i.parse&&(a=i.parse(a));let s=await i.run(a);return{type:"tool_result",tool_use_id:r.id,content:s}}catch(a){return{type:"tool_result",tool_use_id:r.id,content:`Error: ${a instanceof Error?a.message:String(a)}`,is_error:!0}}}))}}var zb={"claude-1.3":"November 6th, 2024","claude-1.3-100k":"November 6th, 2024","claude-instant-1.1":"November 6th, 2024","claude-instant-1.1-100k":"November 6th, 2024","claude-instant-1.2":"November 6th, 2024","claude-3-sonnet-20240229":"July 21st, 2025","claude-3-opus-20240229":"January 5th, 2026","claude-2.1":"July 21st, 2025","claude-2.0":"July 21st, 2025","claude-3-5-sonnet-20241022":"October 22, 2025","claude-3-5-sonnet-20240620":"October 22, 2025"},fr=class extends Qe{constructor(){super(...arguments),this.batches=new va(this._client)}create(e,t){let{betas:o,...r}=e;r.model in zb&&console.warn(`The model '${r.model}' is deprecated and will reach end-of-life on ${zb[r.model]}
Please migrate to a newer model. Visit https://docs.anthropic.com/en/docs/resources/model-deprecations for more information.`);let i=this._client._options.timeout;if(!r.stream&&i==null){let a=Hu[r.model]??void 0;i=this._client.calculateNonstreamingTimeout(r.max_tokens,a)}return this._client.post("/v1/messages?beta=true",{body:r,timeout:i??6e5,...t,headers:re([{...o?.toString()!=null?{"anthropic-beta":o?.toString()}:void 0},t?.headers]),stream:e.stream??!1})}stream(e,t){return Ku.createMessage(this,e,t)}countTokens(e,t){let{betas:o,...r}=e;return this._client.post("/v1/messages/count_tokens?beta=true",{body:r,...t,headers:re([{"anthropic-beta":[...o??[],"token-counting-2024-11-01"].toString()},t?.headers])})}toolRunner(e,t){return new wa(this._client,e,t)}};fr.Batches=va;fr.BetaToolRunner=wa;var ka=class extends Qe{create(e,t={},o){let{betas:r,...i}=t??{};return this._client.post(We`/v1/skills/${e}/versions?beta=true`,ma({body:i,...o,headers:re([{"anthropic-beta":[...r??[],"skills-2025-10-02"].toString()},o?.headers])},this._client))}retrieve(e,t,o){let{skill_id:r,betas:i}=t;return this._client.get(We`/v1/skills/${r}/versions/${e}?beta=true`,{...o,headers:re([{"anthropic-beta":[...i??[],"skills-2025-10-02"].toString()},o?.headers])})}list(e,t={},o){let{betas:r,...i}=t??{};return this._client.getAPIList(We`/v1/skills/${e}/versions?beta=true`,pa,{query:i,...o,headers:re([{"anthropic-beta":[...r??[],"skills-2025-10-02"].toString()},o?.headers])})}delete(e,t,o){let{skill_id:r,betas:i}=t;return this._client.delete(We`/v1/skills/${r}/versions/${e}?beta=true`,{...o,headers:re([{"anthropic-beta":[...i??[],"skills-2025-10-02"].toString()},o?.headers])})}};var ti=class extends Qe{constructor(){super(...arguments),this.versions=new ka(this._client)}create(e={},t){let{betas:o,...r}=e??{};return this._client.post("/v1/skills?beta=true",ma({body:r,...t,headers:re([{"anthropic-beta":[...o??[],"skills-2025-10-02"].toString()},t?.headers])},this._client))}retrieve(e,t={},o){let{betas:r}=t??{};return this._client.get(We`/v1/skills/${e}?beta=true`,{...o,headers:re([{"anthropic-beta":[...r??[],"skills-2025-10-02"].toString()},o?.headers])})}list(e={},t){let{betas:o,...r}=e??{};return this._client.getAPIList("/v1/skills?beta=true",pa,{query:r,...t,headers:re([{"anthropic-beta":[...o??[],"skills-2025-10-02"].toString()},t?.headers])})}delete(e,t={},o){let{betas:r}=t??{};return this._client.delete(We`/v1/skills/${e}?beta=true`,{...o,headers:re([{"anthropic-beta":[...r??[],"skills-2025-10-02"].toString()},o?.headers])})}};ti.Versions=ka;var jn=class extends Qe{constructor(){super(...arguments),this.models=new ha(this._client),this.messages=new fr(this._client),this.files=new fa(this._client),this.skills=new ti(this._client)}};jn.Models=ha;jn.Messages=fr;jn.Files=fa;jn.Skills=ti;var ni=class extends Qe{create(e,t){let{betas:o,...r}=e;return this._client.post("/v1/complete",{body:r,timeout:this._client._options.timeout??6e5,...t,headers:re([{...o?.toString()!=null?{"anthropic-beta":o?.toString()}:void 0},t?.headers]),stream:e.stream??!1})}};var On,hr,Ic,Gu,Ac,Pc,Vu,Mc,zo,Sc,Qu,Wu,_a,Ju,Xu,tf,Db,nf,of,rf,af,qb,Fb="__json_buf";function Bb(n){return n.type==="tool_use"||n.type==="server_tool_use"}var Yu=class n{constructor(){On.add(this),this.messages=[],this.receivedMessages=[],hr.set(this,void 0),this.controller=new AbortController,Ic.set(this,void 0),Gu.set(this,()=>{}),Ac.set(this,()=>{}),Pc.set(this,void 0),Vu.set(this,()=>{}),Mc.set(this,()=>{}),zo.set(this,{}),Sc.set(this,!1),Qu.set(this,!1),Wu.set(this,!1),_a.set(this,!1),Ju.set(this,void 0),Xu.set(this,void 0),nf.set(this,e=>{if(Z(this,Qu,!0,"f"),Eo(e)&&(e=new Lt),e instanceof Lt)return Z(this,Wu,!0,"f"),this._emit("abort",e);if(e instanceof Y)return this._emit("error",e);if(e instanceof Error){let t=new Y(e.message);return t.cause=e,this._emit("error",t)}return this._emit("error",new Y(String(e)))}),Z(this,Ic,new Promise((e,t)=>{Z(this,Gu,e,"f"),Z(this,Ac,t,"f")}),"f"),Z(this,Pc,new Promise((e,t)=>{Z(this,Vu,e,"f"),Z(this,Mc,t,"f")}),"f"),P(this,Ic,"f").catch(()=>{}),P(this,Pc,"f").catch(()=>{})}get response(){return P(this,Ju,"f")}get request_id(){return P(this,Xu,"f")}async withResponse(){let e=await P(this,Ic,"f");if(!e)throw new Error("Could not resolve a `Response` object");return{data:this,response:e,request_id:e.headers.get("request-id")}}static fromReadableStream(e){let t=new n;return t._run(()=>t._fromReadableStream(e)),t}static createMessage(e,t,o){let r=new n;for(let i of t.messages)r._addMessageParam(i);return r._run(()=>r._createMessage(e,{...t,stream:!0},{...o,headers:{...o?.headers,"X-Stainless-Helper-Method":"stream"}})),r}_run(e){e().then(()=>{this._emitFinal(),this._emit("end")},P(this,nf,"f"))}_addMessageParam(e){this.messages.push(e)}_addMessage(e,t=!0){this.receivedMessages.push(e),t&&this._emit("message",e)}async _createMessage(e,t,o){let r=o?.signal,i;r&&(r.aborted&&this.controller.abort(),i=this.controller.abort.bind(this.controller),r.addEventListener("abort",i));try{P(this,On,"m",of).call(this);let{response:a,data:s}=await e.create({...t,stream:!0},{...o,signal:this.controller.signal}).withResponse();this._connected(a);for await(let c of s)P(this,On,"m",rf).call(this,c);if(s.controller.signal?.aborted)throw new Lt;P(this,On,"m",af).call(this)}finally{r&&i&&r.removeEventListener("abort",i)}}_connected(e){this.ended||(Z(this,Ju,e,"f"),Z(this,Xu,e?.headers.get("request-id"),"f"),P(this,Gu,"f").call(this,e),this._emit("connect"))}get ended(){return P(this,Sc,"f")}get errored(){return P(this,Qu,"f")}get aborted(){return P(this,Wu,"f")}abort(){this.controller.abort()}on(e,t){return(P(this,zo,"f")[e]||(P(this,zo,"f")[e]=[])).push({listener:t}),this}off(e,t){let o=P(this,zo,"f")[e];if(!o)return this;let r=o.findIndex(i=>i.listener===t);return r>=0&&o.splice(r,1),this}once(e,t){return(P(this,zo,"f")[e]||(P(this,zo,"f")[e]=[])).push({listener:t,once:!0}),this}emitted(e){return new Promise((t,o)=>{Z(this,_a,!0,"f"),e!=="error"&&this.once("error",o),this.once(e,t)})}async done(){Z(this,_a,!0,"f"),await P(this,Pc,"f")}get currentMessage(){return P(this,hr,"f")}async finalMessage(){return await this.done(),P(this,On,"m",tf).call(this)}async finalText(){return await this.done(),P(this,On,"m",Db).call(this)}_emit(e,...t){if(P(this,Sc,"f"))return;e==="end"&&(Z(this,Sc,!0,"f"),P(this,Vu,"f").call(this));let o=P(this,zo,"f")[e];if(o&&(P(this,zo,"f")[e]=o.filter(r=>!r.once),o.forEach(({listener:r})=>r(...t))),e==="abort"){let r=t[0];!P(this,_a,"f")&&!o?.length&&Promise.reject(r),P(this,Ac,"f").call(this,r),P(this,Mc,"f").call(this,r),this._emit("end");return}if(e==="error"){let r=t[0];!P(this,_a,"f")&&!o?.length&&Promise.reject(r),P(this,Ac,"f").call(this,r),P(this,Mc,"f").call(this,r),this._emit("end")}}_emitFinal(){this.receivedMessages.at(-1)&&this._emit("finalMessage",P(this,On,"m",tf).call(this))}async _fromReadableStream(e,t){let o=t?.signal,r;o&&(o.aborted&&this.controller.abort(),r=this.controller.abort.bind(this.controller),o.addEventListener("abort",r));try{P(this,On,"m",of).call(this),this._connected(null);let i=so.fromReadableStream(e,this.controller);for await(let a of i)P(this,On,"m",rf).call(this,a);if(i.controller.signal?.aborted)throw new Lt;P(this,On,"m",af).call(this)}finally{o&&r&&o.removeEventListener("abort",r)}}[(hr=new WeakMap,Ic=new WeakMap,Gu=new WeakMap,Ac=new WeakMap,Pc=new WeakMap,Vu=new WeakMap,Mc=new WeakMap,zo=new WeakMap,Sc=new WeakMap,Qu=new WeakMap,Wu=new WeakMap,_a=new WeakMap,Ju=new WeakMap,Xu=new WeakMap,nf=new WeakMap,On=new WeakSet,tf=function(){if(this.receivedMessages.length===0)throw new Y("stream ended without producing a Message with role=assistant");return this.receivedMessages.at(-1)},Db=function(){if(this.receivedMessages.length===0)throw new Y("stream ended without producing a Message with role=assistant");let t=this.receivedMessages.at(-1).content.filter(o=>o.type==="text").map(o=>o.text);if(t.length===0)throw new Y("stream ended without producing a content block with type=text");return t.join(" ")},of=function(){this.ended||Z(this,hr,void 0,"f")},rf=function(t){if(this.ended)return;let o=P(this,On,"m",qb).call(this,t);switch(this._emit("streamEvent",t,o),t.type){case"content_block_delta":{let r=o.content.at(-1);switch(t.delta.type){case"text_delta":{r.type==="text"&&this._emit("text",t.delta.text,r.text||"");break}case"citations_delta":{r.type==="text"&&this._emit("citation",t.delta.citation,r.citations??[]);break}case"input_json_delta":{Bb(r)&&r.input&&this._emit("inputJson",t.delta.partial_json,r.input);break}case"thinking_delta":{r.type==="thinking"&&this._emit("thinking",t.delta.thinking,r.thinking);break}case"signature_delta":{r.type==="thinking"&&this._emit("signature",r.signature);break}default:t.delta}break}case"message_stop":{this._addMessageParam(o),this._addMessage(o,!0);break}case"content_block_stop":{this._emit("contentBlock",o.content.at(-1));break}case"message_start":{Z(this,hr,o,"f");break}case"content_block_start":case"message_delta":break}},af=function(){if(this.ended)throw new Y("stream has ended, this shouldn't happen");let t=P(this,hr,"f");if(!t)throw new Y("request ended without sending any chunks");return Z(this,hr,void 0,"f"),t},qb=function(t){let o=P(this,hr,"f");if(t.type==="message_start"){if(o)throw new Y(`Unexpected event order, got ${t.type} before receiving "message_stop"`);return t.message}if(!o)throw new Y(`Unexpected event order, got ${t.type} before "message_start"`);switch(t.type){case"message_stop":return o;case"message_delta":return o.stop_reason=t.delta.stop_reason,o.stop_sequence=t.delta.stop_sequence,o.usage.output_tokens=t.usage.output_tokens,t.usage.input_tokens!=null&&(o.usage.input_tokens=t.usage.input_tokens),t.usage.cache_creation_input_tokens!=null&&(o.usage.cache_creation_input_tokens=t.usage.cache_creation_input_tokens),t.usage.cache_read_input_tokens!=null&&(o.usage.cache_read_input_tokens=t.usage.cache_read_input_tokens),t.usage.server_tool_use!=null&&(o.usage.server_tool_use=t.usage.server_tool_use),o;case"content_block_start":return o.content.push({...t.content_block}),o;case"content_block_delta":{let r=o.content.at(t.index);switch(t.delta.type){case"text_delta":{r?.type==="text"&&(o.content[t.index]={...r,text:(r.text||"")+t.delta.text});break}case"citations_delta":{r?.type==="text"&&(o.content[t.index]={...r,citations:[...r.citations??[],t.delta.citation]});break}case"input_json_delta":{if(r&&Bb(r)){let i=r[Fb]||"";i+=t.delta.partial_json;let a={...r};Object.defineProperty(a,Fb,{value:i,enumerable:!1,writable:!0}),i&&(a.input=Nu(i)),o.content[t.index]=a}break}case"thinking_delta":{r?.type==="thinking"&&(o.content[t.index]={...r,thinking:r.thinking+t.delta.thinking});break}case"signature_delta":{r?.type==="thinking"&&(o.content[t.index]={...r,signature:t.delta.signature});break}default:t.delta}return o}case"content_block_stop":return o}},Symbol.asyncIterator)](){let e=[],t=[],o=!1;return this.on("streamEvent",r=>{let i=t.shift();i?i.resolve(r):e.push(r)}),this.on("end",()=>{o=!0;for(let r of t)r.resolve(void 0);t.length=0}),this.on("abort",r=>{o=!0;for(let i of t)i.reject(r);t.length=0}),this.on("error",r=>{o=!0;for(let i of t)i.reject(r);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:o?{value:void 0,done:!0}:new Promise((i,a)=>t.push({resolve:i,reject:a})).then(i=>i?{value:i,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}toReadableStream(){return new so(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}};var Ca=class extends Qe{create(e,t){return this._client.post("/v1/messages/batches",{body:e,...t})}retrieve(e,t){return this._client.get(We`/v1/messages/batches/${e}`,t)}list(e={},t){return this._client.getAPIList("/v1/messages/batches",En,{query:e,...t})}delete(e,t){return this._client.delete(We`/v1/messages/batches/${e}`,t)}cancel(e,t){return this._client.post(We`/v1/messages/batches/${e}/cancel`,t)}async results(e,t){let o=await this.retrieve(e);if(!o.results_url)throw new Y(`No batch \`results_url\`; Has it finished processing? ${o.processing_status} - ${o.id}`);return this._client.get(o.results_url,{...t,headers:re([{Accept:"application/binary"},t?.headers]),stream:!0,__binaryResponse:!0})._thenUnwrap((r,i)=>ga.fromResponse(i.response,i.controller))}};var gr=class extends Qe{constructor(){super(...arguments),this.batches=new Ca(this._client)}create(e,t){e.model in Ub&&console.warn(`The model '${e.model}' is deprecated and will reach end-of-life on ${Ub[e.model]}
Please migrate to a newer model. Visit https://docs.anthropic.com/en/docs/resources/model-deprecations for more information.`);let o=this._client._options.timeout;if(!e.stream&&o==null){let r=Hu[e.model]??void 0;o=this._client.calculateNonstreamingTimeout(e.max_tokens,r)}return this._client.post("/v1/messages",{body:e,timeout:o??6e5,...t,stream:e.stream??!1})}stream(e,t){return Yu.createMessage(this,e,t)}countTokens(e,t){return this._client.post("/v1/messages/count_tokens",{body:e,...t})}},Ub={"claude-1.3":"November 6th, 2024","claude-1.3-100k":"November 6th, 2024","claude-instant-1.1":"November 6th, 2024","claude-instant-1.1-100k":"November 6th, 2024","claude-instant-1.2":"November 6th, 2024","claude-3-sonnet-20240229":"July 21st, 2025","claude-3-opus-20240229":"January 5th, 2026","claude-2.1":"July 21st, 2025","claude-2.0":"July 21st, 2025","claude-3-5-sonnet-20241022":"October 22, 2025","claude-3-5-sonnet-20240620":"October 22, 2025"};gr.Batches=Ca;var oi=class extends Qe{retrieve(e,t={},o){let{betas:r}=t??{};return this._client.get(We`/v1/models/${e}`,{...o,headers:re([{...r?.toString()!=null?{"anthropic-beta":r?.toString()}:void 0},o?.headers])})}list(e={},t){let{betas:o,...r}=e??{};return this._client.getAPIList("/v1/models",En,{query:r,...t,headers:re([{...o?.toString()!=null?{"anthropic-beta":o?.toString()}:void 0},t?.headers])})}};var $c=n=>{if(typeof globalThis.process<"u")return globalThis.process.env?.[n]?.trim()??void 0;if(typeof globalThis.Deno<"u")return globalThis.Deno.env?.get?.(n)?.trim()};var sf,cf,ed,jb,Kb="\\n\\nHuman:",Hb="\\n\\nAssistant:",tt=class{constructor({baseURL:e=$c("ANTHROPIC_BASE_URL"),apiKey:t=$c("ANTHROPIC_API_KEY")??null,authToken:o=$c("ANTHROPIC_AUTH_TOKEN")??null,...r}={}){sf.add(this),ed.set(this,void 0);let i={apiKey:t,authToken:o,...r,baseURL:e||"https://api.anthropic.com"};if(!i.dangerouslyAllowBrowser&&vb())throw new Y(`It looks like you're running in a browser-like environment.

This is disabled by default, as it risks exposing your secret API credentials to attackers.
If you understand the risks and have appropriate mitigations in place,
you can set the \`dangerouslyAllowBrowser\` option to \`true\`, e.g.,

new Anthropic({ apiKey, dangerouslyAllowBrowser: true });
`);this.baseURL=i.baseURL,this.timeout=i.timeout??cf.DEFAULT_TIMEOUT,this.logger=i.logger??console;let a="warn";this.logLevel=a,this.logLevel=jm(i.logLevel,"ClientOptions.logLevel",this)??jm($c("ANTHROPIC_LOG"),"process.env['ANTHROPIC_LOG']",this)??a,this.fetchOptions=i.fetchOptions,this.maxRetries=i.maxRetries??2,this.fetch=i.fetch??xb(),Z(this,ed,wb,"f"),this._options=i,this.apiKey=t,this.authToken=o}withOptions(e){return new this.constructor({...this._options,baseURL:this.baseURL,maxRetries:this.maxRetries,timeout:this.timeout,logger:this.logger,logLevel:this.logLevel,fetch:this.fetch,fetchOptions:this.fetchOptions,apiKey:this.apiKey,authToken:this.authToken,...e})}defaultQuery(){return this._options.defaultQuery}validateHeaders({values:e,nulls:t}){if(!(this.apiKey&&e.get("x-api-key"))&&!t.has("x-api-key")&&!(this.authToken&&e.get("authorization"))&&!t.has("authorization"))throw new Error('Could not resolve authentication method. Expected either apiKey or authToken to be set. Or for one of the "X-Api-Key" or "Authorization" headers to be explicitly omitted')}async authHeaders(e){return re([await this.apiKeyAuth(e),await this.bearerAuth(e)])}async apiKeyAuth(e){if(this.apiKey!=null)return re([{"X-Api-Key":this.apiKey}])}async bearerAuth(e){if(this.authToken!=null)return re([{Authorization:`Bearer ${this.authToken}`}])}stringifyQuery(e){return Object.entries(e).filter(([t,o])=>typeof o<"u").map(([t,o])=>{if(typeof o=="string"||typeof o=="number"||typeof o=="boolean")return`${encodeURIComponent(t)}=${encodeURIComponent(o)}`;if(o===null)return`${encodeURIComponent(t)}=`;throw new Y(`Cannot stringify type ${typeof o}; Expected string, number, boolean, or null. If you need to pass nested query parameters, you can manually encode them, e.g. { query: { 'foo[key1]': value1, 'foo[key2]': value2 } }, and please open a GitHub issue requesting better support for your use case.`)}).join("&")}getUserAgent(){return`${this.constructor.name}/JS ${dr}`}defaultIdempotencyKey(){return`stainless-node-retry-${Dm()}`}makeStatusError(e,t,o,r){return At.generate(e,t,o,r)}buildURL(e,t,o){let r=!P(this,sf,"m",jb).call(this)&&o||this.baseURL,i=lb(e)?new URL(e):new URL(r+(r.endsWith("/")&&e.startsWith("/")?e.slice(1):e)),a=this.defaultQuery();return ub(a)||(t={...a,...t}),typeof t=="object"&&t&&!Array.isArray(t)&&(i.search=this.stringifyQuery(t)),i.toString()}_calculateNonstreamingTimeout(e){if(3600*e/128e3>600)throw new Y("Streaming is required for operations that may take longer than 10 minutes. See https://github.com/anthropics/anthropic-sdk-typescript#streaming-responses for more details");return 600*1e3}async prepareOptions(e){}async prepareRequest(e,{url:t,options:o}){}get(e,t){return this.methodRequest("get",e,t)}post(e,t){return this.methodRequest("post",e,t)}patch(e,t){return this.methodRequest("patch",e,t)}put(e,t){return this.methodRequest("put",e,t)}delete(e,t){return this.methodRequest("delete",e,t)}methodRequest(e,t,o){return this.request(Promise.resolve(o).then(r=>({method:e,path:t,...r})))}request(e,t=null){return new Xr(this,this.makeRequest(e,t,void 0))}async makeRequest(e,t,o){let r=await e,i=r.maxRetries??this.maxRetries;t==null&&(t=i),await this.prepareOptions(r);let{req:a,url:s,timeout:c}=await this.buildRequest(r,{retryCount:i-t});await this.prepareRequest(a,{url:s,options:r});let l="log_"+(Math.random()*(1<<24)|0).toString(16).padStart(6,"0"),d=o===void 0?"":`, retryOf: ${o}`,p=Date.now();if(Pt(this).debug(`[${l}] sending request`,Oo({retryOfRequestLogID:o,method:r.method,url:s,options:r,headers:a.headers})),r.signal?.aborted)throw new Lt;let f=new AbortController,m=await this.fetchWithTimeout(s,a,c,f).catch(dc),h=Date.now();if(m instanceof globalThis.Error){let k=`retrying, ${t} attempts remaining`;if(r.signal?.aborted)throw new Lt;let x=Eo(m)||/timed? ?out/i.test(String(m)+("cause"in m?String(m.cause):""));if(t)return Pt(this).info(`[${l}] connection ${x?"timed out":"failed"} - ${k}`),Pt(this).debug(`[${l}] connection ${x?"timed out":"failed"} (${k})`,Oo({retryOfRequestLogID:o,url:s,durationMs:h-p,message:m.message})),this.retryRequest(r,t,o??l);throw Pt(this).info(`[${l}] connection ${x?"timed out":"failed"} - error; no more retries left`),Pt(this).debug(`[${l}] connection ${x?"timed out":"failed"} (error; no more retries left)`,Oo({retryOfRequestLogID:o,url:s,durationMs:h-p,message:m.message})),x?new oa:new ur({cause:m})}let g=[...m.headers.entries()].filter(([k])=>k==="request-id").map(([k,x])=>", "+k+": "+JSON.stringify(x)).join(""),v=`[${l}${d}${g}] ${a.method} ${s} ${m.ok?"succeeded":"failed"} with status ${m.status} in ${h-p}ms`;if(!m.ok){let k=await this.shouldRetry(m);if(t&&k){let I=`retrying, ${t} attempts remaining`;return await bb(m.body),Pt(this).info(`${v} - ${I}`),Pt(this).debug(`[${l}] response error (${I})`,Oo({retryOfRequestLogID:o,url:m.url,status:m.status,headers:m.headers,durationMs:h-p})),this.retryRequest(r,t,o??l,m.headers)}let x=k?"error; no more retries left":"error; not retryable";Pt(this).info(`${v} - ${x}`);let y=await m.text().catch(I=>dc(I).message),w=Pu(y),b=w?void 0:y;throw Pt(this).debug(`[${l}] response error (${x})`,Oo({retryOfRequestLogID:o,url:m.url,status:m.status,headers:m.headers,message:b,durationMs:Date.now()-p})),this.makeStatusError(m.status,w,b,m.headers)}return Pt(this).info(v),Pt(this).debug(`[${l}] response start`,Oo({retryOfRequestLogID:o,url:m.url,status:m.status,headers:m.headers,durationMs:h-p})),{response:m,options:r,controller:f,requestLogID:l,retryOfRequestLogID:o,startTime:p}}getAPIList(e,t,o){return this.requestAPIList(t,{method:"get",path:e,...o})}requestAPIList(e,t){let o=this.makeRequest(t,null,void 0);return new vc(this,o,e)}async fetchWithTimeout(e,t,o,r){let{signal:i,method:a,...s}=t||{};i&&i.addEventListener("abort",()=>r.abort());let c=setTimeout(()=>r.abort(),o),l=globalThis.ReadableStream&&s.body instanceof globalThis.ReadableStream||typeof s.body=="object"&&s.body!==null&&Symbol.asyncIterator in s.body,d={signal:r.signal,...l?{duplex:"half"}:{},method:"GET",...s};a&&(d.method=a.toUpperCase());try{return await this.fetch.call(void 0,e,d)}finally{clearTimeout(c)}}async shouldRetry(e){let t=e.headers.get("x-should-retry");return t==="true"?!0:t==="false"?!1:e.status===408||e.status===409||e.status===429||e.status>=500}async retryRequest(e,t,o,r){let i,a=r?.get("retry-after-ms");if(a){let c=parseFloat(a);Number.isNaN(c)||(i=c)}let s=r?.get("retry-after");if(s&&!i){let c=parseFloat(s);Number.isNaN(c)?i=Date.parse(s)-Date.now():i=c*1e3}if(!(i&&0<=i&&i<60*1e3)){let c=e.maxRetries??this.maxRetries;i=this.calculateDefaultRetryTimeoutMillis(t,c)}return await mb(i),this.makeRequest(e,t-1,o)}calculateDefaultRetryTimeoutMillis(e,t){let i=t-e,a=Math.min(.5*Math.pow(2,i),8),s=1-Math.random()*.25;return a*s*1e3}calculateNonstreamingTimeout(e,t){if(36e5*e/128e3>6e5||t!=null&&e>t)throw new Y("Streaming is required for operations that may take longer than 10 minutes. See https://github.com/anthropics/anthropic-sdk-typescript#long-requests for more details");return 6e5}async buildRequest(e,{retryCount:t=0}={}){let o={...e},{method:r,path:i,query:a,defaultBaseURL:s}=o,c=this.buildURL(i,a,s);"timeout"in o&&pb("timeout",o.timeout),o.timeout=o.timeout??this.timeout;let{bodyHeaders:l,body:d}=this.buildBody({options:o}),p=await this.buildHeaders({options:e,method:r,bodyHeaders:l,retryCount:t});return{req:{method:r,headers:p,...o.signal&&{signal:o.signal},...globalThis.ReadableStream&&d instanceof globalThis.ReadableStream&&{duplex:"half"},...d&&{body:d},...this.fetchOptions??{},...o.fetchOptions??{}},url:c,timeout:o.timeout}}async buildHeaders({options:e,method:t,bodyHeaders:o,retryCount:r}){let i={};this.idempotencyHeader&&t!=="get"&&(e.idempotencyKey||(e.idempotencyKey=this.defaultIdempotencyKey()),i[this.idempotencyHeader]=e.idempotencyKey);let a=re([i,{Accept:"application/json","User-Agent":this.getUserAgent(),"X-Stainless-Retry-Count":String(r),...e.timeout?{"X-Stainless-Timeout":String(Math.trunc(e.timeout/1e3))}:{},...yb(),...this._options.dangerouslyAllowBrowser?{"anthropic-dangerous-direct-browser-access":"true"}:void 0,"anthropic-version":"2023-06-01"},await this.authHeaders(e),this._options.defaultHeaders,o,e.headers]);return this.validateHeaders(a),a.values}buildBody({options:{body:e,headers:t}}){if(!e)return{bodyHeaders:void 0,body:void 0};let o=re([t]);return ArrayBuffer.isView(e)||e instanceof ArrayBuffer||e instanceof DataView||typeof e=="string"&&o.values.has("content-type")||globalThis.Blob&&e instanceof globalThis.Blob||e instanceof FormData||e instanceof URLSearchParams||globalThis.ReadableStream&&e instanceof globalThis.ReadableStream?{bodyHeaders:void 0,body:e}:typeof e=="object"&&(Symbol.asyncIterator in e||Symbol.iterator in e&&"next"in e&&typeof e.next=="function")?{bodyHeaders:void 0,body:Mu(e)}:P(this,ed,"f").call(this,{body:e,headers:o})}};cf=tt,ed=new WeakMap,sf=new WeakSet,jb=function(){return this.baseURL!=="https://api.anthropic.com"};tt.Anthropic=cf;tt.HUMAN_PROMPT=Kb;tt.AI_PROMPT=Hb;tt.DEFAULT_TIMEOUT=6e5;tt.AnthropicError=Y;tt.APIError=At;tt.APIConnectionError=ur;tt.APIConnectionTimeoutError=oa;tt.APIUserAbortError=Lt;tt.NotFoundError=sa;tt.ConflictError=ca;tt.RateLimitError=ua;tt.BadRequestError=ra;tt.AuthenticationError=ia;tt.InternalServerError=da;tt.PermissionDeniedError=aa;tt.UnprocessableEntityError=la;tt.toFile=Lu;var co=class extends tt{constructor(){super(...arguments),this.completions=new ni(this),this.messages=new gr(this),this.models=new oi(this),this.beta=new jn(this)}};co.Completions=ni;co.Messages=gr;co.Models=oi;co.Beta=jn;var un=D(require("vscode"));Ke();ot();ce();var Zb=D(require("vscode")),Nt=class n{static _version=null;static getVersion(){if(n._version===null){let e=Zb.extensions.getExtension("vicanent.copilot-helper-pro");n._version=e?.packageJSON?.version||"0.4.0"}return n._version}static getUserAgent(e){return`CHP-${e}/${n.getVersion()}`}static getClientInfo(){return{name:"Copilot ++",version:n.getVersion()}}static resetCache(){n._version=null}};function W(n,e,t,o,r){if(o==="m")throw new TypeError("Private method is not writable");if(o==="a"&&!r)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?n!==e||!r:!e.has(n))throw new TypeError("Cannot write private member to an object whose class did not declare it");return o==="a"?r.call(n,t):r?r.value=t:e.set(n,t),t}function T(n,e,t,o){if(t==="a"&&!o)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?n!==e||!o:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?o:t==="a"?o.call(n):o?o.value:e.get(n)}var lf=function(){let{crypto:n}=globalThis;if(n?.randomUUID)return lf=n.randomUUID.bind(n),n.randomUUID();let e=new Uint8Array(1),t=n?()=>n.getRandomValues(e)[0]:()=>Math.random()*255&255;return"10000000-1000-4000-8000-100000000000".replace(/[018]/g,o=>(+o^t()&15>>+o/4).toString(16))};function Ec(n){return typeof n=="object"&&n!==null&&("name"in n&&n.name==="AbortError"||"message"in n&&String(n.message).includes("FetchRequestCanceledException"))}var Rc=n=>{if(n instanceof Error)return n;if(typeof n=="object"&&n!==null){try{if(Object.prototype.toString.call(n)==="[object Error]"){let e=new Error(n.message,n.cause?{cause:n.cause}:{});return n.stack&&(e.stack=n.stack),n.cause&&!e.cause&&(e.cause=n.cause),n.name&&(e.name=n.name),e}}catch{}try{return new Error(JSON.stringify(n))}catch{}}return new Error(n)};var H=class extends Error{},bt=class n extends H{constructor(e,t,o,r){super(`${n.makeMessage(e,t,o)}`),this.status=e,this.headers=r,this.requestID=r?.get("x-request-id"),this.error=t;let i=t;this.code=i?.code,this.param=i?.param,this.type=i?.type}static makeMessage(e,t,o){let r=t?.message?typeof t.message=="string"?t.message:JSON.stringify(t.message):t?JSON.stringify(t):o;return e&&r?`${e} ${r}`:e?`${e} status code (no body)`:r||"(no status code or body)"}static generate(e,t,o,r){if(!e||!r)return new vr({message:o,cause:Rc(t)});let i=t?.error;return e===400?new Ta(e,i,o,r):e===401?new Ia(e,i,o,r):e===403?new Aa(e,i,o,r):e===404?new Pa(e,i,o,r):e===409?new Ma(e,i,o,r):e===422?new Sa(e,i,o,r):e===429?new $a(e,i,o,r):e>=500?new Ea(e,i,o,r):new n(e,i,o,r)}},dt=class extends bt{constructor({message:e}={}){super(void 0,void 0,e||"Request was aborted.",void 0)}},vr=class extends bt{constructor({message:e,cause:t}){super(void 0,void 0,e||"Connection error.",void 0),t&&(this.cause=t)}},yr=class extends vr{constructor({message:e}={}){super({message:e??"Request timed out."})}},Ta=class extends bt{},Ia=class extends bt{},Aa=class extends bt{},Pa=class extends bt{},Ma=class extends bt{},Sa=class extends bt{},$a=class extends bt{},Ea=class extends bt{},Ra=class extends H{constructor(){super("Could not parse response content as the length limit was reached")}},Oa=class extends H{constructor(){super("Could not parse response content as the request was rejected by the content filter")}},lo=class extends Error{constructor(e){super(e)}};var iS=/^[a-z][a-z0-9+.-]*:/i,Gb=n=>iS.test(n),Zt=n=>(Zt=Array.isArray,Zt(n)),uf=Zt;function df(n){return typeof n!="object"?{}:n??{}}function Vb(n){if(!n)return!0;for(let e in n)return!1;return!0}function Qb(n,e){return Object.prototype.hasOwnProperty.call(n,e)}function Oc(n){return n!=null&&typeof n=="object"&&!Array.isArray(n)}var Wb=(n,e)=>{if(typeof e!="number"||!Number.isInteger(e))throw new H(`${n} must be an integer`);if(e<0)throw new H(`${n} must be a positive integer`);return e};var Jb=n=>{try{return JSON.parse(n)}catch{return}};var uo=n=>new Promise(e=>setTimeout(e,n));var xr="6.15.0";var tw=()=>typeof window<"u"&&typeof window.document<"u"&&typeof navigator<"u";function aS(){return typeof Deno<"u"&&Deno.build!=null?"deno":typeof EdgeRuntime<"u"?"edge":Object.prototype.toString.call(typeof globalThis.process<"u"?globalThis.process:0)==="[object process]"?"node":"unknown"}var sS=()=>{let n=aS();if(n==="deno")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":xr,"X-Stainless-OS":Yb(Deno.build.os),"X-Stainless-Arch":Xb(Deno.build.arch),"X-Stainless-Runtime":"deno","X-Stainless-Runtime-Version":typeof Deno.version=="string"?Deno.version:Deno.version?.deno??"unknown"};if(typeof EdgeRuntime<"u")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":xr,"X-Stainless-OS":"Unknown","X-Stainless-Arch":`other:${EdgeRuntime}`,"X-Stainless-Runtime":"edge","X-Stainless-Runtime-Version":globalThis.process.version};if(n==="node")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":xr,"X-Stainless-OS":Yb(globalThis.process.platform??"unknown"),"X-Stainless-Arch":Xb(globalThis.process.arch??"unknown"),"X-Stainless-Runtime":"node","X-Stainless-Runtime-Version":globalThis.process.version??"unknown"};let e=cS();return e?{"X-Stainless-Lang":"js","X-Stainless-Package-Version":xr,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":`browser:${e.browser}`,"X-Stainless-Runtime-Version":e.version}:{"X-Stainless-Lang":"js","X-Stainless-Package-Version":xr,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":"unknown","X-Stainless-Runtime-Version":"unknown"}};function cS(){if(typeof navigator>"u"||!navigator)return null;let n=[{key:"edge",pattern:/Edge(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/MSIE(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/Trident(?:.*rv\:(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"chrome",pattern:/Chrome(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"firefox",pattern:/Firefox(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"safari",pattern:/(?:Version\W+(\d+)\.(\d+)(?:\.(\d+))?)?(?:\W+Mobile\S*)?\W+Safari/}];for(let{key:e,pattern:t}of n){let o=t.exec(navigator.userAgent);if(o){let r=o[1]||0,i=o[2]||0,a=o[3]||0;return{browser:e,version:`${r}.${i}.${a}`}}}return null}var Xb=n=>n==="x32"?"x32":n==="x86_64"||n==="x64"?"x64":n==="arm"?"arm":n==="aarch64"||n==="arm64"?"arm64":n?`other:${n}`:"unknown",Yb=n=>(n=n.toLowerCase(),n.includes("ios")?"iOS":n==="android"?"Android":n==="darwin"?"MacOS":n==="win32"?"Windows":n==="freebsd"?"FreeBSD":n==="openbsd"?"OpenBSD":n==="linux"?"Linux":n?`Other:${n}`:"Unknown"),ew,nw=()=>ew??(ew=sS());function ow(){if(typeof fetch<"u")return fetch;throw new Error("`fetch` is not defined as a global; Either pass `fetch` to the client, `new OpenAI({ fetch })` or polyfill the global, `globalThis.fetch = fetch`")}function pf(...n){let e=globalThis.ReadableStream;if(typeof e>"u")throw new Error("`ReadableStream` is not defined as a global; You will need to polyfill it, `globalThis.ReadableStream = ReadableStream`");return new e(...n)}function td(n){let e=Symbol.asyncIterator in n?n[Symbol.asyncIterator]():n[Symbol.iterator]();return pf({start(){},async pull(t){let{done:o,value:r}=await e.next();o?t.close():t.enqueue(r)},async cancel(){await e.return?.()}})}function mf(n){if(n[Symbol.asyncIterator])return n;let e=n.getReader();return{async next(){try{let t=await e.read();return t?.done&&e.releaseLock(),t}catch(t){throw e.releaseLock(),t}},async return(){let t=e.cancel();return e.releaseLock(),await t,{done:!0,value:void 0}},[Symbol.asyncIterator](){return this}}}async function rw(n){if(n===null||typeof n!="object")return;if(n[Symbol.asyncIterator]){await n[Symbol.asyncIterator]().return?.();return}let e=n.getReader(),t=e.cancel();e.releaseLock(),await t}var iw=({headers:n,body:e})=>({bodyHeaders:{"content-type":"application/json"},body:JSON.stringify(e)});var nd="RFC3986",ff=n=>String(n),od={RFC1738:n=>String(n).replace(/%20/g,"+"),RFC3986:ff},hf="RFC1738";var rd=(n,e)=>(rd=Object.hasOwn??Function.prototype.call.bind(Object.prototype.hasOwnProperty),rd(n,e)),po=(()=>{let n=[];for(let e=0;e<256;++e)n.push("%"+((e<16?"0":"")+e.toString(16)).toUpperCase());return n})();var gf=1024,aw=(n,e,t,o,r)=>{if(n.length===0)return n;let i=n;if(typeof n=="symbol"?i=Symbol.prototype.toString.call(n):typeof n!="string"&&(i=String(n)),t==="iso-8859-1")return escape(i).replace(/%u[0-9a-f]{4}/gi,function(s){return"%26%23"+parseInt(s.slice(2),16)+"%3B"});let a="";for(let s=0;s<i.length;s+=gf){let c=i.length>=gf?i.slice(s,s+gf):i,l=[];for(let d=0;d<c.length;++d){let p=c.charCodeAt(d);if(p===45||p===46||p===95||p===126||p>=48&&p<=57||p>=65&&p<=90||p>=97&&p<=122||r===hf&&(p===40||p===41)){l[l.length]=c.charAt(d);continue}if(p<128){l[l.length]=po[p];continue}if(p<2048){l[l.length]=po[192|p>>6]+po[128|p&63];continue}if(p<55296||p>=57344){l[l.length]=po[224|p>>12]+po[128|p>>6&63]+po[128|p&63];continue}d+=1,p=65536+((p&1023)<<10|c.charCodeAt(d)&1023),l[l.length]=po[240|p>>18]+po[128|p>>12&63]+po[128|p>>6&63]+po[128|p&63]}a+=l.join("")}return a};function sw(n){return!n||typeof n!="object"?!1:!!(n.constructor&&n.constructor.isBuffer&&n.constructor.isBuffer(n))}function vf(n,e){if(Zt(n)){let t=[];for(let o=0;o<n.length;o+=1)t.push(e(n[o]));return t}return e(n)}var lw={brackets(n){return String(n)+"[]"},comma:"comma",indices(n,e){return String(n)+"["+e+"]"},repeat(n){return String(n)}},uw=function(n,e){Array.prototype.push.apply(n,Zt(e)?e:[e])},cw,wt={addQueryPrefix:!1,allowDots:!1,allowEmptyArrays:!1,arrayFormat:"indices",charset:"utf-8",charsetSentinel:!1,delimiter:"&",encode:!0,encodeDotInKeys:!1,encoder:aw,encodeValuesOnly:!1,format:nd,formatter:ff,indices:!1,serializeDate(n){return(cw??(cw=Function.prototype.call.bind(Date.prototype.toISOString)))(n)},skipNulls:!1,strictNullHandling:!1};function dS(n){return typeof n=="string"||typeof n=="number"||typeof n=="boolean"||typeof n=="symbol"||typeof n=="bigint"}var yf={};function dw(n,e,t,o,r,i,a,s,c,l,d,p,f,m,h,g,v,k){let x=n,y=k,w=0,b=!1;for(;(y=y.get(yf))!==void 0&&!b;){let A=y.get(n);if(w+=1,typeof A<"u"){if(A===w)throw new RangeError("Cyclic object value");b=!0}typeof y.get(yf)>"u"&&(w=0)}if(typeof l=="function"?x=l(e,x):x instanceof Date?x=f?.(x):t==="comma"&&Zt(x)&&(x=vf(x,function(A){return A instanceof Date?f?.(A):A})),x===null){if(i)return c&&!g?c(e,wt.encoder,v,"key",m):e;x=""}if(dS(x)||sw(x)){if(c){let A=g?e:c(e,wt.encoder,v,"key",m);return[h?.(A)+"="+h?.(c(x,wt.encoder,v,"value",m))]}return[h?.(e)+"="+h?.(String(x))]}let C=[];if(typeof x>"u")return C;let I;if(t==="comma"&&Zt(x))g&&c&&(x=vf(x,c)),I=[{value:x.length>0?x.join(",")||null:void 0}];else if(Zt(l))I=l;else{let A=Object.keys(x);I=d?A.sort(d):A}let $=s?String(e).replace(/\./g,"%2E"):String(e),M=o&&Zt(x)&&x.length===1?$+"[]":$;if(r&&Zt(x)&&x.length===0)return M+"[]";for(let A=0;A<I.length;++A){let z=I[A],F=typeof z=="object"&&typeof z.value<"u"?z.value:x[z];if(a&&F===null)continue;let q=p&&s?z.replace(/\./g,"%2E"):z,oe=Zt(x)?typeof t=="function"?t(M,q):M:M+(p?"."+q:"["+q+"]");k.set(n,w);let fe=new WeakMap;fe.set(yf,k),uw(C,dw(F,oe,t,o,r,i,a,s,t==="comma"&&g&&Zt(x)?null:c,l,d,p,f,m,h,g,v,fe))}return C}function pS(n=wt){if(typeof n.allowEmptyArrays<"u"&&typeof n.allowEmptyArrays!="boolean")throw new TypeError("`allowEmptyArrays` option can only be `true` or `false`, when provided");if(typeof n.encodeDotInKeys<"u"&&typeof n.encodeDotInKeys!="boolean")throw new TypeError("`encodeDotInKeys` option can only be `true` or `false`, when provided");if(n.encoder!==null&&typeof n.encoder<"u"&&typeof n.encoder!="function")throw new TypeError("Encoder has to be a function.");let e=n.charset||wt.charset;if(typeof n.charset<"u"&&n.charset!=="utf-8"&&n.charset!=="iso-8859-1")throw new TypeError("The charset option must be either utf-8, iso-8859-1, or undefined");let t=nd;if(typeof n.format<"u"){if(!rd(od,n.format))throw new TypeError("Unknown format option provided.");t=n.format}let o=od[t],r=wt.filter;(typeof n.filter=="function"||Zt(n.filter))&&(r=n.filter);let i;if(n.arrayFormat&&n.arrayFormat in lw?i=n.arrayFormat:"indices"in n?i=n.indices?"indices":"repeat":i=wt.arrayFormat,"commaRoundTrip"in n&&typeof n.commaRoundTrip!="boolean")throw new TypeError("`commaRoundTrip` must be a boolean, or absent");let a=typeof n.allowDots>"u"?n.encodeDotInKeys?!0:wt.allowDots:!!n.allowDots;return{addQueryPrefix:typeof n.addQueryPrefix=="boolean"?n.addQueryPrefix:wt.addQueryPrefix,allowDots:a,allowEmptyArrays:typeof n.allowEmptyArrays=="boolean"?!!n.allowEmptyArrays:wt.allowEmptyArrays,arrayFormat:i,charset:e,charsetSentinel:typeof n.charsetSentinel=="boolean"?n.charsetSentinel:wt.charsetSentinel,commaRoundTrip:!!n.commaRoundTrip,delimiter:typeof n.delimiter>"u"?wt.delimiter:n.delimiter,encode:typeof n.encode=="boolean"?n.encode:wt.encode,encodeDotInKeys:typeof n.encodeDotInKeys=="boolean"?n.encodeDotInKeys:wt.encodeDotInKeys,encoder:typeof n.encoder=="function"?n.encoder:wt.encoder,encodeValuesOnly:typeof n.encodeValuesOnly=="boolean"?n.encodeValuesOnly:wt.encodeValuesOnly,filter:r,format:t,formatter:o,serializeDate:typeof n.serializeDate=="function"?n.serializeDate:wt.serializeDate,skipNulls:typeof n.skipNulls=="boolean"?n.skipNulls:wt.skipNulls,sort:typeof n.sort=="function"?n.sort:null,strictNullHandling:typeof n.strictNullHandling=="boolean"?n.strictNullHandling:wt.strictNullHandling}}function xf(n,e={}){let t=n,o=pS(e),r,i;typeof o.filter=="function"?(i=o.filter,t=i("",t)):Zt(o.filter)&&(i=o.filter,r=i);let a=[];if(typeof t!="object"||t===null)return"";let s=lw[o.arrayFormat],c=s==="comma"&&o.commaRoundTrip;r||(r=Object.keys(t)),o.sort&&r.sort(o.sort);let l=new WeakMap;for(let f=0;f<r.length;++f){let m=r[f];o.skipNulls&&t[m]===null||uw(a,dw(t[m],m,s,c,o.allowEmptyArrays,o.strictNullHandling,o.skipNulls,o.encodeDotInKeys,o.encode?o.encoder:null,o.filter,o.sort,o.allowDots,o.serializeDate,o.format,o.formatter,o.encodeValuesOnly,o.charset,l))}let d=a.join(o.delimiter),p=o.addQueryPrefix===!0?"?":"";return o.charsetSentinel&&(o.charset==="iso-8859-1"?p+="utf8=%26%2310003%3B&":p+="utf8=%E2%9C%93&"),d.length>0?p+d:""}function fw(n){let e=0;for(let r of n)e+=r.length;let t=new Uint8Array(e),o=0;for(let r of n)t.set(r,o),o+=r.length;return t}var pw;function La(n){let e;return(pw??(e=new globalThis.TextEncoder,pw=e.encode.bind(e)))(n)}var mw;function bf(n){let e;return(mw??(e=new globalThis.TextDecoder,mw=e.decode.bind(e)))(n)}var Tn,In,ri=class{constructor(){Tn.set(this,void 0),In.set(this,void 0),W(this,Tn,new Uint8Array,"f"),W(this,In,null,"f")}decode(e){if(e==null)return[];let t=e instanceof ArrayBuffer?new Uint8Array(e):typeof e=="string"?La(e):e;W(this,Tn,fw([T(this,Tn,"f"),t]),"f");let o=[],r;for(;(r=fS(T(this,Tn,"f"),T(this,In,"f")))!=null;){if(r.carriage&&T(this,In,"f")==null){W(this,In,r.index,"f");continue}if(T(this,In,"f")!=null&&(r.index!==T(this,In,"f")+1||r.carriage)){o.push(bf(T(this,Tn,"f").subarray(0,T(this,In,"f")-1))),W(this,Tn,T(this,Tn,"f").subarray(T(this,In,"f")),"f"),W(this,In,null,"f");continue}let i=T(this,In,"f")!==null?r.preceding-1:r.preceding,a=bf(T(this,Tn,"f").subarray(0,i));o.push(a),W(this,Tn,T(this,Tn,"f").subarray(r.index),"f"),W(this,In,null,"f")}return o}flush(){return T(this,Tn,"f").length?this.decode(`
`):[]}};Tn=new WeakMap,In=new WeakMap;ri.NEWLINE_CHARS=new Set([`
`,"\r"]);ri.NEWLINE_REGEXP=/\r\n|[\n\r]/g;function fS(n,e){for(let r=e??0;r<n.length;r++){if(n[r]===10)return{preceding:r,index:r+1,carriage:!1};if(n[r]===13)return{preceding:r,index:r+1,carriage:!0}}return null}function hw(n){for(let o=0;o<n.length-1;o++){if(n[o]===10&&n[o+1]===10||n[o]===13&&n[o+1]===13)return o+2;if(n[o]===13&&n[o+1]===10&&o+3<n.length&&n[o+2]===13&&n[o+3]===10)return o+4}return-1}var ad={off:0,error:200,warn:300,info:400,debug:500},wf=(n,e,t)=>{if(n){if(Qb(ad,n))return n;at(t).warn(`${e} was set to ${JSON.stringify(n)}, expected one of ${JSON.stringify(Object.keys(ad))}`)}};function Lc(){}function id(n,e,t){return!e||ad[n]>ad[t]?Lc:e[n].bind(e)}var hS={error:Lc,warn:Lc,info:Lc,debug:Lc},gw=new WeakMap;function at(n){let e=n.logger,t=n.logLevel??"off";if(!e)return hS;let o=gw.get(e);if(o&&o[0]===t)return o[1];let r={error:id("error",e,t),warn:id("warn",e,t),info:id("info",e,t),debug:id("debug",e,t)};return gw.set(e,[t,r]),r}var Do=n=>(n.options&&(n.options={...n.options},delete n.options.headers),n.headers&&(n.headers=Object.fromEntries((n.headers instanceof Headers?[...n.headers]:Object.entries(n.headers)).map(([e,t])=>[e,e.toLowerCase()==="authorization"||e.toLowerCase()==="cookie"||e.toLowerCase()==="set-cookie"?"***":t]))),"retryOfRequestLogID"in n&&(n.retryOfRequestLogID&&(n.retryOf=n.retryOfRequestLogID),delete n.retryOfRequestLogID),n);var Nc,mo=class n{constructor(e,t,o){this.iterator=e,Nc.set(this,void 0),this.controller=t,W(this,Nc,o,"f")}static fromSSEResponse(e,t,o){let r=!1,i=o?at(o):console;async function*a(){if(r)throw new H("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");r=!0;let s=!1;try{for await(let c of gS(e,t))if(!s){if(c.data.startsWith("[DONE]")){s=!0;continue}if(c.event===null||!c.event.startsWith("thread.")){let l;try{l=JSON.parse(c.data)}catch(d){throw i.error("Could not parse message into JSON:",c.data),i.error("From chunk:",c.raw),d}if(l&&l.error)throw new bt(void 0,l.error,void 0,e.headers);yield l}else{let l;try{l=JSON.parse(c.data)}catch(d){throw console.error("Could not parse message into JSON:",c.data),console.error("From chunk:",c.raw),d}if(c.event=="error")throw new bt(void 0,l.error,l.message,void 0);yield{event:c.event,data:l}}}s=!0}catch(c){if(Ec(c))return;throw c}finally{s||t.abort()}}return new n(a,t,o)}static fromReadableStream(e,t,o){let r=!1;async function*i(){let s=new ri,c=mf(e);for await(let l of c)for(let d of s.decode(l))yield d;for(let l of s.flush())yield l}async function*a(){if(r)throw new H("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");r=!0;let s=!1;try{for await(let c of i())s||c&&(yield JSON.parse(c));s=!0}catch(c){if(Ec(c))return;throw c}finally{s||t.abort()}}return new n(a,t,o)}[(Nc=new WeakMap,Symbol.asyncIterator)](){return this.iterator()}tee(){let e=[],t=[],o=this.iterator(),r=i=>({next:()=>{if(i.length===0){let a=o.next();e.push(a),t.push(a)}return i.shift()}});return[new n(()=>r(e),this.controller,T(this,Nc,"f")),new n(()=>r(t),this.controller,T(this,Nc,"f"))]}toReadableStream(){let e=this,t;return pf({async start(){t=e[Symbol.asyncIterator]()},async pull(o){try{let{value:r,done:i}=await t.next();if(i)return o.close();let a=La(JSON.stringify(r)+`
`);o.enqueue(a)}catch(r){o.error(r)}},async cancel(){await t.return?.()}})}};async function*gS(n,e){if(!n.body)throw e.abort(),typeof globalThis.navigator<"u"&&globalThis.navigator.product==="ReactNative"?new H("The default react-native fetch implementation does not support streaming. Please use expo/fetch: https://docs.expo.dev/versions/latest/sdk/expo/#expofetch-api"):new H("Attempted to iterate over a response with no body");let t=new kf,o=new ri,r=mf(n.body);for await(let i of vS(r))for(let a of o.decode(i)){let s=t.decode(a);s&&(yield s)}for(let i of o.flush()){let a=t.decode(i);a&&(yield a)}}async function*vS(n){let e=new Uint8Array;for await(let t of n){if(t==null)continue;let o=t instanceof ArrayBuffer?new Uint8Array(t):typeof t=="string"?La(t):t,r=new Uint8Array(e.length+o.length);r.set(e),r.set(o,e.length),e=r;let i;for(;(i=hw(e))!==-1;)yield e.slice(0,i),e=e.slice(i)}e.length>0&&(yield e)}var kf=class{constructor(){this.event=null,this.data=[],this.chunks=[]}decode(e){if(e.endsWith("\r")&&(e=e.substring(0,e.length-1)),!e){if(!this.event&&!this.data.length)return null;let i={event:this.event,data:this.data.join(`
`),raw:this.chunks};return this.event=null,this.data=[],this.chunks=[],i}if(this.chunks.push(e),e.startsWith(":"))return null;let[t,o,r]=yS(e,":");return r.startsWith(" ")&&(r=r.substring(1)),t==="event"?this.event=r:t==="data"&&this.data.push(r),null}};function yS(n,e){let t=n.indexOf(e);return t!==-1?[n.substring(0,t),e,n.substring(t+e.length)]:[n,"",""]}async function sd(n,e){let{response:t,requestLogID:o,retryOfRequestLogID:r,startTime:i}=e,a=await(async()=>{if(e.options.stream)return at(n).debug("response",t.status,t.url,t.headers,t.body),e.options.__streamClass?e.options.__streamClass.fromSSEResponse(t,e.controller,n):mo.fromSSEResponse(t,e.controller,n);if(t.status===204)return null;if(e.options.__binaryResponse)return t;let c=t.headers.get("content-type")?.split(";")[0]?.trim();if(c?.includes("application/json")||c?.endsWith("+json")){let p=await t.json();return _f(p,t)}return await t.text()})();return at(n).debug(`[${o}] response parsed`,Do({retryOfRequestLogID:r,url:t.url,status:t.status,body:a,durationMs:Date.now()-i})),a}function _f(n,e){return!n||typeof n!="object"||Array.isArray(n)?n:Object.defineProperty(n,"_request_id",{value:e.headers.get("x-request-id"),enumerable:!1})}var zc,ii=class n extends Promise{constructor(e,t,o=sd){super(r=>{r(null)}),this.responsePromise=t,this.parseResponse=o,zc.set(this,void 0),W(this,zc,e,"f")}_thenUnwrap(e){return new n(T(this,zc,"f"),this.responsePromise,async(t,o)=>_f(e(await this.parseResponse(t,o),o),o.response))}asResponse(){return this.responsePromise.then(e=>e.response)}async withResponse(){let[e,t]=await Promise.all([this.parse(),this.asResponse()]);return{data:e,response:t,request_id:t.headers.get("x-request-id")}}parse(){return this.parsedPromise||(this.parsedPromise=this.responsePromise.then(e=>this.parseResponse(T(this,zc,"f"),e))),this.parsedPromise}then(e,t){return this.parse().then(e,t)}catch(e){return this.parse().catch(e)}finally(e){return this.parse().finally(e)}};zc=new WeakMap;var cd,Dc=class{constructor(e,t,o,r){cd.set(this,void 0),W(this,cd,e,"f"),this.options=r,this.response=t,this.body=o}hasNextPage(){return this.getPaginatedItems().length?this.nextPageRequestOptions()!=null:!1}async getNextPage(){let e=this.nextPageRequestOptions();if(!e)throw new H("No next page expected; please check `.hasNextPage()` before calling `.getNextPage()`.");return await T(this,cd,"f").requestAPIList(this.constructor,e)}async*iterPages(){let e=this;for(yield e;e.hasNextPage();)e=await e.getNextPage(),yield e}async*[(cd=new WeakMap,Symbol.asyncIterator)](){for await(let e of this.iterPages())for(let t of e.getPaginatedItems())yield t}},qc=class extends ii{constructor(e,t,o){super(e,t,async(r,i)=>new o(r,i.response,await sd(r,i),i.options))}async*[Symbol.asyncIterator](){let e=await this;for await(let t of e)yield t}},fo=class extends Dc{constructor(e,t,o,r){super(e,t,o,r),this.data=o.data||[],this.object=o.object}getPaginatedItems(){return this.data??[]}nextPageRequestOptions(){return null}},ae=class extends Dc{constructor(e,t,o,r){super(e,t,o,r),this.data=o.data||[],this.has_more=o.has_more||!1}getPaginatedItems(){return this.data??[]}hasNextPage(){return this.has_more===!1?!1:super.hasNextPage()}nextPageRequestOptions(){let e=this.getPaginatedItems(),t=e[e.length-1]?.id;return t?{...this.options,query:{...df(this.options.query),after:t}}:null}},qo=class extends Dc{constructor(e,t,o,r){super(e,t,o,r),this.data=o.data||[],this.has_more=o.has_more||!1,this.last_id=o.last_id||""}getPaginatedItems(){return this.data??[]}hasNextPage(){return this.has_more===!1?!1:super.hasNextPage()}nextPageRequestOptions(){let e=this.last_id;return e?{...this.options,query:{...df(this.options.query),after:e}}:null}};var If=()=>{if(typeof File>"u"){let{process:n}=globalThis,e=typeof n?.versions?.node=="string"&&parseInt(n.versions.node.split("."))<20;throw new Error("`File` is not defined as a global, which is required for file uploads."+(e?" Update to Node 20 LTS or newer, or set `globalThis.File` to `import('node:buffer').File`.":""))}};function Na(n,e,t){return If(),new File(n,e??"unknown_file",t)}function Fc(n){return(typeof n=="object"&&n!==null&&("name"in n&&n.name&&String(n.name)||"url"in n&&n.url&&String(n.url)||"filename"in n&&n.filename&&String(n.filename)||"path"in n&&n.path&&String(n.path))||"").split(/[\\/]/).pop()||void 0}var ld=n=>n!=null&&typeof n=="object"&&typeof n[Symbol.asyncIterator]=="function",Af=async(n,e)=>Cf(n.body)?{...n,body:await yw(n.body,e)}:n,An=async(n,e)=>({...n,body:await yw(n.body,e)}),vw=new WeakMap;function bS(n){let e=typeof n=="function"?n:n.fetch,t=vw.get(e);if(t)return t;let o=(async()=>{try{let r="Response"in e?e.Response:(await e("data:,")).constructor,i=new FormData;return i.toString()!==await new r(i).text()}catch{return!0}})();return vw.set(e,o),o}var yw=async(n,e)=>{if(!await bS(e))throw new TypeError("The provided fetch function does not support file uploads with the current global FormData class.");let t=new FormData;return await Promise.all(Object.entries(n||{}).map(([o,r])=>Tf(t,o,r))),t},xw=n=>n instanceof Blob&&"name"in n,wS=n=>typeof n=="object"&&n!==null&&(n instanceof Response||ld(n)||xw(n)),Cf=n=>{if(wS(n))return!0;if(Array.isArray(n))return n.some(Cf);if(n&&typeof n=="object"){for(let e in n)if(Cf(n[e]))return!0}return!1},Tf=async(n,e,t)=>{if(t!==void 0){if(t==null)throw new TypeError(`Received null for "${e}"; to pass null in FormData, you must use the string 'null'`);if(typeof t=="string"||typeof t=="number"||typeof t=="boolean")n.append(e,String(t));else if(t instanceof Response)n.append(e,Na([await t.blob()],Fc(t)));else if(ld(t))n.append(e,Na([await new Response(td(t)).blob()],Fc(t)));else if(xw(t))n.append(e,t,Fc(t));else if(Array.isArray(t))await Promise.all(t.map(o=>Tf(n,e+"[]",o)));else if(typeof t=="object")await Promise.all(Object.entries(t).map(([o,r])=>Tf(n,`${e}[${o}]`,r)));else throw new TypeError(`Invalid value given to form, expected a string, number, boolean, object, Array, File or Blob but got ${t} instead`)}};var bw=n=>n!=null&&typeof n=="object"&&typeof n.size=="number"&&typeof n.type=="string"&&typeof n.text=="function"&&typeof n.slice=="function"&&typeof n.arrayBuffer=="function",kS=n=>n!=null&&typeof n=="object"&&typeof n.name=="string"&&typeof n.lastModified=="number"&&bw(n),_S=n=>n!=null&&typeof n=="object"&&typeof n.url=="string"&&typeof n.blob=="function";async function ud(n,e,t){if(If(),n=await n,kS(n))return n instanceof File?n:Na([await n.arrayBuffer()],n.name);if(_S(n)){let r=await n.blob();return e||(e=new URL(n.url).pathname.split(/[\\/]/).pop()),Na(await Pf(r),e,t)}let o=await Pf(n);if(e||(e=Fc(n)),!t?.type){let r=o.find(i=>typeof i=="object"&&"type"in i&&i.type);typeof r=="string"&&(t={...t,type:r})}return Na(o,e,t)}async function Pf(n){let e=[];if(typeof n=="string"||ArrayBuffer.isView(n)||n instanceof ArrayBuffer)e.push(n);else if(bw(n))e.push(n instanceof Blob?n:await n.arrayBuffer());else if(ld(n))for await(let t of n)e.push(...await Pf(t));else{let t=n?.constructor?.name;throw new Error(`Unexpected data type: ${typeof n}${t?`; constructor: ${t}`:""}${CS(n)}`)}return e}function CS(n){return typeof n!="object"||n===null?"":`; props: [${Object.getOwnPropertyNames(n).map(t=>`"${t}"`).join(", ")}]`}var O=class{constructor(e){this._client=e}};function kw(n){return n.replace(/[^A-Za-z0-9\-._~!$&'()*+,;=:@]+/g,encodeURIComponent)}var ww=Object.freeze(Object.create(null)),IS=(n=kw)=>function(t,...o){if(t.length===1)return t[0];let r=!1,i=[],a=t.reduce((d,p,f)=>{/[?#]/.test(p)&&(r=!0);let m=o[f],h=(r?encodeURIComponent:n)(""+m);return f!==o.length&&(m==null||typeof m=="object"&&m.toString===Object.getPrototypeOf(Object.getPrototypeOf(m.hasOwnProperty??ww)??ww)?.toString)&&(h=m+"",i.push({start:d.length+p.length,length:h.length,error:`Value of type ${Object.prototype.toString.call(m).slice(8,-1)} is not a valid path parameter`})),d+p+(f===o.length?"":h)},""),s=a.split(/[?#]/,1)[0],c=/(?<=^|\/)(?:\.|%2e){1,2}(?=\/|$)/gi,l;for(;(l=c.exec(s))!==null;)i.push({start:l.index,length:l[0].length,error:`Value "${l[0]}" can't be safely passed as a path parameter`});if(i.sort((d,p)=>d.start-p.start),i.length>0){let d=0,p=i.reduce((f,m)=>{let h=" ".repeat(m.start-d),g="^".repeat(m.length);return d=m.start+m.length,f+h+g},"");throw new H(`Path parameters result in path with invalid segments:
${i.map(f=>f.error).join(`
`)}
${a}
${p}`)}return a},E=IS(kw);var ai=class extends O{list(e,t={},o){return this._client.getAPIList(E`/chat/completions/${e}/messages`,ae,{query:t,...o})}};function Bc(n){return n!==void 0&&"function"in n&&n.function!==void 0}function Uc(n){return n?.$brand==="auto-parseable-response-format"}function si(n){return n?.$brand==="auto-parseable-tool"}function _w(n,e){return!e||!Mf(e)?{...n,choices:n.choices.map(t=>(Tw(t.message.tool_calls),{...t,message:{...t.message,parsed:null,...t.message.tool_calls?{tool_calls:t.message.tool_calls}:void 0}}))}:jc(n,e)}function jc(n,e){let t=n.choices.map(o=>{if(o.finish_reason==="length")throw new Ra;if(o.finish_reason==="content_filter")throw new Oa;return Tw(o.message.tool_calls),{...o,message:{...o.message,...o.message.tool_calls?{tool_calls:o.message.tool_calls?.map(r=>SS(e,r))??void 0}:void 0,parsed:o.message.content&&!o.message.refusal?MS(e,o.message.content):null}}});return{...n,choices:t}}function MS(n,e){return n.response_format?.type!=="json_schema"?null:n.response_format?.type==="json_schema"?"$parseRaw"in n.response_format?n.response_format.$parseRaw(e):JSON.parse(e):null}function SS(n,e){let t=n.tools?.find(o=>Bc(o)&&o.function?.name===e.function.name);return{...e,function:{...e.function,parsed_arguments:si(t)?t.$parseRaw(e.function.arguments):t?.function.strict?JSON.parse(e.function.arguments):null}}}function Cw(n,e){if(!n||!("tools"in n)||!n.tools)return!1;let t=n.tools?.find(o=>Bc(o)&&o.function?.name===e.function.name);return Bc(t)&&(si(t)||t?.function.strict||!1)}function Mf(n){return Uc(n.response_format)?!0:n.tools?.some(e=>si(e)||e.type==="function"&&e.function.strict===!0)??!1}function Tw(n){for(let e of n||[])if(e.type!=="function")throw new H(`Currently only \`function\` tool calls are supported; Received \`${e.type}\``)}function Iw(n){for(let e of n??[]){if(e.type!=="function")throw new H(`Currently only \`function\` tool types support auto-parsing; Received \`${e.type}\``);if(e.function.strict!==!0)throw new H(`The \`${e.function.name}\` tool is not marked with \`strict: true\`. Only strict function tools can be auto-parsed`)}}var za=n=>n?.role==="assistant",Sf=n=>n?.role==="tool";var $f,dd,pd,Kc,Hc,md,Zc,Fo,Gc,fd,hd,Da,Aw,br=class{constructor(){$f.add(this),this.controller=new AbortController,dd.set(this,void 0),pd.set(this,()=>{}),Kc.set(this,()=>{}),Hc.set(this,void 0),md.set(this,()=>{}),Zc.set(this,()=>{}),Fo.set(this,{}),Gc.set(this,!1),fd.set(this,!1),hd.set(this,!1),Da.set(this,!1),W(this,dd,new Promise((e,t)=>{W(this,pd,e,"f"),W(this,Kc,t,"f")}),"f"),W(this,Hc,new Promise((e,t)=>{W(this,md,e,"f"),W(this,Zc,t,"f")}),"f"),T(this,dd,"f").catch(()=>{}),T(this,Hc,"f").catch(()=>{})}_run(e){setTimeout(()=>{e().then(()=>{this._emitFinal(),this._emit("end")},T(this,$f,"m",Aw).bind(this))},0)}_connected(){this.ended||(T(this,pd,"f").call(this),this._emit("connect"))}get ended(){return T(this,Gc,"f")}get errored(){return T(this,fd,"f")}get aborted(){return T(this,hd,"f")}abort(){this.controller.abort()}on(e,t){return(T(this,Fo,"f")[e]||(T(this,Fo,"f")[e]=[])).push({listener:t}),this}off(e,t){let o=T(this,Fo,"f")[e];if(!o)return this;let r=o.findIndex(i=>i.listener===t);return r>=0&&o.splice(r,1),this}once(e,t){return(T(this,Fo,"f")[e]||(T(this,Fo,"f")[e]=[])).push({listener:t,once:!0}),this}emitted(e){return new Promise((t,o)=>{W(this,Da,!0,"f"),e!=="error"&&this.once("error",o),this.once(e,t)})}async done(){W(this,Da,!0,"f"),await T(this,Hc,"f")}_emit(e,...t){if(T(this,Gc,"f"))return;e==="end"&&(W(this,Gc,!0,"f"),T(this,md,"f").call(this));let o=T(this,Fo,"f")[e];if(o&&(T(this,Fo,"f")[e]=o.filter(r=>!r.once),o.forEach(({listener:r})=>r(...t))),e==="abort"){let r=t[0];!T(this,Da,"f")&&!o?.length&&Promise.reject(r),T(this,Kc,"f").call(this,r),T(this,Zc,"f").call(this,r),this._emit("end");return}if(e==="error"){let r=t[0];!T(this,Da,"f")&&!o?.length&&Promise.reject(r),T(this,Kc,"f").call(this,r),T(this,Zc,"f").call(this,r),this._emit("end")}}_emitFinal(){}};dd=new WeakMap,pd=new WeakMap,Kc=new WeakMap,Hc=new WeakMap,md=new WeakMap,Zc=new WeakMap,Fo=new WeakMap,Gc=new WeakMap,fd=new WeakMap,hd=new WeakMap,Da=new WeakMap,$f=new WeakSet,Aw=function(e){if(W(this,fd,!0,"f"),e instanceof Error&&e.name==="AbortError"&&(e=new dt),e instanceof dt)return W(this,hd,!0,"f"),this._emit("abort",e);if(e instanceof H)return this._emit("error",e);if(e instanceof Error){let t=new H(e.message);return t.cause=e,this._emit("error",t)}return this._emit("error",new H(String(e)))};function Pw(n){return typeof n.parse=="function"}var en,Ef,gd,Rf,Of,Lf,Mw,Sw,$S=10,qa=class extends br{constructor(){super(...arguments),en.add(this),this._chatCompletions=[],this.messages=[]}_addChatCompletion(e){this._chatCompletions.push(e),this._emit("chatCompletion",e);let t=e.choices[0]?.message;return t&&this._addMessage(t),e}_addMessage(e,t=!0){if("content"in e||(e.content=null),this.messages.push(e),t){if(this._emit("message",e),Sf(e)&&e.content)this._emit("functionToolCallResult",e.content);else if(za(e)&&e.tool_calls)for(let o of e.tool_calls)o.type==="function"&&this._emit("functionToolCall",o.function)}}async finalChatCompletion(){await this.done();let e=this._chatCompletions[this._chatCompletions.length-1];if(!e)throw new H("stream ended without producing a ChatCompletion");return e}async finalContent(){return await this.done(),T(this,en,"m",Ef).call(this)}async finalMessage(){return await this.done(),T(this,en,"m",gd).call(this)}async finalFunctionToolCall(){return await this.done(),T(this,en,"m",Rf).call(this)}async finalFunctionToolCallResult(){return await this.done(),T(this,en,"m",Of).call(this)}async totalUsage(){return await this.done(),T(this,en,"m",Lf).call(this)}allChatCompletions(){return[...this._chatCompletions]}_emitFinal(){let e=this._chatCompletions[this._chatCompletions.length-1];e&&this._emit("finalChatCompletion",e);let t=T(this,en,"m",gd).call(this);t&&this._emit("finalMessage",t);let o=T(this,en,"m",Ef).call(this);o&&this._emit("finalContent",o);let r=T(this,en,"m",Rf).call(this);r&&this._emit("finalFunctionToolCall",r);let i=T(this,en,"m",Of).call(this);i!=null&&this._emit("finalFunctionToolCallResult",i),this._chatCompletions.some(a=>a.usage)&&this._emit("totalUsage",T(this,en,"m",Lf).call(this))}async _createChatCompletion(e,t,o){let r=o?.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort())),T(this,en,"m",Mw).call(this,t);let i=await e.chat.completions.create({...t,stream:!1},{...o,signal:this.controller.signal});return this._connected(),this._addChatCompletion(jc(i,t))}async _runChatCompletion(e,t,o){for(let r of t.messages)this._addMessage(r,!1);return await this._createChatCompletion(e,t,o)}async _runTools(e,t,o){let r="tool",{tool_choice:i="auto",stream:a,...s}=t,c=typeof i!="string"&&i.type==="function"&&i?.function?.name,{maxChatCompletions:l=$S}=o||{},d=t.tools.map(m=>{if(si(m)){if(!m.$callback)throw new H("Tool given to `.runTools()` that does not have an associated function");return{type:"function",function:{function:m.$callback,name:m.function.name,description:m.function.description||"",parameters:m.function.parameters,parse:m.$parseRaw,strict:!0}}}return m}),p={};for(let m of d)m.type==="function"&&(p[m.function.name||m.function.function.name]=m.function);let f="tools"in t?d.map(m=>m.type==="function"?{type:"function",function:{name:m.function.name||m.function.function.name,parameters:m.function.parameters,description:m.function.description,strict:m.function.strict}}:m):void 0;for(let m of t.messages)this._addMessage(m,!1);for(let m=0;m<l;++m){let g=(await this._createChatCompletion(e,{...s,tool_choice:i,tools:f,messages:[...this.messages]},o)).choices[0]?.message;if(!g)throw new H("missing message in ChatCompletion response");if(!g.tool_calls?.length)return;for(let v of g.tool_calls){if(v.type!=="function")continue;let k=v.id,{name:x,arguments:y}=v.function,w=p[x];if(w){if(c&&c!==x){let $=`Invalid tool_call: ${JSON.stringify(x)}. ${JSON.stringify(c)} requested. Please try again`;this._addMessage({role:r,tool_call_id:k,content:$});continue}}else{let $=`Invalid tool_call: ${JSON.stringify(x)}. Available options are: ${Object.keys(p).map(M=>JSON.stringify(M)).join(", ")}. Please try again`;this._addMessage({role:r,tool_call_id:k,content:$});continue}let b;try{b=Pw(w)?await w.parse(y):y}catch($){let M=$ instanceof Error?$.message:String($);this._addMessage({role:r,tool_call_id:k,content:M});continue}let C=await w.function(b,this),I=T(this,en,"m",Sw).call(this,C);if(this._addMessage({role:r,tool_call_id:k,content:I}),c)return}}}};en=new WeakSet,Ef=function(){return T(this,en,"m",gd).call(this).content??null},gd=function(){let e=this.messages.length;for(;e-- >0;){let t=this.messages[e];if(za(t))return{...t,content:t.content??null,refusal:t.refusal??null}}throw new H("stream ended without producing a ChatCompletionMessage with role=assistant")},Rf=function(){for(let e=this.messages.length-1;e>=0;e--){let t=this.messages[e];if(za(t)&&t?.tool_calls?.length)return t.tool_calls.filter(o=>o.type==="function").at(-1)?.function}},Of=function(){for(let e=this.messages.length-1;e>=0;e--){let t=this.messages[e];if(Sf(t)&&t.content!=null&&typeof t.content=="string"&&this.messages.some(o=>o.role==="assistant"&&o.tool_calls?.some(r=>r.type==="function"&&r.id===t.tool_call_id)))return t.content}},Lf=function(){let e={completion_tokens:0,prompt_tokens:0,total_tokens:0};for(let{usage:t}of this._chatCompletions)t&&(e.completion_tokens+=t.completion_tokens,e.prompt_tokens+=t.prompt_tokens,e.total_tokens+=t.total_tokens);return e},Mw=function(e){if(e.n!=null&&e.n>1)throw new H("ChatCompletion convenience helpers only support n=1 at this time. To use n>1, please use chat.completions.create() directly.")},Sw=function(e){return typeof e=="string"?e:e===void 0?"undefined":JSON.stringify(e)};var Vc=class n extends qa{static runTools(e,t,o){let r=new n,i={...o,headers:{...o?.headers,"X-Stainless-Helper-Method":"runTools"}};return r._run(()=>r._runTools(e,t,i)),r}_addMessage(e,t=!0){super._addMessage(e,t),za(e)&&e.content&&this._emit("content",e.content)}};var Mt={STR:1,NUM:2,ARR:4,OBJ:8,NULL:16,BOOL:32,NAN:64,INFINITY:128,MINUS_INFINITY:256,INF:384,SPECIAL:496,ATOM:499,COLLECTION:12,ALL:511},Nf=class extends Error{},zf=class extends Error{};function ES(n,e=Mt.ALL){if(typeof n!="string")throw new TypeError(`expecting str, got ${typeof n}`);if(!n.trim())throw new Error(`${n} is empty`);return RS(n.trim(),e)}var RS=(n,e)=>{let t=n.length,o=0,r=f=>{throw new Nf(`${f} at position ${o}`)},i=f=>{throw new zf(`${f} at position ${o}`)},a=()=>(p(),o>=t&&r("Unexpected end of input"),n[o]==='"'?s():n[o]==="{"?c():n[o]==="["?l():n.substring(o,o+4)==="null"||Mt.NULL&e&&t-o<4&&"null".startsWith(n.substring(o))?(o+=4,null):n.substring(o,o+4)==="true"||Mt.BOOL&e&&t-o<4&&"true".startsWith(n.substring(o))?(o+=4,!0):n.substring(o,o+5)==="false"||Mt.BOOL&e&&t-o<5&&"false".startsWith(n.substring(o))?(o+=5,!1):n.substring(o,o+8)==="Infinity"||Mt.INFINITY&e&&t-o<8&&"Infinity".startsWith(n.substring(o))?(o+=8,1/0):n.substring(o,o+9)==="-Infinity"||Mt.MINUS_INFINITY&e&&1<t-o&&t-o<9&&"-Infinity".startsWith(n.substring(o))?(o+=9,-1/0):n.substring(o,o+3)==="NaN"||Mt.NAN&e&&t-o<3&&"NaN".startsWith(n.substring(o))?(o+=3,NaN):d()),s=()=>{let f=o,m=!1;for(o++;o<t&&(n[o]!=='"'||m&&n[o-1]==="\\");)m=n[o]==="\\"?!m:!1,o++;if(n.charAt(o)=='"')try{return JSON.parse(n.substring(f,++o-Number(m)))}catch(h){i(String(h))}else if(Mt.STR&e)try{return JSON.parse(n.substring(f,o-Number(m))+'"')}catch{return JSON.parse(n.substring(f,n.lastIndexOf("\\"))+'"')}r("Unterminated string literal")},c=()=>{o++,p();let f={};try{for(;n[o]!=="}";){if(p(),o>=t&&Mt.OBJ&e)return f;let m=s();p(),o++;try{let h=a();Object.defineProperty(f,m,{value:h,writable:!0,enumerable:!0,configurable:!0})}catch(h){if(Mt.OBJ&e)return f;throw h}p(),n[o]===","&&o++}}catch{if(Mt.OBJ&e)return f;r("Expected '}' at end of object")}return o++,f},l=()=>{o++;let f=[];try{for(;n[o]!=="]";)f.push(a()),p(),n[o]===","&&o++}catch{if(Mt.ARR&e)return f;r("Expected ']' at end of array")}return o++,f},d=()=>{if(o===0){n==="-"&&Mt.NUM&e&&r("Not sure what '-' is");try{return JSON.parse(n)}catch(m){if(Mt.NUM&e)try{return n[n.length-1]==="."?JSON.parse(n.substring(0,n.lastIndexOf("."))):JSON.parse(n.substring(0,n.lastIndexOf("e")))}catch{}i(String(m))}}let f=o;for(n[o]==="-"&&o++;n[o]&&!",]}".includes(n[o]);)o++;o==t&&!(Mt.NUM&e)&&r("Unterminated number literal");try{return JSON.parse(n.substring(f,o))}catch{n.substring(f,o)==="-"&&Mt.NUM&e&&r("Not sure what '-' is");try{return JSON.parse(n.substring(f,n.lastIndexOf("e")))}catch(h){i(String(h))}}},p=()=>{for(;o<t&&` 
\r	`.includes(n[o]);)o++};return a()},Df=n=>ES(n,Mt.ALL^Mt.NUM);var kt,Bo,Fa,wr,qf,vd,Ff,Bf,Uf,yd,jf,$w,ci=class n extends qa{constructor(e){super(),kt.add(this),Bo.set(this,void 0),Fa.set(this,void 0),wr.set(this,void 0),W(this,Bo,e,"f"),W(this,Fa,[],"f")}get currentChatCompletionSnapshot(){return T(this,wr,"f")}static fromReadableStream(e){let t=new n(null);return t._run(()=>t._fromReadableStream(e)),t}static createChatCompletion(e,t,o){let r=new n(t);return r._run(()=>r._runChatCompletion(e,{...t,stream:!0},{...o,headers:{...o?.headers,"X-Stainless-Helper-Method":"stream"}})),r}async _createChatCompletion(e,t,o){super._createChatCompletion;let r=o?.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort())),T(this,kt,"m",qf).call(this);let i=await e.chat.completions.create({...t,stream:!0},{...o,signal:this.controller.signal});this._connected();for await(let a of i)T(this,kt,"m",Ff).call(this,a);if(i.controller.signal?.aborted)throw new dt;return this._addChatCompletion(T(this,kt,"m",yd).call(this))}async _fromReadableStream(e,t){let o=t?.signal;o&&(o.aborted&&this.controller.abort(),o.addEventListener("abort",()=>this.controller.abort())),T(this,kt,"m",qf).call(this),this._connected();let r=mo.fromReadableStream(e,this.controller),i;for await(let a of r)i&&i!==a.id&&this._addChatCompletion(T(this,kt,"m",yd).call(this)),T(this,kt,"m",Ff).call(this,a),i=a.id;if(r.controller.signal?.aborted)throw new dt;return this._addChatCompletion(T(this,kt,"m",yd).call(this))}[(Bo=new WeakMap,Fa=new WeakMap,wr=new WeakMap,kt=new WeakSet,qf=function(){this.ended||W(this,wr,void 0,"f")},vd=function(t){let o=T(this,Fa,"f")[t.index];return o||(o={content_done:!1,refusal_done:!1,logprobs_content_done:!1,logprobs_refusal_done:!1,done_tool_calls:new Set,current_tool_call_index:null},T(this,Fa,"f")[t.index]=o,o)},Ff=function(t){if(this.ended)return;let o=T(this,kt,"m",$w).call(this,t);this._emit("chunk",t,o);for(let r of t.choices){let i=o.choices[r.index];r.delta.content!=null&&i.message?.role==="assistant"&&i.message?.content&&(this._emit("content",r.delta.content,i.message.content),this._emit("content.delta",{delta:r.delta.content,snapshot:i.message.content,parsed:i.message.parsed})),r.delta.refusal!=null&&i.message?.role==="assistant"&&i.message?.refusal&&this._emit("refusal.delta",{delta:r.delta.refusal,snapshot:i.message.refusal}),r.logprobs?.content!=null&&i.message?.role==="assistant"&&this._emit("logprobs.content.delta",{content:r.logprobs?.content,snapshot:i.logprobs?.content??[]}),r.logprobs?.refusal!=null&&i.message?.role==="assistant"&&this._emit("logprobs.refusal.delta",{refusal:r.logprobs?.refusal,snapshot:i.logprobs?.refusal??[]});let a=T(this,kt,"m",vd).call(this,i);i.finish_reason&&(T(this,kt,"m",Uf).call(this,i),a.current_tool_call_index!=null&&T(this,kt,"m",Bf).call(this,i,a.current_tool_call_index));for(let s of r.delta.tool_calls??[])a.current_tool_call_index!==s.index&&(T(this,kt,"m",Uf).call(this,i),a.current_tool_call_index!=null&&T(this,kt,"m",Bf).call(this,i,a.current_tool_call_index)),a.current_tool_call_index=s.index;for(let s of r.delta.tool_calls??[]){let c=i.message.tool_calls?.[s.index];c?.type&&(c?.type==="function"?this._emit("tool_calls.function.arguments.delta",{name:c.function?.name,index:s.index,arguments:c.function.arguments,parsed_arguments:c.function.parsed_arguments,arguments_delta:s.function?.arguments??""}):(c?.type,void 0))}}},Bf=function(t,o){if(T(this,kt,"m",vd).call(this,t).done_tool_calls.has(o))return;let i=t.message.tool_calls?.[o];if(!i)throw new Error("no tool call snapshot");if(!i.type)throw new Error("tool call snapshot missing `type`");if(i.type==="function"){let a=T(this,Bo,"f")?.tools?.find(s=>Bc(s)&&s.function.name===i.function.name);this._emit("tool_calls.function.arguments.done",{name:i.function.name,index:o,arguments:i.function.arguments,parsed_arguments:si(a)?a.$parseRaw(i.function.arguments):a?.function.strict?JSON.parse(i.function.arguments):null})}else i.type},Uf=function(t){let o=T(this,kt,"m",vd).call(this,t);if(t.message.content&&!o.content_done){o.content_done=!0;let r=T(this,kt,"m",jf).call(this);this._emit("content.done",{content:t.message.content,parsed:r?r.$parseRaw(t.message.content):null})}t.message.refusal&&!o.refusal_done&&(o.refusal_done=!0,this._emit("refusal.done",{refusal:t.message.refusal})),t.logprobs?.content&&!o.logprobs_content_done&&(o.logprobs_content_done=!0,this._emit("logprobs.content.done",{content:t.logprobs.content})),t.logprobs?.refusal&&!o.logprobs_refusal_done&&(o.logprobs_refusal_done=!0,this._emit("logprobs.refusal.done",{refusal:t.logprobs.refusal}))},yd=function(){if(this.ended)throw new H("stream has ended, this shouldn't happen");let t=T(this,wr,"f");if(!t)throw new H("request ended without sending any chunks");return W(this,wr,void 0,"f"),W(this,Fa,[],"f"),OS(t,T(this,Bo,"f"))},jf=function(){let t=T(this,Bo,"f")?.response_format;return Uc(t)?t:null},$w=function(t){var o,r,i,a;let s=T(this,wr,"f"),{choices:c,...l}=t;s?Object.assign(s,l):s=W(this,wr,{...l,choices:[]},"f");for(let{delta:d,finish_reason:p,index:f,logprobs:m=null,...h}of t.choices){let g=s.choices[f];if(g||(g=s.choices[f]={finish_reason:p,index:f,message:{},logprobs:m,...h}),m)if(!g.logprobs)g.logprobs=Object.assign({},m);else{let{content:C,refusal:I,...$}=m;Object.assign(g.logprobs,$),C&&((o=g.logprobs).content??(o.content=[]),g.logprobs.content.push(...C)),I&&((r=g.logprobs).refusal??(r.refusal=[]),g.logprobs.refusal.push(...I))}if(p&&(g.finish_reason=p,T(this,Bo,"f")&&Mf(T(this,Bo,"f")))){if(p==="length")throw new Ra;if(p==="content_filter")throw new Oa}if(Object.assign(g,h),!d)continue;let{content:v,refusal:k,function_call:x,role:y,tool_calls:w,...b}=d;if(Object.assign(g.message,b),k&&(g.message.refusal=(g.message.refusal||"")+k),y&&(g.message.role=y),x&&(g.message.function_call?(x.name&&(g.message.function_call.name=x.name),x.arguments&&((i=g.message.function_call).arguments??(i.arguments=""),g.message.function_call.arguments+=x.arguments)):g.message.function_call=x),v&&(g.message.content=(g.message.content||"")+v,!g.message.refusal&&T(this,kt,"m",jf).call(this)&&(g.message.parsed=Df(g.message.content))),w){g.message.tool_calls||(g.message.tool_calls=[]);for(let{index:C,id:I,type:$,function:M,...A}of w){let z=(a=g.message.tool_calls)[C]??(a[C]={});Object.assign(z,A),I&&(z.id=I),$&&(z.type=$),M&&(z.function??(z.function={name:M.name??"",arguments:""})),M?.name&&(z.function.name=M.name),M?.arguments&&(z.function.arguments+=M.arguments,Cw(T(this,Bo,"f"),z)&&(z.function.parsed_arguments=Df(z.function.arguments)))}}}return s},Symbol.asyncIterator)](){let e=[],t=[],o=!1;return this.on("chunk",r=>{let i=t.shift();i?i.resolve(r):e.push(r)}),this.on("end",()=>{o=!0;for(let r of t)r.resolve(void 0);t.length=0}),this.on("abort",r=>{o=!0;for(let i of t)i.reject(r);t.length=0}),this.on("error",r=>{o=!0;for(let i of t)i.reject(r);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:o?{value:void 0,done:!0}:new Promise((i,a)=>t.push({resolve:i,reject:a})).then(i=>i?{value:i,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}toReadableStream(){return new mo(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}};function OS(n,e){let{id:t,choices:o,created:r,model:i,system_fingerprint:a,...s}=n,c={...s,id:t,choices:o.map(({message:l,finish_reason:d,index:p,logprobs:f,...m})=>{if(!d)throw new H(`missing finish_reason for choice ${p}`);let{content:h=null,function_call:g,tool_calls:v,...k}=l,x=l.role;if(!x)throw new H(`missing role for choice ${p}`);if(g){let{arguments:y,name:w}=g;if(y==null)throw new H(`missing function_call.arguments for choice ${p}`);if(!w)throw new H(`missing function_call.name for choice ${p}`);return{...m,message:{content:h,function_call:{arguments:y,name:w},role:x,refusal:l.refusal??null},finish_reason:d,index:p,logprobs:f}}return v?{...m,index:p,finish_reason:d,logprobs:f,message:{...k,role:x,content:h,refusal:l.refusal??null,tool_calls:v.map((y,w)=>{let{function:b,type:C,id:I,...$}=y,{arguments:M,name:A,...z}=b||{};if(I==null)throw new H(`missing choices[${p}].tool_calls[${w}].id
${xd(n)}`);if(C==null)throw new H(`missing choices[${p}].tool_calls[${w}].type
${xd(n)}`);if(A==null)throw new H(`missing choices[${p}].tool_calls[${w}].function.name
${xd(n)}`);if(M==null)throw new H(`missing choices[${p}].tool_calls[${w}].function.arguments
${xd(n)}`);return{...$,id:I,type:C,function:{...z,name:A,arguments:M}}})}}:{...m,message:{...k,content:h,role:x,refusal:l.refusal??null},finish_reason:d,index:p,logprobs:f}}),created:r,model:i,object:"chat.completion",...a?{system_fingerprint:a}:{}};return _w(c,e)}function xd(n){return JSON.stringify(n)}var Qc=class n extends ci{static fromReadableStream(e){let t=new n(null);return t._run(()=>t._fromReadableStream(e)),t}static runTools(e,t,o){let r=new n(t),i={...o,headers:{...o?.headers,"X-Stainless-Helper-Method":"runTools"}};return r._run(()=>r._runTools(e,t,i)),r}};var Uo=class extends O{constructor(){super(...arguments),this.messages=new ai(this._client)}create(e,t){return this._client.post("/chat/completions",{body:e,...t,stream:e.stream??!1})}retrieve(e,t){return this._client.get(E`/chat/completions/${e}`,t)}update(e,t,o){return this._client.post(E`/chat/completions/${e}`,{body:t,...o})}list(e={},t){return this._client.getAPIList("/chat/completions",ae,{query:e,...t})}delete(e,t){return this._client.delete(E`/chat/completions/${e}`,t)}parse(e,t){return Iw(e.tools),this._client.chat.completions.create(e,{...t,headers:{...t?.headers,"X-Stainless-Helper-Method":"chat.completions.parse"}})._thenUnwrap(o=>jc(o,e))}runTools(e,t){return e.stream?Qc.runTools(this._client,e,t):Vc.runTools(this._client,e,t)}stream(e,t){return ci.createChatCompletion(this._client,e,t)}};Uo.Messages=ai;var kr=class extends O{constructor(){super(...arguments),this.completions=new Uo(this._client)}};kr.Completions=Uo;var Ew=Symbol("brand.privateNullableHeaders");function*NS(n){if(!n)return;if(Ew in n){let{values:o,nulls:r}=n;yield*o.entries();for(let i of r)yield[i,null];return}let e=!1,t;n instanceof Headers?t=n.entries():uf(n)?t=n:(e=!0,t=Object.entries(n??{}));for(let o of t){let r=o[0];if(typeof r!="string")throw new TypeError("expected header name to be a string");let i=uf(o[1])?o[1]:[o[1]],a=!1;for(let s of i)s!==void 0&&(e&&!a&&(a=!0,yield[r,null]),yield[r,s])}}var N=n=>{let e=new Headers,t=new Set;for(let o of n){let r=new Set;for(let[i,a]of NS(o)){let s=i.toLowerCase();r.has(s)||(e.delete(i),r.add(s)),a===null?(e.delete(i),t.add(s)):(e.append(i,a),t.delete(s))}}return{[Ew]:!0,values:e,nulls:t}};var Ba=class extends O{create(e,t){return this._client.post("/audio/speech",{body:e,...t,headers:N([{Accept:"application/octet-stream"},t?.headers]),__binaryResponse:!0})}};var Ua=class extends O{create(e,t){return this._client.post("/audio/transcriptions",An({body:e,...t,stream:e.stream??!1,__metadata:{model:e.model}},this._client))}};var ja=class extends O{create(e,t){return this._client.post("/audio/translations",An({body:e,...t,__metadata:{model:e.model}},this._client))}};var ho=class extends O{constructor(){super(...arguments),this.transcriptions=new Ua(this._client),this.translations=new ja(this._client),this.speech=new Ba(this._client)}};ho.Transcriptions=Ua;ho.Translations=ja;ho.Speech=Ba;var li=class extends O{create(e,t){return this._client.post("/batches",{body:e,...t})}retrieve(e,t){return this._client.get(E`/batches/${e}`,t)}list(e={},t){return this._client.getAPIList("/batches",ae,{query:e,...t})}cancel(e,t){return this._client.post(E`/batches/${e}/cancel`,t)}};var Ka=class extends O{create(e,t){return this._client.post("/assistants",{body:e,...t,headers:N([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}retrieve(e,t){return this._client.get(E`/assistants/${e}`,{...t,headers:N([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}update(e,t,o){return this._client.post(E`/assistants/${e}`,{body:t,...o,headers:N([{"OpenAI-Beta":"assistants=v2"},o?.headers])})}list(e={},t){return this._client.getAPIList("/assistants",ae,{query:e,...t,headers:N([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}delete(e,t){return this._client.delete(E`/assistants/${e}`,{...t,headers:N([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}};var Ha=class extends O{create(e,t){return this._client.post("/realtime/sessions",{body:e,...t,headers:N([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}};var Za=class extends O{create(e,t){return this._client.post("/realtime/transcription_sessions",{body:e,...t,headers:N([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}};var _r=class extends O{constructor(){super(...arguments),this.sessions=new Ha(this._client),this.transcriptionSessions=new Za(this._client)}};_r.Sessions=Ha;_r.TranscriptionSessions=Za;var Ga=class extends O{create(e,t){return this._client.post("/chatkit/sessions",{body:e,...t,headers:N([{"OpenAI-Beta":"chatkit_beta=v1"},t?.headers])})}cancel(e,t){return this._client.post(E`/chatkit/sessions/${e}/cancel`,{...t,headers:N([{"OpenAI-Beta":"chatkit_beta=v1"},t?.headers])})}};var Va=class extends O{retrieve(e,t){return this._client.get(E`/chatkit/threads/${e}`,{...t,headers:N([{"OpenAI-Beta":"chatkit_beta=v1"},t?.headers])})}list(e={},t){return this._client.getAPIList("/chatkit/threads",qo,{query:e,...t,headers:N([{"OpenAI-Beta":"chatkit_beta=v1"},t?.headers])})}delete(e,t){return this._client.delete(E`/chatkit/threads/${e}`,{...t,headers:N([{"OpenAI-Beta":"chatkit_beta=v1"},t?.headers])})}listItems(e,t={},o){return this._client.getAPIList(E`/chatkit/threads/${e}/items`,qo,{query:t,...o,headers:N([{"OpenAI-Beta":"chatkit_beta=v1"},o?.headers])})}};var Cr=class extends O{constructor(){super(...arguments),this.sessions=new Ga(this._client),this.threads=new Va(this._client)}};Cr.Sessions=Ga;Cr.Threads=Va;var Qa=class extends O{create(e,t,o){return this._client.post(E`/threads/${e}/messages`,{body:t,...o,headers:N([{"OpenAI-Beta":"assistants=v2"},o?.headers])})}retrieve(e,t,o){let{thread_id:r}=t;return this._client.get(E`/threads/${r}/messages/${e}`,{...o,headers:N([{"OpenAI-Beta":"assistants=v2"},o?.headers])})}update(e,t,o){let{thread_id:r,...i}=t;return this._client.post(E`/threads/${r}/messages/${e}`,{body:i,...o,headers:N([{"OpenAI-Beta":"assistants=v2"},o?.headers])})}list(e,t={},o){return this._client.getAPIList(E`/threads/${e}/messages`,ae,{query:t,...o,headers:N([{"OpenAI-Beta":"assistants=v2"},o?.headers])})}delete(e,t,o){let{thread_id:r}=t;return this._client.delete(E`/threads/${r}/messages/${e}`,{...o,headers:N([{"OpenAI-Beta":"assistants=v2"},o?.headers])})}};var Wa=class extends O{retrieve(e,t,o){let{thread_id:r,run_id:i,...a}=t;return this._client.get(E`/threads/${r}/runs/${i}/steps/${e}`,{query:a,...o,headers:N([{"OpenAI-Beta":"assistants=v2"},o?.headers])})}list(e,t,o){let{thread_id:r,...i}=t;return this._client.getAPIList(E`/threads/${r}/runs/${e}/steps`,ae,{query:i,...o,headers:N([{"OpenAI-Beta":"assistants=v2"},o?.headers])})}};var Rw=n=>{if(typeof Buffer<"u"){let e=Buffer.from(n,"base64");return Array.from(new Float32Array(e.buffer,e.byteOffset,e.length/Float32Array.BYTES_PER_ELEMENT))}else{let e=atob(n),t=e.length,o=new Uint8Array(t);for(let r=0;r<t;r++)o[r]=e.charCodeAt(r);return Array.from(new Float32Array(o.buffer))}};var Tr=n=>{if(typeof globalThis.process<"u")return globalThis.process.env?.[n]?.trim()??void 0;if(typeof globalThis.Deno<"u")return globalThis.Deno.env?.get?.(n)?.trim()};var zt,di,Kf,go,bd,Kn,pi,Ja,ui,_d,Pn,wd,kd,Xc,Wc,Jc,Ow,Lw,Nw,zw,Dw,qw,Fw,jo=class extends br{constructor(){super(...arguments),zt.add(this),Kf.set(this,[]),go.set(this,{}),bd.set(this,{}),Kn.set(this,void 0),pi.set(this,void 0),Ja.set(this,void 0),ui.set(this,void 0),_d.set(this,void 0),Pn.set(this,void 0),wd.set(this,void 0),kd.set(this,void 0),Xc.set(this,void 0)}[(Kf=new WeakMap,go=new WeakMap,bd=new WeakMap,Kn=new WeakMap,pi=new WeakMap,Ja=new WeakMap,ui=new WeakMap,_d=new WeakMap,Pn=new WeakMap,wd=new WeakMap,kd=new WeakMap,Xc=new WeakMap,zt=new WeakSet,Symbol.asyncIterator)](){let e=[],t=[],o=!1;return this.on("event",r=>{let i=t.shift();i?i.resolve(r):e.push(r)}),this.on("end",()=>{o=!0;for(let r of t)r.resolve(void 0);t.length=0}),this.on("abort",r=>{o=!0;for(let i of t)i.reject(r);t.length=0}),this.on("error",r=>{o=!0;for(let i of t)i.reject(r);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:o?{value:void 0,done:!0}:new Promise((i,a)=>t.push({resolve:i,reject:a})).then(i=>i?{value:i,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}static fromReadableStream(e){let t=new di;return t._run(()=>t._fromReadableStream(e)),t}async _fromReadableStream(e,t){let o=t?.signal;o&&(o.aborted&&this.controller.abort(),o.addEventListener("abort",()=>this.controller.abort())),this._connected();let r=mo.fromReadableStream(e,this.controller);for await(let i of r)T(this,zt,"m",Wc).call(this,i);if(r.controller.signal?.aborted)throw new dt;return this._addRun(T(this,zt,"m",Jc).call(this))}toReadableStream(){return new mo(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}static createToolAssistantStream(e,t,o,r){let i=new di;return i._run(()=>i._runToolAssistantStream(e,t,o,{...r,headers:{...r?.headers,"X-Stainless-Helper-Method":"stream"}})),i}async _createToolAssistantStream(e,t,o,r){let i=r?.signal;i&&(i.aborted&&this.controller.abort(),i.addEventListener("abort",()=>this.controller.abort()));let a={...o,stream:!0},s=await e.submitToolOutputs(t,a,{...r,signal:this.controller.signal});this._connected();for await(let c of s)T(this,zt,"m",Wc).call(this,c);if(s.controller.signal?.aborted)throw new dt;return this._addRun(T(this,zt,"m",Jc).call(this))}static createThreadAssistantStream(e,t,o){let r=new di;return r._run(()=>r._threadAssistantStream(e,t,{...o,headers:{...o?.headers,"X-Stainless-Helper-Method":"stream"}})),r}static createAssistantStream(e,t,o,r){let i=new di;return i._run(()=>i._runAssistantStream(e,t,o,{...r,headers:{...r?.headers,"X-Stainless-Helper-Method":"stream"}})),i}currentEvent(){return T(this,wd,"f")}currentRun(){return T(this,kd,"f")}currentMessageSnapshot(){return T(this,Kn,"f")}currentRunStepSnapshot(){return T(this,Xc,"f")}async finalRunSteps(){return await this.done(),Object.values(T(this,go,"f"))}async finalMessages(){return await this.done(),Object.values(T(this,bd,"f"))}async finalRun(){if(await this.done(),!T(this,pi,"f"))throw Error("Final run was not received.");return T(this,pi,"f")}async _createThreadAssistantStream(e,t,o){let r=o?.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort()));let i={...t,stream:!0},a=await e.createAndRun(i,{...o,signal:this.controller.signal});this._connected();for await(let s of a)T(this,zt,"m",Wc).call(this,s);if(a.controller.signal?.aborted)throw new dt;return this._addRun(T(this,zt,"m",Jc).call(this))}async _createAssistantStream(e,t,o,r){let i=r?.signal;i&&(i.aborted&&this.controller.abort(),i.addEventListener("abort",()=>this.controller.abort()));let a={...o,stream:!0},s=await e.create(t,a,{...r,signal:this.controller.signal});this._connected();for await(let c of s)T(this,zt,"m",Wc).call(this,c);if(s.controller.signal?.aborted)throw new dt;return this._addRun(T(this,zt,"m",Jc).call(this))}static accumulateDelta(e,t){for(let[o,r]of Object.entries(t)){if(!e.hasOwnProperty(o)){e[o]=r;continue}let i=e[o];if(i==null){e[o]=r;continue}if(o==="index"||o==="type"){e[o]=r;continue}if(typeof i=="string"&&typeof r=="string")i+=r;else if(typeof i=="number"&&typeof r=="number")i+=r;else if(Oc(i)&&Oc(r))i=this.accumulateDelta(i,r);else if(Array.isArray(i)&&Array.isArray(r)){if(i.every(a=>typeof a=="string"||typeof a=="number")){i.push(...r);continue}for(let a of r){if(!Oc(a))throw new Error(`Expected array delta entry to be an object but got: ${a}`);let s=a.index;if(s==null)throw console.error(a),new Error("Expected array delta entry to have an `index` property");if(typeof s!="number")throw new Error(`Expected array delta entry \`index\` property to be a number but got ${s}`);let c=i[s];c==null?i.push(a):i[s]=this.accumulateDelta(c,a)}continue}else throw Error(`Unhandled record type: ${o}, deltaValue: ${r}, accValue: ${i}`);e[o]=i}return e}_addRun(e){return e}async _threadAssistantStream(e,t,o){return await this._createThreadAssistantStream(t,e,o)}async _runAssistantStream(e,t,o,r){return await this._createAssistantStream(t,e,o,r)}async _runToolAssistantStream(e,t,o,r){return await this._createToolAssistantStream(t,e,o,r)}};di=jo,Wc=function(e){if(!this.ended)switch(W(this,wd,e,"f"),T(this,zt,"m",Nw).call(this,e),e.event){case"thread.created":break;case"thread.run.created":case"thread.run.queued":case"thread.run.in_progress":case"thread.run.requires_action":case"thread.run.completed":case"thread.run.incomplete":case"thread.run.failed":case"thread.run.cancelling":case"thread.run.cancelled":case"thread.run.expired":T(this,zt,"m",Fw).call(this,e);break;case"thread.run.step.created":case"thread.run.step.in_progress":case"thread.run.step.delta":case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":T(this,zt,"m",Lw).call(this,e);break;case"thread.message.created":case"thread.message.in_progress":case"thread.message.delta":case"thread.message.completed":case"thread.message.incomplete":T(this,zt,"m",Ow).call(this,e);break;case"error":throw new Error("Encountered an error event in event processing - errors should be processed earlier");default:}},Jc=function(){if(this.ended)throw new H("stream has ended, this shouldn't happen");if(!T(this,pi,"f"))throw Error("Final run has not been received");return T(this,pi,"f")},Ow=function(e){let[t,o]=T(this,zt,"m",Dw).call(this,e,T(this,Kn,"f"));W(this,Kn,t,"f"),T(this,bd,"f")[t.id]=t;for(let r of o){let i=t.content[r.index];i?.type=="text"&&this._emit("textCreated",i.text)}switch(e.event){case"thread.message.created":this._emit("messageCreated",e.data);break;case"thread.message.in_progress":break;case"thread.message.delta":if(this._emit("messageDelta",e.data.delta,t),e.data.delta.content)for(let r of e.data.delta.content){if(r.type=="text"&&r.text){let i=r.text,a=t.content[r.index];if(a&&a.type=="text")this._emit("textDelta",i,a.text);else throw Error("The snapshot associated with this text delta is not text or missing")}if(r.index!=T(this,Ja,"f")){if(T(this,ui,"f"))switch(T(this,ui,"f").type){case"text":this._emit("textDone",T(this,ui,"f").text,T(this,Kn,"f"));break;case"image_file":this._emit("imageFileDone",T(this,ui,"f").image_file,T(this,Kn,"f"));break}W(this,Ja,r.index,"f")}W(this,ui,t.content[r.index],"f")}break;case"thread.message.completed":case"thread.message.incomplete":if(T(this,Ja,"f")!==void 0){let r=e.data.content[T(this,Ja,"f")];if(r)switch(r.type){case"image_file":this._emit("imageFileDone",r.image_file,T(this,Kn,"f"));break;case"text":this._emit("textDone",r.text,T(this,Kn,"f"));break}}T(this,Kn,"f")&&this._emit("messageDone",e.data),W(this,Kn,void 0,"f")}},Lw=function(e){let t=T(this,zt,"m",zw).call(this,e);switch(W(this,Xc,t,"f"),e.event){case"thread.run.step.created":this._emit("runStepCreated",e.data);break;case"thread.run.step.delta":let o=e.data.delta;if(o.step_details&&o.step_details.type=="tool_calls"&&o.step_details.tool_calls&&t.step_details.type=="tool_calls")for(let i of o.step_details.tool_calls)i.index==T(this,_d,"f")?this._emit("toolCallDelta",i,t.step_details.tool_calls[i.index]):(T(this,Pn,"f")&&this._emit("toolCallDone",T(this,Pn,"f")),W(this,_d,i.index,"f"),W(this,Pn,t.step_details.tool_calls[i.index],"f"),T(this,Pn,"f")&&this._emit("toolCallCreated",T(this,Pn,"f")));this._emit("runStepDelta",e.data.delta,t);break;case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":W(this,Xc,void 0,"f"),e.data.step_details.type=="tool_calls"&&T(this,Pn,"f")&&(this._emit("toolCallDone",T(this,Pn,"f")),W(this,Pn,void 0,"f")),this._emit("runStepDone",e.data,t);break;case"thread.run.step.in_progress":break}},Nw=function(e){T(this,Kf,"f").push(e),this._emit("event",e)},zw=function(e){switch(e.event){case"thread.run.step.created":return T(this,go,"f")[e.data.id]=e.data,e.data;case"thread.run.step.delta":let t=T(this,go,"f")[e.data.id];if(!t)throw Error("Received a RunStepDelta before creation of a snapshot");let o=e.data;if(o.delta){let r=di.accumulateDelta(t,o.delta);T(this,go,"f")[e.data.id]=r}return T(this,go,"f")[e.data.id];case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":case"thread.run.step.in_progress":T(this,go,"f")[e.data.id]=e.data;break}if(T(this,go,"f")[e.data.id])return T(this,go,"f")[e.data.id];throw new Error("No snapshot available")},Dw=function(e,t){let o=[];switch(e.event){case"thread.message.created":return[e.data,o];case"thread.message.delta":if(!t)throw Error("Received a delta with no existing snapshot (there should be one from message creation)");let r=e.data;if(r.delta.content)for(let i of r.delta.content)if(i.index in t.content){let a=t.content[i.index];t.content[i.index]=T(this,zt,"m",qw).call(this,i,a)}else t.content[i.index]=i,o.push(i);return[t,o];case"thread.message.in_progress":case"thread.message.completed":case"thread.message.incomplete":if(t)return[t,o];throw Error("Received thread message event with no existing snapshot")}throw Error("Tried to accumulate a non-message event")},qw=function(e,t){return di.accumulateDelta(t,e)},Fw=function(e){switch(W(this,kd,e.data,"f"),e.event){case"thread.run.created":break;case"thread.run.queued":break;case"thread.run.in_progress":break;case"thread.run.requires_action":case"thread.run.cancelled":case"thread.run.failed":case"thread.run.completed":case"thread.run.expired":case"thread.run.incomplete":W(this,pi,e.data,"f"),T(this,Pn,"f")&&(this._emit("toolCallDone",T(this,Pn,"f")),W(this,Pn,void 0,"f"));break;case"thread.run.cancelling":break}};var mi=class extends O{constructor(){super(...arguments),this.steps=new Wa(this._client)}create(e,t,o){let{include:r,...i}=t;return this._client.post(E`/threads/${e}/runs`,{query:{include:r},body:i,...o,headers:N([{"OpenAI-Beta":"assistants=v2"},o?.headers]),stream:t.stream??!1})}retrieve(e,t,o){let{thread_id:r}=t;return this._client.get(E`/threads/${r}/runs/${e}`,{...o,headers:N([{"OpenAI-Beta":"assistants=v2"},o?.headers])})}update(e,t,o){let{thread_id:r,...i}=t;return this._client.post(E`/threads/${r}/runs/${e}`,{body:i,...o,headers:N([{"OpenAI-Beta":"assistants=v2"},o?.headers])})}list(e,t={},o){return this._client.getAPIList(E`/threads/${e}/runs`,ae,{query:t,...o,headers:N([{"OpenAI-Beta":"assistants=v2"},o?.headers])})}cancel(e,t,o){let{thread_id:r}=t;return this._client.post(E`/threads/${r}/runs/${e}/cancel`,{...o,headers:N([{"OpenAI-Beta":"assistants=v2"},o?.headers])})}async createAndPoll(e,t,o){let r=await this.create(e,t,o);return await this.poll(r.id,{thread_id:e},o)}createAndStream(e,t,o){return jo.createAssistantStream(e,this._client.beta.threads.runs,t,o)}async poll(e,t,o){let r=N([o?.headers,{"X-Stainless-Poll-Helper":"true","X-Stainless-Custom-Poll-Interval":o?.pollIntervalMs?.toString()??void 0}]);for(;;){let{data:i,response:a}=await this.retrieve(e,t,{...o,headers:{...o?.headers,...r}}).withResponse();switch(i.status){case"queued":case"in_progress":case"cancelling":let s=5e3;if(o?.pollIntervalMs)s=o.pollIntervalMs;else{let c=a.headers.get("openai-poll-after-ms");if(c){let l=parseInt(c);isNaN(l)||(s=l)}}await uo(s);break;case"requires_action":case"incomplete":case"cancelled":case"completed":case"failed":case"expired":return i}}}stream(e,t,o){return jo.createAssistantStream(e,this._client.beta.threads.runs,t,o)}submitToolOutputs(e,t,o){let{thread_id:r,...i}=t;return this._client.post(E`/threads/${r}/runs/${e}/submit_tool_outputs`,{body:i,...o,headers:N([{"OpenAI-Beta":"assistants=v2"},o?.headers]),stream:t.stream??!1})}async submitToolOutputsAndPoll(e,t,o){let r=await this.submitToolOutputs(e,t,o);return await this.poll(r.id,t,o)}submitToolOutputsStream(e,t,o){return jo.createToolAssistantStream(e,this._client.beta.threads.runs,t,o)}};mi.Steps=Wa;var Ir=class extends O{constructor(){super(...arguments),this.runs=new mi(this._client),this.messages=new Qa(this._client)}create(e={},t){return this._client.post("/threads",{body:e,...t,headers:N([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}retrieve(e,t){return this._client.get(E`/threads/${e}`,{...t,headers:N([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}update(e,t,o){return this._client.post(E`/threads/${e}`,{body:t,...o,headers:N([{"OpenAI-Beta":"assistants=v2"},o?.headers])})}delete(e,t){return this._client.delete(E`/threads/${e}`,{...t,headers:N([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}createAndRun(e,t){return this._client.post("/threads/runs",{body:e,...t,headers:N([{"OpenAI-Beta":"assistants=v2"},t?.headers]),stream:e.stream??!1})}async createAndRunPoll(e,t){let o=await this.createAndRun(e,t);return await this.runs.poll(o.id,{thread_id:o.thread_id},t)}createAndRunStream(e,t){return jo.createThreadAssistantStream(e,this._client.beta.threads,t)}};Ir.Runs=mi;Ir.Messages=Qa;var Hn=class extends O{constructor(){super(...arguments),this.realtime=new _r(this._client),this.chatkit=new Cr(this._client),this.assistants=new Ka(this._client),this.threads=new Ir(this._client)}};Hn.Realtime=_r;Hn.ChatKit=Cr;Hn.Assistants=Ka;Hn.Threads=Ir;var fi=class extends O{create(e,t){return this._client.post("/completions",{body:e,...t,stream:e.stream??!1})}};var Xa=class extends O{retrieve(e,t,o){let{container_id:r}=t;return this._client.get(E`/containers/${r}/files/${e}/content`,{...o,headers:N([{Accept:"application/binary"},o?.headers]),__binaryResponse:!0})}};var hi=class extends O{constructor(){super(...arguments),this.content=new Xa(this._client)}create(e,t,o){return this._client.post(E`/containers/${e}/files`,An({body:t,...o},this._client))}retrieve(e,t,o){let{container_id:r}=t;return this._client.get(E`/containers/${r}/files/${e}`,o)}list(e,t={},o){return this._client.getAPIList(E`/containers/${e}/files`,ae,{query:t,...o})}delete(e,t,o){let{container_id:r}=t;return this._client.delete(E`/containers/${r}/files/${e}`,{...o,headers:N([{Accept:"*/*"},o?.headers])})}};hi.Content=Xa;var Ar=class extends O{constructor(){super(...arguments),this.files=new hi(this._client)}create(e,t){return this._client.post("/containers",{body:e,...t})}retrieve(e,t){return this._client.get(E`/containers/${e}`,t)}list(e={},t){return this._client.getAPIList("/containers",ae,{query:e,...t})}delete(e,t){return this._client.delete(E`/containers/${e}`,{...t,headers:N([{Accept:"*/*"},t?.headers])})}};Ar.Files=hi;var Ya=class extends O{create(e,t,o){let{include:r,...i}=t;return this._client.post(E`/conversations/${e}/items`,{query:{include:r},body:i,...o})}retrieve(e,t,o){let{conversation_id:r,...i}=t;return this._client.get(E`/conversations/${r}/items/${e}`,{query:i,...o})}list(e,t={},o){return this._client.getAPIList(E`/conversations/${e}/items`,qo,{query:t,...o})}delete(e,t,o){let{conversation_id:r}=t;return this._client.delete(E`/conversations/${r}/items/${e}`,o)}};var Pr=class extends O{constructor(){super(...arguments),this.items=new Ya(this._client)}create(e={},t){return this._client.post("/conversations",{body:e,...t})}retrieve(e,t){return this._client.get(E`/conversations/${e}`,t)}update(e,t,o){return this._client.post(E`/conversations/${e}`,{body:t,...o})}delete(e,t){return this._client.delete(E`/conversations/${e}`,t)}};Pr.Items=Ya;var gi=class extends O{create(e,t){let o=!!e.encoding_format,r=o?e.encoding_format:"base64";o&&at(this._client).debug("embeddings/user defined encoding_format:",e.encoding_format);let i=this._client.post("/embeddings",{body:{...e,encoding_format:r},...t});return o?i:(at(this._client).debug("embeddings/decoding base64 embeddings from base64"),i._thenUnwrap(a=>(a&&a.data&&a.data.forEach(s=>{let c=s.embedding;s.embedding=Rw(c)}),a)))}};var es=class extends O{retrieve(e,t,o){let{eval_id:r,run_id:i}=t;return this._client.get(E`/evals/${r}/runs/${i}/output_items/${e}`,o)}list(e,t,o){let{eval_id:r,...i}=t;return this._client.getAPIList(E`/evals/${r}/runs/${e}/output_items`,ae,{query:i,...o})}};var vi=class extends O{constructor(){super(...arguments),this.outputItems=new es(this._client)}create(e,t,o){return this._client.post(E`/evals/${e}/runs`,{body:t,...o})}retrieve(e,t,o){let{eval_id:r}=t;return this._client.get(E`/evals/${r}/runs/${e}`,o)}list(e,t={},o){return this._client.getAPIList(E`/evals/${e}/runs`,ae,{query:t,...o})}delete(e,t,o){let{eval_id:r}=t;return this._client.delete(E`/evals/${r}/runs/${e}`,o)}cancel(e,t,o){let{eval_id:r}=t;return this._client.post(E`/evals/${r}/runs/${e}`,o)}};vi.OutputItems=es;var Mr=class extends O{constructor(){super(...arguments),this.runs=new vi(this._client)}create(e,t){return this._client.post("/evals",{body:e,...t})}retrieve(e,t){return this._client.get(E`/evals/${e}`,t)}update(e,t,o){return this._client.post(E`/evals/${e}`,{body:t,...o})}list(e={},t){return this._client.getAPIList("/evals",ae,{query:e,...t})}delete(e,t){return this._client.delete(E`/evals/${e}`,t)}};Mr.Runs=vi;var yi=class extends O{create(e,t){return this._client.post("/files",An({body:e,...t},this._client))}retrieve(e,t){return this._client.get(E`/files/${e}`,t)}list(e={},t){return this._client.getAPIList("/files",ae,{query:e,...t})}delete(e,t){return this._client.delete(E`/files/${e}`,t)}content(e,t){return this._client.get(E`/files/${e}/content`,{...t,headers:N([{Accept:"application/binary"},t?.headers]),__binaryResponse:!0})}async waitForProcessing(e,{pollInterval:t=5e3,maxWait:o=1800*1e3}={}){let r=new Set(["processed","error","deleted"]),i=Date.now(),a=await this.retrieve(e);for(;!a.status||!r.has(a.status);)if(await uo(t),a=await this.retrieve(e),Date.now()-i>o)throw new yr({message:`Giving up on waiting for file ${e} to finish processing after ${o} milliseconds.`});return a}};var ts=class extends O{};var ns=class extends O{run(e,t){return this._client.post("/fine_tuning/alpha/graders/run",{body:e,...t})}validate(e,t){return this._client.post("/fine_tuning/alpha/graders/validate",{body:e,...t})}};var xi=class extends O{constructor(){super(...arguments),this.graders=new ns(this._client)}};xi.Graders=ns;var os=class extends O{create(e,t,o){return this._client.getAPIList(E`/fine_tuning/checkpoints/${e}/permissions`,fo,{body:t,method:"post",...o})}retrieve(e,t={},o){return this._client.get(E`/fine_tuning/checkpoints/${e}/permissions`,{query:t,...o})}delete(e,t,o){let{fine_tuned_model_checkpoint:r}=t;return this._client.delete(E`/fine_tuning/checkpoints/${r}/permissions/${e}`,o)}};var bi=class extends O{constructor(){super(...arguments),this.permissions=new os(this._client)}};bi.Permissions=os;var rs=class extends O{list(e,t={},o){return this._client.getAPIList(E`/fine_tuning/jobs/${e}/checkpoints`,ae,{query:t,...o})}};var wi=class extends O{constructor(){super(...arguments),this.checkpoints=new rs(this._client)}create(e,t){return this._client.post("/fine_tuning/jobs",{body:e,...t})}retrieve(e,t){return this._client.get(E`/fine_tuning/jobs/${e}`,t)}list(e={},t){return this._client.getAPIList("/fine_tuning/jobs",ae,{query:e,...t})}cancel(e,t){return this._client.post(E`/fine_tuning/jobs/${e}/cancel`,t)}listEvents(e,t={},o){return this._client.getAPIList(E`/fine_tuning/jobs/${e}/events`,ae,{query:t,...o})}pause(e,t){return this._client.post(E`/fine_tuning/jobs/${e}/pause`,t)}resume(e,t){return this._client.post(E`/fine_tuning/jobs/${e}/resume`,t)}};wi.Checkpoints=rs;var Zn=class extends O{constructor(){super(...arguments),this.methods=new ts(this._client),this.jobs=new wi(this._client),this.checkpoints=new bi(this._client),this.alpha=new xi(this._client)}};Zn.Methods=ts;Zn.Jobs=wi;Zn.Checkpoints=bi;Zn.Alpha=xi;var is=class extends O{};var Sr=class extends O{constructor(){super(...arguments),this.graderModels=new is(this._client)}};Sr.GraderModels=is;var ki=class extends O{createVariation(e,t){return this._client.post("/images/variations",An({body:e,...t},this._client))}edit(e,t){return this._client.post("/images/edits",An({body:e,...t,stream:e.stream??!1},this._client))}generate(e,t){return this._client.post("/images/generations",{body:e,...t,stream:e.stream??!1})}};var _i=class extends O{retrieve(e,t){return this._client.get(E`/models/${e}`,t)}list(e){return this._client.getAPIList("/models",fo,e)}delete(e,t){return this._client.delete(E`/models/${e}`,t)}};var Ci=class extends O{create(e,t){return this._client.post("/moderations",{body:e,...t})}};var as=class extends O{accept(e,t,o){return this._client.post(E`/realtime/calls/${e}/accept`,{body:t,...o,headers:N([{Accept:"*/*"},o?.headers])})}hangup(e,t){return this._client.post(E`/realtime/calls/${e}/hangup`,{...t,headers:N([{Accept:"*/*"},t?.headers])})}refer(e,t,o){return this._client.post(E`/realtime/calls/${e}/refer`,{body:t,...o,headers:N([{Accept:"*/*"},o?.headers])})}reject(e,t={},o){return this._client.post(E`/realtime/calls/${e}/reject`,{body:t,...o,headers:N([{Accept:"*/*"},o?.headers])})}};var ss=class extends O{create(e,t){return this._client.post("/realtime/client_secrets",{body:e,...t})}};var Ko=class extends O{constructor(){super(...arguments),this.clientSecrets=new ss(this._client),this.calls=new as(this._client)}};Ko.ClientSecrets=ss;Ko.Calls=as;function Bw(n,e){return!e||!m$(e)?{...n,output_parsed:null,output:n.output.map(t=>t.type==="function_call"?{...t,parsed_arguments:null}:t.type==="message"?{...t,content:t.content.map(o=>({...o,parsed:null}))}:t)}:Hf(n,e)}function Hf(n,e){let t=n.output.map(r=>{if(r.type==="function_call")return{...r,parsed_arguments:g$(e,r)};if(r.type==="message"){let i=r.content.map(a=>a.type==="output_text"?{...a,parsed:p$(e,a.text)}:a);return{...r,content:i}}return r}),o=Object.assign({},n,{output:t});return Object.getOwnPropertyDescriptor(n,"output_text")||Cd(o),Object.defineProperty(o,"output_parsed",{enumerable:!0,get(){for(let r of o.output)if(r.type==="message"){for(let i of r.content)if(i.type==="output_text"&&i.parsed!==null)return i.parsed}return null}}),o}function p$(n,e){return n.text?.format?.type!=="json_schema"?null:"$parseRaw"in n.text?.format?(n.text?.format).$parseRaw(e):JSON.parse(e)}function m$(n){return!!Uc(n.text?.format)}function f$(n){return n?.$brand==="auto-parseable-tool"}function h$(n,e){return n.find(t=>t.type==="function"&&t.name===e)}function g$(n,e){let t=h$(n.tools??[],e.name);return{...e,...e,parsed_arguments:f$(t)?t.$parseRaw(e.arguments):t?.strict?JSON.parse(e.arguments):null}}function Cd(n){let e=[];for(let t of n.output)if(t.type==="message")for(let o of t.content)o.type==="output_text"&&e.push(o.text);n.output_text=e.join("")}var cs,Td,$r,Id,Uw,jw,Kw,Hw,Ad=class n extends br{constructor(e){super(),cs.add(this),Td.set(this,void 0),$r.set(this,void 0),Id.set(this,void 0),W(this,Td,e,"f")}static createResponse(e,t,o){let r=new n(t);return r._run(()=>r._createOrRetrieveResponse(e,t,{...o,headers:{...o?.headers,"X-Stainless-Helper-Method":"stream"}})),r}async _createOrRetrieveResponse(e,t,o){let r=o?.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort())),T(this,cs,"m",Uw).call(this);let i,a=null;"response_id"in t?(i=await e.responses.retrieve(t.response_id,{stream:!0},{...o,signal:this.controller.signal,stream:!0}),a=t.starting_after??null):i=await e.responses.create({...t,stream:!0},{...o,signal:this.controller.signal}),this._connected();for await(let s of i)T(this,cs,"m",jw).call(this,s,a);if(i.controller.signal?.aborted)throw new dt;return T(this,cs,"m",Kw).call(this)}[(Td=new WeakMap,$r=new WeakMap,Id=new WeakMap,cs=new WeakSet,Uw=function(){this.ended||W(this,$r,void 0,"f")},jw=function(t,o){if(this.ended)return;let r=(a,s)=>{(o==null||s.sequence_number>o)&&this._emit(a,s)},i=T(this,cs,"m",Hw).call(this,t);switch(r("event",t),t.type){case"response.output_text.delta":{let a=i.output[t.output_index];if(!a)throw new H(`missing output at index ${t.output_index}`);if(a.type==="message"){let s=a.content[t.content_index];if(!s)throw new H(`missing content at index ${t.content_index}`);if(s.type!=="output_text")throw new H(`expected content to be 'output_text', got ${s.type}`);r("response.output_text.delta",{...t,snapshot:s.text})}break}case"response.function_call_arguments.delta":{let a=i.output[t.output_index];if(!a)throw new H(`missing output at index ${t.output_index}`);a.type==="function_call"&&r("response.function_call_arguments.delta",{...t,snapshot:a.arguments});break}default:r(t.type,t);break}},Kw=function(){if(this.ended)throw new H("stream has ended, this shouldn't happen");let t=T(this,$r,"f");if(!t)throw new H("request ended without sending any events");W(this,$r,void 0,"f");let o=v$(t,T(this,Td,"f"));return W(this,Id,o,"f"),o},Hw=function(t){let o=T(this,$r,"f");if(!o){if(t.type!=="response.created")throw new H(`When snapshot hasn't been set yet, expected 'response.created' event, got ${t.type}`);return o=W(this,$r,t.response,"f"),o}switch(t.type){case"response.output_item.added":{o.output.push(t.item);break}case"response.content_part.added":{let r=o.output[t.output_index];if(!r)throw new H(`missing output at index ${t.output_index}`);let i=r.type,a=t.part;i==="message"&&a.type!=="reasoning_text"?r.content.push(a):i==="reasoning"&&a.type==="reasoning_text"&&(r.content||(r.content=[]),r.content.push(a));break}case"response.output_text.delta":{let r=o.output[t.output_index];if(!r)throw new H(`missing output at index ${t.output_index}`);if(r.type==="message"){let i=r.content[t.content_index];if(!i)throw new H(`missing content at index ${t.content_index}`);if(i.type!=="output_text")throw new H(`expected content to be 'output_text', got ${i.type}`);i.text+=t.delta}break}case"response.function_call_arguments.delta":{let r=o.output[t.output_index];if(!r)throw new H(`missing output at index ${t.output_index}`);r.type==="function_call"&&(r.arguments+=t.delta);break}case"response.reasoning_text.delta":{let r=o.output[t.output_index];if(!r)throw new H(`missing output at index ${t.output_index}`);if(r.type==="reasoning"){let i=r.content?.[t.content_index];if(!i)throw new H(`missing content at index ${t.content_index}`);if(i.type!=="reasoning_text")throw new H(`expected content to be 'reasoning_text', got ${i.type}`);i.text+=t.delta}break}case"response.completed":{W(this,$r,t.response,"f");break}}return o},Symbol.asyncIterator)](){let e=[],t=[],o=!1;return this.on("event",r=>{let i=t.shift();i?i.resolve(r):e.push(r)}),this.on("end",()=>{o=!0;for(let r of t)r.resolve(void 0);t.length=0}),this.on("abort",r=>{o=!0;for(let i of t)i.reject(r);t.length=0}),this.on("error",r=>{o=!0;for(let i of t)i.reject(r);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:o?{value:void 0,done:!0}:new Promise((i,a)=>t.push({resolve:i,reject:a})).then(i=>i?{value:i,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}async finalResponse(){await this.done();let e=T(this,Id,"f");if(!e)throw new H("stream ended without producing a ChatCompletion");return e}};function v$(n,e){return Bw(n,e)}var ls=class extends O{list(e,t={},o){return this._client.getAPIList(E`/responses/${e}/input_items`,ae,{query:t,...o})}};var us=class extends O{count(e={},t){return this._client.post("/responses/input_tokens",{body:e,...t})}};var Ho=class extends O{constructor(){super(...arguments),this.inputItems=new ls(this._client),this.inputTokens=new us(this._client)}create(e,t){return this._client.post("/responses",{body:e,...t,stream:e.stream??!1})._thenUnwrap(o=>("object"in o&&o.object==="response"&&Cd(o),o))}retrieve(e,t={},o){return this._client.get(E`/responses/${e}`,{query:t,...o,stream:t?.stream??!1})._thenUnwrap(r=>("object"in r&&r.object==="response"&&Cd(r),r))}delete(e,t){return this._client.delete(E`/responses/${e}`,{...t,headers:N([{Accept:"*/*"},t?.headers])})}parse(e,t){return this._client.responses.create(e,t)._thenUnwrap(o=>Hf(o,e))}stream(e,t){return Ad.createResponse(this._client,e,t)}cancel(e,t){return this._client.post(E`/responses/${e}/cancel`,t)}compact(e,t){return this._client.post("/responses/compact",{body:e,...t})}};Ho.InputItems=ls;Ho.InputTokens=us;var ds=class extends O{create(e,t,o){return this._client.post(E`/uploads/${e}/parts`,An({body:t,...o},this._client))}};var Er=class extends O{constructor(){super(...arguments),this.parts=new ds(this._client)}create(e,t){return this._client.post("/uploads",{body:e,...t})}cancel(e,t){return this._client.post(E`/uploads/${e}/cancel`,t)}complete(e,t,o){return this._client.post(E`/uploads/${e}/complete`,{body:t,...o})}};Er.Parts=ds;var Zw=async n=>{let e=await Promise.allSettled(n),t=e.filter(r=>r.status==="rejected");if(t.length){for(let r of t)console.error(r.reason);throw new Error(`${t.length} promise(s) failed - see the above errors`)}let o=[];for(let r of e)r.status==="fulfilled"&&o.push(r.value);return o};var ps=class extends O{create(e,t,o){return this._client.post(E`/vector_stores/${e}/file_batches`,{body:t,...o,headers:N([{"OpenAI-Beta":"assistants=v2"},o?.headers])})}retrieve(e,t,o){let{vector_store_id:r}=t;return this._client.get(E`/vector_stores/${r}/file_batches/${e}`,{...o,headers:N([{"OpenAI-Beta":"assistants=v2"},o?.headers])})}cancel(e,t,o){let{vector_store_id:r}=t;return this._client.post(E`/vector_stores/${r}/file_batches/${e}/cancel`,{...o,headers:N([{"OpenAI-Beta":"assistants=v2"},o?.headers])})}async createAndPoll(e,t,o){let r=await this.create(e,t);return await this.poll(e,r.id,o)}listFiles(e,t,o){let{vector_store_id:r,...i}=t;return this._client.getAPIList(E`/vector_stores/${r}/file_batches/${e}/files`,ae,{query:i,...o,headers:N([{"OpenAI-Beta":"assistants=v2"},o?.headers])})}async poll(e,t,o){let r=N([o?.headers,{"X-Stainless-Poll-Helper":"true","X-Stainless-Custom-Poll-Interval":o?.pollIntervalMs?.toString()??void 0}]);for(;;){let{data:i,response:a}=await this.retrieve(t,{vector_store_id:e},{...o,headers:r}).withResponse();switch(i.status){case"in_progress":let s=5e3;if(o?.pollIntervalMs)s=o.pollIntervalMs;else{let c=a.headers.get("openai-poll-after-ms");if(c){let l=parseInt(c);isNaN(l)||(s=l)}}await uo(s);break;case"failed":case"cancelled":case"completed":return i}}}async uploadAndPoll(e,{files:t,fileIds:o=[]},r){if(t==null||t.length==0)throw new Error("No `files` provided to process. If you've already uploaded files you should use `.createAndPoll()` instead");let i=r?.maxConcurrency??5,a=Math.min(i,t.length),s=this._client,c=t.values(),l=[...o];async function d(f){for(let m of f){let h=await s.files.create({file:m,purpose:"assistants"},r);l.push(h.id)}}let p=Array(a).fill(c).map(d);return await Zw(p),await this.createAndPoll(e,{file_ids:l})}};var ms=class extends O{create(e,t,o){return this._client.post(E`/vector_stores/${e}/files`,{body:t,...o,headers:N([{"OpenAI-Beta":"assistants=v2"},o?.headers])})}retrieve(e,t,o){let{vector_store_id:r}=t;return this._client.get(E`/vector_stores/${r}/files/${e}`,{...o,headers:N([{"OpenAI-Beta":"assistants=v2"},o?.headers])})}update(e,t,o){let{vector_store_id:r,...i}=t;return this._client.post(E`/vector_stores/${r}/files/${e}`,{body:i,...o,headers:N([{"OpenAI-Beta":"assistants=v2"},o?.headers])})}list(e,t={},o){return this._client.getAPIList(E`/vector_stores/${e}/files`,ae,{query:t,...o,headers:N([{"OpenAI-Beta":"assistants=v2"},o?.headers])})}delete(e,t,o){let{vector_store_id:r}=t;return this._client.delete(E`/vector_stores/${r}/files/${e}`,{...o,headers:N([{"OpenAI-Beta":"assistants=v2"},o?.headers])})}async createAndPoll(e,t,o){let r=await this.create(e,t,o);return await this.poll(e,r.id,o)}async poll(e,t,o){let r=N([o?.headers,{"X-Stainless-Poll-Helper":"true","X-Stainless-Custom-Poll-Interval":o?.pollIntervalMs?.toString()??void 0}]);for(;;){let i=await this.retrieve(t,{vector_store_id:e},{...o,headers:r}).withResponse(),a=i.data;switch(a.status){case"in_progress":let s=5e3;if(o?.pollIntervalMs)s=o.pollIntervalMs;else{let c=i.response.headers.get("openai-poll-after-ms");if(c){let l=parseInt(c);isNaN(l)||(s=l)}}await uo(s);break;case"failed":case"completed":return a}}}async upload(e,t,o){let r=await this._client.files.create({file:t,purpose:"assistants"},o);return this.create(e,{file_id:r.id},o)}async uploadAndPoll(e,t,o){let r=await this.upload(e,t,o);return await this.poll(e,r.id,o)}content(e,t,o){let{vector_store_id:r}=t;return this._client.getAPIList(E`/vector_stores/${r}/files/${e}/content`,fo,{...o,headers:N([{"OpenAI-Beta":"assistants=v2"},o?.headers])})}};var Zo=class extends O{constructor(){super(...arguments),this.files=new ms(this._client),this.fileBatches=new ps(this._client)}create(e,t){return this._client.post("/vector_stores",{body:e,...t,headers:N([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}retrieve(e,t){return this._client.get(E`/vector_stores/${e}`,{...t,headers:N([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}update(e,t,o){return this._client.post(E`/vector_stores/${e}`,{body:t,...o,headers:N([{"OpenAI-Beta":"assistants=v2"},o?.headers])})}list(e={},t){return this._client.getAPIList("/vector_stores",ae,{query:e,...t,headers:N([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}delete(e,t){return this._client.delete(E`/vector_stores/${e}`,{...t,headers:N([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}search(e,t,o){return this._client.getAPIList(E`/vector_stores/${e}/search`,fo,{body:t,method:"post",...o,headers:N([{"OpenAI-Beta":"assistants=v2"},o?.headers])})}};Zo.Files=ms;Zo.FileBatches=ps;var Ti=class extends O{create(e,t){return this._client.post("/videos",Af({body:e,...t},this._client))}retrieve(e,t){return this._client.get(E`/videos/${e}`,t)}list(e={},t){return this._client.getAPIList("/videos",qo,{query:e,...t})}delete(e,t){return this._client.delete(E`/videos/${e}`,t)}downloadContent(e,t={},o){return this._client.get(E`/videos/${e}/content`,{query:t,...o,headers:N([{Accept:"application/binary"},o?.headers]),__binaryResponse:!0})}remix(e,t,o){return this._client.post(E`/videos/${e}/remix`,Af({body:t,...o},this._client))}};var fs,Gw,Pd,Ii=class extends O{constructor(){super(...arguments),fs.add(this)}async unwrap(e,t,o=this._client.webhookSecret,r=300){return await this.verifySignature(e,t,o,r),JSON.parse(e)}async verifySignature(e,t,o=this._client.webhookSecret,r=300){if(typeof crypto>"u"||typeof crypto.subtle.importKey!="function"||typeof crypto.subtle.verify!="function")throw new Error("Webhook signature verification is only supported when the `crypto` global is defined");T(this,fs,"m",Gw).call(this,o);let i=N([t]).values,a=T(this,fs,"m",Pd).call(this,i,"webhook-signature"),s=T(this,fs,"m",Pd).call(this,i,"webhook-timestamp"),c=T(this,fs,"m",Pd).call(this,i,"webhook-id"),l=parseInt(s,10);if(isNaN(l))throw new lo("Invalid webhook timestamp format");let d=Math.floor(Date.now()/1e3);if(d-l>r)throw new lo("Webhook timestamp is too old");if(l>d+r)throw new lo("Webhook timestamp is too new");let p=a.split(" ").map(g=>g.startsWith("v1,")?g.substring(3):g),f=o.startsWith("whsec_")?Buffer.from(o.replace("whsec_",""),"base64"):Buffer.from(o,"utf-8"),m=c?`${c}.${s}.${e}`:`${s}.${e}`,h=await crypto.subtle.importKey("raw",f,{name:"HMAC",hash:"SHA-256"},!1,["verify"]);for(let g of p)try{let v=Buffer.from(g,"base64");if(await crypto.subtle.verify("HMAC",h,v,new TextEncoder().encode(m)))return}catch{continue}throw new lo("The given webhook signature does not match the expected signature")}};fs=new WeakSet,Gw=function(e){if(typeof e!="string"||e.length===0)throw new Error("The webhook secret must either be set using the env var, OPENAI_WEBHOOK_SECRET, on the client class, OpenAI({ webhookSecret: '123' }), or passed to this function")},Pd=function(e,t){if(!e)throw new Error("Headers are required");let o=e.get(t);if(o==null)throw new Error(`Missing required header: ${t}`);return o};var Zf,Gf,Md,Vw,G=class{constructor({baseURL:e=Tr("OPENAI_BASE_URL"),apiKey:t=Tr("OPENAI_API_KEY"),organization:o=Tr("OPENAI_ORG_ID")??null,project:r=Tr("OPENAI_PROJECT_ID")??null,webhookSecret:i=Tr("OPENAI_WEBHOOK_SECRET")??null,...a}={}){if(Zf.add(this),Md.set(this,void 0),this.completions=new fi(this),this.chat=new kr(this),this.embeddings=new gi(this),this.files=new yi(this),this.images=new ki(this),this.audio=new ho(this),this.moderations=new Ci(this),this.models=new _i(this),this.fineTuning=new Zn(this),this.graders=new Sr(this),this.vectorStores=new Zo(this),this.webhooks=new Ii(this),this.beta=new Hn(this),this.batches=new li(this),this.uploads=new Er(this),this.responses=new Ho(this),this.realtime=new Ko(this),this.conversations=new Pr(this),this.evals=new Mr(this),this.containers=new Ar(this),this.videos=new Ti(this),t===void 0)throw new H("Missing credentials. Please pass an `apiKey`, or set the `OPENAI_API_KEY` environment variable.");let s={apiKey:t,organization:o,project:r,webhookSecret:i,...a,baseURL:e||"https://api.openai.com/v1"};if(!s.dangerouslyAllowBrowser&&tw())throw new H(`It looks like you're running in a browser-like environment.

This is disabled by default, as it risks exposing your secret API credentials to attackers.
If you understand the risks and have appropriate mitigations in place,
you can set the \`dangerouslyAllowBrowser\` option to \`true\`, e.g.,

new OpenAI({ apiKey, dangerouslyAllowBrowser: true });

https://help.openai.com/en/articles/5112595-best-practices-for-api-key-safety
`);this.baseURL=s.baseURL,this.timeout=s.timeout??Gf.DEFAULT_TIMEOUT,this.logger=s.logger??console;let c="warn";this.logLevel=c,this.logLevel=wf(s.logLevel,"ClientOptions.logLevel",this)??wf(Tr("OPENAI_LOG"),"process.env['OPENAI_LOG']",this)??c,this.fetchOptions=s.fetchOptions,this.maxRetries=s.maxRetries??2,this.fetch=s.fetch??ow(),W(this,Md,iw,"f"),this._options=s,this.apiKey=typeof t=="string"?t:"Missing Key",this.organization=o,this.project=r,this.webhookSecret=i}withOptions(e){return new this.constructor({...this._options,baseURL:this.baseURL,maxRetries:this.maxRetries,timeout:this.timeout,logger:this.logger,logLevel:this.logLevel,fetch:this.fetch,fetchOptions:this.fetchOptions,apiKey:this.apiKey,organization:this.organization,project:this.project,webhookSecret:this.webhookSecret,...e})}defaultQuery(){return this._options.defaultQuery}validateHeaders({values:e,nulls:t}){}async authHeaders(e){return N([{Authorization:`Bearer ${this.apiKey}`}])}stringifyQuery(e){return xf(e,{arrayFormat:"brackets"})}getUserAgent(){return`${this.constructor.name}/JS ${xr}`}defaultIdempotencyKey(){return`stainless-node-retry-${lf()}`}makeStatusError(e,t,o,r){return bt.generate(e,t,o,r)}async _callApiKey(){let e=this._options.apiKey;if(typeof e!="function")return!1;let t;try{t=await e()}catch(o){throw o instanceof H?o:new H(`Failed to get token from 'apiKey' function: ${o.message}`,{cause:o})}if(typeof t!="string"||!t)throw new H(`Expected 'apiKey' function argument to return a string but it returned ${t}`);return this.apiKey=t,!0}buildURL(e,t,o){let r=!T(this,Zf,"m",Vw).call(this)&&o||this.baseURL,i=Gb(e)?new URL(e):new URL(r+(r.endsWith("/")&&e.startsWith("/")?e.slice(1):e)),a=this.defaultQuery();return Vb(a)||(t={...a,...t}),typeof t=="object"&&t&&!Array.isArray(t)&&(i.search=this.stringifyQuery(t)),i.toString()}async prepareOptions(e){await this._callApiKey()}async prepareRequest(e,{url:t,options:o}){}get(e,t){return this.methodRequest("get",e,t)}post(e,t){return this.methodRequest("post",e,t)}patch(e,t){return this.methodRequest("patch",e,t)}put(e,t){return this.methodRequest("put",e,t)}delete(e,t){return this.methodRequest("delete",e,t)}methodRequest(e,t,o){return this.request(Promise.resolve(o).then(r=>({method:e,path:t,...r})))}request(e,t=null){return new ii(this,this.makeRequest(e,t,void 0))}async makeRequest(e,t,o){let r=await e,i=r.maxRetries??this.maxRetries;t==null&&(t=i),await this.prepareOptions(r);let{req:a,url:s,timeout:c}=await this.buildRequest(r,{retryCount:i-t});await this.prepareRequest(a,{url:s,options:r});let l="log_"+(Math.random()*(1<<24)|0).toString(16).padStart(6,"0"),d=o===void 0?"":`, retryOf: ${o}`,p=Date.now();if(at(this).debug(`[${l}] sending request`,Do({retryOfRequestLogID:o,method:r.method,url:s,options:r,headers:a.headers})),r.signal?.aborted)throw new dt;let f=new AbortController,m=await this.fetchWithTimeout(s,a,c,f).catch(Rc),h=Date.now();if(m instanceof globalThis.Error){let k=`retrying, ${t} attempts remaining`;if(r.signal?.aborted)throw new dt;let x=Ec(m)||/timed? ?out/i.test(String(m)+("cause"in m?String(m.cause):""));if(t)return at(this).info(`[${l}] connection ${x?"timed out":"failed"} - ${k}`),at(this).debug(`[${l}] connection ${x?"timed out":"failed"} (${k})`,Do({retryOfRequestLogID:o,url:s,durationMs:h-p,message:m.message})),this.retryRequest(r,t,o??l);throw at(this).info(`[${l}] connection ${x?"timed out":"failed"} - error; no more retries left`),at(this).debug(`[${l}] connection ${x?"timed out":"failed"} (error; no more retries left)`,Do({retryOfRequestLogID:o,url:s,durationMs:h-p,message:m.message})),x?new yr:new vr({cause:m})}let g=[...m.headers.entries()].filter(([k])=>k==="x-request-id").map(([k,x])=>", "+k+": "+JSON.stringify(x)).join(""),v=`[${l}${d}${g}] ${a.method} ${s} ${m.ok?"succeeded":"failed"} with status ${m.status} in ${h-p}ms`;if(!m.ok){let k=await this.shouldRetry(m);if(t&&k){let I=`retrying, ${t} attempts remaining`;return await rw(m.body),at(this).info(`${v} - ${I}`),at(this).debug(`[${l}] response error (${I})`,Do({retryOfRequestLogID:o,url:m.url,status:m.status,headers:m.headers,durationMs:h-p})),this.retryRequest(r,t,o??l,m.headers)}let x=k?"error; no more retries left":"error; not retryable";at(this).info(`${v} - ${x}`);let y=await m.text().catch(I=>Rc(I).message),w=Jb(y),b=w?void 0:y;throw at(this).debug(`[${l}] response error (${x})`,Do({retryOfRequestLogID:o,url:m.url,status:m.status,headers:m.headers,message:b,durationMs:Date.now()-p})),this.makeStatusError(m.status,w,b,m.headers)}return at(this).info(v),at(this).debug(`[${l}] response start`,Do({retryOfRequestLogID:o,url:m.url,status:m.status,headers:m.headers,durationMs:h-p})),{response:m,options:r,controller:f,requestLogID:l,retryOfRequestLogID:o,startTime:p}}getAPIList(e,t,o){return this.requestAPIList(t,{method:"get",path:e,...o})}requestAPIList(e,t){let o=this.makeRequest(t,null,void 0);return new qc(this,o,e)}async fetchWithTimeout(e,t,o,r){let{signal:i,method:a,...s}=t||{};i&&i.addEventListener("abort",()=>r.abort());let c=setTimeout(()=>r.abort(),o),l=globalThis.ReadableStream&&s.body instanceof globalThis.ReadableStream||typeof s.body=="object"&&s.body!==null&&Symbol.asyncIterator in s.body,d={signal:r.signal,...l?{duplex:"half"}:{},method:"GET",...s};a&&(d.method=a.toUpperCase());try{return await this.fetch.call(void 0,e,d)}finally{clearTimeout(c)}}async shouldRetry(e){let t=e.headers.get("x-should-retry");return t==="true"?!0:t==="false"?!1:e.status===408||e.status===409||e.status===429||e.status>=500}async retryRequest(e,t,o,r){let i,a=r?.get("retry-after-ms");if(a){let c=parseFloat(a);Number.isNaN(c)||(i=c)}let s=r?.get("retry-after");if(s&&!i){let c=parseFloat(s);Number.isNaN(c)?i=Date.parse(s)-Date.now():i=c*1e3}if(!(i&&0<=i&&i<60*1e3)){let c=e.maxRetries??this.maxRetries;i=this.calculateDefaultRetryTimeoutMillis(t,c)}return await uo(i),this.makeRequest(e,t-1,o)}calculateDefaultRetryTimeoutMillis(e,t){let i=t-e,a=Math.min(.5*Math.pow(2,i),8),s=1-Math.random()*.25;return a*s*1e3}async buildRequest(e,{retryCount:t=0}={}){let o={...e},{method:r,path:i,query:a,defaultBaseURL:s}=o,c=this.buildURL(i,a,s);"timeout"in o&&Wb("timeout",o.timeout),o.timeout=o.timeout??this.timeout;let{bodyHeaders:l,body:d}=this.buildBody({options:o}),p=await this.buildHeaders({options:e,method:r,bodyHeaders:l,retryCount:t});return{req:{method:r,headers:p,...o.signal&&{signal:o.signal},...globalThis.ReadableStream&&d instanceof globalThis.ReadableStream&&{duplex:"half"},...d&&{body:d},...this.fetchOptions??{},...o.fetchOptions??{}},url:c,timeout:o.timeout}}async buildHeaders({options:e,method:t,bodyHeaders:o,retryCount:r}){let i={};this.idempotencyHeader&&t!=="get"&&(e.idempotencyKey||(e.idempotencyKey=this.defaultIdempotencyKey()),i[this.idempotencyHeader]=e.idempotencyKey);let a=N([i,{Accept:"application/json","User-Agent":this.getUserAgent(),"X-Stainless-Retry-Count":String(r),...e.timeout?{"X-Stainless-Timeout":String(Math.trunc(e.timeout/1e3))}:{},...nw(),"OpenAI-Organization":this.organization,"OpenAI-Project":this.project},await this.authHeaders(e),this._options.defaultHeaders,o,e.headers]);return this.validateHeaders(a),a.values}buildBody({options:{body:e,headers:t}}){if(!e)return{bodyHeaders:void 0,body:void 0};let o=N([t]);return ArrayBuffer.isView(e)||e instanceof ArrayBuffer||e instanceof DataView||typeof e=="string"&&o.values.has("content-type")||globalThis.Blob&&e instanceof globalThis.Blob||e instanceof FormData||e instanceof URLSearchParams||globalThis.ReadableStream&&e instanceof globalThis.ReadableStream?{bodyHeaders:void 0,body:e}:typeof e=="object"&&(Symbol.asyncIterator in e||Symbol.iterator in e&&"next"in e&&typeof e.next=="function")?{bodyHeaders:void 0,body:td(e)}:T(this,Md,"f").call(this,{body:e,headers:o})}};Gf=G,Md=new WeakMap,Zf=new WeakSet,Vw=function(){return this.baseURL!=="https://api.openai.com/v1"};G.OpenAI=Gf;G.DEFAULT_TIMEOUT=6e5;G.OpenAIError=H;G.APIError=bt;G.APIConnectionError=vr;G.APIConnectionTimeoutError=yr;G.APIUserAbortError=dt;G.NotFoundError=Pa;G.ConflictError=Ma;G.RateLimitError=$a;G.BadRequestError=Ta;G.AuthenticationError=Ia;G.InternalServerError=Ea;G.PermissionDeniedError=Aa;G.UnprocessableEntityError=Sa;G.InvalidWebhookSignatureError=lo;G.toFile=ud;G.Completions=fi;G.Chat=kr;G.Embeddings=gi;G.Files=yi;G.Images=ki;G.Audio=ho;G.Moderations=Ci;G.Models=_i;G.FineTuning=Zn;G.Graders=Sr;G.VectorStores=Zo;G.Webhooks=Ii;G.Beta=Hn;G.Batches=li;G.Uploads=Er;G.Responses=Ho;G.Realtime=Ko;G.Conversations=Pr;G.Evals=Mr;G.Containers=Ar;G.Videos=Ti;var me=D(require("vscode"));cr();Ke();ot();ce();ce();var Ie=class n{static instances=new Map;lastRequestTime=0;requestCount=0;maxRequests;windowMs;constructor(e=2,t=1e3){this.maxRequests=e,this.windowMs=t}static getInstance(e,t=2,o=1e3){let r=n.instances.get(e);return r||(r=new n(t,o),n.instances.set(e,r)),r}async throttle(e){let t=Date.now(),o=t-this.lastRequestTime;if(o>=this.windowMs){this.lastRequestTime=t,this.requestCount=1;return}if(this.requestCount<this.maxRequests){this.requestCount++;return}let r=this.windowMs-o;return u.info(`[${e}] Rate limit reached (${this.maxRequests} req/${this.windowMs}ms). Throttling for ${r}ms...`),await new Promise(i=>setTimeout(i,r)),this.throttle(e)}};var hs=D(ck()),cn=D(require("vscode")),lk=require("vscode");ce();var oh=null,rh=null,ih=null,ah=class{constructor(e){this.maxSize=e}cache=new Map;get(e){let t=this.cache.get(e);return t!==void 0&&(this.cache.delete(e),this.cache.set(e,t)),t}put(e,t){if(this.cache.has(e))this.cache.delete(e);else if(this.cache.size>=this.maxSize){let o=this.cache.keys().next().value;o&&this.cache.delete(o)}this.cache.set(e,t)}},he=class n{constructor(e){this.tokenizer=e;this.tokenizer||(this.tokenizer=n.getSharedTokenizer())}tokenCache=new ah(5e3);static setExtensionPath(e){rh=e,u.trace("[TokenCounter] Extension path set")}static getInstance(){return ih||(ih=new n,u.trace("[TokenCounter] Global instance created")),ih}static getSharedTokenizer(){if(!oh){if(u.trace("[TokenCounter] First request for tokenizer, initializing global shared instance..."),!rh)throw new Error("[TokenCounter] Extension path not initialized, please call TokenCounter.setExtensionPath() first");let e=cn.Uri.file(rh),t=cn.Uri.joinPath(e,"dist","o200k_base.tiktoken").fsPath;oh=(0,hs.createTokenizer)(t,(0,hs.getSpecialTokensByEncoder)("o200k_base"),(0,hs.getRegexByEncoder)("o200k_base")),u.trace("[TokenCounter] Tokenizer initialization complete")}return oh}getTextTokenLength(e){if(!e)return 0;let t=this.tokenCache.get(e);if(t!==void 0)return t;let o=this.tokenizer?.encode(e)?.length??0;return this.tokenCache.put(e,o),o}stringifyUnknown(e){if(typeof e=="string")return e;try{return JSON.stringify(e)||""}catch{return String(e)}}async countMessagePartTokens(e){if(!e)return 0;if(e instanceof cn.LanguageModelTextPart)return this.getTextTokenLength(e.value);if(e instanceof cn.LanguageModelToolCallPart){let t=`${e.callId||""} ${e.name||""} ${this.stringifyUnknown(e.input)}`;return this.getTextTokenLength(t)}if(e instanceof cn.LanguageModelToolResultPart){let t=e.callId||"";for(let o of e.content||[])o instanceof cn.LanguageModelTextPart?t+=`
${o.value}`:t+=`
${this.stringifyUnknown(o)}`;return this.getTextTokenLength(t)}return e instanceof cn.LanguageModelPromptTsxPart?this.getTextTokenLength(this.stringifyUnknown(e.value)):typeof e=="string"||typeof e=="number"||typeof e=="boolean"?this.getTextTokenLength(String(e)):typeof e=="object"?this.countMessageObjectTokens(e,1):0}async countLanguageModelMessageTokens(e){let t=3;if(t+=this.getTextTokenLength(String(e.role)),typeof e.content=="string")return t+=this.getTextTokenLength(e.content),t;if(Array.isArray(e.content)){for(let o of e.content)t+=await this.countMessagePartTokens(o);return t}return t+=this.getTextTokenLength(this.stringifyUnknown(e.content)),t}async countTokens(e,t){if(typeof t=="string"){let o=this.tokenizer?.encode(t)?.length??0;return u.trace(`[Token Count] String: ${o} tokens (Length: ${t.length})`),o}try{return await this.countLanguageModelMessageTokens(t)}catch(o){u.warn("[Token Count] Failed to calculate message object tokens, using simplified calculation:",o);let r=this.tokenizer?.encode(JSON.stringify(t))?.length??0;return u.trace(`[Token Count] Fallback calculation: ${r} tokens`),r}}async countMessageObjectTokens(e,t=0){let o=0;t===0&&(o+=3);for(let[r,i]of Object.entries(e))if(i){if(typeof i=="string"){let a=this.getTextTokenLength(i);o+=a}else if(typeof i=="number"||typeof i=="boolean"){let a=this.getTextTokenLength(String(i));o+=a}else if(Array.isArray(i)){for(let a of i)if(typeof a=="string"){let s=this.getTextTokenLength(a);o+=s}else if(typeof a=="number"||typeof a=="boolean"){let s=this.getTextTokenLength(String(a));o+=s}else if(a&&typeof a=="object"){let s=await this.countMessageObjectTokens(a,t+2);o+=s}}else if(typeof i=="object"){let a=await this.countMessageObjectTokens(i,t+1);o+=a}}return o}async countMessagesTokens(e,t,o,r){let i=0;for(let s=0;s<t.length;s++){let c=t[s],l=await this.countTokens(e,c);i+=l}let a=o?.sdkMode||"openai";if(a==="anthropic"){let s=this.countSystemMessageTokens(t);s>0&&(i+=s);let c=this.countToolsTokens(r?.tools);c>0&&(i+=c)}else if(a==="openai"){let s=this.countToolsTokens(r?.tools);s>0&&(i+=s)}return i}countSystemMessageTokens(e){let t="";for(let a of e)a.role===lk.LanguageModelChatMessageRole.System&&(typeof a.content=="string"?t+=a.content:Array.isArray(a.content)&&(t+=a.content.map(s=>s instanceof cn.LanguageModelTextPart?s.value:s instanceof cn.LanguageModelPromptTsxPart?this.stringifyUnknown(s.value):this.stringifyUnknown(s)).filter(Boolean).join(`
`)));if(!t)return 0;let o=this.getTextTokenLength(t),r=28,i=o+r;return u.debug(`[Token Count] System message details: Content ${o} tokens + Wrapping overhead ${r} tokens = ${i} tokens`),i}countToolsTokens(e){let o=0;if(!e||e.length===0)return 0;o+=16;let r=8;for(let i of e){o+=r;let a={name:i.name,description:i.description||"",input_schema:i.inputSchema};for(let[,s]of Object.entries(a))typeof s=="string"?o+=this.getTextTokenLength(s):s&&typeof s=="object"&&(o+=this.getTextTokenLength(JSON.stringify(s)))}return Math.floor(o*1.1)}};var uk=D(require("vscode")),Gt=class n{static instance;emitter=new uk.EventEmitter;events=[];maxEvents=200;lastSuccessEvent;static getInstance(){return n.instance||(n.instance=new n),n.instance}onEvent(e){return this.emitter.event(e)}recordSuccess(e){let t=e.totalTokens??e.promptTokens+e.completionTokens,o={eventId:this.createEventId(),timestamp:Date.now(),status:"success",modelId:e.modelId,providerId:e.providerId,durationMs:e.durationMs,responseMetrics:{promptTokens:e.promptTokens,completionTokens:e.completionTokens,totalTokens:t,maxInputTokens:e.maxInputTokens,maxOutputTokens:e.maxOutputTokens,modelName:e.modelName,providerId:e.providerId,estimatedPromptTokens:e.estimatedPromptTokens}};this.pushEvent(o),this.lastSuccessEvent=o}recordError(e){let t={eventId:this.createEventId(),timestamp:Date.now(),status:"error",modelId:e.modelId,providerId:e.providerId,errorMessage:e.errorMessage,durationMs:e.durationMs};this.pushEvent(t)}recordCancelled(e){let t={eventId:this.createEventId(),timestamp:Date.now(),status:"cancelled",modelId:e.modelId,providerId:e.providerId,durationMs:e.durationMs};this.pushEvent(t)}getLastUsageSummary(){if(!this.lastSuccessEvent?.responseMetrics)return null;let e=this.lastSuccessEvent.responseMetrics,t=e.maxInputTokens||0,o=t>0?e.promptTokens/t*100:0;return{modelName:e.modelName||this.lastSuccessEvent.modelId||"Model",promptTokens:e.promptTokens,completionTokens:e.completionTokens,totalTokens:e.totalTokens,maxInputTokens:e.maxInputTokens,maxOutputTokens:e.maxOutputTokens,percentage:o,providerId:e.providerId,estimatedPromptTokens:e.estimatedPromptTokens}}computeAggregateStats(){let e=0,t=0,o=0,r=0,i=0,a=0,s=0,c=0;for(let l of this.events)l.status==="success"&&l.responseMetrics?(r++,e+=l.responseMetrics.totalTokens,t+=l.responseMetrics.promptTokens,o+=l.responseMetrics.completionTokens):l.status==="cancelled"?i++:l.status==="error"&&a++,typeof l.durationMs=="number"&&(s+=l.durationMs,c++);return{totalTokens:e,totalPromptTokens:t,totalCompletionTokens:o,successfulEvents:r,cancelledEvents:i,errorEvents:a,averageEventDuration:c>0?s/c:0}}pushEvent(e){this.events.push(e),this.events.length>this.maxEvents&&this.events.shift(),this.emitter.fire(e)}createEventId(){let e=Math.random().toString(36).slice(2,10);return`tok_${Date.now()}_${e}`}};var Ai=class n{constructor(e,t,o){this.provider=e;this.displayName=t;this.baseURL=o;this.cleanupInterval=setInterval(()=>this.cleanupExpiredClients(),6e4),this.quotaCache=it.getInstance()}currentRequestProcessedEvents=new Set;clientCache=new Map;CLIENT_CACHE_TTL=300*1e3;cleanupInterval;quotaCache;cleanupExpiredClients(){let e=Date.now();for(let[t,o]of this.clientCache.entries())e-o.lastUsed>this.CLIENT_CACHE_TTL&&(u.debug(`[${this.displayName}] Cleaning up expired OpenAI client: ${t}`),this.clientCache.delete(t))}dispose(){this.cleanupInterval&&clearInterval(this.cleanupInterval),this.clientCache.clear(),this.currentRequestProcessedEvents.clear(),u.debug(`[${this.displayName}] OpenAI Handler disposed`)}async createOpenAIClient(e,t){let o=e?.provider||this.provider,r=e?.apiKey;if(!r&&(r=await R.getApiKey(o),!r))throw new Error(`Missing ${this.displayName} API key`);let i=e?.baseUrl||this.baseURL;if(o==="zhipu"){let p=L.getZhipuEndpoint();i&&p==="api.z.ai"&&(i=i.replace("open.bigmodel.cn","api.z.ai"))}let a={"User-Agent":Nt.getUserAgent("OpenAI")},s=R.processCustomHeader(e?.customHeader,r);Object.keys(s).length>0&&(Object.assign(a,s),u.debug(`${this.displayName} apply custom headers: ${JSON.stringify(e?.customHeader)}`));let c=`${o}:${t||"default"}:${i}:${JSON.stringify(a)}`,l=this.clientCache.get(c);if(l)return l.lastUsed=Date.now(),u.debug(`[${this.displayName}] Reusing cached OpenAI client${t?` for account ${t}`:""}`),l.client;let d=new G({apiKey:r,baseURL:i,defaultHeaders:a,fetch:this.createCustomFetch(),maxRetries:2,timeout:6e4});return this.clientCache.set(c,{client:d,lastUsed:Date.now()}),u.debug(`${this.displayName} OpenAI SDK client created, using baseURL: ${i}${t?` for account ${t}`:""}`),d}createCustomFetch(){return async(e,t)=>{let o=await fetch(e,t);return await this.preprocessSSEResponse(o)}}async preprocessSSEResponse(e){let t=e.headers.get("Content-Type");if(t?.includes("application/json")){let s=await e.text();throw new Error(s||`HTTP ${e.status} ${e.statusText}`)}if(!t||!t.includes("text/event-stream")||!e.body)return e;let o=e.body.getReader(),r=new TextDecoder,i=new TextEncoder,a=new ReadableStream({async start(s){let c=new Map,l="",d="";try{for(;;){let{done:p,value:f}=await o.read();if(p){if(!c.get(0)){let h={id:l||`chatcmpl-${Date.now()}`,object:"chat.completion.chunk",created:Math.floor(Date.now()/1e3),model:d||"unknown",choices:[{index:0,delta:{},finish_reason:"stop"}]};s.enqueue(i.encode(`data: ${JSON.stringify(h)}

`))}s.close();break}let m=r.decode(f,{stream:!0});m=m.replace(/^data:([^\s])/gm,"data: $1");try{let h=/^data: (.*)$/gm,g=m,v=Array.from(m.matchAll(h));for(let k of v){let x=k[1];if(x!=="[DONE]")try{let y=JSON.parse(x);y.id&&(l=y.id),y.model&&(d=y.model);let w=!1;if(y&&Array.isArray(y.choices))for(let b of y.choices)b?.message&&(!b.delta||Object.keys(b.delta).length===0)&&(b.delta=b.message,delete b.message,w=!0);if(y.choices&&y.choices.length>0){for(let b=y.choices.length-1;b>=0;b--){let C=y.choices[b];if(C?.finish_reason&&(typeof C.index=="number"&&c.set(C.index,!0),(!C.delta||Object.keys(C.delta).length===0)&&(u.trace(`preprocessSSEResponse has only finish_reason (choice ${b}), adding empty content to delta`),C.delta={role:"assistant",content:""},w=!0),C.delta.role||(C.delta.role="assistant",w=!0)),C?.delta&&Object.keys(C.delta).length===0){if(C?.finish_reason)continue;u.trace(`preprocessSSEResponse removing invalid delta (choice ${b})`),y.choices.splice(b,1),w=!0}}if(y.choices.length===1)for(let b of y.choices)(b.index==null||b.index!==0)&&(b.index=0,w=!0);for(let b of y.choices){if(b.delta?.tool_calls)for(let C of b.delta.tool_calls)C.type||(C.type="function",w=!0);if(b.message?.tool_calls)for(let C of b.message.tool_calls)C.type||(C.type="function",w=!0)}}if(w){let b=JSON.stringify(y);g=g.replace(k[0],`data: ${b}`)}}catch{}}m=g}catch{}s.enqueue(i.encode(m))}}catch(p){s.error(p)}finally{o.releaseLock()}}});return new Response(a,{status:e.status,statusText:e.statusText,headers:e.headers})}async handleRequest(e,t,o,r,i,a,s){await Ie.getInstance(this.provider,2,1e3).throttle(this.displayName),u.debug(`${e.name} starting to process ${this.displayName} request${s?` (Account ID: ${s})`:""}`),this.currentRequestProcessedEvents.clear();let c=new Map;try{let l=await this.createOpenAIClient(t,s);u.debug(`${e.name} sending ${o.length} messages, using ${this.displayName}`);let p={model:t.model||e.id,messages:this.convertMessagesToOpenAI(o,e.capabilities||void 0,t),max_tokens:L.getMaxTokensForModel(e.maxOutputTokens),stream:!0,stream_options:{include_usage:!0},temperature:L.getTemperature(),top_p:L.getTopP()};if(r.tools&&r.tools.length>0&&e.capabilities?.toolCalling&&(p.tools=this.convertToolsToOpenAI([...r.tools]),p.tool_choice="auto",u.trace(`${e.name} added ${r.tools.length} tools`)),t.extraBody){let F=n.filterExtraBodyParams(t.extraBody);Object.assign(p,F),Object.keys(F).length>0&&u.trace(`${e.name} merged extraBody parameters: ${JSON.stringify(F)}`)}u.info(`${e.name} sending ${this.displayName} request`);let f=!1,m=!1,h=null,g="",v=new Map,k=Date.now(),x=300,y=()=>{let F=Date.now();return F-k>=x?(i.report(new me.LanguageModelTextPart("")),k=F,!0):!1},w=()=>{k=Date.now()},b=null,C=()=>{b||(b=setInterval(()=>{a.isCancellationRequested||y()},x))},I=()=>{b&&(clearInterval(b),b=null)};C();let $=new AbortController,M=a.onCancellationRequested(()=>$.abort()),A=null,z;try{let F=l.chat.completions.stream(p,{signal:$.signal});if(F.on("content",(K,Ve)=>{if(a.isCancellationRequested)throw u.warn(`${e.name} user cancelled request`),new me.CancellationError;w();try{u.trace(`${e.name} received content delta: ${K?K.length:0} characters, preview=${K}`)}catch{}if(typeof K=="string"&&K.replace(/[\s\uFEFF\xA0]+/g,"").length>0&&h){if(g.length>0)try{i.report(new me.LanguageModelThinkingPart(g,h)),g="",m=!0}catch(Rt){u.trace(`${e.name} failed to report thinking: ${String(Rt)}`)}i.report(new me.LanguageModelThinkingPart("",h)),h=null}K&&K.length>0&&(i.report(new me.LanguageModelTextPart(K)),K.trim().length>0&&(f=!0))}).on("tool_calls.function.arguments.done",K=>{if(a.isCancellationRequested)return;w();let Ve=`tool_call_${K.name}_${K.index}_${K.arguments.length}`;if(this.currentRequestProcessedEvents.has(Ve)){u.trace(`Skip duplicate tool call event: ${K.name} (index: ${K.index})`);return}this.currentRequestProcessedEvents.add(Ve);let ue={};if(K.parsed_arguments){let ut=K.parsed_arguments;ue=typeof ut=="object"&&ut!==null?ut:{}}else try{ue=JSON.parse(K.arguments||"{}")}catch(ut){u.trace(`Tool call parameter first parsing failed: ${K.name} (index: ${K.index}), trying deduplication fix...`);let Pe=K.arguments||"{}";try{let Ht=Math.min(50,Math.floor(Pe.length/2)),$e=!1,Ae=0;for(let be=Ht;be>=5;be--){let gt=Pe.substring(0,be),rn=Pe.substring(be).indexOf(gt);if(rn!==-1){Ae=be+rn,$e=!0,u.debug(`Deduplication fix: detected first ${be} characters repeat at position ${Ae}, prefix="${gt}"`);break}}if($e&&Ae>0){let be=Pe.length;Pe=Pe.substring(Ae),u.debug(`Deduplication fix: remove duplicate prefix, truncate from ${be} characters to ${Pe.length} characters`)}}catch{}if(Pe.includes("}{")){let Ht=0,$e=-1;for(let Ae=0;Ae<Pe.length;Ae++)if(Pe[Ae]==="{")Ht++;else if(Pe[Ae]==="}"&&(Ht--,Ht===0)){$e=Ae;break}if($e!==-1&&$e<Pe.length-1){let Ae=Pe.length;Pe=Pe.substring(0,$e+1),u.debug(`Deduplication fix: remove duplicate object, truncate from ${Ae} characters to ${Pe.length} characters`)}}try{ue=JSON.parse(Pe),u.debug(`Deduplication fix successful: ${K.name} (index: ${K.index}), parsed successfully after fix`)}catch(Ht){throw u.error(`Failed to parse tool call parameters: ${K.name} (index: ${K.index})`),u.error(`Original parameter string (first 100 characters): ${K.arguments?.substring(0,100)}`),u.error(`First parsing error: ${ut}`),u.error(`Still failed after deduplication fix: ${Ht}`),ut}}let Rt=v.get(K.index),Ot=Rt||`tool_call_${K.index}_${Date.now()}`;Rt||u.warn(`${e.name} used generated ID for tool call (original ID not found in chunks)`),i.report(new me.LanguageModelToolCallPart(Ot,K.name,ue)),f=!0}).on("tool_calls.function.arguments.delta",K=>{w(),y()}).on("chunk",(K,Ve)=>{if(w(),K.usage&&(z=K.usage,u.debug(`[${this.displayName}] Native usage from API: ${JSON.stringify(K.usage)}`)),K.choices&&K.choices.length>0)for(let ue=0;ue<K.choices.length;ue++){let Rt=K.choices[ue],Ot=Rt.delta,ut=Rt.message;if(Ot?.tool_calls&&Ot.tool_calls.length>0){for(let $e of Ot.tool_calls)if($e.id&&$e.index!==void 0&&(v.set($e.index,$e.id),u.trace(`${e.name} captured tool call ID: ${$e.id} at index ${$e.index}`)),$e.index!==void 0&&!$e.function?.arguments&&g.length>0&&h)try{i.report(new me.LanguageModelThinkingPart(g,h)),i.report(new me.LanguageModelThinkingPart("",h)),g="",m=!0}catch(Ae){u.trace(`${e.name} failed to report thinking: ${String(Ae)}`)}}let Pe=Ot?.reasoning??Ot?.reasoning_content??ut?.reasoning??ut?.reasoning_content;if(Pe&&t.outputThinking!==!1)try{h||(h=`thinking_${Date.now()}_${Math.random().toString(36).slice(2,8)}`),g+=Pe,i.report(new me.LanguageModelThinkingPart(g,h)),g="",m=!0}catch(Ae){u.trace(`${e.name} failed to report thinking: ${String(Ae)}`)}let Ht=ut?.content;if(typeof Ht=="string"&&Ht.replace(/[\s\uFEFF\xA0]+/g,"").length>0){if(h){try{i.report(new me.LanguageModelThinkingPart("",h))}catch($e){u.trace(`${e.name} failed to end thinking: ${String($e)}`)}h=null}try{i.report(new me.LanguageModelTextPart(Ht)),f=!0}catch($e){u.trace(`${e.name} failed to report message content (choice ${ue}): ${String($e)}`)}}}}).on("error",K=>{A=K,$.abort()}),await F.done(),g.length>0&&h)try{i.report(new me.LanguageModelThinkingPart(g,h)),g="",m=!0}catch(K){u.trace(`${e.name} failed to report thinking at end: ${String(K)}`)}if(A)throw A;if(z)try{let K=z;u.info(`${e.name} Token usage: ${K.prompt_tokens}+${K.completion_tokens}=${K.total_tokens}`)}catch(K){u.trace(`${e.name} failed to print finalUsage: ${String(K)}`)}let q,oe,fe,ie=!1;if(z){let K=z;q=K.prompt_tokens??0,oe=K.completion_tokens??0,fe=K.total_tokens}if(q===void 0)try{q=await he.getInstance().countMessagesTokens(e,[...o],{sdkMode:t.sdkMode},r),oe=0,fe=q,ie=!0}catch(K){u.trace(`${e.name} failed to estimate prompt tokens: ${String(K)}`)}q!==void 0&&oe!==void 0&&Gt.getInstance().recordSuccess({modelId:e.id,modelName:e.name,providerId:this.provider,promptTokens:q,completionTokens:oe,totalTokens:fe,maxInputTokens:e.maxInputTokens,maxOutputTokens:e.maxOutputTokens,estimatedPromptTokens:ie}),s&&this.quotaCache.recordSuccess(s,this.provider).catch(()=>{}),u.debug(`${e.name} ${this.displayName} SDK stream processing complete`)}catch(F){throw s&&!(F instanceof me.CancellationError)&&(this.isQuotaError(F)?this.quotaCache.markQuotaExceeded(s,this.provider,{error:F instanceof Error?F.message:String(F),affectedModel:e.id}).catch(()=>{}):this.quotaCache.recordFailure(s,this.provider,F instanceof Error?F.message:String(F)).catch(()=>{})),F instanceof me.CancellationError?(u.info(`${e.name} request cancelled by user`),F):(u.error(`${e.name} SDK stream processing error: ${F}`),F)}finally{M.dispose()}m&&!f&&(i.report(new me.LanguageModelTextPart("<think/>")),u.warn(`${e.name} end of message stream has only thinking content and no text content, added <think/> placeholder as output`)),u.debug(`${e.name} ${this.displayName} request complete`)}catch(l){if(l instanceof Error)if(l.cause instanceof Error){let d=l.cause.message||"Unknown error";throw u.error(`${e.name} ${this.displayName} request failed: ${d}`),l.cause}else{let d=l.message||"Unknown error";throw u.error(`${e.name} ${this.displayName} request failed: ${d}`),d.includes("502")||d.includes("Bad Gateway")||d.includes("500")||d.includes("Internal Server Error")||d.includes("503")||d.includes("Service Unavailable")||d.includes("504")||d.includes("Gateway Timeout")?new me.LanguageModelError(d):l}throw l instanceof me.CancellationError||l instanceof me.LanguageModelError&&(u.debug(`LanguageModelError details: code=${l.code}, cause=${l.cause}`),l.code==="blocked"?u.warn("Request blocked, may contain inappropriate content"):l.code==="noPermissions"?u.warn("Insufficient permissions, please check API key and model access permissions"):l.code==="notFound"?u.warn("Model not found or unavailable"):l.code==="quotaExceeded"?u.warn("Quota exceeded, please check API usage limits"):l.code==="unknown"&&u.warn("Unknown language model error")),l}}isQuotaError(e){if(!(e instanceof Error))return!1;let t=e.message;return t.startsWith("Quota exceeded")||t.startsWith("Rate limited")||t.includes("HTTP 429")||t.includes('"code": 429')||t.includes('"code":429')||t.includes("RESOURCE_EXHAUSTED")||t.includes("429")&&t.includes("Resource has been exhausted")}convertMessagesToOpenAI(e,t,o){let r=[];for(let i of e){let a=this.convertSingleMessage(i,t,o);a&&(Array.isArray(a)?r.push(...a):r.push(a))}return this.balanceFunctionCallsAndResponses(r),r}balanceFunctionCallsAndResponses(e){let t=new Map,o=new Map;for(let r=0;r<e.length;r++){let i=e[r];if(i.role==="assistant"&&"tool_calls"in i&&i.tool_calls)for(let a of i.tool_calls)a.type==="function"&&a.id&&t.set(a.id,{index:r,name:a.function.name});else i.role==="tool"&&"tool_call_id"in i&&o.set(i.tool_call_id,r)}for(let[r,i]of t.entries())if(!o.has(r)){let a={role:"tool",content:"Tool execution failed or was cancelled",tool_call_id:r};e.splice(i.index+1,0,a),u.debug(`OpenAIHandler: Added placeholder tool message for call id=${r} name=${i.name||""}`)}for(let[r,i]of o.entries())if(!t.has(r)){let s={role:"user",content:`Tool result (orphaned): ${e[i].content}`};e[i]=s,u.warn(`OpenAIHandler: Converted orphaned tool message for id=${r} to user message`)}}convertSingleMessage(e,t,o){switch(e.role){case me.LanguageModelChatMessageRole.System:return this.convertSystemMessage(e);case me.LanguageModelChatMessageRole.User:return this.convertUserMessage(e,t);case me.LanguageModelChatMessageRole.Assistant:return this.convertAssistantMessage(e,o);default:return u.warn(`Unknown message role: ${e.role}`),null}}convertSystemMessage(e){let t=this.extractTextContent(e.content);return t?{role:"system",content:t}:null}convertUserMessage(e,t){let o=[],r=this.convertUserContentMessage(e,t);r&&o.push(r);let i=this.convertToolResultMessages(e);return o.push(...i),o}convertUserContentMessage(e,t){let o=e.content.filter(i=>i instanceof me.LanguageModelTextPart),r=[];if(t?.imageInput===!0){u.debug("Model supports image input, starting to collect image parts");for(let s of e.content)s instanceof me.LanguageModelDataPart?(u.debug(`Found data part: MIME=${s.mimeType}, size=${s.data.length} bytes`),this.isImageMimeType(s.mimeType)?(r.push(s),u.debug(`Add image: MIME=${s.mimeType}, size=${s.data.length} bytes`)):s.mimeType==="cache_control"?u.trace("Ignore Claude cache identifier: cache_control"):s.mimeType.startsWith("image/")?u.warn(`Unsupported image MIME type: ${s.mimeType}`):u.trace(`Skip non-image data: ${s.mimeType}`)):u.trace(`Non-data part: ${s.constructor.name}`);let a=e.content.filter(s=>s instanceof me.LanguageModelDataPart).filter(s=>s.mimeType!=="cache_control");a.length>0&&r.length===0&&u.warn(`Found ${a.length} non-cache_control data parts but no valid images, please check image attachment format`)}if(o.length===0&&r.length===0)return null;if(r.length>0){u.debug(`Build multimodal message: ${o.length} text parts + ${r.length} image parts`);let i=[];if(o.length>0){let a=o.map(s=>s.value).join(`
`);i.push({type:"text",text:a}),u.trace(`Add text content: ${a.length} characters`)}for(let a of r){let s=this.createDataUrl(a);i.push({type:"image_url",image_url:{url:s}}),u.trace(`Add image URL: MIME=${a.mimeType}, Base64 length=${s.length} characters`)}return u.debug(`Multimodal message construction complete: ${i.length} content parts`),{role:"user",content:i}}else return{role:"user",content:o.map(i=>i.value).join(`
`)}}convertToolResultMessages(e){let t=[];for(let o of e.content)if(o instanceof me.LanguageModelToolResultPart){let i={role:"tool",content:this.convertToolResultContent(o.content),tool_call_id:o.callId};t.push(i)}return t}convertAssistantMessage(e,t){let o=this.extractTextContent(e.content),r=[],i=null;for(let c of e.content)c instanceof me.LanguageModelToolCallPart&&r.push({id:c.callId,type:"function",function:{name:c.name,arguments:JSON.stringify(c.input)}});let a=t?.includeThinking===!0;if(a){u.trace(`Check if thinking content needs to be included: includeThinking=${a}`);for(let c of e.content)if(c instanceof me.LanguageModelThinkingPart){Array.isArray(c.value)?i=c.value.join(""):i=c.value,u.trace(`Extracted thinking content: ${i.length} characters`);break}}if(!o&&!i&&r.length===0)return null;let s={role:"assistant",content:o||null};return i&&(s.reasoning_content=i,u.trace(`Add reasoning_content: ${i.length} characters`)),r.length>0&&(s.tool_calls=r),s}extractTextContent(e){let t=e.filter(o=>o instanceof me.LanguageModelTextPart).map(o=>o.value);return t.length>0?t.join(`
`):null}convertToolResultContent(e){return typeof e=="string"?e:Array.isArray(e)?e.map(t=>t instanceof me.LanguageModelTextPart?t.value:JSON.stringify(t)).join(`
`):JSON.stringify(e)}convertToolsToOpenAI(e){return e.map(t=>{let o={type:"function",function:{name:t.name,description:t.description||""}};return t.inputSchema?typeof t.inputSchema=="object"&&t.inputSchema!==null?o.function.parameters=t.inputSchema:o.function.parameters={type:"object",properties:{},required:[]}:o.function.parameters={type:"object",properties:{},required:[]},o})}isImageMimeType(e){let t=e.toLowerCase().trim(),o=["image/jpeg","image/jpg","image/png","image/gif","image/webp","image/bmp","image/svg+xml"],r=t.startsWith("image/"),i=o.includes(t);return r&&!i?u.warn(`Image type not in support list: ${e}, supported types: ${o.join(", ")}`):!r&&t!=="cache_control"&&u.trace(`Non-image data type: ${e}`),r&&i}createDataUrl(e){try{let t=Buffer.from(e.data).toString("base64"),o=`data:${e.mimeType};base64,${t}`;return u.debug(`Create image DataURL: MIME=${e.mimeType}, original size=${e.data.length} bytes, Base64 size=${t.length} characters`),o}catch(t){throw u.error(`Failed to create image DataURL: ${t}`),t}}static filterExtraBodyParams(e){let t=new Set(["model","messages","stream","stream_options","tools"]),o={};for(let[r,i]of Object.entries(e))t.has(r)||(o[r]=i,i==null&&(o[r]=void 0));return o}};var ln=D(require("vscode"));ce();var sh={CacheControl:"cache_control"};function q$(n){return n!==void 0}function F$(n){return n.type!=="thinking"&&n.type!=="redacted_thinking"}function dk(n,e=!1){let t=[];for(let o of n)if(e&&o instanceof ln.LanguageModelThinkingPart){let r=o.metadata,a=o.metadata?._signatureProvider==="anthropic"?r?.signature:void 0;if(r?.data)t.push({type:"redacted_thinking",data:r.data});else{let s=r?._completeThinking||(Array.isArray(o.value)?o.value.join(""):o.value);if(s){let c={type:"thinking",thinking:s};a&&(c.signature=a),t.push(c)}}}else if(o instanceof ln.LanguageModelToolCallPart)t.push({type:"tool_use",id:o.callId,input:o.input,name:o.name});else if("data"in o&&"mimeType"in o){let r=o;if(r.mimeType===sh.CacheControl){let i=t.at(-1);i&&F$(i)?i.cache_control={type:"ephemeral"}:t.push({type:"text",text:" ",cache_control:{type:"ephemeral"}})}else r.mimeType.startsWith("image/")&&t.push({type:"image",source:{type:"base64",data:Buffer.from(r.data).toString("base64"),media_type:r.mimeType}})}else if(o instanceof ln.LanguageModelToolResultPart)t.push({type:"tool_result",tool_use_id:o.callId,content:o.content.map(r=>{if(r instanceof ln.LanguageModelTextPart)return{type:"text",text:r.value}}).filter(q$)});else if(o instanceof ln.LanguageModelTextPart){if(o.value==="")continue;t.push({type:"text",text:o.value})}return t}function pk(n,e){let t=[],o={type:"text",text:""};for(let i of e)i.role===ln.LanguageModelChatMessageRole.Assistant?t.push({role:"assistant",content:dk(i.content,n.includeThinking)}):i.role===ln.LanguageModelChatMessageRole.User?t.push({role:"user",content:dk(i.content)}):i.role===ln.LanguageModelChatMessageRole.System&&(o.text+=i.content.map(a=>a instanceof ln.LanguageModelTextPart?a.value:("data"in a&&"mimeType"in a&&a.mimeType===sh.CacheControl&&a.data.toString()==="ephemeral"&&(o.cache_control={type:"ephemeral"}),"")).join(""));let r=[];for(let i of t)if(r.length===0||r[r.length-1].role!==i.role)r.push(i);else{let a=r[r.length-1];Array.isArray(a.content)&&Array.isArray(i.content)&&a.content.push(...i.content)}if(n.includeThinking){for(let i of r)if(i.role==="assistant"&&Array.isArray(i.content)){let a=i.content,s=a.filter(l=>l.type==="thinking"||l.type==="redacted_thinking"),c=a.filter(l=>l.type!=="thinking"&&l.type!=="redacted_thinking");s.length===0?(a.unshift({type:"thinking",thinking:"..."}),u.trace("Assistant message missing thinking block, added default one")):a[0]?.type!=="thinking"&&a[0]?.type!=="redacted_thinking"&&(i.content=[...s,...c],u.trace("Assistant message reordered to start with thinking block"))}}return{messages:r,system:o}}function mk(n){return n.map(e=>{let t=e.inputSchema;return t?{name:e.name,description:e.description||"",input_schema:{type:"object",properties:t.properties??{},required:t.required??[],...t.additionalProperties!==void 0&&{additionalProperties:t.additionalProperties}}}:{name:e.name,description:e.description||"",input_schema:{type:"object",properties:{},required:[]}}})}var el=class{constructor(e,t,o){this.provider=e;this.displayName=t;this.baseURL=o}async createAnthropicClient(e){let t=e?.provider||this.provider,o=await R.getApiKey(t);if(!o)throw new Error(`Missing ${this.displayName} API key`);let r=e?.baseUrl||this.baseURL;if(t==="minimax-coding"){let c=L.getMinimaxEndpoint();r&&c==="minimax.io"&&(r=r.replace("api.minimaxi.com","api.minimax.io"))}if(t==="zhipu"){let c=L.getZhipuEndpoint();r&&c==="api.z.ai"&&(r=r.replace("open.bigmodel.cn","api.z.ai"))}let i={"User-Agent":Nt.getUserAgent(this.provider)},a=R.processCustomHeader(e?.customHeader,o);Object.keys(a).length>0&&(Object.assign(i,a),u.debug(`${this.displayName} apply custom headers: ${JSON.stringify(e?.customHeader)}`));let s=new co({apiKey:o,baseURL:r,authToken:o,defaultHeaders:i});return u.info(`${this.displayName} Anthropic compatible client created`),s}async handleRequest(e,t,o,r,i,a){try{let s=await this.createAnthropicClient(t),{messages:c,system:l}=pk(t,o),d=r.tools?mk([...r.tools]):[],p=t.model||e.id,f={model:p,max_tokens:L.getMaxTokensForModel(e.maxOutputTokens),messages:c,stream:!0,temperature:L.getTemperature(),top_p:L.getTopP()};if(t.extraBody){let g=Ai.filterExtraBodyParams(t.extraBody);Object.assign(f,g),Object.keys(g).length>0&&u.trace(`${e.name} merged extraBody parameters: ${JSON.stringify(g)}`)}l.text&&(f.system=[l]),d.length>0&&(f.tools=d),u.debug(`[${e.name}] Send Anthropic API request, containing ${c.length} messages, using model: ${p}`);let m=await s.messages.create(f),h=await this.handleAnthropicStream(m,i,a,t);u.info(`[${e.name}] Anthropic request completed`,h.usage)}catch(s){u.error(`[${e.name}] Anthropic SDK error:`,s);let c=`[${e.name}] Anthropic API call failed`;throw s instanceof Error&&(s.message.includes("401")?c+=": Invalid API key, please check configuration":s.message.includes("429")?c+=": Request rate limit, please try again later":s.message.includes("500")?c+=": Server error, please try again later":c+=`: ${s.message}`),i.report(new un.LanguageModelTextPart(c)),s}}async handleAnthropicStream(e,t,o,r){let i,a,s,c,d=null,p=!1,f=!1,m="",h=0,g=20,v=160,k=200,x=w=>{let b=w.trim().match(/\S+/g);return b?b.length:0},y=w=>{if(!m)return;let b=x(m),C=Date.now(),I=C-h;(w||b>=g||m.length>=v||I>=k)&&(t.report(new un.LanguageModelTextPart(m)),m="",h=C)};u.debug("Start processing Anthropic streaming response");try{for await(let w of e){if(o.isCancellationRequested){u.debug("Stream processing cancelled"),y(!0),this.reportRemainingThinkingContent(t,a,d,"stream cancellation");break}switch(w.type){case"message_start":c={inputTokens:(w.message.usage.input_tokens??0)+(w.message.usage.cache_creation_input_tokens??0)+(w.message.usage.cache_read_input_tokens??0),outputTokens:1,totalTokens:-1},u.trace(`Message stream start - initial input tokens: ${c.inputTokens}`);break;case"content_block_start":w.content_block.type==="tool_use"?(this.reportRemainingThinkingContent(t,a,d,"tool call start"),a&&(a.thinking=""),d=null,i={toolId:w.content_block.id,name:w.content_block.name,jsonInput:""},u.trace(`Tool call start: ${w.content_block.name}`)):w.content_block.type==="thinking"?(a={thinking:"",signature:""},d=`thinking_${Date.now()}_${Math.random().toString(36).slice(2,8)}`,f=!0,u.trace("Thinking block start (streaming output)")):w.content_block.type==="text"?(this.reportRemainingThinkingContent(t,a,d,"text block start"),a&&(a.thinking=""),d=null,u.trace("Text block start")):w.content_block.type==="redacted_thinking"&&(s={data:w.content_block.data},u.trace("Encrypted thinking block start"));break;case"content_block_delta":if(w.delta.type==="text_delta")m+=w.delta.text,y(!1),p=!0;else if(w.delta.type==="input_json_delta"&&i){i.jsonInput=(i.jsonInput||"")+w.delta.partial_json;try{let b=JSON.parse(i.jsonInput);t.report(new un.LanguageModelToolCallPart(i.toolId??"",i.name??"",b)),i=void 0}catch{}p=!0}else if(w.delta.type==="thinking_delta"){let b=w.delta.thinking||"";if(a)if(a.thinking=(a.thinking||"")+b,r?.outputThinking!==!1){let I=a.thinking||"";if(I.length>=20){d||(d=`thinking_${Date.now()}_${Math.random().toString(36).slice(2,8)}`);try{t.report(new un.LanguageModelThinkingPart(I,d)),a.thinking=""}catch($){u.trace(`Failed to report thinking content: ${String($)}`)}}}else u.trace("\u23ED\uFE0F Skip thinking content output: configured not to output thinking")}else w.delta.type==="signature_delta"&&a&&(a.signature=(a.signature||"")+(w.delta.signature||""));break;case"content_block_stop":if(i){try{let b=JSON.parse(i.jsonInput||"{}");t.report(new un.LanguageModelToolCallPart(i.toolId??"",i.name??"",b)),u.debug(`Tool call complete: ${i.name}`)}catch(b){u.error(`Failed to parse tool call JSON (${i.name}):`,b)}i=void 0}else if(a){let b=!1,C=a.thinking||"";if(C.length>0&&d){let I=new un.LanguageModelThinkingPart(C,d);a.signature&&(I.metadata={signature:a.signature,_completeThinking:C}),t.report(I),t.report(new un.LanguageModelThinkingPart("",d)),b=!0}if(!b&&a.signature){let I=new un.LanguageModelThinkingPart("");I.metadata={signature:a.signature,_completeThinking:C},t.report(I)}a=void 0,u.debug("Thinking block complete")}else s&&(s=void 0,u.debug("Encrypted thinking block complete"));break;case"message_delta":c&&w.usage&&(w.usage.input_tokens!==void 0&&w.usage.input_tokens!==null&&(c.inputTokens=w.usage.input_tokens+(w.usage.cache_creation_input_tokens??0)+(w.usage.cache_read_input_tokens??0)),w.usage.output_tokens!==void 0&&w.usage.output_tokens!==null&&(c.outputTokens=w.usage.output_tokens),c.totalTokens=c.inputTokens+c.outputTokens,u.trace(`Token usage update - Input: ${c.inputTokens}, Output: ${c.outputTokens}, Total: ${c.totalTokens}`)),w.delta.stop_reason&&u.trace(`Message stop reason: ${w.delta.stop_reason}`);break;case"message_stop":y(!0),this.reportRemainingThinkingContent(t,a,d,"message stream end"),a&&(a.thinking=""),d=null,f&&!p&&(t.report(new un.LanguageModelTextPart("<think/>")),u.warn("Only thinking content and no text content at end of message stream, added <think/> placeholder as output")),u.trace("Message stream complete");break;default:u.trace("Received other event types");break}}}catch(w){throw u.error("Error processing Anthropic stream:",w),w}finally{y(!0),this.reportRemainingThinkingContent(t,a,d,"stream processing end")}return c?u.debug(`Stream processing complete - final usage statistics: Input=${c.inputTokens}, Output=${c.outputTokens}, Total=${c.totalTokens}`):u.warn("Stream processing complete but usage statistics not obtained"),{usage:c}}reportRemainingThinkingContent(e,t,o,r){let i=t?.thinking||"";if(i.length>0&&o)try{e.report(new un.LanguageModelThinkingPart(i,o)),u.trace(`reporting remaining thinking content at ${r}: ${i.length} characters`),e.report(new un.LanguageModelThinkingPart("",o))}catch(a){u.trace(`failed to report thinking content at ${r}: ${String(a)}`)}}};Wr();var Or=D(require("node:crypto")),ze=D(require("vscode"));cr();ot();ce();var tl=D(require("vscode"));Cu();var B$=3e4,U$=6e4,j$=1e3,gs=class{quotaCountdownTimer;quotaCountdownEndAt=0;quotaCountdownMessage;quotaCountdownModel;quotaCountdownAccountId;quotaCountdownAccountName;lastQuotaNoticeAt=0;notifyQuotaExceeded(e,t,o,r){if(e<=0)return;this.startQuotaCountdown(e,t,o,r),this.updateAccountManagerQuota(e,t,o,r);let i=Date.now();if(i-this.lastQuotaNoticeAt<B$)return;this.lastQuotaNoticeAt=i;let a=t?` (${t})`:"",s=r?` [${r}]`:"",c=`Copilot ++ Antigravity quota limit reached${a}${s}. Retry in ${this.formatCountdown(e)}.`}async notifyQuotaTooLong(e,t,o,r){if(e<=0)return;let i=t?` (${t})`:"",a=r?` [${r}]`:"",s=`Antigravity quota exceeded${i}${a}. Retry in ${this.formatCountdown(e)}.`,c=await tl.window.showWarningMessage(s,"Add Account","Open Account Manager","Dismiss");c==="Add Account"?await tl.commands.executeCommand("chp.antigravity.login"):c==="Open Account Manager"&&await tl.commands.executeCommand("chp.accounts.openManager")}startQuotaCountdown(e,t,o,r){this.quotaCountdownEndAt=Date.now()+e,this.quotaCountdownModel=t,this.quotaCountdownAccountId=o,this.quotaCountdownAccountName=r,this.quotaCountdownTimer&&(clearTimeout(this.quotaCountdownTimer),this.quotaCountdownTimer=void 0),this.updateQuotaCountdown()}updateQuotaCountdown(){if(!this.quotaCountdownEndAt)return;let e=this.quotaCountdownEndAt-Date.now();if(e<=0){this.clearQuotaCountdown();return}let t=this.quotaCountdownModel?` (${this.quotaCountdownModel})`:"",o=this.quotaCountdownAccountName?` [${this.quotaCountdownAccountName}]`:"",r=`Copilot ++ Antigravity limited${t}${o}: ${this.formatCountdown(e)}`,i=this.getCountdownUpdateInterval(e);this.quotaCountdownTimer=setTimeout(()=>this.updateQuotaCountdown(),i)}clearQuotaCountdown(){this.quotaCountdownTimer&&(clearTimeout(this.quotaCountdownTimer),this.quotaCountdownTimer=void 0),this.quotaCountdownMessage&&(this.quotaCountdownMessage.dispose(),this.quotaCountdownMessage=void 0),this.quotaCountdownEndAt=0,this.quotaCountdownModel=void 0,this.quotaCountdownAccountId=void 0,this.quotaCountdownAccountName=void 0,this.updateAccountManagerQuota(0,"")}updateAccountManagerQuota(e,t,o,r){try{if(e<=0){Jr.updateAntigravityQuotaNotice(null);return}Jr.updateAntigravityQuotaNotice({resetAt:Date.now()+e,modelName:t||void 0,accountId:o||this.quotaCountdownAccountId,accountName:r||this.quotaCountdownAccountName})}catch{}}formatCountdown(e){let t=Math.max(0,Math.floor(e/1e3)),o=t%60,r=Math.floor(t/60)%60,i=Math.floor(t/3600);return i>0?`${i}h${r}m${o}s`:r>0?`${r}m${o}s`:`${o}s`}getCountdownUpdateInterval(e){return e>=3600*1e3?U$:j$}formatDuration(e){let t=Math.floor(e/1e3),o=Math.floor(t/60),r=Math.floor(o/60);if(r>0){let i=o%60;return`${r}h${i}m`}else if(o>0){let i=t%60;return`${o}m${i}s`}else return`${t}s`}dispose(){this.clearQuotaCountdown()}};var dn=D(require("vscode")),Pi=class n{textBuffer="";lastTextFlushTime=0;thinkingBuffer="";currentThinkingId=null;toolCallsInProgress=new Map;seenToolCalls=new Set;toolCallCounter=0;isInsideThinkingTag=!1;thinkingTagBuffer="";static TEXT_BUFFER_WORD_THRESHOLD=20;static TEXT_BUFFER_CHAR_THRESHOLD=160;static TEXT_BUFFER_MAX_DELAY_MS=200;CLOSING_TAG="</thinking>";CLOSING_TAG_LEN=this.CLOSING_TAG.length;lastActivityReportTime=0;static ACTIVITY_REPORT_INTERVAL_MS=200;toolCallProgressReported=new Set;lastToolCallProgressTime=0;static TOOL_CALL_PROGRESS_INTERVAL_MS=300;shouldStopAfterToolCall=!1;async processStream(e){let{response:t,modelConfig:o,progress:r,token:i}=e;if(!t.body)throw new Error("OpenAI response body is empty.");let a=t.body.getReader(),s=new TextDecoder,c="",l=0,d=setInterval(()=>{i.isCancellationRequested||r.report(new dn.LanguageModelTextPart(""))},n.ACTIVITY_REPORT_INTERVAL_MS);try{for(;;){if(i.isCancellationRequested)throw new dn.CancellationError;let{done:p,value:f}=await a.read();if(p)break;l++;let m=s.decode(f,{stream:!0});if(c+=m,c=c.replace(/\r\n/g,`
`),c=this.processSSELines(c,o,r),this.shouldStopAfterToolCall){await a.cancel();break}await new Promise(h=>setImmediate(h))}}finally{clearInterval(d),this.processRemainingBuffer(c,o,r),this.flushPendingThinkingTagBuffer(),this.flushTextBuffer(r),this.finalizeThinkingPart(r),this.finalizeToolCalls(r)}}processSSELines(e,t,o){let r=e.indexOf(`
`);for(;r!==-1;){let i=e.slice(0,r);e=e.slice(r+1);let a=i.trimEnd();if(a.length===0){r=e.indexOf(`
`);continue}if(a.startsWith("data:")){let s=a.slice(5).trim();if(s==="[DONE]"){r=e.indexOf(`
`);continue}s.length>0&&this.processOpenAIChunk(s,t,o)}r=e.indexOf(`
`)}return e}processOpenAIChunk(e,t,o){try{let r=JSON.parse(e);Array.isArray(r.choices)&&r.choices.length>0?this.processOpenAIFormat(r,t,o):(r.response||r.candidates)&&this.processGeminiFormat(r,t,o),this.flushTextBufferIfNeeded(o),this.flushThinkingBuffer(o)}catch{}}processOpenAIFormat(e,t,o){for(let r of e.choices||[]){let i=r.delta;if(i.content!==void 0&&i.content!==null&&this.handleTextContent(i.content,t,o),i.tool_calls&&i.tool_calls.length>0)for(let a of i.tool_calls)this.handleToolCallDelta(a,o);r.finish_reason==="tool_calls"&&(this.thinkingTagBuffer.length>0&&(this.textBuffer+=this.thinkingTagBuffer,this.thinkingTagBuffer=""),this.flushTextBuffer(o),this.flushThinkingBuffer(o),this.finalizeToolCalls(o))}}processGeminiFormat(e,t,o){let i=(e.response||e).candidates||[];for(let a of i){let s=a.content?.parts||[],c=s.map(l=>l.thought?"thought":l.text!==void 0?"text":l.functionCall?"functionCall":l.inlineData?"inlineData":"unknown");for(let l of s){if(l.thought===!0){t.outputThinking!==!1&&l.text&&(this.currentThinkingId||(this.currentThinkingId=this.generateThinkingId()),this.thinkingBuffer+=l.text,this.flushThinkingBuffer(o));continue}if(l.text!==void 0&&(this.processTextWithThinkingTags(l.text,t,o),this.flushTextBuffer(o),this.flushThinkingBuffer(o)),l.functionCall&&(this.flushThinkingTagBufferForToolCall(),this.flushTextBuffer(o),this.flushThinkingBuffer(o),this.handleGeminiFunctionCall(l.functionCall,o)),l.inlineData){let d=l.inlineData.mimeType||"image/png",p=l.inlineData.data||"",f=`

![Generated Image](data:${d};base64,${p})

`;this.textBuffer+=f,this.flushTextBuffer(o)}}a.finishReason&&(this.thinkingTagBuffer.length>0&&(this.textBuffer+=this.thinkingTagBuffer,this.thinkingTagBuffer=""),this.flushTextBuffer(o),this.flushThinkingBuffer(o),this.finalizeToolCalls(o))}}handleGeminiFunctionCall(e,t){let o=e.id||`tool_call_${this.toolCallCounter++}_${Date.now()}`,r=e.name||"";if(!r)return;let i=`${o}:${r}`;if(this.seenToolCalls.has(i))return;this.seenToolCalls.add(i),this.flushThinkingTagBufferForToolCall(),this.flushTextBuffer(t),this.flushThinkingBuffer(t);let a=this.removeNullsFromArgs(e.args||{});try{let s=new dn.LanguageModelToolCallPart(o,r,a);t.report(s),this.lastActivityReportTime=Date.now(),this.shouldStopAfterToolCall=!0}catch{}}handleTextContent(e,t,o){let r=e.match(/^<think>\n?([\s\S]*?)\n?<\/think>\n?/);if(r){let i=r[1];i&&t.outputThinking!==!1&&(this.currentThinkingId||(this.currentThinkingId=this.generateThinkingId()),this.thinkingBuffer+=i,this.flushThinkingBuffer(o));let a=e.slice(r[0].length);a&&(this.processTextWithThinkingTags(a,t,o),this.flushTextBuffer(o));return}this.processTextWithThinkingTags(e,t,o),this.flushTextBuffer(o)}processTextWithThinkingTags(e,t,o){if(t.outputThinking===!1){let i=e.replace(/<thinking>[\s\S]*?<\/thinking>/g,"");i.length>0&&(this.textBuffer+=i);return}let r=0;for(;r<e.length;)if(this.isInsideThinkingTag){if(this.thinkingTagBuffer+=e[r],this.thinkingTagBuffer.endsWith(this.CLOSING_TAG)){let i=this.thinkingTagBuffer.slice(0,-this.CLOSING_TAG_LEN);i.length>0&&(this.currentThinkingId||(this.currentThinkingId=this.generateThinkingId()),this.thinkingBuffer+=i,this.flushThinkingBuffer(o)),this.isInsideThinkingTag=!1,this.thinkingTagBuffer=""}else if(this.thinkingTagBuffer.length>this.CLOSING_TAG_LEN){let i=this.thinkingTagBuffer.length-this.CLOSING_TAG_LEN,a=this.thinkingTagBuffer.slice(0,i);this.thinkingTagBuffer=this.thinkingTagBuffer.slice(i),a.length>0&&(this.currentThinkingId||(this.currentThinkingId=this.generateThinkingId()),this.thinkingBuffer+=a)}r++}else{if(this.thinkingTagBuffer+=e[r],this.thinkingTagBuffer.length>10){let i=this.thinkingTagBuffer.slice(0,-10);this.textBuffer+=i,this.thinkingTagBuffer=this.thinkingTagBuffer.slice(-10)}if(this.thinkingTagBuffer.endsWith("<thinking>")){let i=this.thinkingTagBuffer.slice(0,-10);i.length>0&&(this.textBuffer+=i),this.isInsideThinkingTag=!0,this.thinkingTagBuffer="",this.currentThinkingId||(this.currentThinkingId=this.generateThinkingId())}r++}if(!this.isInsideThinkingTag&&this.thinkingTagBuffer.length>0){if(!"<thinking>".startsWith(this.thinkingTagBuffer))this.textBuffer+=this.thinkingTagBuffer,this.thinkingTagBuffer="";else if(this.thinkingTagBuffer.length>0&&this.thinkingTagBuffer.length<10){let a="<thinking>".slice(0,this.thinkingTagBuffer.length);this.thinkingTagBuffer!==a&&(this.textBuffer+=this.thinkingTagBuffer,this.thinkingTagBuffer="")}}}handleToolCallDelta(e,t){let o=e.index,r=this.toolCallsInProgress.get(o);r||(this.flushThinkingTagBufferForToolCall(),this.flushTextBuffer(t),this.flushThinkingBuffer(t),r={id:e.id||`tool_call_${this.toolCallCounter++}_${Date.now()}`,name:"",args:""},this.toolCallsInProgress.set(o,r)),e.id&&(r.id=e.id),e.function?.name&&(r.name=e.function.name,this.toolCallProgressReported.has(o)||(this.toolCallProgressReported.add(o),this.reportToolCallProgress(r.name,t))),e.function?.arguments&&(r.args+=e.function.arguments,this.reportToolCallArgumentsProgress(r.name,r.args.length,t)),this.reportActivity(t)}reportToolCallProgress(e,t){let o=`tool_prep_${Date.now()}`,r=`
Preparing tool: ${e}...
`;t.report(new dn.LanguageModelThinkingPart(r,o))}reportToolCallArgumentsProgress(e,t,o){let r=Date.now();r-this.lastToolCallProgressTime>=n.TOOL_CALL_PROGRESS_INTERVAL_MS&&(this.lastToolCallProgressTime=r,o.report(new dn.LanguageModelTextPart("")))}finalizeToolCalls(e){this.flushThinkingTagBufferForToolCall(),this.flushTextBuffer(e),this.flushThinkingBuffer(e);for(let[,t]of this.toolCallsInProgress){if(!t.name)continue;let o=`${t.id}:${t.name}`;if(this.seenToolCalls.has(o))continue;this.seenToolCalls.add(o);let r={};if(t.args)try{r=JSON.parse(t.args)}catch{r={value:t.args}}r=this.removeNullsFromArgs(r);try{let i=new dn.LanguageModelToolCallPart(t.id,t.name,r);e.report(i)}catch{}}this.toolCallsInProgress.clear(),this.toolCallProgressReported.clear()}removeNullsFromArgs(e){if(e==null)return{};if(typeof e!="object")return{value:e};if(Array.isArray(e))return{items:e.filter(o=>o!=null)};let t={};for(let[o,r]of Object.entries(e))r!=null&&(typeof r=="object"&&!Array.isArray(r)?t[o]=this.removeNullsFromArgs(r):Array.isArray(r)?t[o]=r.filter(i=>i!=null):t[o]=r);return t}processRemainingBuffer(e,t,o){let r=e.trim();if(r.length>0&&r.startsWith("data:")){let i=r.slice(5).trim();i&&i!=="[DONE]"&&this.processOpenAIChunk(i,t,o)}}flushTextBuffer(e){if(this.textBuffer.length===0)return;let t=this.textBuffer;this.textBuffer="",this.lastTextFlushTime=Date.now();try{e.report(new dn.LanguageModelTextPart(t))}catch{}}flushTextBufferIfNeeded(e){if(this.textBuffer.length===0)return;let t=this.countWords(this.textBuffer),r=Date.now()-this.lastTextFlushTime;(t>=n.TEXT_BUFFER_WORD_THRESHOLD||this.textBuffer.length>=n.TEXT_BUFFER_CHAR_THRESHOLD||r>=n.TEXT_BUFFER_MAX_DELAY_MS)&&this.flushTextBuffer(e)}countWords(e){let t=e.trim().match(/\S+/g);return t?t.length:0}flushThinkingBuffer(e){if(this.thinkingBuffer.length>0&&this.currentThinkingId){let t=this.thinkingBuffer;this.thinkingBuffer="",e.report(new dn.LanguageModelThinkingPart(t,this.currentThinkingId))}}finalizeThinkingPart(e){this.thinkingBuffer.length>0&&this.flushThinkingBuffer(e),this.currentThinkingId&&(e.report(new dn.LanguageModelThinkingPart("",this.currentThinkingId)),this.currentThinkingId=null)}reportActivity(e){let t=Date.now();t-this.lastActivityReportTime>=n.ACTIVITY_REPORT_INTERVAL_MS&&(e.report(new dn.LanguageModelTextPart("")),this.lastActivityReportTime=t)}generateThinkingId(){return`thinking_${Date.now()}_${Math.random().toString(36).slice(2,8)}`}flushPendingThinkingTagBuffer(){this.thinkingTagBuffer.length!==0&&(this.isInsideThinkingTag?(this.currentThinkingId||(this.currentThinkingId=this.generateThinkingId()),this.thinkingBuffer+=this.thinkingTagBuffer):this.textBuffer+=this.thinkingTagBuffer,this.thinkingTagBuffer="")}flushThinkingTagBufferForToolCall(){this.thinkingTagBuffer.length!==0&&(this.textBuffer+=this.thinkingTagBuffer,this.thinkingTagBuffer="",this.isInsideThinkingTag=!1)}};Wr();var Gn=D(require("vscode"));var Ld=class n{textBuffer="";textBufferLastFlush=0;thinkingBuffer="";currentThinkingId=null;seenToolCalls=new Set;toolCallCounter=0;isInsideThinkingTag=!1;thinkingTagBuffer="";sseDataParts=[];CLOSING_TAG="</thinking>";thinkingQueue="";thinkingFlushInterval=null;thinkingProgress=null;chunkCounter=0;lastChunkTime=0;streamVelocity=0;hasReceivedContent=!1;hasThinkingContent=!1;lastActivityReportTime=0;activityReportInterval=null;pendingToolCalls=[];toolCallFlushInterval=null;static THINKING_FLUSH_INTERVAL_MS=80;static THINKING_CHARS_PER_FLUSH=150;static ACTIVITY_REPORT_INTERVAL_MS=400;static TEXT_BUFFER_MIN_SIZE=40;static TEXT_BUFFER_MAX_DELAY_MS=25;static YIELD_EVERY_N_CHUNKS=5;static HIGH_VELOCITY_THRESHOLD=10;static ADAPTIVE_BUFFER_MULTIPLIER=.5;static TOOL_CALL_FLUSH_DELAY_MS=50;async processStream(e){let{response:t,modelConfig:o,progress:r,token:i}=e;if(!t.body)throw new Error("Antigravity response body is empty.");let a=t.body.getReader(),s=new TextDecoder,c="";this.startActivityReporting(r);try{for(;;){if(i.isCancellationRequested)throw new Gn.CancellationError;let{done:l,value:d}=await a.read();if(l)break;let p=performance.now();if(this.lastChunkTime>0){let f=p-this.lastChunkTime;this.streamVelocity=f>0?d.length/f:this.streamVelocity}this.lastChunkTime=p,c+=s.decode(d,{stream:!0}),c=c.replace(/\r\n/g,`
`),c=this.processSSELines(c,o,r),this.flushTextBufferAdaptive(r),this.flushThinkingBufferIfNeeded(r),this.schedulePendingToolCallsFlush(r),this.chunkCounter++,this.chunkCounter%n.YIELD_EVERY_N_CHUNKS===0&&await new Promise(f=>setTimeout(f,1))}}finally{this.stopActivityReporting(),this.processRemainingBuffer(c,o,r),this.flushTextBuffer(r,!0),this.flushPendingToolCallsImmediate(r),this.finalizeThinkingPart(r),this.hasThinkingContent&&!this.hasReceivedContent&&r.report(new Gn.LanguageModelTextPart("<think/>"))}}startActivityReporting(e){this.activityReportInterval||(this.lastActivityReportTime=Date.now(),this.activityReportInterval=setInterval(()=>{let t=Date.now();t-this.lastActivityReportTime>=n.ACTIVITY_REPORT_INTERVAL_MS&&(this.thinkingBuffer.length>0?this.flushThinkingBuffer(e):this.textBuffer.length>0&&this.flushTextBuffer(e,!0),this.lastActivityReportTime=t)},n.ACTIVITY_REPORT_INTERVAL_MS/2))}stopActivityReporting(){this.activityReportInterval&&(clearInterval(this.activityReportInterval),this.activityReportInterval=null),this.toolCallFlushInterval&&(clearInterval(this.toolCallFlushInterval),this.toolCallFlushInterval=null)}markActivity(){this.lastActivityReportTime=Date.now()}schedulePendingToolCallsFlush(e){this.pendingToolCalls.length===0||this.toolCallFlushInterval||(this.toolCallFlushInterval=setTimeout(()=>{this.flushPendingToolCallsImmediate(e),this.toolCallFlushInterval=null},n.TOOL_CALL_FLUSH_DELAY_MS))}flushPendingToolCallsImmediate(e){for(;this.pendingToolCalls.length>0;){let t=this.pendingToolCalls.shift();t&&(e.report(new Gn.LanguageModelToolCallPart(t.callId,t.name,t.args)),this.markActivity())}}processSSELines(e,t,o){let r=e.indexOf(`
`);for(;r!==-1;){let i=e.slice(0,r).trimEnd();if(e=e.slice(r+1),i.length===0){this.processSSEEvent(t,o),r=e.indexOf(`
`);continue}if(i.startsWith("data:")){let a=i.slice(5);if(a.trim()==="[DONE]"){this.sseDataParts=[],r=e.indexOf(`
`);continue}a.length>0&&this.sseDataParts.push(a.trimStart())}r=e.indexOf(`
`)}return e}processSSEEvent(e,t){if(this.sseDataParts.length===0)return;let o=this.sseDataParts.join(`
`).trim();if(this.sseDataParts=[],!o||o==="[DONE]")return;let r=()=>`tool_call_${this.toolCallCounter++}_${Date.now()}`;try{this.handleStreamPayload(o,r,e,t),this.flushTextBufferIfNeeded(t),this.flushThinkingBufferIfNeeded(t)}catch(i){if(i instanceof SyntaxError&&String(i.message).includes("after JSON")){let a=this.splitConcatenatedJSON(o);for(let s of a)try{this.handleStreamPayload(s,r,e,t)}catch{}}}}processRemainingBuffer(e,t,o){let r=e.trim();if(r.length>0&&r.startsWith("data:")&&this.sseDataParts.push(r.slice(5).trimStart()),this.sseDataParts.length>0){let i=this.sseDataParts.join(`
`).trim();if(i&&i!=="[DONE]"){let a=()=>`tool_call_${this.toolCallCounter++}_${Date.now()}`;try{this.handleStreamPayload(i,a,t,o)}catch{}}}}handleStreamPayload(e,t,o,r){let i=JSON.parse(e),s=(i.response||i).candidates||[];for(let c of s){let l=c.content;for(let d of l?.parts||[])this.handlePart(d,t,o,r)}}handlePart(e,t,o,r){if(e.thought===!0){o.outputThinking!==!1&&typeof e.text=="string"&&(this.currentThinkingId||(this.currentThinkingId=t()),this.thinkingBuffer+=e.text,this.hasThinkingContent=!0,this.flushThinkingBufferIfNeeded(r));return}if(typeof e.text=="string"){let a=this.processTextWithThinkingTags(e.text,o);this.isInsideThinkingTag?this.flushThinkingBufferIfNeeded(r):(this.finalizeThinkingPart(r),a.length>0&&(this.textBuffer+=a,a.trim().length>0&&(this.hasReceivedContent=!0),this.flushTextBufferIfNeeded(r)))}if(e.functionCall?.name){this.flushTextBuffer(r,!0),this.flushThinkingBuffer(r);let a=lh(e);if(a?.callId&&a.name){let s=`${a.callId}:${a.name}`;if(this.seenToolCalls.has(s))return;this.seenToolCalls.add(s),a.thoughtSignature&&ch(a.callId,a.thoughtSignature);let c={};if(a.args&&typeof a.args=="object")c=a.args;else if(typeof a.args=="string")try{let l=JSON.parse(a.args);l&&typeof l=="object"&&(c=l)}catch{c={value:a.args}}this.pendingToolCalls.push({callId:a.callId,name:a.name,args:c}),this.hasReceivedContent=!0,this.markActivity()}}}processTextWithThinkingTags(e,t){if(t.outputThinking===!1)return e.replace(/<thinking>[\s\S]*?<\/thinking>/g,"");let o="",r=this.thinkingTagBuffer+e;for(this.thinkingTagBuffer="";r.length>0;)if(this.isInsideThinkingTag){let i=r.indexOf(this.CLOSING_TAG);if(i!==-1){let a=r.slice(0,i);a.length>0&&(this.currentThinkingId||(this.currentThinkingId=this.generateThinkingId()),this.thinkingBuffer+=a,this.hasThinkingContent=!0),this.isInsideThinkingTag=!1,r=r.slice(i+this.CLOSING_TAG.length)}else{let a=Math.max(0,r.length-12);a>0&&(this.currentThinkingId||(this.currentThinkingId=this.generateThinkingId()),this.thinkingBuffer+=r.slice(0,a),this.hasThinkingContent=!0),this.thinkingTagBuffer=r.slice(a),r=""}}else{let i=r.indexOf("<thinking>");if(i!==-1)o+=r.slice(0,i),this.isInsideThinkingTag=!0,this.currentThinkingId||(this.currentThinkingId=this.generateThinkingId()),r=r.slice(i+10);else{let a=Math.max(0,r.length-10);o+=r.slice(0,a),this.thinkingTagBuffer=r.slice(a),r=""}}return o}flushTextBuffer(e,t=!1){this.textBuffer.length>0&&(t||this.textBuffer.length>=n.TEXT_BUFFER_MIN_SIZE)&&(e.report(new Gn.LanguageModelTextPart(this.textBuffer)),this.textBuffer="",this.textBufferLastFlush=Date.now(),this.markActivity())}flushTextBufferIfNeeded(e){if(this.textBuffer.length===0)return;let t=Date.now()-this.textBufferLastFlush;(this.textBuffer.length>=n.TEXT_BUFFER_MIN_SIZE||t>=n.TEXT_BUFFER_MAX_DELAY_MS)&&this.flushTextBuffer(e,!0)}flushTextBufferAdaptive(e){if(this.textBuffer.length===0)return;let t=this.streamVelocity>n.HIGH_VELOCITY_THRESHOLD,o=n.TEXT_BUFFER_MIN_SIZE,r=n.TEXT_BUFFER_MAX_DELAY_MS,i=n.ADAPTIVE_BUFFER_MULTIPLIER,a=t?Math.floor(o*i):o,s=t?Math.floor(r*i):r,c=Date.now()-this.textBufferLastFlush;(this.textBuffer.length>=a||c>=s)&&this.flushTextBuffer(e,!0)}flushThinkingBuffer(e){this.thinkingBuffer.length>0&&this.currentThinkingId&&(this.enqueueThinking(this.thinkingBuffer,e),this.thinkingBuffer="")}flushThinkingBufferIfNeeded(e){this.flushThinkingBuffer(e)}enqueueThinking(e,t){this.thinkingQueue+=e,this.thinkingProgress=t,this.markActivity(),this.thinkingFlushInterval||(this.thinkingFlushInterval=setInterval(()=>this.flushThinkingChunk(),n.THINKING_FLUSH_INTERVAL_MS))}flushThinkingChunk(){if(this.thinkingQueue.length===0||!this.thinkingProgress||!this.currentThinkingId)return;let e=Math.min(n.THINKING_CHARS_PER_FLUSH,this.thinkingQueue.length),t=this.thinkingQueue.slice(0,e);this.thinkingQueue=this.thinkingQueue.slice(e),this.thinkingProgress.report(new Gn.LanguageModelThinkingPart(t,this.currentThinkingId)),this.markActivity()}finalizeThinkingPart(e){for(this.thinkingFlushInterval&&(clearInterval(this.thinkingFlushInterval),this.thinkingFlushInterval=null),this.thinkingBuffer.length>0&&(this.thinkingQueue+=this.thinkingBuffer,this.thinkingBuffer=""),this.thinkingProgress=e;this.thinkingQueue.length>0;){let t=Math.min(n.THINKING_CHARS_PER_FLUSH*2,this.thinkingQueue.length),o=this.thinkingQueue.slice(0,t);this.thinkingQueue=this.thinkingQueue.slice(t),this.currentThinkingId&&e.report(new Gn.LanguageModelThinkingPart(o,this.currentThinkingId))}this.currentThinkingId&&(e.report(new Gn.LanguageModelThinkingPart("",this.currentThinkingId)),this.currentThinkingId=null)}splitConcatenatedJSON(e){let t=[],o=0,r=-1;for(let i=0;i<e.length;i++)e[i]==="{"?(o===0&&(r=i),o++):e[i]==="}"&&(o--,o===0&&r!==-1&&(t.push(e.slice(r,i+1)),r=-1));return t}generateThinkingId(){return`thinking_${Date.now()}_${Math.random().toString(36).slice(2,8)}`}};var K$=["https://daily-cloudcode-pa.sandbox.googleapis.com","https://cloudcode-pa.googleapis.com"],H$="antigravity/1.11.5",Z$=5,G$=1e3,uh=3e4,V$=1e3,fk=1800*1e3,Q$=600*1e3,hk=120*1e3,W$=new Set(["$ref","$defs","definitions","$id","$anchor","$dynamicRef","$dynamicAnchor","$schema","$vocabulary","$comment","exclusiveMinimum","exclusiveMaximum","minimum","maximum","multipleOf","additionalProperties","minLength","maxLength","pattern","minItems","maxItems","uniqueItems","minContains","maxContains","minProperties","maxProperties","if","then","else","dependentSchemas","dependentRequired","unevaluatedItems","unevaluatedProperties","contentEncoding","contentMediaType","contentSchema","dependencies","allOf","anyOf","oneOf","not","strict","input_examples","examples"]),dh=new Map,J$="skip_thought_signature_validator";function ch(n,e){n&&e&&dh.set(n,e)}function X$(n){switch(n){case 400:return"user_error";case 401:return"auth_error";case 402:case 403:case 429:return"quota_error";case 404:return"not_found";case 500:case 502:case 503:case 504:return"transient";default:return"unknown"}}function Y$(n){return n==="quota_error"||n==="transient"||n==="auth_error"}function eE(n,e){if(n!==403||!e)return!1;if(e.toLowerCase().includes("permission denied"))return!0;try{let t=JSON.parse(e);if(t?.error?.status==="PERMISSION_DENIED")return!0;let o=t?.error?.details;if(Array.isArray(o)){for(let r of o)if(r["@type"]==="type.googleapis.com/google.rpc.ErrorInfo"&&r.reason==="CONSUMER_INVALID")return!0}}catch{}return!1}function vk(n){let e=n.match(/^(\d+(?:\.\d+)?)s$/);return e?Math.round(parseFloat(e[1])*1e3):null}function gk(n){let e=vk(n);if(e!==null)return e;let t=0,o=n.match(/(\d+)h/),r=n.match(/(\d+)m/),i=n.match(/(\d+(?:\.\d+)?)s/);return o&&(t+=parseInt(o[1],10)*60*60*1e3),r&&(t+=parseInt(r[1],10)*60*1e3),i&&(t+=Math.round(parseFloat(i[1])*1e3)),t>0?t:null}function Nd(n){try{let e=JSON.parse(n),t=e?.error||e,o=t?.details||(Array.isArray(e)?e[0]?.error?.details:null);if(!o){if(t?.metadata?.quotaResetDelay){let r=gk(t.metadata.quotaResetDelay);if(r!==null&&r>0)return r}return null}for(let r of o){if(r["@type"]==="type.googleapis.com/google.rpc.RetryInfo"&&r.retryDelay){let i=vk(r.retryDelay);if(i!==null&&i>0)return i}if(r["@type"]==="type.googleapis.com/google.rpc.ErrorInfo"&&r.metadata?.quotaResetDelay){let i=gk(r.metadata.quotaResetDelay);if(i!==null&&i>0)return i}}}catch{}return null}function yk(n,e){return new Promise(t=>{if(n<=0){t();return}let o=setTimeout(t,n),r=e.onCancellationRequested(()=>{clearTimeout(o),t()});setTimeout(()=>r.dispose(),n+100)})}var ph=class n{static instance;modelStates=new Map;static getInstance(){return n.instance||(n.instance=new n),n.instance}markQuotaExceeded(e,t){let o=this.modelStates.get(e)||{isExhausted:!1,resetsAt:0,lastUpdated:0,exceeded:!1,nextRecoverAt:0,backoffLevel:0},r=V$*2**(o.backoffLevel||0);r>fk&&(r=fk);let i=t&&t>r?t:r;this.modelStates.set(e,{isExhausted:!0,resetsAt:Date.now()+i,lastUpdated:Date.now(),exceeded:!0,nextRecoverAt:Date.now()+i,backoffLevel:(o.backoffLevel||0)+1,lastError:`Quota exceeded, retry after ${Math.round(i/1e3)}s`})}clearQuotaExceeded(e){let t=this.modelStates.get(e);t&&(t.exceeded=!1,t.backoffLevel=0,t.lastError=void 0)}isInCooldown(e){let t=this.modelStates.get(e);return!t||!t.exceeded?!1:Date.now()>=(t.nextRecoverAt||0)?(this.clearQuotaExceeded(e),!1):!0}getRemainingCooldown(e){let t=this.modelStates.get(e);if(!t||!t.exceeded)return 0;let o=(t.nextRecoverAt||0)-Date.now();return o>0?o:0}},mh=class{retryCount=0;async handleRateLimit(e,t,o){if(e)return"continue";if(this.retryCount>=Z$)return"max_exceeded";let r=G$*2**this.retryCount,i=Nd(t);return i!==null?r=Math.min(i+500,uh):r>uh&&(r=uh),this.retryCount++,await yk(r,o),o.isCancellationRequested?"max_exceeded":"retry"}};function tE(n){if(!n||typeof n!="object"||Array.isArray(n))return{type:"object",properties:{}};let e;try{e=JSON.parse(JSON.stringify(n))}catch{return{type:"object",properties:{}}}let t=o=>{if(o){if(Array.isArray(o.properties)&&(o.properties={}),Array.isArray(o.items)){let r=o.items[0];o.items=r&&typeof r=="object"?r:void 0}typeof o.type=="string"&&(o.type=o.type.toLowerCase());for(let r of Object.keys(o))W$.has(r)&&delete o[r];for(let r of[o.properties,o.items,o.additionalProperties,o.patternProperties,o.propertyNames,o.contains])if(r&&typeof r=="object"&&!Array.isArray(r)&&t(r),Array.isArray(r))for(let i of r)i&&typeof i=="object"&&t(i);if(o.properties&&typeof o.properties=="object")for(let r of Object.values(o.properties))r&&typeof r=="object"&&t(r)}};return t(e),(typeof e.type!="string"||!e.type.trim()||e.type==="None")&&(e.type="object"),(!e.properties||typeof e.properties!="object")&&(e.properties={}),e}function nE(n){return n.map(e=>{let t=dh.get(e.callId),o=t||J$;return t||dh.set(e.callId,o),{functionCall:{name:e.name,id:e.callId,args:e.input},thoughtSignature:o}})}function lh(n){let e=n.functionCall;return e?.name?{callId:e.id||`call_${Date.now()}_${Math.random().toString(36).substring(2,15)}`,name:e.name,args:e.args,thoughtSignature:n.thoughtSignature}:null}var fh=class{convertMessagesToGemini(e,t,o){let r=[],i="",a=new Map;for(let m of e)if(m.role===ze.LanguageModelChatMessageRole.Assistant)for(let h of m.content)h instanceof ze.LanguageModelToolCallPart&&a.set(h.callId,h.name);let s=t.outputThinking!==!1||t.includeThinking===!0,l=(o||t.model||"").toLowerCase().includes("claude"),p=e.filter(m=>m.role!==ze.LanguageModelChatMessageRole.System).length,f=0;for(let m of e){if(m.role===ze.LanguageModelChatMessageRole.System){i=m.content.filter(h=>h instanceof ze.LanguageModelTextPart).map(h=>h.value).join(`
`);continue}if(f++,m.role===ze.LanguageModelChatMessageRole.User){let h=[],g=m.content.filter(v=>v instanceof ze.LanguageModelTextPart).map(v=>v.value).join(`
`);g&&h.push({text:g});for(let v of m.content)if(v instanceof ze.LanguageModelDataPart&&v.mimeType.toLowerCase().startsWith("image/")&&h.push({inlineData:{mimeType:v.mimeType,data:Buffer.from(v.data).toString("base64")}}),v instanceof ze.LanguageModelToolResultPart){let k=a.get(v.callId)||"unknown",x="";typeof v.content=="string"?x=v.content:Array.isArray(v.content)?x=v.content.map(w=>w instanceof ze.LanguageModelTextPart?w.value:JSON.stringify(w)).join(`
`):x=JSON.stringify(v.content);let y={content:x};try{let w=JSON.parse(x.trim());w&&typeof w=="object"&&(y=Array.isArray(w)?{result:w}:w)}catch{}h.push({functionResponse:{name:k,id:v.callId,response:y}})}h.length>0&&r.push({role:"user",parts:h});continue}if(m.role===ze.LanguageModelChatMessageRole.Assistant){let h=[];if(!l&&(t.includeThinking===!0||t.outputThinking!==!1)){for(let x of m.content)if(x instanceof ze.LanguageModelThinkingPart){let y=Array.isArray(x.value)?x.value.join(""):x.value;y&&h.push({text:y,thought:!0});break}}let v=m.content.filter(x=>x instanceof ze.LanguageModelTextPart).map(x=>x.value).join(`
`);v&&h.push({text:v});let k=m.content.filter(x=>x instanceof ze.LanguageModelToolCallPart);k.length>0&&h.push(...nE(k)),l&&(h=h.filter(x=>x.thought!==!0)),!l&&s&&f===p&&!h.some(x=>x.thought===!0)&&h.unshift({text:"Thinking...",thought:!0}),h.length>0&&r.push({role:"model",parts:h})}}return{contents:r,systemInstruction:i?{role:"user",parts:[{text:i}]}:void 0}}},hh=class{messageConverter=new fh;MODEL_ALIASES={"gemini-2.5-computer-use-preview-10-2025":"rev19-uic3-1p","gemini-3-pro-image-preview":"gemini-3-pro-image","gemini-3-pro-preview":"gemini-3-pro-high","gemini-claude-sonnet-4-5":"claude-sonnet-4-5","claude-sonnet-4-5":"claude-sonnet-4-5","gemini-claude-sonnet-4-5-thinking":"claude-sonnet-4-5-thinking","claude-sonnet-4-5-thinking":"claude-sonnet-4-5-thinking","gemini-claude-opus-4-5-thinking":"claude-opus-4-5-thinking","claude-opus-4-5-thinking":"claude-opus-4-5-thinking"};aliasToModelName(e){return this.MODEL_ALIASES[e]||e}buildAntigravityPayload(e,t,o,r,i,a){let s=L.getMaxTokensForModel(e.maxOutputTokens),c=this.aliasToModelName(i).toLowerCase(),{contents:l,systemInstruction:d}=this.messageConverter.convertMessagesToGemini(o,t,c),p=c.includes("claude")&&c.includes("thinking"),f=t.outputThinking!==!1||t.includeThinking===!0,m={maxOutputTokens:s,temperature:L.getTemperature(),topP:L.getTopP()},h=r.tools&&r.tools.length>0&&e.capabilities?.toolCalling;if(p&&f&&!h){let k=t.thinkingBudget||1e4;s<k+1e3&&(m.maxOutputTokens=k+1e3),m.thinkingConfig={includeThoughts:!0,thinkingBudget:k}}let g={contents:l,generationConfig:m};d&&(g.systemInstruction=d),h&&(g.tools=[{functionDeclarations:r.tools?.map(k=>({name:k.name,description:k.description||"",parameters:k.inputSchema&&typeof k.inputSchema=="object"?tE(k.inputSchema):{type:"object",properties:{}}}))}],g.toolConfig={functionCallingConfig:{mode:"AUTO"}}),g.safetySettings=[{category:"HARM_CATEGORY_HARASSMENT",threshold:"OFF"},{category:"HARM_CATEGORY_HATE_SPEECH",threshold:"OFF"},{category:"HARM_CATEGORY_SEXUALLY_EXPLICIT",threshold:"OFF"},{category:"HARM_CATEGORY_DANGEROUS_CONTENT",threshold:"OFF"},{category:"HARM_CATEGORY_CIVIC_INTEGRITY",threshold:"BLOCK_NONE"}],t.extraBody&&typeof t.extraBody=="object"&&Object.assign(g,t.extraBody);let v=Or.default.randomUUID?Or.default.randomUUID():Or.default.randomBytes(16).toString("hex");return{project:a||this.generateProjectId(),model:this.aliasToModelName(i),userAgent:"antigravity",requestId:`agent-${v}`,request:{...g,sessionId:`-${v.replace(/-/g,"").slice(0,16)}`}}}generateProjectId(){let e=["useful","bright","swift","calm","bold"],t=["fuze","wave","spark","flow","core"],o=Or.default.randomBytes(2);return`${e[o[0]%e.length]}-${t[o[1]%t.length]}-${(Or.default.randomUUID?Or.default.randomUUID():Or.default.randomBytes(16).toString("hex")).replace(/-/g,"").slice(0,5).toLowerCase()}`}},nl=class{constructor(e){this.displayName=e}quotaManager=ph.getInstance();accountQuotaCache=it.getInstance();quotaNotificationManager=new gs;fromIRTranslator=new hh;cacheUpdateTimers=new Map;pendingCacheUpdates=new Map;projectIdCache=null;projectIdPromise=null;async handleRequest(e,t,o,r,i,a,s,c,l){await Ie.getInstance("antigravity",2,1e3).throttle(this.displayName);let d=s||await et.getAccessToken();if(!d)throw new Error("Not logged in to Antigravity. Please login first.");let p=t.model||e.id,f=this.fromIRTranslator.aliasToModelName(p),m=c||"default-antigravity",h=`${m}:${f}`;if(this.quotaManager.isInCooldown(h)){let $=this.quotaManager.getRemainingCooldown(h);if($>5e3&&this.quotaNotificationManager.notifyQuotaExceeded($,f,c,this.displayName),$>hk)throw this.debouncedCacheUpdate(`quota-${m}`,()=>this.accountQuotaCache.markQuotaExceeded(m,"antigravity",{accountName:this.displayName,resetDelayMs:$,affectedModel:f,error:"Quota cooldown exceeds max wait threshold"}),50),await this.quotaNotificationManager.notifyQuotaTooLong($,f,c,this.displayName),new Error(`Quota wait too long (${this.quotaNotificationManager.formatDuration($)}). Please add another account or try again later.`);if(await yk($,a),a.isCancellationRequested)throw new ze.CancellationError}let g=await this.getProjectId(d),v=this.fromIRTranslator.buildAntigravityPayload(e,t,o,r,f,g),k=t.baseUrl?[t.baseUrl.replace(/\/v1internal\/?$/,"")]:[...K$],x=new AbortController,y=a.onCancellationRequested(()=>x.abort()),w=new mh;i.report(new ze.LanguageModelTextPart(""));let b=0,C="",I=null;try{for(let $=0;$<k.length;$++){let M=`${k[$].replace(/\/$/,"")}/v1internal:streamGenerateContent?alt=sse`;if(a.isCancellationRequested)throw new ze.CancellationError;try{let A=await this.streamRequest(M,d,v,t,i,a,x);if(A.success){this.quotaManager.clearQuotaExceeded(h),this.quotaNotificationManager.clearQuotaCountdown(),this.debouncedCacheUpdate(`success-${m}`,()=>this.accountQuotaCache.recordSuccess(m,"antigravity",this.displayName),50);try{let F=await he.getInstance().countMessagesTokens(e,[...o],{sdkMode:t.sdkMode||"openai"},r);Gt.getInstance().recordSuccess({modelId:e.id,modelName:e.name,providerId:"antigravity",promptTokens:F,completionTokens:0,totalTokens:F,maxInputTokens:e.maxInputTokens,maxOutputTokens:e.maxOutputTokens,estimatedPromptTokens:!0})}catch(F){u.trace(`[Antigravity] Failed to estimate prompt tokens: ${String(F)}`)}return}if(eE(A.status,A.body))throw this.debouncedCacheUpdate(`failure-${m}`,()=>this.accountQuotaCache.recordFailure(m,"antigravity",`HTTP ${A.status||403}: ${A.body||"Permission denied"}`,this.displayName),50),new Error(A.body||"Permission denied on Antigravity project.");let z=X$(A.status||0);if(z==="quota_error"){b=A.status||0,C=A.body||"";let F=Nd(C);this.quotaManager.markQuotaExceeded(h,F||void 0);let q=this.quotaManager.getRemainingCooldown(h);if(q>5e3&&this.quotaNotificationManager.notifyQuotaExceeded(q,f,m,this.displayName),this.debouncedCacheUpdate(`quota-${m}`,()=>this.accountQuotaCache.markQuotaExceeded(m,"antigravity",{accountName:this.displayName,resetDelayMs:F||q,affectedModel:f,error:`HTTP ${b}: Quota exceeded`}),50),q>hk)throw await this.quotaNotificationManager.notifyQuotaTooLong(q,f,m,this.displayName),new Error(`Quota wait too long (${this.quotaNotificationManager.formatDuration(q)}). Please add another account or try again later.`);if(F&&F>Q$)throw new Error(`Account quota exhausted (quota resets in ${this.quotaNotificationManager.formatDuration(F)}). Please wait or use a different account.`);if($+1<k.length)continue;if(l!==!1&&await w.handleRateLimit(!1,C,a)==="retry"){$--;continue}throw new Error(`Quota exceeded${F?` (quota resets in ${this.quotaNotificationManager.formatDuration(F)})`:""}: ${C||`HTTP ${A.status}`}`)}if(z==="transient"&&Y$(z)&&$+1<k.length){b=A.status||0,C=A.body||"";continue}if(z==="auth_error")throw new Error("Authentication failed. Please re-login to Antigravity.");if(A.status===404&&$+1<k.length){b=A.status,C=A.body||"";continue}throw new Error(A.body||`HTTP ${A.status} ${A.statusText}`)}catch(A){if(A instanceof ze.CancellationError||A instanceof Error&&(A.message.startsWith("Quota exceeded")||A.message.startsWith("Rate limited")||A.message.startsWith("HTTP")||A.message.startsWith("Authentication failed")))throw A;if(b=0,C="",I=A instanceof Error?A:new Error(String(A)),$+1<k.length)continue;throw A}}throw b!==0?new Error(`HTTP ${b}${Nd(C)?` (quota resets in ${this.quotaNotificationManager.formatDuration(Nd(C))})`:""}: ${C}`):I||new Error("All Antigravity endpoints unavailable")}finally{y.dispose()}}async streamRequest(e,t,o,r,i,a,s){let c;try{c=await fetch(e,{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json",Accept:"text/event-stream","User-Agent":H$},body:JSON.stringify(o),signal:s.signal})}catch(l){throw a.isCancellationRequested||s.signal.aborted?new ze.CancellationError:l}return c.ok?(r.sdkMode==="openai"||r.sdkMode==="openai-sse"?await new Pi().processStream({response:c,modelConfig:r,progress:i,token:a}):await new Ld().processStream({response:c,modelConfig:r,progress:i,token:a}),{success:!0}):{success:!1,status:c.status,statusText:c.statusText,body:await c.text()}}async getProjectId(e){return this.projectIdCache?this.projectIdCache:this.projectIdPromise?this.projectIdPromise:(this.projectIdPromise=et.ensureProjectId(e).then(t=>(this.projectIdCache=t,this.projectIdPromise=null,t)).catch(t=>{throw this.projectIdPromise=null,t}),this.projectIdPromise)}isInCooldown(e,t){return this.quotaManager.isInCooldown(`${t||"default-antigravity"}:${this.fromIRTranslator.aliasToModelName(e)}`)}getRemainingCooldown(e,t){return this.quotaManager.getRemainingCooldown(`${t||"default-antigravity"}:${this.fromIRTranslator.aliasToModelName(e)}`)}debouncedCacheUpdate(e,t,o){let r=this.cacheUpdateTimers.get(e);r&&clearTimeout(r),this.pendingCacheUpdates.set(e,t);let i=setTimeout(()=>{let a=this.pendingCacheUpdates.get(e);a&&(a().catch(()=>{}),this.pendingCacheUpdates.delete(e)),this.cacheUpdateTimers.delete(e)},o);this.cacheUpdateTimers.set(e,i)}};var Vt=D(require("vscode"));Ke();ot();ce();var Go=D(require("vscode"));Ke();ot();ce();var De=class n{static async startWizard(e){let t=e.supportsApiKey!==!1,o=e.supportsBaseUrl!==!1,r=n.getBaseUrlInfo(e.providerKey),i=[];if(t&&i.push({label:`$(key) Configure ${e.displayName} API Key`,detail:`Set or clear ${e.displayName} API key`,action:"apiKey"}),o){let s=r.override||r.defaultBaseUrl;i.push({label:"$(globe) Configure Base URL (Proxy)",description:s?`Current: ${s}`:"Current: Default",detail:`Override ${e.displayName} endpoint (optional)`,action:"baseUrl"})}if(i.length===0)return;let a=await Go.window.showQuickPick(i,{title:`${e.displayName} Configuration`,placeHolder:"Select an option to configure"});if(a){if(a.action==="apiKey"){await n.configureApiKey(e);return}a.action==="baseUrl"&&await n.configureBaseUrl(e.providerKey,e.displayName)}}static async configureApiKey(e){e.apiKeyTemplate&&await R.promptAndSetApiKey(e.providerKey,e.displayName,e.apiKeyTemplate)}static async configureBaseUrl(e,t){let o=n.getBaseUrlInfo(e),r=await Go.window.showInputBox({prompt:`Enter ${t} base URL (leave empty to clear override)`,title:`${t} Base URL`,value:o.override??"",placeHolder:o.defaultBaseUrl||"https://example.com/v1"});if(r!==void 0)try{await Go.workspace.getConfiguration("chp").update(`${e}.baseUrl`,r.trim(),Go.ConfigurationTarget.Global);let a=r.trim()?`${t} base URL updated.`:`${t} base URL override cleared.`;Go.window.showInformationMessage(a)}catch(i){let a=`Failed to update ${t} base URL: ${i instanceof Error?i.message:"Unknown error"}`;u.error(a),Go.window.showErrorMessage(a)}}static getBaseUrlInfo(e){let t=L.getConfigProvider(),o=L.getProviderOverrides();return{defaultBaseUrl:t[e]?.baseUrl,override:o[e]?.baseUrl}}};var Vn=class n{static PROVIDER_KEY="minimax";static CODING_PLAN_KEY="minimax-coding";static async startWizard(e,t){try{let r=L.getMinimaxEndpoint()==="minimax.io"?"International (minimax.io)":"China (minimaxi.com)",i=await Vt.window.showQuickPick([{label:"$(key) Configure Regular API Key",detail:"For standard pay-as-you-go models like MiniMax-M2",value:"normal"},{label:"$(key) Configure Coding Plan Dedicated Key",detail:"For MiniMax-M2 (Coding Plan) model",value:"coding"},{label:"$(check-all) Configure Both Keys",detail:"Configure regular key and Coding Plan key in sequence",value:"both"},{label:"$(globe) Set Coding Plan Endpoint",description:`Current: ${r}`,detail:"Set the endpoint site for Coding Plan: China (minimaxi.com) or International (minimax.io)",value:"endpoint"},{label:"$(globe) Configure Base URL (Proxy)",detail:"Override MiniMax endpoint (optional)",value:"baseUrl"}],{title:`${e} Key Configuration`,placeHolder:"Please select an option to configure"});if(!i){u.debug("User cancelled MiniMax configuration wizard");return}(i.value==="normal"||i.value==="both")&&await n.setNormalApiKey(e,t),(i.value==="coding"||i.value==="both")&&await n.setCodingPlanApiKey(e,t),i.value==="endpoint"&&await n.setCodingPlanEndpoint(e),i.value==="baseUrl"&&await De.configureBaseUrl("minimax",e)}catch(o){u.error(`MiniMax configuration wizard error: ${o instanceof Error?o.message:"Unknown error"}`)}}static async setNormalApiKey(e,t){let o=await Vt.window.showInputBox({prompt:`Enter ${e} regular API Key (leave empty to clear)`,title:`Set ${e} Regular API Key`,placeHolder:t,password:!0,validateInput:r=>(!r||r.trim()==="",null)});if(o!==void 0)try{o.trim()===""?(u.info(`${e} regular API Key cleared`),await R.deleteApiKey(n.PROVIDER_KEY),Vt.window.showInformationMessage(`${e} regular API Key cleared`)):(await R.setApiKey(n.PROVIDER_KEY,o.trim()),u.info(`${e} regular API Key set`),Vt.window.showInformationMessage(`${e} regular API Key set`))}catch(r){u.error(`Regular API Key operation failed: ${r instanceof Error?r.message:"Unknown error"}`),Vt.window.showErrorMessage(`Setup failed: ${r instanceof Error?r.message:"Unknown error"}`)}}static async setCodingPlanApiKey(e,t){let o=await Vt.window.showInputBox({prompt:`Enter ${e} Coding Plan dedicated API Key (leave empty to clear)`,title:`Set ${e} Coding Plan Dedicated API Key`,placeHolder:t,password:!0,validateInput:r=>(!r||r.trim()==="",null)});if(o!==void 0)try{o.trim()===""?(u.info(`${e} Coding Plan dedicated API Key cleared`),await R.deleteApiKey(n.CODING_PLAN_KEY),Vt.window.showInformationMessage(`${e} Coding Plan dedicated API Key cleared`)):(await R.setApiKey(n.CODING_PLAN_KEY,o.trim()),u.info(`${e} Coding Plan dedicated API Key set`),Vt.window.showInformationMessage(`${e} Coding Plan dedicated API Key set`),await n.setCodingPlanEndpoint(e))}catch(r){u.error(`Coding Plan API Key operation failed: ${r instanceof Error?r.message:"Unknown error"}`),Vt.window.showErrorMessage(`Setup failed: ${r instanceof Error?r.message:"Unknown error"}`)}}static async setCodingPlanEndpoint(e){try{let t=await Vt.window.showQuickPick([{label:"$(home) China (minimaxi.com)",value:"minimaxi.com"},{label:"$(globe) International (minimax.io)",value:"minimax.io"}],{title:`${e} (Coding Plan) Endpoint Selection`,placeHolder:"Please select an endpoint",canPickMany:!1});if(!t){u.debug(`User cancelled ${e} Coding Plan endpoint selection`);return}await n.saveCodingPlanSite(t.value);let o=t.value==="minimax.io"?"International":"China";u.info(`${e} Coding Plan endpoint set to: ${o}`),Vt.window.showInformationMessage(`${e} Coding Plan endpoint set to: ${o}`)}catch(t){u.error(`Coding Plan endpoint setup failed: ${t instanceof Error?t.message:"Unknown error"}`)}}static async saveCodingPlanSite(e){try{await Vt.workspace.getConfiguration("chp.minimax").update("endpoint",e,Vt.ConfigurationTarget.Global),u.info(`Coding Plan endpoint saved: ${e}`)}catch(t){throw u.error(`Failed to save Coding Plan endpoint: ${t instanceof Error?t.message:"Unknown error"}`),t}}};var st=D(require("vscode"));cr();Ke();ot();ce();var ol=class{constructor(e,t,o="https://api.mistral.ai/v1"){this.provider=e;this.displayName=t;this.baseURL=o;this.quotaCache=it.getInstance()}toolCallIdMapping=new Map;reverseToolCallIdMapping=new Map;quotaCache;generateToolCallId(){let e="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789",t="";for(let o=0;o<9;o++)t+=e.charAt(Math.floor(Math.random()*e.length));return t}getOrCreateVsCodeToolCallId(e){if(this.reverseToolCallIdMapping.has(e))return this.reverseToolCallIdMapping.get(e);let t=this.generateToolCallId();return this.toolCallIdMapping.set(t,e),this.reverseToolCallIdMapping.set(e,t),t}getMistralToolCallId(e){return this.toolCallIdMapping.get(e)}clearToolCallIdMappings(){this.toolCallIdMapping.clear(),this.reverseToolCallIdMapping.clear()}async handleRequest(e,t,o,r,i,a,s){await Ie.getInstance(this.provider,2,1e3).throttle(this.displayName),this.clearToolCallIdMappings(),u.debug(`${e.name} starting to process Mistral request${s?` (Account ID: ${s})`:""}`);try{let c=t.apiKey;if(c||(c=await R.getApiKey(this.provider)),!c)throw new Error(`Missing ${this.displayName} API key`);let l=t.baseUrl||this.baseURL,d=t.model||e.id,p=this.convertMessagesToMistral(o),f=r.tools&&r.tools.length>0?this.convertToolsToMistral([...r.tools]):void 0,m={model:d,messages:p,tools:f,tool_choice:f?r.toolMode===st.LanguageModelChatToolMode.Required?"any":"auto":void 0,max_tokens:L.getMaxTokensForModel(e.maxOutputTokens),temperature:L.getTemperature(),top_p:L.getTopP(),stream:!0},h=await fetch(`${l}/chat/completions`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${c}`,"User-Agent":Nt.getUserAgent("Mistral")},body:JSON.stringify(m),signal:this.createAbortSignal(a)});if(!h.ok){let w=await h.text();throw new Error(`Mistral API error: ${h.status} ${h.statusText} - ${w}`)}if(!h.body)throw new Error("Mistral response body is empty");let g=await this.processStream(h.body,i,a,e.name),v=g.promptTokens,k=g.completionTokens,x=g.totalTokens,y=!1;if(v===void 0)try{v=await he.getInstance().countMessagesTokens(e,[...o],{sdkMode:t.sdkMode||"openai"},r),k=0,x=v,y=!0}catch(w){u.trace(`${e.name} failed to estimate prompt tokens: ${String(w)}`)}v!==void 0&&k!==void 0&&Gt.getInstance().recordSuccess({modelId:e.id,modelName:e.name,providerId:this.provider,promptTokens:v,completionTokens:k,totalTokens:x,maxInputTokens:e.maxInputTokens,maxOutputTokens:e.maxOutputTokens,estimatedPromptTokens:y}),s&&await this.quotaCache.recordSuccess(s,this.provider)}catch(c){throw s&&!(c instanceof st.CancellationError)&&(this.isQuotaError(c)?await this.quotaCache.markQuotaExceeded(s,this.provider,{error:c instanceof Error?c.message:String(c),affectedModel:e.id}):await this.quotaCache.recordFailure(s,this.provider,c instanceof Error?c.message:String(c))),c instanceof st.CancellationError?(u.info(`${e.name} request cancelled by user`),c):(u.error(`${e.name} Mistral request failed: ${c}`),c)}}createAbortSignal(e){let t=new AbortController;return e.onCancellationRequested(()=>t.abort()),t.signal}async processStream(e,t,o,r){let i=e.getReader(),a=new TextDecoder,s="",c=new Map,l=new Set,d=!1,p=!1,f;try{for(;;){let{done:m,value:h}=await i.read();if(m||o.isCancellationRequested)break;s+=a.decode(h,{stream:!0});let g=s.split(`
`);s=g.pop()||"";for(let v of g){let k=v.trim();if(!k||!k.startsWith("data:"))continue;let x=k.slice(5).trim();if(x==="[DONE]")break;try{let y=JSON.parse(x);if(y.choices&&y.choices.length>0)for(let w of y.choices){let b=w.delta?.tool_calls??w.message?.tool_calls;if(b)for(let C of b)C.type||(C.type="function")}if(y.choices&&y.choices.length>0){let w=y.choices[0],b=w.delta,C=w.message,I=b?.content??C?.content,$=b?.tool_calls??C?.tool_calls;if(I&&(t.report(new st.LanguageModelTextPart(I)),I.trim().length>0&&(d=!0)),$)for(let M of $){let A=M.id;if(!A)continue;let z=this.getOrCreateVsCodeToolCallId(A),F=c.get(z)??{argsText:""};if(M.function?.name&&(F.name=M.function.name),M.function?.arguments&&(F.argsText+=M.function.arguments),c.set(z,F),!l.has(z)&&F.name&&F.argsText)try{let q=JSON.parse(F.argsText);t.report(new st.LanguageModelToolCallPart(z,F.name,q)),l.add(z),d=!0}catch{}}if(w.finish_reason==="tool_calls"||w.finish_reason==="stop"){for(let[M,A]of c)if(!l.has(M)&&A.name){let z={};try{z=A.argsText?JSON.parse(A.argsText):{}}catch{z={raw:A.argsText}}t.report(new st.LanguageModelToolCallPart(M,A.name,z)),l.add(M),d=!0}}}y.usage&&(f=y.usage,u.info(`${r} Token usage: ${y.usage.prompt_tokens}+${y.usage.completion_tokens}=${y.usage.total_tokens}`))}catch(y){u.trace(`Failed to parse Mistral chunk: ${y}`)}}}}finally{i.releaseLock()}return p&&!d&&(t.report(new st.LanguageModelTextPart("<think/>")),u.warn(`${r} end of message stream has only thinking content and no text content, added <think/> placeholder as output`)),{promptTokens:f?.prompt_tokens,completionTokens:f?.completion_tokens,totalTokens:f?.total_tokens}}convertMessagesToMistral(e){let t=[];for(let o of e){let r=this.toMistralRole(o.role),i=this.extractTextContent(o.content),a={role:r,content:i||null};if(o.role===st.LanguageModelChatMessageRole.Assistant){let s=[];for(let c of o.content)if(c instanceof st.LanguageModelToolCallPart){let l=this.getMistralToolCallId(c.callId);l||(l=this.generateToolCallId(),this.toolCallIdMapping.set(c.callId,l),this.reverseToolCallIdMapping.set(l,c.callId)),s.push({id:l,type:"function",function:{name:c.name,arguments:JSON.stringify(c.input)}})}s.length>0&&(a.tool_calls=s)}if(o.role===st.LanguageModelChatMessageRole.User){for(let s of o.content)if(s instanceof st.LanguageModelToolResultPart){let c=this.getMistralToolCallId(s.callId);c||(c=this.generateToolCallId(),this.toolCallIdMapping.set(s.callId,c),this.reverseToolCallIdMapping.set(c,s.callId));let l=this.extractTextContent(s.content);t.push({role:"tool",content:l||"",tool_call_id:c,name:void 0})}}a.role!=="tool"&&(a.content||a.tool_calls&&a.tool_calls.length>0)&&t.push(a)}return t}toMistralRole(e){switch(e){case st.LanguageModelChatMessageRole.System:return"system";case st.LanguageModelChatMessageRole.User:return"user";case st.LanguageModelChatMessageRole.Assistant:return"assistant";default:return"user"}}isQuotaError(e){if(!(e instanceof Error))return!1;let t=e.message;return t.startsWith("Quota exceeded")||t.startsWith("Rate limited")||t.includes("429")}extractTextContent(e){let t=e.filter(o=>o instanceof st.LanguageModelTextPart).map(o=>o.value);return t.length>0?t.join(`
`):null}convertToolsToMistral(e){return e.map(t=>({type:"function",function:{name:t.name,description:t.description||"",parameters:t.inputSchema||{type:"object",properties:{}}}}))}};var xo=D(require("vscode"));Ke();ce();var rl=class n{static PROVIDER_KEY="moonshot";static KIMI_KEY="kimi";static async startWizard(e,t){try{let o=await xo.window.showQuickPick([{label:"$(key) Configure Moonshot API Key",detail:"API key for calling Kimi-K2 series and other models on Moonshot AI Open Platform",value:"moonshot"},{label:"$(key) Configure Kimi For Coding Dedicated Key",detail:"Dedicated key for code development scenarios provided as a premium benefit in Kimi membership plan",value:"kimi"},{label:"$(check-all) Configure Both Keys",detail:"Configure Moonshot API key and Kimi For Coding dedicated key in sequence",value:"both"},{label:"$(globe) Configure Base URL (Proxy)",detail:"Override MoonshotAI endpoint (optional)",value:"baseUrl"}],{title:`${e} Key Configuration`,placeHolder:"Please select the item to configure"});if(!o){u.debug("User cancelled the MoonshotAI configuration wizard");return}(o.value==="moonshot"||o.value==="both")&&await n.setMoonshotApiKey(e,t),(o.value==="kimi"||o.value==="both")&&await n.setKimiApiKey(e),o.value==="baseUrl"&&await De.configureBaseUrl("moonshot",e)}catch(o){u.error(`MoonshotAI configuration wizard error: ${o instanceof Error?o.message:"Unknown error"}`)}}static async setMoonshotApiKey(e,t){let o=await xo.window.showInputBox({prompt:`Enter ${e} API Key (leave empty to clear)`,title:`Set ${e} API Key`,placeHolder:t,password:!0,validateInput:r=>(!r||r.trim()==="",null)});if(o!==void 0)try{o.trim()===""?(u.info(`${e} API Key cleared`),await R.deleteApiKey(n.PROVIDER_KEY),xo.window.showInformationMessage(`${e} API Key cleared`)):(await R.setApiKey(n.PROVIDER_KEY,o.trim()),u.info(`${e} API Key set`),xo.window.showInformationMessage(`${e} API Key set`))}catch(r){u.error(`Moonshot API Key operation failed: ${r instanceof Error?r.message:"Unknown error"}`),xo.window.showErrorMessage(`Setup failed: ${r instanceof Error?r.message:"Unknown error"}`)}}static async setKimiApiKey(e){let t=await xo.window.showInputBox({prompt:"Enter Kimi For Coding dedicated API Key (leave empty to clear)",title:"Set Kimi For Coding Dedicated API Key",placeHolder:"sk-kimi-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx",password:!0,validateInput:o=>(!o||o.trim()==="",null)});if(t!==void 0)try{t.trim()===""?(u.info("Kimi For Coding dedicated API Key cleared"),await R.deleteApiKey(n.KIMI_KEY),xo.window.showInformationMessage("Kimi For Coding dedicated API Key cleared")):(await R.setApiKey(n.KIMI_KEY,t.trim()),u.info("Kimi For Coding dedicated API Key set"),xo.window.showInformationMessage("Kimi For Coding dedicated API Key set"))}catch(o){u.error(`Kimi For Coding API Key operation failed: ${o instanceof Error?o.message:"Unknown error"}`),xo.window.showErrorMessage(`Setup failed: ${o instanceof Error?o.message:"Unknown error"}`)}}};var qe=D(require("vscode"));Ke();ot();ce();var vs=class n{static PROVIDER_KEY="zhipu";static async startWizard(e,t){try{let r=L.getZhipuSearchConfig().enableMCP?"Enabled":"Disabled",a=L.getZhipuEndpoint()==="api.z.ai"?"International (api.z.ai)":"Domestic (open.bigmodel.cn)",c=L.getZhipuPlan()==="coding"?"Coding Plan (/api/coding/paas/v4)":"Normal (/api/paas/v4)",l=await qe.window.showQuickPick([{label:`$(key) Configure ${e} API Key`,detail:`Set or delete ${e} API Key`,action:"updateApiKey"},{label:"$(plug) Enable MCP Search Mode",description:`Current: ${r}`,detail:"Use search quota in Coding Plan plan, Lite(100 trial)/Pro(1K searches)/Max(4K searches)",action:"toggleMCP"},{label:"$(globe) Set Endpoint",description:`Current: ${a}`,detail:"Set ZhipuAI endpoint: Domestic (open.bigmodel.cn) or International (api.z.ai)",action:"endpoint"},{label:"$(code) Set Plan Type",description:`Current: ${c}`,detail:"Coding Plan: /api/coding/paas/v4 (GLM Coding Plan), Normal: /api/paas/v4 (standard billing)",action:"plan"},{label:"$(lightbulb) Set Thinking Mode",description:`Current: ${L.getZhipuThinking()}`,detail:"Deep thinking mode: enabled, disabled, or auto (GLM-4.5+)",action:"thinking"},{label:"$(globe) Configure Base URL (Proxy)",detail:"Override ZhipuAI endpoint (optional)",action:"baseUrl"}],{title:`${e} Configuration Menu`,placeHolder:"Select action to perform"});if(!l){u.debug("User cancelled ZhipuAI configuration wizard");return}if(l.action==="updateApiKey")if(await R.hasValidApiKey(n.PROVIDER_KEY)){if(!await n.showSetApiKeyStep(e,t))return}else{if(u.debug("No API key detected, starting API key setup process"),!await n.showSetApiKeyStep(e,t)){u.debug("User cancelled API key setup");return}u.debug("API key setup successful, entering MCP search configuration"),await n.showMCPConfigStep(e)}else l.action==="toggleMCP"?await n.showMCPConfigStep(e):l.action==="endpoint"?await n.setEndpoint(e):l.action==="plan"?await n.setPlan(e):l.action==="thinking"?await n.setThinking(e):l.action==="baseUrl"&&await De.configureBaseUrl("zhipu",e)}catch(o){u.error(`ZhipuAI configuration wizard error: ${o instanceof Error?o.message:"Unknown error"}`)}}static async showSetApiKeyStep(e,t){let o=await qe.window.showInputBox({prompt:`Enter ${e} API Key (leave empty to clear)`,title:`Set ${e} API Key`,placeHolder:t,password:!0,validateInput:r=>(!r||r.trim()==="",null)});if(o===void 0)return!1;try{return o.trim()===""?(u.info(`${e} API Key cleared`),await R.deleteApiKey(n.PROVIDER_KEY)):(await R.setApiKey(n.PROVIDER_KEY,o.trim()),u.info(`${e} API Key set`)),!0}catch(r){return u.error(`API Key operation failed: ${r instanceof Error?r.message:"Unknown error"}`),!1}}static async showMCPConfigStep(e){let t=await qe.window.showQuickPick([{label:"$(x) Do not enable MCP Search Mode",detail:"Use Web Search API pay-as-you-go interface, use when plan quota is exhausted or advanced search features are needed",action:"disableMCP"},{label:"$(check) Enable MCP Search Mode",detail:"Use search quota in Coding Plan plan, Lite(100 trial)/Pro(1K searches)/Max(4K searches)",action:"enableMCP"}],{title:`${e} MCP Search Service Configuration Communication Mode Settings`,placeHolder:"Choose whether to enable MCP communication mode for search service"});if(t)try{t.action==="enableMCP"?await n.setMCPConfig(!0):await n.setMCPConfig(!1)}catch(o){u.error(`MCP configuration failed: ${o instanceof Error?o.message:"Unknown error"}`),qe.window.showErrorMessage(`MCP configuration failed: ${o instanceof Error?o.message:"Unknown error"}`)}}static async setMCPConfig(e){try{await qe.workspace.getConfiguration("chp").update("zhipu.search.enableMCP",e,qe.ConfigurationTarget.Global),u.info(`Zhipu MCP search service ${e?"enabled":"disabled"}`)}catch(t){let o=`Failed to set MCP configuration: ${t instanceof Error?t.message:"Unknown error"}`;throw u.error(o),t}}static async setEndpoint(e){let o=L.getZhipuEndpoint()==="api.z.ai"?"International (api.z.ai)":"Domestic (open.bigmodel.cn)",r=await qe.window.showQuickPick([{label:"$(home) Domestic (open.bigmodel.cn)",detail:"Recommended, faster domestic access",value:"open.bigmodel.cn"},{label:"$(globe) International (api.z.ai)",detail:"Use for overseas users or when domestic site access is restricted",value:"api.z.ai"}],{title:`${e} Endpoint Selection`,placeHolder:`Current: ${o}`});if(r)try{await qe.workspace.getConfiguration("chp.zhipu").update("endpoint",r.value,qe.ConfigurationTarget.Global),u.info(`ZhipuAI endpoint set to ${r.value}`),qe.window.showInformationMessage(`ZhipuAI endpoint set to ${r.value==="api.z.ai"?"International":"Domestic"}`)}catch(i){let a=`Failed to set endpoint: ${i instanceof Error?i.message:"Unknown error"}`;u.error(a),qe.window.showErrorMessage(a)}}static async setPlan(e){let o=L.getZhipuPlan()==="coding"?"Coding Plan":"Normal",r=await qe.window.showQuickPick([{label:"$(code) Coding Plan",detail:"Use /api/coding/paas/v4 endpoint - for GLM Coding Plan subscribers",value:"coding"},{label:"$(globe) Normal",detail:"Use /api/paas/v4 endpoint - for standard billing (pay-per-use)",value:"normal"}],{title:`${e} Plan Type Selection`,placeHolder:`Current: ${o}`});if(r)try{await qe.workspace.getConfiguration("chp.zhipu").update("plan",r.value,qe.ConfigurationTarget.Global),u.info(`ZhipuAI plan set to ${r.value}`),qe.window.showInformationMessage(`ZhipuAI plan set to ${r.value==="coding"?"Coding Plan":"Normal"}`)}catch(i){let a=`Failed to set plan: ${i instanceof Error?i.message:"Unknown error"}`;u.error(a),qe.window.showErrorMessage(a)}}static getMCPStatus(){return L.getZhipuSearchConfig().enableMCP}static async setThinking(e){let t=L.getZhipuThinking(),o=L.getZhipuClearThinking(),r=await qe.window.showQuickPick([{label:"$(lightbulb) Enabled",detail:"Always enable deep thinking (GLM-4.5+ models)",value:"enabled"},{label:"$(debug-disconnect) Disabled",detail:"Disable deep thinking for faster responses",value:"disabled"},{label:"$(question) Auto",detail:"Let the model decide when to use thinking",value:"auto"}],{title:`${e} Thinking Mode`,placeHolder:`Current: ${t}`});if(r)try{let i=qe.workspace.getConfiguration("chp.zhipu");await i.update("thinking",r.value,qe.ConfigurationTarget.Global);let a=await qe.window.showQuickPick([{label:"$(sparkle) Clear previous reasoning blocks",detail:"clear_thinking=true (recommended). Prior reasoning_content is removed from next-turn context.",value:!0},{label:"$(history) Preserve previous reasoning blocks",detail:"clear_thinking=false. Keep prior reasoning_content in context (requires full ordered history).",value:!1}],{title:`${e} Thinking Context Handling`,placeHolder:`Current: ${o?"Clear previous reasoning":"Preserve previous reasoning"}`});a&&await i.update("clearThinking",a.value,qe.ConfigurationTarget.Global),u.info(`ZhipuAI thinking set to ${r.value}, clearThinking: ${a?.value??o}`),qe.window.showInformationMessage(`ZhipuAI thinking mode: ${r.value}`)}catch(i){let a=`Failed to set thinking: ${i instanceof Error?i.message:"Unknown error"}`;u.error(a),qe.window.showErrorMessage(a)}}};Ke();cc();ot();var Ln=D(require("vscode"));ao();cc();ot();ac();ce();var ys=class n{static SCHEMA_URI="chp-settings://root/schema.json";static schemaProvider=null;static lastSchemaHash=null;static initialize(){n.schemaProvider&&n.schemaProvider.dispose(),n.schemaProvider=Ln.workspace.registerTextDocumentContentProvider("chp-settings",{provideTextDocumentContent:e=>{if(e.toString()===n.SCHEMA_URI){let t=n.getProviderOverridesSchema();return JSON.stringify(t,null,2)}return""}}),Ln.workspace.onDidOpenTextDocument(e=>{e.uri.scheme==="chp-settings"&&n.updateSchema()}),Ln.workspace.onDidChangeConfiguration(e=>{e.affectsConfiguration("chp")&&n.invalidateCache()}),u.info("Dynamic JSON Schema provider initialized")}static invalidateCache(){n.lastSchemaHash=null,n.updateSchema()}static updateSchema(){try{let e=n.getProviderOverridesSchema(),t=n.generateSchemaHash(e);if(n.lastSchemaHash===t)return;n.lastSchemaHash=t;let o=Ln.Uri.parse(n.SCHEMA_URI);Ln.workspace.textDocuments.forEach(r=>{if(r.uri.toString()===n.SCHEMA_URI){let i=JSON.stringify(e,null,2),a=new Ln.WorkspaceEdit;a.replace(o,new Ln.Range(0,0,r.lineCount,0),i),Ln.workspace.applyEdit(a),u.info("JSON Schema updated")}})}catch(e){u.error("Failed to update JSON Schema:",e)}}static generateSchemaHash(e){return JSON.stringify(e,Object.keys(e).sort())}static getProviderOverridesSchema(){let e=L.getConfigProvider(),t={},o={type:"string",description:"Provider configuration key name",enum:Object.keys(e),enumDescriptions:Object.entries(e).map(([a,s])=>s.displayName||a)};for(let[a,s]of Object.entries(e))t[`^${a}$`]=n.createProviderSchema(a,s);let{providerIds:r,enumDescriptions:i}=n.getAllAvailableProviders();return{$schema:"http://json-schema.org/draft-07/schema#",$id:n.SCHEMA_URI,title:"Copilot ++ Configuration Schema",description:"Schema for Copilot ++ configuration with dynamic model ID suggestions",type:"object",properties:{"chp.providerOverrides":{type:"object",description:"Provider configuration overrides. Allows overriding provider baseUrl and model configuration, supports adding new models or overriding existing model parameters.",patternProperties:t,propertyNames:o},"chp.fimCompletion.modelConfig":{type:"object",description:"FIM (Fill-in-the-Middle) completion mode configuration",properties:{provider:{type:"string",description:"Provider ID used for FIM completion",enum:r,enumDescriptions:i}},additionalProperties:!0},"chp.nesCompletion.modelConfig":{type:"object",description:"NES (Next Edit Suggestion) completion mode configuration",properties:{provider:{type:"string",description:"Provider ID used for NES completion",enum:r,enumDescriptions:i}},additionalProperties:!0},"chp.compatibleModels":{type:"array",description:"Custom model configuration for Compatible Provider.",default:[],items:{type:"object",properties:{id:{type:"string",description:"Model ID",minLength:1},name:{type:"string",description:"Model display name",minLength:1},tooltip:{type:"string",description:"Model description"},provider:{type:"string",description:"Model provider identifier. Select an existing provider ID from the dropdown list, or enter a new ID to create a custom provider.",anyOf:[{type:"string",enum:r,description:"Select existing provider ID"},{type:"string",minLength:3,maxLength:100,pattern:"^[a-zA-Z0-9_-]+$",description:"Add new custom provider ID (allows letters, numbers, underscores, hyphens)"}]},sdkMode:{type:"string",enum:["openai","openai-sse","anthropic"],enumDescriptions:["OpenAI SDK standard mode, uses official OpenAI SDK for request/response processing","OpenAI SSE compatibility mode, uses in-plugin SSE parsing logic for streaming response processing","Anthropic SDK standard mode, uses official Anthropic SDK for request/response processing"],description:"SDK mode defaults to openai.",default:"openai"},baseUrl:{type:"string",description:"API base URL",format:"uri"},model:{type:"string",description:"Model name used for API requests (optional, defaults to model ID)"},maxInputTokens:{type:"number",description:"Maximum input token count",minimum:128},maxOutputTokens:{type:"number",description:"Maximum output token count",minimum:8},outputThinking:{type:"boolean",description:"Whether to show thinking process in chat interface (recommended for thinking models like Claude Sonnet/Opus 4.5)",default:!0},includeThinking:{type:"boolean",description:`Whether to inject thinking content into context for multi-turn conversations (must be enabled for thinking models)
Defaults to true, recommended for thinking models to maintain context
Must be set to true when the model requires tool messages in multi-turn conversations to include thinking content`,default:!0},capabilities:{type:"object",properties:{toolCalling:{type:"boolean",description:"Whether tool calling is supported"},imageInput:{type:"boolean",description:"Whether image input is supported"}},required:["toolCalling","imageInput"]},customHeader:{type:"object",description:"Custom HTTP header configuration, supports ${APIKEY} placeholder replacement",additionalProperties:{type:"string",description:"HTTP header value"}},extraBody:{type:"object",description:"Extra request body parameters, will be merged into the request body in API requests",additionalProperties:{description:"Extra request body parameter value"}}},required:["id","name","maxInputTokens","maxOutputTokens","capabilities"]}}},additionalProperties:!0}}static createProviderSchema(e,t){let r={anyOf:[{type:"string",enum:t.models?.map(a=>a.id)||[],description:"Override existing model ID"},{type:"string",minLength:3,maxLength:100,pattern:"^[a-zA-Z0-9._-]+$",description:"Add new custom model ID (allows letters, numbers, underscores, hyphens, and dots)"}],description:"Select an existing model ID from the dropdown list, or enter a new ID to create a custom configuration"},i={type:"string",minLength:1,description:"Override model name or endpoint ID used for API requests"};return{type:"object",description:`${t.displayName||e} configuration overrides`,properties:{baseUrl:{type:"string",description:"Override provider-level API base URL",format:"uri"},customHeader:{type:"object",description:"Provider-level custom HTTP headers, supports ${APIKEY} placeholder replacement",additionalProperties:{type:"string",description:"HTTP header value"}},models:{type:"array",description:"Model override configuration list",minItems:1,items:{type:"object",properties:{id:r,model:i,name:{type:"string",minLength:1,description:`Friendly name displayed in model selector.\r
Valid for custom model IDs, will not override preset model names.`},tooltip:{type:"string",minLength:1,description:`Detailed description displayed as hover tooltip.\r
Valid for custom model IDs, will not override preset model descriptions.`},maxInputTokens:{type:"number",minimum:1,maximum:2e6,description:"Override maximum input token count"},maxOutputTokens:{type:"number",minimum:1,maximum:2e5,description:"Override maximum output token count"},sdkMode:{type:"string",enum:["openai","anthropic"],description:"Override SDK mode: openai (OpenAI compatible format) or anthropic (Anthropic compatible format)"},baseUrl:{type:"string",description:"Override model-level API base URL",format:"uri"},outputThinking:{type:"boolean",description:"Whether to show thinking process in chat interface (recommended for thinking models, default true)",default:!0},capabilities:{type:"object",description:"Model capabilities configuration",properties:{toolCalling:{type:"boolean",description:"Whether tool calling is supported"},imageInput:{type:"boolean",description:"Whether image input is supported"}},required:["toolCalling","imageInput"],additionalProperties:!1},customHeader:{type:"object",description:"Model custom HTTP headers, supports ${APIKEY} placeholder replacement",additionalProperties:{type:"string",description:"HTTP header value"}},extraBody:{type:"object",description:"Extra request body parameters (optional)",additionalProperties:{description:"Extra request body parameter value"}}},required:["id"],additionalProperties:!1}}},additionalProperties:!1}}static getAllAvailableProviders(){let e=[],t=[];try{for(let[i,a]of Object.entries(vt))e.push(i),t.push(a.displayName||i);for(let[i,a]of Object.entries(bn))e.includes(i)||(e.push(i),t.push(a.displayName||i));let o=wn.getModels(),r=new Set;for(let i of o)i.provider?.trim()&&!e.includes(i.provider)&&r.add(i.provider.trim());for(let i of Array.from(r).sort())e.push(i),t.push(`Custom Provider: ${i}`)}catch(o){u.error("Failed to get available provider list:",o)}return{providerIds:e,enumDescriptions:t}}static dispose(){n.schemaProvider&&(n.schemaProvider.dispose(),n.schemaProvider=null),u.trace("Dynamic JSON Schema provider cleaned up")}};ac();ce();var gh=Object.freeze({status:"aborted"});function S(n,e,t){function o(s,c){var l;Object.defineProperty(s,"_zod",{value:s._zod??{},enumerable:!1}),(l=s._zod).traits??(l.traits=new Set),s._zod.traits.add(n),e(s,c);for(let d in a.prototype)d in s||Object.defineProperty(s,d,{value:a.prototype[d].bind(s)});s._zod.constr=a,s._zod.def=c}let r=t?.Parent??Object;class i extends r{}Object.defineProperty(i,"name",{value:n});function a(s){var c;let l=t?.Parent?new i:this;o(l,s),(c=l._zod).deferred??(c.deferred=[]);for(let d of l._zod.deferred)d();return l}return Object.defineProperty(a,"init",{value:o}),Object.defineProperty(a,Symbol.hasInstance,{value:s=>t?.Parent&&s instanceof t.Parent?!0:s?._zod?.traits?.has(n)}),Object.defineProperty(a,"name",{value:n}),a}var oE=Symbol("zod_brand"),Vo=class extends Error{constructor(){super("Encountered Promise during synchronous parse. Use .parseAsync() instead.")}},zd={};function Mn(n){return n&&Object.assign(zd,n),zd}var _e={};io(_e,{BIGINT_FORMAT_RANGES:()=>bk,Class:()=>yh,NUMBER_FORMAT_RANGES:()=>Ih,aborted:()=>Si,allowsEval:()=>_h,assert:()=>cE,assertEqual:()=>rE,assertIs:()=>aE,assertNever:()=>sE,assertNotEqual:()=>iE,assignProp:()=>kh,cached:()=>al,captureStackTrace:()=>qd,cleanEnum:()=>wE,cleanRegex:()=>cl,clone:()=>Qn,createTransparentProxy:()=>fE,defineLazy:()=>Fe,esc:()=>Mi,escapeRegex:()=>Lr,extend:()=>vE,finalizeIssue:()=>Wn,floatSafeRemainder:()=>wh,getElementAtPath:()=>lE,getEnumValues:()=>xh,getLengthableOrigin:()=>ll,getParsedType:()=>mE,getSizableOrigin:()=>wk,isObject:()=>xs,isPlainObject:()=>bs,issue:()=>Ah,joinValues:()=>Dd,jsonStringifyReplacer:()=>bh,merge:()=>yE,normalizeParams:()=>X,nullish:()=>sl,numKeys:()=>pE,omit:()=>gE,optionalKeys:()=>Th,partial:()=>xE,pick:()=>hE,prefixIssues:()=>bo,primitiveTypes:()=>xk,promiseAllObject:()=>uE,propertyKeyTypes:()=>Ch,randomString:()=>dE,required:()=>bE,stringifyPrimitive:()=>Fd,unwrapMessage:()=>il});function rE(n){return n}function iE(n){return n}function aE(n){}function sE(n){throw new Error}function cE(n){}function xh(n){let e=Object.values(n).filter(o=>typeof o=="number");return Object.entries(n).filter(([o,r])=>e.indexOf(+o)===-1).map(([o,r])=>r)}function Dd(n,e="|"){return n.map(t=>Fd(t)).join(e)}function bh(n,e){return typeof e=="bigint"?e.toString():e}function al(n){return{get value(){{let t=n();return Object.defineProperty(this,"value",{value:t}),t}throw new Error("cached value already set")}}}function sl(n){return n==null}function cl(n){let e=n.startsWith("^")?1:0,t=n.endsWith("$")?n.length-1:n.length;return n.slice(e,t)}function wh(n,e){let t=(n.toString().split(".")[1]||"").length,o=(e.toString().split(".")[1]||"").length,r=t>o?t:o,i=Number.parseInt(n.toFixed(r).replace(".","")),a=Number.parseInt(e.toFixed(r).replace(".",""));return i%a/10**r}function Fe(n,e,t){Object.defineProperty(n,e,{get(){{let r=t();return n[e]=r,r}throw new Error("cached value already set")},set(r){Object.defineProperty(n,e,{value:r})},configurable:!0})}function kh(n,e,t){Object.defineProperty(n,e,{value:t,writable:!0,enumerable:!0,configurable:!0})}function lE(n,e){return e?e.reduce((t,o)=>t?.[o],n):n}function uE(n){let e=Object.keys(n),t=e.map(o=>n[o]);return Promise.all(t).then(o=>{let r={};for(let i=0;i<e.length;i++)r[e[i]]=o[i];return r})}function dE(n=10){let e="abcdefghijklmnopqrstuvwxyz",t="";for(let o=0;o<n;o++)t+=e[Math.floor(Math.random()*e.length)];return t}function Mi(n){return JSON.stringify(n)}var qd=Error.captureStackTrace?Error.captureStackTrace:(...n)=>{};function xs(n){return typeof n=="object"&&n!==null&&!Array.isArray(n)}var _h=al(()=>{if(typeof navigator<"u"&&navigator?.userAgent?.includes("Cloudflare"))return!1;try{let n=Function;return new n(""),!0}catch{return!1}});function bs(n){if(xs(n)===!1)return!1;let e=n.constructor;if(e===void 0)return!0;let t=e.prototype;return!(xs(t)===!1||Object.prototype.hasOwnProperty.call(t,"isPrototypeOf")===!1)}function pE(n){let e=0;for(let t in n)Object.prototype.hasOwnProperty.call(n,t)&&e++;return e}var mE=n=>{let e=typeof n;switch(e){case"undefined":return"undefined";case"string":return"string";case"number":return Number.isNaN(n)?"nan":"number";case"boolean":return"boolean";case"function":return"function";case"bigint":return"bigint";case"symbol":return"symbol";case"object":return Array.isArray(n)?"array":n===null?"null":n.then&&typeof n.then=="function"&&n.catch&&typeof n.catch=="function"?"promise":typeof Map<"u"&&n instanceof Map?"map":typeof Set<"u"&&n instanceof Set?"set":typeof Date<"u"&&n instanceof Date?"date":typeof File<"u"&&n instanceof File?"file":"object";default:throw new Error(`Unknown data type: ${e}`)}},Ch=new Set(["string","number","symbol"]),xk=new Set(["string","number","bigint","boolean","symbol","undefined"]);function Lr(n){return n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function Qn(n,e,t){let o=new n._zod.constr(e??n._zod.def);return(!e||t?.parent)&&(o._zod.parent=n),o}function X(n){let e=n;if(!e)return{};if(typeof e=="string")return{error:()=>e};if(e?.message!==void 0){if(e?.error!==void 0)throw new Error("Cannot specify both `message` and `error` params");e.error=e.message}return delete e.message,typeof e.error=="string"?{...e,error:()=>e.error}:e}function fE(n){let e;return new Proxy({},{get(t,o,r){return e??(e=n()),Reflect.get(e,o,r)},set(t,o,r,i){return e??(e=n()),Reflect.set(e,o,r,i)},has(t,o){return e??(e=n()),Reflect.has(e,o)},deleteProperty(t,o){return e??(e=n()),Reflect.deleteProperty(e,o)},ownKeys(t){return e??(e=n()),Reflect.ownKeys(e)},getOwnPropertyDescriptor(t,o){return e??(e=n()),Reflect.getOwnPropertyDescriptor(e,o)},defineProperty(t,o,r){return e??(e=n()),Reflect.defineProperty(e,o,r)}})}function Fd(n){return typeof n=="bigint"?n.toString()+"n":typeof n=="string"?`"${n}"`:`${n}`}function Th(n){return Object.keys(n).filter(e=>n[e]._zod.optin==="optional"&&n[e]._zod.optout==="optional")}var Ih={safeint:[Number.MIN_SAFE_INTEGER,Number.MAX_SAFE_INTEGER],int32:[-2147483648,2147483647],uint32:[0,4294967295],float32:[-34028234663852886e22,34028234663852886e22],float64:[-Number.MAX_VALUE,Number.MAX_VALUE]},bk={int64:[BigInt("-9223372036854775808"),BigInt("9223372036854775807")],uint64:[BigInt(0),BigInt("18446744073709551615")]};function hE(n,e){let t={},o=n._zod.def;for(let r in e){if(!(r in o.shape))throw new Error(`Unrecognized key: "${r}"`);e[r]&&(t[r]=o.shape[r])}return Qn(n,{...n._zod.def,shape:t,checks:[]})}function gE(n,e){let t={...n._zod.def.shape},o=n._zod.def;for(let r in e){if(!(r in o.shape))throw new Error(`Unrecognized key: "${r}"`);e[r]&&delete t[r]}return Qn(n,{...n._zod.def,shape:t,checks:[]})}function vE(n,e){if(!bs(e))throw new Error("Invalid input to extend: expected a plain object");let t={...n._zod.def,get shape(){let o={...n._zod.def.shape,...e};return kh(this,"shape",o),o},checks:[]};return Qn(n,t)}function yE(n,e){return Qn(n,{...n._zod.def,get shape(){let t={...n._zod.def.shape,...e._zod.def.shape};return kh(this,"shape",t),t},catchall:e._zod.def.catchall,checks:[]})}function xE(n,e,t){let o=e._zod.def.shape,r={...o};if(t)for(let i in t){if(!(i in o))throw new Error(`Unrecognized key: "${i}"`);t[i]&&(r[i]=n?new n({type:"optional",innerType:o[i]}):o[i])}else for(let i in o)r[i]=n?new n({type:"optional",innerType:o[i]}):o[i];return Qn(e,{...e._zod.def,shape:r,checks:[]})}function bE(n,e,t){let o=e._zod.def.shape,r={...o};if(t)for(let i in t){if(!(i in r))throw new Error(`Unrecognized key: "${i}"`);t[i]&&(r[i]=new n({type:"nonoptional",innerType:o[i]}))}else for(let i in o)r[i]=new n({type:"nonoptional",innerType:o[i]});return Qn(e,{...e._zod.def,shape:r,checks:[]})}function Si(n,e=0){for(let t=e;t<n.issues.length;t++)if(n.issues[t]?.continue!==!0)return!0;return!1}function bo(n,e){return e.map(t=>{var o;return(o=t).path??(o.path=[]),t.path.unshift(n),t})}function il(n){return typeof n=="string"?n:n?.message}function Wn(n,e,t){let o={...n,path:n.path??[]};if(!n.message){let r=il(n.inst?._zod.def?.error?.(n))??il(e?.error?.(n))??il(t.customError?.(n))??il(t.localeError?.(n))??"Invalid input";o.message=r}return delete o.inst,delete o.continue,e?.reportInput||delete o.input,o}function wk(n){return n instanceof Set?"set":n instanceof Map?"map":n instanceof File?"file":"unknown"}function ll(n){return Array.isArray(n)?"array":typeof n=="string"?"string":"unknown"}function Ah(...n){let[e,t,o]=n;return typeof e=="string"?{message:e,code:"custom",input:t,inst:o}:{...e}}function wE(n){return Object.entries(n).filter(([e,t])=>Number.isNaN(Number.parseInt(e,10))).map(e=>e[1])}var yh=class{constructor(...e){}};var kk=(n,e)=>{n.name="$ZodError",Object.defineProperty(n,"_zod",{value:n._zod,enumerable:!1}),Object.defineProperty(n,"issues",{value:e,enumerable:!1}),Object.defineProperty(n,"message",{get(){return JSON.stringify(e,bh,2)},enumerable:!0}),Object.defineProperty(n,"toString",{value:()=>n.message,enumerable:!1})},Bd=S("$ZodError",kk),Ph=S("$ZodError",kk,{Parent:Error});function Mh(n,e=t=>t.message){let t={},o=[];for(let r of n.issues)r.path.length>0?(t[r.path[0]]=t[r.path[0]]||[],t[r.path[0]].push(e(r))):o.push(e(r));return{formErrors:o,fieldErrors:t}}function Sh(n,e){let t=e||function(i){return i.message},o={_errors:[]},r=i=>{for(let a of i.issues)if(a.code==="invalid_union"&&a.errors.length)a.errors.map(s=>r({issues:s}));else if(a.code==="invalid_key")r({issues:a.issues});else if(a.code==="invalid_element")r({issues:a.issues});else if(a.path.length===0)o._errors.push(t(a));else{let s=o,c=0;for(;c<a.path.length;){let l=a.path[c];c===a.path.length-1?(s[l]=s[l]||{_errors:[]},s[l]._errors.push(t(a))):s[l]=s[l]||{_errors:[]},s=s[l],c++}}};return r(n),o}var _k=n=>(e,t,o,r)=>{let i=o?Object.assign(o,{async:!1}):{async:!1},a=e._zod.run({value:t,issues:[]},i);if(a instanceof Promise)throw new Vo;if(a.issues.length){let s=new(r?.Err??n)(a.issues.map(c=>Wn(c,i,Mn())));throw qd(s,r?.callee),s}return a.value};var Ck=n=>async(e,t,o,r)=>{let i=o?Object.assign(o,{async:!0}):{async:!0},a=e._zod.run({value:t,issues:[]},i);if(a instanceof Promise&&(a=await a),a.issues.length){let s=new(r?.Err??n)(a.issues.map(c=>Wn(c,i,Mn())));throw qd(s,r?.callee),s}return a.value};var $h=n=>(e,t,o)=>{let r=o?{...o,async:!1}:{async:!1},i=e._zod.run({value:t,issues:[]},r);if(i instanceof Promise)throw new Vo;return i.issues.length?{success:!1,error:new(n??Bd)(i.issues.map(a=>Wn(a,r,Mn())))}:{success:!0,data:i.value}},ul=$h(Ph),Eh=n=>async(e,t,o)=>{let r=o?Object.assign(o,{async:!0}):{async:!0},i=e._zod.run({value:t,issues:[]},r);return i instanceof Promise&&(i=await i),i.issues.length?{success:!1,error:new n(i.issues.map(a=>Wn(a,r,Mn())))}:{success:!0,data:i.value}},Ud=Eh(Ph);var Tk=/^[cC][^\s-]{8,}$/,Ik=/^[0-9a-z]+$/,Ak=/^[0-9A-HJKMNP-TV-Za-hjkmnp-tv-z]{26}$/,Pk=/^[0-9a-vA-V]{20}$/,Mk=/^[A-Za-z0-9]{27}$/,Sk=/^[a-zA-Z0-9_-]{21}$/,$k=/^P(?:(\d+W)|(?!.*W)(?=\d|T\d)(\d+Y)?(\d+M)?(\d+D)?(T(?=\d)(\d+H)?(\d+M)?(\d+([.,]\d+)?S)?)?)$/;var Ek=/^([0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12})$/,Rh=n=>n?new RegExp(`^([0-9a-fA-F]{8}-[0-9a-fA-F]{4}-${n}[0-9a-fA-F]{3}-[89abAB][0-9a-fA-F]{3}-[0-9a-fA-F]{12})$`):/^([0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[1-8][0-9a-fA-F]{3}-[89abAB][0-9a-fA-F]{3}-[0-9a-fA-F]{12}|00000000-0000-0000-0000-000000000000)$/;var Rk=/^(?!\.)(?!.*\.\.)([A-Za-z0-9_'+\-\.]*)[A-Za-z0-9_+-]@([A-Za-z0-9][A-Za-z0-9\-]*\.)+[A-Za-z]{2,}$/;var _E="^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$";function Ok(){return new RegExp(_E,"u")}var Lk=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,Nk=/^(([0-9a-fA-F]{1,4}:){7}[0-9a-fA-F]{1,4}|::|([0-9a-fA-F]{1,4})?::([0-9a-fA-F]{1,4}:?){0,6})$/,zk=/^((25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/([0-9]|[1-2][0-9]|3[0-2])$/,Dk=/^(([0-9a-fA-F]{1,4}:){7}[0-9a-fA-F]{1,4}|::|([0-9a-fA-F]{1,4})?::([0-9a-fA-F]{1,4}:?){0,6})\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,qk=/^$|^(?:[0-9a-zA-Z+/]{4})*(?:(?:[0-9a-zA-Z+/]{2}==)|(?:[0-9a-zA-Z+/]{3}=))?$/,Oh=/^[A-Za-z0-9_-]*$/,Fk=/^([a-zA-Z0-9-]+\.)*[a-zA-Z0-9-]+$/;var Bk=/^\+(?:[0-9]){6,14}[0-9]$/,Uk="(?:(?:\\d\\d[2468][048]|\\d\\d[13579][26]|\\d\\d0[48]|[02468][048]00|[13579][26]00)-02-29|\\d{4}-(?:(?:0[13578]|1[02])-(?:0[1-9]|[12]\\d|3[01])|(?:0[469]|11)-(?:0[1-9]|[12]\\d|30)|(?:02)-(?:0[1-9]|1\\d|2[0-8])))",jk=new RegExp(`^${Uk}$`);function Kk(n){let e="(?:[01]\\d|2[0-3]):[0-5]\\d";return typeof n.precision=="number"?n.precision===-1?`${e}`:n.precision===0?`${e}:[0-5]\\d`:`${e}:[0-5]\\d\\.\\d{${n.precision}}`:`${e}(?::[0-5]\\d(?:\\.\\d+)?)?`}function Hk(n){return new RegExp(`^${Kk(n)}$`)}function Zk(n){let e=Kk({precision:n.precision}),t=["Z"];n.local&&t.push(""),n.offset&&t.push("([+-]\\d{2}:\\d{2})");let o=`${e}(?:${t.join("|")})`;return new RegExp(`^${Uk}T(?:${o})$`)}var Gk=n=>{let e=n?`[\\s\\S]{${n?.minimum??0},${n?.maximum??""}}`:"[\\s\\S]*";return new RegExp(`^${e}$`)},Vk=/^\d+n?$/,Qk=/^\d+$/,Wk=/^-?\d+(?:\.\d+)?/i,Jk=/true|false/i,Xk=/null/i;var Yk=/^[^A-Z]*$/,e0=/^[^a-z]*$/;var Qt=S("$ZodCheck",(n,e)=>{var t;n._zod??(n._zod={}),n._zod.def=e,(t=n._zod).onattach??(t.onattach=[])}),t0={number:"number",bigint:"bigint",object:"date"},Lh=S("$ZodCheckLessThan",(n,e)=>{Qt.init(n,e);let t=t0[typeof e.value];n._zod.onattach.push(o=>{let r=o._zod.bag,i=(e.inclusive?r.maximum:r.exclusiveMaximum)??Number.POSITIVE_INFINITY;e.value<i&&(e.inclusive?r.maximum=e.value:r.exclusiveMaximum=e.value)}),n._zod.check=o=>{(e.inclusive?o.value<=e.value:o.value<e.value)||o.issues.push({origin:t,code:"too_big",maximum:e.value,input:o.value,inclusive:e.inclusive,inst:n,continue:!e.abort})}}),Nh=S("$ZodCheckGreaterThan",(n,e)=>{Qt.init(n,e);let t=t0[typeof e.value];n._zod.onattach.push(o=>{let r=o._zod.bag,i=(e.inclusive?r.minimum:r.exclusiveMinimum)??Number.NEGATIVE_INFINITY;e.value>i&&(e.inclusive?r.minimum=e.value:r.exclusiveMinimum=e.value)}),n._zod.check=o=>{(e.inclusive?o.value>=e.value:o.value>e.value)||o.issues.push({origin:t,code:"too_small",minimum:e.value,input:o.value,inclusive:e.inclusive,inst:n,continue:!e.abort})}}),n0=S("$ZodCheckMultipleOf",(n,e)=>{Qt.init(n,e),n._zod.onattach.push(t=>{var o;(o=t._zod.bag).multipleOf??(o.multipleOf=e.value)}),n._zod.check=t=>{if(typeof t.value!=typeof e.value)throw new Error("Cannot mix number and bigint in multiple_of check.");(typeof t.value=="bigint"?t.value%e.value===BigInt(0):wh(t.value,e.value)===0)||t.issues.push({origin:typeof t.value,code:"not_multiple_of",divisor:e.value,input:t.value,inst:n,continue:!e.abort})}}),o0=S("$ZodCheckNumberFormat",(n,e)=>{Qt.init(n,e),e.format=e.format||"float64";let t=e.format?.includes("int"),o=t?"int":"number",[r,i]=Ih[e.format];n._zod.onattach.push(a=>{let s=a._zod.bag;s.format=e.format,s.minimum=r,s.maximum=i,t&&(s.pattern=Qk)}),n._zod.check=a=>{let s=a.value;if(t){if(!Number.isInteger(s)){a.issues.push({expected:o,format:e.format,code:"invalid_type",input:s,inst:n});return}if(!Number.isSafeInteger(s)){s>0?a.issues.push({input:s,code:"too_big",maximum:Number.MAX_SAFE_INTEGER,note:"Integers must be within the safe integer range.",inst:n,origin:o,continue:!e.abort}):a.issues.push({input:s,code:"too_small",minimum:Number.MIN_SAFE_INTEGER,note:"Integers must be within the safe integer range.",inst:n,origin:o,continue:!e.abort});return}}s<r&&a.issues.push({origin:"number",input:s,code:"too_small",minimum:r,inclusive:!0,inst:n,continue:!e.abort}),s>i&&a.issues.push({origin:"number",input:s,code:"too_big",maximum:i,inst:n})}});var r0=S("$ZodCheckMaxLength",(n,e)=>{var t;Qt.init(n,e),(t=n._zod.def).when??(t.when=o=>{let r=o.value;return!sl(r)&&r.length!==void 0}),n._zod.onattach.push(o=>{let r=o._zod.bag.maximum??Number.POSITIVE_INFINITY;e.maximum<r&&(o._zod.bag.maximum=e.maximum)}),n._zod.check=o=>{let r=o.value;if(r.length<=e.maximum)return;let a=ll(r);o.issues.push({origin:a,code:"too_big",maximum:e.maximum,inclusive:!0,input:r,inst:n,continue:!e.abort})}}),i0=S("$ZodCheckMinLength",(n,e)=>{var t;Qt.init(n,e),(t=n._zod.def).when??(t.when=o=>{let r=o.value;return!sl(r)&&r.length!==void 0}),n._zod.onattach.push(o=>{let r=o._zod.bag.minimum??Number.NEGATIVE_INFINITY;e.minimum>r&&(o._zod.bag.minimum=e.minimum)}),n._zod.check=o=>{let r=o.value;if(r.length>=e.minimum)return;let a=ll(r);o.issues.push({origin:a,code:"too_small",minimum:e.minimum,inclusive:!0,input:r,inst:n,continue:!e.abort})}}),a0=S("$ZodCheckLengthEquals",(n,e)=>{var t;Qt.init(n,e),(t=n._zod.def).when??(t.when=o=>{let r=o.value;return!sl(r)&&r.length!==void 0}),n._zod.onattach.push(o=>{let r=o._zod.bag;r.minimum=e.length,r.maximum=e.length,r.length=e.length}),n._zod.check=o=>{let r=o.value,i=r.length;if(i===e.length)return;let a=ll(r),s=i>e.length;o.issues.push({origin:a,...s?{code:"too_big",maximum:e.length}:{code:"too_small",minimum:e.length},inclusive:!0,exact:!0,input:o.value,inst:n,continue:!e.abort})}}),dl=S("$ZodCheckStringFormat",(n,e)=>{var t,o;Qt.init(n,e),n._zod.onattach.push(r=>{let i=r._zod.bag;i.format=e.format,e.pattern&&(i.patterns??(i.patterns=new Set),i.patterns.add(e.pattern))}),e.pattern?(t=n._zod).check??(t.check=r=>{e.pattern.lastIndex=0,!e.pattern.test(r.value)&&r.issues.push({origin:"string",code:"invalid_format",format:e.format,input:r.value,...e.pattern?{pattern:e.pattern.toString()}:{},inst:n,continue:!e.abort})}):(o=n._zod).check??(o.check=()=>{})}),s0=S("$ZodCheckRegex",(n,e)=>{dl.init(n,e),n._zod.check=t=>{e.pattern.lastIndex=0,!e.pattern.test(t.value)&&t.issues.push({origin:"string",code:"invalid_format",format:"regex",input:t.value,pattern:e.pattern.toString(),inst:n,continue:!e.abort})}}),c0=S("$ZodCheckLowerCase",(n,e)=>{e.pattern??(e.pattern=Yk),dl.init(n,e)}),l0=S("$ZodCheckUpperCase",(n,e)=>{e.pattern??(e.pattern=e0),dl.init(n,e)}),u0=S("$ZodCheckIncludes",(n,e)=>{Qt.init(n,e);let t=Lr(e.includes),o=new RegExp(typeof e.position=="number"?`^.{${e.position}}${t}`:t);e.pattern=o,n._zod.onattach.push(r=>{let i=r._zod.bag;i.patterns??(i.patterns=new Set),i.patterns.add(o)}),n._zod.check=r=>{r.value.includes(e.includes,e.position)||r.issues.push({origin:"string",code:"invalid_format",format:"includes",includes:e.includes,input:r.value,inst:n,continue:!e.abort})}}),d0=S("$ZodCheckStartsWith",(n,e)=>{Qt.init(n,e);let t=new RegExp(`^${Lr(e.prefix)}.*`);e.pattern??(e.pattern=t),n._zod.onattach.push(o=>{let r=o._zod.bag;r.patterns??(r.patterns=new Set),r.patterns.add(t)}),n._zod.check=o=>{o.value.startsWith(e.prefix)||o.issues.push({origin:"string",code:"invalid_format",format:"starts_with",prefix:e.prefix,input:o.value,inst:n,continue:!e.abort})}}),p0=S("$ZodCheckEndsWith",(n,e)=>{Qt.init(n,e);let t=new RegExp(`.*${Lr(e.suffix)}$`);e.pattern??(e.pattern=t),n._zod.onattach.push(o=>{let r=o._zod.bag;r.patterns??(r.patterns=new Set),r.patterns.add(t)}),n._zod.check=o=>{o.value.endsWith(e.suffix)||o.issues.push({origin:"string",code:"invalid_format",format:"ends_with",suffix:e.suffix,input:o.value,inst:n,continue:!e.abort})}});var m0=S("$ZodCheckOverwrite",(n,e)=>{Qt.init(n,e),n._zod.check=t=>{t.value=e.tx(t.value)}});var Kd=class{constructor(e=[]){this.content=[],this.indent=0,this&&(this.args=e)}indented(e){this.indent+=1,e(this),this.indent-=1}write(e){if(typeof e=="function"){e(this,{execution:"sync"}),e(this,{execution:"async"});return}let o=e.split(`
`).filter(a=>a),r=Math.min(...o.map(a=>a.length-a.trimStart().length)),i=o.map(a=>a.slice(r)).map(a=>" ".repeat(this.indent*2)+a);for(let a of i)this.content.push(a)}compile(){let e=Function,t=this?.args,r=[...(this?.content??[""]).map(i=>`  ${i}`)];return new e(...t,r.join(`
`))}};var h0={major:4,minor:0,patch:0};var Me=S("$ZodType",(n,e)=>{var t;n??(n={}),n._zod.def=e,n._zod.bag=n._zod.bag||{},n._zod.version=h0;let o=[...n._zod.def.checks??[]];n._zod.traits.has("$ZodCheck")&&o.unshift(n);for(let r of o)for(let i of r._zod.onattach)i(n);if(o.length===0)(t=n._zod).deferred??(t.deferred=[]),n._zod.deferred?.push(()=>{n._zod.run=n._zod.parse});else{let r=(i,a,s)=>{let c=Si(i),l;for(let d of a){if(d._zod.def.when){if(!d._zod.def.when(i))continue}else if(c)continue;let p=i.issues.length,f=d._zod.check(i);if(f instanceof Promise&&s?.async===!1)throw new Vo;if(l||f instanceof Promise)l=(l??Promise.resolve()).then(async()=>{await f,i.issues.length!==p&&(c||(c=Si(i,p)))});else{if(i.issues.length===p)continue;c||(c=Si(i,p))}}return l?l.then(()=>i):i};n._zod.run=(i,a)=>{let s=n._zod.parse(i,a);if(s instanceof Promise){if(a.async===!1)throw new Vo;return s.then(c=>r(c,o,a))}return r(s,o,a)}}n["~standard"]={validate:r=>{try{let i=ul(n,r);return i.success?{value:i.data}:{issues:i.error?.issues}}catch{return Ud(n,r).then(a=>a.success?{value:a.data}:{issues:a.error?.issues})}},vendor:"zod",version:1}}),Zd=S("$ZodString",(n,e)=>{Me.init(n,e),n._zod.pattern=[...n?._zod.bag?.patterns??[]].pop()??Gk(n._zod.bag),n._zod.parse=(t,o)=>{if(e.coerce)try{t.value=String(t.value)}catch{}return typeof t.value=="string"||t.issues.push({expected:"string",code:"invalid_type",input:t.value,inst:n}),t}}),He=S("$ZodStringFormat",(n,e)=>{dl.init(n,e),Zd.init(n,e)}),T0=S("$ZodGUID",(n,e)=>{e.pattern??(e.pattern=Ek),He.init(n,e)}),I0=S("$ZodUUID",(n,e)=>{if(e.version){let o={v1:1,v2:2,v3:3,v4:4,v5:5,v6:6,v7:7,v8:8}[e.version];if(o===void 0)throw new Error(`Invalid UUID version: "${e.version}"`);e.pattern??(e.pattern=Rh(o))}else e.pattern??(e.pattern=Rh());He.init(n,e)}),A0=S("$ZodEmail",(n,e)=>{e.pattern??(e.pattern=Rk),He.init(n,e)}),P0=S("$ZodURL",(n,e)=>{He.init(n,e),n._zod.check=t=>{try{let o=t.value,r=new URL(o),i=r.href;e.hostname&&(e.hostname.lastIndex=0,e.hostname.test(r.hostname)||t.issues.push({code:"invalid_format",format:"url",note:"Invalid hostname",pattern:Fk.source,input:t.value,inst:n,continue:!e.abort})),e.protocol&&(e.protocol.lastIndex=0,e.protocol.test(r.protocol.endsWith(":")?r.protocol.slice(0,-1):r.protocol)||t.issues.push({code:"invalid_format",format:"url",note:"Invalid protocol",pattern:e.protocol.source,input:t.value,inst:n,continue:!e.abort})),!o.endsWith("/")&&i.endsWith("/")?t.value=i.slice(0,-1):t.value=i;return}catch{t.issues.push({code:"invalid_format",format:"url",input:t.value,inst:n,continue:!e.abort})}}}),M0=S("$ZodEmoji",(n,e)=>{e.pattern??(e.pattern=Ok()),He.init(n,e)}),S0=S("$ZodNanoID",(n,e)=>{e.pattern??(e.pattern=Sk),He.init(n,e)}),$0=S("$ZodCUID",(n,e)=>{e.pattern??(e.pattern=Tk),He.init(n,e)}),E0=S("$ZodCUID2",(n,e)=>{e.pattern??(e.pattern=Ik),He.init(n,e)}),R0=S("$ZodULID",(n,e)=>{e.pattern??(e.pattern=Ak),He.init(n,e)}),O0=S("$ZodXID",(n,e)=>{e.pattern??(e.pattern=Pk),He.init(n,e)}),L0=S("$ZodKSUID",(n,e)=>{e.pattern??(e.pattern=Mk),He.init(n,e)}),N0=S("$ZodISODateTime",(n,e)=>{e.pattern??(e.pattern=Zk(e)),He.init(n,e)}),z0=S("$ZodISODate",(n,e)=>{e.pattern??(e.pattern=jk),He.init(n,e)}),D0=S("$ZodISOTime",(n,e)=>{e.pattern??(e.pattern=Hk(e)),He.init(n,e)}),q0=S("$ZodISODuration",(n,e)=>{e.pattern??(e.pattern=$k),He.init(n,e)}),F0=S("$ZodIPv4",(n,e)=>{e.pattern??(e.pattern=Lk),He.init(n,e),n._zod.onattach.push(t=>{let o=t._zod.bag;o.format="ipv4"})}),B0=S("$ZodIPv6",(n,e)=>{e.pattern??(e.pattern=Nk),He.init(n,e),n._zod.onattach.push(t=>{let o=t._zod.bag;o.format="ipv6"}),n._zod.check=t=>{try{new URL(`http://[${t.value}]`)}catch{t.issues.push({code:"invalid_format",format:"ipv6",input:t.value,inst:n,continue:!e.abort})}}}),U0=S("$ZodCIDRv4",(n,e)=>{e.pattern??(e.pattern=zk),He.init(n,e)}),j0=S("$ZodCIDRv6",(n,e)=>{e.pattern??(e.pattern=Dk),He.init(n,e),n._zod.check=t=>{let[o,r]=t.value.split("/");try{if(!r)throw new Error;let i=Number(r);if(`${i}`!==r)throw new Error;if(i<0||i>128)throw new Error;new URL(`http://[${o}]`)}catch{t.issues.push({code:"invalid_format",format:"cidrv6",input:t.value,inst:n,continue:!e.abort})}}});function K0(n){if(n==="")return!0;if(n.length%4!==0)return!1;try{return atob(n),!0}catch{return!1}}var H0=S("$ZodBase64",(n,e)=>{e.pattern??(e.pattern=qk),He.init(n,e),n._zod.onattach.push(t=>{t._zod.bag.contentEncoding="base64"}),n._zod.check=t=>{K0(t.value)||t.issues.push({code:"invalid_format",format:"base64",input:t.value,inst:n,continue:!e.abort})}});function CE(n){if(!Oh.test(n))return!1;let e=n.replace(/[-_]/g,o=>o==="-"?"+":"/"),t=e.padEnd(Math.ceil(e.length/4)*4,"=");return K0(t)}var Z0=S("$ZodBase64URL",(n,e)=>{e.pattern??(e.pattern=Oh),He.init(n,e),n._zod.onattach.push(t=>{t._zod.bag.contentEncoding="base64url"}),n._zod.check=t=>{CE(t.value)||t.issues.push({code:"invalid_format",format:"base64url",input:t.value,inst:n,continue:!e.abort})}}),G0=S("$ZodE164",(n,e)=>{e.pattern??(e.pattern=Bk),He.init(n,e)});function TE(n,e=null){try{let t=n.split(".");if(t.length!==3)return!1;let[o]=t;if(!o)return!1;let r=JSON.parse(atob(o));return!("typ"in r&&r?.typ!=="JWT"||!r.alg||e&&(!("alg"in r)||r.alg!==e))}catch{return!1}}var V0=S("$ZodJWT",(n,e)=>{He.init(n,e),n._zod.check=t=>{TE(t.value,e.alg)||t.issues.push({code:"invalid_format",format:"jwt",input:t.value,inst:n,continue:!e.abort})}});var Dh=S("$ZodNumber",(n,e)=>{Me.init(n,e),n._zod.pattern=n._zod.bag.pattern??Wk,n._zod.parse=(t,o)=>{if(e.coerce)try{t.value=Number(t.value)}catch{}let r=t.value;if(typeof r=="number"&&!Number.isNaN(r)&&Number.isFinite(r))return t;let i=typeof r=="number"?Number.isNaN(r)?"NaN":Number.isFinite(r)?void 0:"Infinity":void 0;return t.issues.push({expected:"number",code:"invalid_type",input:r,inst:n,...i?{received:i}:{}}),t}}),Q0=S("$ZodNumber",(n,e)=>{o0.init(n,e),Dh.init(n,e)}),W0=S("$ZodBoolean",(n,e)=>{Me.init(n,e),n._zod.pattern=Jk,n._zod.parse=(t,o)=>{if(e.coerce)try{t.value=!!t.value}catch{}let r=t.value;return typeof r=="boolean"||t.issues.push({expected:"boolean",code:"invalid_type",input:r,inst:n}),t}}),J0=S("$ZodBigInt",(n,e)=>{Me.init(n,e),n._zod.pattern=Vk,n._zod.parse=(t,o)=>{if(e.coerce)try{t.value=BigInt(t.value)}catch{}return typeof t.value=="bigint"||t.issues.push({expected:"bigint",code:"invalid_type",input:t.value,inst:n}),t}});var X0=S("$ZodNull",(n,e)=>{Me.init(n,e),n._zod.pattern=Xk,n._zod.values=new Set([null]),n._zod.parse=(t,o)=>{let r=t.value;return r===null||t.issues.push({expected:"null",code:"invalid_type",input:r,inst:n}),t}}),Y0=S("$ZodAny",(n,e)=>{Me.init(n,e),n._zod.parse=t=>t}),e_=S("$ZodUnknown",(n,e)=>{Me.init(n,e),n._zod.parse=t=>t}),t_=S("$ZodNever",(n,e)=>{Me.init(n,e),n._zod.parse=(t,o)=>(t.issues.push({expected:"never",code:"invalid_type",input:t.value,inst:n}),t)});var n_=S("$ZodDate",(n,e)=>{Me.init(n,e),n._zod.parse=(t,o)=>{if(e.coerce)try{t.value=new Date(t.value)}catch{}let r=t.value,i=r instanceof Date;return i&&!Number.isNaN(r.getTime())||t.issues.push({expected:"date",code:"invalid_type",input:r,...i?{received:"Invalid Date"}:{},inst:n}),t}});function g0(n,e,t){n.issues.length&&e.issues.push(...bo(t,n.issues)),e.value[t]=n.value}var o_=S("$ZodArray",(n,e)=>{Me.init(n,e),n._zod.parse=(t,o)=>{let r=t.value;if(!Array.isArray(r))return t.issues.push({expected:"array",code:"invalid_type",input:r,inst:n}),t;t.value=Array(r.length);let i=[];for(let a=0;a<r.length;a++){let s=r[a],c=e.element._zod.run({value:s,issues:[]},o);c instanceof Promise?i.push(c.then(l=>g0(l,t,a))):g0(c,t,a)}return i.length?Promise.all(i).then(()=>t):t}});function Hd(n,e,t){n.issues.length&&e.issues.push(...bo(t,n.issues)),e.value[t]=n.value}function v0(n,e,t,o){n.issues.length?o[t]===void 0?t in o?e.value[t]=void 0:e.value[t]=n.value:e.issues.push(...bo(t,n.issues)):n.value===void 0?t in o&&(e.value[t]=void 0):e.value[t]=n.value}var r_=S("$ZodObject",(n,e)=>{Me.init(n,e);let t=al(()=>{let p=Object.keys(e.shape);for(let m of p)if(!(e.shape[m]instanceof Me))throw new Error(`Invalid element at key "${m}": expected a Zod schema`);let f=Th(e.shape);return{shape:e.shape,keys:p,keySet:new Set(p),numKeys:p.length,optionalKeys:new Set(f)}});Fe(n._zod,"propValues",()=>{let p=e.shape,f={};for(let m in p){let h=p[m]._zod;if(h.values){f[m]??(f[m]=new Set);for(let g of h.values)f[m].add(g)}}return f});let o=p=>{let f=new Kd(["shape","payload","ctx"]),m=t.value,h=x=>{let y=Mi(x);return`shape[${y}]._zod.run({ value: input[${y}], issues: [] }, ctx)`};f.write("const input = payload.value;");let g=Object.create(null),v=0;for(let x of m.keys)g[x]=`key_${v++}`;f.write("const newResult = {}");for(let x of m.keys)if(m.optionalKeys.has(x)){let y=g[x];f.write(`const ${y} = ${h(x)};`);let w=Mi(x);f.write(`
        if (${y}.issues.length) {
          if (input[${w}] === undefined) {
            if (${w} in input) {
              newResult[${w}] = undefined;
            }
          } else {
            payload.issues = payload.issues.concat(
              ${y}.issues.map((iss) => ({
                ...iss,
                path: iss.path ? [${w}, ...iss.path] : [${w}],
              }))
            );
          }
        } else if (${y}.value === undefined) {
          if (${w} in input) newResult[${w}] = undefined;
        } else {
          newResult[${w}] = ${y}.value;
        }
        `)}else{let y=g[x];f.write(`const ${y} = ${h(x)};`),f.write(`
          if (${y}.issues.length) payload.issues = payload.issues.concat(${y}.issues.map(iss => ({
            ...iss,
            path: iss.path ? [${Mi(x)}, ...iss.path] : [${Mi(x)}]
          })));`),f.write(`newResult[${Mi(x)}] = ${y}.value`)}f.write("payload.value = newResult;"),f.write("return payload;");let k=f.compile();return(x,y)=>k(p,x,y)},r,i=xs,a=!zd.jitless,c=a&&_h.value,l=e.catchall,d;n._zod.parse=(p,f)=>{d??(d=t.value);let m=p.value;if(!i(m))return p.issues.push({expected:"object",code:"invalid_type",input:m,inst:n}),p;let h=[];if(a&&c&&f?.async===!1&&f.jitless!==!0)r||(r=o(e.shape)),p=r(p,f);else{p.value={};let y=d.shape;for(let w of d.keys){let b=y[w],C=b._zod.run({value:m[w],issues:[]},f),I=b._zod.optin==="optional"&&b._zod.optout==="optional";C instanceof Promise?h.push(C.then($=>I?v0($,p,w,m):Hd($,p,w))):I?v0(C,p,w,m):Hd(C,p,w)}}if(!l)return h.length?Promise.all(h).then(()=>p):p;let g=[],v=d.keySet,k=l._zod,x=k.def.type;for(let y of Object.keys(m)){if(v.has(y))continue;if(x==="never"){g.push(y);continue}let w=k.run({value:m[y],issues:[]},f);w instanceof Promise?h.push(w.then(b=>Hd(b,p,y))):Hd(w,p,y)}return g.length&&p.issues.push({code:"unrecognized_keys",keys:g,input:m,inst:n}),h.length?Promise.all(h).then(()=>p):p}});function y0(n,e,t,o){for(let r of n)if(r.issues.length===0)return e.value=r.value,e;return e.issues.push({code:"invalid_union",input:e.value,inst:t,errors:n.map(r=>r.issues.map(i=>Wn(i,o,Mn())))}),e}var qh=S("$ZodUnion",(n,e)=>{Me.init(n,e),Fe(n._zod,"optin",()=>e.options.some(t=>t._zod.optin==="optional")?"optional":void 0),Fe(n._zod,"optout",()=>e.options.some(t=>t._zod.optout==="optional")?"optional":void 0),Fe(n._zod,"values",()=>{if(e.options.every(t=>t._zod.values))return new Set(e.options.flatMap(t=>Array.from(t._zod.values)))}),Fe(n._zod,"pattern",()=>{if(e.options.every(t=>t._zod.pattern)){let t=e.options.map(o=>o._zod.pattern);return new RegExp(`^(${t.map(o=>cl(o.source)).join("|")})$`)}}),n._zod.parse=(t,o)=>{let r=!1,i=[];for(let a of e.options){let s=a._zod.run({value:t.value,issues:[]},o);if(s instanceof Promise)i.push(s),r=!0;else{if(s.issues.length===0)return s;i.push(s)}}return r?Promise.all(i).then(a=>y0(a,t,n,o)):y0(i,t,n,o)}}),i_=S("$ZodDiscriminatedUnion",(n,e)=>{qh.init(n,e);let t=n._zod.parse;Fe(n._zod,"propValues",()=>{let r={};for(let i of e.options){let a=i._zod.propValues;if(!a||Object.keys(a).length===0)throw new Error(`Invalid discriminated union option at index "${e.options.indexOf(i)}"`);for(let[s,c]of Object.entries(a)){r[s]||(r[s]=new Set);for(let l of c)r[s].add(l)}}return r});let o=al(()=>{let r=e.options,i=new Map;for(let a of r){let s=a._zod.propValues[e.discriminator];if(!s||s.size===0)throw new Error(`Invalid discriminated union option at index "${e.options.indexOf(a)}"`);for(let c of s){if(i.has(c))throw new Error(`Duplicate discriminator value "${String(c)}"`);i.set(c,a)}}return i});n._zod.parse=(r,i)=>{let a=r.value;if(!xs(a))return r.issues.push({code:"invalid_type",expected:"object",input:a,inst:n}),r;let s=o.value.get(a?.[e.discriminator]);return s?s._zod.run(r,i):e.unionFallback?t(r,i):(r.issues.push({code:"invalid_union",errors:[],note:"No matching discriminator",input:a,path:[e.discriminator],inst:n}),r)}}),a_=S("$ZodIntersection",(n,e)=>{Me.init(n,e),n._zod.parse=(t,o)=>{let r=t.value,i=e.left._zod.run({value:r,issues:[]},o),a=e.right._zod.run({value:r,issues:[]},o);return i instanceof Promise||a instanceof Promise?Promise.all([i,a]).then(([c,l])=>x0(t,c,l)):x0(t,i,a)}});function zh(n,e){if(n===e)return{valid:!0,data:n};if(n instanceof Date&&e instanceof Date&&+n==+e)return{valid:!0,data:n};if(bs(n)&&bs(e)){let t=Object.keys(e),o=Object.keys(n).filter(i=>t.indexOf(i)!==-1),r={...n,...e};for(let i of o){let a=zh(n[i],e[i]);if(!a.valid)return{valid:!1,mergeErrorPath:[i,...a.mergeErrorPath]};r[i]=a.data}return{valid:!0,data:r}}if(Array.isArray(n)&&Array.isArray(e)){if(n.length!==e.length)return{valid:!1,mergeErrorPath:[]};let t=[];for(let o=0;o<n.length;o++){let r=n[o],i=e[o],a=zh(r,i);if(!a.valid)return{valid:!1,mergeErrorPath:[o,...a.mergeErrorPath]};t.push(a.data)}return{valid:!0,data:t}}return{valid:!1,mergeErrorPath:[]}}function x0(n,e,t){if(e.issues.length&&n.issues.push(...e.issues),t.issues.length&&n.issues.push(...t.issues),Si(n))return n;let o=zh(e.value,t.value);if(!o.valid)throw new Error(`Unmergable intersection. Error path: ${JSON.stringify(o.mergeErrorPath)}`);return n.value=o.data,n}var s_=S("$ZodRecord",(n,e)=>{Me.init(n,e),n._zod.parse=(t,o)=>{let r=t.value;if(!bs(r))return t.issues.push({expected:"record",code:"invalid_type",input:r,inst:n}),t;let i=[];if(e.keyType._zod.values){let a=e.keyType._zod.values;t.value={};for(let c of a)if(typeof c=="string"||typeof c=="number"||typeof c=="symbol"){let l=e.valueType._zod.run({value:r[c],issues:[]},o);l instanceof Promise?i.push(l.then(d=>{d.issues.length&&t.issues.push(...bo(c,d.issues)),t.value[c]=d.value})):(l.issues.length&&t.issues.push(...bo(c,l.issues)),t.value[c]=l.value)}let s;for(let c in r)a.has(c)||(s=s??[],s.push(c));s&&s.length>0&&t.issues.push({code:"unrecognized_keys",input:r,inst:n,keys:s})}else{t.value={};for(let a of Reflect.ownKeys(r)){if(a==="__proto__")continue;let s=e.keyType._zod.run({value:a,issues:[]},o);if(s instanceof Promise)throw new Error("Async schemas not supported in object keys currently");if(s.issues.length){t.issues.push({origin:"record",code:"invalid_key",issues:s.issues.map(l=>Wn(l,o,Mn())),input:a,path:[a],inst:n}),t.value[s.value]=s.value;continue}let c=e.valueType._zod.run({value:r[a],issues:[]},o);c instanceof Promise?i.push(c.then(l=>{l.issues.length&&t.issues.push(...bo(a,l.issues)),t.value[s.value]=l.value})):(c.issues.length&&t.issues.push(...bo(a,c.issues)),t.value[s.value]=c.value)}}return i.length?Promise.all(i).then(()=>t):t}});var c_=S("$ZodEnum",(n,e)=>{Me.init(n,e);let t=xh(e.entries);n._zod.values=new Set(t),n._zod.pattern=new RegExp(`^(${t.filter(o=>Ch.has(typeof o)).map(o=>typeof o=="string"?Lr(o):o.toString()).join("|")})$`),n._zod.parse=(o,r)=>{let i=o.value;return n._zod.values.has(i)||o.issues.push({code:"invalid_value",values:t,input:i,inst:n}),o}}),l_=S("$ZodLiteral",(n,e)=>{Me.init(n,e),n._zod.values=new Set(e.values),n._zod.pattern=new RegExp(`^(${e.values.map(t=>typeof t=="string"?Lr(t):t?t.toString():String(t)).join("|")})$`),n._zod.parse=(t,o)=>{let r=t.value;return n._zod.values.has(r)||t.issues.push({code:"invalid_value",values:e.values,input:r,inst:n}),t}});var u_=S("$ZodTransform",(n,e)=>{Me.init(n,e),n._zod.parse=(t,o)=>{let r=e.transform(t.value,t);if(o.async)return(r instanceof Promise?r:Promise.resolve(r)).then(a=>(t.value=a,t));if(r instanceof Promise)throw new Vo;return t.value=r,t}}),d_=S("$ZodOptional",(n,e)=>{Me.init(n,e),n._zod.optin="optional",n._zod.optout="optional",Fe(n._zod,"values",()=>e.innerType._zod.values?new Set([...e.innerType._zod.values,void 0]):void 0),Fe(n._zod,"pattern",()=>{let t=e.innerType._zod.pattern;return t?new RegExp(`^(${cl(t.source)})?$`):void 0}),n._zod.parse=(t,o)=>e.innerType._zod.optin==="optional"?e.innerType._zod.run(t,o):t.value===void 0?t:e.innerType._zod.run(t,o)}),p_=S("$ZodNullable",(n,e)=>{Me.init(n,e),Fe(n._zod,"optin",()=>e.innerType._zod.optin),Fe(n._zod,"optout",()=>e.innerType._zod.optout),Fe(n._zod,"pattern",()=>{let t=e.innerType._zod.pattern;return t?new RegExp(`^(${cl(t.source)}|null)$`):void 0}),Fe(n._zod,"values",()=>e.innerType._zod.values?new Set([...e.innerType._zod.values,null]):void 0),n._zod.parse=(t,o)=>t.value===null?t:e.innerType._zod.run(t,o)}),m_=S("$ZodDefault",(n,e)=>{Me.init(n,e),n._zod.optin="optional",Fe(n._zod,"values",()=>e.innerType._zod.values),n._zod.parse=(t,o)=>{if(t.value===void 0)return t.value=e.defaultValue,t;let r=e.innerType._zod.run(t,o);return r instanceof Promise?r.then(i=>b0(i,e)):b0(r,e)}});function b0(n,e){return n.value===void 0&&(n.value=e.defaultValue),n}var f_=S("$ZodPrefault",(n,e)=>{Me.init(n,e),n._zod.optin="optional",Fe(n._zod,"values",()=>e.innerType._zod.values),n._zod.parse=(t,o)=>(t.value===void 0&&(t.value=e.defaultValue),e.innerType._zod.run(t,o))}),h_=S("$ZodNonOptional",(n,e)=>{Me.init(n,e),Fe(n._zod,"values",()=>{let t=e.innerType._zod.values;return t?new Set([...t].filter(o=>o!==void 0)):void 0}),n._zod.parse=(t,o)=>{let r=e.innerType._zod.run(t,o);return r instanceof Promise?r.then(i=>w0(i,n)):w0(r,n)}});function w0(n,e){return!n.issues.length&&n.value===void 0&&n.issues.push({code:"invalid_type",expected:"nonoptional",input:n.value,inst:e}),n}var g_=S("$ZodCatch",(n,e)=>{Me.init(n,e),n._zod.optin="optional",Fe(n._zod,"optout",()=>e.innerType._zod.optout),Fe(n._zod,"values",()=>e.innerType._zod.values),n._zod.parse=(t,o)=>{let r=e.innerType._zod.run(t,o);return r instanceof Promise?r.then(i=>(t.value=i.value,i.issues.length&&(t.value=e.catchValue({...t,error:{issues:i.issues.map(a=>Wn(a,o,Mn()))},input:t.value}),t.issues=[]),t)):(t.value=r.value,r.issues.length&&(t.value=e.catchValue({...t,error:{issues:r.issues.map(i=>Wn(i,o,Mn()))},input:t.value}),t.issues=[]),t)}});var v_=S("$ZodPipe",(n,e)=>{Me.init(n,e),Fe(n._zod,"values",()=>e.in._zod.values),Fe(n._zod,"optin",()=>e.in._zod.optin),Fe(n._zod,"optout",()=>e.out._zod.optout),n._zod.parse=(t,o)=>{let r=e.in._zod.run(t,o);return r instanceof Promise?r.then(i=>k0(i,e,o)):k0(r,e,o)}});function k0(n,e,t){return Si(n)?n:e.out._zod.run({value:n.value,issues:n.issues},t)}var y_=S("$ZodReadonly",(n,e)=>{Me.init(n,e),Fe(n._zod,"propValues",()=>e.innerType._zod.propValues),Fe(n._zod,"values",()=>e.innerType._zod.values),Fe(n._zod,"optin",()=>e.innerType._zod.optin),Fe(n._zod,"optout",()=>e.innerType._zod.optout),n._zod.parse=(t,o)=>{let r=e.innerType._zod.run(t,o);return r instanceof Promise?r.then(_0):_0(r)}});function _0(n){return n.value=Object.freeze(n.value),n}var x_=S("$ZodCustom",(n,e)=>{Qt.init(n,e),Me.init(n,e),n._zod.parse=(t,o)=>t,n._zod.check=t=>{let o=t.value,r=e.fn(o);if(r instanceof Promise)return r.then(i=>C0(i,t,o,n));C0(r,t,o,n)}});function C0(n,e,t,o){if(!n){let r={code:"custom",input:t,inst:o,path:[...o._zod.def.path??[]],continue:!o._zod.def.abort};o._zod.def.params&&(r.params=o._zod.def.params),e.issues.push(Ah(r))}}var IE=n=>{let e=typeof n;switch(e){case"number":return Number.isNaN(n)?"NaN":"number";case"object":{if(Array.isArray(n))return"array";if(n===null)return"null";if(Object.getPrototypeOf(n)!==Object.prototype&&n.constructor)return n.constructor.name}}return e},AE=()=>{let n={string:{unit:"characters",verb:"to have"},file:{unit:"bytes",verb:"to have"},array:{unit:"items",verb:"to have"},set:{unit:"items",verb:"to have"}};function e(o){return n[o]??null}let t={regex:"input",email:"email address",url:"URL",emoji:"emoji",uuid:"UUID",uuidv4:"UUIDv4",uuidv6:"UUIDv6",nanoid:"nanoid",guid:"GUID",cuid:"cuid",cuid2:"cuid2",ulid:"ULID",xid:"XID",ksuid:"KSUID",datetime:"ISO datetime",date:"ISO date",time:"ISO time",duration:"ISO duration",ipv4:"IPv4 address",ipv6:"IPv6 address",cidrv4:"IPv4 range",cidrv6:"IPv6 range",base64:"base64-encoded string",base64url:"base64url-encoded string",json_string:"JSON string",e164:"E.164 number",jwt:"JWT",template_literal:"input"};return o=>{switch(o.code){case"invalid_type":return`Invalid input: expected ${o.expected}, received ${IE(o.input)}`;case"invalid_value":return o.values.length===1?`Invalid input: expected ${Fd(o.values[0])}`:`Invalid option: expected one of ${Dd(o.values,"|")}`;case"too_big":{let r=o.inclusive?"<=":"<",i=e(o.origin);return i?`Too big: expected ${o.origin??"value"} to have ${r}${o.maximum.toString()} ${i.unit??"elements"}`:`Too big: expected ${o.origin??"value"} to be ${r}${o.maximum.toString()}`}case"too_small":{let r=o.inclusive?">=":">",i=e(o.origin);return i?`Too small: expected ${o.origin} to have ${r}${o.minimum.toString()} ${i.unit}`:`Too small: expected ${o.origin} to be ${r}${o.minimum.toString()}`}case"invalid_format":{let r=o;return r.format==="starts_with"?`Invalid string: must start with "${r.prefix}"`:r.format==="ends_with"?`Invalid string: must end with "${r.suffix}"`:r.format==="includes"?`Invalid string: must include "${r.includes}"`:r.format==="regex"?`Invalid string: must match pattern ${r.pattern}`:`Invalid ${t[r.format]??o.format}`}case"not_multiple_of":return`Invalid number: must be a multiple of ${o.divisor}`;case"unrecognized_keys":return`Unrecognized key${o.keys.length>1?"s":""}: ${Dd(o.keys,", ")}`;case"invalid_key":return`Invalid key in ${o.origin}`;case"invalid_union":return"Invalid input";case"invalid_element":return`Invalid value in ${o.origin}`;default:return"Invalid input"}}};function b_(){return{localeError:AE()}}var PE=Symbol("ZodOutput"),ME=Symbol("ZodInput"),Fh=class{constructor(){this._map=new Map,this._idmap=new Map}add(e,...t){let o=t[0];if(this._map.set(e,o),o&&typeof o=="object"&&"id"in o){if(this._idmap.has(o.id))throw new Error(`ID ${o.id} already exists in the registry`);this._idmap.set(o.id,e)}return this}clear(){return this._map=new Map,this._idmap=new Map,this}remove(e){let t=this._map.get(e);return t&&typeof t=="object"&&"id"in t&&this._idmap.delete(t.id),this._map.delete(e),this}get(e){let t=e._zod.parent;if(t){let o={...this.get(t)??{}};return delete o.id,{...o,...this._map.get(e)}}return this._map.get(e)}has(e){return this._map.has(e)}};function w_(){return new Fh}var ws=w_();function k_(n,e){return new n({type:"string",...X(e)})}function __(n,e){return new n({type:"string",coerce:!0,...X(e)})}function C_(n,e){return new n({type:"string",format:"email",check:"string_format",abort:!1,...X(e)})}function Bh(n,e){return new n({type:"string",format:"guid",check:"string_format",abort:!1,...X(e)})}function T_(n,e){return new n({type:"string",format:"uuid",check:"string_format",abort:!1,...X(e)})}function I_(n,e){return new n({type:"string",format:"uuid",check:"string_format",abort:!1,version:"v4",...X(e)})}function A_(n,e){return new n({type:"string",format:"uuid",check:"string_format",abort:!1,version:"v6",...X(e)})}function P_(n,e){return new n({type:"string",format:"uuid",check:"string_format",abort:!1,version:"v7",...X(e)})}function Uh(n,e){return new n({type:"string",format:"url",check:"string_format",abort:!1,...X(e)})}function M_(n,e){return new n({type:"string",format:"emoji",check:"string_format",abort:!1,...X(e)})}function S_(n,e){return new n({type:"string",format:"nanoid",check:"string_format",abort:!1,...X(e)})}function $_(n,e){return new n({type:"string",format:"cuid",check:"string_format",abort:!1,...X(e)})}function E_(n,e){return new n({type:"string",format:"cuid2",check:"string_format",abort:!1,...X(e)})}function R_(n,e){return new n({type:"string",format:"ulid",check:"string_format",abort:!1,...X(e)})}function O_(n,e){return new n({type:"string",format:"xid",check:"string_format",abort:!1,...X(e)})}function L_(n,e){return new n({type:"string",format:"ksuid",check:"string_format",abort:!1,...X(e)})}function N_(n,e){return new n({type:"string",format:"ipv4",check:"string_format",abort:!1,...X(e)})}function z_(n,e){return new n({type:"string",format:"ipv6",check:"string_format",abort:!1,...X(e)})}function D_(n,e){return new n({type:"string",format:"cidrv4",check:"string_format",abort:!1,...X(e)})}function q_(n,e){return new n({type:"string",format:"cidrv6",check:"string_format",abort:!1,...X(e)})}function F_(n,e){return new n({type:"string",format:"base64",check:"string_format",abort:!1,...X(e)})}function B_(n,e){return new n({type:"string",format:"base64url",check:"string_format",abort:!1,...X(e)})}function U_(n,e){return new n({type:"string",format:"e164",check:"string_format",abort:!1,...X(e)})}function j_(n,e){return new n({type:"string",format:"jwt",check:"string_format",abort:!1,...X(e)})}function K_(n,e){return new n({type:"string",format:"datetime",check:"string_format",offset:!1,local:!1,precision:null,...X(e)})}function H_(n,e){return new n({type:"string",format:"date",check:"string_format",...X(e)})}function Z_(n,e){return new n({type:"string",format:"time",check:"string_format",precision:null,...X(e)})}function G_(n,e){return new n({type:"string",format:"duration",check:"string_format",...X(e)})}function V_(n,e){return new n({type:"number",checks:[],...X(e)})}function Q_(n,e){return new n({type:"number",coerce:!0,checks:[],...X(e)})}function W_(n,e){return new n({type:"number",check:"number_format",abort:!1,format:"safeint",...X(e)})}function J_(n,e){return new n({type:"boolean",...X(e)})}function X_(n,e){return new n({type:"boolean",coerce:!0,...X(e)})}function Y_(n,e){return new n({type:"bigint",coerce:!0,...X(e)})}function eC(n,e){return new n({type:"null",...X(e)})}function tC(n){return new n({type:"any"})}function nC(n){return new n({type:"unknown"})}function oC(n,e){return new n({type:"never",...X(e)})}function rC(n,e){return new n({type:"date",coerce:!0,...X(e)})}function ks(n,e){return new Lh({check:"less_than",...X(e),value:n,inclusive:!1})}function Qo(n,e){return new Lh({check:"less_than",...X(e),value:n,inclusive:!0})}function _s(n,e){return new Nh({check:"greater_than",...X(e),value:n,inclusive:!1})}function Jn(n,e){return new Nh({check:"greater_than",...X(e),value:n,inclusive:!0})}function pl(n,e){return new n0({check:"multiple_of",...X(e),value:n})}function Gd(n,e){return new r0({check:"max_length",...X(e),maximum:n})}function Cs(n,e){return new i0({check:"min_length",...X(e),minimum:n})}function Vd(n,e){return new a0({check:"length_equals",...X(e),length:n})}function jh(n,e){return new s0({check:"string_format",format:"regex",...X(e),pattern:n})}function Kh(n){return new c0({check:"string_format",format:"lowercase",...X(n)})}function Hh(n){return new l0({check:"string_format",format:"uppercase",...X(n)})}function Zh(n,e){return new u0({check:"string_format",format:"includes",...X(e),includes:n})}function Gh(n,e){return new d0({check:"string_format",format:"starts_with",...X(e),prefix:n})}function Vh(n,e){return new p0({check:"string_format",format:"ends_with",...X(e),suffix:n})}function $i(n){return new m0({check:"overwrite",tx:n})}function Qh(n){return $i(e=>e.normalize(n))}function Wh(){return $i(n=>n.trim())}function Jh(){return $i(n=>n.toLowerCase())}function Xh(){return $i(n=>n.toUpperCase())}function iC(n,e,t){return new n({type:"array",element:e,...X(t)})}function aC(n,e,t){let o=X(t);return o.abort??(o.abort=!0),new n({type:"custom",check:"custom",fn:e,...o})}function sC(n,e,t){return new n({type:"custom",check:"custom",fn:e,...X(t)})}function Is(n){return!!n._zod}function Xn(n,e){return Is(n)?ul(n,e):n.safeParse(e)}function Qd(n){if(!n)return;let e;if(Is(n)?e=n._zod?.def?.shape:e=n.shape,!!e){if(typeof e=="function")try{return e()}catch{return}return e}}function cC(n){if(Is(n)){let i=n._zod?.def;if(i){if(i.value!==void 0)return i.value;if(Array.isArray(i.values)&&i.values.length>0)return i.values[0]}}let t=n._def;if(t){if(t.value!==void 0)return t.value;if(Array.isArray(t.values)&&t.values.length>0)return t.values[0]}let o=n.value;if(o!==void 0)return o}var ml={};io(ml,{ZodISODate:()=>uC,ZodISODateTime:()=>lC,ZodISODuration:()=>pC,ZodISOTime:()=>dC,date:()=>eg,datetime:()=>Yh,duration:()=>ng,time:()=>tg});var lC=S("ZodISODateTime",(n,e)=>{N0.init(n,e),Je.init(n,e)});function Yh(n){return K_(lC,n)}var uC=S("ZodISODate",(n,e)=>{z0.init(n,e),Je.init(n,e)});function eg(n){return H_(uC,n)}var dC=S("ZodISOTime",(n,e)=>{D0.init(n,e),Je.init(n,e)});function tg(n){return Z_(dC,n)}var pC=S("ZodISODuration",(n,e)=>{q0.init(n,e),Je.init(n,e)});function ng(n){return G_(pC,n)}var fC=(n,e)=>{Bd.init(n,e),n.name="ZodError",Object.defineProperties(n,{format:{value:t=>Sh(n,t)},flatten:{value:t=>Mh(n,t)},addIssue:{value:t=>n.issues.push(t)},addIssues:{value:t=>n.issues.push(...t)},isEmpty:{get(){return n.issues.length===0}}})},J9=S("ZodError",fC),fl=S("ZodError",fC,{Parent:Error});var hC=_k(fl),gC=Ck(fl),vC=$h(fl),yC=Eh(fl);var Be=S("ZodType",(n,e)=>(Me.init(n,e),n.def=e,Object.defineProperty(n,"_def",{value:e}),n.check=(...t)=>n.clone({...e,checks:[...e.checks??[],...t.map(o=>typeof o=="function"?{_zod:{check:o,def:{check:"custom"},onattach:[]}}:o)]}),n.clone=(t,o)=>Qn(n,t,o),n.brand=()=>n,n.register=((t,o)=>(t.add(n,o),n)),n.parse=(t,o)=>hC(n,t,o,{callee:n.parse}),n.safeParse=(t,o)=>vC(n,t,o),n.parseAsync=async(t,o)=>gC(n,t,o,{callee:n.parseAsync}),n.safeParseAsync=async(t,o)=>yC(n,t,o),n.spa=n.safeParseAsync,n.refine=(t,o)=>n.check(_R(t,o)),n.superRefine=t=>n.check(CR(t)),n.overwrite=t=>n.check($i(t)),n.optional=()=>nt(n),n.nullable=()=>wC(n),n.nullish=()=>nt(wC(n)),n.nonoptional=t=>gR(n,t),n.array=()=>B(n),n.or=t=>Ue([n,t]),n.and=t=>Xd(n,t),n.transform=t=>rg(n,SC(t)),n.default=t=>mR(n,t),n.prefault=t=>hR(n,t),n.catch=t=>yR(n,t),n.pipe=t=>rg(n,t),n.readonly=()=>wR(n),n.describe=t=>{let o=n.clone();return ws.add(o,{description:t}),o},Object.defineProperty(n,"description",{get(){return ws.get(n)?.description},configurable:!0}),n.meta=(...t)=>{if(t.length===0)return ws.get(n);let o=n.clone();return ws.add(o,t[0]),o},n.isOptional=()=>n.safeParse(void 0).success,n.isNullable=()=>n.safeParse(null).success,n)),kC=S("_ZodString",(n,e)=>{Zd.init(n,e),Be.init(n,e);let t=n._zod.bag;n.format=t.format??null,n.minLength=t.minimum??null,n.maxLength=t.maximum??null,n.regex=(...o)=>n.check(jh(...o)),n.includes=(...o)=>n.check(Zh(...o)),n.startsWith=(...o)=>n.check(Gh(...o)),n.endsWith=(...o)=>n.check(Vh(...o)),n.min=(...o)=>n.check(Cs(...o)),n.max=(...o)=>n.check(Gd(...o)),n.length=(...o)=>n.check(Vd(...o)),n.nonempty=(...o)=>n.check(Cs(1,...o)),n.lowercase=o=>n.check(Kh(o)),n.uppercase=o=>n.check(Hh(o)),n.trim=()=>n.check(Wh()),n.normalize=(...o)=>n.check(Qh(...o)),n.toLowerCase=()=>n.check(Jh()),n.toUpperCase=()=>n.check(Xh())}),ig=S("ZodString",(n,e)=>{Zd.init(n,e),kC.init(n,e),n.email=t=>n.check(C_(zE,t)),n.url=t=>n.check(Uh(_C,t)),n.jwt=t=>n.check(j_(XE,t)),n.emoji=t=>n.check(M_(DE,t)),n.guid=t=>n.check(Bh(xC,t)),n.uuid=t=>n.check(T_(Wd,t)),n.uuidv4=t=>n.check(I_(Wd,t)),n.uuidv6=t=>n.check(A_(Wd,t)),n.uuidv7=t=>n.check(P_(Wd,t)),n.nanoid=t=>n.check(S_(qE,t)),n.guid=t=>n.check(Bh(xC,t)),n.cuid=t=>n.check($_(FE,t)),n.cuid2=t=>n.check(E_(BE,t)),n.ulid=t=>n.check(R_(UE,t)),n.base64=t=>n.check(F_(QE,t)),n.base64url=t=>n.check(B_(WE,t)),n.xid=t=>n.check(O_(jE,t)),n.ksuid=t=>n.check(L_(KE,t)),n.ipv4=t=>n.check(N_(HE,t)),n.ipv6=t=>n.check(z_(ZE,t)),n.cidrv4=t=>n.check(D_(GE,t)),n.cidrv6=t=>n.check(q_(VE,t)),n.e164=t=>n.check(U_(JE,t)),n.datetime=t=>n.check(Yh(t)),n.date=t=>n.check(eg(t)),n.time=t=>n.check(tg(t)),n.duration=t=>n.check(ng(t))});function _(n){return k_(ig,n)}var Je=S("ZodStringFormat",(n,e)=>{He.init(n,e),kC.init(n,e)}),zE=S("ZodEmail",(n,e)=>{A0.init(n,e),Je.init(n,e)});var xC=S("ZodGUID",(n,e)=>{T0.init(n,e),Je.init(n,e)});var Wd=S("ZodUUID",(n,e)=>{I0.init(n,e),Je.init(n,e)});var _C=S("ZodURL",(n,e)=>{P0.init(n,e),Je.init(n,e)});function CC(n){return Uh(_C,n)}var DE=S("ZodEmoji",(n,e)=>{M0.init(n,e),Je.init(n,e)});var qE=S("ZodNanoID",(n,e)=>{S0.init(n,e),Je.init(n,e)});var FE=S("ZodCUID",(n,e)=>{$0.init(n,e),Je.init(n,e)});var BE=S("ZodCUID2",(n,e)=>{E0.init(n,e),Je.init(n,e)});var UE=S("ZodULID",(n,e)=>{R0.init(n,e),Je.init(n,e)});var jE=S("ZodXID",(n,e)=>{O0.init(n,e),Je.init(n,e)});var KE=S("ZodKSUID",(n,e)=>{L0.init(n,e),Je.init(n,e)});var HE=S("ZodIPv4",(n,e)=>{F0.init(n,e),Je.init(n,e)});var ZE=S("ZodIPv6",(n,e)=>{B0.init(n,e),Je.init(n,e)});var GE=S("ZodCIDRv4",(n,e)=>{U0.init(n,e),Je.init(n,e)});var VE=S("ZodCIDRv6",(n,e)=>{j0.init(n,e),Je.init(n,e)});var QE=S("ZodBase64",(n,e)=>{H0.init(n,e),Je.init(n,e)});var WE=S("ZodBase64URL",(n,e)=>{Z0.init(n,e),Je.init(n,e)});var JE=S("ZodE164",(n,e)=>{G0.init(n,e),Je.init(n,e)});var XE=S("ZodJWT",(n,e)=>{V0.init(n,e),Je.init(n,e)});var Jd=S("ZodNumber",(n,e)=>{Dh.init(n,e),Be.init(n,e),n.gt=(o,r)=>n.check(_s(o,r)),n.gte=(o,r)=>n.check(Jn(o,r)),n.min=(o,r)=>n.check(Jn(o,r)),n.lt=(o,r)=>n.check(ks(o,r)),n.lte=(o,r)=>n.check(Qo(o,r)),n.max=(o,r)=>n.check(Qo(o,r)),n.int=o=>n.check(bC(o)),n.safe=o=>n.check(bC(o)),n.positive=o=>n.check(_s(0,o)),n.nonnegative=o=>n.check(Jn(0,o)),n.negative=o=>n.check(ks(0,o)),n.nonpositive=o=>n.check(Qo(0,o)),n.multipleOf=(o,r)=>n.check(pl(o,r)),n.step=(o,r)=>n.check(pl(o,r)),n.finite=()=>n;let t=n._zod.bag;n.minValue=Math.max(t.minimum??Number.NEGATIVE_INFINITY,t.exclusiveMinimum??Number.NEGATIVE_INFINITY)??null,n.maxValue=Math.min(t.maximum??Number.POSITIVE_INFINITY,t.exclusiveMaximum??Number.POSITIVE_INFINITY)??null,n.isInt=(t.format??"").includes("int")||Number.isSafeInteger(t.multipleOf??.5),n.isFinite=!0,n.format=t.format??null});function Ce(n){return V_(Jd,n)}var YE=S("ZodNumberFormat",(n,e)=>{Q0.init(n,e),Jd.init(n,e)});function bC(n){return W_(YE,n)}var ag=S("ZodBoolean",(n,e)=>{W0.init(n,e),Be.init(n,e)});function Oe(n){return J_(ag,n)}var TC=S("ZodBigInt",(n,e)=>{J0.init(n,e),Be.init(n,e),n.gte=(o,r)=>n.check(Jn(o,r)),n.min=(o,r)=>n.check(Jn(o,r)),n.gt=(o,r)=>n.check(_s(o,r)),n.gte=(o,r)=>n.check(Jn(o,r)),n.min=(o,r)=>n.check(Jn(o,r)),n.lt=(o,r)=>n.check(ks(o,r)),n.lte=(o,r)=>n.check(Qo(o,r)),n.max=(o,r)=>n.check(Qo(o,r)),n.positive=o=>n.check(_s(BigInt(0),o)),n.negative=o=>n.check(ks(BigInt(0),o)),n.nonpositive=o=>n.check(Qo(BigInt(0),o)),n.nonnegative=o=>n.check(Jn(BigInt(0),o)),n.multipleOf=(o,r)=>n.check(pl(o,r));let t=n._zod.bag;n.minValue=t.minimum??null,n.maxValue=t.maximum??null,n.format=t.format??null});var eR=S("ZodNull",(n,e)=>{X0.init(n,e),Be.init(n,e)});function sg(n){return eC(eR,n)}var tR=S("ZodAny",(n,e)=>{Y0.init(n,e),Be.init(n,e)});function IC(){return tC(tR)}var nR=S("ZodUnknown",(n,e)=>{e_.init(n,e),Be.init(n,e)});function Xe(){return nC(nR)}var oR=S("ZodNever",(n,e)=>{t_.init(n,e),Be.init(n,e)});function rR(n){return oC(oR,n)}var AC=S("ZodDate",(n,e)=>{n_.init(n,e),Be.init(n,e),n.min=(o,r)=>n.check(Jn(o,r)),n.max=(o,r)=>n.check(Qo(o,r));let t=n._zod.bag;n.minDate=t.minimum?new Date(t.minimum):null,n.maxDate=t.maximum?new Date(t.maximum):null});var iR=S("ZodArray",(n,e)=>{o_.init(n,e),Be.init(n,e),n.element=e.element,n.min=(t,o)=>n.check(Cs(t,o)),n.nonempty=t=>n.check(Cs(1,t)),n.max=(t,o)=>n.check(Gd(t,o)),n.length=(t,o)=>n.check(Vd(t,o)),n.unwrap=()=>n.element});function B(n,e){return iC(iR,n,e)}var PC=S("ZodObject",(n,e)=>{r_.init(n,e),Be.init(n,e),_e.defineLazy(n,"shape",()=>e.shape),n.keyof=()=>pn(Object.keys(n._zod.def.shape)),n.catchall=t=>n.clone({...n._zod.def,catchall:t}),n.passthrough=()=>n.clone({...n._zod.def,catchall:Xe()}),n.loose=()=>n.clone({...n._zod.def,catchall:Xe()}),n.strict=()=>n.clone({...n._zod.def,catchall:rR()}),n.strip=()=>n.clone({...n._zod.def,catchall:void 0}),n.extend=t=>_e.extend(n,t),n.merge=t=>_e.merge(n,t),n.pick=t=>_e.pick(n,t),n.omit=t=>_e.omit(n,t),n.partial=(...t)=>_e.partial($C,n,t[0]),n.required=(...t)=>_e.required(EC,n,t[0])});function j(n,e){let t={type:"object",get shape(){return _e.assignProp(this,"shape",{...n}),this.shape},..._e.normalizeParams(e)};return new PC(t)}function _t(n,e){return new PC({type:"object",get shape(){return _e.assignProp(this,"shape",{...n}),this.shape},catchall:Xe(),..._e.normalizeParams(e)})}var MC=S("ZodUnion",(n,e)=>{qh.init(n,e),Be.init(n,e),n.options=e.options});function Ue(n,e){return new MC({type:"union",options:n,..._e.normalizeParams(e)})}var aR=S("ZodDiscriminatedUnion",(n,e)=>{MC.init(n,e),i_.init(n,e)});function cg(n,e,t){return new aR({type:"union",options:e,discriminator:n,..._e.normalizeParams(t)})}var sR=S("ZodIntersection",(n,e)=>{a_.init(n,e),Be.init(n,e)});function Xd(n,e){return new sR({type:"intersection",left:n,right:e})}var cR=S("ZodRecord",(n,e)=>{s_.init(n,e),Be.init(n,e),n.keyType=e.keyType,n.valueType=e.valueType});function Ye(n,e,t){return new cR({type:"record",keyType:n,valueType:e,..._e.normalizeParams(t)})}var og=S("ZodEnum",(n,e)=>{c_.init(n,e),Be.init(n,e),n.enum=e.entries,n.options=Object.values(e.entries);let t=new Set(Object.keys(e.entries));n.extract=(o,r)=>{let i={};for(let a of o)if(t.has(a))i[a]=e.entries[a];else throw new Error(`Key ${a} not found in enum`);return new og({...e,checks:[],..._e.normalizeParams(r),entries:i})},n.exclude=(o,r)=>{let i={...e.entries};for(let a of o)if(t.has(a))delete i[a];else throw new Error(`Key ${a} not found in enum`);return new og({...e,checks:[],..._e.normalizeParams(r),entries:i})}});function pn(n,e){let t=Array.isArray(n)?Object.fromEntries(n.map(o=>[o,o])):n;return new og({type:"enum",entries:t,..._e.normalizeParams(e)})}var lR=S("ZodLiteral",(n,e)=>{l_.init(n,e),Be.init(n,e),n.values=new Set(e.values),Object.defineProperty(n,"value",{get(){if(e.values.length>1)throw new Error("This schema contains multiple valid literal values. Use `.values` instead.");return e.values[0]}})});function V(n,e){return new lR({type:"literal",values:Array.isArray(n)?n:[n],..._e.normalizeParams(e)})}var uR=S("ZodTransform",(n,e)=>{u_.init(n,e),Be.init(n,e),n._zod.parse=(t,o)=>{t.addIssue=i=>{if(typeof i=="string")t.issues.push(_e.issue(i,t.value,e));else{let a=i;a.fatal&&(a.continue=!1),a.code??(a.code="custom"),a.input??(a.input=t.value),a.inst??(a.inst=n),a.continue??(a.continue=!0),t.issues.push(_e.issue(a))}};let r=e.transform(t.value,t);return r instanceof Promise?r.then(i=>(t.value=i,t)):(t.value=r,t)}});function SC(n){return new uR({type:"transform",transform:n})}var $C=S("ZodOptional",(n,e)=>{d_.init(n,e),Be.init(n,e),n.unwrap=()=>n._zod.def.innerType});function nt(n){return new $C({type:"optional",innerType:n})}var dR=S("ZodNullable",(n,e)=>{p_.init(n,e),Be.init(n,e),n.unwrap=()=>n._zod.def.innerType});function wC(n){return new dR({type:"nullable",innerType:n})}var pR=S("ZodDefault",(n,e)=>{m_.init(n,e),Be.init(n,e),n.unwrap=()=>n._zod.def.innerType,n.removeDefault=n.unwrap});function mR(n,e){return new pR({type:"default",innerType:n,get defaultValue(){return typeof e=="function"?e():e}})}var fR=S("ZodPrefault",(n,e)=>{f_.init(n,e),Be.init(n,e),n.unwrap=()=>n._zod.def.innerType});function hR(n,e){return new fR({type:"prefault",innerType:n,get defaultValue(){return typeof e=="function"?e():e}})}var EC=S("ZodNonOptional",(n,e)=>{h_.init(n,e),Be.init(n,e),n.unwrap=()=>n._zod.def.innerType});function gR(n,e){return new EC({type:"nonoptional",innerType:n,..._e.normalizeParams(e)})}var vR=S("ZodCatch",(n,e)=>{g_.init(n,e),Be.init(n,e),n.unwrap=()=>n._zod.def.innerType,n.removeCatch=n.unwrap});function yR(n,e){return new vR({type:"catch",innerType:n,catchValue:typeof e=="function"?e:()=>e})}var xR=S("ZodPipe",(n,e)=>{v_.init(n,e),Be.init(n,e),n.in=e.in,n.out=e.out});function rg(n,e){return new xR({type:"pipe",in:n,out:e})}var bR=S("ZodReadonly",(n,e)=>{y_.init(n,e),Be.init(n,e)});function wR(n){return new bR({type:"readonly",innerType:n})}var RC=S("ZodCustom",(n,e)=>{x_.init(n,e),Be.init(n,e)});function kR(n){let e=new Qt({check:"custom"});return e._zod.check=n,e}function OC(n,e){return aC(RC,n??(()=>!0),e)}function _R(n,e={}){return sC(RC,n,e)}function CR(n){let e=kR(t=>(t.addIssue=o=>{if(typeof o=="string")t.issues.push(_e.issue(o,t.value,e._zod.def));else{let r=o;r.fatal&&(r.continue=!1),r.code??(r.code="custom"),r.input??(r.input=t.value),r.inst??(r.inst=e),r.continue??(r.continue=!e._zod.def.abort),t.issues.push(_e.issue(r))}},n(t.value,t)));return e}function lg(n,e){return rg(SC(n),e)}var LC={invalid_type:"invalid_type",too_big:"too_big",too_small:"too_small",invalid_format:"invalid_format",not_multiple_of:"not_multiple_of",unrecognized_keys:"unrecognized_keys",invalid_union:"invalid_union",invalid_key:"invalid_key",invalid_element:"invalid_element",invalid_value:"invalid_value",custom:"custom"};var Yd={};io(Yd,{bigint:()=>PR,boolean:()=>AR,date:()=>MR,number:()=>IR,string:()=>TR});function TR(n){return __(ig,n)}function IR(n){return Q_(Jd,n)}function AR(n){return X_(ag,n)}function PR(n){return Y_(TC,n)}function MR(n){return rC(AC,n)}Mn(b_());var Ps="2025-11-25";var NC=[Ps,"2025-06-18","2025-03-26","2024-11-05","2024-10-07"],Nr="io.modelcontextprotocol/related-task",tp="2.0",Dt=OC(n=>n!==null&&(typeof n=="object"||typeof n=="function")),zC=Ue([_(),Ce().int()]),DC=_(),H8=_t({ttl:Ue([Ce(),sg()]).optional(),pollInterval:Ce().optional()}),$R=j({ttl:Ce().optional()}),ER=j({taskId:_()}),dg=_t({progressToken:zC.optional(),[Nr]:ER.optional()}),Sn=j({_meta:dg.optional()}),hl=Sn.extend({task:$R.optional()}),qC=n=>hl.safeParse(n).success,qt=j({method:_(),params:Sn.loose().optional()}),Nn=j({_meta:dg.optional()}),zn=j({method:_(),params:Nn.loose().optional()}),Ft=_t({_meta:dg.optional()}),np=Ue([_(),Ce().int()]),FC=j({jsonrpc:V(tp),id:np,...qt.shape}).strict(),gl=n=>FC.safeParse(n).success,BC=j({jsonrpc:V(tp),...zn.shape}).strict(),UC=n=>BC.safeParse(n).success,pg=j({jsonrpc:V(tp),id:np,result:Ft}).strict(),Ei=n=>pg.safeParse(n).success;var te;(function(n){n[n.ConnectionClosed=-32e3]="ConnectionClosed",n[n.RequestTimeout=-32001]="RequestTimeout",n[n.ParseError=-32700]="ParseError",n[n.InvalidRequest=-32600]="InvalidRequest",n[n.MethodNotFound=-32601]="MethodNotFound",n[n.InvalidParams=-32602]="InvalidParams",n[n.InternalError=-32603]="InternalError",n[n.UrlElicitationRequired=-32042]="UrlElicitationRequired"})(te||(te={}));var mg=j({jsonrpc:V(tp),id:np.optional(),error:j({code:Ce().int(),message:_(),data:Xe().optional()})}).strict();var jC=n=>mg.safeParse(n).success;var op=Ue([FC,BC,pg,mg]),Z8=Ue([pg,mg]),Ri=Ft.strict(),RR=Nn.extend({requestId:np.optional(),reason:_().optional()}),rp=zn.extend({method:V("notifications/cancelled"),params:RR}),OR=j({src:_(),mimeType:_().optional(),sizes:B(_()).optional(),theme:pn(["light","dark"]).optional()}),vl=j({icons:B(OR).optional()}),As=j({name:_(),title:_().optional()}),KC=As.extend({...As.shape,...vl.shape,version:_(),websiteUrl:_().optional(),description:_().optional()}),LR=Xd(j({applyDefaults:Oe().optional()}),Ye(_(),Xe())),NR=lg(n=>n&&typeof n=="object"&&!Array.isArray(n)&&Object.keys(n).length===0?{form:{}}:n,Xd(j({form:LR.optional(),url:Dt.optional()}),Ye(_(),Xe()).optional())),zR=_t({list:Dt.optional(),cancel:Dt.optional(),requests:_t({sampling:_t({createMessage:Dt.optional()}).optional(),elicitation:_t({create:Dt.optional()}).optional()}).optional()}),DR=_t({list:Dt.optional(),cancel:Dt.optional(),requests:_t({tools:_t({call:Dt.optional()}).optional()}).optional()}),qR=j({experimental:Ye(_(),Dt).optional(),sampling:j({context:Dt.optional(),tools:Dt.optional()}).optional(),elicitation:NR.optional(),roots:j({listChanged:Oe().optional()}).optional(),tasks:zR.optional()}),FR=Sn.extend({protocolVersion:_(),capabilities:qR,clientInfo:KC}),BR=qt.extend({method:V("initialize"),params:FR});var UR=j({experimental:Ye(_(),Dt).optional(),logging:Dt.optional(),completions:Dt.optional(),prompts:j({listChanged:Oe().optional()}).optional(),resources:j({subscribe:Oe().optional(),listChanged:Oe().optional()}).optional(),tools:j({listChanged:Oe().optional()}).optional(),tasks:DR.optional()}),fg=Ft.extend({protocolVersion:_(),capabilities:UR,serverInfo:KC,instructions:_().optional()}),HC=zn.extend({method:V("notifications/initialized"),params:Nn.optional()}),ZC=n=>HC.safeParse(n).success,ip=qt.extend({method:V("ping"),params:Sn.optional()}),jR=j({progress:Ce(),total:nt(Ce()),message:nt(_())}),KR=j({...Nn.shape,...jR.shape,progressToken:zC}),ap=zn.extend({method:V("notifications/progress"),params:KR}),HR=Sn.extend({cursor:DC.optional()}),yl=qt.extend({params:HR.optional()}),xl=Ft.extend({nextCursor:DC.optional()}),ZR=pn(["working","input_required","completed","failed","cancelled"]),bl=j({taskId:_(),status:ZR,ttl:Ue([Ce(),sg()]),createdAt:_(),lastUpdatedAt:_(),pollInterval:nt(Ce()),statusMessage:nt(_())}),Oi=Ft.extend({task:bl}),GR=Nn.merge(bl),wl=zn.extend({method:V("notifications/tasks/status"),params:GR}),sp=qt.extend({method:V("tasks/get"),params:Sn.extend({taskId:_()})}),cp=Ft.merge(bl),lp=qt.extend({method:V("tasks/result"),params:Sn.extend({taskId:_()})}),G8=Ft.loose(),up=yl.extend({method:V("tasks/list")}),dp=xl.extend({tasks:B(bl)}),pp=qt.extend({method:V("tasks/cancel"),params:Sn.extend({taskId:_()})}),GC=Ft.merge(bl),VC=j({uri:_(),mimeType:nt(_()),_meta:Ye(_(),Xe()).optional()}),QC=VC.extend({text:_()}),hg=_().refine(n=>{try{return atob(n),!0}catch{return!1}},{message:"Invalid Base64 string"}),WC=VC.extend({blob:hg}),kl=pn(["user","assistant"]),Ms=j({audience:B(kl).optional(),priority:Ce().min(0).max(1).optional(),lastModified:ml.datetime({offset:!0}).optional()}),JC=j({...As.shape,...vl.shape,uri:_(),description:nt(_()),mimeType:nt(_()),annotations:Ms.optional(),_meta:nt(_t({}))}),VR=j({...As.shape,...vl.shape,uriTemplate:_(),description:nt(_()),mimeType:nt(_()),annotations:Ms.optional(),_meta:nt(_t({}))}),QR=yl.extend({method:V("resources/list")}),gg=xl.extend({resources:B(JC)}),WR=yl.extend({method:V("resources/templates/list")}),vg=xl.extend({resourceTemplates:B(VR)}),yg=Sn.extend({uri:_()}),JR=yg,XR=qt.extend({method:V("resources/read"),params:JR}),xg=Ft.extend({contents:B(Ue([QC,WC]))}),bg=zn.extend({method:V("notifications/resources/list_changed"),params:Nn.optional()}),YR=yg,eO=qt.extend({method:V("resources/subscribe"),params:YR}),tO=yg,nO=qt.extend({method:V("resources/unsubscribe"),params:tO}),oO=Nn.extend({uri:_()}),rO=zn.extend({method:V("notifications/resources/updated"),params:oO}),iO=j({name:_(),description:nt(_()),required:nt(Oe())}),aO=j({...As.shape,...vl.shape,description:nt(_()),arguments:nt(B(iO)),_meta:nt(_t({}))}),sO=yl.extend({method:V("prompts/list")}),wg=xl.extend({prompts:B(aO)}),cO=Sn.extend({name:_(),arguments:Ye(_(),_()).optional()}),lO=qt.extend({method:V("prompts/get"),params:cO}),kg=j({type:V("text"),text:_(),annotations:Ms.optional(),_meta:Ye(_(),Xe()).optional()}),_g=j({type:V("image"),data:hg,mimeType:_(),annotations:Ms.optional(),_meta:Ye(_(),Xe()).optional()}),Cg=j({type:V("audio"),data:hg,mimeType:_(),annotations:Ms.optional(),_meta:Ye(_(),Xe()).optional()}),uO=j({type:V("tool_use"),name:_(),id:_(),input:Ye(_(),Xe()),_meta:Ye(_(),Xe()).optional()}),dO=j({type:V("resource"),resource:Ue([QC,WC]),annotations:Ms.optional(),_meta:Ye(_(),Xe()).optional()}),pO=JC.extend({type:V("resource_link")}),Tg=Ue([kg,_g,Cg,pO,dO]),mO=j({role:kl,content:Tg}),Ig=Ft.extend({description:_().optional(),messages:B(mO)}),Ag=zn.extend({method:V("notifications/prompts/list_changed"),params:Nn.optional()}),fO=j({title:_().optional(),readOnlyHint:Oe().optional(),destructiveHint:Oe().optional(),idempotentHint:Oe().optional(),openWorldHint:Oe().optional()}),hO=j({taskSupport:pn(["required","optional","forbidden"]).optional()}),XC=j({...As.shape,...vl.shape,description:_().optional(),inputSchema:j({type:V("object"),properties:Ye(_(),Dt).optional(),required:B(_()).optional()}).catchall(Xe()),outputSchema:j({type:V("object"),properties:Ye(_(),Dt).optional(),required:B(_()).optional()}).catchall(Xe()).optional(),annotations:fO.optional(),execution:hO.optional(),_meta:Ye(_(),Xe()).optional()}),gO=yl.extend({method:V("tools/list")}),Pg=xl.extend({tools:B(XC)}),Ss=Ft.extend({content:B(Tg).default([]),structuredContent:Ye(_(),Xe()).optional(),isError:Oe().optional()}),V8=Ss.or(Ft.extend({toolResult:Xe()})),vO=hl.extend({name:_(),arguments:Ye(_(),Xe()).optional()}),yO=qt.extend({method:V("tools/call"),params:vO}),Mg=zn.extend({method:V("notifications/tools/list_changed"),params:Nn.optional()}),YC=j({autoRefresh:Oe().default(!0),debounceMs:Ce().int().nonnegative().default(300)}),eT=pn(["debug","info","notice","warning","error","critical","alert","emergency"]),xO=Sn.extend({level:eT}),bO=qt.extend({method:V("logging/setLevel"),params:xO}),wO=Nn.extend({level:eT,logger:_().optional(),data:Xe()}),kO=zn.extend({method:V("notifications/message"),params:wO}),_O=j({name:_().optional()}),CO=j({hints:B(_O).optional(),costPriority:Ce().min(0).max(1).optional(),speedPriority:Ce().min(0).max(1).optional(),intelligencePriority:Ce().min(0).max(1).optional()}),TO=j({mode:pn(["auto","required","none"]).optional()}),IO=j({type:V("tool_result"),toolUseId:_().describe("The unique identifier for the corresponding tool call."),content:B(Tg).default([]),structuredContent:j({}).loose().optional(),isError:Oe().optional(),_meta:Ye(_(),Xe()).optional()}),AO=cg("type",[kg,_g,Cg]),ep=cg("type",[kg,_g,Cg,uO,IO]),PO=j({role:kl,content:Ue([ep,B(ep)]),_meta:Ye(_(),Xe()).optional()}),MO=hl.extend({messages:B(PO),modelPreferences:CO.optional(),systemPrompt:_().optional(),includeContext:pn(["none","thisServer","allServers"]).optional(),temperature:Ce().optional(),maxTokens:Ce().int(),stopSequences:B(_()).optional(),metadata:Dt.optional(),tools:B(XC).optional(),toolChoice:TO.optional()}),Sg=qt.extend({method:V("sampling/createMessage"),params:MO}),$g=Ft.extend({model:_(),stopReason:nt(pn(["endTurn","stopSequence","maxTokens"]).or(_())),role:kl,content:AO}),SO=Ft.extend({model:_(),stopReason:nt(pn(["endTurn","stopSequence","maxTokens","toolUse"]).or(_())),role:kl,content:Ue([ep,B(ep)])}),$O=j({type:V("boolean"),title:_().optional(),description:_().optional(),default:Oe().optional()}),EO=j({type:V("string"),title:_().optional(),description:_().optional(),minLength:Ce().optional(),maxLength:Ce().optional(),format:pn(["email","uri","date","date-time"]).optional(),default:_().optional()}),RO=j({type:pn(["number","integer"]),title:_().optional(),description:_().optional(),minimum:Ce().optional(),maximum:Ce().optional(),default:Ce().optional()}),OO=j({type:V("string"),title:_().optional(),description:_().optional(),enum:B(_()),default:_().optional()}),LO=j({type:V("string"),title:_().optional(),description:_().optional(),oneOf:B(j({const:_(),title:_()})),default:_().optional()}),NO=j({type:V("string"),title:_().optional(),description:_().optional(),enum:B(_()),enumNames:B(_()).optional(),default:_().optional()}),zO=Ue([OO,LO]),DO=j({type:V("array"),title:_().optional(),description:_().optional(),minItems:Ce().optional(),maxItems:Ce().optional(),items:j({type:V("string"),enum:B(_())}),default:B(_()).optional()}),qO=j({type:V("array"),title:_().optional(),description:_().optional(),minItems:Ce().optional(),maxItems:Ce().optional(),items:j({anyOf:B(j({const:_(),title:_()}))}),default:B(_()).optional()}),FO=Ue([DO,qO]),BO=Ue([NO,zO,FO]),UO=Ue([BO,$O,EO,RO]),jO=hl.extend({mode:V("form").optional(),message:_(),requestedSchema:j({type:V("object"),properties:Ye(_(),UO),required:B(_()).optional()})}),KO=hl.extend({mode:V("url"),message:_(),elicitationId:_(),url:_().url()}),HO=Ue([jO,KO]),Eg=qt.extend({method:V("elicitation/create"),params:HO}),ZO=Nn.extend({elicitationId:_()}),GO=zn.extend({method:V("notifications/elicitation/complete"),params:ZO}),Rg=Ft.extend({action:pn(["accept","decline","cancel"]),content:lg(n=>n===null?void 0:n,Ye(_(),Ue([_(),Ce(),Oe(),B(_())])).optional())}),VO=j({type:V("ref/resource"),uri:_()});var QO=j({type:V("ref/prompt"),name:_()}),WO=Sn.extend({ref:Ue([QO,VO]),argument:j({name:_(),value:_()}),context:j({arguments:Ye(_(),_()).optional()}).optional()}),JO=qt.extend({method:V("completion/complete"),params:WO});var Og=Ft.extend({completion:_t({values:B(_()).max(100),total:nt(Ce().int()),hasMore:nt(Oe())})}),XO=j({uri:_().startsWith("file://"),name:_().optional(),_meta:Ye(_(),Xe()).optional()}),YO=qt.extend({method:V("roots/list"),params:Sn.optional()}),e1=Ft.extend({roots:B(XO)}),t1=zn.extend({method:V("notifications/roots/list_changed"),params:Nn.optional()}),Q8=Ue([ip,BR,JO,bO,lO,sO,QR,WR,XR,eO,nO,yO,gO,sp,lp,up,pp]),W8=Ue([rp,ap,HC,t1,wl]),J8=Ue([Ri,$g,SO,Rg,e1,cp,dp,Oi]),X8=Ue([ip,Sg,Eg,YO,sp,lp,up,pp]),Y8=Ue([rp,ap,kO,rO,bg,Mg,Ag,wl,GO]),eW=Ue([Ri,fg,Og,Ig,wg,gg,vg,xg,Ss,Pg,cp,dp,Oi]),ee=class n extends Error{constructor(e,t,o){super(`MCP error ${e}: ${t}`),this.code=e,this.data=o,this.name="McpError"}static fromError(e,t,o){if(e===te.UrlElicitationRequired&&o){let r=o;if(r.elicitations)return new ug(r.elicitations,t)}return new n(e,t,o)}},ug=class extends ee{constructor(e,t=`URL elicitation${e.length>1?"s":""} required`){super(te.UrlElicitationRequired,t,{elicitations:e})}get elicitations(){return this.data?.elicitations??[]}};function zr(n){return n==="completed"||n==="failed"||n==="cancelled"}var n1=Symbol("Let zodToJsonSchema decide on which parser to use");var RW=new Set("ABCDEFGHIJKLMNOPQRSTUVXYZabcdefghijklmnopqrstuvxyz0123456789");function Lg(n){let t=Qd(n)?.method;if(!t)throw new Error("Schema is missing a method literal");let o=cC(t);if(typeof o!="string")throw new Error("Schema method literal must be a string");return o}function Ng(n,e){let t=Xn(n,e);if(!t.success)throw t.error;return t.data}var c1=6e4,mp=class{constructor(e){this._options=e,this._requestMessageId=0,this._requestHandlers=new Map,this._requestHandlerAbortControllers=new Map,this._notificationHandlers=new Map,this._responseHandlers=new Map,this._progressHandlers=new Map,this._timeoutInfo=new Map,this._pendingDebouncedNotifications=new Set,this._taskProgressTokens=new Map,this._requestResolvers=new Map,this.setNotificationHandler(rp,t=>{this._oncancel(t)}),this.setNotificationHandler(ap,t=>{this._onprogress(t)}),this.setRequestHandler(ip,t=>({})),this._taskStore=e?.taskStore,this._taskMessageQueue=e?.taskMessageQueue,this._taskStore&&(this.setRequestHandler(sp,async(t,o)=>{let r=await this._taskStore.getTask(t.params.taskId,o.sessionId);if(!r)throw new ee(te.InvalidParams,"Failed to retrieve task: Task not found");return{...r}}),this.setRequestHandler(lp,async(t,o)=>{let r=async()=>{let i=t.params.taskId;if(this._taskMessageQueue){let s;for(;s=await this._taskMessageQueue.dequeue(i,o.sessionId);){if(s.type==="response"||s.type==="error"){let c=s.message,l=c.id,d=this._requestResolvers.get(l);if(d)if(this._requestResolvers.delete(l),s.type==="response")d(c);else{let p=c,f=new ee(p.error.code,p.error.message,p.error.data);d(f)}else{let p=s.type==="response"?"Response":"Error";this._onerror(new Error(`${p} handler missing for request ${l}`))}continue}await this._transport?.send(s.message,{relatedRequestId:o.requestId})}}let a=await this._taskStore.getTask(i,o.sessionId);if(!a)throw new ee(te.InvalidParams,`Task not found: ${i}`);if(!zr(a.status))return await this._waitForTaskUpdate(i,o.signal),await r();if(zr(a.status)){let s=await this._taskStore.getTaskResult(i,o.sessionId);return this._clearTaskQueue(i),{...s,_meta:{...s._meta,[Nr]:{taskId:i}}}}return await r()};return await r()}),this.setRequestHandler(up,async(t,o)=>{try{let{tasks:r,nextCursor:i}=await this._taskStore.listTasks(t.params?.cursor,o.sessionId);return{tasks:r,nextCursor:i,_meta:{}}}catch(r){throw new ee(te.InvalidParams,`Failed to list tasks: ${r instanceof Error?r.message:String(r)}`)}}),this.setRequestHandler(pp,async(t,o)=>{try{let r=await this._taskStore.getTask(t.params.taskId,o.sessionId);if(!r)throw new ee(te.InvalidParams,`Task not found: ${t.params.taskId}`);if(zr(r.status))throw new ee(te.InvalidParams,`Cannot cancel task in terminal status: ${r.status}`);await this._taskStore.updateTaskStatus(t.params.taskId,"cancelled","Client cancelled task execution.",o.sessionId),this._clearTaskQueue(t.params.taskId);let i=await this._taskStore.getTask(t.params.taskId,o.sessionId);if(!i)throw new ee(te.InvalidParams,`Task not found after cancellation: ${t.params.taskId}`);return{_meta:{},...i}}catch(r){throw r instanceof ee?r:new ee(te.InvalidRequest,`Failed to cancel task: ${r instanceof Error?r.message:String(r)}`)}}))}async _oncancel(e){if(!e.params.requestId)return;this._requestHandlerAbortControllers.get(e.params.requestId)?.abort(e.params.reason)}_setupTimeout(e,t,o,r,i=!1){this._timeoutInfo.set(e,{timeoutId:setTimeout(r,t),startTime:Date.now(),timeout:t,maxTotalTimeout:o,resetTimeoutOnProgress:i,onTimeout:r})}_resetTimeout(e){let t=this._timeoutInfo.get(e);if(!t)return!1;let o=Date.now()-t.startTime;if(t.maxTotalTimeout&&o>=t.maxTotalTimeout)throw this._timeoutInfo.delete(e),ee.fromError(te.RequestTimeout,"Maximum total timeout exceeded",{maxTotalTimeout:t.maxTotalTimeout,totalElapsed:o});return clearTimeout(t.timeoutId),t.timeoutId=setTimeout(t.onTimeout,t.timeout),!0}_cleanupTimeout(e){let t=this._timeoutInfo.get(e);t&&(clearTimeout(t.timeoutId),this._timeoutInfo.delete(e))}async connect(e){this._transport=e;let t=this.transport?.onclose;this._transport.onclose=()=>{t?.(),this._onclose()};let o=this.transport?.onerror;this._transport.onerror=i=>{o?.(i),this._onerror(i)};let r=this._transport?.onmessage;this._transport.onmessage=(i,a)=>{r?.(i,a),Ei(i)||jC(i)?this._onresponse(i):gl(i)?this._onrequest(i,a):UC(i)?this._onnotification(i):this._onerror(new Error(`Unknown message type: ${JSON.stringify(i)}`))},await this._transport.start()}_onclose(){let e=this._responseHandlers;this._responseHandlers=new Map,this._progressHandlers.clear(),this._taskProgressTokens.clear(),this._pendingDebouncedNotifications.clear();let t=ee.fromError(te.ConnectionClosed,"Connection closed");this._transport=void 0,this.onclose?.();for(let o of e.values())o(t)}_onerror(e){this.onerror?.(e)}_onnotification(e){let t=this._notificationHandlers.get(e.method)??this.fallbackNotificationHandler;t!==void 0&&Promise.resolve().then(()=>t(e)).catch(o=>this._onerror(new Error(`Uncaught error in notification handler: ${o}`)))}_onrequest(e,t){let o=this._requestHandlers.get(e.method)??this.fallbackRequestHandler,r=this._transport,i=e.params?._meta?.[Nr]?.taskId;if(o===void 0){let d={jsonrpc:"2.0",id:e.id,error:{code:te.MethodNotFound,message:"Method not found"}};i&&this._taskMessageQueue?this._enqueueTaskMessage(i,{type:"error",message:d,timestamp:Date.now()},r?.sessionId).catch(p=>this._onerror(new Error(`Failed to enqueue error response: ${p}`))):r?.send(d).catch(p=>this._onerror(new Error(`Failed to send an error response: ${p}`)));return}let a=new AbortController;this._requestHandlerAbortControllers.set(e.id,a);let s=qC(e.params)?e.params.task:void 0,c=this._taskStore?this.requestTaskStore(e,r?.sessionId):void 0,l={signal:a.signal,sessionId:r?.sessionId,_meta:e.params?._meta,sendNotification:async d=>{let p={relatedRequestId:e.id};i&&(p.relatedTask={taskId:i}),await this.notification(d,p)},sendRequest:async(d,p,f)=>{let m={...f,relatedRequestId:e.id};i&&!m.relatedTask&&(m.relatedTask={taskId:i});let h=m.relatedTask?.taskId??i;return h&&c&&await c.updateTaskStatus(h,"input_required"),await this.request(d,p,m)},authInfo:t?.authInfo,requestId:e.id,requestInfo:t?.requestInfo,taskId:i,taskStore:c,taskRequestedTtl:s?.ttl,closeSSEStream:t?.closeSSEStream,closeStandaloneSSEStream:t?.closeStandaloneSSEStream};Promise.resolve().then(()=>{s&&this.assertTaskHandlerCapability(e.method)}).then(()=>o(e,l)).then(async d=>{if(a.signal.aborted)return;let p={result:d,jsonrpc:"2.0",id:e.id};i&&this._taskMessageQueue?await this._enqueueTaskMessage(i,{type:"response",message:p,timestamp:Date.now()},r?.sessionId):await r?.send(p)},async d=>{if(a.signal.aborted)return;let p={jsonrpc:"2.0",id:e.id,error:{code:Number.isSafeInteger(d.code)?d.code:te.InternalError,message:d.message??"Internal error",...d.data!==void 0&&{data:d.data}}};i&&this._taskMessageQueue?await this._enqueueTaskMessage(i,{type:"error",message:p,timestamp:Date.now()},r?.sessionId):await r?.send(p)}).catch(d=>this._onerror(new Error(`Failed to send response: ${d}`))).finally(()=>{this._requestHandlerAbortControllers.delete(e.id)})}_onprogress(e){let{progressToken:t,...o}=e.params,r=Number(t),i=this._progressHandlers.get(r);if(!i){this._onerror(new Error(`Received a progress notification for an unknown token: ${JSON.stringify(e)}`));return}let a=this._responseHandlers.get(r),s=this._timeoutInfo.get(r);if(s&&a&&s.resetTimeoutOnProgress)try{this._resetTimeout(r)}catch(c){this._responseHandlers.delete(r),this._progressHandlers.delete(r),this._cleanupTimeout(r),a(c);return}i(o)}_onresponse(e){let t=Number(e.id),o=this._requestResolvers.get(t);if(o){if(this._requestResolvers.delete(t),Ei(e))o(e);else{let a=new ee(e.error.code,e.error.message,e.error.data);o(a)}return}let r=this._responseHandlers.get(t);if(r===void 0){this._onerror(new Error(`Received a response for an unknown message ID: ${JSON.stringify(e)}`));return}this._responseHandlers.delete(t),this._cleanupTimeout(t);let i=!1;if(Ei(e)&&e.result&&typeof e.result=="object"){let a=e.result;if(a.task&&typeof a.task=="object"){let s=a.task;typeof s.taskId=="string"&&(i=!0,this._taskProgressTokens.set(s.taskId,t))}}if(i||this._progressHandlers.delete(t),Ei(e))r(e);else{let a=ee.fromError(e.error.code,e.error.message,e.error.data);r(a)}}get transport(){return this._transport}async close(){await this._transport?.close()}async*requestStream(e,t,o){let{task:r}=o??{};if(!r){try{yield{type:"result",result:await this.request(e,t,o)}}catch(a){yield{type:"error",error:a instanceof ee?a:new ee(te.InternalError,String(a))}}return}let i;try{let a=await this.request(e,Oi,o);if(a.task)i=a.task.taskId,yield{type:"taskCreated",task:a.task};else throw new ee(te.InternalError,"Task creation did not return a task");for(;;){let s=await this.getTask({taskId:i},o);if(yield{type:"taskStatus",task:s},zr(s.status)){s.status==="completed"?yield{type:"result",result:await this.getTaskResult({taskId:i},t,o)}:s.status==="failed"?yield{type:"error",error:new ee(te.InternalError,`Task ${i} failed`)}:s.status==="cancelled"&&(yield{type:"error",error:new ee(te.InternalError,`Task ${i} was cancelled`)});return}if(s.status==="input_required"){yield{type:"result",result:await this.getTaskResult({taskId:i},t,o)};return}let c=s.pollInterval??this._options?.defaultTaskPollInterval??1e3;await new Promise(l=>setTimeout(l,c)),o?.signal?.throwIfAborted()}}catch(a){yield{type:"error",error:a instanceof ee?a:new ee(te.InternalError,String(a))}}}request(e,t,o){let{relatedRequestId:r,resumptionToken:i,onresumptiontoken:a,task:s,relatedTask:c}=o??{};return new Promise((l,d)=>{let p=x=>{d(x)};if(!this._transport){p(new Error("Not connected"));return}if(this._options?.enforceStrictCapabilities===!0)try{this.assertCapabilityForMethod(e.method),s&&this.assertTaskCapability(e.method)}catch(x){p(x);return}o?.signal?.throwIfAborted();let f=this._requestMessageId++,m={...e,jsonrpc:"2.0",id:f};o?.onprogress&&(this._progressHandlers.set(f,o.onprogress),m.params={...e.params,_meta:{...e.params?._meta||{},progressToken:f}}),s&&(m.params={...m.params,task:s}),c&&(m.params={...m.params,_meta:{...m.params?._meta||{},[Nr]:c}});let h=x=>{this._responseHandlers.delete(f),this._progressHandlers.delete(f),this._cleanupTimeout(f),this._transport?.send({jsonrpc:"2.0",method:"notifications/cancelled",params:{requestId:f,reason:String(x)}},{relatedRequestId:r,resumptionToken:i,onresumptiontoken:a}).catch(w=>this._onerror(new Error(`Failed to send cancellation: ${w}`)));let y=x instanceof ee?x:new ee(te.RequestTimeout,String(x));d(y)};this._responseHandlers.set(f,x=>{if(!o?.signal?.aborted){if(x instanceof Error)return d(x);try{let y=Xn(t,x.result);y.success?l(y.data):d(y.error)}catch(y){d(y)}}}),o?.signal?.addEventListener("abort",()=>{h(o?.signal?.reason)});let g=o?.timeout??c1,v=()=>h(ee.fromError(te.RequestTimeout,"Request timed out",{timeout:g}));this._setupTimeout(f,g,o?.maxTotalTimeout,v,o?.resetTimeoutOnProgress??!1);let k=c?.taskId;if(k){let x=y=>{let w=this._responseHandlers.get(f);w?w(y):this._onerror(new Error(`Response handler missing for side-channeled request ${f}`))};this._requestResolvers.set(f,x),this._enqueueTaskMessage(k,{type:"request",message:m,timestamp:Date.now()}).catch(y=>{this._cleanupTimeout(f),d(y)})}else this._transport.send(m,{relatedRequestId:r,resumptionToken:i,onresumptiontoken:a}).catch(x=>{this._cleanupTimeout(f),d(x)})})}async getTask(e,t){return this.request({method:"tasks/get",params:e},cp,t)}async getTaskResult(e,t,o){return this.request({method:"tasks/result",params:e},t,o)}async listTasks(e,t){return this.request({method:"tasks/list",params:e},dp,t)}async cancelTask(e,t){return this.request({method:"tasks/cancel",params:e},GC,t)}async notification(e,t){if(!this._transport)throw new Error("Not connected");this.assertNotificationCapability(e.method);let o=t?.relatedTask?.taskId;if(o){let s={...e,jsonrpc:"2.0",params:{...e.params,_meta:{...e.params?._meta||{},[Nr]:t.relatedTask}}};await this._enqueueTaskMessage(o,{type:"notification",message:s,timestamp:Date.now()});return}if((this._options?.debouncedNotificationMethods??[]).includes(e.method)&&!e.params&&!t?.relatedRequestId&&!t?.relatedTask){if(this._pendingDebouncedNotifications.has(e.method))return;this._pendingDebouncedNotifications.add(e.method),Promise.resolve().then(()=>{if(this._pendingDebouncedNotifications.delete(e.method),!this._transport)return;let s={...e,jsonrpc:"2.0"};t?.relatedTask&&(s={...s,params:{...s.params,_meta:{...s.params?._meta||{},[Nr]:t.relatedTask}}}),this._transport?.send(s,t).catch(c=>this._onerror(c))});return}let a={...e,jsonrpc:"2.0"};t?.relatedTask&&(a={...a,params:{...a.params,_meta:{...a.params?._meta||{},[Nr]:t.relatedTask}}}),await this._transport.send(a,t)}setRequestHandler(e,t){let o=Lg(e);this.assertRequestHandlerCapability(o),this._requestHandlers.set(o,(r,i)=>{let a=Ng(e,r);return Promise.resolve(t(a,i))})}removeRequestHandler(e){this._requestHandlers.delete(e)}assertCanSetRequestHandler(e){if(this._requestHandlers.has(e))throw new Error(`A request handler for ${e} already exists, which would be overridden`)}setNotificationHandler(e,t){let o=Lg(e);this._notificationHandlers.set(o,r=>{let i=Ng(e,r);return Promise.resolve(t(i))})}removeNotificationHandler(e){this._notificationHandlers.delete(e)}_cleanupTaskProgressHandler(e){let t=this._taskProgressTokens.get(e);t!==void 0&&(this._progressHandlers.delete(t),this._taskProgressTokens.delete(e))}async _enqueueTaskMessage(e,t,o){if(!this._taskStore||!this._taskMessageQueue)throw new Error("Cannot enqueue task message: taskStore and taskMessageQueue are not configured");let r=this._options?.maxTaskQueueSize;await this._taskMessageQueue.enqueue(e,t,o,r)}async _clearTaskQueue(e,t){if(this._taskMessageQueue){let o=await this._taskMessageQueue.dequeueAll(e,t);for(let r of o)if(r.type==="request"&&gl(r.message)){let i=r.message.id,a=this._requestResolvers.get(i);a?(a(new ee(te.InternalError,"Task cancelled or completed")),this._requestResolvers.delete(i)):this._onerror(new Error(`Resolver missing for request ${i} during task ${e} cleanup`))}}}async _waitForTaskUpdate(e,t){let o=this._options?.defaultTaskPollInterval??1e3;try{let r=await this._taskStore?.getTask(e);r?.pollInterval&&(o=r.pollInterval)}catch{}return new Promise((r,i)=>{if(t.aborted){i(new ee(te.InvalidRequest,"Request cancelled"));return}let a=setTimeout(r,o);t.addEventListener("abort",()=>{clearTimeout(a),i(new ee(te.InvalidRequest,"Request cancelled"))},{once:!0})})}requestTaskStore(e,t){let o=this._taskStore;if(!o)throw new Error("No task store configured");return{createTask:async r=>{if(!e)throw new Error("No request provided");return await o.createTask(r,e.id,{method:e.method,params:e.params},t)},getTask:async r=>{let i=await o.getTask(r,t);if(!i)throw new ee(te.InvalidParams,"Failed to retrieve task: Task not found");return i},storeTaskResult:async(r,i,a)=>{await o.storeTaskResult(r,i,a,t);let s=await o.getTask(r,t);if(s){let c=wl.parse({method:"notifications/tasks/status",params:s});await this.notification(c),zr(s.status)&&this._cleanupTaskProgressHandler(r)}},getTaskResult:r=>o.getTaskResult(r,t),updateTaskStatus:async(r,i,a)=>{let s=await o.getTask(r,t);if(!s)throw new ee(te.InvalidParams,`Task "${r}" not found - it may have been cleaned up`);if(zr(s.status))throw new ee(te.InvalidParams,`Cannot update task "${r}" from terminal status "${s.status}" to "${i}". Terminal states (completed, failed, cancelled) cannot transition to other states.`);await o.updateTaskStatus(r,i,a,t);let c=await o.getTask(r,t);if(c){let l=wl.parse({method:"notifications/tasks/status",params:c});await this.notification(l),zr(c.status)&&this._cleanupTaskProgressHandler(r)}},listTasks:r=>o.listTasks(r,t)}}};function tT(n){return n!==null&&typeof n=="object"&&!Array.isArray(n)}function nT(n,e){let t={...n};for(let o in e){let r=o,i=e[r];if(i===void 0)continue;let a=t[r];tT(a)&&tT(i)?t[r]={...a,...i}:t[r]=i}return t}var UA=D(wy(),1),jA=D(BA(),1);function XD(){let n=new UA.default({strict:!1,validateFormats:!0,validateSchema:!1,allErrors:!0});return(0,jA.default)(n),n}var Wp=class{constructor(e){this._ajv=e??XD()}getValidator(e){let t="$id"in e&&typeof e.$id=="string"?this._ajv.getSchema(e.$id)??this._ajv.compile(e):this._ajv.compile(e);return o=>t(o)?{valid:!0,data:o,errorMessage:void 0}:{valid:!1,data:void 0,errorMessage:this._ajv.errorsText(t.errors)}}};var Jp=class{constructor(e){this._client=e}async*callToolStream(e,t=Ss,o){let r=this._client,i={...o,task:o?.task??(r.isToolTask(e.name)?{}:void 0)},a=r.requestStream({method:"tools/call",params:e},t,i),s=r.getToolOutputValidator(e.name);for await(let c of a){if(c.type==="result"&&s){let l=c.result;if(!l.structuredContent&&!l.isError){yield{type:"error",error:new ee(te.InvalidRequest,`Tool ${e.name} has an output schema but did not return structured content`)};return}if(l.structuredContent)try{let d=s(l.structuredContent);if(!d.valid){yield{type:"error",error:new ee(te.InvalidParams,`Structured content does not match the tool's output schema: ${d.errorMessage}`)};return}}catch(d){if(d instanceof ee){yield{type:"error",error:d};return}yield{type:"error",error:new ee(te.InvalidParams,`Failed to validate structured content: ${d instanceof Error?d.message:String(d)}`)};return}}yield c}}async getTask(e,t){return this._client.getTask({taskId:e},t)}async getTaskResult(e,t,o){return this._client.getTaskResult({taskId:e},t,o)}async listTasks(e,t){return this._client.listTasks(e?{cursor:e}:void 0,t)}async cancelTask(e,t){return this._client.cancelTask({taskId:e},t)}requestStream(e,t,o){return this._client.requestStream(e,t,o)}};function KA(n,e,t){if(!n)throw new Error(`${t} does not support task creation (required for ${e})`);switch(e){case"tools/call":if(!n.tools?.call)throw new Error(`${t} does not support task creation for tools/call (required for ${e})`);break;default:break}}function HA(n,e,t){if(!n)throw new Error(`${t} does not support task creation (required for ${e})`);switch(e){case"sampling/createMessage":if(!n.sampling?.createMessage)throw new Error(`${t} does not support task creation for sampling/createMessage (required for ${e})`);break;case"elicitation/create":if(!n.elicitation?.create)throw new Error(`${t} does not support task creation for elicitation/create (required for ${e})`);break;default:break}}function Xp(n,e){if(!(!n||e===null||typeof e!="object")){if(n.type==="object"&&n.properties&&typeof n.properties=="object"){let t=e,o=n.properties;for(let r of Object.keys(o)){let i=o[r];t[r]===void 0&&Object.prototype.hasOwnProperty.call(i,"default")&&(t[r]=i.default),t[r]!==void 0&&Xp(i,t[r])}}if(Array.isArray(n.anyOf))for(let t of n.anyOf)typeof t!="boolean"&&Xp(t,e);if(Array.isArray(n.oneOf))for(let t of n.oneOf)typeof t!="boolean"&&Xp(t,e)}}function YD(n){if(!n)return{supportsFormMode:!1,supportsUrlMode:!1};let e=n.form!==void 0,t=n.url!==void 0;return{supportsFormMode:e||!e&&!t,supportsUrlMode:t}}var Yp=class extends mp{constructor(e,t){super(t),this._clientInfo=e,this._cachedToolOutputValidators=new Map,this._cachedKnownTaskTools=new Set,this._cachedRequiredTaskTools=new Set,this._listChangedDebounceTimers=new Map,this._capabilities=t?.capabilities??{},this._jsonSchemaValidator=t?.jsonSchemaValidator??new Wp,t?.listChanged&&(this._pendingListChangedConfig=t.listChanged)}_setupListChangedHandlers(e){e.tools&&this._serverCapabilities?.tools?.listChanged&&this._setupListChangedHandler("tools",Mg,e.tools,async()=>(await this.listTools()).tools),e.prompts&&this._serverCapabilities?.prompts?.listChanged&&this._setupListChangedHandler("prompts",Ag,e.prompts,async()=>(await this.listPrompts()).prompts),e.resources&&this._serverCapabilities?.resources?.listChanged&&this._setupListChangedHandler("resources",bg,e.resources,async()=>(await this.listResources()).resources)}get experimental(){return this._experimental||(this._experimental={tasks:new Jp(this)}),this._experimental}registerCapabilities(e){if(this.transport)throw new Error("Cannot register capabilities after connecting to transport");this._capabilities=nT(this._capabilities,e)}setRequestHandler(e,t){let r=Qd(e)?.method;if(!r)throw new Error("Schema is missing a method literal");let i;if(Is(r)){let s=r;i=s._zod?.def?.value??s.value}else{let s=r;i=s._def?.value??s.value}if(typeof i!="string")throw new Error("Schema method literal must be a string");let a=i;if(a==="elicitation/create"){let s=async(c,l)=>{let d=Xn(Eg,c);if(!d.success){let x=d.error instanceof Error?d.error.message:String(d.error);throw new ee(te.InvalidParams,`Invalid elicitation request: ${x}`)}let{params:p}=d.data;p.mode=p.mode??"form";let{supportsFormMode:f,supportsUrlMode:m}=YD(this._capabilities.elicitation);if(p.mode==="form"&&!f)throw new ee(te.InvalidParams,"Client does not support form-mode elicitation requests");if(p.mode==="url"&&!m)throw new ee(te.InvalidParams,"Client does not support URL-mode elicitation requests");let h=await Promise.resolve(t(c,l));if(p.task){let x=Xn(Oi,h);if(!x.success){let y=x.error instanceof Error?x.error.message:String(x.error);throw new ee(te.InvalidParams,`Invalid task creation result: ${y}`)}return x.data}let g=Xn(Rg,h);if(!g.success){let x=g.error instanceof Error?g.error.message:String(g.error);throw new ee(te.InvalidParams,`Invalid elicitation result: ${x}`)}let v=g.data,k=p.mode==="form"?p.requestedSchema:void 0;if(p.mode==="form"&&v.action==="accept"&&v.content&&k&&this._capabilities.elicitation?.form?.applyDefaults)try{Xp(k,v.content)}catch{}return v};return super.setRequestHandler(e,s)}if(a==="sampling/createMessage"){let s=async(c,l)=>{let d=Xn(Sg,c);if(!d.success){let h=d.error instanceof Error?d.error.message:String(d.error);throw new ee(te.InvalidParams,`Invalid sampling request: ${h}`)}let{params:p}=d.data,f=await Promise.resolve(t(c,l));if(p.task){let h=Xn(Oi,f);if(!h.success){let g=h.error instanceof Error?h.error.message:String(h.error);throw new ee(te.InvalidParams,`Invalid task creation result: ${g}`)}return h.data}let m=Xn($g,f);if(!m.success){let h=m.error instanceof Error?m.error.message:String(m.error);throw new ee(te.InvalidParams,`Invalid sampling result: ${h}`)}return m.data};return super.setRequestHandler(e,s)}return super.setRequestHandler(e,t)}assertCapability(e,t){if(!this._serverCapabilities?.[e])throw new Error(`Server does not support ${e} (required for ${t})`)}async connect(e,t){if(await super.connect(e),e.sessionId===void 0)try{let o=await this.request({method:"initialize",params:{protocolVersion:Ps,capabilities:this._capabilities,clientInfo:this._clientInfo}},fg,t);if(o===void 0)throw new Error(`Server sent invalid initialize result: ${o}`);if(!NC.includes(o.protocolVersion))throw new Error(`Server's protocol version is not supported: ${o.protocolVersion}`);this._serverCapabilities=o.capabilities,this._serverVersion=o.serverInfo,e.setProtocolVersion&&e.setProtocolVersion(o.protocolVersion),this._instructions=o.instructions,await this.notification({method:"notifications/initialized"}),this._pendingListChangedConfig&&(this._setupListChangedHandlers(this._pendingListChangedConfig),this._pendingListChangedConfig=void 0)}catch(o){throw this.close(),o}}getServerCapabilities(){return this._serverCapabilities}getServerVersion(){return this._serverVersion}getInstructions(){return this._instructions}assertCapabilityForMethod(e){switch(e){case"logging/setLevel":if(!this._serverCapabilities?.logging)throw new Error(`Server does not support logging (required for ${e})`);break;case"prompts/get":case"prompts/list":if(!this._serverCapabilities?.prompts)throw new Error(`Server does not support prompts (required for ${e})`);break;case"resources/list":case"resources/templates/list":case"resources/read":case"resources/subscribe":case"resources/unsubscribe":if(!this._serverCapabilities?.resources)throw new Error(`Server does not support resources (required for ${e})`);if(e==="resources/subscribe"&&!this._serverCapabilities.resources.subscribe)throw new Error(`Server does not support resource subscriptions (required for ${e})`);break;case"tools/call":case"tools/list":if(!this._serverCapabilities?.tools)throw new Error(`Server does not support tools (required for ${e})`);break;case"completion/complete":if(!this._serverCapabilities?.completions)throw new Error(`Server does not support completions (required for ${e})`);break;case"initialize":break;case"ping":break}}assertNotificationCapability(e){switch(e){case"notifications/roots/list_changed":if(!this._capabilities.roots?.listChanged)throw new Error(`Client does not support roots list changed notifications (required for ${e})`);break;case"notifications/initialized":break;case"notifications/cancelled":break;case"notifications/progress":break}}assertRequestHandlerCapability(e){if(this._capabilities)switch(e){case"sampling/createMessage":if(!this._capabilities.sampling)throw new Error(`Client does not support sampling capability (required for ${e})`);break;case"elicitation/create":if(!this._capabilities.elicitation)throw new Error(`Client does not support elicitation capability (required for ${e})`);break;case"roots/list":if(!this._capabilities.roots)throw new Error(`Client does not support roots capability (required for ${e})`);break;case"tasks/get":case"tasks/list":case"tasks/result":case"tasks/cancel":if(!this._capabilities.tasks)throw new Error(`Client does not support tasks capability (required for ${e})`);break;case"ping":break}}assertTaskCapability(e){KA(this._serverCapabilities?.tasks?.requests,e,"Server")}assertTaskHandlerCapability(e){this._capabilities&&HA(this._capabilities.tasks?.requests,e,"Client")}async ping(e){return this.request({method:"ping"},Ri,e)}async complete(e,t){return this.request({method:"completion/complete",params:e},Og,t)}async setLoggingLevel(e,t){return this.request({method:"logging/setLevel",params:{level:e}},Ri,t)}async getPrompt(e,t){return this.request({method:"prompts/get",params:e},Ig,t)}async listPrompts(e,t){return this.request({method:"prompts/list",params:e},wg,t)}async listResources(e,t){return this.request({method:"resources/list",params:e},gg,t)}async listResourceTemplates(e,t){return this.request({method:"resources/templates/list",params:e},vg,t)}async readResource(e,t){return this.request({method:"resources/read",params:e},xg,t)}async subscribeResource(e,t){return this.request({method:"resources/subscribe",params:e},Ri,t)}async unsubscribeResource(e,t){return this.request({method:"resources/unsubscribe",params:e},Ri,t)}async callTool(e,t=Ss,o){if(this.isToolTaskRequired(e.name))throw new ee(te.InvalidRequest,`Tool "${e.name}" requires task-based execution. Use client.experimental.tasks.callToolStream() instead.`);let r=await this.request({method:"tools/call",params:e},t,o),i=this.getToolOutputValidator(e.name);if(i){if(!r.structuredContent&&!r.isError)throw new ee(te.InvalidRequest,`Tool ${e.name} has an output schema but did not return structured content`);if(r.structuredContent)try{let a=i(r.structuredContent);if(!a.valid)throw new ee(te.InvalidParams,`Structured content does not match the tool's output schema: ${a.errorMessage}`)}catch(a){throw a instanceof ee?a:new ee(te.InvalidParams,`Failed to validate structured content: ${a instanceof Error?a.message:String(a)}`)}}return r}isToolTask(e){return this._serverCapabilities?.tasks?.requests?.tools?.call?this._cachedKnownTaskTools.has(e):!1}isToolTaskRequired(e){return this._cachedRequiredTaskTools.has(e)}cacheToolMetadata(e){this._cachedToolOutputValidators.clear(),this._cachedKnownTaskTools.clear(),this._cachedRequiredTaskTools.clear();for(let t of e){if(t.outputSchema){let r=this._jsonSchemaValidator.getValidator(t.outputSchema);this._cachedToolOutputValidators.set(t.name,r)}let o=t.execution?.taskSupport;(o==="required"||o==="optional")&&this._cachedKnownTaskTools.add(t.name),o==="required"&&this._cachedRequiredTaskTools.add(t.name)}}getToolOutputValidator(e){return this._cachedToolOutputValidators.get(e)}async listTools(e,t){let o=await this.request({method:"tools/list",params:e},Pg,t);return this.cacheToolMetadata(o.tools),o}_setupListChangedHandler(e,t,o,r){let i=YC.safeParse(o);if(!i.success)throw new Error(`Invalid ${e} listChanged options: ${i.error.message}`);if(typeof o.onChanged!="function")throw new Error(`Invalid ${e} listChanged options: onChanged must be a function`);let{autoRefresh:a,debounceMs:s}=i.data,{onChanged:c}=o,l=async()=>{if(!a){c(null,null);return}try{let p=await r();c(null,p)}catch(p){let f=p instanceof Error?p:new Error(String(p));c(f,null)}},d=()=>{if(s){let p=this._listChangedDebounceTimers.get(e);p&&clearTimeout(p);let f=setTimeout(l,s);this._listChangedDebounceTimers.set(e,f)}else l()};this.setNotificationHandler(t,d)}async sendRootsListChanged(){return this.notification({method:"notifications/roots/list_changed"})}};function em(n){return n?n instanceof Headers?Object.fromEntries(n.entries()):Array.isArray(n)?Object.fromEntries(n):{...n}:{}}function ZA(n=fetch,e){return e?async(t,o)=>{let r={...e,...o,headers:o?.headers?{...em(e.headers),...em(o.headers)}:e.headers};return n(t,r)}:n}var My;My=globalThis.crypto?.webcrypto??globalThis.crypto??import("node:crypto").then(n=>n.webcrypto);async function eq(n){return(await My).getRandomValues(new Uint8Array(n))}async function tq(n){let e="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789-._~",t="",o=await eq(n);for(let r=0;r<n;r++){let i=o[r]%e.length;t+=e[i]}return t}async function nq(n){return await tq(n)}async function oq(n){let e=await(await My).subtle.digest("SHA-256",new TextEncoder().encode(n));return btoa(String.fromCharCode(...new Uint8Array(e))).replace(/\//g,"_").replace(/\+/g,"-").replace(/=/g,"")}async function Sy(n){if(n||(n=43),n<43||n>128)throw`Expected a length between 43 and 128. Received ${n}.`;let e=await nq(n),t=await oq(e);return{code_verifier:e,code_challenge:t}}var Kt=CC().superRefine((n,e)=>{if(!URL.canParse(n))return e.addIssue({code:LC.custom,message:"URL must be parseable",fatal:!0}),gh}).refine(n=>{let e=new URL(n);return e.protocol!=="javascript:"&&e.protocol!=="data:"&&e.protocol!=="vbscript:"},{message:"URL cannot use javascript:, data:, or vbscript: scheme"}),VA=_t({resource:_().url(),authorization_servers:B(Kt).optional(),jwks_uri:_().url().optional(),scopes_supported:B(_()).optional(),bearer_methods_supported:B(_()).optional(),resource_signing_alg_values_supported:B(_()).optional(),resource_name:_().optional(),resource_documentation:_().optional(),resource_policy_uri:_().url().optional(),resource_tos_uri:_().url().optional(),tls_client_certificate_bound_access_tokens:Oe().optional(),authorization_details_types_supported:B(_()).optional(),dpop_signing_alg_values_supported:B(_()).optional(),dpop_bound_access_tokens_required:Oe().optional()}),$y=_t({issuer:_(),authorization_endpoint:Kt,token_endpoint:Kt,registration_endpoint:Kt.optional(),scopes_supported:B(_()).optional(),response_types_supported:B(_()),response_modes_supported:B(_()).optional(),grant_types_supported:B(_()).optional(),token_endpoint_auth_methods_supported:B(_()).optional(),token_endpoint_auth_signing_alg_values_supported:B(_()).optional(),service_documentation:Kt.optional(),revocation_endpoint:Kt.optional(),revocation_endpoint_auth_methods_supported:B(_()).optional(),revocation_endpoint_auth_signing_alg_values_supported:B(_()).optional(),introspection_endpoint:_().optional(),introspection_endpoint_auth_methods_supported:B(_()).optional(),introspection_endpoint_auth_signing_alg_values_supported:B(_()).optional(),code_challenge_methods_supported:B(_()).optional(),client_id_metadata_document_supported:Oe().optional()}),rq=_t({issuer:_(),authorization_endpoint:Kt,token_endpoint:Kt,userinfo_endpoint:Kt.optional(),jwks_uri:Kt,registration_endpoint:Kt.optional(),scopes_supported:B(_()).optional(),response_types_supported:B(_()),response_modes_supported:B(_()).optional(),grant_types_supported:B(_()).optional(),acr_values_supported:B(_()).optional(),subject_types_supported:B(_()),id_token_signing_alg_values_supported:B(_()),id_token_encryption_alg_values_supported:B(_()).optional(),id_token_encryption_enc_values_supported:B(_()).optional(),userinfo_signing_alg_values_supported:B(_()).optional(),userinfo_encryption_alg_values_supported:B(_()).optional(),userinfo_encryption_enc_values_supported:B(_()).optional(),request_object_signing_alg_values_supported:B(_()).optional(),request_object_encryption_alg_values_supported:B(_()).optional(),request_object_encryption_enc_values_supported:B(_()).optional(),token_endpoint_auth_methods_supported:B(_()).optional(),token_endpoint_auth_signing_alg_values_supported:B(_()).optional(),display_values_supported:B(_()).optional(),claim_types_supported:B(_()).optional(),claims_supported:B(_()).optional(),service_documentation:_().optional(),claims_locales_supported:B(_()).optional(),ui_locales_supported:B(_()).optional(),claims_parameter_supported:Oe().optional(),request_parameter_supported:Oe().optional(),request_uri_parameter_supported:Oe().optional(),require_request_uri_registration:Oe().optional(),op_policy_uri:Kt.optional(),op_tos_uri:Kt.optional(),client_id_metadata_document_supported:Oe().optional()}),QA=j({...rq.shape,...$y.pick({code_challenge_methods_supported:!0}).shape}),WA=j({access_token:_(),id_token:_().optional(),token_type:_(),expires_in:Yd.number().optional(),scope:_().optional(),refresh_token:_().optional()}).strip(),JA=j({error:_(),error_description:_().optional(),error_uri:_().optional()}),GA=Kt.optional().or(V("").transform(()=>{})),iq=j({redirect_uris:B(Kt),token_endpoint_auth_method:_().optional(),grant_types:B(_()).optional(),response_types:B(_()).optional(),client_name:_().optional(),client_uri:Kt.optional(),logo_uri:GA,scope:_().optional(),contacts:B(_()).optional(),tos_uri:GA,policy_uri:_().optional(),jwks_uri:Kt.optional(),jwks:IC().optional(),software_id:_().optional(),software_version:_().optional(),software_statement:_().optional()}).strip(),aq=j({client_id:_(),client_secret:_().optional(),client_id_issued_at:Ce().optional(),client_secret_expires_at:Ce().optional()}).strip(),XA=iq.merge(aq),iee=j({error:_(),error_description:_().optional()}).strip(),aee=j({token:_(),token_type_hint:_().optional()}).strip();function YA(n){let e=typeof n=="string"?new URL(n):new URL(n.href);return e.hash="",e}function eP({requestedResource:n,configuredResource:e}){let t=typeof n=="string"?new URL(n):new URL(n.href),o=typeof e=="string"?new URL(e):new URL(e.href);if(t.origin!==o.origin||t.pathname.length<o.pathname.length)return!1;let r=t.pathname.endsWith("/")?t.pathname:t.pathname+"/",i=o.pathname.endsWith("/")?o.pathname:o.pathname+"/";return r.startsWith(i)}var lt=class extends Error{constructor(e,t){super(e),this.errorUri=t,this.name=this.constructor.name}toResponseObject(){let e={error:this.errorCode,error_description:this.message};return this.errorUri&&(e.error_uri=this.errorUri),e}get errorCode(){return this.constructor.errorCode}},Yl=class extends lt{};Yl.errorCode="invalid_request";var Hi=class extends lt{};Hi.errorCode="invalid_client";var Zi=class extends lt{};Zi.errorCode="invalid_grant";var Gi=class extends lt{};Gi.errorCode="unauthorized_client";var eu=class extends lt{};eu.errorCode="unsupported_grant_type";var tu=class extends lt{};tu.errorCode="invalid_scope";var nu=class extends lt{};nu.errorCode="access_denied";var nr=class extends lt{};nr.errorCode="server_error";var ou=class extends lt{};ou.errorCode="temporarily_unavailable";var ru=class extends lt{};ru.errorCode="unsupported_response_type";var iu=class extends lt{};iu.errorCode="unsupported_token_type";var au=class extends lt{};au.errorCode="invalid_token";var su=class extends lt{};su.errorCode="method_not_allowed";var cu=class extends lt{};cu.errorCode="too_many_requests";var Vi=class extends lt{};Vi.errorCode="invalid_client_metadata";var lu=class extends lt{};lu.errorCode="insufficient_scope";var uu=class extends lt{};uu.errorCode="invalid_target";var tP={[Yl.errorCode]:Yl,[Hi.errorCode]:Hi,[Zi.errorCode]:Zi,[Gi.errorCode]:Gi,[eu.errorCode]:eu,[tu.errorCode]:tu,[nu.errorCode]:nu,[nr.errorCode]:nr,[ou.errorCode]:ou,[ru.errorCode]:ru,[iu.errorCode]:iu,[au.errorCode]:au,[su.errorCode]:su,[cu.errorCode]:cu,[Vi.errorCode]:Vi,[lu.errorCode]:lu,[uu.errorCode]:uu};var or=class extends Error{constructor(e){super(e??"Unauthorized")}};function sq(n){return["client_secret_basic","client_secret_post","none"].includes(n)}var Ey="code",Ry="S256";function cq(n,e){let t=n.client_secret!==void 0;return e.length===0?t?"client_secret_post":"none":"token_endpoint_auth_method"in n&&n.token_endpoint_auth_method&&sq(n.token_endpoint_auth_method)&&e.includes(n.token_endpoint_auth_method)?n.token_endpoint_auth_method:t&&e.includes("client_secret_basic")?"client_secret_basic":t&&e.includes("client_secret_post")?"client_secret_post":e.includes("none")?"none":t?"client_secret_post":"none"}function lq(n,e,t,o){let{client_id:r,client_secret:i}=e;switch(n){case"client_secret_basic":uq(r,i,t);return;case"client_secret_post":dq(r,i,o);return;case"none":pq(r,o);return;default:throw new Error(`Unsupported client authentication method: ${n}`)}}function uq(n,e,t){if(!e)throw new Error("client_secret_basic authentication requires a client_secret");let o=btoa(`${n}:${e}`);t.set("Authorization",`Basic ${o}`)}function dq(n,e,t){t.set("client_id",n),e&&t.set("client_secret",e)}function pq(n,e){e.set("client_id",n)}async function oP(n){let e=n instanceof Response?n.status:void 0,t=n instanceof Response?await n.text():n;try{let o=JA.parse(JSON.parse(t)),{error:r,error_description:i,error_uri:a}=o,s=tP[r]||nr;return new s(i||"",a)}catch(o){let r=`${e?`HTTP ${e}: `:""}Invalid OAuth error response: ${o}. Raw body: ${t}`;return new nr(r)}}async function du(n,e){try{return await Oy(n,e)}catch(t){if(t instanceof Hi||t instanceof Gi)return await n.invalidateCredentials?.("all"),await Oy(n,e);if(t instanceof Zi)return await n.invalidateCredentials?.("tokens"),await Oy(n,e);throw t}}async function Oy(n,{serverUrl:e,authorizationCode:t,scope:o,resourceMetadataUrl:r,fetchFn:i}){let a,s;try{a=await hq(e,{resourceMetadataUrl:r},i),a.authorization_servers&&a.authorization_servers.length>0&&(s=a.authorization_servers[0])}catch{}s||(s=new URL("/",e));let c=await fq(e,n,a),l=await bq(s,{fetchFn:i}),d=await Promise.resolve(n.clientInformation());if(!d){if(t!==void 0)throw new Error("Existing OAuth client information is required when exchanging an authorization code");let v=l?.client_id_metadata_document_supported===!0,k=n.clientMetadataUrl;if(k&&!mq(k))throw new Vi(`clientMetadataUrl must be a valid HTTPS URL with a non-root pathname, got: ${k}`);if(v&&k)d={client_id:k},await n.saveClientInformation?.(d);else{if(!n.saveClientInformation)throw new Error("OAuth client information must be saveable for dynamic registration");let y=await Tq(s,{metadata:l,clientMetadata:n.clientMetadata,fetchFn:i});await n.saveClientInformation(y),d=y}}let p=!n.redirectUrl;if(t!==void 0||p){let v=await Cq(n,s,{metadata:l,resource:c,authorizationCode:t,fetchFn:i});return await n.saveTokens(v),"AUTHORIZED"}let f=await n.tokens();if(f?.refresh_token)try{let v=await _q(s,{metadata:l,clientInformation:d,refreshToken:f.refresh_token,resource:c,addClientAuthentication:n.addClientAuthentication,fetchFn:i});return await n.saveTokens(v),"AUTHORIZED"}catch(v){if(!(!(v instanceof lt)||v instanceof nr))throw v}let m=n.state?await n.state():void 0,{authorizationUrl:h,codeVerifier:g}=await wq(s,{metadata:l,clientInformation:d,state:m,redirectUrl:n.redirectUrl,scope:o||a?.scopes_supported?.join(" ")||n.clientMetadata.scope,resource:c});return await n.saveCodeVerifier(g),await n.redirectToAuthorization(h),"REDIRECT"}function mq(n){if(!n)return!1;try{let e=new URL(n);return e.protocol==="https:"&&e.pathname!=="/"}catch{return!1}}async function fq(n,e,t){let o=YA(n);if(e.validateResourceURL)return await e.validateResourceURL(o,t?.resource);if(t){if(!eP({requestedResource:o,configuredResource:t.resource}))throw new Error(`Protected resource ${t.resource} does not match expected ${o} (or origin)`);return new URL(t.resource)}}function Ny(n){let e=n.headers.get("WWW-Authenticate");if(!e)return{};let[t,o]=e.split(" ");if(t.toLowerCase()!=="bearer"||!o)return{};let r=Ly(n,"resource_metadata")||void 0,i;if(r)try{i=new URL(r)}catch{}let a=Ly(n,"scope")||void 0,s=Ly(n,"error")||void 0;return{resourceMetadataUrl:i,scope:a,error:s}}function Ly(n,e){let t=n.headers.get("WWW-Authenticate");if(!t)return null;let o=new RegExp(`${e}=(?:"([^"]+)"|([^\\s,]+))`),r=t.match(o);return r?r[1]||r[2]:null}async function hq(n,e,t=fetch){let o=await yq(n,"oauth-protected-resource",t,{protocolVersion:e?.protocolVersion,metadataUrl:e?.resourceMetadataUrl});if(!o||o.status===404)throw await o?.body?.cancel(),new Error("Resource server does not implement OAuth 2.0 Protected Resource Metadata.");if(!o.ok)throw await o.body?.cancel(),new Error(`HTTP ${o.status} trying to load well-known OAuth protected resource metadata.`);return VA.parse(await o.json())}async function zy(n,e,t=fetch){try{return await t(n,{headers:e})}catch(o){if(o instanceof TypeError)return e?zy(n,void 0,t):void 0;throw o}}function gq(n,e="",t={}){return e.endsWith("/")&&(e=e.slice(0,-1)),t.prependPathname?`${e}/.well-known/${n}`:`/.well-known/${n}${e}`}async function nP(n,e,t=fetch){return await zy(n,{"MCP-Protocol-Version":e},t)}function vq(n,e){return!n||n.status>=400&&n.status<500&&e!=="/"}async function yq(n,e,t,o){let r=new URL(n),i=o?.protocolVersion??Ps,a;if(o?.metadataUrl)a=new URL(o.metadataUrl);else{let c=gq(e,r.pathname);a=new URL(c,o?.metadataServerUrl??r),a.search=r.search}let s=await nP(a,i,t);if(!o?.metadataUrl&&vq(s,r.pathname)){let c=new URL(`/.well-known/${e}`,r);s=await nP(c,i,t)}return s}function xq(n){let e=typeof n=="string"?new URL(n):n,t=e.pathname!=="/",o=[];if(!t)return o.push({url:new URL("/.well-known/oauth-authorization-server",e.origin),type:"oauth"}),o.push({url:new URL("/.well-known/openid-configuration",e.origin),type:"oidc"}),o;let r=e.pathname;return r.endsWith("/")&&(r=r.slice(0,-1)),o.push({url:new URL(`/.well-known/oauth-authorization-server${r}`,e.origin),type:"oauth"}),o.push({url:new URL(`/.well-known/openid-configuration${r}`,e.origin),type:"oidc"}),o.push({url:new URL(`${r}/.well-known/openid-configuration`,e.origin),type:"oidc"}),o}async function bq(n,{fetchFn:e=fetch,protocolVersion:t=Ps}={}){let o={"MCP-Protocol-Version":t,Accept:"application/json"},r=xq(n);for(let{url:i,type:a}of r){let s=await zy(i,o,e);if(s){if(!s.ok){if(await s.body?.cancel(),s.status>=400&&s.status<500)continue;throw new Error(`HTTP ${s.status} trying to load ${a==="oauth"?"OAuth":"OpenID provider"} metadata from ${i}`)}return a==="oauth"?$y.parse(await s.json()):QA.parse(await s.json())}}}async function wq(n,{metadata:e,clientInformation:t,redirectUrl:o,scope:r,state:i,resource:a}){let s;if(e){if(s=new URL(e.authorization_endpoint),!e.response_types_supported.includes(Ey))throw new Error(`Incompatible auth server: does not support response type ${Ey}`);if(e.code_challenge_methods_supported&&!e.code_challenge_methods_supported.includes(Ry))throw new Error(`Incompatible auth server: does not support code challenge method ${Ry}`)}else s=new URL("/authorize",n);let c=await Sy(),l=c.code_verifier,d=c.code_challenge;return s.searchParams.set("response_type",Ey),s.searchParams.set("client_id",t.client_id),s.searchParams.set("code_challenge",d),s.searchParams.set("code_challenge_method",Ry),s.searchParams.set("redirect_uri",String(o)),i&&s.searchParams.set("state",i),r&&s.searchParams.set("scope",r),r?.includes("offline_access")&&s.searchParams.append("prompt","consent"),a&&s.searchParams.set("resource",a.href),{authorizationUrl:s,codeVerifier:l}}function kq(n,e,t){return new URLSearchParams({grant_type:"authorization_code",code:n,code_verifier:e,redirect_uri:String(t)})}async function rP(n,{metadata:e,tokenRequestParams:t,clientInformation:o,addClientAuthentication:r,resource:i,fetchFn:a}){let s=e?.token_endpoint?new URL(e.token_endpoint):new URL("/token",n),c=new Headers({"Content-Type":"application/x-www-form-urlencoded",Accept:"application/json"});if(i&&t.set("resource",i.href),r)await r(c,t,s,e);else if(o){let d=e?.token_endpoint_auth_methods_supported??[],p=cq(o,d);lq(p,o,c,t)}let l=await(a??fetch)(s,{method:"POST",headers:c,body:t});if(!l.ok)throw await oP(l);return WA.parse(await l.json())}async function _q(n,{metadata:e,clientInformation:t,refreshToken:o,resource:r,addClientAuthentication:i,fetchFn:a}){let s=new URLSearchParams({grant_type:"refresh_token",refresh_token:o}),c=await rP(n,{metadata:e,tokenRequestParams:s,clientInformation:t,addClientAuthentication:i,resource:r,fetchFn:a});return{refresh_token:o,...c}}async function Cq(n,e,{metadata:t,resource:o,authorizationCode:r,fetchFn:i}={}){let a=n.clientMetadata.scope,s;if(n.prepareTokenRequest&&(s=await n.prepareTokenRequest(a)),!s){if(!r)throw new Error("Either provider.prepareTokenRequest() or authorizationCode is required");if(!n.redirectUrl)throw new Error("redirectUrl is required for authorization_code flow");let l=await n.codeVerifier();s=kq(r,l,n.redirectUrl)}let c=await n.clientInformation();return rP(e,{metadata:t,tokenRequestParams:s,clientInformation:c??void 0,addClientAuthentication:n.addClientAuthentication,resource:o,fetchFn:i})}async function Tq(n,{metadata:e,clientMetadata:t,fetchFn:o}){let r;if(e){if(!e.registration_endpoint)throw new Error("Incompatible auth server: does not support dynamic client registration");r=new URL(e.registration_endpoint)}else r=new URL("/register",n);let i=await(o??fetch)(r,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!i.ok)throw await oP(i);return XA.parse(await i.json())}var tm=class extends Error{constructor(e,t){super(e),this.name="ParseError",this.type=t.type,this.field=t.field,this.value=t.value,this.line=t.line}};function Dy(n){}function iP(n){if(typeof n=="function")throw new TypeError("`callbacks` must be an object, got a function instead. Did you mean `{onEvent: fn}`?");let{onEvent:e=Dy,onError:t=Dy,onRetry:o=Dy,onComment:r}=n,i="",a=!0,s,c="",l="";function d(g){let v=a?g.replace(/^\xEF\xBB\xBF/,""):g,[k,x]=Iq(`${i}${v}`);for(let y of k)p(y);i=x,a=!1}function p(g){if(g===""){m();return}if(g.startsWith(":")){r&&r(g.slice(g.startsWith(": ")?2:1));return}let v=g.indexOf(":");if(v!==-1){let k=g.slice(0,v),x=g[v+1]===" "?2:1,y=g.slice(v+x);f(k,y,g);return}f(g,"",g)}function f(g,v,k){switch(g){case"event":l=v;break;case"data":c=`${c}${v}
`;break;case"id":s=v.includes("\0")?void 0:v;break;case"retry":/^\d+$/.test(v)?o(parseInt(v,10)):t(new tm(`Invalid \`retry\` value: "${v}"`,{type:"invalid-retry",value:v,line:k}));break;default:t(new tm(`Unknown field "${g.length>20?`${g.slice(0,20)}\u2026`:g}"`,{type:"unknown-field",field:g,value:v,line:k}));break}}function m(){c.length>0&&e({id:s,event:l||void 0,data:c.endsWith(`
`)?c.slice(0,-1):c}),s=void 0,c="",l=""}function h(g={}){i&&g.consume&&p(i),a=!0,s=void 0,c="",l="",i=""}return{feed:d,reset:h}}function Iq(n){let e=[],t="",o=0;for(;o<n.length;){let r=n.indexOf("\r",o),i=n.indexOf(`
`,o),a=-1;if(r!==-1&&i!==-1?a=Math.min(r,i):r!==-1?r===n.length-1?a=-1:a=r:i!==-1&&(a=i),a===-1){t=n.slice(o);break}else{let s=n.slice(o,a);e.push(s),o=a+1,n[o-1]==="\r"&&n[o]===`
`&&o++}}return[e,t]}var nm=class extends TransformStream{constructor({onError:e,onRetry:t,onComment:o}={}){let r;super({start(i){r=iP({onEvent:a=>{i.enqueue(a)},onError(a){e==="terminate"?i.error(a):typeof e=="function"&&e(a)},onRetry:t,onComment:o})},transform(i){r.feed(i)}})}};var Aq={initialReconnectionDelay:1e3,maxReconnectionDelay:3e4,reconnectionDelayGrowFactor:1.5,maxRetries:2},Zr=class extends Error{constructor(e,t){super(`Streamable HTTP error: ${t}`),this.code=e}},om=class{constructor(e,t){this._hasCompletedAuthFlow=!1,this._url=e,this._resourceMetadataUrl=void 0,this._scope=void 0,this._requestInit=t?.requestInit,this._authProvider=t?.authProvider,this._fetch=t?.fetch,this._fetchWithInit=ZA(t?.fetch,t?.requestInit),this._sessionId=t?.sessionId,this._reconnectionOptions=t?.reconnectionOptions??Aq}async _authThenStart(){if(!this._authProvider)throw new or("No auth provider");let e;try{e=await du(this._authProvider,{serverUrl:this._url,resourceMetadataUrl:this._resourceMetadataUrl,scope:this._scope,fetchFn:this._fetchWithInit})}catch(t){throw this.onerror?.(t),t}if(e!=="AUTHORIZED")throw new or;return await this._startOrAuthSse({resumptionToken:void 0})}async _commonHeaders(){let e={};if(this._authProvider){let o=await this._authProvider.tokens();o&&(e.Authorization=`Bearer ${o.access_token}`)}this._sessionId&&(e["mcp-session-id"]=this._sessionId),this._protocolVersion&&(e["mcp-protocol-version"]=this._protocolVersion);let t=em(this._requestInit?.headers);return new Headers({...e,...t})}async _startOrAuthSse(e){let{resumptionToken:t}=e;try{let o=await this._commonHeaders();o.set("Accept","text/event-stream"),t&&o.set("last-event-id",t);let r=await(this._fetch??fetch)(this._url,{method:"GET",headers:o,signal:this._abortController?.signal});if(!r.ok){if(await r.body?.cancel(),r.status===401&&this._authProvider)return await this._authThenStart();if(r.status===405)return;throw new Zr(r.status,`Failed to open SSE stream: ${r.statusText}`)}this._handleSseStream(r.body,e,!0)}catch(o){throw this.onerror?.(o),o}}_getNextReconnectionDelay(e){if(this._serverRetryMs!==void 0)return this._serverRetryMs;let t=this._reconnectionOptions.initialReconnectionDelay,o=this._reconnectionOptions.reconnectionDelayGrowFactor,r=this._reconnectionOptions.maxReconnectionDelay;return Math.min(t*Math.pow(o,e),r)}_scheduleReconnection(e,t=0){let o=this._reconnectionOptions.maxRetries;if(t>=o){this.onerror?.(new Error(`Maximum reconnection attempts (${o}) exceeded.`));return}let r=this._getNextReconnectionDelay(t);this._reconnectionTimeout=setTimeout(()=>{this._startOrAuthSse(e).catch(i=>{this.onerror?.(new Error(`Failed to reconnect SSE stream: ${i instanceof Error?i.message:String(i)}`)),this._scheduleReconnection(e,t+1)})},r)}_handleSseStream(e,t,o){if(!e)return;let{onresumptiontoken:r,replayMessageId:i}=t,a,s=!1,c=!1;(async()=>{try{let d=e.pipeThrough(new TextDecoderStream).pipeThrough(new nm({onRetry:m=>{this._serverRetryMs=m}})).getReader();for(;;){let{value:m,done:h}=await d.read();if(h)break;if(m.id&&(a=m.id,s=!0,r?.(m.id)),!!m.data&&(!m.event||m.event==="message"))try{let g=op.parse(JSON.parse(m.data));Ei(g)&&(c=!0,i!==void 0&&(g.id=i)),this.onmessage?.(g)}catch(g){this.onerror?.(g)}}(o||s)&&!c&&this._abortController&&!this._abortController.signal.aborted&&this._scheduleReconnection({resumptionToken:a,onresumptiontoken:r,replayMessageId:i},0)}catch(d){if(this.onerror?.(new Error(`SSE stream disconnected: ${d}`)),(o||s)&&!c&&this._abortController&&!this._abortController.signal.aborted)try{this._scheduleReconnection({resumptionToken:a,onresumptiontoken:r,replayMessageId:i},0)}catch(m){this.onerror?.(new Error(`Failed to reconnect: ${m instanceof Error?m.message:String(m)}`))}}})()}async start(){if(this._abortController)throw new Error("StreamableHTTPClientTransport already started! If using Client class, note that connect() calls start() automatically.");this._abortController=new AbortController}async finishAuth(e){if(!this._authProvider)throw new or("No auth provider");if(await du(this._authProvider,{serverUrl:this._url,authorizationCode:e,resourceMetadataUrl:this._resourceMetadataUrl,scope:this._scope,fetchFn:this._fetchWithInit})!=="AUTHORIZED")throw new or("Failed to authorize")}async close(){this._reconnectionTimeout&&(clearTimeout(this._reconnectionTimeout),this._reconnectionTimeout=void 0),this._abortController?.abort(),this.onclose?.()}async send(e,t){try{let{resumptionToken:o,onresumptiontoken:r}=t||{};if(o){this._startOrAuthSse({resumptionToken:o,replayMessageId:gl(e)?e.id:void 0}).catch(f=>this.onerror?.(f));return}let i=await this._commonHeaders();i.set("content-type","application/json"),i.set("accept","application/json, text/event-stream");let a={...this._requestInit,method:"POST",headers:i,body:JSON.stringify(e),signal:this._abortController?.signal},s=await(this._fetch??fetch)(this._url,a),c=s.headers.get("mcp-session-id");if(c&&(this._sessionId=c),!s.ok){let f=await s.text().catch(()=>null);if(s.status===401&&this._authProvider){if(this._hasCompletedAuthFlow)throw new Zr(401,"Server returned 401 after successful authentication");let{resourceMetadataUrl:m,scope:h}=Ny(s);if(this._resourceMetadataUrl=m,this._scope=h,await du(this._authProvider,{serverUrl:this._url,resourceMetadataUrl:this._resourceMetadataUrl,scope:this._scope,fetchFn:this._fetchWithInit})!=="AUTHORIZED")throw new or;return this._hasCompletedAuthFlow=!0,this.send(e)}if(s.status===403&&this._authProvider){let{resourceMetadataUrl:m,scope:h,error:g}=Ny(s);if(g==="insufficient_scope"){let v=s.headers.get("WWW-Authenticate");if(this._lastUpscopingHeader===v)throw new Zr(403,"Server returned 403 after trying upscoping");if(h&&(this._scope=h),m&&(this._resourceMetadataUrl=m),this._lastUpscopingHeader=v??void 0,await du(this._authProvider,{serverUrl:this._url,resourceMetadataUrl:this._resourceMetadataUrl,scope:this._scope,fetchFn:this._fetch})!=="AUTHORIZED")throw new or;return this.send(e)}}throw new Zr(s.status,`Error POSTing to endpoint: ${f}`)}if(this._hasCompletedAuthFlow=!1,this._lastUpscopingHeader=void 0,s.status===202){await s.body?.cancel(),ZC(e)&&this._startOrAuthSse({resumptionToken:void 0}).catch(f=>this.onerror?.(f));return}let d=(Array.isArray(e)?e:[e]).filter(f=>"method"in f&&"id"in f&&f.id!==void 0).length>0,p=s.headers.get("content-type");if(d)if(p?.includes("text/event-stream"))this._handleSseStream(s.body,{onresumptiontoken:r},!1);else if(p?.includes("application/json")){let f=await s.json(),m=Array.isArray(f)?f.map(h=>op.parse(h)):[op.parse(f)];for(let h of m)this.onmessage?.(h)}else throw await s.body?.cancel(),new Zr(-1,`Unexpected content type: ${p}`);else await s.body?.cancel()}catch(o){throw this.onerror?.(o),o}}get sessionId(){return this._sessionId}async terminateSession(){if(this._sessionId)try{let e=await this._commonHeaders(),t={...this._requestInit,method:"DELETE",headers:e,signal:this._abortController?.signal},o=await(this._fetch??fetch)(this._url,t);if(await o.body?.cancel(),!o.ok&&o.status!==405)throw new Zr(o.status,`Failed to terminate session: ${o.statusText}`);this._sessionId=void 0}catch(e){throw this.onerror?.(e),e}}setProtocolVersion(e){this._protocolVersion=e}get protocolVersion(){return this._protocolVersion}async resumeStream(e,t){await this._startOrAuthSse({resumptionToken:e,onresumptiontoken:t?.onresumptiontoken})}};var Qi=D(require("vscode"));Ke();ot();ce();var Wi=class n{static clientCache=new Map;client=null;transport=null;userAgent;currentApiKey=null;isConnecting=!1;connectionPromise=null;constructor(){this.userAgent=Nt.getUserAgent("MCPWebSearch")}static async getInstance(e){let t=e||await R.getApiKey("zhipu");if(!t)throw new Error("ZhipuAI API key not set");let o=n.clientCache.get(t);return o?u.debug(`[MCP WebSearch] Reusing cached client instance (API key: ${t.substring(0,8)}...)`):(u.debug(`[MCP WebSearch] Creating new client instance (API key: ${t.substring(0,8)}...)`),o=new n,o.currentApiKey=t,n.clientCache.set(t,o)),await o.ensureConnected(),o}static async clearCache(e){if(e){let t=n.clientCache.get(e);t&&(await t.cleanup(),n.clientCache.delete(e),u.info(`[MCP WebSearch] Cleared cache for API key ${e.substring(0,8)}...`))}else{for(let[t,o]of n.clientCache.entries())await o.cleanup(),u.info(`[MCP WebSearch] Cleared cache for API key ${t.substring(0,8)}...`);n.clientCache.clear(),u.info("[MCP WebSearch] Cleared all client caches")}}static getCacheStats(){let e={totalClients:n.clientCache.size,connectedClients:0,apiKeys:[]};for(let[t,o]of n.clientCache.entries())o.isConnected()&&e.connectedClients++,e.apiKeys.push(`${t.substring(0,8)}...`);return e}async handleErrorResponse(e){let t=e.message;if(t.includes("403")||t.includes("You do not have access"))throw t.includes("search-prime")||t.includes("web_search_prime")?(u.warn(`[MCP WebSearch] Detected insufficient MCP permissions for web search: ${t}`),await this.showMCPDisableDialog()?(await this.disableMCPMode(),new Error("Insufficient ZhipuAI search permissions: MCP mode disabled, please try searching again.")):new Error("Insufficient ZhipuAI search permissions: Your account does not have access to web search MCP features. Please check your ZhipuAI subscription status.")):new Error("Insufficient ZhipuAI search permissions: 403 error. Please check your API key permissions or subscription status.");if(t.includes("MCP error")){let o=t.match(/MCP error (\d+): (.+)/);if(o){let[,r,i]=o;throw new Error(`ZhipuAI MCP protocol error ${r}: ${i}`)}}throw e}async showMCPDisableDialog(){return await Qi.window.showWarningMessage(`Detected that your ZhipuAI account does not have access to web search MCP features. This could be because:

1. Your account does not support MCP features (requires Coding Plan subscription)
2. Insufficient API key permissions

Switch to standard billing mode (pay-per-use)?`,{modal:!0},"Switch to Standard Mode","Keep MCP Mode")==="Switch to Standard Mode"}async disableMCPMode(){try{await Qi.workspace.getConfiguration("chp.zhipu.search").update("enableMCP",!1,Qi.ConfigurationTarget.Global),u.info("[MCP WebSearch] MCP mode disabled, switched to standard billing mode"),Qi.window.showInformationMessage("ZhipuAI search has switched to standard billing mode (pay-per-use). You can re-enable MCP mode in settings."),await this.internalCleanup()}catch(e){throw u.error("[MCP WebSearch] Failed to disable MCP mode",e instanceof Error?e:void 0),new Error(`Failed to disable MCP mode: ${e instanceof Error?e.message:"Unknown error"}`)}}async isEnabled(){return!!await R.getApiKey("zhipu")}isConnected(){return this.client!==null&&this.transport!==null}async ensureConnected(){if(this.isConnected()){u.debug("[MCP WebSearch] Client connected");return}return this.isConnecting&&this.connectionPromise?(u.debug("[MCP WebSearch] Waiting for connection to complete..."),this.connectionPromise):(this.isConnecting=!0,this.connectionPromise=this.initializeClient().finally(()=>{this.isConnecting=!1,this.connectionPromise=null}),this.connectionPromise)}async initializeClient(){if(this.client&&this.transport){u.debug("[MCP WebSearch] Client initialized");return}let e=this.currentApiKey||await R.getApiKey("zhipu");if(!e)throw new Error("ZhipuAI API key not set");this.currentApiKey=e,u.info("[MCP WebSearch] Initializing MCP client...");try{let t="https://open.bigmodel.cn/api/mcp/web_search_prime/mcp";L.getZhipuEndpoint()==="api.z.ai"&&(t=t.replace("open.bigmodel.cn","api.z.ai")),this.client=new Yp({name:"CHP-WebSearch-Client",version:Nt.getVersion()},{capabilities:{}}),this.transport=new om(new URL(t),{requestInit:{headers:{Authorization:`Bearer ${e}`,"User-Agent":this.userAgent}}}),await this.client.connect(this.transport),u.info("[MCP WebSearch] Connected successfully using StreamableHTTP transport (authenticated via Authorization header)")}catch(t){throw u.error("[MCP WebSearch] Client initialization failed",t instanceof Error?t:void 0),await this.internalCleanup(),new Error(`MCP client connection failed: ${t instanceof Error?t.message:"Unknown error"}`)}}async search(e){if(u.info(`[MCP WebSearch] Starting search: "${e.search_query}"`),await this.ensureConnected(),!this.client)throw new Error("MCP client not initialized");try{let t=await this.client.listTools();if(u.debug(`[MCP WebSearch] Available tools: ${t.tools.map(i=>i.name).join(", ")}`),!t.tools.find(i=>i.name==="webSearchPrime"))throw new Error("webSearchPrime tool not found");let r=await this.client.callTool({name:"webSearchPrime",arguments:{search_query:e.search_query,search_engine:e.search_engine||"search_std",search_intent:e.search_intent||!1,count:e.count||10,search_domain_filter:e.search_domain_filter,search_recency_filter:e.search_recency_filter||"noLimit",content_size:e.content_size||"medium"}});if(Array.isArray(r.content)){let[{text:i}]=r.content;if(i.startsWith("MCP error"))throw new Error(i);let a=JSON.parse(JSON.parse(i));return u.debug(`[MCP WebSearch] Tool invocation successful: ${a?.length||0} results`),a}return u.debug("[MCP WebSearch] Tool invocation finished: no results"),[]}catch(t){throw u.error("[MCP WebSearch] Search failed",t instanceof Error?t:void 0),t instanceof Error&&await this.handleErrorResponse(t),t instanceof Error&&(t.message.includes("connection")||t.message.includes("connect"))&&(u.warn("[MCP WebSearch] Connection error detected, will auto-reconnect on next search"),await this.internalCleanup()),new Error(`Search failed: ${t instanceof Error?t.message:"Unknown error"}`)}}getStatus(){return{name:"CHP-MCP-WebSearch-Client",version:Nt.getVersion(),enabled:!0,connected:this.isConnected()}}async internalCleanup(){u.debug("[MCP WebSearch] Cleaning up client connection...");try{this.transport&&(await this.transport.close(),this.transport=null),this.client=null,u.debug("[MCP WebSearch] Client connection cleaned up")}catch(e){u.error("[MCP WebSearch] Connection cleanup failed",e instanceof Error?e:void 0)}}async cleanup(){u.info("[MCP WebSearch] Cleaning up client resources...");try{await this.internalCleanup(),this.currentApiKey&&(n.clientCache.delete(this.currentApiKey),u.info(`[MCP WebSearch] Removed client from cache (API key: ${this.currentApiKey.substring(0,8)}...)`)),u.info("[MCP WebSearch] Client resources cleaned up")}catch(e){u.error("[MCP WebSearch] Resource cleanup failed",e instanceof Error?e:void 0)}}async reconnect(){u.info("[MCP WebSearch] Reconnecting client..."),await this.internalCleanup(),await this.ensureConnected()}};var aP=D(require("node:crypto")),pu=D(require("vscode"));ao();ce();var Gs=class n{context;cacheVersion="1";cacheExpiryMs=1440*60*1e3;static SELECTED_MODEL_KEY="chp_selected_model";constructor(e){this.context=e}async getCachedModels(e,t){try{if(this.context.extensionMode===pu.ExtensionMode.Development)return u.trace(`[ModelInfoCache] ${e}: Skipping cache in development mode`),null;let r=this.getCacheKey(e),i=this.context.globalState.get(r);if(!i)return u.trace(`[ModelInfoCache] ${e}: No cache`),null;let a=pu.extensions.getExtension("vicanent.copilot-helper-pro")?.packageJSON.version||"";if(i.extensionVersion!==a)return u.trace(`[ModelInfoCache] ${e}: Version mismatch (cached: ${i.extensionVersion}, current: ${a})`),null;if(i.apiKeyHash!==t)return u.trace(`[ModelInfoCache] ${e}: API key changed`),null;let c=Date.now()-i.timestamp;if(c>this.cacheExpiryMs){let l=(c/36e5).toFixed(1);return u.trace(`[ModelInfoCache] ${e}: Cache expired (${l} hours ago)`),null}return u.trace(`[ModelInfoCache] ${e}: Cache hit (${i.models.length} models, age ${(c/1e3).toFixed(1)}s)`),i.models}catch(o){return u.warn(`[ModelInfoCache] Failed to read ${e} cache:`,o instanceof Error?o.message:String(o)),null}}async cacheModels(e,t,o){try{let r=pu.extensions.getExtension("vicanent.copilot-helper-pro")?.packageJSON.version||"",i={models:t,extensionVersion:r,timestamp:Date.now(),apiKeyHash:o},a=this.getCacheKey(e);await this.context.globalState.update(a,i)}catch(r){u.warn(`[ModelInfoCache] Failed to cache ${e}:`,r instanceof Error?r.message:String(r))}}async invalidateCache(e){try{let t=this.getCacheKey(e);await this.context.globalState.update(t,void 0),u.trace(`[ModelInfoCache] ${e}: Cache cleared`)}catch(t){u.warn(`[ModelInfoCache] Failed to clear ${e} cache:`,t instanceof Error?t.message:String(t))}}async clearAll(){let e=[...Object.keys(vt),"compatible"],t=0;for(let o of e)try{await this.invalidateCache(o),t++}catch(r){u.warn(`[ModelInfoCache] Error clearing ${o} cache:`,r instanceof Error?r.message:String(r))}u.info(`[ModelInfoCache] All caches cleared (${t}/${e.length})`)}static async computeApiKeyHash(e){try{return aP.default.createHash("sha256").update(e).digest("hex").substring(0,16)}catch(t){return u.warn("Failed to compute API key hash:",t instanceof Error?t.message:String(t)),"hash-error"}}getCacheKey(e){return`chp_modelinfo_cache_${this.cacheVersion}_${e}`}async saveLastSelectedModel(e,t){try{let o={providerKey:e,modelId:t,timestamp:Date.now()};await this.context.globalState.update(n.SELECTED_MODEL_KEY,o)}catch(o){u.warn("[ModelInfoCache] Failed to save model selection:",o instanceof Error?o.message:String(o))}}getLastSelectedModel(e){try{let t=this.context.globalState.get(n.SELECTED_MODEL_KEY);return t&&t.providerKey===e?(u.trace(`[ModelInfoCache] ${e}: Read default model (${t.modelId})`),t.modelId):(t&&u.trace(`[ModelInfoCache] ${e}: Skipping default selection for other provider (saved: ${t.providerKey}/${t.modelId})`),null)}catch(t){return u.warn("[ModelInfoCache] Failed to read model selection:",t instanceof Error?t.message:String(t)),null}}};ce();ce();var Pq={maxAttempts:3,initialDelayMs:1e3,maxDelayMs:3e4,backoffMultiplier:2,jitterEnabled:!0},Vs=class{config;constructor(e){this.config={...Pq,...e}}async executeWithRetry(e,t,o){let r,i=0,a=this.config.initialDelayMs;u.trace(`[${o}] Starting initial request`);try{return await e()}catch(s){if(r=s,!t(r))throw u.warn(`[${o}] Initial request failed (non-retryable): ${r.message}`),r;u.warn(`[${o}] Initial request failed, initiating retry mechanism: ${r.message}`)}for(;i<this.config.maxAttempts;){i++;let s=this.config.jitterEnabled?Math.random()*.1:0,c=Math.min(a*(1+s),this.config.maxDelayMs);u.info(`[${o}] Retrying in ${c/1e3} seconds...`),await this.delay(c),u.info(`[${o}] Retry attempt #${i}/${this.config.maxAttempts}`);try{let l=await e();return u.info(`[${o}] Retry successful after ${i} attempt(s)`),l}catch(l){if(r=l,!t(r)){u.warn(`[${o}] Retry attempt #${i} failed (non-retryable): ${r.message}`);break}u.warn(`[${o}] Retry attempt #${i} failed, preparing next retry: ${r.message}`),a*=this.config.backoffMultiplier}}throw r?(u.error(`[${o}] All retry attempts exhausted: ${r.message}`),r):new Error(`[${o}] Unknown error occurred`)}static isRateLimitError(e){return!!(e instanceof Error&&(e.message.includes("429")||"status"in e&&e.status===429||"statusCode"in e&&e.statusCode===429))}delay(e){return new Promise(t=>setTimeout(t,e))}};var sP=D(require("vscode")),Qs=class n{static outputChannel;static initialize(e="CHP-Status"){n.outputChannel=sP.window.createOutputChannel(e,{log:!0})}static trace(e,...t){n.outputChannel&&n.outputChannel.trace(e,...t)}static debug(e,...t){n.outputChannel&&n.outputChannel.debug(e,...t)}static info(e,...t){n.outputChannel&&n.outputChannel.info(e,...t)}static warn(e,...t){n.outputChannel&&n.outputChannel.warn(e,...t)}static error(e,...t){n.outputChannel&&n.outputChannel.error(e,...t)}static dispose(){n.outputChannel&&n.outputChannel.dispose()}};var Ao=D(require("vscode"));var Te=class n{openaiHandler;anthropicHandler;providerKey;context;baseProviderConfig;cachedProviderConfig;configListener;modelInfoCache;accountManager;lastUsedAccountByModel=new Map;_chatEndpoints;_onDidChangeLanguageModelChatInformation=new Ao.EventEmitter;onDidChangeLanguageModelChatInformation=this._onDidChangeLanguageModelChatInformation.event;constructor(e,t,o){this.context=e,this.providerKey=t,this.accountManager=Ne.getInstance(),this.baseProviderConfig=o,this.cachedProviderConfig=L.applyProviderOverrides(this.providerKey,this.baseProviderConfig),this.modelInfoCache=new Gs(e),this.configListener=Ao.workspace.onDidChangeConfiguration(r=>{t!=="compatible"&&(r.affectsConfiguration("chp.providerOverrides")||r.affectsConfiguration(`chp.${t}.baseUrl`))&&(this.cachedProviderConfig=L.applyProviderOverrides(this.providerKey,this.baseProviderConfig),this.refreshHandlers(),this.modelInfoCache?.invalidateCache(this.providerKey).catch(i=>u.warn(`[${this.providerKey}] Failed to clear cache:`,i)),u.trace(`${this.providerKey} configuration updated`),this._onDidChangeLanguageModelChatInformation.fire()),r.affectsConfiguration("chp.editToolMode")&&(u.trace(`${this.providerKey} detected editToolMode change`),this.modelInfoCache?.invalidateCache(this.providerKey).catch(i=>u.warn(`[${this.providerKey}] Failed to clear cache:`,i)),this._onDidChangeLanguageModelChatInformation.fire())}),this.accountManager.onAccountChange(r=>{(r.provider===this.providerKey||r.provider==="all")&&(u.trace(`[${this.providerKey}] Account change detected: ${r.type}`),this.modelInfoCache?.invalidateCache(this.providerKey).catch(i=>u.warn(`[${this.providerKey}] Failed to clear cache:`,i)),this._onDidChangeLanguageModelChatInformation.fire())}),this.refreshHandlers()}refreshHandlers(){this.openaiHandler?.dispose(),this.openaiHandler=new Ai(this.providerKey,this.baseProviderConfig.displayName,this.cachedProviderConfig.baseUrl),this.anthropicHandler=new el(this.providerKey,this.baseProviderConfig.displayName,this.cachedProviderConfig.baseUrl)}dedupeModelInfos(e){let t=new Set,o=[];for(let r of e){if(t.has(r.id)){u.warn(`[${this.providerKey}] Duplicate model id detected, skipping: ${r.id}`);continue}t.add(r.id),o.push(r)}return o}dispose(){this.configListener?.dispose(),this._onDidChangeLanguageModelChatInformation.dispose(),this.openaiHandler?.dispose(),u.info(`${this.providerConfig.displayName}: Extension destroyed`)}get providerConfig(){return this.cachedProviderConfig}static createAndActivate(e,t,o){u.trace(`${o.displayName} model extension activated!`);let r=new n(e,t,o),i=Ao.lm.registerLanguageModelChatProvider(`chp.${t}`,r),a=Ao.commands.registerCommand(`chp.${t}.setApiKey`,async()=>{t==="moonshot"?await rl.startWizard(o.displayName,o.apiKeyTemplate):await De.startWizard({providerKey:t,displayName:o.displayName,apiKeyTemplate:o.apiKeyTemplate,supportsApiKey:!0,supportsBaseUrl:!0}),await r.modelInfoCache?.invalidateCache(t),r._onDidChangeLanguageModelChatInformation.fire()}),s=[i,a];for(let c of s)e.subscriptions.push(c);return{provider:r,disposables:s}}modelConfigToInfo(e){let t=Ao.workspace.getConfiguration("chp").get("editToolMode","claude"),o;return t&&t!=="none"?o=t.startsWith("claude")?"claude-sonnet-4.5":t:o=e.id,{id:e.id,name:e.name,detail:this.providerConfig.displayName,tooltip:e.tooltip||`${e.name} via ${this.providerConfig.displayName}`,family:o,maxInputTokens:e.maxInputTokens,maxOutputTokens:e.maxOutputTokens,version:e.id,capabilities:e.capabilities}}async provideLanguageModelChatInformation(e,t){try{let a=await this.getApiKeyHash(),s=await this.modelInfoCache?.getCachedModels(this.providerKey,a);if(s){if(u.trace(`[${this.providerKey}] Return model list from cache (${s.length} models)`),L.getRememberLastModel()){let l=this.modelInfoCache?.getLastSelectedModel(this.providerKey);l&&(s=s.map(d=>({...d,isDefault:d.id===l})))}return this.updateModelCacheAsync(a),this.dedupeModelInfos(s)}}catch(a){u.warn(`[${this.providerKey}] Cache query failed, falling back to original logic:`,a instanceof Error?a.message:String(a))}if(!await R.hasValidApiKey(this.providerKey)){if(e.silent)return[];if(await Ao.commands.executeCommand(`chp.${this.providerKey}.setApiKey`),!await R.hasValidApiKey(this.providerKey))return[]}let r=this.providerConfig.models.map(a=>this.modelConfigToInfo(a));if(L.getRememberLastModel()){let a=this.modelInfoCache?.getLastSelectedModel(this.providerKey);a&&(r=r.map(s=>({...s,isDefault:s.id===a})))}try{let a=await this.getApiKeyHash();this.updateModelCacheAsync(a)}catch(a){u.warn(`[${this.providerKey}] Cache saving failed:`,a)}return this.dedupeModelInfos(r)}updateModelCacheAsync(e){(async()=>{try{let t=this.providerConfig.models.map(o=>this.modelConfigToInfo(o));t=this.dedupeModelInfos(t),await this.modelInfoCache?.cacheModels(this.providerKey,t,e)}catch(t){u.trace(`[${this.providerKey}] Background cache update failed:`,t instanceof Error?t.message:String(t))}})()}async getApiKeyHash(){try{let e=await R.getApiKey(this.providerKey);return e?await Gs.computeApiKeyHash(e):"no-key"}catch(e){return u.warn(`[${this.providerKey}] Failed to compute API key hash:`,e instanceof Error?e.message:String(e)),"hash-error"}}async provideLanguageModelChatResponse(e,t,o,r,i){L.getRememberLastModel()&&this.modelInfoCache?.saveLastSelectedModel(this.providerKey,e.id).catch(l=>u.warn(`[${this.providerKey}] Failed to save model selection:`,l));let s=this.providerConfig.models.find(l=>l.id===e.id);if(!s){let l=`Model not found: ${e.id}`;throw u.error(l),new Error(l)}let c=s.provider||this.providerKey;try{let l=this.accountManager.getAccountsByProvider(c),d=this.accountManager.getLoadBalanceEnabled(c),p=this.accountManager.getAccountIdForModel(c,e.id);if(l.length===0){await R.ensureApiKey(c,this.providerConfig.displayName);let y=s.sdkMode||"openai";u.info(`${this.providerConfig.displayName} Provider starts processing request (fallback mode): ${s.name}`),y==="anthropic"?await this.anthropicHandler.handleRequest(e,s,t,o,r,i):await this.openaiHandler.handleRequest(e,s,t,o,r,i);return}let f=l.filter(y=>y.status==="active").length>0?l.filter(y=>y.status==="active"):l,m=this.buildAccountCandidates(e.id,f,p,d,c),h=this.accountManager.getActiveAccount(c),g=d?m.filter(y=>!this.accountManager.isAccountQuotaLimited(y.id)):m,v;g.length>0?h&&g.some(y=>y.id===h.id)?v=[h,...g.filter(y=>y.id!==h.id)]:v=g:h&&m.some(y=>y.id===h.id)?v=[h,...m.filter(y=>y.id!==h.id)]:v=m,u.debug(`[${c}] Active account: ${h?.displayName||"none"}, accountsToTry: ${v.map(y=>y.displayName).join(", ")}`);let k,x=!1;for(let y of v){let w=await this.accountManager.getCredentials(y.id);if(!w){k=new Error(`Missing credentials for ${y.displayName}`);continue}let b={...s,apiKey:"apiKey"in w?w.apiKey:void 0,baseUrl:"endpoint"in w?w.endpoint:void 0,customHeader:"customHeaders"in w?w.customHeaders:void 0},C=o?.selectionsMetadata;!b.baseUrl&&C?.baseUrl&&(b.baseUrl=C.baseUrl),"accessToken"in w&&(b.accessToken=w.accessToken,b.apiKey=w.accessToken);try{let I=s.sdkMode||"openai";u.info(`${this.providerConfig.displayName}: ${e.name} using account "${y.displayName}" (ID: ${y.id})`),I==="anthropic"?await this.anthropicHandler.handleRequest(e,b,t,o,r,i):await this.openaiHandler.handleRequest(e,b,t,o,r,i,y.id),this.lastUsedAccountByModel.set(e.id,y.id),x&&(u.info(`[${c}] Saving account "${y.displayName}" as preferred for model ${e.id}`),await this.accountManager.setAccountForModel(c,e.id,y.id));return}catch(I){if(x=!0,this.isLongTermQuotaExhausted(I)){if(d){u.warn(`[${c}] Account ${y.displayName} quota exhausted, switching...`),k=I;continue}throw I}if(d&&this.isQuotaError(I)){u.warn(`[${c}] Account ${y.displayName} rate limited, switching...`),k=I;continue}throw I}}throw k||new Error(`No available accounts for ${c}`)}catch(l){let d=`Error: ${l instanceof Error?l.message:"Unknown error"}`;throw u.error(d),l}finally{u.info(`${this.providerConfig.displayName}: ${e.name} Request completed`)}}buildAccountCandidates(e,t,o,r,i){if(t.length===0)return[];let a=o?t.find(f=>f.id===o):void 0,c=this.accountManager.getActiveAccount(i)||t.find(f=>f.isDefault)||t[0];if(!r)return a?[a]:c?[c]:[];let l=[...t].sort((f,m)=>new Date(f.createdAt).getTime()-new Date(m.createdAt).getTime()),d=this.lastUsedAccountByModel.get(e),p=l;if(d){let f=l.findIndex(m=>m.id===d);f>=0&&(p=[...l.slice(f+1),...l.slice(0,f+1)])}return a?[a,...p.filter(f=>f.id!==a.id)]:c?[c,...p.filter(f=>f.id!==c.id)]:p}isQuotaError(e){if(!(e instanceof Error))return!1;let t=e.message;return t.startsWith("Quota exceeded")||t.startsWith("Rate limited")||t.includes("HTTP 429")||t.includes('"code": 429')||t.includes('"code":429')||t.includes("RESOURCE_EXHAUSTED")||t.includes("429")&&t.includes("Resource has been exhausted")}isLongTermQuotaExhausted(e){return e instanceof Error&&e.message.startsWith("Account quota exhausted")}async provideTokenCount(e,t,o){return he.getInstance().countTokens(e,t)}async countMessagesTokens(e,t,o,r){return he.getInstance().countMessagesTokens(e,t,o,r)}};Wr();var rm=class n extends Te{static PROVIDER_KEY="antigravity";cachedModels=[];antigravityHandler;accountManager;lastUsedAccountByModel=new Map;constructor(e){let t={displayName:"Antigravity",baseUrl:"https://cloudcode-pa.googleapis.com/v1internal",apiKeyTemplate:"",models:[]};super(e,n.PROVIDER_KEY,t),this.antigravityHandler=new nl(t.displayName),this.accountManager=Ne.getInstance()}static createAndActivate(e){u.trace("Antigravity Provider activated!");let t=new n(e),o=Ji.lm.registerLanguageModelChatProvider("chp.antigravity",t),r=Ji.commands.registerCommand("chp.antigravity.login",async()=>{await uc(),await t.modelInfoCache?.invalidateCache(n.PROVIDER_KEY),t._onDidChangeLanguageModelChatInformation.fire()}),i=Ji.commands.registerCommand("chp.antigravity.logout",async()=>{await et.logout(),await t.modelInfoCache?.invalidateCache(n.PROVIDER_KEY),t._onDidChangeLanguageModelChatInformation.fire()}),a=[o,r,i];for(let s of a)e.subscriptions.push(s);return{provider:t,disposables:a}}getProviderConfig(){return{displayName:"Antigravity",baseUrl:"https://cloudcode-pa.googleapis.com/v1internal",apiKeyTemplate:"",models:this.cachedModels}}async provideLanguageModelChatInformation(e,t){try{if(!await et.isLoggedIn())return e.silent||await Ji.window.showInformationMessage("Antigravity requires login. Would you like to login now?","Login","Cancel")==="Login"&&await uc(),[];let r=await et.getCachedModels();if(r.length===0&&(r=await et.getModels()),r.length===0)return u.warn("No Antigravity models available"),[];let a=L.getProviderOverrides()[n.PROVIDER_KEY],s=a?.models||[],c=a?.baseUrl;this.cachedModels=r.map(f=>{let m=s.find(g=>g.id===f.id),h={id:f.id,name:f.displayName||f.name,tooltip:`${f.displayName} - Antigravity`,maxInputTokens:f.maxTokens||2e5,maxOutputTokens:m?.maxOutputTokens||f.maxOutputTokens||8192,sdkMode:"openai",capabilities:{toolCalling:!0,imageInput:!0}};return c&&(h.baseUrl=c),m?.extraBody&&(h.extraBody=m.extraBody,u.debug(`[Antigravity] Applied extraBody override to model ${f.id}`)),m?.outputThinking!==void 0&&(h.outputThinking=m.outputThinking),h});let l=L.getRememberLastModel(),d;l&&(d=this.modelInfoCache?.getLastSelectedModel(n.PROVIDER_KEY)??void 0);let p=this.cachedModels.map(f=>({id:f.id,name:f.name,vendor:"chp.antigravity",family:"antigravity",version:"1.0",maxInputTokens:f.maxInputTokens,maxOutputTokens:f.maxOutputTokens,isDefault:l&&f.id===d,capabilities:{toolCalling:f.capabilities?.toolCalling??!0,imageInput:f.capabilities?.imageInput??!0},tooltip:f.tooltip||f.name,detail:"Antigravity"}));return u.debug(`Antigravity Provider provides ${p.length} models`),p}catch(o){return u.error("Failed to get Antigravity models:",o),[]}}async provideLanguageModelChatResponse(e,t,o,r,i){L.getRememberLastModel()&&this.modelInfoCache?.saveLastSelectedModel(n.PROVIDER_KEY,e.id).catch(c=>u.warn("[antigravity] Failed to save model selection:",c));let s=this.cachedModels.find(c=>c.id===e.id);if(!s)throw new Error(`Model not found: ${e.id}`);try{let c={...s,model:e.id},l=this.accountManager.getAccountsByProvider(n.PROVIDER_KEY),d=this.accountManager.getLoadBalanceEnabled(n.PROVIDER_KEY),p=this.accountManager.getAccountIdForModel(n.PROVIDER_KEY,e.id);if(l.length===0){let y=await et.getAccessToken();if(!y)throw new Error("Not logged in to Antigravity. Please login first.");u.info(`Antigravity Provider processing request: ${e.name} (default account)`),await this.antigravityHandler.handleRequest(e,c,t,o,r,i,y,void 0,d);return}let f=l.filter(y=>y.status==="active").length>0?l.filter(y=>y.status==="active"):l,m=this.buildAccountCandidates(e.id,f,p,d),h=this.accountManager.getActiveAccount(n.PROVIDER_KEY),g=d?m.filter(y=>!this.accountManager.isAccountQuotaLimited(y.id)&&!this.antigravityHandler.isInCooldown(e.id,y.id)):m,v;g.length>0?h&&g.some(y=>y.id===h.id)?v=[h,...g.filter(y=>y.id!==h.id)]:v=g:h&&m.some(y=>y.id===h.id)?v=[h,...m.filter(y=>y.id!==h.id)]:v=m,u.debug(`[antigravity] Active account: ${h?.displayName||"none"}, accountsToTry: ${v.map(y=>y.displayName).join(", ")}`);let k,x=!1;for(let y of v){let w=await this.getAccessTokenForAccount(y);if(!w){k=new Error(`Missing Antigravity credentials for ${y.displayName}`);continue}try{u.info(`Antigravity Provider: ${e.name} using account "${y.displayName}" (ID: ${y.id})`),await this.antigravityHandler.handleRequest(e,c,t,o,r,i,w,y.id,d),this.lastUsedAccountByModel.set(e.id,y.id),x&&(u.info(`[antigravity] Saving account "${y.displayName}" as preferred for model ${e.id}`),await this.accountManager.setAccountForModel(n.PROVIDER_KEY,e.id,y.id));return}catch(b){if(x=!0,this.isLongTermQuotaExhausted(b)){if(d){u.warn(`[antigravity] Account ${y.displayName} quota exhausted, switching...`),k=b;continue}throw b}if(d&&this.isQuotaError(b)){u.warn(`[antigravity] Account ${y.displayName} rate limited, switching...`),k=b;continue}throw b}}throw k||new Error("No available Antigravity accounts for this request.")}catch(c){throw u.error("Antigravity request failed:",c),c}finally{u.info(`Antigravity Provider: ${e.name} request completed`)}}buildAccountCandidates(e,t,o,r){if(t.length===0)return[];let i=o?t.find(p=>p.id===o):void 0,s=this.accountManager.getActiveAccount(n.PROVIDER_KEY)||t.find(p=>p.isDefault)||t[0];if(!r)return i?[i]:s?[s]:[];let c=[...t].sort((p,f)=>new Date(p.createdAt).getTime()-new Date(f.createdAt).getTime()),l=this.lastUsedAccountByModel.get(e),d=c;if(l){let p=c.findIndex(f=>f.id===l);p>=0&&(d=[...c.slice(p+1),...c.slice(0,p+1)])}return i?[i,...d.filter(p=>p.id!==i.id)]:s?[s,...d.filter(p=>p.id!==s.id)]:d}async getAccessTokenForAccount(e){let t=await this.accountManager.getCredentials(e.id);if(!t||!("accessToken"in t))return null;let o=t.expiresAt?new Date(t.expiresAt).getTime():0;if(o&&o-Date.now()>300*1e3||!("refreshToken"in t)||!t.refreshToken)return t.accessToken;let r=await et.refreshToken(t.refreshToken,{persist:e.isDefault===!0});return r?(await this.accountManager.updateCredentials(e.id,{...t,accessToken:r.accessToken,expiresAt:r.expiresAt}),r.accessToken):null}isQuotaError(e){if(!(e instanceof Error))return!1;let t=e.message;return t.startsWith("Quota exceeded")||t.startsWith("Rate limited")||t.includes("HTTP 429")||t.includes('"code": 429')||t.includes('"code":429')||t.includes("RESOURCE_EXHAUSTED")||t.includes("429")&&t.includes("Resource has been exhausted")}isLongTermQuotaExhausted(e){return e instanceof Error&&e.message.startsWith("Account quota exhausted")}};var Ws=D(require("node:fs")),mP=D(require("node:path"));var St=D(require("vscode"));Ke();ot();ce();var Gr=D(require("vscode"));ce();function Mq(n){if(!n)return!1;let e=n.toLowerCase();return["id","limit","count","index","size","offset","length","results_limit","maxresults","debugsessionid","cellid"].some(o=>e.includes(o))||e.endsWith("_id")}function cP(n){if(typeof n!="string"||!n)return"tool";let e=n.replace(/[^a-zA-Z0-9_-]/g,"_");return/^[a-zA-Z]/.test(e)||(e=`tool_${e}`),e=e.replace(/_+/g,"_"),e.slice(0,64)}function Sq(n){if(!n||typeof n!="object"||Array.isArray(n))return{};let e=new Set(["type","properties","required","additionalProperties","description","enum","default","items","minLength","maxLength","minimum","maximum","pattern","format"]),t={};for(let[o,r]of Object.entries(n))e.has(o)&&(t[o]=r);return t}function im(n,e){if(!n||typeof n!="object"||Array.isArray(n))return{type:"object",properties:{}};let t=n;for(let r of["anyOf","oneOf","allOf"]){let i=t[r];if(Array.isArray(i)&&i.length>0){let a;for(let s of i)if(s&&typeof s=="object"&&s.type==="string"){a=s;break}t={...a??i[0]};break}}t=Sq(t);let o=t.type;if(o==null&&(o="object",t.type=o),o==="number"&&e&&Mq(e)&&(t.type="integer",o="integer"),o==="object"){let r=t.properties??{},i={};if(r&&typeof r=="object")for(let[c,l]of Object.entries(r))i[c]=im(l,c);t.properties=i;let a=t.required;Array.isArray(a)?t.required=a.filter(c=>typeof c=="string"):a!==void 0&&(t.required=[]);let s=t.additionalProperties;s!==void 0&&typeof s!="boolean"&&delete t.additionalProperties}else if(o==="array"){let r=t.items;Array.isArray(r)&&r.length>0?t.items=im(r[0]):r&&typeof r=="object"?t.items=im(r):t.items={type:"string"}}return t}function mu(n){let e=n.tools??[];if(!e||e.length===0)return{};let t=e.filter(r=>!!r&&typeof r=="object").map(r=>{let i=cP(typeof r.name=="string"?r.name:String(r.name??"tool")),a=typeof r.description=="string"?r.description:"",s=im(r.inputSchema??{type:"object",properties:{}});return{type:"function",function:{name:i,description:a,parameters:s}}}),o="auto";if(n.toolMode===Gr.LanguageModelChatToolMode.Required){if(e.length!==1)throw u.error("[Hugging Face Model Provider] ToolMode.Required but multiple tools:",e.length),new Error("LanguageModelChatToolMode.Required is not supported with more than one tool");o={type:"function",function:{name:cP(e[0].name)}}}return{tools:t,tool_choice:o}}function $n(n){if(!n[n.length-1])throw u.error("[Hugging Face Model Provider] No messages in request"),new Error("Invalid request: no messages.");n.forEach((t,o)=>{if(t.role===Gr.LanguageModelChatMessageRole.Assistant){let r=new Set(t.content.filter(s=>s instanceof Gr.LanguageModelToolCallPart).map(s=>s.callId));if(r.size===0)return;let i=o+1,a="Invalid request: Tool call part must be followed by a User message with a LanguageModelToolResultPart with a matching callId.";for(;r.size>0;){let s=n[i++];if(!s||s.role!==Gr.LanguageModelChatMessageRole.User)throw u.error("[Hugging Face Model Provider] Validation failed: missing tool result for call IDs:",Array.from(r)),new Error(a);s.content.forEach(c=>{if(!am(c)){let d=Object.getPrototypeOf(c)?.constructor?.name??typeof c;throw u.error("[Hugging Face Model Provider] Validation failed: expected tool result part, got:",d),new Error(a)}let l=c.callId;r.delete(l)})}}})}function am(n){if(!n||typeof n!="object")return!1;let e=n,t=typeof e.callId=="string",o="content"in e;return t&&o}var sm="https://llm.chutes.ai/v1",qy=16e3,pP=131072,cm=class n extends Te{userAgent;extensionPath;configFilePath;clientCache=new Map;constructor(e,t,o,r,i){super(e,t,o),this.userAgent=r,this.extensionPath=i,this.configFilePath=mP.join(this.extensionPath,"src","providers","config","chutes.json")}refreshHandlers(){this.clientCache&&this.clientCache.size>0&&(u.debug(`[Chutes] Clearing ${this.clientCache.size} cached OpenAI clients due to config change`),this.clientCache.clear()),super.refreshHandlers()}estimateMessagesTokens(e){let t=0;for(let o of e)for(let r of o.content)r instanceof St.LanguageModelTextPart&&(t+=Math.ceil(r.value.length/4));return t}estimateToolTokens(e){if(!e||e.length===0)return 0;try{let t=JSON.stringify(e);return Math.ceil(t.length/4)}catch{return 0}}async prepareLanguageModelChatInformation(e,t){let o=await this.ensureApiKey(e.silent??!0);if(!o)return[];let{models:r}=await this.fetchModels(o);this.updateConfigFileAsync(r);let i=r.map(s=>{let c=s.input_modalities??[],l=Array.isArray(c)&&c.includes("image"),d=s.supported_features?.includes("tools")??!1,p=s.context_length??s.max_model_len??pP,f=s.max_output_length??qy;f>=p&&(f=Math.min(p/2,qy)),f=Math.floor(Math.max(1,Math.min(f,p-1024)));let m=Math.max(1,p-f);return{id:s.id,name:s.id,tooltip:`${s.id} by Chutes`,family:"chutes",version:"1.0.0",maxInputTokens:m,maxOutputTokens:f,capabilities:{toolCalling:d,imageInput:l}}});return this._chatEndpoints=i.map(s=>({model:s.id,modelMaxPromptTokens:s.maxInputTokens+s.maxOutputTokens})),this.dedupeModelInfos(i)}async provideLanguageModelChatInformation(e,t){return this.prepareLanguageModelChatInformation({silent:e.silent??!1},t)}async fetchModels(e){let t=(async()=>{let o=this.providerConfig.baseUrl||sm,r=await fetch(`${o}/models`,{method:"GET",headers:{Authorization:`Bearer ${e}`,"User-Agent":this.userAgent}});if(!r.ok){let a="";try{a=await r.text()}catch(c){u.error("[Chutes Model Provider] Failed to read response text",c)}let s=new Error(`Failed to fetch Chutes models: ${r.status} ${r.statusText}${a?`
${a}`:""}`);throw u.error("[Chutes Model Provider] Failed to fetch Chutes models",s),s}return(await r.json()).data??[]})();try{return{models:await t}}catch(o){throw u.error("[Chutes Model Provider] Failed to fetch Chutes models",o),o}}updateConfigFileAsync(e){(async()=>{try{if(!Ws.existsSync(this.configFilePath)){u.debug(`[Chutes] Config file not found at ${this.configFilePath}, skipping auto-update`);return}let t=e.map(i=>{let a=i.input_modalities??[],s=Array.isArray(a)&&a.includes("image"),c=i.supported_features?.includes("tools")??!1,l=i.context_length??i.max_model_len??pP,d=i.max_output_length??qy,p=Math.max(1,l-d);return{id:i.id.replace(/[/]/g,"-").replace(/[^a-zA-Z0-9-]/g,"-").toLowerCase(),name:i.id,tooltip:`${i.id} by Chutes`,maxInputTokens:p,maxOutputTokens:d,model:i.id,capabilities:{toolCalling:c,imageInput:s}}}),o;try{let i=Ws.readFileSync(this.configFilePath,"utf8");o=JSON.parse(i)}catch(i){u.warn("[Chutes] Failed to read existing config, using defaults:",i instanceof Error?i.message:String(i)),o={displayName:"Chutes",baseUrl:sm,apiKeyTemplate:"cpk_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx",models:[]}}let r={displayName:o.displayName||"Chutes",baseUrl:o.baseUrl||sm,apiKeyTemplate:o.apiKeyTemplate||"cpk_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx",models:t};Ws.writeFileSync(this.configFilePath,JSON.stringify(r,null,4),"utf8"),u.info(`[Chutes] Auto-updated config file with ${t.length} models`)}catch(t){u.warn("[Chutes] Background config update failed:",t instanceof Error?t.message:String(t))}})()}async provideLanguageModelChatResponse(e,t,o,r,i){await Ie.getInstance(this.providerKey,2,1e3).throttle(this.providerConfig.displayName);try{let a=await this.ensureApiKey(!0);if(!a)throw new Error("Chutes API key not found");if($n(t),o.tools&&o.tools.length>128)throw new Error("Cannot have more than 128 tools per request.");let s=this.estimateMessagesTokens(t),c=o.tools?this.estimateToolTokens(this.openaiHandler.convertToolsToOpenAI([...o.tools])):0,l=Math.max(1,e.maxInputTokens);if(s+c>l)throw u.error("[Chutes Model Provider] Message exceeds token limit",{total:s+c,tokenLimit:l}),new Error("Message exceeds token limit.");let d=await this.createOpenAIClient(a),p=this.providerConfig.models.find(b=>b.id===e.id),f=this.openaiHandler.convertMessagesToOpenAI(t,e.capabilities||void 0,p),m={model:e.id,messages:f,stream:!0,stream_options:{include_usage:!0},max_tokens:Math.min(o.modelOptions?.max_tokens||4096,e.maxOutputTokens),temperature:o.modelOptions?.temperature??L.getTemperature(),top_p:L.getTopP()};if(o.modelOptions){let b=o.modelOptions;(typeof b.stop=="string"||Array.isArray(b.stop))&&(m.stop=b.stop),typeof b.frequency_penalty=="number"&&(m.frequency_penalty=b.frequency_penalty),typeof b.presence_penalty=="number"&&(m.presence_penalty=b.presence_penalty)}o.tools&&o.tools.length>0&&e.capabilities?.toolCalling&&(m.tools=this.openaiHandler.convertToolsToOpenAI([...o.tools]),m.tool_choice="auto");let h=new AbortController;i.onCancellationRequested(()=>h.abort());let g=d.chat.completions.stream(m,{signal:h.signal}),v=null,k="",x=!1,y=!1,w=new Map;if(g.on("chunk",b=>{if(!i.isCancellationRequested&&b.choices&&b.choices.length>0)for(let C of b.choices){if(C.delta?.tool_calls)for(let M of C.delta.tool_calls)M.id&&M.index!==void 0&&w.set(M.index,M.id);let I=C.delta,$=I?.reasoning??I?.reasoning_content;if($&&typeof $=="string"){v||(v=`chutes_thinking_${Date.now()}_${Math.random().toString(36).slice(2,8)}`),k+=$;try{r.report(new St.LanguageModelThinkingPart(k,v)),k="",y=!0}catch(M){u.warn("[Chutes] Failed to report thinking",M instanceof Error?M.message:String(M))}}}}),g.on("content",b=>{if(!i.isCancellationRequested&&b&&typeof b=="string"&&b.trim().length>0){if(v){try{r.report(new St.LanguageModelThinkingPart("",v))}catch{}v=null}try{r.report(new St.LanguageModelTextPart(b)),x=!0}catch(C){u.warn("[Chutes] Failed to report content",C instanceof Error?C.message:String(C))}}}),g.on("tool_calls.function.arguments.done",b=>{if(i.isCancellationRequested)return;if(v){try{r.report(new St.LanguageModelThinkingPart("",v))}catch{}v=null}let C=w.get(b.index)||`tool_call_${b.index}_${Date.now()}`,I={};if(b.parsed_arguments){let $=b.parsed_arguments;I=typeof $=="object"&&$!==null?$:{}}else try{I=JSON.parse(b.arguments||"{}")}catch{I={value:b.arguments}}try{r.report(new St.LanguageModelToolCallPart(C,b.name,I)),x=!0}catch($){u.warn("[Chutes] Failed to report tool call",$ instanceof Error?$.message:String($))}}),await g.finalChatCompletion(),v)try{r.report(new St.LanguageModelThinkingPart("",v))}catch{}}catch(a){throw u.error("[Chutes Model Provider] Chat request failed",{modelId:e.id,messageCount:t.length,error:a instanceof Error?{name:a.name,message:a.message}:String(a)}),a}finally{this.incrementRequestCount()}}async createOpenAIClient(e){let t=this.providerConfig.baseUrl||sm,o=`chutes:${t}`,r=this.clientCache.get(o);if(r)return r.lastUsed=Date.now(),r.client;let i=new G({apiKey:e,baseURL:t,defaultHeaders:{"User-Agent":this.userAgent},maxRetries:2,timeout:6e4});return this.clientCache.set(o,{client:i,lastUsed:Date.now()}),i}async provideTokenCount(e,t,o){return he.getInstance().countTokens(e,t)}async ensureApiKey(e){let t=await R.getApiKey("chutes");return!t&&!e&&(await R.promptAndSetApiKey("chutes","Chutes","cpk_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"),t=await R.getApiKey("chutes")),t}incrementRequestCount(){let e=new Date().toDateString(),t=this.context?.globalState.get("chutes.requestCount")||0;this.context?.globalState.get("chutes.lastResetDate")!==e?(t=1,this.context?.globalState.update("chutes.lastResetDate",e)):t++,this.context?.globalState.update("chutes.requestCount",t),u.debug(`[Chutes] Global request count: ${t}/5000`)}static createAndActivate(e,t,o){u.trace(`${o.displayName} provider activated!`);let s=`better-copilot-chat/${St.extensions.getExtension("OEvortex.better-copilot-chat")?.packageJSON?.version??"unknown"} VSCode/${St.version}`,c=e.extensionPath,l=new n(e,t,o,s,c),d=St.lm.registerLanguageModelChatProvider(`chp.${t}`,l),p=St.commands.registerCommand(`chp.${t}.setApiKey`,async()=>{await De.startWizard({providerKey:t,displayName:o.displayName,apiKeyTemplate:o.apiKeyTemplate,supportsApiKey:!0,supportsBaseUrl:!0}),await l.modelInfoCache?.invalidateCache(t),l._onDidChangeLanguageModelChatInformation.fire(void 0)}),f=[d,p];for(let m of f)e.subscriptions.push(m);return{provider:l,disposables:f}}};var rt=D(require("vscode"));ao();var lm=class n extends Te{static PROVIDER_KEY="compatible";modelsChangeListener;retryManager;constructor(e){let t={displayName:"Compatible",baseUrl:"https://api.openai.com/v1",apiKeyTemplate:"sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx",models:[]};super(e,n.PROVIDER_KEY,t),this.retryManager=new Vs({maxAttempts:3,initialDelayMs:1e3,maxDelayMs:3e4,backoffMultiplier:2,jitterEnabled:!0}),this.getProviderConfig(),this.modelsChangeListener=wn.onDidChangeModels(()=>{u.debug("[compatible] Received model change event, refreshing configuration and cache"),this.getProviderConfig(),this.modelInfoCache?.invalidateCache(n.PROVIDER_KEY).catch(o=>u.warn("[compatible] Failed to clear cache:",o)),this._onDidChangeLanguageModelChatInformation.fire(),u.debug("[compatible] Triggered language model information change event")})}dispose(){this.modelsChangeListener?.dispose(),super.dispose()}getProviderConfig(){try{let t=wn.getModels().map(o=>{let r=o.customHeader;if(o.provider){let i=bn[o.provider];i?.customHeader&&(r={...o.customHeader||{},...i.customHeader});let a;if(o.sdkMode==="anthropic"&&i?.anthropic?a=i.anthropic:o.sdkMode!=="anthropic"&&i?.openai&&(a=i.openai.extraBody),a){let s=a.extraBody||{},c=o.extraBody||{};o.extraBody={...s,...c}}}return{id:o.id,name:o.name,provider:o.provider,tooltip:o.tooltip||`${o.name} (${o.sdkMode})`,maxInputTokens:o.maxInputTokens,maxOutputTokens:o.maxOutputTokens,sdkMode:o.sdkMode,capabilities:o.capabilities,...o.baseUrl&&{baseUrl:o.baseUrl},...o.model&&{model:o.model},...r&&{customHeader:r},...o.extraBody&&{extraBody:o.extraBody},...o.outputThinking!==void 0&&{outputThinking:o.outputThinking},...o.includeThinking!==void 0&&{includeThinking:o.includeThinking}}});u.debug(`Compatible Provider loaded ${t.length} user-configured models`),this.cachedProviderConfig={displayName:"Compatible",baseUrl:"https://api.openai.com/v1",apiKeyTemplate:"sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx",models:t}}catch(e){u.error("Failed to get Compatible Provider configuration:",e),this.cachedProviderConfig={displayName:"Compatible",baseUrl:"https://api.openai.com/v1",apiKeyTemplate:"sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx",models:[]}}return this.cachedProviderConfig}async provideLanguageModelChatInformation(e,t){try{let o=await this.getApiKeyHash(),r=await this.modelInfoCache?.getCachedModels(n.PROVIDER_KEY,o);if(r){if(u.trace(`Compatible Provider cache hit: ${r.length} models`),L.getRememberLastModel()){let d=this.modelInfoCache?.getLastSelectedModel(n.PROVIDER_KEY);d&&(r=r.map(p=>({...p,isDefault:p.id===d})))}return this.updateModelCacheAsync(o),r}let i=this.providerConfig;if(i.models.length===0)return e.silent||setImmediate(async()=>{try{await wn.configureModelOrUpdateAPIKey()}catch{u.debug("Automatically triggering new model addition failed or was cancelled by user")}}),[];let a=new Set;for(let l of i.models)l.provider&&a.add(l.provider);for(let l of a)if(!e.silent&&!await R.ensureApiKey(l,l,!1))return u.warn(`Compatible Provider: user has not set API key for provider "${l}"`),[];let s=i.models.map(l=>{let d=this.modelConfigToInfo(l),p=l.sdkMode==="anthropic"?"Anthropic":"OpenAI";if(l.provider){let f=bn[l.provider];if(f?.displayName)return{...d,detail:f.displayName};let m=vt[l.provider];if(m?.displayName)return{...d,detail:m.displayName}}return{...d,detail:`${p} Compatible`}});if(L.getRememberLastModel()){let l=this.modelInfoCache?.getLastSelectedModel(n.PROVIDER_KEY);l&&(s=s.map(d=>({...d,isDefault:d.id===l})))}return u.debug(`Compatible Provider provided ${s.length} model information`),this.updateModelCacheAsync(o),s}catch(o){return u.error("Failed to get Compatible Provider model information:",o),[]}}updateModelCacheAsync(e){(async()=>{try{let o=this.providerConfig.models.map(r=>{let i=this.modelConfigToInfo(r),a=r.sdkMode==="anthropic"?"Anthropic":"OpenAI";if(r.provider){let s=bn[r.provider];if(s?.displayName)return{...i,detail:s.displayName};let c=vt[r.provider];if(c?.displayName)return{...i,detail:c.displayName}}return{...i,detail:`${a} Compatible`}});await this.modelInfoCache?.cacheModels(n.PROVIDER_KEY,o,e)}catch(t){u.trace("[compatible] Background cache update failed:",t instanceof Error?t.message:String(t))}})()}async provideLanguageModelChatResponse(e,t,o,r,i){L.getRememberLastModel()&&this.modelInfoCache?.saveLastSelectedModel(n.PROVIDER_KEY,e.id).catch(s=>u.warn("[compatible] Failed to save model selection:",s));try{let s=this.providerConfig,c=s.models.find(f=>f.id===e.id);if(!c){let f=`Compatible Provider could not find model: ${e.id}`;throw u.error(f),new Error(f)}if(!await R.ensureApiKey(c.provider,s.displayName,!1))throw new Error(`API key for model ${c.name} has not been set yet`);let d=c.sdkMode||"openai",p="OpenAI SDK";d==="anthropic"?p="Anthropic SDK":d==="openai-sse"&&(p="OpenAI SSE"),u.info(`Compatible Provider starts processing request (${p}): ${c.name}`);try{await this.retryManager.executeWithRetry(async()=>{d==="anthropic"?await this.anthropicHandler.handleRequest(e,c,t,o,r,i):d==="openai-sse"?await this.handleRequestWithCustomSSE(e,c,t,o,r,i):await this.openaiHandler.handleRequest(e,c,t,o,r,i)},f=>Vs.isRateLimitError(f),this.providerConfig.displayName)}catch(f){let m=`Error: ${f instanceof Error?f.message:"Unknown error"}`;throw u.error(m),f}finally{u.info(`Compatible Provider: ${e.name} Request completed`)}}catch(s){throw u.error("Compatible Provider failed to process request:",s),s}}parseThinkingTags(e,t,o){let r=[],i=[],a=o+e,s=t,c="";for(;a.length>0;)if(s){let l=a.indexOf("</thinking>");if(l!==-1){let d=a.substring(0,l);d.length>0&&r.push(d),a=a.substring(l+11),s=!1}else{let d=this.findPartialTag(a,"</thinking>");if(d.found){let p=a.substring(0,d.index);p.length>0&&r.push(p),c=a.substring(d.index),a=""}else r.push(a),a=""}}else{let l=a.indexOf("<thinking>");if(l!==-1){let d=a.substring(0,l);d.length>0&&i.push(d),a=a.substring(l+10),s=!0}else{let d=this.findPartialTag(a,"<thinking>");if(d.found){let p=a.substring(0,d.index);p.length>0&&i.push(p),c=a.substring(d.index),a=""}else i.push(a),a=""}}return{thinkingParts:r,contentParts:i,isInsideThinkingTag:s,remainingTagBuffer:c}}findPartialTag(e,t){for(let o=1;o<t.length;o++){let r=e.substring(e.length-o),i=t.substring(0,o);if(r===i)return{found:!0,index:e.length-o}}return{found:!1,index:-1}}async handleRequestWithCustomSSE(e,t,o,r,i,a){let s=t.provider||this.providerKey,c=await R.getApiKey(s);if(!c)throw new Error(`Missing ${s} API key`);let d=`${t.baseUrl||"https://api.openai.com/v1"}/chat/completions`;u.info(`[${e.name}] Process ${o.length} messages using custom SSE processing`);let p={model:t.model||e.id,messages:this.openaiHandler.convertMessagesToOpenAI(o,e.capabilities||void 0,t),max_tokens:L.getMaxTokensForModel(e.maxOutputTokens),stream:!0,temperature:L.getTemperature(),top_p:L.getTopP()};if(r.tools&&r.tools.length>0&&e.capabilities?.toolCalling&&(p.tools=this.openaiHandler.convertToolsToOpenAI([...r.tools]),p.tool_choice="auto"),t.extraBody){let h=t.extraBody;Object.assign(p,h),u.trace(`${e.name} merged extraBody parameters: ${JSON.stringify(h)}`)}u.debug(`[${e.name}] Send API request`);let f=new AbortController,m=a.onCancellationRequested(()=>f.abort());try{let h=R.processCustomHeader(t?.customHeader,c),g=await fetch(d,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${c}`,...h},body:JSON.stringify(p),signal:f.signal});if(!g.ok){let Ve=await g.text();throw new Error(`API request failed: ${g.status} ${g.statusText} - ${Ve}`)}if(!g.body)throw new Error("Response body is empty");let v=g.body.getReader(),k=new TextDecoder,x="",y,w=!1,b=!1,C=0,I=new Map,$=null,M="",A=10,z=!1,F="",q="";try{for(;;){if(a.isCancellationRequested){u.warn(`[${e.name}] User cancelled request`);break}let{done:Ve,value:ue}=await v.read();if(Ve)break;x+=k.decode(ue,{stream:!0});let Rt=x.split(`
`);x=Rt.pop()||"";for(let Ot of Rt)if(!(!Ot.trim()||Ot.trim()==="")&&Ot.startsWith("data:")){let ut=Ot.substring(5).trim();if(ut==="[DONE]"){u.debug(`[${e.name}] Received end of stream marker`);continue}try{let Pe=JSON.parse(ut);C++;let Ht=!1;if(Pe.usage&&(!Pe.choices||Pe.choices.length===0))y=Pe.usage,u.debug(`[${e.name}] Received usage statistics: ${JSON.stringify(Pe.usage)}`);else for(let $e of Pe.choices||[]){let Ae=$e.delta;if(Ae?.reasoning_content&&typeof Ae.reasoning_content=="string")if(u.trace(`[${e.name}] Received thinking content: ${Ae.reasoning_content.length} characters, content="${Ae.reasoning_content}"`),$||($=`thinking_${Date.now()}_${Math.random().toString(36).slice(2,8)}`,u.trace(`[${e.name}] Create new chain of thought ID: ${$}`)),M+=Ae.reasoning_content,M.length>=A)try{i.report(new rt.LanguageModelThinkingPart(M,$)),M="",b=!0}catch(be){u.trace(`[${e.name}] Failed to report thinking content: ${String(be)}`)}else b=!0;if(Ae?.content&&typeof Ae.content=="string"){u.trace(`[${e.name}] Output text content: ${Ae.content.length} characters, preview=${Ae.content}`);let be=this.parseThinkingTags(Ae.content,z,F);z=be.isInsideThinkingTag,F=be.remainingTagBuffer;for(let gt of be.thinkingParts)if(gt.length>0)if($||($=`thinking_${Date.now()}_${Math.random().toString(36).slice(2,8)}`,u.trace(`[${e.name}] Create new chain of thought ID (from tag): ${$}`)),M+=gt,M.length>=A)try{i.report(new rt.LanguageModelThinkingPart(M,$)),M="",b=!0}catch(we){u.trace(`[${e.name}] Failed to report thinking content (from tag): ${String(we)}`)}else b=!0;for(let gt of be.contentParts)if(gt.length>0){if(M.length>0&&$)try{i.report(new rt.LanguageModelThinkingPart(M,$)),M="",b=!0}catch(we){u.trace(`[${e.name}] Failed to report remaining thinking content: ${String(we)}`)}if($&&!z){try{u.trace(`[${e.name}] End chain of thought before outputting content ID: ${$}`),i.report(new rt.LanguageModelThinkingPart("",$))}catch(we){u.trace(`[${e.name}] Failed to send thinking done(id=${$}) failure: ${String(we)}`)}$=null}i.report(new rt.LanguageModelTextPart(gt)),Ht=!0}}if(Ae?.tool_calls&&Array.isArray(Ae.tool_calls))for(let be of Ae.tool_calls){let gt=be.index??0;if(gt!==void 0&&!be.function?.arguments){if(M.length>0&&$)try{i.report(new rt.LanguageModelThinkingPart(M,$)),i.report(new rt.LanguageModelThinkingPart("",$)),M="",b=!0}catch(rn){u.trace(`[${e.name}] Failed to report remaining thinking content: ${String(rn)}`)}u.trace(`[${e.name}] Tool call start: ${be.function?.name||"unknown"} (index: ${gt})`)}let we=I.get(gt);if(we||(we={arguments:""},I.set(gt,we)),be.id&&(we.id=be.id),be.function?.name&&(we.name=be.function.name),be.function?.arguments){let rn=be.function.arguments;if(we.arguments.endsWith(rn))u.trace(`[${e.name}] Skip duplicate tool call parameters [${gt}]: "${rn}"`);else if(we.arguments.length>0&&rn.startsWith(we.arguments)){let ku=rn.substring(we.arguments.length);we.arguments+=ku,u.trace(`[${e.name}] Partial duplication detected, extract incremental part [${gt}]: "${ku}"`)}else we.arguments+=rn}u.trace(`[${e.name}] Accumulate tool call data [${gt}]: name=${we.name}, args_length=${we.arguments.length}`)}if($e.finish_reason){if(u.debug(`[${e.name}] Stream ended, reason: ${$e.finish_reason}`),M.length>0&&$)try{i.report(new rt.LanguageModelThinkingPart(M,$)),M="",b=!0}catch(be){u.trace(`[${e.name}] Failed to report remaining thinking content: ${String(be)}`)}if($&&$e.finish_reason!=="length"){try{u.trace(`[${e.name}] End chain of thought before stream ends ID: ${$}`),i.report(new rt.LanguageModelThinkingPart("",$))}catch(be){u.warn(`[${e.name}] Failed to end chain of thought: ${String(be)}`)}$=null}if($e.finish_reason==="tool_calls"){let be=!1;for(let[gt,we]of I.entries())if(we.name&&we.arguments)try{let rn=JSON.parse(we.arguments),ku=we.id||`tool_${Date.now()}_${gt}`;i.report(new rt.LanguageModelToolCallPart(ku,we.name,rn)),u.info(`[${e.name}] Successfully processed tool call: ${we.name}, args: ${we.arguments}`),be=!0}catch(rn){u.error(`[${e.name}] Unable to parse tool call parameters: ${we.name}, args: ${we.arguments}, error: ${rn}`)}else u.warn(`[${e.name}] Incomplete tool call [${gt}]: name=${we.name}, args_length=${we.arguments.length}`);be&&(Ht=!0,u.trace(`[${e.name}] Tool call processed, marked as content received`))}else $e.finish_reason==="stop"&&(Ht||u.trace(`[${e.name}] finish_reason=stop, no text content received`))}}Ht&&(w=!0)}catch(Pe){u.error(`[${e.name}] Failed to parse JSON: ${ut}`,Pe)}}}}finally{v.releaseLock()}u.trace(`[${e.name}] SSE stream processing statistics: ${C} chunks, hasReceivedContent=${w}`),u.debug(`[${e.name}] Stream processing complete`);let oe=y?.prompt_tokens,fe=y?.completion_tokens,ie=y?.total_tokens,K=!1;if(oe===void 0)try{oe=await he.getInstance().countMessagesTokens(e,[...o],{sdkMode:t.sdkMode||"openai"},r),fe=0,ie=oe,K=!0}catch(Ve){u.trace(`[${e.name}] Failed to estimate prompt tokens in custom SSE mode: ${String(Ve)}`)}oe!==void 0&&fe!==void 0&&Gt.getInstance().recordSuccess({modelId:e.id,modelName:e.name,providerId:this.providerKey,promptTokens:oe,completionTokens:fe,totalTokens:ie,maxInputTokens:e.maxInputTokens,maxOutputTokens:e.maxOutputTokens,estimatedPromptTokens:K}),b&&!w&&(i.report(new rt.LanguageModelTextPart("<think/>")),u.warn(`[${e.name}] End of message stream has only thinking content and no text content, added <think/> placeholder as output`)),u.debug(`[${e.name}] API request complete`)}catch(h){throw h instanceof Error&&h.name==="AbortError"?(u.warn(`[${e.name}] User cancelled request`),new rt.CancellationError):h}finally{m.dispose()}}static registerCommands(e){let t=[];t.push(rt.commands.registerCommand("chp.compatible.manageModels",async()=>{try{await wn.configureModelOrUpdateAPIKey()}catch(o){u.error("Failed to manage Compatible models:",o),rt.window.showErrorMessage(`Failed to manage models: ${o instanceof Error?o.message:"Unknown error"}`)}}));for(let o of t)e.subscriptions.push(o);return u.debug("Compatible Provider commands registered"),t}static createAndActivate(e){u.trace("Compatible Provider activated!");let t=new n(e),o=rt.lm.registerLanguageModelChatProvider("chp.compatible",t),r=n.registerCommands(e),i=[o,...r];for(let a of i)e.subscriptions.push(a);return{provider:t,disposables:i}}};var $t=D(require("vscode"));var um=class n extends Te{userAgent;clientCache=new Map;constructor(e,t,o,r){super(e,t,o),this.userAgent=r}refreshHandlers(){this.clientCache&&this.clientCache.size>0&&(u.debug(`[DeepInfra] Clearing ${this.clientCache.size} cached OpenAI clients due to config change`),this.clientCache.clear()),super.refreshHandlers()}async ensureApiKey(e){let t=await R.getApiKey(this.providerKey);return!t&&!e&&(await R.promptAndSetApiKey(this.providerKey,this.providerConfig.displayName,this.providerConfig.apiKeyTemplate),t=await R.getApiKey(this.providerKey)),t}async fetchModels(e){try{let o=`${this.providerConfig.baseUrl||"https://api.deepinfra.com/v1/openai"}/models`;u.debug(`[DeepInfra] Fetching models from: ${o}`);let r=new AbortController,i=setTimeout(()=>r.abort(),1e4);try{let a=await fetch(o,{method:"GET",headers:{Authorization:`Bearer ${e}`,"User-Agent":this.userAgent},signal:r.signal});if(clearTimeout(i),!a.ok){let l=await a.text();return u.warn(`[DeepInfra] Failed to fetch models: ${a.status} ${a.statusText}`),a.status===429&&u.warn("[DeepInfra] Rate limited (429). Will retry with pre-configured models."),[]}let c=(await a.json()).data||[];return u.info(`[DeepInfra] Successfully fetched ${c.length} models`),c}catch(a){return clearTimeout(i),a instanceof Error&&a.name==="AbortError"?u.warn("[DeepInfra] Model fetch timeout (10s). Using pre-configured models."):u.warn(`[DeepInfra] Model fetch failed: ${a instanceof Error?a.message:String(a)}. Using pre-configured models.`),[]}}catch(t){return u.warn("[DeepInfra] Error in fetchModels:",t instanceof Error?t.message:String(t)),[]}}async prepareLanguageModelChatInformation(e,t){let o=await this.ensureApiKey(e.silent??!0);if(!o)return[];let r=await this.fetchModels(o);(!r||r.length===0)&&(u.info("[DeepInfra] No models from API, using pre-configured models from config"),r=this.providerConfig.models.map(l=>({id:l.id,object:"model",created:0,owned_by:"deepinfra",metadata:{description:l.tooltip||"",context_length:l.maxInputTokens||128e3,max_tokens:l.maxOutputTokens||16e3}})));let a=r.filter(c=>c.metadata&&typeof c.metadata.max_tokens=="number"&&typeof c.metadata.context_length=="number").map(c=>{let l=c.metadata,p={toolCalling:!0,imageInput:l.tags?.includes("vision")??!1},f=16e3,m=l.max_tokens||128e3;return{id:c.id,name:c.id,tooltip:l.description||`DeepInfra model: ${c.id}`,family:"deepinfra",version:"1.0.0",maxInputTokens:m,maxOutputTokens:f,capabilities:p}}),s=this.dedupeModelInfos(a);return this._chatEndpoints=s.map(c=>({model:c.id,modelMaxPromptTokens:c.maxInputTokens+c.maxOutputTokens})),s}async provideLanguageModelChatInformation(e,t){try{let o=await this.getApiKeyHash(),r=await this.modelInfoCache?.getCachedModels(this.providerKey,o);if(r)return this.prepareLanguageModelChatInformation(e,t).then(a=>{this.modelInfoCache?.cacheModels(this.providerKey,a,o)}).catch(()=>{}),r;let i=await this.prepareLanguageModelChatInformation(e,t);return i.length>0&&await this.modelInfoCache?.cacheModels(this.providerKey,i,o),i}catch(o){return u.error("[DeepInfra] Failed to provide model info",o),[]}}static createAndActivate(e,t,o){u.trace(`${o.displayName} provider activated!`);let s=`better-copilot-chat/${$t.extensions.getExtension("OEvortex.better-copilot-chat")?.packageJSON?.version??"unknown"} VSCode/${$t.version}`,c=new n(e,t,o,s),l=$t.lm.registerLanguageModelChatProvider(`chp.${t}`,c),d=$t.commands.registerCommand(`chp.${t}.setApiKey`,async()=>{await De.startWizard({providerKey:t,displayName:o.displayName,apiKeyTemplate:o.apiKeyTemplate,supportsApiKey:!0,supportsBaseUrl:!0}),await c.modelInfoCache?.invalidateCache(t),c._onDidChangeLanguageModelChatInformation.fire()}),p=[l,d];for(let f of p)e.subscriptions.push(f);return{provider:c,disposables:p}}async createOpenAIClient(e){let t=this.providerConfig.baseUrl||"https://api.deepinfra.com/v1/openai";u.info(`[DeepInfra] Creating OpenAI client with baseURL: ${t}`);let o=`deepinfra:${e}:${t}`,r=this.clientCache.get(o);if(r)return r.lastUsed=Date.now(),u.debug(`[DeepInfra] Using cached client for baseURL: ${t}`),r.client;let i=new G({apiKey:e,baseURL:t,defaultHeaders:{"User-Agent":this.userAgent},maxRetries:2,timeout:6e4});return this.clientCache.set(o,{client:i,lastUsed:Date.now()}),u.info(`[DeepInfra] Created new OpenAI client for baseURL: ${t}`),i}async provideLanguageModelChatResponse(e,t,o,r,i){await Ie.getInstance(this.providerKey,2,1e3).throttle(this.providerConfig.displayName);try{u.info(`[DeepInfra] Starting request for model: ${e.name}`);let a=await this.ensureApiKey(!0);if(!a)throw new Error("DeepInfra API key not found");let s=await this.createOpenAIClient(a),c=this.providerConfig.models.find(x=>x.id===e.id),l=this.openaiHandler.convertMessagesToOpenAI(t,e.capabilities||void 0,c),d={model:e.id,messages:l,stream:!0,stream_options:{include_usage:!0},max_tokens:Math.min(o.modelOptions?.max_tokens||4096,e.maxOutputTokens),temperature:o.modelOptions?.temperature??L.getTemperature(),top_p:L.getTopP()};o.tools&&o.tools.length>0&&e.capabilities?.toolCalling&&(d.tools=this.openaiHandler.convertToolsToOpenAI([...o.tools]),d.tool_choice="auto");let p=new AbortController;i.onCancellationRequested(()=>p.abort());let f=s.chat.completions.stream(d,{signal:p.signal}),m=null,h="",g=!1,v=!1,k=new Map;f.on("chunk",x=>{if(!i.isCancellationRequested&&x.choices&&x.choices.length>0)for(let y of x.choices){if(y.delta?.tool_calls)for(let b of y.delta.tool_calls)b.id&&b.index!==void 0&&k.set(b.index,b.id);let w=y.delta;w?.reasoning_content&&(m||(m=`di_thinking_${Date.now()}_${Math.random().toString(36).slice(2,8)}`),h+=w.reasoning_content,r.report(new $t.LanguageModelThinkingPart(h,m)),h="",v=!0)}}),f.on("content",x=>{i.isCancellationRequested||x&&(m&&(r.report(new $t.LanguageModelThinkingPart("",m)),m=null),r.report(new $t.LanguageModelTextPart(x)),x.trim().length>0&&(g=!0))}),f.on("tool_calls.function.arguments.done",x=>{if(i.isCancellationRequested)return;if(m){try{r.report(new $t.LanguageModelThinkingPart("",m))}catch{}m=null}let y=k.get(x.index)||`tool_call_${x.index}_${Date.now()}`,w={};if(x.parsed_arguments){let b=x.parsed_arguments;w=typeof b=="object"&&b!==null?b:{}}else try{w=JSON.parse(x.arguments||"{}")}catch{w={value:x.arguments}}try{r.report(new $t.LanguageModelToolCallPart(y,x.name,w)),g=!0}catch(b){u.warn("[DeepInfra] Failed to report tool call",b instanceof Error?b.message:String(b))}}),await f.finalChatCompletion(),m&&r.report(new $t.LanguageModelThinkingPart("",m)),v&&!g&&(r.report(new $t.LanguageModelTextPart("<think/>")),u.warn("[DeepInfra] End of message stream has only thinking content and no text content, added <think/> placeholder as output"))}catch(a){throw u.error(`[DeepInfra] Request failed: ${a instanceof Error?a.message:String(a)}`),a}}async provideTokenCount(e,t,o){return he.getInstance().countTokens(e,t)}};var Xi=D(require("vscode"));ce();var Po=D(require("node:fs")),xP=D(require("node:os")),Js=D(require("node:path"));ce();var fP="681255809395-oo8ft2oprdrnp9e3aqf6av3hmdib135j.apps.googleusercontent.com",hP="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",gP="https://accounts.google.com/o/oauth2/token",vP="https://cloudcode-pa.googleapis.com/v1internal";var yP=["https://www.googleapis.com/auth/cloud-platform","https://www.googleapis.com/auth/userinfo.email","https://www.googleapis.com/auth/userinfo.profile"];var rr=class n{static instance;credentials=null;refreshTimer=null;refreshLock=!1;constructor(){this.startProactiveRefresh()}static getInstance(){return n.instance||(n.instance=new n),n.instance}startProactiveRefresh(){this.refreshTimer&&clearInterval(this.refreshTimer),this.refreshTimer=setInterval(async()=>{try{this.credentials&&!this.isTokenValid(this.credentials)&&(u.debug("Gemini CLI: Proactive token refresh triggered"),await this.refreshAccessToken(this.credentials))}catch(e){u.trace(`Gemini CLI: Proactive refresh failed: ${e}`)}},3e4)}getCredentialPath(){let e=Js.join(xP.homedir(),".gemini","oauth_creds.json");return Js.normalize(e)}loadCachedCredentials(){let e=this.getCredentialPath();u.debug(`Gemini CLI: Checking credentials at: ${e}`),u.debug(`Gemini CLI: File exists: ${Po.existsSync(e)}`);try{if(!Po.existsSync(e))throw new Error(`Gemini OAuth credentials not found at ${e}. Please login using the Gemini CLI first: gemini auth login`);let t=JSON.parse(Po.readFileSync(e,"utf-8"));return{access_token:t.access_token,refresh_token:t.refresh_token,token_type:t.token_type||"Bearer",expiry_date:t.expiry_date}}catch(t){throw t instanceof Error?t:new Error("Invalid Gemini OAuth credentials file")}}async refreshAccessToken(e){if(this.refreshLock){for(;this.refreshLock;)await new Promise(t=>setTimeout(t,100));return this.credentials||e}this.refreshLock=!0;try{if(!e.refresh_token)throw new Error("No refresh token available in credentials.");let t=new URLSearchParams;t.set("grant_type","refresh_token"),t.set("refresh_token",e.refresh_token),t.set("client_id",fP),t.set("client_secret",hP),t.set("scope",yP.join(" "));let o=await fetch(gP,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded",Accept:"application/json","User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/131.0.0.0 Safari/537.36"},body:t.toString()});if(!o.ok){let a=await o.text();throw new Error(`Token refresh failed: ${o.status} ${o.statusText}. Response: ${a}`)}let r=await o.json();if(r.error)throw new Error(`Token refresh failed: ${r.error} - ${r.error_description||"Unknown error"}`);let i={access_token:r.access_token,token_type:r.token_type||"Bearer",refresh_token:r.refresh_token||e.refresh_token,expiry_date:Date.now()+r.expires_in*1e3};return this.saveCredentials(i),this.credentials=i,i}finally{this.refreshLock=!1}}saveCredentials(e){let t=this.getCredentialPath();try{let o=Js.dirname(t);Po.existsSync(o)||Po.mkdirSync(o,{recursive:!0}),Po.writeFileSync(t,JSON.stringify(e,null,2),"utf-8")}catch(o){u.warn(`Failed to save refreshed credentials: ${o}`)}}isTokenValid(e){return e.expiry_date?Date.now()<e.expiry_date-3e5:!1}async ensureAuthenticated(e=!1){return this.credentials=this.loadCachedCredentials(),(e||!this.isTokenValid(this.credentials))&&(this.credentials=await this.refreshAccessToken(this.credentials)),{accessToken:this.credentials.access_token,baseURL:this.getBaseURL()}}invalidateCredentials(){this.credentials=null}getBaseURL(){return vP}async getAccessToken(){let{accessToken:e}=await this.ensureAuthenticated();return e}async getBaseURLAsync(){let{baseURL:e}=await this.ensureAuthenticated();return e}async forceRefresh(){return await this.ensureAuthenticated(!0)}};var pm=D(require("node:crypto")),je=D(require("vscode"));cr();ot();ce();var Mo=D(require("vscode"));var dm=class n{textBuffer="";textBufferLastFlush=0;thinkingBuffer="";currentThinkingId=null;seenToolCalls=new Set;toolCallCounter=0;isInsideThinkingTag=!1;thinkingTagBuffer="";sseDataParts=[];CLOSING_TAG="</thinking>";thinkingQueue="";thinkingFlushInterval=null;thinkingProgress=null;chunkCounter=0;lastChunkTime=0;streamVelocity=0;functionCallsBuffer="";lastActivityReportTime=0;activityReportInterval=null;pendingToolCalls=[];toolCallFlushInterval=null;static THINKING_FLUSH_INTERVAL_MS=80;static THINKING_CHARS_PER_FLUSH=150;static ACTIVITY_REPORT_INTERVAL_MS=400;static TEXT_BUFFER_MIN_SIZE=40;static TEXT_BUFFER_MAX_DELAY_MS=25;static YIELD_EVERY_N_CHUNKS=5;static HIGH_VELOCITY_THRESHOLD=10;static ADAPTIVE_BUFFER_MULTIPLIER=.5;static TOOL_CALL_FLUSH_DELAY_MS=50;async processStream(e){let{response:t,modelConfig:o,progress:r,token:i}=e;if(!t.body)throw new Error("Gemini response body is empty.");let a=t.body.getReader(),s=new TextDecoder,c="";this.startActivityReporting(r);try{for(;;){if(i.isCancellationRequested)throw new Mo.CancellationError;let{done:l,value:d}=await a.read();if(l)break;let p=performance.now();if(this.lastChunkTime>0){let f=p-this.lastChunkTime;this.streamVelocity=f>0?d.length/f:this.streamVelocity}this.lastChunkTime=p,c+=s.decode(d,{stream:!0}),c=c.replace(/\r\n/g,`
`),c=this.processSSELines(c,o,r),this.flushTextBufferAdaptive(r),this.flushThinkingBufferIfNeeded(r),this.schedulePendingToolCallsFlush(r),this.chunkCounter++,this.chunkCounter%n.YIELD_EVERY_N_CHUNKS===0&&await new Promise(f=>setTimeout(f,1))}}finally{console.log(`GeminiCLI: Stream processing complete, pending tool calls: ${this.pendingToolCalls.length}`),this.stopActivityReporting(),this.processRemainingBuffer(c,o,r),this.flushTextBuffer(r,!0),this.flushPendingToolCallsImmediate(r),this.finalizeThinkingPart(r),console.log(`GeminiCLI: Final pending tool calls after cleanup: ${this.pendingToolCalls.length}`)}}startActivityReporting(e){this.activityReportInterval||(this.lastActivityReportTime=Date.now(),this.activityReportInterval=setInterval(()=>{let t=Date.now();t-this.lastActivityReportTime>=n.ACTIVITY_REPORT_INTERVAL_MS&&(this.thinkingBuffer.length>0?this.flushThinkingBuffer(e):this.textBuffer.length>0&&this.flushTextBuffer(e,!0),this.lastActivityReportTime=t)},n.ACTIVITY_REPORT_INTERVAL_MS/2))}stopActivityReporting(){this.activityReportInterval&&(clearInterval(this.activityReportInterval),this.activityReportInterval=null),this.toolCallFlushInterval&&(clearInterval(this.toolCallFlushInterval),this.toolCallFlushInterval=null)}markActivity(){this.lastActivityReportTime=Date.now()}schedulePendingToolCallsFlush(e){this.pendingToolCalls.length===0||this.toolCallFlushInterval||(this.toolCallFlushInterval=setTimeout(()=>{this.flushPendingToolCallsImmediate(e),this.toolCallFlushInterval=null},n.TOOL_CALL_FLUSH_DELAY_MS))}flushPendingToolCallsImmediate(e){for(console.log(`GeminiCLI: flushPendingToolCallsImmediate called, pending count: ${this.pendingToolCalls.length}`);this.pendingToolCalls.length>0;){let t=this.pendingToolCalls.shift();t&&(console.log(`GeminiCLI: Reporting tool call: ${t.callId}, name: ${t.name}`),e.report(new Mo.LanguageModelToolCallPart(t.callId,t.name,t.args)),this.markActivity())}console.log("GeminiCLI: All pending tool calls flushed")}processSSELines(e,t,o){let r=e.indexOf(`
`),i=0;for(;r!==-1;){let a=e.slice(0,r).trimEnd();if(e=e.slice(r+1),i++,a.length===0){console.log(`GeminiCLI: Empty line, processing SSE event, sseDataParts count: ${this.sseDataParts.length}`),this.processSSEEvent(t,o),r=e.indexOf(`
`);continue}if(a.startsWith("data:")){let s=a.slice(5);if(s.trim()==="[DONE]"){console.log("GeminiCLI: Received [DONE] signal"),this.sseDataParts=[],r=e.indexOf(`
`);continue}s.length>0&&(this.sseDataParts.push(s.trimStart()),console.log(`GeminiCLI: Added data line, sseDataParts count: ${this.sseDataParts.length}`))}r=e.indexOf(`
`)}return i>0&&console.log(`GeminiCLI: Processed ${i} SSE lines, buffer remaining: "${e.substring(0,50)}..."`),e}processSSEEvent(e,t){if(this.sseDataParts.length===0)return;let o=this.sseDataParts.join(`
`).trim();if(this.sseDataParts=[],!o||o==="[DONE]"){console.log("GeminiCLI: SSE event is empty or [DONE]");return}console.log(`GeminiCLI: Processing SSE event, data length: ${o.length}`);let r=()=>`tool_call_${this.toolCallCounter++}_${Date.now()}`;try{this.handleStreamPayload(o,r,e,t),this.flushTextBufferIfNeeded(t),this.flushThinkingBufferIfNeeded(t)}catch(i){if(console.error("GeminiCLI: Error in handleStreamPayload:",i),i instanceof SyntaxError&&String(i.message).includes("after JSON")){console.log("GeminiCLI: Attempting to split concatenated JSON");let a=this.splitConcatenatedJSON(o);console.log(`GeminiCLI: Found ${a.length} JSON objects`);for(let s of a)try{this.handleStreamPayload(s,r,e,t)}catch(c){console.error("GeminiCLI: Error processing JSON object:",c)}}}}processRemainingBuffer(e,t,o){let r=e.trim();if(console.log(`GeminiCLI: processRemainingBuffer, trailing: "${r.substring(0,100)}..."`),r.length>0&&r.startsWith("data:")&&(this.sseDataParts.push(r.slice(5).trimStart()),console.log(`GeminiCLI: Added trailing data to sseDataParts, count: ${this.sseDataParts.length}`)),this.sseDataParts.length>0){let i=this.sseDataParts.join(`
`).trim();if(console.log(`GeminiCLI: Processing remaining SSE data, length: ${i.length}`),i&&i!=="[DONE]"){let a=()=>`tool_call_${this.toolCallCounter++}_${Date.now()}`;try{this.handleStreamPayload(i,a,t,o)}catch(s){console.error("GeminiCLI: Error processing remaining buffer:",s)}}}}handleStreamPayload(e,t,o,r){console.log(`GeminiCLI: Parsing JSON payload, length: ${e.length}`);let i;try{i=JSON.parse(e),console.log("GeminiCLI: JSON parsed successfully")}catch(c){throw console.error("GeminiCLI: Failed to parse JSON:",c),c}let s=(i.response||i).candidates||[];console.log(`GeminiCLI: Found ${s.length} candidates`);for(let c of s){let l=c.content;if(!l?.parts){console.log("GeminiCLI: No content or parts in candidate");continue}console.log(`GeminiCLI: Processing ${l.parts.length} parts`);for(let d of l.parts)this.handlePart(d,t,o,r)}}handlePart(e,t,o,r){console.log("GeminiCLI: Received part:",JSON.stringify(e,null,2));let i=!!e.functionCall,a=typeof e.text=="string",s=e.thought===!0;if(console.log(`GeminiCLI: Part has functionCall=${i}, text=${a}, thought=${s}`),e.thought===!0){o.outputThinking!==!1&&typeof e.text=="string"&&(this.currentThinkingId||(this.currentThinkingId=t()),console.log("GeminiCLI: Received thought part:",e.text),this.thinkingBuffer+=e.text,this.flushThinkingBufferIfNeeded(r));return}if(typeof e.text=="string"){let l=this.functionCallsBuffer+e.text,d=/<function_calls>[\s\S]*?<\/function_calls>/g,p=0,f=d.exec(l);for(;f!==null;){let v=l.slice(p,f.index);if(v.length>0){let w=this.processTextWithThinkingTags(v,o);this.isInsideThinkingTag?this.flushThinkingBufferIfNeeded(r):(this.finalizeThinkingPart(r),w.length>0&&(this.textBuffer+=w,this.flushTextBufferIfNeeded(r)))}let k=f[0],x=/<tool_call\s+name="([^"]+)"\s+arguments='([^']*)'\s*\/>/g,y=x.exec(k);for(this.flushTextBuffer(r,!0),this.flushThinkingBuffer(r);y!==null;){let w=y[1],b=y[2]||"",C={};try{C=JSON.parse(b)}catch{C={value:b}}let I=t(),$=`${I}:${w}`;this.seenToolCalls.has($)||(this.seenToolCalls.add($),this.pendingToolCalls.push({callId:I,name:w,args:C}),this.markActivity()),y=x.exec(k)}p=d.lastIndex,f=d.exec(l)}let m=l.slice(p),h=m.indexOf("<function_calls>"),g=m.indexOf("</function_calls>");if(h!==-1&&g===-1){this.functionCallsBuffer=m.slice(h);let v=m.slice(0,h);if(v.length>0){let k=this.processTextWithThinkingTags(v,o);this.isInsideThinkingTag?this.flushThinkingBufferIfNeeded(r):(this.finalizeThinkingPart(r),k.length>0&&(this.textBuffer+=k,this.flushTextBufferIfNeeded(r)))}}else if(this.functionCallsBuffer="",m.length>0){let v=this.processTextWithThinkingTags(m,o);this.isInsideThinkingTag?this.flushThinkingBufferIfNeeded(r):(this.finalizeThinkingPart(r),v.length>0&&(this.textBuffer+=v,this.flushTextBufferIfNeeded(r)))}}let c=e.functionCall;if(c?.name){console.log(`GeminiCLI: Processing functionCall: name=${c.name}, id=${c.id||"generated"}`),this.flushTextBuffer(r,!0),this.flushThinkingBuffer(r);let l=wP(e);if(console.log(`GeminiCLI: Extracted tool call info: callId=${l?.callId}, name=${l?.name}`),l?.callId&&l.name){let d=`${l.callId}:${l.name}`;if(console.log(`GeminiCLI: Dedupe key: ${d}, alreadySeen=${this.seenToolCalls.has(d)}`),this.seenToolCalls.has(d)){console.log(`GeminiCLI: Skipping duplicate tool call: ${d}`);return}this.seenToolCalls.add(d),console.log(`GeminiCLI: Added to seenToolCalls: ${d}`),l.thoughtSignature&&bP(l.callId,l.thoughtSignature);let p={};if(l.args&&typeof l.args=="object")p=l.args;else if(typeof l.args=="string")try{let f=JSON.parse(l.args);f&&typeof f=="object"&&(p=f)}catch{p={value:l.args}}this.pendingToolCalls.push({callId:l.callId,name:l.name,args:p}),this.markActivity(),console.log(`GeminiCLI: Queued tool call: ${l.callId}, pending count: ${this.pendingToolCalls.length}`)}}}processTextWithThinkingTags(e,t){if(t.outputThinking===!1)return e.replace(/<thinking>[\s\S]*?<\/thinking>/g,"");let o="",r=this.thinkingTagBuffer+e;for(this.thinkingTagBuffer="";r.length>0;)if(this.isInsideThinkingTag){let i=r.indexOf(this.CLOSING_TAG);if(i!==-1){let a=r.slice(0,i);a.length>0&&(this.currentThinkingId||(this.currentThinkingId=this.generateThinkingId()),this.thinkingBuffer+=a),this.isInsideThinkingTag=!1,r=r.slice(i+this.CLOSING_TAG.length)}else{let a=Math.max(0,r.length-12);a>0&&(this.currentThinkingId||(this.currentThinkingId=this.generateThinkingId()),this.thinkingBuffer+=r.slice(0,a)),this.thinkingTagBuffer=r.slice(a),r=""}}else{let i=r.indexOf("<thinking>");if(i!==-1)o+=r.slice(0,i),this.isInsideThinkingTag=!0,this.currentThinkingId||(this.currentThinkingId=this.generateThinkingId()),r=r.slice(i+10);else{let a=Math.max(0,r.length-10);o+=r.slice(0,a),this.thinkingTagBuffer=r.slice(a),r=""}}return o}flushTextBuffer(e,t=!1){this.textBuffer.length>0&&(t||this.textBuffer.length>=n.TEXT_BUFFER_MIN_SIZE)&&(e.report(new Mo.LanguageModelTextPart(this.textBuffer)),this.textBuffer="",this.textBufferLastFlush=Date.now(),this.markActivity())}flushTextBufferIfNeeded(e){if(this.textBuffer.length===0)return;let t=Date.now()-this.textBufferLastFlush;(this.textBuffer.length>=n.TEXT_BUFFER_MIN_SIZE||t>=n.TEXT_BUFFER_MAX_DELAY_MS)&&this.flushTextBuffer(e,!0)}flushTextBufferAdaptive(e){if(this.textBuffer.length===0)return;let t=this.streamVelocity>n.HIGH_VELOCITY_THRESHOLD,o=n.TEXT_BUFFER_MIN_SIZE,r=n.TEXT_BUFFER_MAX_DELAY_MS,i=n.ADAPTIVE_BUFFER_MULTIPLIER,a=t?Math.floor(o*i):o,s=t?Math.floor(r*i):r,c=Date.now()-this.textBufferLastFlush;(this.textBuffer.length>=a||c>=s)&&this.flushTextBuffer(e,!0)}flushThinkingBuffer(e){this.thinkingBuffer.length>0&&this.currentThinkingId&&(this.enqueueThinking(this.thinkingBuffer,e),this.thinkingBuffer="")}flushThinkingBufferIfNeeded(e){this.flushThinkingBuffer(e)}enqueueThinking(e,t){this.thinkingQueue+=e,this.thinkingProgress=t,this.markActivity(),this.thinkingFlushInterval||(this.thinkingFlushInterval=setInterval(()=>this.flushThinkingChunk(),n.THINKING_FLUSH_INTERVAL_MS))}flushThinkingChunk(){if(this.thinkingQueue.length===0||!this.thinkingProgress||!this.currentThinkingId)return;let e=Math.min(n.THINKING_CHARS_PER_FLUSH,this.thinkingQueue.length),t=this.thinkingQueue.slice(0,e);this.thinkingQueue=this.thinkingQueue.slice(e),this.thinkingProgress.report(new Mo.LanguageModelThinkingPart(t,this.currentThinkingId)),this.markActivity()}finalizeThinkingPart(e){for(this.thinkingFlushInterval&&(clearInterval(this.thinkingFlushInterval),this.thinkingFlushInterval=null),this.thinkingBuffer.length>0&&(this.thinkingQueue+=this.thinkingBuffer,this.thinkingBuffer=""),this.thinkingProgress=e;this.thinkingQueue.length>0;){let t=Math.min(n.THINKING_CHARS_PER_FLUSH*2,this.thinkingQueue.length),o=this.thinkingQueue.slice(0,t);this.thinkingQueue=this.thinkingQueue.slice(t),this.currentThinkingId&&e.report(new Mo.LanguageModelThinkingPart(o,this.currentThinkingId))}this.currentThinkingId&&(e.report(new Mo.LanguageModelThinkingPart("",this.currentThinkingId)),this.currentThinkingId=null)}splitConcatenatedJSON(e){let t=[],o=0,r=-1;for(let i=0;i<e.length;i++)e[i]==="{"?(o===0&&(r=i),o++):e[i]==="}"&&(o--,o===0&&r!==-1&&(t.push(e.slice(r,i+1)),r=-1));return t}generateThinkingId(){return`thinking_${Date.now()}_${Math.random().toString(36).slice(2,8)}`}};var Eq=["https://cloudcode-pa.googleapis.com"],kP="gemini-cli/1.0.0",Rq=5,Oq=1e3,Fy=3e4,Lq=1e3,_P=1800*1e3,Nq=600*1e3,CP=120*1e3,zq=new Set(["$ref","$defs","definitions","$id","$anchor","$dynamicRef","$dynamicAnchor","$schema","$vocabulary","$comment","exclusiveMinimum","exclusiveMaximum","minimum","maximum","multipleOf","additionalProperties","minLength","maxLength","pattern","minItems","maxItems","uniqueItems","minContains","maxContains","minProperties","maxProperties","if","then","else","dependentSchemas","dependentRequired","unevaluatedItems","unevaluatedProperties","contentEncoding","contentMediaType","contentSchema","dependencies","allOf","anyOf","oneOf","not","strict","input_examples","examples"]),By=new Map,Dq="skip_thought_signature_validator";function bP(n,e){n&&e&&By.set(n,e)}function qq(n){switch(n){case 400:return"user_error";case 401:return"auth_error";case 402:case 403:case 429:return"quota_error";case 404:return"not_found";case 500:case 502:case 503:case 504:return"transient";default:return"unknown"}}function Fq(n){return n==="quota_error"||n==="transient"||n==="auth_error"}function Bq(n,e){if(n!==403||!e)return!1;if(e.toLowerCase().includes("permission denied"))return!0;try{let t=JSON.parse(e);if(t?.error?.status==="PERMISSION_DENIED")return!0;let o=t?.error?.details;if(Array.isArray(o)){for(let r of o)if(r["@type"]==="type.googleapis.com/google.rpc.ErrorInfo"&&r.reason==="CONSUMER_INVALID")return!0}}catch{}return!1}function TP(n){let e=n.match(/^(\d+(?:\.\d+)?)s$/);return e?Math.round(parseFloat(e[1])*1e3):null}function Uq(n){let e=TP(n);if(e!==null)return e;let t=0,o=n.match(/(\d+)h/),r=n.match(/(\d+)m/),i=n.match(/(\d+(?:\.\d+)?)s/);return o&&(t+=parseInt(o[1],10)*60*60*1e3),r&&(t+=parseInt(r[1],10)*60*1e3),i&&(t+=Math.round(parseFloat(i[1])*1e3)),t>0?t:null}function Uy(n){try{let e=JSON.parse(n),t=e?.error?.details||(Array.isArray(e)?e[0]?.error?.details:null);if(!t)return null;for(let o of t){if(o["@type"]==="type.googleapis.com/google.rpc.RetryInfo"&&o.retryDelay){let r=TP(o.retryDelay);if(r!==null&&r>0)return r}if(o["@type"]==="type.googleapis.com/google.rpc.ErrorInfo"&&o.metadata?.quotaResetDelay){let r=Uq(o.metadata.quotaResetDelay);if(r!==null&&r>0)return r}}}catch{}return null}function IP(n,e){return new Promise(t=>{if(n<=0){t();return}let o=setTimeout(t,n),r=e.onCancellationRequested(()=>{clearTimeout(o),t()});setTimeout(()=>r.dispose(),n+100)})}var jy=class n{static instance;modelStates=new Map;static getInstance(){return n.instance||(n.instance=new n),n.instance}markQuotaExceeded(e,t){let o=this.modelStates.get(e)||{isExhausted:!1,resetsAt:0,lastUpdated:0,exceeded:!1,nextRecoverAt:0,backoffLevel:0},r=Lq*2**(o.backoffLevel||0);r>_P&&(r=_P);let i=t&&t>r?t:r;this.modelStates.set(e,{isExhausted:!0,resetsAt:Date.now()+i,lastUpdated:Date.now(),exceeded:!0,nextRecoverAt:Date.now()+i,backoffLevel:(o.backoffLevel||0)+1,lastError:`Quota exceeded, retry after ${Math.round(i/1e3)}s`})}clearQuotaExceeded(e){let t=this.modelStates.get(e);t&&(t.exceeded=!1,t.backoffLevel=0,t.lastError=void 0)}isInCooldown(e){let t=this.modelStates.get(e);return!t||!t.exceeded?!1:Date.now()>=(t.nextRecoverAt||0)?(this.clearQuotaExceeded(e),!1):!0}getRemainingCooldown(e){let t=this.modelStates.get(e);if(!t||!t.exceeded)return 0;let o=(t.nextRecoverAt||0)-Date.now();return o>0?o:0}},Ky=class{retryCount=0;async handleRateLimit(e,t,o){if(e)return"continue";if(this.retryCount>=Rq)return"max_exceeded";let r=Oq*2**this.retryCount,i=Uy(t);return i!==null?r=Math.min(i+500,Fy):r>Fy&&(r=Fy),this.retryCount++,await IP(r,o),o.isCancellationRequested?"max_exceeded":"retry"}};function jq(n){if(!n||typeof n!="object"||Array.isArray(n))return{type:"object",properties:{}};let e;try{e=JSON.parse(JSON.stringify(n))}catch{return{type:"object",properties:{}}}let t=o=>{if(o){for(let r of["anyOf","oneOf","allOf"]){let i=o[r];if(Array.isArray(i)&&i.length>0){let a;for(let c of i)if(c&&typeof c=="object"&&(a=c,a.type==="string"))break;let s=a??i[0];for(let c of Object.keys(o))delete o[c];Object.assign(o,s);break}}if(Array.isArray(o.type)){let i=o.type.filter(a=>a!=="null").find(a=>typeof a=="string"&&a.trim()!=="");o.type=i??"object"}if(o.nullable===!0&&delete o.nullable,Array.isArray(o.properties)){let r={};for(let i of o.properties){if(!i||typeof i!="object")continue;let a=i,s=a.name??a.key,c=a.value??a.schema??a.property;typeof s=="string"&&c&&typeof c=="object"&&(r[s]=c)}o.properties=r}if(Array.isArray(o.items)){let r=o.items[0];o.items=r&&typeof r=="object"?r:void 0}typeof o.type=="string"&&(o.type=o.type.toLowerCase());for(let r of Object.keys(o))zq.has(r)&&delete o[r];for(let r of[o.properties,o.items,o.additionalProperties,o.patternProperties,o.propertyNames,o.contains])if(r&&typeof r=="object"&&!Array.isArray(r)&&t(r),Array.isArray(r))for(let i of r)i&&typeof i=="object"&&t(i);if(o.properties&&typeof o.properties=="object")for(let r of Object.values(o.properties))r&&typeof r=="object"&&t(r)}};return t(e),(typeof e.type!="string"||!e.type.trim()||e.type==="None")&&(e.type="object"),(!e.properties||typeof e.properties!="object")&&(e.properties={}),e}function Kq(n){return n.map(e=>{let t=By.get(e.callId),o=t||Dq;t||By.set(e.callId,o);let r=e.input;if(typeof r=="string")try{r=JSON.parse(r)}catch{r={value:r}}return(!r||typeof r!="object"||Array.isArray(r))&&(r={value:r}),{functionCall:{name:e.name,id:e.callId,args:r},thoughtSignature:o}})}function wP(n){let e=n.functionCall;return e?.name?{callId:e.id||`call_${Date.now()}_${Math.random().toString(36).substring(2,15)}`,name:e.name,args:e.args,thoughtSignature:n.thoughtSignature}:null}var Hy=class{convertMessagesToGemini(e,t,o){let r=[],i="",a=new Map;for(let m of e)if(m.role===je.LanguageModelChatMessageRole.Assistant)for(let h of m.content)h instanceof je.LanguageModelToolCallPart&&a.set(h.callId,h.name);let s=t.outputThinking!==!1||t.includeThinking===!0,l=(o||t.model||"").toLowerCase().includes("claude"),p=e.filter(m=>m.role!==je.LanguageModelChatMessageRole.System).length,f=0;for(let m of e){if(m.role===je.LanguageModelChatMessageRole.System){i=m.content.filter(h=>h instanceof je.LanguageModelTextPart).map(h=>h.value).join(`
`);continue}if(f++,m.role===je.LanguageModelChatMessageRole.User){let h=[],g=m.content.filter(v=>v instanceof je.LanguageModelTextPart).map(v=>v.value).join(`
`);g&&h.push({text:g});for(let v of m.content)if(v instanceof je.LanguageModelDataPart&&v.mimeType.toLowerCase().startsWith("image/")&&h.push({inlineData:{mimeType:v.mimeType,data:Buffer.from(v.data).toString("base64")}}),v instanceof je.LanguageModelToolResultPart){let k=a.get(v.callId)||"unknown",x="";typeof v.content=="string"?x=v.content:Array.isArray(v.content)?x=v.content.map(w=>w instanceof je.LanguageModelTextPart?w.value:JSON.stringify(w)).join(`
`):x=JSON.stringify(v.content);let y={content:x};try{let w=JSON.parse(x.trim());w&&typeof w=="object"&&(y=Array.isArray(w)?{result:w}:w)}catch{}h.push({functionResponse:{name:k,id:v.callId,response:y}})}h.length>0&&r.push({role:"user",parts:h});continue}if(m.role===je.LanguageModelChatMessageRole.Assistant){let h=[],g=!l&&(t.includeThinking===!0||t.outputThinking!==!1),v=m.content.filter(x=>x instanceof je.LanguageModelToolCallPart);if(g&&v.length===0){for(let x of m.content)if(x instanceof je.LanguageModelThinkingPart){let y=Array.isArray(x.value)?x.value.join(""):x.value;y&&h.push({text:y,thought:!0});break}}let k=m.content.filter(x=>x instanceof je.LanguageModelTextPart).map(x=>x.value).join(`
`);k&&h.push({text:k}),v.length>0&&h.push(...Kq(v)),l&&(h=h.filter(x=>x.thought!==!0)),!l&&v.length===0&&g&&f===p&&!h.some(x=>x.thought===!0)&&h.unshift({text:"Thinking...",thought:!0}),h.length>0&&r.push({role:"model",parts:h})}}return{contents:r,systemInstruction:i?{role:"user",parts:[{text:i}]}:void 0}}},Zy=class{messageConverter=new Hy;buildGeminiPayload(e,t,o,r,i,a){let s=L.getMaxTokensForModel(e.maxOutputTokens),c=i.toLowerCase(),{contents:l,systemInstruction:d}=this.messageConverter.convertMessagesToGemini(o,t,c),p=c.includes("claude")&&c.includes("thinking"),f=t.outputThinking!==!1||t.includeThinking===!0,m={maxOutputTokens:s,temperature:L.getTemperature(),topP:L.getTopP()},h=r.tools&&r.tools.length>0&&e.capabilities?.toolCalling;if(f)if(console.log("GeminiCLI: Thinking enabled for model:",c),p){let y=t.thinkingBudget||1e4;s<y+1e3&&(m.maxOutputTokens=y+1e3),m.thinkingConfig={includeThoughts:!0,thinkingBudget:y},console.log("GeminiCLI: Claude thinking config:",m.thinkingConfig)}else c.includes("gemini-3")?(m.thinkingConfig={includeThoughts:!0,thinkingLevel:"HIGH"},console.log("GeminiCLI: Gemini-3 thinking config:",m.thinkingConfig)):c.includes("gemini-2.5")?(m.thinkingConfig={includeThoughts:!0,thinkingBudget:8192},console.log("GeminiCLI: Gemini-2.5 thinking config:",m.thinkingConfig)):console.log("GeminiCLI: Model does not support thinking:",c);else console.log("GeminiCLI: Thinking disabled for model:",c);let g={contents:l,generationConfig:m};d&&(g.systemInstruction=d),h&&(g.tools=[{functionDeclarations:r.tools?.map(y=>({name:y.name,description:y.description||"",parameters:y.inputSchema&&typeof y.inputSchema=="object"?jq(y.inputSchema):{type:"object",properties:{}}}))}],g.toolConfig={functionCallingConfig:{mode:"AUTO"}}),t.extraBody&&typeof t.extraBody=="object"&&Object.assign(g,t.extraBody);let k=`agent-${pm.default.randomUUID?pm.default.randomUUID():pm.default.randomBytes(16).toString("hex")}`,x={model:i,user_prompt_id:k,request:g};return a&&(x.project=a),this.validatePartsBalance(g.contents,c),this.balanceFunctionCallResponses(g.contents,c),x}validatePartsBalance(e,t){let o=0,r=0,i=0;for(let a of e)for(let s of a.parts)s.functionCall&&o++,s.functionResponse&&r++,s.thoughtSignature&&!s.functionCall&&i++;console.log(`GeminiCLI: Parts validation - functionCalls=${o}, functionResponses=${r}, orphanThoughtSignatures=${i}`),o!==r&&console.warn(`GeminiCLI: WARNING - Function call/response mismatch! calls=${o}, responses=${r}. Attempting to automatically balance parts before sending.`),i>0&&console.warn(`GeminiCLI: WARNING - Found ${i} thoughtSignature parts without functionCall. Attempting to reattach them to the nearest functionCall part.`)}balanceFunctionCallResponses(e,t){let o=new Map,r=new Map,i=[];for(let a=0;a<e.length;a++){let s=e[a];for(let c=0;c<s.parts.length;c++){let l=s.parts[c];if(l.functionCall){let d=l.functionCall.id||l.functionCall.callId||`call_${a}_${c}`;o.set(String(d),{name:l.functionCall.name,contentIndex:a,partIndex:c}),l.thoughtSignature&&(l.thoughtSignature=String(l.thoughtSignature))}else if(l.functionResponse){let p=l.functionResponse.id||`__name_${l.functionResponse.name}`,f=r.get(p)||[];f.push({contentIndex:a,partIndex:c}),r.set(p,f)}l.thoughtSignature&&!l.functionCall&&i.push({signature:String(l.thoughtSignature),contentIndex:a,partIndex:c})}}for(let[a,s]of o.entries()){let c=a;r.has(c)||(e.push({role:"user",parts:[{functionResponse:{name:s.name||"",id:a,response:{}}}]}),console.log(`GeminiCLI: Added placeholder functionResponse for id=${a} name=${s.name||""}`))}for(let[a,s]of r.entries())if(!o.has(a)){for(let c=s.length-1;c>=0;c--){let l=s[c],d=e[l.contentIndex],f=d.parts[l.partIndex].functionResponse?.response;f&&Object.keys(f).length>0?d.parts[l.partIndex]={text:JSON.stringify(f)}:d.parts.splice(l.partIndex,1)}console.warn(`GeminiCLI: Converted/removed ${s.length} orphan functionResponse(s) for key=${a}`)}for(let a of i){let{signature:s,contentIndex:c,partIndex:l}=a,d=!1,p=e[c];if(p){let f=p.parts.findIndex(m=>m.functionCall);f!==-1&&(p.parts[f].thoughtSignature=s,delete p.parts[l].thoughtSignature,d=!0)}if(!d)for(let f=c-1;f>=0&&!d;f--){let m=e[f].parts.findIndex(h=>h.functionCall);m!==-1&&(e[f].parts[m].thoughtSignature=s,delete e[c].parts[l].thoughtSignature,d=!0)}if(!d)for(let f=c+1;f<e.length&&!d;f++){let m=e[f].parts.findIndex(h=>h.functionCall);m!==-1&&(e[f].parts[m].thoughtSignature=s,delete e[c].parts[l].thoughtSignature,d=!0)}d||(delete e[c].parts[l].thoughtSignature,console.warn(`GeminiCLI: Removed orphan thoughtSignature at content=${c} part=${l} - no functionCall found to attach to.`))}for(let a=e.length-1;a>=0;a--)(!e[a].parts||e[a].parts.length===0)&&e.splice(a,1)}},mm=class{constructor(e){this.displayName=e}quotaManager=jy.getInstance();accountQuotaCache=it.getInstance();quotaNotificationManager=new gs;fromIRTranslator=new Zy;cacheUpdateTimers=new Map;pendingCacheUpdates=new Map;projectIdCache=null;projectIdPromise=null;async handleRequest(e,t,o,r,i,a,s,c,l){await Ie.getInstance("geminicli",2,1e3).throttle(this.displayName);let d=s||await rr.getInstance().getAccessToken();if(!d)throw new Error("Not logged in to Gemini CLI. Please login first.");let p=t.model||e.id,f=c||"default-gemini",m=`${f}:${p}`;if(this.quotaManager.isInCooldown(m)){let I=this.quotaManager.getRemainingCooldown(m);if(I>5e3&&this.quotaNotificationManager.notifyQuotaExceeded(I,p,c,this.displayName),I>CP)throw this.debouncedCacheUpdate(`quota-${f}`,()=>this.accountQuotaCache.markQuotaExceeded(f,"gemini",{accountName:this.displayName,resetDelayMs:I,affectedModel:p,error:"Quota cooldown exceeds max wait threshold"}),50),await this.quotaNotificationManager.notifyQuotaTooLong(I,p,c,this.displayName),new Error(`Quota wait too long (${this.quotaNotificationManager.formatDuration(I)}). Please add another account or try again later.`);if(await IP(I,a),a.isCancellationRequested)throw new je.CancellationError}let h=await this.getProjectId(d,t.baseUrl),g=this.fromIRTranslator.buildGeminiPayload(e,t,o,r,p,h),v=t.baseUrl?[t.baseUrl.replace(/\/v1internal\/?$/,"")]:[...Eq],k=new AbortController,x=a.onCancellationRequested(()=>k.abort()),y=new Ky;i.report(new je.LanguageModelTextPart(""));let w=0,b="",C=null;try{for(let I=0;I<v.length;I++){let $=`${v[I].replace(/\/$/,"")}/v1internal:streamGenerateContent?alt=sse`;if(a.isCancellationRequested)throw new je.CancellationError;try{let M=await this.streamRequest($,d,g,t,i,a,k);if(M.success){this.quotaManager.clearQuotaExceeded(m),this.quotaNotificationManager.clearQuotaCountdown(),this.debouncedCacheUpdate(`success-${f}`,()=>this.accountQuotaCache.recordSuccess(f,"gemini",this.displayName),50);try{let z=await he.getInstance().countMessagesTokens(e,[...o],{sdkMode:t.sdkMode||"openai"},r);Gt.getInstance().recordSuccess({modelId:e.id,modelName:e.name,providerId:"gemini",promptTokens:z,completionTokens:0,totalTokens:z,maxInputTokens:e.maxInputTokens,maxOutputTokens:e.maxOutputTokens,estimatedPromptTokens:!0})}catch(z){u.trace(`[GeminiCLI] Failed to estimate prompt tokens: ${String(z)}`)}return}if(Bq(M.status,M.body))throw this.debouncedCacheUpdate(`failure-${f}`,()=>this.accountQuotaCache.recordFailure(f,"gemini",`HTTP ${M.status||403}: ${M.body||"Permission denied"}`,this.displayName),50),new Error(M.body||"Permission denied on Gemini project.");let A=qq(M.status||0);if(A==="quota_error"){w=M.status||0,b=M.body||"";let z=Uy(b);this.quotaManager.markQuotaExceeded(m,z||void 0);let F=this.quotaManager.getRemainingCooldown(m);if(F>5e3&&this.quotaNotificationManager.notifyQuotaExceeded(F,p,f,this.displayName),this.debouncedCacheUpdate(`quota-${f}`,()=>this.accountQuotaCache.markQuotaExceeded(f,"gemini",{accountName:this.displayName,resetDelayMs:z||F,affectedModel:p,error:`HTTP ${w}: Quota exceeded`}),50),F>CP)throw await this.quotaNotificationManager.notifyQuotaTooLong(F,p,f,this.displayName),new Error(`Quota wait too long (${this.quotaNotificationManager.formatDuration(F)}). Please add another account or try again later.`);if(z&&z>Nq)throw new Error(`Account quota exhausted (quota resets in ${this.quotaNotificationManager.formatDuration(z)}). Please wait or use a different account.`);if(I+1<v.length)continue;if(l!==!1&&await y.handleRateLimit(!1,b,a)==="retry"){I--;continue}throw new Error(`Quota exceeded${z?` (quota resets in ${this.quotaNotificationManager.formatDuration(z)})`:""}: ${b||`HTTP ${M.status}`}`)}if(A==="transient"&&Fq(A)&&I+1<v.length){w=M.status||0,b=M.body||"";continue}if(A==="auth_error")throw new Error("Authentication failed. Please re-login to Gemini CLI.");if(M.status===404&&I+1<v.length){w=M.status,b=M.body||"";continue}throw new Error(M.body||`HTTP ${M.status} ${M.statusText}`)}catch(M){if(M instanceof je.CancellationError||M instanceof Error&&(M.message.startsWith("Quota exceeded")||M.message.startsWith("Rate limited")||M.message.startsWith("HTTP")||M.message.startsWith("Authentication failed")))throw M;if(w=0,b="",C=M instanceof Error?M:new Error(String(M)),I+1<v.length)continue;throw M}}if(w!==0){let I=Uy(b);throw new Error(`HTTP ${w}${I?` (quota resets in ${this.quotaNotificationManager.formatDuration(I)})`:""}: ${b}`)}throw C||new Error("All Gemini endpoints unavailable")}finally{x.dispose()}}async getProjectId(e,t){return this.projectIdCache?this.projectIdCache:this.projectIdPromise?this.projectIdPromise:(this.projectIdPromise=(async()=>{try{let o=(t||"https://cloudcode-pa.googleapis.com/v1internal").replace(/\/$/,""),r=o.includes("/v1internal")?`${o}:loadCodeAssist`:`${o.replace(/\/$/,"")}/v1internal:loadCodeAssist`,i=process.env.GOOGLE_CLOUD_PROJECT||process.env.GOOGLE_CLOUD_PROJECT_ID||"",a={ideType:"IDE_UNSPECIFIED",platform:"PLATFORM_UNSPECIFIED",pluginType:"GEMINI"};i&&(a.duetProject=i);let s=await fetch(r,{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json","User-Agent":kP,"Client-Metadata":JSON.stringify(a)},body:JSON.stringify({cloudaicompanionProject:i||void 0,metadata:a})});if(!s.ok)return this.projectIdCache="","";let c=await s.text(),l;try{l=JSON.parse(c)}catch{return this.projectIdCache="",""}let d=l?.cloudaicompanionProject,p="";return typeof d=="string"?p=d.trim():d&&typeof d=="object"&&typeof d.id=="string"&&(p=d.id.trim()),this.projectIdCache=p,p}catch{return this.projectIdCache="",""}finally{this.projectIdPromise=null}})(),this.projectIdPromise)}async streamRequest(e,t,o,r,i,a,s){let c;try{c=await fetch(e,{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json",Accept:"text/event-stream","User-Agent":kP},body:JSON.stringify(o),signal:s.signal})}catch(l){throw a.isCancellationRequested||s.signal.aborted?new je.CancellationError:l}return c.ok?(r.sdkMode==="openai"||r.sdkMode==="openai-sse"?await new Pi().processStream({response:c,modelConfig:r,progress:i,token:a}):await new dm().processStream({response:c,modelConfig:r,progress:i,token:a}),{success:!0}):{success:!1,status:c.status,statusText:c.statusText,body:await c.text()}}isInCooldown(e,t){return this.quotaManager.isInCooldown(`${t||"default-gemini"}:${e}`)}getRemainingCooldown(e,t){return this.quotaManager.getRemainingCooldown(`${t||"default-gemini"}:${e}`)}debouncedCacheUpdate(e,t,o){let r=this.cacheUpdateTimers.get(e);r&&clearTimeout(r),this.pendingCacheUpdates.set(e,t);let i=setTimeout(()=>{let a=this.pendingCacheUpdates.get(e);a&&(a().catch(()=>{}),this.pendingCacheUpdates.delete(e)),this.cacheUpdateTimers.delete(e)},o);this.cacheUpdateTimers.set(e,i)}};var fm=class n extends Te{geminiHandler;cooldowns=new Map;constructor(e,t,o){super(e,t,o),this.geminiHandler=new mm(o.displayName)}isInCooldown(e){let t=this.cooldowns.get(e);return typeof t=="number"&&Date.now()<t}setCooldown(e,t=1e4){this.cooldowns.set(e,Date.now()+t)}isRateLimitError(e){if(!(e instanceof Error))return!1;let t=e.message;return t.includes("HTTP 429")||t.includes("Rate limited")||t.includes("Quota exceeded")||t.includes("429")}static createAndActivate(e,t,o){u.trace(`${o.displayName} provider activated!`);let r=new n(e,t,o),i=Xi.lm.registerLanguageModelChatProvider(`chp.${t}`,r),a=Xi.commands.registerCommand(`chp.${t}.login`,async()=>{try{let{accessToken:c,baseURL:l}=await rr.getInstance().ensureAuthenticated(!0);Xi.window.showInformationMessage(`${o.displayName} login successful!`);try{let d=Ne.getInstance();d.getAccountsByProvider("geminicli").find(f=>f.metadata?.source==="cli")||await d.addOAuthAccount("geminicli","Gemini CLI (Local)","",{accessToken:c??"",refreshToken:"",expiresAt:"",tokenType:""},{source:"cli",baseURL:l})}catch(d){u.warn("[geminicli] Failed to register CLI account with AccountManager",d)}await r.modelInfoCache?.invalidateCache(t),r._onDidChangeLanguageModelChatInformation.fire()}catch(c){Xi.window.showErrorMessage(`${o.displayName} login failed: ${c instanceof Error?c.message:"Unknown error"}`)}}),s=[i,a];for(let c of s)e.subscriptions.push(c);return{provider:r,disposables:s}}async provideLanguageModelChatInformation(e,t){return this.providerConfig.models.map(o=>this.modelConfigToInfo(o))}async provideLanguageModelChatResponse(e,t,o,r,i){let a=this.providerConfig.models.find(s=>s.id===e.id);if(!a)throw new Error(`Model not found: ${e.id}`);try{if(this.isInCooldown(e.id))throw new Error("Rate limited: please try again later");let s=Ne.getInstance(),c=s.getAccountsByProvider("geminicli"),l=s.getLoadBalanceEnabled("geminicli"),d=s.getAccountIdForModel("geminicli",e.id),p=async g=>{let v=await s.getCredentials(g.id);if(!v)return{success:!1,reason:"no-creds"};let k;if("accessToken"in v?k=v.accessToken:"apiKey"in v&&(k=v.apiKey),!k)return{success:!1,reason:"no-token"};let x={...a,baseUrl:a.baseUrl||void 0,customHeader:{...a.customHeader||{},Authorization:`Bearer ${k}`}};try{return await this.geminiHandler.handleRequest(e,x,t,o,r,i,k),{success:!0}}catch(y){return{success:!1,error:y}}};if(c&&c.length>0){let g=c.filter(b=>b.status==="active"),v=g.length>0?g:c,k=s.getActiveAccount("geminicli"),x;if(l)k&&v.some(b=>b.id===k.id)?x=[k,...v.filter(b=>b.id!==k.id)]:x=v;else{let b=d?c.find(C=>C.id===d):k;x=b?[b]:v.length>0?[v[0]]:[]}let y,w=!1;for(let b of x){let C=await p(b);if(C.success){w&&l&&s.setAccountForModel("geminicli",e.id,b.id).catch(()=>{});return}if(y=C.error??C.reason,C.error instanceof Error&&C.error.message.includes("401")){await s.markAccountExpired(b.id);continue}if(this.isRateLimitError(C.error)&&l){w=!0;continue}if(C.error)throw C.error}y&&u.warn("[geminicli] Managed accounts failed, falling back to CLI credentials",y)}let{accessToken:f,baseURL:m}=await rr.getInstance().ensureAuthenticated(),h={...a,baseUrl:m,apiKey:f,customHeader:a.customHeader};await this.geminiHandler.handleRequest(e,h,t,o,r,i,f)}catch(s){if(s instanceof Error&&s.message.includes("401")){rr.getInstance().invalidateCredentials?.();let{accessToken:c,baseURL:l}=await rr.getInstance().ensureAuthenticated(!0),d={...a,baseUrl:l,customHeader:{...a.customHeader,Authorization:`Bearer ${c}`}};await this.geminiHandler.handleRequest(e,d,t,o,r,i,c);return}throw this.isRateLimitError(s)?(this.setCooldown(e.id,1e4),new Error("Rate limited: please try again in a few seconds")):s}}};var Ct=D(require("vscode"));Ke();ot();ce();var AP="https://router.huggingface.co/v1",Xs=16e3,Gy=128e3,hm=class n extends Te{userAgent;clientCache=new Map;constructor(e,t,o,r){super(e,t,o),this.userAgent=r}refreshHandlers(){this.clientCache&&this.clientCache.size>0&&(u.debug(`[HuggingFace] Clearing ${this.clientCache.size} cached OpenAI clients due to config change`),this.clientCache.clear()),super.refreshHandlers()}estimateMessagesTokens(e){let t=0;for(let o of e)for(let r of o.content)r instanceof Ct.LanguageModelTextPart&&(t+=Math.ceil(r.value.length/4));return t}estimateToolTokens(e){if(!e||e.length===0)return 0;try{let t=JSON.stringify(e);return Math.ceil(t.length/4)}catch{return 0}}async prepareLanguageModelChatInformation(e,t){let o=await this.ensureApiKey(e.silent??!0);if(!o)return[];let{models:r}=await this.fetchModels(o),i=r.flatMap(s=>{let c=s?.providers??[],l=s.architecture?.input_modalities??[],d=Array.isArray(l)&&l.includes("image"),p=c.filter(m=>m.supports_tools===!0),f=[];if(p.length>0){let m=p.map(x=>typeof x?.context_length=="number"&&x.context_length>0?x.context_length:void 0).filter(x=>typeof x=="number"),h=m.length>0?Math.min(...m):Gy,g=Xs;g>=h&&(g=Math.min(h/2,Xs)),g=Math.floor(Math.max(1,Math.min(g,h-1024)));let v=Math.max(1,h-g),k={toolCalling:!0,imageInput:d};f.push({id:`${s.id}:cheapest`,name:`${s.id} (cheapest)`,tooltip:"Hugging Face via the cheapest provider",family:"huggingface",version:"1.0.0",maxInputTokens:v,maxOutputTokens:g,capabilities:k}),f.push({id:`${s.id}:fastest`,name:`${s.id} (fastest)`,tooltip:"Hugging Face via the fastest provider",family:"huggingface",version:"1.0.0",maxInputTokens:v,maxOutputTokens:g,capabilities:k})}for(let m of p){let h=m?.context_length??Gy,g=Xs;g>=h&&(g=Math.min(h/2,Xs)),g=Math.floor(Math.max(1,Math.min(g,h-1024)));let v=Math.max(1,h-g);f.push({id:`${s.id}:${m.provider}`,name:`${s.id} via ${m.provider}`,tooltip:`Hugging Face via ${m.provider}`,family:"huggingface",version:"1.0.0",maxInputTokens:v,maxOutputTokens:g,capabilities:{toolCalling:!0,imageInput:d}})}if(p.length===0&&c.length>0){let h=c[0]?.context_length??Gy,g=Xs;g>=h&&(g=Math.min(h/2,Xs)),g=Math.floor(Math.max(1,Math.min(g,h-1024)));let v=Math.max(1,h-g);f.push({id:s.id,name:s.id,tooltip:"Hugging Face",family:"huggingface",version:"1.0.0",maxInputTokens:v,maxOutputTokens:g,capabilities:{toolCalling:!1,imageInput:d}})}return f}),a=this.dedupeModelInfos(i);return this._chatEndpoints=a.map(s=>({model:s.id,modelMaxPromptTokens:s.maxInputTokens+s.maxOutputTokens})),a}async provideLanguageModelChatInformation(e,t){return this.prepareLanguageModelChatInformation({silent:e.silent??!1},t)}async fetchModels(e){let t=(async()=>{let o=this.providerConfig.baseUrl||AP,r=await fetch(`${o}/models`,{method:"GET",headers:{Authorization:`Bearer ${e}`,"User-Agent":this.userAgent}});if(!r.ok){let a="";try{a=await r.text()}catch(c){u.error("[Hugging Face Model Provider] Failed to read response text",c)}let s=new Error(`Failed to fetch Hugging Face models: ${r.status} ${r.statusText}${a?`
${a}`:""}`);throw u.error("[Hugging Face Model Provider] Failed to fetch Hugging Face models",s),s}return(await r.json()).data??[]})();try{return{models:await t}}catch(o){throw u.error("[Hugging Face Model Provider] Failed to fetch Hugging Face models",o),o}}async provideLanguageModelChatResponse(e,t,o,r,i){await Ie.getInstance(this.providerKey,2,1e3).throttle(this.providerConfig.displayName);try{let a=await this.ensureApiKey(!0);if(!a)throw new Error("Hugging Face API key not found");if($n(t),o.tools&&o.tools.length>128)throw new Error("Cannot have more than 128 tools per request.");let s=this.estimateMessagesTokens(t),c=o.tools?this.estimateToolTokens(this.openaiHandler.convertToolsToOpenAI([...o.tools])):0,l=Math.max(1,e.maxInputTokens);if(s+c>l)throw u.error("[Hugging Face Model Provider] Message exceeds token limit",{total:s+c,tokenLimit:l}),new Error("Message exceeds token limit.");let d=await this.createOpenAIClient(a),p=this.providerConfig.models.find(b=>b.id===e.id),f=this.openaiHandler.convertMessagesToOpenAI(t,e.capabilities||void 0,p),m={model:e.id,messages:f,stream:!0,stream_options:{include_usage:!0},max_tokens:Math.min(o.modelOptions?.max_tokens||4096,e.maxOutputTokens),temperature:o.modelOptions?.temperature??L.getTemperature(),top_p:L.getTopP()};if(o.modelOptions){let b=o.modelOptions;(typeof b.stop=="string"||Array.isArray(b.stop))&&(m.stop=b.stop),typeof b.frequency_penalty=="number"&&(m.frequency_penalty=b.frequency_penalty),typeof b.presence_penalty=="number"&&(m.presence_penalty=b.presence_penalty)}o.tools&&o.tools.length>0&&e.capabilities?.toolCalling&&(m.tools=this.openaiHandler.convertToolsToOpenAI([...o.tools]),m.tool_choice="auto");let h=new AbortController;i.onCancellationRequested(()=>h.abort());let g=d.chat.completions.stream(m,{signal:h.signal}),v=null,k="",x=!1,y=!1,w=new Map;if(g.on("chunk",b=>{if(!i.isCancellationRequested&&b.choices&&b.choices.length>0)for(let C of b.choices){if(C.delta?.tool_calls)for(let M of C.delta.tool_calls)M.id&&M.index!==void 0&&w.set(M.index,M.id);let I=C.delta,$=I?.reasoning??I?.reasoning_content;if($&&typeof $=="string"){v||(v=`hf_thinking_${Date.now()}_${Math.random().toString(36).slice(2,8)}`),k+=$;try{r.report(new Ct.LanguageModelThinkingPart(k,v)),k="",y=!0}catch(M){u.warn("[Hugging Face] Failed to report thinking",M instanceof Error?M.message:String(M))}}}}),g.on("content",b=>{if(!i.isCancellationRequested&&b&&typeof b=="string"&&b.trim().length>0){if(v){try{r.report(new Ct.LanguageModelThinkingPart("",v))}catch{}v=null}try{r.report(new Ct.LanguageModelTextPart(b)),x=!0}catch(C){u.warn("[Hugging Face] Failed to report content",C instanceof Error?C.message:String(C))}}}),g.on("tool_calls.function.arguments.done",b=>{if(i.isCancellationRequested)return;if(v){try{r.report(new Ct.LanguageModelThinkingPart("",v))}catch{}v=null}let C=w.get(b.index)||`tool_call_${b.index}_${Date.now()}`,I={};if(b.parsed_arguments){let $=b.parsed_arguments;I=typeof $=="object"&&$!==null?$:{}}else try{I=JSON.parse(b.arguments||"{}")}catch{I={value:b.arguments}}try{r.report(new Ct.LanguageModelToolCallPart(C,b.name,I)),x=!0}catch($){u.warn("[Hugging Face] Failed to report tool call",$ instanceof Error?$.message:String($))}}),await g.finalChatCompletion(),v)try{r.report(new Ct.LanguageModelThinkingPart("",v))}catch{}y&&!x&&(r.report(new Ct.LanguageModelTextPart("<think/>")),u.warn("[Hugging Face] End of message stream has only thinking content and no text content, added <think/> placeholder as output"))}catch(a){throw u.error("[Hugging Face Model Provider] Chat request failed",{modelId:e.id,messageCount:t.length,error:a instanceof Error?{name:a.name,message:a.message}:String(a)}),a}}async createOpenAIClient(e){let t=this.providerConfig.baseUrl||AP,o=`huggingface:${t}`,r=this.clientCache.get(o);if(r)return r.lastUsed=Date.now(),r.client;let i=new G({apiKey:e,baseURL:t,defaultHeaders:{"User-Agent":this.userAgent},maxRetries:2,timeout:6e4});return this.clientCache.set(o,{client:i,lastUsed:Date.now()}),i}async provideTokenCount(e,t,o){return he.getInstance().countTokens(e,t)}async ensureApiKey(e){let t=await R.getApiKey("huggingface");return!t&&!e&&(await R.promptAndSetApiKey("huggingface","Hugging Face","hf_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"),t=await R.getApiKey("huggingface")),t}static createAndActivate(e,t,o){u.trace(`${o.displayName} provider activated!`);let s=`better-copilot-chat/${Ct.extensions.getExtension("OEvortex.better-copilot-chat")?.packageJSON?.version??"unknown"} VSCode/${Ct.version}`,c=new n(e,t,o,s),l=Ct.lm.registerLanguageModelChatProvider(`chp.${t}`,c),d=Ct.commands.registerCommand(`chp.${t}.setApiKey`,async()=>{await De.startWizard({providerKey:t,displayName:o.displayName,apiKeyTemplate:o.apiKeyTemplate,supportsApiKey:!0,supportsBaseUrl:!0}),await c.modelInfoCache?.invalidateCache(t),c._onDidChangeLanguageModelChatInformation.fire(void 0)}),p=[l,d];for(let f of p)e.subscriptions.push(f);return{provider:c,disposables:p}}};var Ys=D(require("node:fs")),MP=D(require("node:path"));var ft=D(require("vscode"));Ke();ot();ce();var gm=D(require("vscode"));Ke();ce();var fu=class n{static PROVIDER_KEY="lightningai";static async startWizard(e,t){try{let o=await gm.window.showQuickPick([{label:`$(key) Configure ${e} API Key`,detail:"Format: APIKey/Username/StudioName (e.g., 26e4d40e.../abhay/vision-model)",action:"updateApiKey"},{label:"$(globe) Configure Base URL (Proxy)",detail:`Override ${e} endpoint (optional)`,action:"baseUrl"}],{title:`${e} Configuration Menu`,placeHolder:"Select action to perform"});if(!o){u.debug("User cancelled Lightning AI configuration wizard");return}o.action==="updateApiKey"&&await n.showSetApiKeyStep(e,t),o.action==="baseUrl"&&await De.configureBaseUrl("lightningai",e)}catch(o){u.error(`Lightning AI configuration wizard error: ${o instanceof Error?o.message:"Unknown error"}`)}}static async showSetApiKeyStep(e,t){let o=await gm.window.showInputBox({prompt:`Enter ${e} API Key in format: APIKey/Username/StudioName`,title:`Set ${e} API Key`,placeHolder:"************************/abhay/vision-model",password:!0,validateInput:r=>!r||r.trim()===""?null:r.split("/").length!==3?"Invalid format. Expected: APIKey/Username/StudioName":null});if(o===void 0)return!1;try{return o.trim()===""?(u.info(`${e} API Key cleared`),await R.deleteApiKey(n.PROVIDER_KEY)):(await R.setApiKey(n.PROVIDER_KEY,o.trim()),u.info(`${e} API Key set`),gm.window.showInformationMessage(`${e} API Key set successfully.`)),!0}catch(r){return u.error(`API Key operation failed: ${r instanceof Error?r.message:"Unknown error"}`),!1}}};var Vy="https://lightning.ai/api/v1",Qy=16e3,PP=128e3,vm=class n extends Te{userAgent;extensionPath;configFilePath;clientCache=new Map;constructor(e,t,o,r,i){super(e,t,o),this.userAgent=r,this.extensionPath=i,this.configFilePath=MP.join(this.extensionPath,"src","providers","config","lightningai.json")}refreshHandlers(){this.clientCache&&this.clientCache.size>0&&(u.debug(`[LightningAI] Clearing ${this.clientCache.size} cached OpenAI clients due to config change`),this.clientCache.clear()),super.refreshHandlers()}estimateMessagesTokens(e){let t=0;for(let o of e)for(let r of o.content)r instanceof ft.LanguageModelTextPart&&(t+=Math.ceil(r.value.length/4));return t}estimateToolTokens(e){if(!e||e.length===0)return 0;try{let t=JSON.stringify(e);return Math.ceil(t.length/4)}catch{return 0}}async prepareLanguageModelChatInformation(e,t){let o=await this.ensureApiKey(e.silent??!0);if(!o)return this.providerConfig.models&&this.providerConfig.models.length>0?this.providerConfig.models.map(s=>this.modelConfigToInfo(s)):[];let r=[];try{r=await this.fetchModels(o),this.updateConfigFileAsync(r)}catch{return u.warn("[LightningAI] Failed to fetch models, using cached config"),this.providerConfig.models.map(c=>this.modelConfigToInfo(c))}let i=r.map(s=>{let c=s.architecture?.input_modalities??[],l=Array.isArray(c)&&c.includes("image"),d=!0,p=s.context_length??PP,f=s.max_tokens&&s.max_tokens>0?s.max_tokens:Qy;f>=p&&(f=Math.min(p/2,Qy)),f=Math.floor(Math.max(1,Math.min(f,p-1024)));let m=Math.max(1,p-f);return{id:s.id,name:s.name||s.id,tooltip:s.description||`${s.id} by Lightning AI`,family:s.id,version:"1.0.0",maxInputTokens:m,maxOutputTokens:f,capabilities:{toolCalling:d,imageInput:l}}}),a=this.dedupeModelInfos(i);return this._chatEndpoints=a.map(s=>({model:s.id,modelMaxPromptTokens:s.maxInputTokens+s.maxOutputTokens})),a}async provideLanguageModelChatInformation(e,t){return this.prepareLanguageModelChatInformation({silent:e.silent??!1},t)}async fetchModels(e){let t=this.providerConfig.baseUrl||Vy,o=await fetch(`${t}/models`,{method:"GET",headers:{Authorization:`Bearer ${e}`,"User-Agent":this.userAgent}});if(!o.ok){let i="";try{i=await o.text()}catch{}throw new Error(`Failed to fetch Lightning AI models: ${o.status} ${i}`)}return(await o.json()).data??[]}updateConfigFileAsync(e){(async()=>{try{if(!Ys.existsSync(this.configFilePath))return;let t=e.map(i=>{let a=i.architecture?.input_modalities??[],s=Array.isArray(a)&&a.includes("image"),c=i.context_length??PP,l=i.max_tokens&&i.max_tokens>0?i.max_tokens:Qy,d=Math.max(1,c-l);return{id:i.id,name:i.name||i.id,tooltip:i.description||`${i.id} by Lightning AI`,maxInputTokens:d,maxOutputTokens:l,model:i.id,capabilities:{toolCalling:!0,imageInput:s}}}),o;try{let i=Ys.readFileSync(this.configFilePath,"utf8");o=JSON.parse(i)}catch{o={displayName:"Lightning AI",baseUrl:Vy,apiKeyTemplate:"sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx",models:[]}}let r={...o,models:t};Ys.writeFileSync(this.configFilePath,JSON.stringify(r,null,4),"utf8"),u.info(`[LightningAI] Auto-updated config with ${t.length} models`)}catch(t){u.warn("[LightningAI] Background config update failed:",t)}})()}async provideLanguageModelChatResponse(e,t,o,r,i){await Ie.getInstance(this.providerKey,2,1e3).throttle(this.providerConfig.displayName);try{let a=await this.ensureApiKey(!0);if(!a)throw new Error("Lightning AI API key not found");if($n(t),o.tools&&o.tools.length>128)throw new Error("Cannot have more than 128 tools per request.");let s=this.estimateMessagesTokens(t),c=o.tools?mu({...o,tools:o.tools}):{},l=c.tools?this.estimateToolTokens(c.tools):0,d=Math.max(1,e.maxInputTokens);if(s+l>d)throw new Error("Message exceeds token limit.");let p=await this.createOpenAIClient(a),f=this.providerConfig.models.find(q=>q.model===e.id||q.id===e.id),m=this.openaiHandler.convertMessagesToOpenAI(t,e.capabilities||void 0,f),h={model:e.id,messages:m,stream:!0,stream_options:{include_usage:!0},max_tokens:Math.min(o.modelOptions?.max_tokens||4096,e.maxOutputTokens)},g=o.modelOptions?.temperature??L.getTemperature(),v=L.getTopP();if(g!==void 0&&g!==1?h.temperature=g:v!==void 0&&v!==1?h.top_p=v:h.temperature=g,o.modelOptions){let q=o.modelOptions;(typeof q.stop=="string"||Array.isArray(q.stop))&&(h.stop=q.stop),typeof q.frequency_penalty=="number"&&(h.frequency_penalty=q.frequency_penalty),typeof q.presence_penalty=="number"&&(h.presence_penalty=q.presence_penalty)}c.tools&&e.capabilities?.toolCalling&&(h.tools=c.tools,h.tool_choice=c.tool_choice);let k=new AbortController;i.onCancellationRequested(()=>k.abort());let x=p.chat.completions.stream(h,{signal:k.signal}),y=null,w="",b=!1,C=!1,I=new Map,$=new Set,M=new Map,A,z=(q,oe,fe)=>{let ie=q.startsWith("tool_call_")||q.startsWith("tool_call_legacy_"),K="";if(ie)try{K=JSON.stringify(fe)}catch{K=""}let Ve=ie?`${oe}:${K}`:`${q}:${oe}`;if(!$.has(Ve)){if($.add(Ve),y){try{r.report(new ft.LanguageModelThinkingPart("",y))}catch{}y=null}try{r.report(new ft.LanguageModelToolCallPart(q,oe,fe)),b=!0}catch(ue){u.warn("[LightningAI] Failed to report tool call",ue instanceof Error?ue.message:String(ue))}}},F=()=>{for(let[q,oe]of M.entries()){if(!oe.name)continue;let fe=oe.id||I.get(q)||`tool_call_${q}_${Date.now()}`,ie={};try{ie=JSON.parse(oe.arguments||"{}")}catch{ie={value:oe.arguments}}z(fe,oe.name,ie)}};if(x.on("chunk",q=>{if(!i.isCancellationRequested&&q.choices&&q.choices.length>0)for(let oe of q.choices){if(oe.delta?.tool_calls)for(let ue of oe.delta.tool_calls){ue.id&&ue.index!==void 0&&I.set(ue.index,ue.id);let Rt=ue.index??0,Ot=M.get(Rt)??{arguments:""};ue.id&&(Ot.id=ue.id);let ut=ue.function;ut?.name&&(Ot.name=ut.name),typeof ut?.arguments=="string"&&ut.arguments.length>0&&(Ot.arguments+=ut.arguments),M.set(Rt,Ot)}let fe=oe.delta?.function_call;fe&&(A=A??{arguments:""},fe.name&&(A.name=fe.name),typeof fe.arguments=="string"&&fe.arguments.length>0&&(A.arguments+=fe.arguments));let ie=oe.delta,K=ie?.reasoning??ie?.reasoning_content;if(K&&typeof K=="string"){y||(y=`lightningai_thinking_${Date.now()}_${Math.random().toString(36).slice(2,8)}`),w+=K;try{r.report(new ft.LanguageModelThinkingPart(w,y)),w="",C=!0}catch{}}let Ve=oe?.finish_reason;if(Ve==="tool_calls"&&F(),Ve==="function_call"&&A?.name){let ue={};try{ue=JSON.parse(A.arguments||"{}")}catch{ue={value:A.arguments}}let Rt=`tool_call_legacy_${Date.now()}`;z(Rt,A.name,ue)}}}),x.on("content",q=>{if(!i.isCancellationRequested&&q&&typeof q=="string"&&q.trim().length>0){if(y){try{r.report(new ft.LanguageModelThinkingPart("",y))}catch{}y=null}try{r.report(new ft.LanguageModelTextPart(q)),b=!0}catch{}}}),x.on("tool_calls.function.arguments.done",q=>{if(i.isCancellationRequested)return;let oe=I.get(q.index)||`tool_call_${q.index}_${Date.now()}`,fe={};if(q.parsed_arguments){let ie=q.parsed_arguments;fe=typeof ie=="object"&&ie!==null?ie:{}}else try{fe=JSON.parse(q.arguments||"{}")}catch{fe={value:q.arguments}}z(oe,q.name,fe)}),await x.finalChatCompletion(),F(),y)try{r.report(new ft.LanguageModelThinkingPart("",y))}catch{}C&&!b&&r.report(new ft.LanguageModelTextPart("<think/>"))}catch(a){if(!(i.isCancellationRequested||a instanceof Error&&a.name==="AbortError")){if(a instanceof Error&&a.status===402)throw u.warn(`[LightningAI] Quota exceeded (402) for model ${e.id}`),new Error(`Lightning AI quota exceeded for model ${e.id}. Please check your account balance or try again later.`);if(a instanceof Error&&a.status===401)throw u.warn(`[LightningAI] Authentication failed (401) for model ${e.id}`),new Error("Lightning AI authentication failed. Please check your API key format (APIKey/Username/StudioName) and try again.");u.error("[LightningAI] Chat request failed",a instanceof Error?a.message:String(a))}throw a}finally{this.incrementRequestCount()}}incrementRequestCount(){let e=new Date().toDateString(),t=this.providerKey,o=this.context?.globalState.get(`${t}.requestCount`)||0;this.context?.globalState.get(`${t}.lastResetDate`)!==e?(o=1,this.context?.globalState.update(`${t}.lastResetDate`,e)):o++,this.context?.globalState.update(`${t}.requestCount`,o),u.debug(`[LightningAI] Global request count: ${o}`)}async createOpenAIClient(e){let t=this.providerConfig.baseUrl||Vy,o=`lightningai:${t}`,r=this.clientCache.get(o);if(r)return r.lastUsed=Date.now(),r.client;let i=new G({apiKey:e,baseURL:t,defaultHeaders:{"User-Agent":this.userAgent},maxRetries:2,timeout:6e4});return this.clientCache.set(o,{client:i,lastUsed:Date.now()}),i}async provideTokenCount(e,t,o){return he.getInstance().countTokens(e,t)}async ensureApiKey(e){let t=await R.getApiKey(this.providerKey);return!t&&!e&&(await R.promptAndSetApiKey(this.providerKey,this.providerConfig.displayName,this.providerConfig.apiKeyTemplate),t=await R.getApiKey(this.providerKey)),t}static createAndActivate(e,t,o){u.trace(`${o.displayName} provider activated!`);let s=`better-copilot-chat/${ft.extensions.getExtension("OEvortex.better-copilot-chat")?.packageJSON?.version??"unknown"} VSCode/${ft.version}`,c=new n(e,t,o,s,e.extensionPath),l=ft.lm.registerLanguageModelChatProvider(`chp.${t}`,c),d=ft.commands.registerCommand(`chp.${t}.setApiKey`,async()=>{await fu.startWizard(o.displayName,o.apiKeyTemplate),await c.modelInfoCache?.invalidateCache(t),c._onDidChangeLanguageModelChatInformation.fire(void 0)}),p=ft.commands.registerCommand(`chp.${t}.configWizard`,async()=>{await fu.startWizard(o.displayName,o.apiKeyTemplate)}),f=[l,d,p];for(let m of f)e.subscriptions.push(m);return{provider:c,disposables:f}}};var Yi=D(require("vscode"));var ym=class n extends Te{static createAndActivate(e,t,o){u.trace(`${o.displayName} dedicated model extension activated!`);let r=new n(e,t,o),i=Yi.lm.registerLanguageModelChatProvider(`chp.${t}`,r),a=Yi.commands.registerCommand(`chp.${t}.setApiKey`,async()=>{await Vn.startWizard(o.displayName,o.apiKeyTemplate),await r.modelInfoCache?.invalidateCache(t),r._onDidChangeLanguageModelChatInformation.fire()}),s=Yi.commands.registerCommand(`chp.${t}.setCodingPlanApiKey`,async()=>{await Vn.setCodingPlanApiKey(o.displayName,o.apiKeyTemplate),await r.modelInfoCache?.invalidateCache("minimax-coding"),r._onDidChangeLanguageModelChatInformation.fire()}),c=Yi.commands.registerCommand(`chp.${t}.setCodingPlanEndpoint`,async()=>{u.info(`User manually opens ${o.displayName} Coding Plan endpoint selection`),await Vn.setCodingPlanEndpoint(o.displayName)}),l=Yi.commands.registerCommand(`chp.${t}.configWizard`,async()=>{u.info(`Start ${o.displayName} configuration wizard`),await Vn.startWizard(o.displayName,o.apiKeyTemplate)}),d=[i,a,s,c,l];for(let p of d)e.subscriptions.push(p);return{provider:r,disposables:d}}getProviderKeyForModel(e){return e.provider?e.provider:this.providerKey}async ensureApiKeyForModel(e){let t=this.getProviderKeyForModel(e),o=t==="minimax-coding",r=o?"Coding Plan Dedicated":"Normal";if(await R.hasValidApiKey(t)){let s=await R.getApiKey(t);if(s)return s}u.warn(`Model ${e.name} lacks ${r} API key, entering setup process`),o?await Vn.setCodingPlanApiKey(this.providerConfig.displayName,this.providerConfig.apiKeyTemplate):await Vn.setNormalApiKey(this.providerConfig.displayName,this.providerConfig.apiKeyTemplate);let a=await R.getApiKey(t);if(a)return u.info(`${r} key setup successful`),a;throw new Error(`${this.providerConfig.displayName}: User has not set ${r} API key`)}async provideLanguageModelChatInformation(e,t){let o=await R.hasValidApiKey(this.providerKey),r=await R.hasValidApiKey("minimax-coding"),i=o||r;if(e.silent&&!i)return u.debug(`${this.providerConfig.displayName}: In silent mode, no keys detected, returning empty model list`),[];if(!e.silent&&!i){u.info(`${this.providerConfig.displayName}: Detected no keys configured, starting configuration wizard`),await Vn.startWizard(this.providerConfig.displayName,this.providerConfig.apiKeyTemplate);let c=await R.hasValidApiKey(this.providerKey),l=await R.hasValidApiKey("minimax-coding");if(!c&&!l)return u.warn(`${this.providerConfig.displayName}: User has not set any keys, returning empty model list`),[]}u.debug(`${this.providerConfig.displayName}: Return all ${this.providerConfig.models.length} models`);let a=this.providerConfig.models.map(c=>this.modelConfigToInfo(c));if(L.getRememberLastModel()){let c=this.modelInfoCache?.getLastSelectedModel(this.providerKey);c&&(a=a.map(l=>({...l,isDefault:l.id===c})))}return a}async provideLanguageModelChatResponse(e,t,o,r,i){await Ie.getInstance(this.providerKey,2,1e3).throttle(this.providerConfig.displayName),L.getRememberLastModel()&&this.modelInfoCache?.saveLastSelectedModel(this.providerKey,e.id).catch(f=>u.warn(`[${this.providerKey}] Failed to save model selection:`,f));let s=this.providerConfig.models.find(f=>f.id===e.id);if(!s){let f=`Model not found: ${e.id}`;throw u.error(f),new Error(f)}let c=this.getProviderKeyForModel(s);if(!await this.ensureApiKeyForModel(s)){let f=c==="minimax-coding"?"Coding Plan Dedicated":"Normal";throw new Error(`${this.providerConfig.displayName}: Invalid ${f} API key`)}u.info(`${this.providerConfig.displayName}: About to process request, using ${c==="minimax-coding"?"Coding Plan":"Normal"} key - model: ${s.name}`);let d=s.sdkMode||"openai",p=d==="anthropic"?"Anthropic SDK":"OpenAI SDK";u.info(`${this.providerConfig.displayName} Provider starts processing request (${p}): ${s.name}`);try{d==="anthropic"?await this.anthropicHandler.handleRequest(e,s,t,o,r,i):await this.openaiHandler.handleRequest(e,s,t,o,r,i)}catch(f){let m=`Error: ${f instanceof Error?f.message:"Unknown error"}`;throw u.error(m),f}finally{u.info(`${this.providerConfig.displayName}: ${e.name} Request completed`)}}async provideTokenCount(e,t,o){return he.getInstance().countTokens(e,t)}};var bm=D(require("vscode"));var xm=class n extends Te{mistralHandler;constructor(e,t,o){super(e,t,o),this.mistralHandler=new ol(t,o.displayName,o.baseUrl)}static createAndActivate(e,t,o){u.trace(`${o.displayName} dedicated model extension activated!`);let r=new n(e,t,o),i=bm.lm.registerLanguageModelChatProvider(`chp.${t}`,r),a=bm.commands.registerCommand(`chp.${t}.setApiKey`,async()=>{await De.startWizard({providerKey:t,displayName:o.displayName,apiKeyTemplate:o.apiKeyTemplate,supportsApiKey:!0,supportsBaseUrl:!0}),await r.modelInfoCache?.invalidateCache(t),r._onDidChangeLanguageModelChatInformation.fire()}),s=[i,a];for(let c of s)e.subscriptions.push(c);return{provider:r,disposables:s}}async provideLanguageModelChatResponse(e,t,o,r,i){u.info(`[Mistral] Starting request for model: ${e.name}`),L.getRememberLastModel()&&this.modelInfoCache?.saveLastSelectedModel(this.providerKey,e.id).catch(c=>u.warn(`[${this.providerKey}] Failed to save model selection:`,c));let a=this.providerConfig.models.find(c=>c.id===e.id);if(!a){let c=`Model not found: ${e.id}`;throw u.error(c),new Error(c)}let s=a.provider||this.providerKey;try{let c=this.accountManager.getAccountsByProvider(s),l=this.accountManager.getLoadBalanceEnabled(s),d=this.accountManager.getAccountIdForModel(s,e.id);if(c.length===0){await R.ensureApiKey(s,this.providerConfig.displayName),u.info(`${this.providerConfig.displayName} Provider starts processing request (fallback mode): ${a.name}`),await this.mistralHandler.handleRequest(e,a,t,o,r,i);return}let p=c.filter(x=>x.status==="active").length>0?c.filter(x=>x.status==="active"):c,f=this.buildAccountCandidates(e.id,p,d,l,s),m=this.accountManager.getActiveAccount(s),h=l?f.filter(x=>!this.accountManager.isAccountQuotaLimited(x.id)):f,g;h.length>0?m&&h.some(x=>x.id===m.id)?g=[m,...h.filter(x=>x.id!==m.id)]:g=h:m&&f.some(x=>x.id===m.id)?g=[m,...f.filter(x=>x.id!==m.id)]:g=f,u.debug(`[${s}] Active account: ${m?.displayName||"none"}, accountsToTry: ${g.map(x=>x.displayName).join(", ")}`);let v,k=!1;for(let x of g){let y=await this.accountManager.getCredentials(x.id);if(!y){v=new Error(`Missing credentials for ${x.displayName}`);continue}let w={...a,apiKey:"apiKey"in y?y.apiKey:void 0,baseUrl:"endpoint"in y?y.endpoint:void 0,customHeader:"customHeaders"in y?y.customHeaders:void 0};"accessToken"in y&&(w.accessToken=y.accessToken,w.apiKey=y.accessToken);try{u.info(`${this.providerConfig.displayName}: ${e.name} using account "${x.displayName}" (ID: ${x.id})`),await this.mistralHandler.handleRequest(e,w,t,o,r,i,x.id),this.lastUsedAccountByModel.set(e.id,x.id),k&&(u.info(`[${s}] Saving account "${x.displayName}" as preferred for model ${e.id}`),await this.accountManager.setAccountForModel(s,e.id,x.id));return}catch(b){if(k=!0,this.isLongTermQuotaExhausted(b)){if(l){u.warn(`[${s}] Account ${x.displayName} quota exhausted, switching...`),v=b;continue}throw b}if(l&&this.isQuotaError(b)){u.warn(`[${s}] Account ${x.displayName} rate limited, switching...`),v=b;continue}throw b}}throw v||new Error(`No available accounts for ${s}`)}catch(c){throw u.error(`[Mistral] Request failed: ${c instanceof Error?c.message:String(c)}`),c}finally{u.info(`${this.providerConfig.displayName}: ${e.name} Request completed`)}}async provideTokenCount(e,t,o){return he.getInstance().countTokens(e,t)}};var Et=D(require("vscode"));Ke();ot();ce();var Hq=16e3,Zq=128e3,hu=class n extends Te{userAgent;clientCache=new Map;constructor(e,t,o,r){super(e,t,o),this.userAgent=r}refreshHandlers(){this.clientCache&&this.clientCache.size>0&&(u.debug(`[Ollama] Clearing ${this.clientCache.size} cached OpenAI clients due to config change`),this.clientCache.clear()),super.refreshHandlers()}async prepareLanguageModelChatInformation(e,t){if(!await this.ensureApiKey(e.silent??!0))return[];let r=this.providerConfig.models.map(i=>{let a={toolCalling:i.capabilities?.toolCalling??!1,imageInput:i.capabilities?.imageInput??!1};return{id:i.id,name:i.name,tooltip:i.name||"Ollama",family:"ollama",version:"1.0.0",maxInputTokens:i.maxInputTokens||Zq,maxOutputTokens:i.maxOutputTokens||Hq,capabilities:a}});return this._chatEndpoints=r.map(i=>({model:i.id,modelMaxPromptTokens:i.maxInputTokens+i.maxOutputTokens})),r}async provideLanguageModelChatInformation(e,t){return this.prepareLanguageModelChatInformation({silent:e.silent??!1},t)}async provideLanguageModelChatResponse(e,t,o,r,i){await Ie.getInstance(this.providerKey,2,1e3).throttle(this.providerConfig.displayName);try{L.getRememberLastModel()&&this.modelInfoCache?.saveLastSelectedModel(this.providerKey,e.id).catch(y=>u.warn("[Ollama] Failed to save model selection",y instanceof Error?y.message:String(y)));let s=await this.ensureApiKey(!1);if(!s)throw new Error("Ollama API key not found");if(o.tools&&o.tools.length>128)throw new Error("Cannot have more than 128 tools per request.");let c=this.providerConfig.models.find(y=>y.id===e.id),l=await this.createOpenAIClient(s,c),d=this.openaiHandler.convertMessagesToOpenAI(t,e.capabilities||void 0,c),p={model:e.id,messages:d,stream:!0,stream_options:{include_usage:!0},max_tokens:Math.min(o.modelOptions?.max_tokens||4096,e.maxOutputTokens),temperature:o.modelOptions?.temperature??L.getTemperature(),top_p:L.getTopP()};if(o.modelOptions){let y=o.modelOptions;(typeof y.stop=="string"||Array.isArray(y.stop))&&(p.stop=y.stop),typeof y.frequency_penalty=="number"&&(p.frequency_penalty=y.frequency_penalty),typeof y.presence_penalty=="number"&&(p.presence_penalty=y.presence_penalty)}o.tools&&o.tools.length>0&&e.capabilities?.toolCalling&&(p.tools=this.openaiHandler.convertToolsToOpenAI([...o.tools]),p.tool_choice="auto");let f=new AbortController;i.onCancellationRequested(()=>f.abort());let m=l.chat.completions.stream(p,{signal:f.signal}),h=null,g="",v=!1,k=!1,x=new Map;m.on("chunk",y=>{if(!i.isCancellationRequested&&y.choices&&y.choices.length>0)for(let w of y.choices){if(w.delta?.tool_calls)for(let I of w.delta.tool_calls)I.id&&I.index!==void 0&&x.set(I.index,I.id);let b=w.delta,C=b?.reasoning??b?.reasoning_content;if(C&&typeof C=="string"){h||(h=`ollama_thinking_${Date.now()}_${Math.random().toString(36).slice(2,8)}`),g+=C;try{r.report(new Et.LanguageModelThinkingPart(g,h)),g="",k=!0}catch(I){u.warn("[Ollama] Failed to report thinking",I instanceof Error?I.message:String(I))}}}}),m.on("content",y=>{if(!i.isCancellationRequested&&y&&typeof y=="string"&&y.trim().length>0){if(h){try{r.report(new Et.LanguageModelThinkingPart("",h))}catch{}h=null}try{r.report(new Et.LanguageModelTextPart(y)),v=!0}catch(w){u.warn("[Ollama] Failed to report content",w instanceof Error?w.message:String(w))}}}),m.on("tool_calls.function.arguments.done",y=>{if(i.isCancellationRequested)return;if(h){try{r.report(new Et.LanguageModelThinkingPart("",h))}catch{}h=null}let w=x.get(y.index)||`tool_call_${y.index}_${Date.now()}`,b={};if(y.parsed_arguments){let C=y.parsed_arguments;b=typeof C=="object"&&C!==null?C:{}}else try{b=JSON.parse(y.arguments||"{}")}catch{b={value:y.arguments}}try{r.report(new Et.LanguageModelToolCallPart(w,y.name,b)),v=!0}catch(C){u.warn("[Ollama] Failed to report tool call",C instanceof Error?C.message:String(C))}});try{await m.finalChatCompletion()}catch(y){if(y instanceof Error&&y.message.includes("missing finish_reason"))u.debug("[Ollama] Stream completed without finish_reason, ignoring error");else throw y}if(h)try{r.report(new Et.LanguageModelThinkingPart("",h))}catch{}k&&!v&&(r.report(new Et.LanguageModelTextPart("<think/>")),u.warn("[Ollama] End of message stream has only thinking content and no text content, added <think/> placeholder as output"))}catch(a){throw u.error("[Ollama] Chat request failed",a instanceof Error?a.message:String(a)),a}}async createOpenAIClient(e,t){let o=t?.baseUrl||this.providerConfig.baseUrl||"http://localhost:11434/v1",r=`ollama:${o}`,i=this.clientCache.get(r);if(i)return i.lastUsed=Date.now(),i.client;let a=new G({apiKey:e,baseURL:o,defaultHeaders:{"User-Agent":this.userAgent},maxRetries:2,timeout:6e4});return this.clientCache.set(r,{client:a,lastUsed:Date.now()}),a}async provideTokenCount(e,t,o){return he.getInstance().countTokens(e,t)}async ensureApiKey(e){let t=await R.getApiKey(this.providerKey);return!t&&!e&&(await R.promptAndSetApiKey(this.providerKey,this.providerConfig.displayName,this.providerConfig.apiKeyTemplate),t=await R.getApiKey(this.providerKey)),t}static createAndActivate(e,t,o){u.trace(`${o.displayName} provider activated!`);let s=`better-copilot-chat/${Et.extensions.getExtension("OEvortex.better-copilot-chat")?.packageJSON?.version??"unknown"} VSCode/${Et.version}`,c=new n(e,t,o,s),l=Et.lm.registerLanguageModelChatProvider(`chp.${t}`,c),d=Et.commands.registerCommand(`chp.${t}.setApiKey`,async()=>{await De.startWizard({providerKey:t,displayName:o.displayName,apiKeyTemplate:o.apiKeyTemplate,supportsApiKey:!0,supportsBaseUrl:!0}),await c.modelInfoCache?.invalidateCache(t),c._onDidChangeLanguageModelChatInformation.fire(void 0)}),p=[l,d];for(let f of p)e.subscriptions.push(f);return{provider:c,disposables:p}}};var ec=D(require("node:fs")),$P=D(require("node:path"));var Tt=D(require("vscode"));Ke();ot();ce();var Wy="https://opencode.ai/zen/v1",Jy=16e3,SP=128e3,wm=class n extends Te{userAgent;extensionPath;configFilePath;clientCache=new Map;constructor(e,t,o,r,i){super(e,t,o),this.userAgent=r,this.extensionPath=i,this.configFilePath=$P.join(this.extensionPath,"src","providers","config","opencode.json")}refreshHandlers(){this.clientCache&&this.clientCache.size>0&&(u.debug(`[OpenCode] Clearing ${this.clientCache.size} cached OpenAI clients due to config change`),this.clientCache.clear()),super.refreshHandlers()}estimateMessagesTokens(e){let t=0;for(let o of e)for(let r of o.content)r instanceof Tt.LanguageModelTextPart&&(t+=Math.ceil(r.value.length/4));return t}estimateToolTokens(e){if(!e||e.length===0)return 0;try{let t=JSON.stringify(e);return Math.ceil(t.length/4)}catch{return 0}}async prepareLanguageModelChatInformation(e,t){let o=await this.ensureApiKey(e.silent??!0);if(!o)return this.providerConfig.models&&this.providerConfig.models.length>0?this.providerConfig.models.map(s=>this.modelConfigToInfo(s)):[];let r=[];try{r=await this.fetchModels(o),this.updateConfigFileAsync(r)}catch{return u.warn("[OpenCode] Failed to fetch models, using cached config"),this.providerConfig.models.map(c=>this.modelConfigToInfo(c))}let i=r.map(s=>{let c=s.input_modalities??[],l=Array.isArray(c)&&c.includes("image"),d=!0,p=s.context_length??SP,f=s.max_output_length??Jy;f>=p&&(f=Math.min(p/2,Jy)),f=Math.floor(Math.max(1,Math.min(f,p-1024)));let m=Math.max(1,p-f);return{id:s.id,name:s.id,tooltip:`${s.id} by OpenCode`,family:s.id,version:"1.0.0",maxInputTokens:m,maxOutputTokens:f,capabilities:{toolCalling:d,imageInput:l}}}),a=this.dedupeModelInfos(i);return this._chatEndpoints=a.map(s=>({model:s.id,modelMaxPromptTokens:s.maxInputTokens+s.maxOutputTokens})),a}async provideLanguageModelChatInformation(e,t){return this.prepareLanguageModelChatInformation({silent:e.silent??!1},t)}async fetchModels(e){let t=this.providerConfig.baseUrl||Wy,o=await fetch(`${t}/models`,{method:"GET",headers:{Authorization:`Bearer ${e}`,"User-Agent":this.userAgent}});if(!o.ok){let i="";try{i=await o.text()}catch{}throw new Error(`Failed to fetch OpenCode models: ${o.status} ${i}`)}return(await o.json()).data??[]}updateConfigFileAsync(e){(async()=>{try{if(!ec.existsSync(this.configFilePath))return;let t=e.map(i=>{let a=i.input_modalities??[],s=Array.isArray(a)&&a.includes("image"),c=i.context_length??SP,l=i.max_output_length??Jy,d=Math.max(1,c-l);return{id:i.id,name:i.id,tooltip:`${i.id} by OpenCode`,maxInputTokens:d,maxOutputTokens:l,model:i.id,capabilities:{toolCalling:!0,imageInput:s}}}),o;try{let i=ec.readFileSync(this.configFilePath,"utf8");o=JSON.parse(i)}catch{o={displayName:"OpenCode",baseUrl:Wy,apiKeyTemplate:"sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx",models:[]}}let r={...o,models:t};ec.writeFileSync(this.configFilePath,JSON.stringify(r,null,4),"utf8"),u.info(`[OpenCode] Auto-updated config with ${t.length} models`)}catch(t){u.warn("[OpenCode] Background config update failed:",t)}})()}async provideLanguageModelChatResponse(e,t,o,r,i){await Ie.getInstance(this.providerKey,2,1e3).throttle(this.providerConfig.displayName);try{let a=await this.ensureApiKey(!0);if(!a)throw new Error("OpenCode API key not found");if($n(t),o.tools&&o.tools.length>128)throw new Error("Cannot have more than 128 tools per request.");let s=this.estimateMessagesTokens(t),c=o.tools?this.estimateToolTokens(this.openaiHandler.convertToolsToOpenAI([...o.tools])):0,l=Math.max(1,e.maxInputTokens);if(s+c>l)throw new Error("Message exceeds token limit.");let d=await this.createOpenAIClient(a),p=this.providerConfig.models.find(A=>A.model===e.id||A.id===e.id),f=this.openaiHandler.convertMessagesToOpenAI(t,e.capabilities||void 0,p),m={model:e.id,messages:f,stream:!0,stream_options:{include_usage:!0},max_tokens:Math.min(o.modelOptions?.max_tokens||4096,e.maxOutputTokens),temperature:o.modelOptions?.temperature??L.getTemperature(),top_p:L.getTopP()};if(o.modelOptions){let A=o.modelOptions;(typeof A.stop=="string"||Array.isArray(A.stop))&&(m.stop=A.stop),typeof A.frequency_penalty=="number"&&(m.frequency_penalty=A.frequency_penalty),typeof A.presence_penalty=="number"&&(m.presence_penalty=A.presence_penalty)}o.tools&&o.tools.length>0&&e.capabilities?.toolCalling&&(m.tools=this.openaiHandler.convertToolsToOpenAI([...o.tools]),m.tool_choice="auto");let h=new AbortController;i.onCancellationRequested(()=>h.abort());let g=d.chat.completions.stream(m,{signal:h.signal}),v=null,k="",x=!1,y=!1,w=new Map,b=new Set,C=new Map,I,$=(A,z,F)=>{let q=A.startsWith("tool_call_")||A.startsWith("tool_call_legacy_"),oe="";if(q)try{oe=JSON.stringify(F)}catch{oe=""}let fe=q?`${z}:${oe}`:`${A}:${z}`;if(!b.has(fe)){if(b.add(fe),v){try{r.report(new Tt.LanguageModelThinkingPart("",v))}catch{}v=null}try{r.report(new Tt.LanguageModelToolCallPart(A,z,F)),x=!0}catch(ie){u.warn("[OpenCode] Failed to report tool call",ie instanceof Error?ie.message:String(ie))}}},M=()=>{for(let[A,z]of C.entries()){if(!z.name)continue;let F=z.id||w.get(A)||`tool_call_${A}_${Date.now()}`,q={};try{q=JSON.parse(z.arguments||"{}")}catch{q={value:z.arguments}}$(F,z.name,q)}};if(g.on("chunk",A=>{if(!i.isCancellationRequested&&A.choices&&A.choices.length>0)for(let z of A.choices){if(z.delta?.tool_calls)for(let ie of z.delta.tool_calls){ie.id&&ie.index!==void 0&&w.set(ie.index,ie.id);let K=ie.index??0,Ve=C.get(K)??{arguments:""};ie.id&&(Ve.id=ie.id);let ue=ie.function;ue?.name&&(Ve.name=ue.name),typeof ue?.arguments=="string"&&ue.arguments.length>0&&(Ve.arguments+=ue.arguments),C.set(K,Ve)}let F=z.delta?.function_call;F&&(I=I??{arguments:""},F.name&&(I.name=F.name),typeof F.arguments=="string"&&F.arguments.length>0&&(I.arguments+=F.arguments));let q=z.delta,oe=q?.reasoning??q?.reasoning_content;if(oe&&typeof oe=="string"){v||(v=`opencode_thinking_${Date.now()}_${Math.random().toString(36).slice(2,8)}`),k+=oe;try{r.report(new Tt.LanguageModelThinkingPart(k,v)),k="",y=!0}catch{}}let fe=z?.finish_reason;if(fe==="tool_calls"&&M(),fe==="function_call"&&I?.name){let ie={};try{ie=JSON.parse(I.arguments||"{}")}catch{ie={value:I.arguments}}let K=`tool_call_legacy_${Date.now()}`;$(K,I.name,ie)}}}),g.on("content",A=>{if(!i.isCancellationRequested&&A&&typeof A=="string"&&A.trim().length>0){if(v){try{r.report(new Tt.LanguageModelThinkingPart("",v))}catch{}v=null}try{r.report(new Tt.LanguageModelTextPart(A)),x=!0}catch{}}}),g.on("tool_calls.function.arguments.done",A=>{if(i.isCancellationRequested)return;let z=w.get(A.index)||`tool_call_${A.index}_${Date.now()}`,F={};if(A.parsed_arguments){let q=A.parsed_arguments;F=typeof q=="object"&&q!==null?q:{}}else try{F=JSON.parse(A.arguments||"{}")}catch{F={value:A.arguments}}$(z,A.name,F)}),await g.finalChatCompletion(),M(),v)try{r.report(new Tt.LanguageModelThinkingPart("",v))}catch{}y&&!x&&r.report(new Tt.LanguageModelTextPart("<think/>"))}catch(a){throw i.isCancellationRequested||a instanceof Error&&a.name==="AbortError"||u.error("[OpenCode] Chat request failed",a instanceof Error?a.message:String(a)),a}finally{this.incrementRequestCount()}}incrementRequestCount(){let e=new Date().toDateString(),t=this.providerKey,o=this.context?.globalState.get(`${t}.requestCount`)||0;this.context?.globalState.get(`${t}.lastResetDate`)!==e?(o=1,this.context?.globalState.update(`${t}.lastResetDate`,e)):o++,this.context?.globalState.update(`${t}.requestCount`,o),u.debug(`[OpenCode] Global request count: ${o}`)}async createOpenAIClient(e){let t=this.providerConfig.baseUrl||Wy,o=`opencode:${t}`,r=this.clientCache.get(o);if(r)return r.lastUsed=Date.now(),r.client;let i=new G({apiKey:e,baseURL:t,defaultHeaders:{"User-Agent":this.userAgent},maxRetries:2,timeout:6e4});return this.clientCache.set(o,{client:i,lastUsed:Date.now()}),i}async provideTokenCount(e,t,o){return he.getInstance().countTokens(e,t)}async ensureApiKey(e){let t=await R.getApiKey(this.providerKey);return!t&&!e&&(await R.promptAndSetApiKey(this.providerKey,this.providerConfig.displayName,this.providerConfig.apiKeyTemplate),t=await R.getApiKey(this.providerKey)),t}static createAndActivate(e,t,o){u.trace(`${o.displayName} provider activated!`);let s=`better-copilot-chat/${Tt.extensions.getExtension("OEvortex.better-copilot-chat")?.packageJSON?.version??"unknown"} VSCode/${Tt.version}`,c=new n(e,t,o,s,e.extensionPath),l=Tt.lm.registerLanguageModelChatProvider(`chp.${t}`,c),d=Tt.commands.registerCommand(`chp.${t}.setApiKey`,async()=>{await De.startWizard({providerKey:t,displayName:o.displayName,apiKeyTemplate:o.apiKeyTemplate,supportsApiKey:!0,supportsBaseUrl:!0}),await c.modelInfoCache?.invalidateCache(t),c._onDidChangeLanguageModelChatInformation.fire(void 0)}),p=[l,d];for(let f of p)e.subscriptions.push(f);return{provider:c,disposables:p}}};var ht=D(require("vscode"));ce();var ir=D(require("node:fs")),LP=D(require("node:os")),km=D(require("node:path"));ce();var EP="f0304373b74a44d2b584a3fb70ca9e56",RP="https://chat.qwen.ai/api/v1/oauth2/token",OP="https://dashscope.aliyuncs.com/compatible-mode/v1";var ea=class n{static instance;credentials=null;refreshPromise=null;refreshTimer=null;constructor(){this.startProactiveRefresh()}static getInstance(){return n.instance||(n.instance=new n),n.instance}startProactiveRefresh(){this.refreshTimer&&clearInterval(this.refreshTimer),this.refreshTimer=setInterval(async()=>{try{this.credentials&&!this.isTokenValid(this.credentials)&&(u.debug("Qwen CLI: Proactive token refresh triggered"),await this.refreshAccessToken(this.credentials))}catch(e){u.trace(`Qwen CLI: Proactive refresh failed: ${e}`)}},3e4)}getCredentialPath(){return km.join(LP.homedir(),".qwen","oauth_creds.json")}loadCachedCredentials(){let e=this.getCredentialPath();try{if(!ir.existsSync(e))throw new Error(`Qwen OAuth credentials not found at ${e}. Please login using the Qwen Code CLI first: qwen-code auth login`);let t=JSON.parse(ir.readFileSync(e,"utf-8"));return{access_token:t.access_token,refresh_token:t.refresh_token,token_type:t.token_type||"Bearer",expiry_date:t.expiry_date,resource_url:t.resource_url}}catch(t){throw t instanceof Error?t:new Error("Invalid Qwen OAuth credentials file")}}async refreshAccessToken(e){return this.refreshPromise?this.refreshPromise:(this.refreshPromise=(async()=>{try{if(!e.refresh_token)throw new Error("No refresh token available in credentials.");let t=new URLSearchParams;t.set("grant_type","refresh_token"),t.set("refresh_token",e.refresh_token),t.set("client_id",EP);let o=await fetch(RP,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded",Accept:"application/json","User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/131.0.0.0 Safari/537.36"},body:t.toString()});if(!o.ok){let a=await o.text();throw new Error(`Token refresh failed: ${o.status} ${o.statusText}. Response: ${a}`)}let r=await o.json();if(r.error)throw new Error(`Token refresh failed: ${r.error} - ${r.error_description||"Unknown error"}`);let i={access_token:r.access_token,token_type:r.token_type||"Bearer",refresh_token:r.refresh_token||e.refresh_token,expiry_date:Date.now()+r.expires_in*1e3,resource_url:e.resource_url};return this.saveCredentials(i),this.credentials=i,i}finally{this.refreshPromise=null}})(),this.refreshPromise)}saveCredentials(e){let t=this.getCredentialPath();try{let o=km.dirname(t);ir.existsSync(o)||ir.mkdirSync(o,{recursive:!0}),ir.writeFileSync(t,JSON.stringify(e,null,2),"utf-8")}catch(o){u.warn(`Failed to save refreshed credentials: ${o}`)}}isTokenValid(e){return e.expiry_date?Date.now()<e.expiry_date-3e4:!1}async ensureAuthenticated(e=!1){return this.credentials=this.loadCachedCredentials(),(e||!this.isTokenValid(this.credentials))&&(this.credentials=await this.refreshAccessToken(this.credentials)),{accessToken:this.credentials.access_token,baseURL:this.getBaseURL(this.credentials)}}invalidateCredentials(){this.credentials=null}getBaseURL(e){let t=e.resource_url||OP;return!t.startsWith("http://")&&!t.startsWith("https://")&&(t=`https://${t}`),t=t.replace(/\/$/,""),t.endsWith("/v1")||(t=`${t}/v1`),t}async getAccessToken(){let{accessToken:e}=await this.ensureAuthenticated();return e}async getBaseURLAsync(){let{baseURL:e}=await this.ensureAuthenticated();return e}};var Xy=class n{static instance;modelStates=new Map;static getInstance(){return n.instance||(n.instance=new n),n.instance}markRateLimited(e,t){let o=this.modelStates.get(e)||{isRateLimited:!1,resetsAt:0,backoffLevel:0},r=1e3*2**(o.backoffLevel||0),i=3e4;r>i&&(r=i);let a=t&&t>r?t:r;this.modelStates.set(e,{isRateLimited:!0,resetsAt:Date.now()+a,backoffLevel:(o.backoffLevel||0)+1}),u.debug(`[qwencli] Rate limit marked for ${e}, cooldown: ${a}ms, backoff level: ${(o.backoffLevel||0)+1}`)}clearRateLimited(e){let t=this.modelStates.get(e);t&&(t.isRateLimited=!1,t.backoffLevel=0)}isInCooldown(e){let t=this.modelStates.get(e);return!t||!t.isRateLimited?!1:Date.now()>=t.resetsAt?(this.clearRateLimited(e),!1):!0}getRemainingCooldown(e){let t=this.modelStates.get(e);if(!t||!t.isRateLimited)return 0;let o=t.resetsAt-Date.now();return o>0?o:0}},Yy=class{inThinkingBlock=!1;buffer="";parse(e){let t="",o="";for(this.buffer+=e;;)if(this.inThinkingBlock){let r=this.buffer.indexOf("</think>");if(r!==-1)o+=this.buffer.substring(0,r),this.buffer=this.buffer.substring(r+8),this.inThinkingBlock=!1;else{o+=this.buffer,this.buffer="";break}}else{let r=this.buffer.indexOf("<think>");if(r!==-1)t+=this.buffer.substring(0,r),this.buffer=this.buffer.substring(r+7),this.inThinkingBlock=!0;else{t+=this.buffer,this.buffer="";break}}return{regular:t,thinking:o}}},_m=class n extends Te{rateLimitManager=Xy.getInstance();isRateLimitError(e){if(!(e instanceof Error))return!1;let t=e.message;return t.includes("HTTP 429")||t.includes("Rate limited")||t.includes("Quota exceeded")||t.includes("429")}static createAndActivate(e,t,o){u.trace(`${o.displayName} provider activated!`);let r=new n(e,t,o),i=ht.lm.registerLanguageModelChatProvider(`chp.${t}`,r),a=ht.commands.registerCommand(`chp.${t}.login`,async()=>{try{let{accessToken:c,baseURL:l}=await ea.getInstance().ensureAuthenticated(!0);ht.window.showInformationMessage(`${o.displayName} login successful!`);try{let d=Ne.getInstance();d.getAccountsByProvider("qwencli").find(f=>f.metadata?.source==="cli")||await d.addOAuthAccount("qwencli","Qwen CLI (Local)","",{accessToken:c??"",refreshToken:"",expiresAt:"",tokenType:""},{source:"cli",baseURL:l})}catch(d){u.warn("[qwencli] Failed to register CLI account with AccountManager",d)}await r.modelInfoCache?.invalidateCache(t),r._onDidChangeLanguageModelChatInformation.fire()}catch(c){ht.window.showErrorMessage(`${o.displayName} login failed: ${c instanceof Error?c.message:"Unknown error"}`)}}),s=[i,a];for(let c of s)e.subscriptions.push(c);return{provider:r,disposables:s}}async provideLanguageModelChatInformation(e,t){return this.providerConfig.models.map(o=>this.modelConfigToInfo(o))}async provideLanguageModelChatResponse(e,t,o,r,i){let a=this.providerConfig.models.find(s=>s.id===e.id);if(!a)throw new Error(`Model not found: ${e.id}`);try{if(this.rateLimitManager.isInCooldown(e.id)){let y=this.rateLimitManager.getRemainingCooldown(e.id),w=Math.ceil(y/1e3);throw new Error(`Rate limited: please try again in ${w} seconds`)}await Ie.getInstance(this.providerKey,2,1e3).throttle(this.providerConfig.displayName);let s=Ne.getInstance(),c=s.getAccountsByProvider("qwencli"),l=s.getLoadBalanceEnabled("qwencli"),d=s.getAccountIdForModel("qwencli",e.id),p=async(y,w)=>{if(!w){let C=await s.getCredentials(y.id);if(!C)return{success:!1,reason:"no-creds"};if("accessToken"in C?w=C.accessToken:"apiKey"in C&&(w=C.apiKey),!w)return{success:!1,reason:"no-token"}}let b={...a,baseUrl:a.baseUrl||void 0,customHeader:{...a.customHeader||{},Authorization:`Bearer ${w}`}};try{return await this.openaiHandler.handleRequest(e,b,t,o,r,i),{success:!0}}catch(C){return{success:!1,error:C}}};if(c&&c.length>0){let y=c.filter(M=>M.status==="active"),w=y.length>0?y:c,b=s.getActiveAccount("qwencli"),C;if(l)b&&w.some(M=>M.id===b.id)?C=[b,...w.filter(M=>M.id!==b.id)]:C=w;else{let M=d?c.find(A=>A.id===d):b;C=M?[M]:w.length>0?[w[0]]:[]}let I,$=!1;for(let M of C){let A=await p(M);if(A.success){$&&l&&s.setAccountForModel("qwencli",e.id,M.id).catch(()=>{}),this.rateLimitManager.clearRateLimited(e.id);return}if(I=A.error??A.reason,A.error instanceof Error&&A.error.message.includes("401")){await s.markAccountExpired(M.id);continue}if(this.isRateLimitError(A.error)&&l){$=!0;continue}if(A.error)throw A.error}I&&u.warn("[qwencli] Managed accounts failed, falling back to CLI credentials",I)}let{accessToken:f,baseURL:m}=await ea.getInstance().ensureAuthenticated(),h={...a,baseUrl:m,apiKey:f,customHeader:a.customHeader},g=new Yy,v=null,k="",x={report:y=>{if(y instanceof ht.LanguageModelTextPart){let{regular:w,thinking:b}=g.parse(y.value);b&&(v||(v=`qwen_thinking_${Date.now()}`),r.report(new ht.LanguageModelThinkingPart(b,v)));let C=k+(w||""),I=/<function_calls>[\s\S]*?<\/function_calls>/g,$=0,M=I.exec(C);for(;M!==null;){let q=C.slice($,M.index);q&&q.length>0&&(v&&(r.report(new ht.LanguageModelThinkingPart("",v)),v=null),r.report(new ht.LanguageModelTextPart(q)));let oe=M[0],fe=/<tool_call\s+name="([^"]+)"\s+arguments='([^']*)'\s*\/>/g,ie=fe.exec(oe);for(;ie!==null;){let K=ie[1],Ve=ie[2]||"",ue={};try{ue=JSON.parse(Ve)}catch{ue={value:Ve}}let Rt=`qwen_call_${Date.now()}_${Math.random().toString(36).slice(2,8)}`;v&&(r.report(new ht.LanguageModelThinkingPart("",v)),v=null),r.report(new ht.LanguageModelToolCallPart(Rt,K,ue)),ie=fe.exec(oe)}$=I.lastIndex,M=I.exec(C)}let A=C.slice($),z=A.indexOf("<function_calls>"),F=A.indexOf("</function_calls>");if(z!==-1&&F===-1){let q=A.slice(0,z);q&&q.length>0&&(v&&(r.report(new ht.LanguageModelThinkingPart("",v)),v=null),r.report(new ht.LanguageModelTextPart(q))),k=A.slice(z)}else k="",A&&A.length>0&&(v&&(r.report(new ht.LanguageModelThinkingPart("",v)),v=null),r.report(new ht.LanguageModelTextPart(A)))}else r.report(y)}};await this.openaiHandler.handleRequest(e,h,t,o,x,i),this.rateLimitManager.clearRateLimited(e.id)}catch(s){if(s instanceof Error&&s.message.includes("401")){ea.getInstance().invalidateCredentials();let{accessToken:c,baseURL:l}=await ea.getInstance().ensureAuthenticated(!0),d={...a,baseUrl:l,customHeader:{...a.customHeader,Authorization:`Bearer ${c}`}};await this.openaiHandler.handleRequest(e,d,t,o,r,i);return}if(this.isRateLimitError(s)){this.rateLimitManager.markRateLimited(e.id,1e4);let c=this.rateLimitManager.getRemainingCooldown(e.id),l=Math.ceil(c/1e3);throw new Error(`Rate limited: please try again in ${l} seconds`)}throw s}}};var tc=D(require("node:fs")),zP=D(require("node:path"));var It=D(require("vscode"));Ke();ot();ce();var Cm="https://zenmux.ai/api/v1",ex=16e3,NP=128e3,Tm=class n extends Te{userAgent;extensionPath;configFilePath;clientCache=new Map;constructor(e,t,o,r,i){super(e,t,o),this.userAgent=r,this.extensionPath=i,this.configFilePath=zP.join(this.extensionPath,"src","providers","config","zenmux.json")}refreshHandlers(){this.clientCache&&this.clientCache.size>0&&(u.debug(`[ZenMux] Clearing ${this.clientCache.size} cached OpenAI clients due to config change`),this.clientCache.clear()),super.refreshHandlers()}estimateMessagesTokens(e){let t=0;for(let o of e)for(let r of o.content)r instanceof It.LanguageModelTextPart&&(t+=Math.ceil(r.value.length/4));return t}estimateToolTokens(e){if(!e||e.length===0)return 0;try{let t=JSON.stringify(e);return Math.ceil(t.length/4)}catch{return 0}}async prepareLanguageModelChatInformation(e,t){let o=await this.ensureApiKey(e.silent??!0),r=[];try{r=(await this.fetchModels(o)).models}catch{return u.warn("[Zenmux] Failed to fetch models during initialization, using cached config if available"),this.providerConfig.models&&this.providerConfig.models.length>0?this.providerConfig.models.map(c=>({id:c.model||c.id,name:c.name||c.id,tooltip:c.tooltip||c.id,family:"zenmux",version:"1.0.0",maxInputTokens:c.maxInputTokens||128e3,maxOutputTokens:c.maxOutputTokens||16e3,capabilities:c.capabilities||{toolCalling:!1,imageInput:!1}})):[]}this.updateConfigFileAsync(r);let i=r.map(s=>{let c=s.input_modalities??[],l=Array.isArray(c)&&c.includes("image"),d=s.capabilities?.reasoning??!1,p=s.context_length??NP,f=ex;f>=p&&(f=Math.min(p/2,ex)),f=Math.floor(Math.max(1,Math.min(f,p-1024)));let m=Math.max(1,p-f);return{id:s.id,name:s.display_name||s.id,tooltip:`${s.display_name||s.id} by Zenmux`,family:"zenmux",version:"1.0.0",maxInputTokens:m,maxOutputTokens:f,capabilities:{toolCalling:!0,imageInput:l}}}),a=this.dedupeModelInfos(i);return this._chatEndpoints=a.map(s=>({model:s.id,modelMaxPromptTokens:s.maxInputTokens+s.maxOutputTokens})),a}async provideLanguageModelChatInformation(e,t){return this.prepareLanguageModelChatInformation({silent:e.silent??!1},t)}async fetchModels(e){let t={"User-Agent":this.userAgent};e&&(t.Authorization=`Bearer ${e}`);let o=(async()=>{let r=this.providerConfig.baseUrl||Cm,i=await fetch(`${r}/models`,{method:"GET",headers:t});if(!i.ok){let s="";try{s=await i.text()}catch(l){u.error("[Zenmux Model Provider] Failed to read response text",l)}let c=new Error(`Failed to fetch Zenmux models: ${i.status} ${i.statusText}${s?`
${s}`:""}`);throw u.error("[Zenmux Model Provider] Failed to fetch Zenmux models",c),c}return(await i.json()).data??[]})();try{return{models:await o}}catch(r){throw u.error("[Zenmux Model Provider] Failed to fetch Zenmux models",r),r}}updateConfigFileAsync(e){(async()=>{try{if(!tc.existsSync(this.configFilePath)){u.debug(`[Zenmux] Config file not found at ${this.configFilePath}, skipping auto-update`);return}let t=e.map(i=>{let a=i.input_modalities??[],s=Array.isArray(a)&&a.includes("image"),c=i.context_length??NP,l=ex,d=Math.max(1,c-l);return{id:i.id.replace(/[/]/g,"-").replace(/[^a-zA-Z0-9-]/g,"-").toLowerCase(),name:i.display_name||i.id,tooltip:`${i.display_name||i.id} by Zenmux`,maxInputTokens:d,maxOutputTokens:l,model:i.id,capabilities:{toolCalling:!0,imageInput:s}}}),o;try{let i=tc.readFileSync(this.configFilePath,"utf8");o=JSON.parse(i)}catch(i){u.warn("[Zenmux] Failed to read existing config, using defaults:",i instanceof Error?i.message:String(i)),o={displayName:"Zenmux",baseUrl:Cm,apiKeyTemplate:"zm-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx",models:[]}}let r={displayName:o.displayName||"Zenmux",baseUrl:o.baseUrl||Cm,apiKeyTemplate:o.apiKeyTemplate||"zm-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx",models:t};tc.writeFileSync(this.configFilePath,JSON.stringify(r,null,4),"utf8"),u.info(`[Zenmux] Auto-updated config file with ${t.length} models`)}catch(t){u.warn("[Zenmux] Background config update failed:",t instanceof Error?t.message:String(t))}})()}async provideLanguageModelChatResponse(e,t,o,r,i){await Ie.getInstance(this.providerKey,5,1e3).throttle(this.providerConfig.displayName);try{let a=await this.ensureApiKey(!0);if(!a)throw new Error("Zenmux API key not found");if($n(t),o.tools&&o.tools.length>128)throw new Error("Cannot have more than 128 tools per request.");let s=this.estimateMessagesTokens(t),c=o.tools?this.estimateToolTokens(this.openaiHandler.convertToolsToOpenAI([...o.tools])):0,l=Math.max(1,e.maxInputTokens);if(s+c>l)throw u.error("[Zenmux Model Provider] Message exceeds token limit",{total:s+c,tokenLimit:l}),new Error("Message exceeds token limit.");let d=await this.createOpenAIClient(a),p=this.providerConfig.models.find(b=>b.model===e.id||b.id===e.id),f=this.openaiHandler.convertMessagesToOpenAI(t,e.capabilities||void 0,p),m={model:e.id,messages:f,stream:!0,stream_options:{include_usage:!0},max_tokens:Math.min(o.modelOptions?.max_tokens||4096,e.maxOutputTokens),temperature:o.modelOptions?.temperature??L.getTemperature(),top_p:L.getTopP()};if(o.modelOptions){let b=o.modelOptions;(typeof b.stop=="string"||Array.isArray(b.stop))&&(m.stop=b.stop),typeof b.frequency_penalty=="number"&&(m.frequency_penalty=b.frequency_penalty),typeof b.presence_penalty=="number"&&(m.presence_penalty=b.presence_penalty)}o.tools&&o.tools.length>0&&e.capabilities?.toolCalling&&(m.tools=this.openaiHandler.convertToolsToOpenAI([...o.tools]),m.tool_choice="auto");let h=new AbortController;i.onCancellationRequested(()=>h.abort());let g=d.chat.completions.stream(m,{signal:h.signal}),v=null,k="",x=!1,y=!1,w=new Map;if(g.on("chunk",b=>{if(!i.isCancellationRequested&&b.choices&&b.choices.length>0)for(let C of b.choices){if(C.delta?.tool_calls)for(let M of C.delta.tool_calls)M.id&&M.index!==void 0&&w.set(M.index,M.id);let I=C.delta,$=I?.reasoning??I?.reasoning_content;if($&&typeof $=="string"){v||(v=`zenmux_thinking_${Date.now()}_${Math.random().toString(36).slice(2,8)}`),k+=$;try{r.report(new It.LanguageModelThinkingPart(k,v)),k="",y=!0}catch(M){u.warn("[Zenmux] Failed to report thinking",M instanceof Error?M.message:String(M))}}}}),g.on("content",b=>{if(!i.isCancellationRequested&&b&&typeof b=="string"&&b.trim().length>0){if(v){try{r.report(new It.LanguageModelThinkingPart("",v))}catch{}v=null}try{r.report(new It.LanguageModelTextPart(b)),x=!0}catch(C){u.warn("[Zenmux] Failed to report content",C instanceof Error?C.message:String(C))}}}),g.on("tool_calls.function.arguments.done",b=>{if(i.isCancellationRequested)return;if(v){try{r.report(new It.LanguageModelThinkingPart("",v))}catch{}v=null}let C=w.get(b.index)||`tool_call_${b.index}_${Date.now()}`,I={};if(b.parsed_arguments){let $=b.parsed_arguments;I=typeof $=="object"&&$!==null?$:{}}else try{I=JSON.parse(b.arguments||"{}")}catch{I={value:b.arguments}}try{r.report(new It.LanguageModelToolCallPart(C,b.name,I)),x=!0}catch($){u.warn("[Zenmux] Failed to report tool call",$ instanceof Error?$.message:String($))}}),await g.finalChatCompletion(),v)try{r.report(new It.LanguageModelThinkingPart("",v))}catch{}y&&!x&&(r.report(new It.LanguageModelTextPart("<think/>")),u.warn("[Zenmux] End of message stream has only thinking content and no text content, added <think/> placeholder as output"))}catch(a){throw u.error("[Zenmux Model Provider] Chat request failed",{modelId:e.id,messageCount:t.length,error:a instanceof Error?{name:a.name,message:a.message}:String(a)}),a}}async createOpenAIClient(e){let t=this.providerConfig.baseUrl||Cm,o=`zenmux:${t}`,r=this.clientCache.get(o);if(r)return r.lastUsed=Date.now(),r.client;let i=new G({apiKey:e,baseURL:t,defaultHeaders:{"User-Agent":this.userAgent},maxRetries:2,timeout:6e4});return this.clientCache.set(o,{client:i,lastUsed:Date.now()}),i}async provideTokenCount(e,t,o){return he.getInstance().countTokens(e,t)}async ensureApiKey(e){let t=await R.getApiKey("zenmux");return!t&&!e&&(await R.promptAndSetApiKey("zenmux","Zenmux","zm-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"),t=await R.getApiKey("zenmux")),t}static createAndActivate(e,t,o){u.trace(`${o.displayName} provider activated!`);let s=`better-copilot-chat/${It.extensions.getExtension("OEvortex.better-copilot-chat")?.packageJSON?.version??"unknown"} VSCode/${It.version}`,c=e.extensionPath,l=new n(e,t,o,s,c),d=It.lm.registerLanguageModelChatProvider(`chp.${t}`,l),p=It.commands.registerCommand(`chp.${t}.setApiKey`,async()=>{await De.startWizard({providerKey:t,displayName:o.displayName,apiKeyTemplate:o.apiKeyTemplate,supportsApiKey:!0,supportsBaseUrl:!0}),await l.modelInfoCache?.invalidateCache(t),l._onDidChangeLanguageModelChatInformation.fire(void 0)}),f=[d,p];for(let m of f)e.subscriptions.push(m);return{provider:l,disposables:f}}};var nc=D(require("node:fs")),DP=D(require("node:path")),gu=D(require("vscode"));ot();ce();var Vq=16752,Qq=186e3,Wq="https://api.z.ai/api/coding/paas/v4",Jq="https://api.z.ai/api/paas/v4",Xq=[{id:"glm-4.7-flash",object:"model",created:0,owned_by:"zhipu"},{id:"glm-4.7-flashx",object:"model",created:0,owned_by:"zhipu"}],Im=class n extends Te{configFilePath;constructor(e,t,o){super(e,t,o),this.configFilePath=DP.join(e.extensionPath,"src","providers","config","zhipu.json")}getBaseUrl(){let e=L.getZhipuPlan(),t=this.cachedProviderConfig.baseUrl;return t||(e==="coding"?Wq:Jq)}refreshHandlers(){super.refreshHandlers(),u.debug("[Zhipu] Handlers refreshed due to config change")}async fetchModels(e){let t=this.getBaseUrl();u.info(`[Zhipu] Fetching models from ${t}/models`);let o=await fetch(`${t}/models`,{method:"GET",headers:{Authorization:`Bearer ${e}`}});if(!o.ok){let i="";try{i=await o.text()}catch{}let a=new Error(`Failed to fetch Zhipu models: ${o.status} ${o.statusText}${i?`
${i}`:""}`);throw u.error("[Zhipu Model Provider] Failed to fetch Zhipu models",a),a}return(await o.json()).data??[]}mergeHardcodedModels(e){let t=new Set(e.map(r=>r.id)),o=[...e];for(let r of Xq)t.has(r.id)||o.push(r);return o}supportsThinking(e){let t=e.toLowerCase();return/^glm-(5|4\.(5|6|7))(?:[^\d].*)?$/.test(t)}buildThinkingExtraBody(e,t){if(!this.supportsThinking(e))return t;let o=L.getZhipuThinking();if(o==="auto"){if(!t)return;let i={...t};return delete i.thinking,Object.keys(i).length>0?i:void 0}return{...t||{},thinking:{type:o,clear_thinking:L.getZhipuClearThinking()}}}getModelMetadata(e){let t={name:e,maxInputTokens:Qq,maxOutputTokens:Vq,toolCalling:!0,imageInput:!1};return{"glm-5":{name:"GLM-5 (Latest)",maxInputTokens:186e3,maxOutputTokens:16752,toolCalling:!0,imageInput:!1},"glm-4.7":{name:"GLM-4.7",maxInputTokens:186e3,maxOutputTokens:16752,toolCalling:!0,imageInput:!1},"glm-4.6":{name:"GLM-4.6",maxInputTokens:186e3,maxOutputTokens:16752,toolCalling:!0,imageInput:!1},"glm-4.5":{name:"GLM-4.5",maxInputTokens:1e5,maxOutputTokens:28e3,toolCalling:!0,imageInput:!1},"glm-4.5-air":{name:"GLM-4.5-Air",maxInputTokens:1e5,maxOutputTokens:28e3,toolCalling:!0,imageInput:!1},"glm-4.7-flash":{name:"GLM-4.7-Flash (Free, 1 Concurrent)",maxInputTokens:186e3,maxOutputTokens:16752,toolCalling:!0,imageInput:!1},"glm-4.7-flashx":{name:"GLM-4.7-FlashX (Paid)",maxInputTokens:186e3,maxOutputTokens:16752,toolCalling:!0,imageInput:!1}}[e]||t}async provideLanguageModelChatInformation(e,t){let o=await this.getApiKeyFromManager();if(!o)return super.provideLanguageModelChatInformation(e,t);try{let r=await this.fetchModels(o),i=this.mergeHardcodedModels(r);this.updateConfigFileAsync(i);let a=i.map(s=>{let c=this.getModelMetadata(s.id);return{id:s.id,name:c.name,tooltip:`${s.id} by ZhipuAI`,family:"zhipu",version:"1.0.0",maxInputTokens:c.maxInputTokens,maxOutputTokens:c.maxOutputTokens,capabilities:{toolCalling:c.toolCalling,imageInput:c.imageInput}}});return this._chatEndpoints=a.map(s=>({model:s.id,modelMaxPromptTokens:s.maxInputTokens+s.maxOutputTokens})),a}catch(r){return u.warn("[Zhipu] Failed to fetch models from API, falling back to config:",r instanceof Error?r.message:String(r)),super.provideLanguageModelChatInformation(e,t)}}async getApiKeyFromManager(){try{let{ApiKeyManager:e}=await Promise.resolve().then(()=>(Ke(),Qx)),t=await e.getApiKey(this.providerKey);return t===void 0?null:t}catch(e){return u.warn("[Zhipu] Failed to get API key:",e),null}}updateConfigFileAsync(e){(async()=>{try{if(!nc.existsSync(this.configFilePath)){u.debug(`[Zhipu] Config file not found at ${this.configFilePath}, skipping auto-update`);return}let t=e.map(i=>{let a=this.getModelMetadata(i.id);return{id:i.id,name:a.name,tooltip:`${i.id} by ZhipuAI`,maxInputTokens:a.maxInputTokens,maxOutputTokens:a.maxOutputTokens,model:i.id,sdkMode:"openai",baseUrl:this.getBaseUrl(),extraBody:this.buildThinkingExtraBody(i.id),capabilities:{toolCalling:a.toolCalling,imageInput:a.imageInput}}}),o;try{let i=nc.readFileSync(this.configFilePath,"utf8");o=JSON.parse(i)}catch{o={displayName:"ZhipuAI",baseUrl:this.getBaseUrl(),apiKeyTemplate:"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx.xxxxxxxxxxxxxxxx",models:[]}}let r={displayName:o.displayName||"ZhipuAI",baseUrl:o.baseUrl||this.getBaseUrl(),apiKeyTemplate:o.apiKeyTemplate||"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx.xxxxxxxxxxxxxxxx",models:t};nc.writeFileSync(this.configFilePath,JSON.stringify(r,null,4),"utf8"),u.info(`[Zhipu] Auto-updated config file with ${t.length} models`)}catch(t){u.warn(`[Zhipu] Background config update failed: ${t instanceof Error?t.message:String(t)}`)}})()}static createAndActivate(e,t,o){u.trace(`${o.displayName} dedicated model extension activated!`);let r=new n(e,t,o),i=gu.lm.registerLanguageModelChatProvider(`chp.${t}`,r),a=gu.commands.registerCommand(`chp.${t}.setApiKey`,async()=>{await vs.startWizard(o.displayName,o.apiKeyTemplate),await r.modelInfoCache?.invalidateCache(t),r._onDidChangeLanguageModelChatInformation.fire()}),s=gu.commands.registerCommand(`chp.${t}.configWizard`,async()=>{u.info(`Starting ${o.displayName} configuration wizard`),await vs.startWizard(o.displayName,o.apiKeyTemplate)}),c=[i,a,s];for(let l of c)e.subscriptions.push(l);return{provider:r,disposables:c}}async provideLanguageModelChatResponse(e,t,o,r,i){await Ie.getInstance(this.providerKey,2,1e3).throttle(this.providerConfig.displayName);let a=this.providerConfig.models.find(s=>s.id===e.id);a&&(a.sdkMode="openai",a.baseUrl=a.baseUrl||this.getBaseUrl(),a.extraBody=this.buildThinkingExtraBody(e.id,a.extraBody)),await super.provideLanguageModelChatResponse(e,t,o,r,i)}};var vn=D(require("vscode"));var vu=class{async invoke(e){try{let{agent_name:t,prompt:o}=e.input;if(u.info(`[Tool Invocation] delegate_to_agent invoked: agent=${t}, prompt="${o.substring(0,50)}..."`),!t)throw new Error("Missing required parameter: agent_name");if(!o)throw new Error("Missing required parameter: prompt");if(t.toLowerCase()==="gemini"||t.toLowerCase()==="geminicli")return await vn.commands.executeCommand("chp.geminicli.invoke",o),new vn.LanguageModelToolResult([new vn.LanguageModelTextPart(`Successfully delegated task to ${t}.`)]);let r=`@${t} ${o}`;try{await vn.commands.executeCommand("workbench.panel.chat.view.copilot.focus"),await vn.commands.executeCommand("workbench.action.chat.insertIntoInput",r);let i=["workbench.action.chat.sendMessage","workbench.action.chat.accept","workbench.action.chat.submit"],a=!1;for(let s of i)try{await vn.commands.executeCommand(s),a=!0;break}catch{}return a||await vn.commands.executeCommand("type",{text:`
`}),new vn.LanguageModelToolResult([new vn.LanguageModelTextPart(`Successfully delegated task to ${t}.`)])}catch(i){throw u.warn(`[Delegate Tool] Failed to delegate to ${t}:`,i),new Error(`Failed to delegate to ${t}. Make sure the agent is available.`)}}catch(t){let o=t instanceof Error?t.message:"Unknown error";throw u.error("[Tool Invocation] delegate_to_agent failed",t instanceof Error?t:void 0),new vn.LanguageModelError(`Delegation failed: ${o}`)}}};var qP=D(require("node:https")),ar=D(require("vscode"));Ke();var yu=class{baseURL="https://api.minimax.chat/v1/coding_plan/search";async search(e){let t=await R.getApiKey("minimax-coding");if(!t)throw new Error('MiniMax Coding Plan API key not set, please run command "Copilot ++: Set MiniMax Coding Plan API Key" first');let o=JSON.stringify({q:e.q}),r={method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`,"Content-Length":Buffer.byteLength(o),"User-Agent":Nt.getUserAgent("MiniMaxSearch")}};u.info(`[MiniMax Search] Starting search: "${e.q}"`),u.debug(`[MiniMax Search] Request data: ${o}`);let i=this.baseURL;return L.getMinimaxEndpoint()==="minimax.io"&&(i=i.replace("api.minimax.chat","api.minimax.io")),new Promise((a,s)=>{let c=qP.request(i,r,l=>{let d="";l.on("data",p=>{d+=p}),l.on("end",()=>{try{if(u.debug(`[MiniMax Search] Response status code: ${l.statusCode}`),u.debug(`[MiniMax Search] Response data: ${d}`),l.statusCode!==200){let f=`MiniMax search API error ${l.statusCode}`;try{let m=JSON.parse(d);f+=`: ${m.error?.message||JSON.stringify(m)}`}catch{f+=`: ${d}`}u.error("[MiniMax Search] API returned error",new Error(f)),s(new Error(f));return}let p=JSON.parse(d);u.info(`[MiniMax Search] Search complete: found ${p.organic?.length||0} results`),a(p)}catch(p){u.error("[MiniMax Search] Failed to parse response",p instanceof Error?p:void 0),s(new Error(`Failed to parse MiniMax search response: ${p instanceof Error?p.message:"Unknown error"}`))}})});c.on("error",l=>{u.error("[MiniMax Search] Request failed",l),s(new Error(`MiniMax search request failed: ${l.message}`))}),c.write(o),c.end()})}async invoke(e){try{u.info(`[Tool Invocation] MiniMax web search tool invoked: ${JSON.stringify(e.input)}`);let t=e.input;if(!t.q)throw new Error("Missing required parameter: q");let o=await this.search(t),r=o.organic||[];u.info("[Tool Invocation] MiniMax web search tool invocation successful");let i=[];if(r.length>0)i.push(new ar.LanguageModelTextPart(`## Search Results (${r.length})`)),r.forEach((a,s)=>{let c=`**${s+1}. ${a.title}**

${a.snippet}

${a.date}

[View Original](${a.link})

---
`;i.push(new ar.LanguageModelTextPart(c))});else{if(o.base_resp?.status_code!==0&&o.base_resp?.status_msg)throw new ar.LanguageModelError(o.base_resp.status_msg);i.push(new ar.LanguageModelTextPart("No relevant search results found."))}return new ar.LanguageModelToolResult(i)}catch(t){let o=t instanceof Error?t.message:"Unknown error";throw u.error("[Tool Invocation] MiniMax web search tool invocation failed",t instanceof Error?t:void 0),new ar.LanguageModelError(`MiniMax search failed: ${o}`)}}async cleanup(){try{u.info("[MiniMax Search] Tool resources cleaned up")}catch(e){u.error("[MiniMax Search] Resource cleanup failed",e instanceof Error?e:void 0)}}};var Am=D(require("vscode"));var FP=D(require("node:https")),oc=D(require("vscode"));Ke();ot();var xu=class{baseURL="https://open.bigmodel.cn/api/paas/v4";isMCPEnabled(){return L.getZhipuSearchConfig().enableMCP}async searchViaMCP(e){u.info(`[Zhipu Search] Using MCP mode search: "${e.search_query}"`);let t=await Wi.getInstance(),o={search_query:e.search_query,search_engine:e.search_engine,search_intent:e.search_intent,count:e.count,search_domain_filter:e.search_domain_filter,search_recency_filter:e.search_recency_filter,content_size:e.content_size};return await t.search(o)}async search(e){let t=await R.getApiKey("zhipu");if(!t)throw new Error('ZhipuAI API key not set, please run command "Copilot ++: Set ZhipuAI API Key" first');let o=this.baseURL;L.getZhipuEndpoint()==="api.z.ai"&&(o=o.replace("open.bigmodel.cn","api.z.ai"));let i=`${o}/web_search`,a=JSON.stringify({search_query:e.search_query,search_engine:e.search_engine||"search_std",search_intent:e.search_intent!==void 0?e.search_intent:!1,count:e.count||10,search_domain_filter:e.search_domain_filter,search_recency_filter:e.search_recency_filter||"noLimit",content_size:e.content_size||"medium",request_id:e.request_id,user_id:e.user_id}),s={method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`,"Content-Length":Buffer.byteLength(a),"User-Agent":Nt.getUserAgent("ZhipuSearch")}};return u.info(`[Zhipu Search] Starting search: "${e.search_query}" using engine ${e.search_engine||"search_std"}`),u.debug(`[Zhipu Search] Request data: ${a}`),new Promise((c,l)=>{let d=FP.request(i,s,p=>{let f="";p.on("data",m=>{f+=m}),p.on("end",()=>{try{if(u.debug(`[Zhipu Search] Response status code: ${p.statusCode}`),u.debug(`[Zhipu Search] Response data: ${f}`),p.statusCode!==200){let h=`ZhipuAI search API error ${p.statusCode}`;try{let g=JSON.parse(f);h+=`: ${g.error?.message||JSON.stringify(g)}`}catch{h+=`: ${f}`}u.error("[Zhipu Search] API returned error",new Error(h)),l(new Error(h));return}let m=JSON.parse(f);u.info(`[Zhipu Search] Search complete: found ${m.search_result?.length||0} results`),c(m)}catch(m){u.error("[Zhipu Search] Failed to parse response",m instanceof Error?m:void 0),l(new Error(`Failed to parse ZhipuAI search response: ${m instanceof Error?m.message:"Unknown error"}`))}})});d.on("error",p=>{u.error("[Zhipu Search] Request failed",p),l(new Error(`ZhipuAI search request failed: ${p.message}`))}),d.write(a),d.end()})}async invoke(e){try{u.info(`[Tool Invocation] ZhipuAI web search tool invoked: ${JSON.stringify(e.input)}`);let t=e.input;if(!t.search_query)throw new Error("Missing required parameter: search_query");let o;return this.isMCPEnabled()?(u.info("[Zhipu Search] Using MCP mode search"),o=await this.searchViaMCP(t)):(u.info("[Zhipu Search] Using standard billing interface search (pay-per-use)"),o=(await this.search(t)).search_result||[]),u.info("[Tool Invocation] ZhipuAI web search tool invocation successful"),new oc.LanguageModelToolResult([new oc.LanguageModelTextPart(JSON.stringify(o))])}catch(t){let o=t instanceof Error?t.message:"Unknown error";throw u.error("[Tool Invocation] ZhipuAI web search tool invocation failed",t instanceof Error?t:void 0),new oc.LanguageModelError(`ZhipuAI search failed: ${o}`)}}getSearchModeStatus(){let e=this.isMCPEnabled();return{mode:e?"MCP":"Standard",description:e?"MCP mode (Coding Plan exclusive)":"Standard billing interface mode (pay-per-use)"}}async cleanup(){try{u.info("[Zhipu Search] Tool resources cleaned up")}catch(e){u.error("[Zhipu Search] Resource cleanup failed",e instanceof Error?e:void 0)}}getMCPCacheStats(){return Wi.getCacheStats()}async clearMCPCache(e){await Wi.clearCache(e)}};var rc,ic,bu;function tx(n){try{rc=new xu;let e=Am.lm.registerTool("chp_zhipuWebSearch",{invoke:rc.invoke.bind(rc)});n.subscriptions.push(e),ic=new yu;let t=Am.lm.registerTool("chp_minimaxWebSearch",{invoke:ic.invoke.bind(ic)});n.subscriptions.push(t),bu=new vu;let o=Am.lm.registerTool("chp_delegateToAgent",{invoke:bu.invoke.bind(bu)});n.subscriptions.push(o),n.subscriptions.push({dispose:async()=>{await Yq()}}),u.info("Zhipu AI web search tool registered: chp_zhipuWebSearch"),u.info("MiniMax web search tool registered: chp_minimaxWebSearch"),u.info("Delegate to agent tool registered: chp_delegateToAgent")}catch(e){throw u.error("Tool registration failed",e instanceof Error?e:void 0),e}}async function Yq(){try{rc&&(await rc.cleanup(),rc=void 0,u.info("ZhipuAI web search tool resources cleaned up")),ic&&(await ic.cleanup(),ic=void 0,u.info("MiniMax web search tool resources cleaned up")),bu&&(bu=void 0,u.info("Delegate to agent tool resources cleaned up"))}catch(n){u.error("Tool cleanup failed",n instanceof Error?n:void 0)}}sr();var yn=D(require("vscode"));Ke();var BP=`body {
	font-family:
		-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue",
		Arial, sans-serif;
	color: #ddd;
	background: transparent;
}
.container {
	width: 420px;
	padding: 12px;
}
.header {
	display: flex;
	justify-content: space-between;
	align-items: center;
}
.header h2 {
	margin: 0;
	font-size: 14px;
}
.section {
	margin-top: 12px;
}
.label-row {
	display: flex;
	justify-content: space-between;
	align-items: center;
	font-size: 12px;
}
.progress {
	width: 100%;
	height: 8px;
	background: #2b2b2b;
	border-radius: 6px;
	margin-top: 8px;
}
.progress > .bar {
	height: 100%;
	background: linear-gradient(90deg, #3b82f6, #7c3aed);
	border-radius: 6px;
	width: 0%;
}
.button {
	margin-top: 10px;
	background: #2d2d2d;
	border: 1px solid #444;
	color: #fff;
	padding: 8px 10px;
	border-radius: 6px;
	cursor: pointer;
}
.providers {
	margin-top: 12px;
}
.provider-item {
	padding: 6px 0;
	border-bottom: 1px solid rgba(255, 255, 255, 0.03);
	display: flex;
	justify-content: space-between;
	align-items: center;
	font-size: 12px;
}
.toggle {
	display: inline-flex;
	align-items: center;
	gap: 8px;
}
.small {
	font-size: 11px;
	color: #aaa;
}
.footer {
	margin-top: 10px;
	font-size: 11px;
	color: #aaa;
}
hr {
	border: 0;
	border-top: 1px solid rgba(255, 255, 255, 0.03);
	margin: 10px 0;
}
`;var UP=`(() => {
    // Minimal client-side logic
    function $(id) {
        return document.getElementById(id);
    }
    window.addEventListener("message", (event) => {
        const msg = event.data;
        if (msg.command === "updateState") {
            updateState(msg.data);
        } else if (msg.command === "tokenUpdate") {
            applyToken(msg.data);
        }
    });

    function updateState(state) {
        // Token
        if (state.tokenUsage && state.tokenUsage.percentage != null) {
            applyToken(state.tokenUsage);
        } else {
            $("token-model").textContent = "No requests yet";
            setProgress(0);
        }

        // Inline/FIM/NES
        $("inline-val").textContent = state.inlineEnabled ? "Included" : "Disabled";
        $("fim-val").textContent = state.fimEnabled ? "Enabled" : "Disabled";
        $("nes-val").textContent = state.nesEnabled ? "Enabled" : "Disabled";

        // Providers
        const list = $("providers-list");
        list.innerHTML = "";
        if (state.providers) {
            for (const [k, v] of Object.entries(state.providers)) {
                const div = document.createElement("div");
                div.className = "provider-item";
                div.innerHTML = \`<div>\${capitalize(k)}</div><div class="small">\${v}</div>\`;
                list.appendChild(div);
            }
        }
    }

    function applyToken(data) {
        const modelName = data.modelName || "Model";
        const percent = Number.isFinite(data.percentage)
            ? data.percentage
            : 0;
        const promptTokens =
            typeof data.promptTokens === "number" ? data.promptTokens : 0;
        const maxInputTokens =
            typeof data.maxInputTokens === "number" ? data.maxInputTokens : 0;
        const suffix = maxInputTokens
            ? \` (\${promptTokens}/\${maxInputTokens})\`
            : promptTokens
                ? \` (\${promptTokens})\`
                : "";
        $("token-model").textContent =
            \`\${modelName} \u2014 \${percent.toFixed(1)}%\${suffix}\`;
        setProgress(Math.max(0, Math.min(100, percent)));
    }

    function setProgress(pct) {
        const bar = $("bar");
        bar.style.width = \`\${pct}%\`;
    }

    function capitalize(s) {
        return s.charAt(0).toUpperCase() + s.slice(1);
    }

    // Buttons
    window.managePaid = () => {
        vscode.postMessage({ command: "managePaidRequests" });
    };
    window.refresh = () => {
        vscode.postMessage({ command: "refresh" });
    };

    // Post init ready
    const vscode = acquireVsCodeApi
        ? acquireVsCodeApi()
        : { postMessage: () => { } };
    // Request initial state
    setTimeout(() => {
        vscode.postMessage({ command: "ready" });
    }, 50);
})();
`;var Pm=class n{static currentPanel;static context;static async show(e){if(n.context=e,n.currentPanel){n.currentPanel.reveal(yn.ViewColumn.Active);return}let t=yn.window.createWebviewPanel("chpCopilotOverview","Copilot ++ Overview",yn.ViewColumn.Active,{enableScripts:!0,retainContextWhenHidden:!0,localResourceRoots:[yn.Uri.joinPath(e.extensionUri,"src","ui")]});n.currentPanel=t,t.webview.html=n.generateHTML(t.webview);let o=t.webview.onDidReceiveMessage(async r=>{switch(r.command){case"ready":await n.sendStateUpdate(t.webview);break;case"managePaidRequests":await yn.commands.executeCommand("workbench.action.openSettings","chp");break;case"refresh":await n.sendStateUpdate(t.webview);break}});t.onDidDispose(()=>{o.dispose(),n.currentPanel=void 0,n.detachTokenListener()}),n.attachTokenListener(t.webview),await n.sendStateUpdate(t.webview)}static generateHTML(e){let t=e.cspSource;return`<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><meta http-equiv="Content-Security-Policy" content="default-src 'none'; style-src 'unsafe-inline' ${t}; script-src 'unsafe-inline' ${t};" /><style>${BP}</style></head><body><div class="container"><div class="header"><h2>Copilot Usage</h2><button class="button" onclick="refresh()">Refresh</button></div><div class="section"><div class="label-row"><div class="small">Inline Suggestions</div><div id="inline-val">Included</div></div></div><div class="section"><div class="label-row"><div class="small">Chat messages</div><div id="token-model">No requests yet</div></div><div class="progress"><div id="bar" class="bar"></div></div></div><div class="section"><button class="button" onclick="managePaid()">Manage paid premium requests</button></div><hr/><div class="providers"><h3 style="margin:0;">Providers</h3><div id="providers-list"></div></div><div class="footer">Allowance resets TBD</div></div><script>${UP}</script></body></html>`}static async sendStateUpdate(e){try{let t=["deepseek","deepinfra","chutes","opencode","lightningai","zenmux","huggingface","minimax","zhipu","antigravity","codex","compatible"],o={};await Promise.all(t.map(async s=>{try{let c=await R.hasValidApiKey(s);o[s]=c?"Configured":"Not configured"}catch{o[s]="Unknown"}}));let r=yn.workspace.getConfiguration("editor").get("inlineSuggest.enabled",!0),i=yn.workspace.getConfiguration("chp").get("fimCompletion.enabled",!1),a=yn.workspace.getConfiguration("chp").get("nesCompletion.enabled",!1);e.postMessage({command:"updateState",data:{providers:o,tokenUsage:Gt.getInstance().getLastUsageSummary(),inlineEnabled:r,fimEnabled:i,nesEnabled:a}})}catch(t){console.error("sendStateUpdate failed",t)}}static tokenListener;static attachTokenListener(e){let t=Gt.getInstance(),o=()=>{let r=t.getLastUsageSummary();r&&e.postMessage({command:"tokenUpdate",data:r})};n.tokenListener=t.onEvent(r=>{r.status==="success"&&r.responseMetrics&&o()}),o()}static detachTokenListener(){n.tokenListener&&(n.tokenListener.dispose(),n.tokenListener=void 0)}};function nx(n){return yn.commands.registerCommand("chp.copilot.openOverview",async()=>{await Pm.show(n)})}Rm();var ro=D(require("vscode"));Vr();var jP=`/* GCMP Settings Page - Modern & Simple UI */

:root {
	--card-bg: var(--vscode-editor-background);
	--card-border: var(--vscode-panel-border);
	--card-hover: var(--vscode-list-hoverBackground);
	--accent-color: var(--vscode-button-background);
	--accent-hover: var(--vscode-button-hoverBackground);
	--success-color: #4caf50;
	--warning-color: #ff9800;
	--danger-color: #f44336;
}

* {
	box-sizing: border-box;
}

body {
	font-family: var(--vscode-font-family);
	font-size: var(--vscode-font-size);
	color: var(--vscode-foreground);
	background-color: var(--vscode-editor-background);
	padding: 0;
	margin: 0;
	line-height: 1.5;
}

.settings-container {
	max-width: 800px;
	margin: 0 auto;
	padding: 24px;
}

/* Header */
.settings-header {
	margin-bottom: 32px;
	padding-bottom: 16px;
	border-bottom: 1px solid var(--card-border);
}

.settings-header h1 {
	margin: 0 0 8px 0;
	font-size: 1.8em;
	font-weight: 600;
	color: var(--vscode-foreground);
	display: flex;
	align-items: center;
	gap: 12px;
}

.settings-header h1 .icon {
	font-size: 1.2em;
}

.settings-header p {
	margin: 0;
	color: var(--vscode-descriptionForeground);
	font-size: 1em;
}

/* Section */
.settings-section {
	margin-bottom: 28px;
}

.section-title {
	font-size: 1.2em;
	font-weight: 600;
	margin: 0 0 16px 0;
	color: var(--vscode-foreground);
	display: flex;
	align-items: center;
	gap: 8px;
}

.section-title .badge {
	font-size: 0.7em;
	padding: 2px 8px;
	border-radius: 12px;
	background-color: var(--accent-color);
	color: var(--vscode-button-foreground);
	font-weight: 500;
}

/* Card Grid */
.card-grid {
	display: grid;
	grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
	gap: 16px;
}

/* Settings Card */
.settings-card {
	background-color: var(--card-bg);
	border: 1px solid var(--card-border);
	border-radius: 8px;
	padding: 16px;
	transition: all 0.2s ease;
}

.settings-card:hover {
	border-color: var(--accent-color);
	box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
}

.card-header {
	display: flex;
	align-items: center;
	justify-content: space-between;
	margin-bottom: 12px;
}

.card-title {
	display: flex;
	align-items: center;
	gap: 10px;
}

.card-title .provider-icon {
	width: 32px;
	height: 32px;
	border-radius: 6px;
	display: flex;
	align-items: center;
	justify-content: center;
	font-size: 1.2em;
	background: linear-gradient(135deg, var(--accent-color), var(--accent-hover));
	color: var(--vscode-button-foreground);
}

.card-title h3 {
	margin: 0;
	font-size: 1.1em;
	font-weight: 600;
}

.card-description {
	color: var(--vscode-descriptionForeground);
	font-size: 0.95em;
	margin-bottom: 16px;
	line-height: 1.5;
}

/* Toggle Switch */
.toggle-container {
	display: flex;
	align-items: center;
	justify-content: space-between;
	padding: 12px 0;
	border-top: 1px solid var(--card-border);
}

.toggle-label {
	display: flex;
	flex-direction: column;
	gap: 2px;
}

.toggle-label .label-text {
	font-weight: 500;
	font-size: 0.95em;
}

.toggle-label .label-hint {
	font-size: 0.85em;
	color: var(--vscode-descriptionForeground);
}

/* Modern Toggle Switch */
.toggle-switch {
	position: relative;
	width: 48px;
	height: 26px;
	flex-shrink: 0;
}

.toggle-switch input {
	opacity: 0;
	width: 0;
	height: 0;
}

.toggle-slider {
	position: absolute;
	cursor: pointer;
	top: 0;
	left: 0;
	right: 0;
	bottom: 0;
	background-color: var(--vscode-input-background);
	border: 1px solid var(--vscode-input-border);
	transition: all 0.3s ease;
	border-radius: 26px;
}

.toggle-slider:before {
	position: absolute;
	content: "";
	height: 20px;
	width: 20px;
	left: 2px;
	bottom: 2px;
	background-color: var(--vscode-foreground);
	transition: all 0.3s ease;
	border-radius: 50%;
}

.toggle-switch input:checked + .toggle-slider {
	background-color: var(--success-color);
	border-color: var(--success-color);
}

.toggle-switch input:checked + .toggle-slider:before {
	transform: translateX(22px);
	background-color: white;
}

.toggle-switch input:focus + .toggle-slider {
	box-shadow: 0 0 0 2px var(--vscode-focusBorder);
}

.toggle-switch input:disabled + .toggle-slider {
	opacity: 0.5;
	cursor: not-allowed;
}

/* Status Indicator */
.status-indicator {
	display: inline-flex;
	align-items: center;
	gap: 6px;
	padding: 4px 10px;
	border-radius: 12px;
	font-size: 0.85em;
	font-weight: 500;
}

.status-indicator.enabled {
	background-color: rgba(76, 175, 80, 0.15);
	color: var(--success-color);
}

.status-indicator.disabled {
	background-color: rgba(158, 158, 158, 0.15);
	color: var(--vscode-descriptionForeground);
}

.status-dot {
	width: 8px;
	height: 8px;
	border-radius: 50%;
	background-color: currentColor;
}

/* Account Count Badge */
.account-badge {
	display: inline-flex;
	align-items: center;
	gap: 4px;
	padding: 2px 8px;
	border-radius: 10px;
	font-size: 0.8em;
	background-color: var(--vscode-badge-background);
	color: var(--vscode-badge-foreground);
}

.account-badge.success {
	background-color: rgba(76, 175, 80, 0.15);
	color: var(--success-color);
}

.account-badge.warning {
	background-color: rgba(255, 152, 0, 0.15);
	color: var(--warning-color);
}

.account-info {
	display: flex;
	gap: 8px;
	flex-wrap: wrap;
	margin-bottom: 12px;
}

/* Strategy Selector */
.strategy-container {
	margin-top: 16px;
	padding-top: 16px;
	border-top: 1px solid var(--card-border);
}

.strategy-label {
	margin-bottom: 12px;
}

.strategy-label .label-text {
	font-weight: 500;
	font-size: 0.95em;
}

.strategy-options {
	display: flex;
	flex-direction: column;
	gap: 8px;
}

.strategy-option {
	display: flex;
	align-items: flex-start;
	gap: 10px;
	padding: 10px 12px;
	border: 1px solid var(--card-border);
	border-radius: 6px;
	cursor: pointer;
	transition: all 0.2s ease;
	background-color: transparent;
}

.strategy-option:hover {
	border-color: var(--accent-color);
	background-color: var(--card-hover);
}

.strategy-option.selected {
	border-color: var(--success-color);
	background-color: rgba(76, 175, 80, 0.08);
}

.strategy-option input[type="radio"] {
	margin-top: 2px;
	accent-color: var(--success-color);
}

.strategy-content {
	display: flex;
	flex-direction: column;
	gap: 2px;
}

.strategy-name {
	font-weight: 500;
	font-size: 0.95em;
}

.strategy-desc {
	font-size: 0.85em;
	color: var(--vscode-descriptionForeground);
}

/* Action Buttons Container */
.action-buttons {
	display: flex;
	gap: 12px;
	flex-wrap: wrap;
}

/* Info Box */
.info-box {
	display: flex;
	align-items: flex-start;
	gap: 12px;
	padding: 14px;
	background-color: var(--vscode-textBlockQuote-background);
	border-left: 3px solid var(--accent-color);
	border-radius: 0 6px 6px 0;
	margin-top: 16px;
}

.info-box .info-icon {
	font-size: 1.2em;
	flex-shrink: 0;
}

.info-box .info-content {
	flex: 1;
}

.info-box .info-content p {
	margin: 0;
	font-size: 0.95em;
	line-height: 1.5;
}

/* Empty State */
.empty-state {
	text-align: center;
	padding: 40px 20px;
	color: var(--vscode-descriptionForeground);
}

.empty-state .empty-icon {
	font-size: 3em;
	margin-bottom: 16px;
	opacity: 0.5;
}

.empty-state h3 {
	margin: 0 0 8px 0;
	color: var(--vscode-foreground);
}

.empty-state p {
	margin: 0;
	font-size: 0.95em;
}

/* Action Button */
.action-button {
	display: inline-flex;
	align-items: center;
	gap: 6px;
	padding: 8px 16px;
	border: none;
	border-radius: 6px;
	font-size: 0.95em;
	font-weight: 500;
	cursor: pointer;
	transition: all 0.2s ease;
	background-color: var(--vscode-button-background);
	color: var(--vscode-button-foreground);
}

.action-button:hover {
	background-color: var(--vscode-button-hoverBackground);
}

.action-button.secondary {
	background-color: var(--vscode-button-secondaryBackground);
	color: var(--vscode-button-secondaryForeground);
}

.action-button.secondary:hover {
	background-color: var(--vscode-button-secondaryHoverBackground);
}

/* Divider */
.divider {
	height: 1px;
	background-color: var(--card-border);
	margin: 24px 0;
}

/* Loading Spinner */
.loading-spinner {
	display: inline-block;
	width: 16px;
	height: 16px;
	border: 2px solid var(--vscode-foreground);
	border-radius: 50%;
	border-top-color: transparent;
	animation: spin 0.8s linear infinite;
}

@keyframes spin {
	to {
		transform: rotate(360deg);
	}
}

/* Toast Notification */
.toast {
	position: fixed;
	bottom: 24px;
	right: 24px;
	padding: 12px 20px;
	background-color: var(--vscode-notifications-background);
	border: 1px solid var(--vscode-notifications-border);
	border-radius: 8px;
	box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
	display: flex;
	align-items: center;
	gap: 10px;
	z-index: 1000;
	animation: slideIn 0.3s ease;
}

.toast.success {
	border-left: 3px solid var(--success-color);
}

.toast.error {
	border-left: 3px solid var(--danger-color);
}

@keyframes slideIn {
	from {
		opacity: 0;
		transform: translateY(20px);
	}
	to {
		opacity: 1;
		transform: translateY(0);
	}
}

/* Responsive */
@media (max-width: 600px) {
	.settings-container {
		padding: 16px;
	}

	.card-grid {
		grid-template-columns: 1fr;
	}

	.settings-header h1 {
		font-size: 1.5em;
	}
}

/* Scrollbar */
::-webkit-scrollbar {
	width: 8px;
}

::-webkit-scrollbar-track {
	background: transparent;
}

::-webkit-scrollbar-thumb {
	background-color: var(--vscode-scrollbarSlider-background);
	border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
	background-color: var(--vscode-scrollbarSlider-hoverBackground);
}
`;var KP=`/* GCMP Settings Page - JavaScript */

// VS Code API
const vscode = acquireVsCodeApi();

// State management
let settingsState = {
	providers: [],
	loadBalanceSettings: {},
	loadBalanceStrategies: {},
	loading: true,
};

// Available load balance strategies
const LOAD_BALANCE_STRATEGIES = [
	{
		id: "round-robin",
		name: "Round Robin",
		description: "Distribute requests evenly across accounts",
	},
	{
		id: "quota-aware",
		name: "Quota Aware",
		description: "Prioritize accounts with more remaining quota",
	},
	{
		id: "failover",
		name: "Failover Only",
		description: "Use primary account, switch on errors",
	},
];

/**
 * Initialize the settings page
 */
function _initializeSettingsPage(initialData) {
	settingsState = {
		...settingsState,
		...initialData,
		loading: false,
	};
	renderPage();
}

/**
 * Render the entire page
 */
function renderPage() {
	const app = document.getElementById("app");
	if (!app) return;

	app.innerHTML = \`
        \${renderHeader()}
        \${renderLoadBalanceSection()}
        \${renderAdvancedSection()}
        \${renderInfoSection()}
    \`;

	attachEventListeners();
}

/**
 * Render header section
 */
function renderHeader() {
	return \`
        <div class="settings-header">
            <h1>
                <span class="icon"></span>
                GCMP Settings
            </h1>
            <p>Configure load balancing and advanced settings for AI Chat Models</p>
        </div>
    \`;
}

/**
 * Render load balance section
 */
function renderLoadBalanceSection() {
	const providers = settingsState.providers || [];

	// Filter providers that have accounts
	const providersWithAccounts = providers.filter((p) => p.accountCount > 0);

	if (providersWithAccounts.length === 0) {
		return \`
            <div class="settings-section">
                <h2 class="section-title">
                    \u2696\uFE0F Load Balance Settings
                    <span class="badge">Multi-Account</span>
                </h2>
                <div class="empty-state">
                    <div class="empty-icon">\u{1F4ED}</div>
                    <h3>No Accounts Configured</h3>
                    <p>Add accounts to providers to enable load balancing features</p>
                    <button class="action-button" onclick="openAccountManager()">
                        \u{1F464} Manage Accounts
                    </button>
                </div>
            </div>
        \`;
	}

	return \`
        <div class="settings-section">
            <h2 class="section-title">
                \u2696\uFE0F Load Balance Settings
                <span class="badge">Multi-Account</span>
            </h2>
            <div class="card-grid">
                \${providersWithAccounts.map((provider) => renderProviderCard(provider)).join("")}
            </div>
        </div>
    \`;
}

/**
 * Render a provider card
 */
function renderProviderCard(provider) {
	const isEnabled = settingsState.loadBalanceSettings[provider.id] || false;
	const currentStrategy =
		settingsState.loadBalanceStrategies[provider.id] || "round-robin";
	const accountCount = provider.accountCount || 0;
	const statusClass = isEnabled ? "enabled" : "disabled";
	const statusText = isEnabled ? "Enabled" : "Disabled";
	const canEnable = accountCount >= 2;

	return \`
        <div class="settings-card" data-provider="\${provider.id}">
            <div class="card-header">
                <div class="card-title">
                    <div class="provider-icon">\${getProviderIcon(provider.id)}</div>
                    <h3>\${escapeHtml(provider.displayName)}</h3>
                </div>
                <span class="status-indicator \${statusClass}">
                    <span class="status-dot"></span>
                    \${statusText}
                </span>
            </div>
            <div class="card-description">
                \${getProviderDescription(provider.id)}
            </div>
            <div class="account-info">
                <span class="account-badge">
                    \u{1F464} \${accountCount} account\${accountCount !== 1 ? "s" : ""}
                </span>
                \${accountCount >= 2 ? '<span class="account-badge success">Ready for LB</span>' : '<span class="account-badge warning">Need 2+ accounts</span>'}
            </div>
            <div class="toggle-container">
                <div class="toggle-label">
                    <span class="label-text">Enable Load Balancing</span>
                    <span class="label-hint">\${canEnable ? "Distribute requests across accounts" : "Requires 2+ accounts"}</span>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" 
                           id="toggle-\${provider.id}" 
                           \${isEnabled ? "checked" : ""} 
                           \${!canEnable ? "disabled" : ""}
                           onchange="handleToggleChange('\${provider.id}', this.checked)">
                    <span class="toggle-slider"></span>
                </label>
            </div>
            \${isEnabled && canEnable ? renderStrategySelector(provider.id, currentStrategy) : ""}
        </div>
    \`;
}

/**
 * Render strategy selector
 */
function renderStrategySelector(providerId, currentStrategy) {
	return \`
        <div class="strategy-container">
            <div class="strategy-label">
                <span class="label-text">Load Balance Strategy</span>
            </div>
            <div class="strategy-options">
                \${LOAD_BALANCE_STRATEGIES.map(
									(strategy) => \`
                    <label class="strategy-option \${currentStrategy === strategy.id ? "selected" : ""}">
                        <input type="radio" 
                               name="strategy-\${providerId}" 
                               value="\${strategy.id}"
                               \${currentStrategy === strategy.id ? "checked" : ""}
                               onchange="handleStrategyChange('\${providerId}', '\${strategy.id}')">
                        <div class="strategy-content">
                            <span class="strategy-name">\${strategy.name}</span>
                            <span class="strategy-desc">\${strategy.description}</span>
                        </div>
                    </label>
                \`,
								).join("")}
            </div>
        </div>
    \`;
}

/**
 * Render advanced section
 */
function renderAdvancedSection() {
	return \`
        <div class="settings-section">
            <h2 class="section-title">
                Quick Actions
            </h2>
            <div class="action-buttons">
                <button class="action-button" onclick="openAccountManager()">
                    \u{1F464} Manage Accounts
                </button>
                <button class="action-button secondary" onclick="refreshSettings()">
                    Refresh
                </button>
            </div>
        </div>
    \`;
}

/**
 * Render info section
 */
function renderInfoSection() {
	return \`
        <div class="divider"></div>
        <div class="info-box">
            <span class="info-icon"></span>
            <div class="info-content">
                <p><strong>About Load Balancing:</strong></p>
                <p>When enabled, requests will be distributed across multiple accounts to optimize quota usage and improve reliability. 
                If one account hits its quota limit, the system will automatically switch to another available account.</p>
            </div>
        </div>
        <div class="info-box" style="margin-top: 12px;">
            <span class="info-icon"></span>
            <div class="info-content">
                <p><strong>Load Balance Strategies:</strong></p>
                <p>\u2022 <strong>Round Robin:</strong> Requests are distributed evenly across accounts<br>
                \u2022 <strong>Quota Aware:</strong> Prioritizes accounts with more remaining quota<br>
                \u2022 <strong>Failover Only:</strong> Uses primary account, switches only on errors</p>
            </div>
        </div>
    \`;
}

/**
 * Get provider icon
 */
function getProviderIcon(providerId) {
	const icons = {
		antigravity: "",
		codex: "\u{1F916}",
		zhipu: "\u{1F9E0}",
		moonshot: "\u{1F319}",
		minimax: "",
		deepseek: "",
		compatible: "",
	};
	return icons[providerId] || "\u{1F916}";
}

/**
 * Get provider description
 */
function getProviderDescription(providerId) {
	const descriptions = {
		antigravity:
			"Google Cloud Code powered AI models with OAuth authentication",
		codex: "OpenAI Codex models with OAuth authentication",
		zhipu: "ZhipuAI GLM models with Coding Plan support",
		moonshot: "MoonshotAI Kimi models for coding assistance",
		minimax: "MiniMax models with Coding Plan features",
		deepseek: "DeepSeek AI models for code generation",
		compatible: "OpenAI/Anthropic compatible custom models",
	};
	return descriptions[providerId] || "AI model provider";
}

/**
 * Handle toggle change
 */
function _handleToggleChange(providerId, enabled) {
	// Update local state
	settingsState.loadBalanceSettings[providerId] = enabled;

	// Send message to extension
	vscode.postMessage({
		command: "setLoadBalance",
		providerId: providerId,
		enabled: enabled,
	});

	// Re-render to show/hide strategy selector
	renderPage();
	showToast(
		enabled ? "Load balancing enabled" : "Load balancing disabled",
		"success",
	);
}

/**
 * Handle strategy change
 */
function _handleStrategyChange(providerId, strategy) {
	// Update local state
	settingsState.loadBalanceStrategies[providerId] = strategy;

	// Send message to extension
	vscode.postMessage({
		command: "setLoadBalanceStrategy",
		providerId: providerId,
		strategy: strategy,
	});

	// Update UI
	renderPage();
	showToast(\`Strategy changed to \${strategy}\`, "success");
}

/**
 * Open account manager
 */
function _openAccountManager() {
	vscode.postMessage({
		command: "openAccountManager",
	});
}

/**
 * Refresh settings
 */
function _refreshSettings() {
	vscode.postMessage({
		command: "refresh",
	});
	showToast("Refreshing settings...", "success");
}

/**
 * Update card status indicator
 */
function _updateCardStatus(providerId, enabled) {
	const card = document.querySelector(\`[data-provider="\${providerId}"]\`);
	if (!card) return;

	const statusIndicator = card.querySelector(".status-indicator");
	if (statusIndicator) {
		statusIndicator.className = \`status-indicator \${enabled ? "enabled" : "disabled"}\`;
		statusIndicator.innerHTML = \`
            <span class="status-dot"></span>
            \${enabled ? "Enabled" : "Disabled"}
        \`;
	}
}

/**
 * Show toast notification
 */
function showToast(message, type = "success") {
	// Remove existing toast
	const existingToast = document.querySelector(".toast");
	if (existingToast) {
		existingToast.remove();
	}

	const toast = document.createElement("div");
	toast.className = \`toast \${type}\`;
	toast.innerHTML = \`
        <span>\${type === "success" ? "OK" : "NO"}</span>
        <span>\${escapeHtml(message)}</span>
    \`;
	document.body.appendChild(toast);

	// Auto remove after 3 seconds
	setTimeout(() => {
		toast.style.animation = "slideIn 0.3s ease reverse";
		setTimeout(() => toast.remove(), 300);
	}, 3000);
}

/**
 * Attach event listeners
 */
function attachEventListeners() {
	// Add any additional event listeners here
}

/**
 * Escape HTML to prevent XSS
 */
function escapeHtml(text) {
	if (!text) return "";
	const map = {
		"&": "&amp;",
		"<": "&lt;",
		">": "&gt;",
		'"': "&quot;",
		"'": "&#039;",
	};
	return String(text).replace(/[&<>"']/g, (char) => map[char]);
}

/**
 * Handle messages from extension
 */
window.addEventListener("message", (event) => {
	const message = event.data;
	switch (message.command) {
		case "updateState":
			settingsState = {
				...settingsState,
				...message.data,
			};
			renderPage();
			break;
		case "showToast":
			showToast(message.message, message.type);
			break;
	}
});
`;var Mm=class n{static currentPanel;static accountManager;static loadBalanceStrategies={};static async show(e){if(n.context=e,n.currentPanel){n.currentPanel.reveal(ro.ViewColumn.One);return}try{n.accountManager=Ne.getInstance()}catch{ro.window.showErrorMessage("Account Manager not initialized");return}let t=ro.window.createWebviewPanel("chpSettings","Copilot ++ Settings",ro.ViewColumn.One,{enableScripts:!0,retainContextWhenHidden:!0,localResourceRoots:[ro.Uri.joinPath(e.extensionUri,"src","ui")]});n.currentPanel=t,t.webview.html=n.generateHTML(t.webview);let o=t.webview.onDidReceiveMessage(async r=>{switch(r.command){case"setLoadBalance":await n.handleSetLoadBalance(r.providerId,r.enabled,t.webview);break;case"setLoadBalanceStrategy":await n.handleSetLoadBalanceStrategy(r.providerId,r.strategy,t.webview);break;case"openAccountManager":await ro.commands.executeCommand("chp.accounts.openManager");break;case"refresh":await n.sendStateUpdate(t.webview);break}});t.onDidDispose(()=>{n.currentPanel=void 0,o.dispose()}),await n.sendStateUpdate(t.webview)}static generateHTML(e){let t=e.cspSource||"";return`<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Copilot ++ Settings</title>
        <meta http-equiv="Content-Security-Policy" content="default-src 'none'; style-src 'unsafe-inline' ${t}; script-src 'unsafe-inline' ${t};" />
        <style>
            ${jP}
        </style>
    </head>
    <body>
        <div class="settings-container">
            <div id="app">
                <div class="settings-header">
                    <h1>
                        <span class="icon"></span>
                        Copilot ++ Settings
                    </h1>
                    <p>Loading settings...</p>
                </div>
                <div style="text-align: center; padding: 40px;">
                    <div class="loading-spinner"></div>
                </div>
            </div>
        </div>
        <script>
            ${KP}
        </script>
    </body>
</html>`}static async sendStateUpdate(e){let t=n.getProvidersInfo(),o={},r={};for(let a of t)o[a.id]=n.accountManager.getLoadBalanceEnabled(a.id),r[a.id]=n.loadBalanceStrategies[a.id]||"round-robin";e.postMessage({command:"updateState",data:{providers:t,loadBalanceSettings:o,loadBalanceStrategies:r}});let i=`
            if (typeof initializeSettingsPage === 'function') {
                initializeSettingsPage({
                    providers: ${JSON.stringify(t)},
                    loadBalanceSettings: ${JSON.stringify(o)},
                    loadBalanceStrategies: ${JSON.stringify(r)}
                });
            }
        `;setTimeout(()=>{e.postMessage({command:"updateState",data:{providers:t,loadBalanceSettings:o,loadBalanceStrategies:r}})},100)}static getProvidersInfo(){return[{id:"antigravity",displayName:"Antigravity (Google Cloud Code)"},{id:"codex",displayName:"Codex (OpenAI Codex)"},{id:"zhipu",displayName:"ZhipuAI (GLM)"},{id:"moonshot",displayName:"MoonshotAI (Kimi)"},{id:"minimax",displayName:"MiniMax"},{id:"deepseek",displayName:"DeepSeek"},{id:"deepinfra",displayName:"DeepInfra"},{id:"compatible",displayName:"OpenAI/Anthropic Compatible"}].map(t=>{let o=n.accountManager.getAccountsByProvider(t.id);return{id:t.id,displayName:t.displayName,accountCount:o.length,supportsLoadBalance:Ne.supportsMultiAccount(t.id)}})}static async handleSetLoadBalance(e,t,o){try{await n.accountManager.setLoadBalanceEnabled(e,t),o.postMessage({command:"showToast",message:`Load balancing ${t?"enabled":"disabled"} for ${e}`,type:"success"})}catch(r){o.postMessage({command:"showToast",message:`Failed to update load balance setting: ${r}`,type:"error"})}}static async handleSetLoadBalanceStrategy(e,t,o){try{n.loadBalanceStrategies[e]=t,o.postMessage({command:"showToast",message:`Strategy changed to ${t} for ${e}`,type:"success"})}catch(r){o.postMessage({command:"showToast",message:`Failed to update strategy: ${r}`,type:"error"})}}static dispose(){n.currentPanel&&(n.currentPanel.dispose(),n.currentPanel=void 0)}};function ox(n){return ro.commands.registerCommand("chp.openSettings",async()=>{await Mm.show(n)})}cc();var Sm={},wu=[],rx;async function eF(n){let e=Date.now(),t=L.getConfigProvider();if(!t){u.warn("Provider configuration not found, skipping provider registration");return}he.setExtensionPath(n.extensionPath);let o=Object.entries(t);u.info(`\u23F1\uFE0F Starting parallel registration of ${o.length} providers...`);let r=o.map(async([c,l])=>{try{u.trace(`Registering provider: ${l.displayName} (${c})`);let d=Date.now(),p,f;if(c==="zhipu"){let h=Im.createAndActivate(n,c,l);p=h.provider,f=h.disposables}else if(c==="minimax"){let h=ym.createAndActivate(n,c,l);p=h.provider,f=h.disposables}else if(c==="chutes"){let h=cm.createAndActivate(n,c,l);p=h.provider,f=h.disposables}else if(c==="zenmux"){let h=Tm.createAndActivate(n,c,l);p=h.provider,f=h.disposables}else if(c==="lightningai"){let h=vm.createAndActivate(n,c,l);p=h.provider,f=h.disposables}else if(c==="opencode"){let h=wm.createAndActivate(n,c,l);p=h.provider,f=h.disposables}else if(c==="qwencli"){let h=_m.createAndActivate(n,c,l);p=h.provider,f=h.disposables}else if(c==="geminicli"){let h=fm.createAndActivate(n,c,l);p=h.provider,f=h.disposables}else if(c==="huggingface"){let h=hm.createAndActivate(n,c,l);p=h.provider,f=h.disposables}else if(c==="deepinfra"){let h=um.createAndActivate(n,c,l);p=h.provider,f=h.disposables}else if(c==="mistral"){let h=xm.createAndActivate(n,c,l);p=h.provider,f=h.disposables}else if(c==="ollama"){let h=hu.createAndActivate(n,c,l);p=h.provider,f=h.disposables}else{let h=Te.createAndActivate(n,c,l);p=h.provider,f=h.disposables}let m=Date.now()-d;return u.info(`${l.displayName} provider registered successfully (time: ${m}ms)`),{providerKey:c,provider:p,disposables:f}}catch(d){return u.error(`Failed to register provider ${c}:`,d),null}}),i=await Promise.all(r);for(let c of i)c&&(Sm[c.providerKey]=c.provider,wu.push(...c.disposables));let a=Date.now()-e,s=i.filter(c=>c!==null).length;u.info(`\u23F1\uFE0F Provider registration completed: ${s}/${o.length} successful (total time: ${a}ms)`)}async function tF(n){try{u.trace("Registering compatible provider...");let e=Date.now(),t=lm.createAndActivate(n),o=t.provider,r=t.disposables;Sm.compatible=o,wu.push(...r);let i=Date.now()-e;u.info(`Compatible Provider registered successfully (time: ${i}ms)`)}catch(e){u.error("Failed to register compatible provider:",e)}try{let e=nx(n);wu.push(e)}catch(e){u.warn("Failed to register Copilot Overview command",e)}}async function nF(n){try{u.trace("Registering inline completion provider (Shim mode)...");let e=Date.now(),t=Iu.createAndActivate(n);rx=t.provider,wu.push(...t.disposables);let o=Date.now()-e;u.info(`Inline completion provider registered successfully - Shim mode (time: ${o}ms)`)}catch(e){u.error("Failed to register inline completion provider:",e)}}async function oF(n){globalThis.__chp_singletons={CompletionLogger:$o,ApiKeyManager:R,ConfigManager:L};let e=Date.now();try{u.initialize("Copilot ++"),Qs.initialize("GitHub Copilot Models Provider Status"),$o.initialize("Copilot ++Inline Completion");let t=n.extensionMode===Se.ExtensionMode.Development;u.info(`Copilot ++Extension Mode: ${t?"Development":"Production"}`),t&&u.checkAndPromptLogLevel(),u.info("\u23F1\uFE0F Starting Copilot ++extension activation...");let o=Date.now();R.initialize(n),u.trace(`\u23F1\uFE0F API key manager initialization complete (time: ${Date.now()-o}ms)`),o=Date.now(),Ne.initialize(n),it.initialize(n);let r=sb(n);n.subscriptions.push(...r);let i=Tu.initialize();n.subscriptions.push({dispose:()=>i.dispose()}),i.syncAllAccounts().catch(g=>u.warn("Account sync failed:",g));let a=Ne.getInstance(),s=async()=>{let g=a.getActiveAccount("antigravity");if(!g)return;let v=await a.getCredentials(g.id);if(!v)return;let k=v.accessToken??v.apiKey;if(k){let x=Se.workspace.getConfiguration("antigravityQuotaWatcher");x.get("apiKey")!==k&&await x.update("apiKey",k,Se.ConfigurationTarget.Global)}};s(),n.subscriptions.push(a.onAccountChange(async g=>{g.provider==="antigravity"&&(g.type==="switched"||g.type==="updated"||g.type==="added")&&await s()})),u.trace(`\u23F1\uFE0F Multi-account manager initialization complete (time: ${Date.now()-o}ms)`),o=Date.now();let c=ox(n);n.subscriptions.push(c),u.trace(`\u23F1\uFE0F Settings page command registered (time: ${Date.now()-o}ms)`),o=Date.now();let l=L.initialize();n.subscriptions.push(l),u.trace(`\u23F1\uFE0F Configuration manager initialized (time: ${Date.now()-o}ms)`),o=Date.now(),ys.initialize(),n.subscriptions.push({dispose:()=>ys.dispose()}),u.trace(`\u23F1\uFE0F JSON Schema provider initialized (time: ${Date.now()-o}ms)`),o=Date.now(),wn.initialize(),u.trace(`\u23F1\uFE0F Compatible model manager initialized (time: ${Date.now()-o}ms)`),o=Date.now(),await eF(n),u.trace(`\u23F1\uFE0F Model provider registration complete (time: ${Date.now()-o}ms)`),o=Date.now(),await tF(n),u.trace(`\u23F1\uFE0F Compatible provider registration complete (time: ${Date.now()-o}ms)`),o=Date.now(),tx(n),u.trace(`\u23F1\uFE0F Tools registered (time: ${Date.now()-o}ms)`),o=Date.now();let d=rm.createAndActivate(n);Sm.antigravity=d.provider,wu.push(...d.disposables),u.trace(`\u23F1\uFE0F Antigravity Provider registered (time: ${Date.now()-o}ms)`),o=Date.now(),await nF(n),u.trace(`\u23F1\uFE0F NES inline completion provider registered (time: ${Date.now()-o}ms)`),o=Date.now();let p=Se.commands.registerCommand("chp.copilot.attachSelection",async()=>{try{let g=Se.window.activeTextEditor;if(!g){Se.window.showWarningMessage("No active editor found.");return}let v=g.selection,k=g.document,x=k.fileName.split("/").pop()||k.fileName,y;v.start.line===v.end.line?y=`${v.start.line+1}`:y=`${v.start.line+1}-${v.end.line+1}`;let w=`@${x}:${y} `;await Se.commands.executeCommand("workbench.panel.chat.view.copilot.focus"),await Se.commands.executeCommand("workbench.action.chat.insertIntoInput",w)}catch(g){u.warn("Unable to execute Copilot attach selection:",g),Se.window.showWarningMessage("Failed to insert reference to Copilot Chat. Make sure GitHub Copilot Chat is installed.")}});n.subscriptions.push(p);let f=Se.commands.registerCommand("chp.copilot.insertHandle",async()=>{try{let g=Se.window.activeTextEditor;if(!g){Se.window.showWarningMessage("No active editor found.");return}let v=g.selection,k=g.document,x=k.fileName.split("/").pop()||k.fileName,y;v.isEmpty?y=`L${v.start.line+1}`:v.start.line===v.end.line?y=`L${v.start.line+1}`:y=`L${v.start.line+1}-L${v.end.line+1}`;let w=`#file:${x}:${y} `;await Se.commands.executeCommand("workbench.panel.chat.view.copilot.focus"),await Se.commands.executeCommand("type",{text:w}),u.trace(`Inserted handle reference: ${w}`)}catch(g){u.warn("Unable to insert handle reference:",g),Se.window.showWarningMessage("Failed to insert handle reference to Copilot Chat. Make sure GitHub Copilot Chat is installed.")}});n.subscriptions.push(f);let m=Se.commands.registerCommand("chp.copilot.insertHandleFullPath",async()=>{try{let g=Se.window.activeTextEditor;if(!g){Se.window.showWarningMessage("No active editor found.");return}let v=g.selection,k=g.document,x=Se.workspace.getWorkspaceFolder(k.uri),y;x?y=Se.workspace.asRelativePath(k.uri,!1):y=k.fileName.split("/").pop()||k.fileName;let w;v.isEmpty?w=`L${v.start.line+1}`:v.start.line===v.end.line?w=`L${v.start.line+1}`:w=`L${v.start.line+1}-L${v.end.line+1}`;let b=`#handle:${y}:${w} `;await Se.commands.executeCommand("workbench.panel.chat.view.copilot.focus"),await Se.commands.executeCommand("type",{text:b})}catch(g){u.warn("Unable to insert handle reference with full path:",g),Se.window.showWarningMessage("Failed to insert handle reference to Copilot Chat.")}});n.subscriptions.push(m),u.trace(`\u23F1\uFE0F Copilot helper commands registered (time: ${Date.now()-o}ms)`);let h=Date.now()-e;u.info(`Copilot ++extension activation completed (total time: ${h}ms)`)}catch(t){let o=`Copilot ++extension activation failed: ${t instanceof Error?t.message:"Unknown error"}`;throw u.error(o,t instanceof Error?t:void 0),Se.window.showErrorMessage("Copilot ++extension startup failed. Please check the output window for details."),t}}function rF(){try{for(let[n,e]of Object.entries(Sm))try{typeof e.dispose=="function"&&(e.dispose(),u.trace(`Provider ${n} resources cleaned up`))}catch(t){u.warn(`Error cleaning up provider ${n} resources:`,t)}rx&&(rx.dispose(),u.trace("Inline completion provider cleaned up"));try{Ne.getInstance().dispose(),u.trace("Multi-account manager cleaned up")}catch{}L.dispose(),Qs.dispose(),$o.dispose(),u.dispose()}catch(n){u.error("Error during Copilot ++extension deactivation:",n)}}0&&(module.exports={activate,deactivate});
